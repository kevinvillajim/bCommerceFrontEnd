import{I as Y,T as Z,H as ee,e as E,j as e,R as te,aa as se,b2 as re,F as ae,b3 as oe,h as ne,E as ie,o as le}from"./ui-vendor-DEBjJ4HS.js";import{r as m}from"./react-vendor-Cy458wKG.js";import{c as g,b as U,T as ce}from"./admin-chunk-C7Ad4l4I.js";import{S as de}from"./StatCardList-BC4AxJgi.js";class y{id;level;eventType;message;context;method;url;ipAddress;userAgent;userId;statusCode;errorHash;createdAt;timeAgo;isCritical;isError;user;constructor(t){this.id=t.id,this.level=t.level,this.eventType=t.event_type,this.message=t.message,this.context=t.context,this.method=t.method,this.url=t.url,this.ipAddress=t.ip_address,this.userAgent=t.user_agent,this.userId=t.user_id,this.statusCode=t.status_code,this.errorHash=t.error_hash,this.createdAt=t.created_at,this.timeAgo=t.time_ago,this.isCritical=t.is_critical,this.isError=t.is_error,this.user=t.user}getFormattedDate(){return new Date(this.createdAt).toLocaleString()}getLevelColor(){switch(this.level){case"critical":return"bg-red-100 text-red-800";case"error":return"bg-orange-100 text-orange-800";case"warning":return"bg-yellow-100 text-yellow-800";case"info":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}}getLevelIcon(){switch(this.level){case"critical":return"🔥";case"error":return"❌";case"warning":return"⚠️";case"info":return"ℹ️";default:return"📝"}}getShortMessage(t=100){return this.message.length>t?`${this.message.substring(0,t)}...`:this.message}getEventTypeDisplayName(){return this.eventType.split("_").map(t=>t.charAt(0).toUpperCase()+t.slice(1)).join(" ")}hasContext(){return this.context!==void 0&&Object.keys(this.context).length>0}getUserDisplayName(){return this.user?this.user.name||this.user.email||`User #${this.user.id}`:"Anonymous"}toJSON(){return{id:this.id,level:this.level,event_type:this.eventType,message:this.message,context:this.context,method:this.method,url:this.url,ip_address:this.ipAddress,user_agent:this.userAgent,user_id:this.userId,status_code:this.statusCode,error_hash:this.errorHash,created_at:this.createdAt,time_ago:this.timeAgo,is_critical:this.isCritical,is_error:this.isError,user:this.user}}}class me{baseUrl="/admin/logs";async getLogs(t={}){const r=new URLSearchParams;Object.entries(t).forEach(([d,a])=>{a!=null&&a!==""&&r.append(d,String(a))});const n=await g.get(`${this.baseUrl}?${r.toString()}`);return{logs:n.data.map(d=>new y(d)),total:n.meta.total,currentPage:n.meta.current_page,lastPage:n.meta.last_page,perPage:n.meta.per_page}}async getLog(t){const r=await g.get(`${this.baseUrl}/${t}`);return new y(r.data)}async getStats(){return(await g.get(`${this.baseUrl}/stats`)).data}async getRecentLogs(t=50){const r=new URLSearchParams;return t&&r.append("limit",String(t)),(await g.get(`${this.baseUrl}/recent?${r.toString()}`)).data.map(l=>new y(l))}async getCriticalLogs(t=24){const r=new URLSearchParams;t&&r.append("hours",String(t));const n=await g.get(`${this.baseUrl}/critical?${r.toString()}`);return{logs:n.data.map(d=>new y(d)),hours:n.meta.hours,count:n.meta.count}}async getLogsByEventType(t,r=10){const n=new URLSearchParams;n.append("event_type",t),r&&n.append("limit",String(r));const l=await g.get(`${this.baseUrl}/by-event-type?${n.toString()}`);return{logs:l.data.map(a=>new y(a)),eventType:l.meta.event_type,count:l.meta.count}}async getEventTypes(){return(await g.get(`${this.baseUrl}/event-types`)).data}async getLogUsers(){return(await g.get(`${this.baseUrl}/users`)).data}async deleteLog(t){await g.delete(`${this.baseUrl}/${t}`)}async cleanupLogs(t={}){return(await g.post(`${this.baseUrl}/cleanup`,t)).data}async getDashboardData(){try{const[t,r,n,l]=await Promise.all([this.getRecentLogs(10),this.getCriticalLogs(24),this.getStats(),this.getEventTypes()]);return{recentLogs:t,criticalLogs:r.logs,stats:n,eventTypes:l}}catch(t){throw console.error("Error fetching dashboard data:",t),t}}async searchLogs(t,r={}){return this.getLogs({...r,search:t})}async exportLogs(t={}){const r=new URLSearchParams;Object.entries(t).forEach(([l,d])=>{d!=null&&d!==""&&r.append(l,String(d))});const n=await fetch(`${U.api.baseUrl}${this.baseUrl}/export?${r.toString()}`,{method:"GET",headers:{Authorization:`Bearer ${localStorage.getItem(U.storage.authTokenKey)}`,Accept:"application/json"}});if(!n.ok)throw new Error("Failed to export logs");return n.blob()}formatFiltersForDisplay(t){const r={};return t.level&&(r.Level=t.level.toUpperCase()),t.event_type&&(r["Event Type"]=t.event_type.replace("_"," ")),t.user_id&&(r["User ID"]=String(t.user_id)),t.status_code&&(r["Status Code"]=String(t.status_code)),t.from_date&&(r.From=new Date(t.from_date).toLocaleDateString()),t.to_date&&(r.To=new Date(t.to_date).toLocaleDateString()),t.search&&(r.Search=t.search),r}validateFilters(t){const r=[];if(t.per_page&&(t.per_page<5||t.per_page>100)&&r.push("Per page must be between 5 and 100"),t.from_date&&t.to_date){const n=new Date(t.from_date),l=new Date(t.to_date);n>l&&r.push("From date must be before to date")}return t.search&&t.search.length>255&&r.push("Search term is too long (max 255 characters)"),r}}const h=new me,pe=()=>{const[f,t]=m.useState([]),[r,n]=m.useState(!0),[l,d]=m.useState(1),[a,b]=m.useState(null),[p,T]=m.useState(null),[A,k]=m.useState(1),[D,P]=m.useState(0),[$,R]=m.useState([]),[F,I]=m.useState([]),[c,N]=m.useState({page:1,per_page:20,level:void 0,event_type:void 0,user_id:void 0,status_code:void 0,from_date:void 0,to_date:void 0,search:void 0}),O=["error","critical","warning","info"],H=[401,403,404,429,500,502,503,504],M=[{key:"id",header:"ID",sortable:!0},{key:"createdAt",header:"Fecha y Hora",sortable:!0,render:s=>e.jsxs("div",{className:"flex items-center",children:[e.jsx(E,{className:"w-4 h-4 mr-1 text-gray-400"}),e.jsxs("div",{className:"flex flex-col",children:[e.jsx("span",{className:"text-sm",children:s.getFormattedDate()}),e.jsx("span",{className:"text-xs text-gray-500",children:s.timeAgo})]})]})},{key:"level",header:"Nivel",sortable:!0,render:s=>e.jsxs("span",{className:`px-2 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ${s.getLevelColor()}`,children:[s.getLevelIcon()," ",s.level.toUpperCase()]})},{key:"eventType",header:"Tipo de Evento",sortable:!0,render:s=>e.jsxs("div",{className:"flex items-center",children:[e.jsx(oe,{className:"w-4 h-4 mr-1 text-gray-400"}),e.jsx("span",{className:"text-sm",children:s.getEventTypeDisplayName()})]})},{key:"message",header:"Mensaje",sortable:!0,render:s=>e.jsx("div",{className:"max-w-xs",children:e.jsx("p",{className:"text-sm text-gray-900 truncate",title:s.message,children:s.getShortMessage(60)})})},{key:"user",header:"Usuario",sortable:!0,render:s=>e.jsxs("div",{className:"flex items-center",children:[e.jsx(ne,{className:"w-4 h-4 mr-1 text-gray-400"}),e.jsx("span",{className:"text-sm",children:s.getUserDisplayName()})]})},{key:"statusCode",header:"Estado",sortable:!0,render:s=>e.jsx("span",{className:`px-2 py-1 text-xs rounded ${s.statusCode?s.statusCode>=500?"bg-red-100 text-red-800":s.statusCode>=400?"bg-yellow-100 text-yellow-800":"bg-green-100 text-green-800":"bg-gray-100 text-gray-600"}`,children:s.statusCode||"N/A"})},{key:"actions",header:"Acciones",render:s=>e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:()=>b(s),className:"text-primary-600 hover:text-primary-900",title:"Ver detalles",children:e.jsx(ie,{size:16})}),e.jsx("button",{onClick:()=>C(s.id),className:"text-red-600 hover:text-red-900",title:"Eliminar log",children:e.jsx(le,{size:16})})]})}],v=async()=>{try{const[s,o,x]=await Promise.all([h.getStats(),h.getEventTypes(),h.getLogUsers()]);T(s),R(o),I(x)}catch(s){console.error("Error loading initial data:",s)}},j=async(s=c)=>{try{n(!0);const o=await h.getLogs(s);t(o.logs),k(o.lastPage),P(o.total),d(o.currentPage)}catch(o){console.error("Error loading logs:",o),t([])}finally{n(!1)}};m.useEffect(()=>{v(),j()},[]),m.useEffect(()=>{j(c)},[c]);const u=(s,o)=>{const x={...c,[s]:o===""||o==="all"?void 0:o,page:1};N(x)},z=s=>{const o={...c,page:s};N(o)},C=async s=>{if(confirm("¿Estás seguro de que quieres eliminar este log?"))try{await h.deleteLog(s),await j(),await v()}catch(o){console.error("Error deleting log:",o),alert("Error al eliminar el log")}},B=async()=>{if(confirm(`⚠️ ¿Estás seguro de que quieres BORRAR TODOS LOS LOGS?

Esta acción no se puede deshacer y eliminará todos los registros de errores del sistema.`))try{await h.cleanupLogs({days:0}),t([]),b(null),await v(),alert("✅ Todos los logs han sido eliminados correctamente.")}catch(s){console.error("Error eliminando todos los logs:",s),alert("❌ Error al eliminar los logs. Por favor intenta nuevamente.")}},q=async()=>{await j(),await v()},V=()=>{N({page:1,per_page:20,level:void 0,event_type:void 0,user_id:void 0,status_code:void 0,from_date:void 0,to_date:void 0,search:void 0})},J=s=>{if(s.length===0)return"";const o=["ID","Fecha","Nivel","Tipo de Evento","Mensaje","Usuario","Email Usuario","Código de Estado","Método HTTP","URL","IP","User Agent","Contexto"],x=s.map(i=>[i.id,i.getFormattedDate(),i.level,i.eventType||"",`"${i.message.replace(/"/g,'""')}"`,i.user?.name||"",i.user?.email||"",i.statusCode||"",i.method||"",`"${(i.url||"").replace(/"/g,'""')}"`,i.ipAddress||"",`"${(i.userAgent||"").replace(/"/g,'""')}"`,i.hasContext()?`"${JSON.stringify(i.context).replace(/"/g,'""')}"`:""]);return[o.join(","),...x.map(i=>i.join(","))].join(`
`)},G=async()=>{try{const s=[];let o=1;const x=100;let i=!0;for(;i;){const Q={...c,per_page:x,page:o},S=await h.getLogs(Q);s.push(...S.logs),i=o<S.lastPage,o++}if(s.length===0){alert("No hay logs para exportar con los filtros actuales");return}const K=J(s),W=new Blob([K],{type:"text/csv;charset=utf-8;"}),L=URL.createObjectURL(W),X=`admin_logs_export_${new Date().toISOString().slice(0,10)}.csv`,w=document.createElement("a");w.setAttribute("href",L),w.setAttribute("download",X),w.click(),URL.revokeObjectURL(L)}catch(s){console.error("Error exporting logs:",s),alert("Error al exportar los logs")}},_=p?[{title:"Total",value:p.total||0,description:"Total de registros",icon:Y,bgColor:"bg-gray-50/20",textColor:"text-gray-700",valueColor:"text-gray-800",descriptionColor:"text-gray-600",iconColor:"text-gray-600"},{title:"Críticos",value:p.critical||0,description:"Registros críticos",icon:Z,bgColor:"bg-red-50/20",textColor:"text-red-700",valueColor:"text-red-800",descriptionColor:"text-red-600",iconColor:"text-red-600"},{title:"Errores",value:p.errors||0,description:"Registros de error",icon:ee,bgColor:"bg-orange-50/20",textColor:"text-orange-700",valueColor:"text-orange-800",descriptionColor:"text-orange-600",iconColor:"text-orange-600"},{title:"Hoy",value:p.today||0,description:"Registros de hoy",icon:E,bgColor:"bg-blue-50/20",textColor:"text-blue-700",valueColor:"text-blue-800",descriptionColor:"text-blue-600",iconColor:"text-blue-600"}]:[];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Registros de Errores"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:q,className:"px-3 py-2 bg-primary-100 text-primary-700 rounded-md hover:bg-primary-200",title:"Refrescar datos",children:e.jsx(te,{size:20})}),e.jsx("button",{onClick:G,className:"px-3 py-2 bg-green-100 text-green-700 rounded-md hover:bg-green-200",title:"Exportar registros como CSV",children:e.jsx(se,{size:20})}),e.jsx("button",{onClick:B,className:"px-3 py-2 bg-red-100 text-red-700 rounded-md hover:bg-red-200",title:"Borrar todos los logs",children:e.jsx(re,{size:20})})]})]}),_.length>0&&e.jsx(de,{items:_}),e.jsxs("div",{className:"bg-white p-4 rounded-lg shadow-sm space-y-4",children:[e.jsxs("div",{className:"flex items-center mb-2",children:[e.jsx(ae,{className:"w-5 h-5 text-gray-500 mr-2"}),e.jsx("h2",{className:"text-lg font-medium text-gray-900",children:"Filtros"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-4 lg:grid-cols-6 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nivel"}),e.jsxs("select",{value:c.level||"all",onChange:s=>u("level",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"all",children:"Todos"}),O.map(s=>e.jsx("option",{value:s,children:s.charAt(0).toUpperCase()+s.slice(1)},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tipo de Evento"}),e.jsxs("select",{value:c.event_type||"all",onChange:s=>u("event_type",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"all",children:"Todos"}),$.map(s=>e.jsx("option",{value:s,children:s.replace("_"," ").split(" ").map(o=>o.charAt(0).toUpperCase()+o.slice(1)).join(" ")},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Usuario"}),e.jsxs("select",{value:c.user_id||"all",onChange:s=>u("user_id",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"all",children:"Todos"}),F.map(s=>e.jsx("option",{value:s.id,children:s.name||s.email},s.id))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Código HTTP"}),e.jsxs("select",{value:c.status_code||"all",onChange:s=>u("status_code",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500",children:[e.jsx("option",{value:"all",children:"Todos"}),H.map(s=>e.jsx("option",{value:s,children:s},s))]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Desde"}),e.jsx("input",{type:"date",value:c.from_date||"",onChange:s=>u("from_date",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Hasta"}),e.jsx("input",{type:"date",value:c.to_date||"",onChange:s=>u("to_date",s.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Buscar en mensajes, URLs y eventos"}),e.jsx("input",{type:"text",value:c.search||"",onChange:s=>u("search",s.target.value),placeholder:"Escribir para buscar...",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-primary-500"})]}),e.jsx("div",{className:"flex justify-end",children:e.jsx("button",{onClick:V,className:"px-4 py-2 bg-gray-100 text-gray-700 rounded-md hover:bg-gray-200",children:"Limpiar filtros"})})]}),e.jsx(ce,{data:f,columns:M,loading:r,emptyMessage:"No se encontraron registros de errores",pagination:{currentPage:l,totalPages:A,totalItems:D,itemsPerPage:c.per_page||20,onPageChange:z}}),a&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg w-full max-w-4xl max-h-[90vh] overflow-hidden",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 flex justify-between items-center",children:[e.jsxs("div",{className:"flex items-center space-x-3",children:[e.jsxs("span",{className:`px-2 py-1 text-xs rounded-full ${a.getLevelColor()}`,children:[a.getLevelIcon()," ",a.level.toUpperCase()]}),e.jsxs("h3",{className:"text-lg font-medium text-gray-900",children:["Detalles del Log #",a.id]})]}),e.jsx("button",{onClick:()=>b(null),className:"text-gray-500 hover:text-gray-700",children:e.jsx("svg",{className:"w-6 h-6",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})})]}),e.jsxs("div",{className:"px-6 py-4 overflow-y-auto max-h-[70vh]",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6 mb-6",children:[e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 mb-1",children:"Fecha y Hora"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.getFormattedDate()}),e.jsx("p",{className:"text-sm text-gray-500",children:a.timeAgo})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 mb-1",children:"Tipo de Evento"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.getEventTypeDisplayName()})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 mb-1",children:"Usuario"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.getUserDisplayName()}),a.user?.email&&e.jsx("p",{className:"text-sm text-gray-500",children:a.user.email})]}),e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 mb-1",children:"Código de Estado"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.statusCode||"N/A"})]}),a.method&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 mb-1",children:"Método HTTP"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.method})]}),a.ipAddress&&e.jsxs("div",{children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 mb-1",children:"Dirección IP"}),e.jsx("p",{className:"font-semibold text-gray-900",children:a.ipAddress})]})]}),a.url&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 mb-1",children:"URL"}),e.jsx("p",{className:"font-semibold text-gray-900 break-all",children:a.url})]}),e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 mb-1",children:"Mensaje"}),e.jsx("p",{className:"font-semibold text-gray-900 whitespace-pre-wrap",children:a.message})]}),a.userAgent&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 mb-1",children:"User Agent"}),e.jsx("p",{className:"text-sm text-gray-900 break-words bg-gray-50 p-2 rounded",children:a.userAgent})]}),a.hasContext()&&e.jsxs("div",{className:"mb-4",children:[e.jsx("p",{className:"text-sm font-medium text-gray-500 mb-1",children:"Contexto Adicional"}),e.jsx("pre",{className:"mt-2 p-3 bg-gray-100 rounded-md text-sm text-gray-900 overflow-x-auto max-h-60",children:JSON.stringify(a.context,null,2)})]})]}),e.jsxs("div",{className:"px-6 py-3 border-t border-gray-200 flex justify-end space-x-3",children:[e.jsx("button",{onClick:()=>C(a.id),className:"px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700",children:"Eliminar Log"}),e.jsx("button",{onClick:()=>b(null),className:"px-4 py-2 bg-primary-600 text-white rounded-md hover:bg-primary-700",children:"Cerrar"})]})]})})]})};export{pe as default};
//# sourceMappingURL=AdminLogViewerPage-DHJEGIpp.js.map
