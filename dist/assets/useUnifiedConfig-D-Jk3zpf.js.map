{"version":3,"file":"useUnifiedConfig-D-Jk3zpf.js","sources":["../../src/presentation/hooks/useUnifiedConfig.ts"],"sourcesContent":["/**\r\n * 🎯 JORDAN FASE 1: HOOK PARA CONFIGURACIÓN UNIFICADA\r\n * Reemplaza todos los hooks de configuración existentes\r\n */\r\n\r\nimport { useState, useEffect, useCallback, useRef } from 'react';\r\nimport ConfigurationManager, { \r\n  type UnifiedConfig, \r\n  type ConfigurationResult \r\n} from '../../core/services/ConfigurationManager';\r\n\r\ninterface UseUnifiedConfigReturn {\r\n  config: UnifiedConfig | null;\r\n  loading: boolean;\r\n  error: string | null;\r\n  warnings: string[];\r\n  source: 'cache' | 'api' | 'fallback';\r\n  isStale: boolean;\r\n  refetch: () => Promise<void>;\r\n  stats: any;\r\n}\r\n\r\n/**\r\n * 🔧 HOOK PRINCIPAL - Reemplaza useShippingConfig, useVolumeDiscount, etc.\r\n */\r\nexport const useUnifiedConfig = (autoRefresh: boolean = true): UseUnifiedConfigReturn => {\r\n  const [result, setResult] = useState<ConfigurationResult | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const managerRef = useRef(ConfigurationManager.getInstance());\r\n  const intervalRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n  // 📡 OBTENER CONFIGURACIÓN\r\n  const fetchConfig = useCallback(async (forceRefresh: boolean = false) => {\r\n    try {\r\n      setLoading(true);\r\n      const configResult = await managerRef.current.getUnifiedConfig(forceRefresh);\r\n      setResult(configResult);\r\n      \r\n      console.log('✅ JORDAN useUnifiedConfig - Configuración cargada:', {\r\n        source: configResult.source,\r\n        isStale: configResult.is_stale,\r\n        errors: configResult.errors.length,\r\n        warnings: configResult.warnings.length\r\n      });\r\n      \r\n    } catch (error) {\r\n      console.error('❌ JORDAN useUnifiedConfig - Error:', error);\r\n      setResult({\r\n        config: managerRef.current.getConfigSync() || managerRef.current['getSecureFallbackConfig'](),\r\n        source: 'fallback',\r\n        is_stale: true,\r\n        errors: [error instanceof Error ? error.message : 'Error desconocido'],\r\n        warnings: ['Hook usando configuración de emergencia']\r\n      });\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  }, []);\r\n\r\n  // 🔄 REFETCH MANUAL\r\n  const refetch = useCallback(async () => {\r\n    await fetchConfig(true);\r\n  }, [fetchConfig]);\r\n\r\n  // 📊 OBTENER ESTADÍSTICAS\r\n  const getStats = useCallback(() => {\r\n    return managerRef.current.getStats();\r\n  }, []);\r\n\r\n  // 🚀 INICIALIZACIÓN\r\n  useEffect(() => {\r\n    fetchConfig();\r\n\r\n    // 🔄 AUTO-REFRESH (opcional)\r\n    if (autoRefresh) {\r\n      intervalRef.current = setInterval(() => {\r\n        console.log('🔄 JORDAN - Auto-refresh de configuración');\r\n        fetchConfig();\r\n      }, 5 * 60 * 1000); // Cada 5 minutos\r\n    }\r\n\r\n    return () => {\r\n      if (intervalRef.current) {\r\n        clearInterval(intervalRef.current);\r\n      }\r\n    };\r\n  }, [fetchConfig, autoRefresh]);\r\n\r\n  return {\r\n    config: result?.config || null,\r\n    loading,\r\n    error: result?.errors?.[0] || null,\r\n    warnings: result?.warnings || [],\r\n    source: result?.source || 'fallback',\r\n    isStale: result?.is_stale || false,\r\n    refetch,\r\n    stats: getStats()\r\n  };\r\n};\r\n\r\n/**\r\n * 🎯 HOOKS ESPECÍFICOS - Para compatibilidad gradual\r\n */\r\n\r\n// 🚚 HOOK DE ENVÍO (reemplaza useShippingConfig)\r\nexport const useShippingConfig = () => {\r\n  const { config, loading, error } = useUnifiedConfig();\r\n  \r\n  return {\r\n    config: config?.shipping || null,\r\n    loading,\r\n    error,\r\n    // Métodos de conveniencia\r\n    calculateShipping: (subtotal: number) => {\r\n      if (!config?.shipping) return 0;\r\n      return subtotal >= config.shipping.free_threshold ? 0 : config.shipping.default_cost;\r\n    },\r\n    isFreeShipping: (subtotal: number) => {\r\n      if (!config?.shipping) return false;\r\n      return subtotal >= config.shipping.free_threshold;\r\n    }\r\n  };\r\n};\r\n\r\n// 📦 HOOK DE DESCUENTOS POR VOLUMEN (reemplaza useVolumeDiscount)\r\nexport const useVolumeDiscounts = () => {\r\n  const { config, loading, error } = useUnifiedConfig();\r\n  \r\n  return {\r\n    tiers: config?.volume_discounts || [],\r\n    loading,\r\n    error,\r\n    // Métodos de conveniencia\r\n    getDiscountForQuantity: (quantity: number) => {\r\n      if (!config?.volume_discounts) return 0;\r\n      \r\n      const sortedTiers = [...config.volume_discounts].sort((a, b) => b.quantity - a.quantity);\r\n      for (const tier of sortedTiers) {\r\n        if (quantity >= tier.quantity) {\r\n          return tier.discount / 100; // ✅ CORREGIDO: Convertir porcentaje a decimal\r\n        }\r\n      }\r\n      return 0;\r\n    },\r\n    getApplicableTier: (quantity: number) => {\r\n      if (!config?.volume_discounts) return null;\r\n      \r\n      const sortedTiers = [...config.volume_discounts].sort((a, b) => b.quantity - a.quantity);\r\n      for (const tier of sortedTiers) {\r\n        if (quantity >= tier.quantity) {\r\n          return tier;\r\n        }\r\n      }\r\n      return null;\r\n    }\r\n  };\r\n};\r\n\r\n// 💰 HOOK DE CONFIGURACIÓN FINANCIERA (reemplaza FinancialConfigurationService)\r\nexport const useFinancialConfig = () => {\r\n  const { config, loading, error } = useUnifiedConfig();\r\n  \r\n  return {\r\n    taxRate: config?.tax_rate || 0.15,\r\n    platformCommissionRate: config?.platform_commission_rate || 0.10,\r\n    loading,\r\n    error,\r\n    // Métodos de conveniencia\r\n    calculateTax: (amount: number) => amount * (config?.tax_rate || 0.15),\r\n    calculateCommission: (subtotal: number) => {\r\n      const rate = config?.platform_commission_rate || 0.10;\r\n      return {\r\n        rate: rate * 100, // Para mostrar como porcentaje\r\n        amount: subtotal * rate,\r\n        sellerEarnings: subtotal * (1 - rate)\r\n      };\r\n    }\r\n  };\r\n};\r\n\r\n/**\r\n * 🔍 HOOK DE DEBUG - Para desarrollo\r\n */\r\nexport const useConfigurationDebug = () => {\r\n  const { config, stats, source, isStale, warnings } = useUnifiedConfig();\r\n  \r\n  return {\r\n    config,\r\n    stats,\r\n    source,\r\n    isStale,\r\n    warnings,\r\n    // Helper para mostrar estado en UI de desarrollo\r\n    getDebugInfo: () => ({\r\n      manager_stats: stats,\r\n      current_source: source,\r\n      is_stale: isStale,\r\n      warnings_count: warnings.length,\r\n      config_version: config?.version,\r\n      config_updated: config?.updated_at,\r\n      cache_valid: stats.cache_valid\r\n    })\r\n  };\r\n};\r\n\r\nexport default useUnifiedConfig;"],"names":["useUnifiedConfig","autoRefresh","result","setResult","useState","loading","setLoading","managerRef","useRef","ConfigurationManager","intervalRef","fetchConfig","useCallback","forceRefresh","configResult","error","refetch","getStats","useEffect","useShippingConfig","config","subtotal","useVolumeDiscounts","quantity","sortedTiers","a","b","tier"],"mappings":"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"}