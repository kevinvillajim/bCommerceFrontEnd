import{d as Z,h as ee,u as se,r,j as s}from"./index-DmNDOrWy.js";import{u as te}from"./useChat-CTw3ZN82.js";import{u as ae,C as re,a as ne,b as oe,M as ie}from"./ChatFilterToast-DPT1PUcO.js";import{M as U}from"./message-square-C6QrtgNg.js";import{A as le}from"./arrow-left-sVt-VeaA.js";import{R as ce}from"./refresh-cw-BOPCg90x.js";import"./errorHandler-ugMJT1nb.js";import"./search-CbEKe7UQ.js";import"./funnel-CAFb7hhq.js";import"./user-nLts-VnI.js";import"./store-BV-a-_hn.js";import"./package-CIRlwNqy.js";import"./dateUtils-CfeftkgG.js";import"./check-CHNPnXXq.js";import"./loader-circle-D95e5ckH.js";import"./send-BCk3tQWd.js";import"./triangle-alert-B75WTV0P.js";import"./ban-DWyykPX6.js";import"./shield-C7SSAF2o.js";const $e=()=>{const i=Z(),{chatId:o}=ee(),{user:c}=se(),[g,T]=r.useState(""),[y,k]=r.useState("all"),[$,z]=r.useState(!1),[x,V]=r.useState(window.innerWidth<768),[S,d]=r.useState(!o),[p,f]=r.useState(!1),[I,W]=r.useState("Cargando conversaciones..."),C=r.useRef(!1),v=r.useRef(o),L=r.useRef(0),R=r.useRef(!0),{showUserWarning:D,NotificationComponent:H}=ae(),{chats:j,selectedChat:a,messages:q,loading:u,error:A,fetchChats:h,fetchChatMessages:w,sendMessage:B,updateChatStatus:_,setSelectedChat:l,startMessagesPolling:M,stopMessagesPolling:N,markAllAsRead:b}=te();r.useEffect(()=>{const e=()=>{V(window.innerWidth<768)};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),r.useEffect(()=>{!C.current&&c?.id&&(console.log("Cargando lista inicial de chats..."),f(!0),h().then(e=>{if(C.current=!0,f(!1),console.log(`Lista inicial de ${e.length} chats cargada`),o&&e.length>0){const t=parseInt(o,10),n=e.find(m=>m.id===t);n?(console.log(`Chat ${t} encontrado en carga inicial, seleccionando...`),l(n),d(!1)):(console.log(`Chat ${t} no encontrado en lista inicial, intentando carga directa...`),E(t))}}).catch(e=>{console.error("Error al cargar chats iniciales:",e),f(!1),C.current=!0}))},[h,o,l,c?.id]);const E=r.useCallback(async e=>{if(c?.id){console.log(`Intentando cargar chat específico ${e}...`),f(!0),W(`Cargando conversación #${e}...`),L.current+=1;try{const t=j.find(n=>n.id===e);if(t)console.log(`Chat ${e} encontrado en la lista, seleccionando...`),l(t),d(!1),M(e),t.unreadCount&&t.unreadCount>0&&setTimeout(()=>{b(e).catch(console.error)},1e3);else{console.log(`Chat ${e} no encontrado en la lista, cargando desde API...`);try{if(await w(e))console.log(`Chat ${e} cargado correctamente desde API`),d(!1),M(e),setTimeout(()=>{b(e).catch(console.error)},1e3);else if(console.warn(`Chat ${e} no encontrado en API, mostrando lista de chats`),L.current>=3)i("/chats",{replace:!0});else{const F=(await h()).find(Y=>Y.id===e);F?(l(F),d(!1)):i("/chats",{replace:!0})}}catch(n){console.error(`Error al cargar chat ${e} desde API:`,n),i("/chats",{replace:!0})}}}catch(t){console.error(`Error al cargar chat ${e}:`,t),i("/chats",{replace:!0})}finally{f(!1)}}},[j,w,i,l,h,M,b,c?.id]);r.useEffect(()=>{if(!(!C.current||!c?.id)){if(R.current){R.current=!1;return}if(!(o===v.current&&a))if(N(),v.current=o,L.current=0,o){const e=parseInt(o,10);if(isNaN(e)){i("/chats",{replace:!0});return}E(e)}else l(null),d(!0)}},[o,E,i,a,l,N,c?.id]);const G=j.filter(e=>{const t=y==="all"||e.status===y,n=$?e.unreadCount&&e.unreadCount>0:!0,m=g===""||e.product?.name&&e.product.name.toLowerCase().includes(g.toLowerCase())||e.seller?.storeName&&e.seller.storeName.toLowerCase().includes(g.toLowerCase());return t&&n&&m}),J=e=>{e&&e.id&&(console.log(`Usuario seleccionó chat ${e.id}`),N(),i(`/chats/${e.id}`,{replace:!0}),v.current=String(e.id),l(e),x&&d(!1),e.unreadCount&&e.unreadCount>0&&setTimeout(()=>{e.id!==void 0&&b(e.id).catch(console.error)},1e3))},K=async e=>{console.log("Enviando mensaje...");try{const t=await B(e);return t&&a?.id&&await w(a.id),t}catch(t){if(console.error("Error al enviar mensaje:",t),t?.response?.data?.status==="error"){const n=t.response.data,m=n.data?.censored_content;D(n.message,m)}return!1}},O=async(e,t)=>(console.log(`Actualizando estado de chat ${e} a ${t}...`),await _(e,t)),Q=()=>{console.log("Volviendo a lista de chats"),N(),d(!0),i("/chats",{replace:!0}),v.current=void 0},P=()=>{console.log("Refrescando lista de chats"),h(),a&&a.id&&w(a.id)},X=()=>(u||p)&&!a?s.jsxs("div",{className:"flex flex-col justify-center items-center h-full",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4"}),s.jsx("p",{className:"text-gray-600",children:I})]}):a?s.jsxs(s.Fragment,{children:[s.jsx(ne,{chat:a,isSeller:!1,onUpdateStatus:O,loading:u}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx(oe,{messages:q,loading:u,noMessagesText:"No hay mensajes todavía",currentUserId:c?.id??void 0})}),s.jsx(ie,{onSendMessage:K,isDisabled:a.status!=="active",disabledText:a.status==="closed"?"Esta conversación está cerrada":"Esta conversación está archivada",isLoading:u,chatId:a.id})]}):s.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-4 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4",children:s.jsx(U,{className:"h-8 w-8 text-gray-500"})}),s.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Selecciona una conversación"}),s.jsx("p",{className:"text-gray-500 mt-2 max-w-md",children:j.length>0?"Elige una conversación de la lista para ver los mensajes y responder":"No tienes conversaciones activas. Puedes iniciar una desde la página de un producto."})]});return s.jsxs("div",{className:"container mx-auto p-4",children:[s.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[s.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center",children:[s.jsx(U,{className:"w-6 h-6 mr-2"}),"Mis Conversaciones"]}),s.jsxs("div",{className:"flex space-x-2",children:[x&&a&&!S&&s.jsxs("button",{onClick:Q,className:"px-3 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 flex items-center",children:[s.jsx(le,{size:16,className:"mr-1"}),"Volver"]}),s.jsxs("button",{onClick:P,className:"px-3 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center",disabled:u||p,children:[s.jsx(ce,{size:16,className:`mr-1 ${u||p?"animate-spin":""}`}),"Actualizar"]})]})]}),A&&s.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4",children:[s.jsx("strong",{className:"font-bold",children:"Error: "}),s.jsx("span",{className:"block sm:inline",children:A}),s.jsx("button",{onClick:P,className:"underline ml-2 text-red-700 hover:text-red-900",children:"Reintentar"})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow-sm flex flex-col md:flex-row overflow-hidden",style:{minHeight:"70vh"},children:[(!x||S)&&s.jsx("div",{className:"w-full md:w-1/3 border-r border-gray-200 flex flex-col scrollable-container",children:s.jsx(re,{chats:G,selectedChatId:a?.id,onSelectChat:J,loading:u||p,searchTerm:g,onSearchChange:T,statusFilter:y,onStatusFilterChange:k,unreadFilter:$,onUnreadFilterChange:z,isSeller:!1})}),(!x||!S)&&s.jsx("div",{className:"w-full md:w-2/3 flex flex-col",children:X()})]}),s.jsx(H,{})]})};export{$e as default};
//# sourceMappingURL=UserChatPage-fe6ulajp.js.map
