import{j as e,d as ce,a1 as le,T as de,V as me,k as fe,au as ue,at as xe}from"./ui-vendor-BUNMIuFe.js";import{r as s,u as he,R as Q,L as U}from"./react-vendor-Cy458wKG.js";import{u as ge,c as T,A as L,C as w,f as O}from"./admin-chunk-BNcFjXlJ.js";import{u as X}from"./chat-chunk-BRsdDZXf.js";import{u as pe}from"./checkout-chunk-C5n3Mg9L.js";import{b as ve}from"./index-BStY3ojk.js";import{u as ye}from"./useImageCache-BZuULX8l.js";import{u as be}from"./useAutoPrefetch-DYmcqHFG.js";import"./utils-vendor-DeGC_a19.js";import"./seller-chunk-6swISJwY.js";const Z=()=>{const[u,l]=s.useState(!1),[d,n]=s.useState(null),{isAuthenticated:x}=X(),{invalidateMany:g}=ge();return{loading:u,error:d,getUserFavorites:async(r=10,i=0)=>{try{if(l(!0),n(null),!x)throw new Error("User must be authenticated to get favorites");const o=await T.get(L.FAVORITES.LIST,{limit:r,offset:i}),k=(o?.data||[]).map((b,p)=>({favorite:{id:b.product?.id?b.product.id+1e3:p+1e3,userId:0,productId:b.product?.id||0,notifyPriceChange:!0,notifyPromotion:!0,notifyLowStock:!0},product:b.product}));return{favorites:k,meta:o?.meta||{total:k.length,limit:r,offset:i,has_more:!1}}}catch(o){const c=o instanceof Error?o.message:"Failed to fetch favorites";return n(c),{favorites:[],meta:{total:0,limit:r,offset:i,has_more:!1}}}finally{l(!1)}},toggleFavorite:async(r,i)=>{try{if(l(!0),n(null),!x)throw new Error("User must be authenticated to toggle favorites");const o={notify_price_change:i?.notify_price_change??!0,notify_promotion:i?.notify_promotion??!0,notify_low_stock:i?.notify_low_stock??!0},c=await T.post(L.FAVORITES.TOGGLE,{product_id:r,notification_preferences:o});return g(["favorites_*","header_counters"]),{is_favorite:c?.data?.is_favorite||!1,favorite_id:c?.data?.favorite_id||null,message:c?.message||"Favorite status updated"}}catch(o){const c=o instanceof Error?o.message:"Failed to toggle favorite";throw n(c),new Error(c)}finally{l(!1)}},checkIsFavorite:async r=>{try{if(l(!0),n(null),!x)return{is_favorite:!1,favorite_id:null,notification_preferences:null};const i=await T.get(L.FAVORITES.CHECK(r));return{is_favorite:i?.data?.is_favorite||!1,favorite_id:i?.data?.favorite_id||null,notification_preferences:i?.data?.notification_preferences||null}}catch(i){const o=i instanceof Error?i.message:"Failed to check favorite status";return n(o),console.error(o),{is_favorite:!1,favorite_id:null,notification_preferences:null}}finally{l(!1)}},updateNotificationPreferences:async(r,i)=>{try{if(l(!0),n(null),!x)throw new Error("User must be authenticated to update notification preferences");const o=await T.put(L.FAVORITES.UPDATE_NOTIFICATIONS(r),i);return g(["favorites_*"]),{success:!0,message:o?.message||"Notification preferences updated",favorite:o?.data}}catch(o){const c=o instanceof Error?o.message:"Failed to update notification preferences";throw n(c),new Error(c)}finally{l(!1)}}}},je=Q.memo(({favoriteId:u,initialPreferences:l,onClose:d})=>{const[n,x]=s.useState({notify_price_change:l.notifyPriceChange,notify_promotion:l.notifyPromotion,notify_low_stock:l.notifyLowStock}),[g,C]=s.useState(!1),{updateNotificationPreferences:S}=Z(),h=s.useCallback(r=>{const{name:i,checked:o}=r.target;x(c=>({...c,[i]:o}))},[]),F=s.useCallback(async()=>{try{C(!0),await S(u,n),d()}catch(r){console.error("Error saving preferences:",r)}finally{C(!1)}},[u,n,S,d]);return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50",children:e.jsxs("div",{className:"bg-white rounded-lg p-6 max-w-md w-full shadow-xl",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold",children:"Preferencias de notificaci√≥n"}),e.jsxs("button",{onClick:d,className:"text-gray-500 hover:text-gray-700",children:[e.jsx("span",{className:"sr-only",children:"Cerrar"}),e.jsx("svg",{className:"h-6 w-6",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})]})]}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"notify_price_change",name:"notify_price_change",checked:n.notify_price_change,onChange:h,className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"notify_price_change",className:"ml-2 block text-sm text-gray-700",children:"Notificarme cambios de precio"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"notify_promotion",name:"notify_promotion",checked:n.notify_promotion,onChange:h,className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"notify_promotion",className:"ml-2 block text-sm text-gray-700",children:"Notificarme promociones"})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("input",{type:"checkbox",id:"notify_low_stock",name:"notify_low_stock",checked:n.notify_low_stock,onChange:h,className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded"}),e.jsx("label",{htmlFor:"notify_low_stock",className:"ml-2 block text-sm text-gray-700",children:"Notificarme cuando haya poco stock"})]})]}),e.jsxs("div",{className:"mt-6 flex justify-end space-x-3",children:[e.jsx("button",{onClick:d,className:"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors",children:"Cancelar"}),e.jsx("button",{onClick:F,disabled:g,className:"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50",children:g?"Guardando...":"Guardar"})]})]})})}),Ae=()=>{const[u,l]=s.useState([]),[d,n]=s.useState(!0),[x,g]=s.useState(!1),[C,S]=s.useState(null),[h,F]=s.useState(null),[r,i]=s.useState(1),[o,c]=s.useState(!1),[k,b]=s.useState(0),[p,P]=s.useState(!1),j=10,{getUserFavorites:z,toggleFavorite:$}=Z(),{isAuthenticated:E}=X(),{addToCart:D}=pe(),V=he(),{getOptimizedImageUrl:G}=ye(),{prefetchFavoritesPageData:R}=be({enabled:!0,delay:300,onPrefetchComplete:()=>console.log("‚úÖ Favorites page prefetch completed")}),{optimisticCartAdd:H,optimisticFavoriteRemove:K}=ve(),A=s.useCallback(()=>{w.removeItem("cart_user_data"),w.removeItem("cart_guest_data"),w.removeItem("header_counters");for(let t=1;t<=10;t++)w.removeItem(`user_favorites_${t}_10`);console.log("üîÑ Cache invalidado desde FavoritePage")},[]),W=s.useCallback(t=>G(t,"medium"),[G]),q=s.useCallback(t=>{if(!t)return{original:0,discounted:0,discount:0};const a=parseFloat(t.price?.toString()||"0"),m=parseFloat((t.discount_percentage||t.discount)?.toString()||"0");let f=a;return m>0&&(f=a-a*(m/100)),{original:a,discounted:f,discount:m}},[]),Y=s.useCallback((t=0,a=0)=>{const m=parseFloat(t?.toString()||"0"),f=parseInt(a?.toString()||"0");return e.jsxs("div",{className:"flex items-center",children:[[1,2,3,4,5].map(v=>e.jsx(ce,{size:14,className:`${v<=Math.round(m)?"text-yellow-400 fill-current":"text-gray-300"}`},v)),e.jsxs("span",{className:"ml-2 text-sm text-gray-600",children:[m.toFixed(1)," (",f,")"]})]})},[]),B=s.useCallback(()=>{for(let t=1;t<=Math.ceil(k/j);t++)w.removeItem(`user_favorites_${t}_${j}`);console.log("üóëÔ∏è Cache de favoritos invalidado")},[k,j]),N=s.useCallback(async()=>{const t=`user_favorites_${r}_${j}`,a=w.getItem(t);if(a&&r===1){console.log("üíæ Usando favoritos desde cache"),l(a.favorites),b(a.meta.total),c(a.meta.has_more),g(a.favorites.length===0),n(!1),a.favorites.length>0&&R();return}try{n(!0),console.log("üåê Cargando favoritos desde API");const m=(r-1)*j,f=await z(j,m),v=f.favorites.map(y=>({favorite:{id:y.favorite.id||0,userId:y.favorite.userId,productId:y.favorite.productId,notifyPriceChange:y.favorite.notifyPriceChange||!1,notifyPromotion:y.favorite.notifyPromotion||!1,notifyLowStock:y.favorite.notifyLowStock||!1},product:y.product}));l(v),b(f.meta.total),c(f.meta.has_more),g(v.length===0&&r===1);const M={favorites:v,meta:f.meta};w.setItem(t,M,3*60*1e3),r===1&&v.length>0&&R()}catch(m){console.error("Error fetching favorites:",m),S("No se pudieron cargar los favoritos. Por favor, int√©ntalo de nuevo.")}finally{n(!1)}},[z,r,j,R]),J=s.useCallback(()=>{console.log("üîÑ Forzando refresh de favoritos"),B(),i(1),n(!0),N()},[B,N]),ee=s.useCallback(async t=>{if(p){console.log("Ya se est√° procesando una acci√≥n, ignorando click");return}try{P(!0),K(),await $(t),A(),await N()}catch(a){console.error("Error removing from favorites:",a)}finally{setTimeout(()=>{P(!1)},500)}},[$,A,N,K,p]),te=s.useCallback(async t=>{if(p){console.log("Ya se est√° procesando una acci√≥n, ignorando click");return}try{if(!t.stock||t.stock<=0)return;P(!0),H(),await D({productId:t.id,quantity:1}),A()}catch(a){console.error(`Error adding product ${t.id} to cart:`,a)}finally{setTimeout(()=>{P(!1)},500)}},[D,H,A,p]),ae=s.useCallback(t=>{t&&F(t)},[]),se=s.useCallback(()=>{F(null)},[]),re=s.useCallback(()=>{o&&!d&&(console.log("üìÑ Cargando m√°s favoritos - p√°gina",r+1),i(t=>t+1))},[o,d,r]),oe=s.useMemo(()=>u.map(t=>{const a=t.product;if(!a)return{...t,prices:null,imageUrl:"",isInStock:!1,ratingStars:e.jsx("div",{className:"flex items-center",children:e.jsx("span",{className:"text-sm text-gray-600",children:"Sin valorar"})})};const m=a.is_in_stock!==void 0?a.is_in_stock:a.stock>0;return{...t,prices:q(a),imageUrl:W(a),isInStock:m,ratingStars:Y(a.rating||0,a.rating_count||0)}}),[u,q,W,Y]);s.useEffect(()=>{if(!E){V("/login",{state:{from:"/favorites"}});return}if(r!==1)return;const t=`user_favorites_1_${j}`,a=w.getItem(t);a?(console.log("‚ö° Carga instant√°nea desde cache"),l(a.favorites),b(a.meta.total),c(a.meta.has_more),g(a.favorites.length===0),n(!1),Date.now()-(a.timestamp||0)>60*1e3&&setTimeout(()=>{N()},100)):N()},[E,V]),s.useEffect(()=>{E&&r>1&&N()},[E,r,N]);const ie=Q.memo(({item:t,prices:a,imageUrl:m,isInStock:f,ratingStars:v,onRemove:M,onAddToCart:y,onOpenPreferences:ne,isUpdating:I})=>{const _=t.product;return _?e.jsxs("div",{className:"flex flex-col sm:flex-row p-6 border-b border-gray-200 last:border-b-0 hover:bg-gray-50 transition-colors",children:[e.jsxs("div",{className:"sm:w-40 sm:h-40 h-60 w-full flex-shrink-0 mx-auto sm:mx-0 relative",children:[e.jsx(U,{to:`/products/${_.id}`,children:e.jsx("img",{src:m,alt:_.name,className:"w-full h-full object-contain sm:object-cover rounded-lg shadow-sm"})}),e.jsxs("div",{className:"absolute top-2 left-2 flex flex-col space-y-1",children:[a.discount>0&&e.jsxs("span",{className:"bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-md shadow-sm",children:[a.discount,"% OFF"]}),_.isNew&&e.jsx("span",{className:"bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-md shadow-sm",children:"NUEVO"})]})]}),e.jsxs("div",{className:"flex-1 sm:ml-6 mt-4 sm:mt-0 flex flex-col",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsxs("div",{children:[_.category&&e.jsx("span",{className:"inline-block text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-md mb-2 uppercase tracking-wide",children:_.category}),e.jsx(U,{to:`/products/${_.id}`,className:"block",children:e.jsx("h3",{className:"text-xl font-medium text-gray-800 hover:text-primary-600 transition-colors mb-2",children:_.name})}),e.jsx("div",{className:"mb-2",children:v}),e.jsx("div",{className:"mb-3",children:f?e.jsxs("span",{className:"inline-flex items-center text-sm text-green-600",children:[e.jsx(le,{size:14,className:"mr-1"}),"En stock"]}):e.jsxs("span",{className:"inline-flex items-center text-sm text-amber-600",children:[e.jsx(de,{size:14,className:"mr-1"}),"Agotado"]})})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsx("button",{onClick:ne,disabled:I,className:"cursor-pointer text-gray-400 hover:text-blue-500 transition-colors disabled:opacity-50","aria-label":"Configurar notificaciones",children:e.jsx(me,{size:20,className:"stroke-current"})}),e.jsx("button",{onClick:M,disabled:I,className:"cursor-pointer text-gray-400 hover:text-red-500 transition-colors disabled:opacity-50","aria-label":"Eliminar de favoritos",children:e.jsx(fe,{size:20,className:"stroke-current"})})]})]}),e.jsxs("div",{className:"mt-auto pt-4 flex flex-wrap sm:flex-nowrap items-center justify-between",children:[e.jsx("div",{className:"flex items-center mb-3 sm:mb-0",children:a.discount>0?e.jsxs(e.Fragment,{children:[e.jsx("span",{className:"font-bold text-primary-600 text-xl",children:O(a.discounted)}),e.jsx("span",{className:"text-sm text-gray-500 line-through ml-2",children:O(a.original)}),e.jsxs("span",{className:"ml-3 px-2 py-1 text-xs font-semibold text-white bg-red-500 rounded",children:[a.discount,"% DESCUENTO"]})]}):e.jsx("span",{className:"font-bold text-primary-600 text-xl",children:O(a.original)})}),e.jsxs("button",{onClick:y,disabled:!f||I,className:`cursor-pointer inline-flex items-center px-5 py-2.5 rounded-lg text-white font-medium transition-all disabled:opacity-50 ${f&&!I?"bg-primary-600 hover:bg-primary-700 shadow-sm hover:shadow":"bg-gray-400 cursor-not-allowed"}`,children:[e.jsx(ue,{size:18,className:"mr-2"}),I?"Agregando...":f?"A√±adir al carrito":"Agotado"]})]})]})]}):null});return e.jsxs("div",{className:"container mx-auto px-10 lg:px-20 py-10",children:[e.jsxs("div",{className:"flex flex-wrap justify-between items-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Mis Favoritos"}),e.jsxs("div",{className:"flex items-center space-x-4",children:[!x&&!d&&e.jsxs("div",{className:"text-sm text-gray-500 px-3 py-1.5 bg-gray-100 rounded-full",children:[k," ",k===1?"producto":"productos"," en tu lista"]}),!x&&e.jsx("button",{onClick:J,disabled:d||p,className:"text-sm text-blue-600 hover:text-blue-700 disabled:opacity-50 px-3 py-1.5 border border-blue-200 rounded-lg hover:bg-blue-50 transition-colors",children:d?"Actualizando...":"Actualizar"})]})]}),C&&e.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6",children:[C,e.jsx("button",{className:"ml-2 underline",onClick:J,children:"Reintentar"})]}),d?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600"})}):x?e.jsxs("div",{className:"text-center py-20 bg-gradient-to-b from-gray-50 to-white rounded-xl shadow-md",children:[e.jsx(xe,{className:"mx-auto h-16 w-16 text-red-100 mb-6"}),e.jsx("h2",{className:"text-2xl font-semibold text-gray-700 mb-3",children:"Tu lista de favoritos est√° vac√≠a"}),e.jsx("p",{className:"text-gray-500 mb-8 max-w-md mx-auto",children:"Guarda los productos que te gusten para verlos m√°s tarde."}),e.jsx(U,{to:"/products",className:"inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 shadow-sm hover:shadow transition-all",children:"Explorar productos"})]}):e.jsxs("div",{className:"bg-white rounded-xl shadow-lg overflow-hidden",children:[oe.map(t=>e.jsx(ie,{item:t,prices:t.prices,imageUrl:t.imageUrl,isInStock:t.isInStock,ratingStars:t.ratingStars,onRemove:()=>ee(t.product.id),onAddToCart:()=>te(t.product),onOpenPreferences:()=>ae(t.favorite.id),isUpdating:p},t.favorite.id)),o&&e.jsx("div",{className:"flex justify-center py-4",children:e.jsx("button",{onClick:re,disabled:d||p,className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 disabled:opacity-50",children:d?"Cargando...":"Cargar m√°s favoritos"})})]}),h!==null&&e.jsx(je,{favoriteId:h,initialPreferences:{notifyPriceChange:u.find(t=>t.favorite.id===h)?.favorite.notifyPriceChange||!0,notifyPromotion:u.find(t=>t.favorite.id===h)?.favorite.notifyPromotion||!0,notifyLowStock:u.find(t=>t.favorite.id===h)?.favorite.notifyLowStock||!0},onClose:se})]})};export{Ae as default};
//# sourceMappingURL=FavoritePage-BtV7cDxI.js.map
