{"version":3,"file":"chat-chunk-C3LrqA3R.js","sources":["../../src/infrastructure/services/GoogleAuthService.ts","../../src/core/services/AuthService.ts","../../src/core/useCases/user/LoginUseCase.ts","../../src/core/useCases/user/RegisterUseCase.ts","../../src/core/useCases/user/UpdateProfileUseCase.ts","../../src/core/useCases/user/GoogleLoginUseCase.ts","../../src/core/useCases/user/GoogleRegisterUseCase.ts","../../src/presentation/hooks/useAuth.ts","../../src/utils/dateUtils.ts","../../node_modules/date-fns/locale/es/_lib/formatDistance.js","../../node_modules/date-fns/locale/es/_lib/formatLong.js","../../node_modules/date-fns/locale/es/_lib/formatRelative.js","../../node_modules/date-fns/locale/es/_lib/localize.js","../../node_modules/date-fns/locale/es/_lib/match.js","../../node_modules/date-fns/locale/es.js","../../src/presentation/components/chat/ChatList.tsx","../../src/presentation/components/chat/ChatMessages.tsx","../../src/presentation/hooks/useRealTimeChat.ts","../../src/presentation/components/chat/ChatHeader.tsx","../../src/presentation/components/chat/MessageForm.tsx"],"sourcesContent":["// src/infrastructure/services/GoogleAuthService.ts - CORREGIDO PARA PRODUCCI√ìN\r\n\r\ninterface GoogleAuthResponse {\r\n  success: boolean;\r\n  user?: any;\r\n  error?: string;\r\n}\r\n\r\nexport class GoogleAuthService {\r\n  private static instance: GoogleAuthService;\r\n  private isInitialized = false;\r\n  private clientId = '581090375629-kds9jjgs2pk60iqe05fmjhpf6pps2nsv.apps.googleusercontent.com';\r\n  private baseApiUrl = `${import.meta.env.VITE_URL_BASE || 'https://api.comersia.app'}/api`;\r\n\r\n  private constructor() {}\r\n\r\n  public static getInstance(): GoogleAuthService {\r\n    if (!GoogleAuthService.instance) {\r\n      GoogleAuthService.instance = new GoogleAuthService();\r\n    }\r\n    return GoogleAuthService.instance;\r\n  }\r\n\r\n  /**\r\n   * M√©todo principal - Siempre usa redirect en producci√≥n\r\n   */\r\n  async authenticateWithGoogle(action: 'login' | 'register'): Promise<GoogleAuthResponse> {\r\n    try {\r\n      console.log(`üîê Iniciando ${action} con Google...`);\r\n      \r\n      // Debug info para producci√≥n\r\n      console.log('üîç Debug OAuth:', {\r\n        hostname: window.location.hostname,\r\n        protocol: window.location.protocol,\r\n        isProduction: this.isProduction(),\r\n        baseApiUrl: this.baseApiUrl,\r\n        clientId: this.clientId.substring(0, 20) + '...'\r\n      });\r\n      \r\n      // En producci√≥n, siempre usar redirect (m√°s confiable)\r\n      if (this.shouldUseRedirect()) {\r\n        console.log('üîÑ Usando m√©todo redirect (recomendado para producci√≥n)');\r\n        return this.authenticateWithRedirect(action);\r\n      }\r\n\r\n      // Solo intentar FedCM en localhost si est√° disponible\r\n      console.log('üÜï Intentando m√©todo FedCM...');\r\n      await this.initialize();\r\n      return this.authenticateWithFedCM(action);\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error en authenticateWithGoogle:', error);\r\n      \r\n      // Fallback a redirect siempre\r\n      console.log('üîÑ Fallback a m√©todo redirect...');\r\n      return this.authenticateWithRedirect(action);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * M√©todo de redirect (m√°s confiable para producci√≥n)\r\n   */\r\n  private async authenticateWithRedirect(action: 'login' | 'register'): Promise<GoogleAuthResponse> {\r\n    try {\r\n      console.log(`üîÑ Usando m√©todo de redirect para ${action}...`);\r\n      \r\n      // Guardar estado en localStorage\r\n      localStorage.setItem('google_oauth_action', action);\r\n      localStorage.setItem('google_oauth_return_url', window.location.pathname);\r\n      \r\n      // Verificar configuraci√≥n antes de redirigir\r\n      if (!this.clientId || !this.baseApiUrl) {\r\n        throw new Error('Configuraci√≥n de Google OAuth incompleta');\r\n      }\r\n      \r\n      // Redirigir al backend\r\n      const redirectUrl = `${this.baseApiUrl}/auth/google/redirect?action=${action}`;\r\n      console.log('üåê Redirigiendo a:', redirectUrl);\r\n      \r\n      window.location.href = redirectUrl;\r\n      \r\n      // Esta promesa nunca se resuelve porque redirigimos\r\n      return new Promise(() => {});\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error en m√©todo de redirect:', error);\r\n      return {\r\n        success: false,\r\n        error: 'Error al iniciar autenticaci√≥n con Google'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * M√©todo FedCM (solo para localhost/desarrollo)\r\n   */\r\n  private async authenticateWithFedCM(action: 'login' | 'register'): Promise<GoogleAuthResponse> {\r\n    try {\r\n      console.log(`üÜï Usando m√©todo FedCM para ${action}...`);\r\n\r\n      if (!window.google?.accounts?.id) {\r\n        throw new Error('Google Identity Services no est√° disponible');\r\n      }\r\n\r\n      return new Promise((resolve) => {\r\n        // Verificar que window.google existe antes de usar\r\n        if (!window.google?.accounts?.id) {\r\n          resolve({\r\n            success: false,\r\n            error: 'Google Identity Services no disponible'\r\n          });\r\n          return;\r\n        }\r\n\r\n        // Configuraci√≥n con prompt para forzar selector de cuentas\r\n        window.google.accounts.id.initialize({\r\n          client_id: this.clientId,\r\n          callback: async (response: any) => {\r\n            try {\r\n              const result = await this.sendCredentialToBackend(response.credential, action);\r\n              resolve(result);\r\n            } catch (error) {\r\n              console.error('‚ùå Error procesando credential:', error);\r\n              resolve({\r\n                success: false,\r\n                error: error instanceof Error ? error.message : 'Error desconocido'\r\n              });\r\n            }\r\n          },\r\n          auto_select: false,\r\n          cancel_on_tap_outside: true,\r\n          context: 'signin',\r\n          ux_mode: 'popup',\r\n          // Configuraci√≥n b√°sica sin opciones experimentales\r\n          itp_support: true,\r\n        });\r\n\r\n        // Timeout para evitar que se quede colgado\r\n        const timeout = setTimeout(() => {\r\n          resolve({\r\n            success: false,\r\n            error: 'Timeout en la autenticaci√≥n con Google'\r\n          });\r\n        }, 30000); // 30 segundos\r\n\r\n        // Limpiar cualquier selecci√≥n autom√°tica previa\r\n        if (window.google?.accounts?.id) {\r\n          window.google.accounts.id.disableAutoSelect();\r\n        }\r\n        \r\n        // Mostrar prompt con manejo simplificado\r\n        if (window.google?.accounts?.id) {\r\n          window.google.accounts.id.prompt((notification: any) => {\r\n            console.log('üìä Notification:', notification);\r\n            clearTimeout(timeout);\r\n            \r\n            // Usar getMomentType() si est√° disponible, sino usar los m√©todos legacy\r\n            const momentType = notification.getMomentType?.();\r\n            \r\n            if (momentType) {\r\n              // Nuevo API\r\n              if (momentType === 'dismissed' || momentType === 'skipped') {\r\n                console.log('‚ùå Prompt fue cerrado o saltado (nuevo API)');\r\n                resolve({\r\n                  success: false,\r\n                  error: 'Autenticaci√≥n cancelada por el usuario'\r\n                });\r\n              }\r\n            } else {\r\n              // API legacy como fallback\r\n              if (notification.isNotDisplayed?.()) {\r\n                console.log('‚ùå Prompt no se mostr√≥');\r\n                resolve({\r\n                  success: false,\r\n                  error: 'No se pudo mostrar el prompt de Google'\r\n                });\r\n              } else if (notification.isSkippedMoment?.()) {\r\n                console.log('‚è≠Ô∏è Prompt fue omitido');\r\n                resolve({\r\n                  success: false,\r\n                  error: 'Autenticaci√≥n omitida por el usuario'\r\n                });\r\n              } else if (notification.isDismissedMoment?.()) {\r\n                console.log('‚ùå Prompt fue cerrado');\r\n                resolve({\r\n                  success: false,\r\n                  error: 'Autenticaci√≥n cancelada por el usuario'\r\n                });\r\n              }\r\n            }\r\n          });\r\n        }\r\n      });\r\n      \r\n    } catch (error) {\r\n      console.error('‚ùå Error en m√©todo FedCM:', error);\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Error en FedCM'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Inicializar Google Identity Services\r\n   */\r\n  async initialize(): Promise<void> {\r\n    if (this.isInitialized) return;\r\n\r\n    try {\r\n      await this.loadGoogleScript();\r\n      this.isInitialized = true;\r\n      console.log('‚úÖ Google Identity Services inicializado');\r\n    } catch (error) {\r\n      console.error('‚ùå Error inicializando Google Identity Services:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cargar script de Google\r\n   */\r\n  private async loadGoogleScript(): Promise<void> {\r\n    return new Promise((resolve, reject) => {\r\n      if (window.google?.accounts?.id) {\r\n        resolve();\r\n        return;\r\n      }\r\n\r\n      const existingScript = document.querySelector('script[src*=\"accounts.google.com\"]');\r\n      if (existingScript) {\r\n        existingScript.addEventListener('load', () => resolve());\r\n        existingScript.addEventListener('error', () => reject(new Error('Error cargando script')));\r\n        return;\r\n      }\r\n\r\n      const script = document.createElement('script');\r\n      script.src = 'https://accounts.google.com/gsi/client';\r\n      script.async = true;\r\n      script.defer = true;\r\n      \r\n      script.onload = () => {\r\n        setTimeout(() => resolve(), 200);\r\n      };\r\n      \r\n      script.onerror = () => {\r\n        reject(new Error('Error cargando script de Google'));\r\n      };\r\n      \r\n      document.head.appendChild(script);\r\n    });\r\n  }\r\n\r\n  /**\r\n   * Determinar si debe usar redirect - SIEMPRE true en producci√≥n\r\n   */\r\n  private shouldUseRedirect(): boolean {\r\n    // En producci√≥n (comersia.app), SIEMPRE usar redirect\r\n    const isProduction = this.isProduction();\r\n    const forceRedirect = localStorage.getItem('google_auth_force_redirect') === 'true';\r\n    const isLocalhost = window.location.hostname === 'localhost';\r\n    \r\n    // Usar redirect en producci√≥n, cuando est√° forzado, o en localhost por defecto\r\n    return isProduction || forceRedirect || isLocalhost;\r\n  }\r\n\r\n  /**\r\n   * Verificar si estamos en producci√≥n\r\n   */\r\n  private isProduction(): boolean {\r\n    return window.location.hostname === 'comersia.app';\r\n  }\r\n\r\n  /**\r\n   * Enviar credential al backend\r\n   */\r\n  private async sendCredentialToBackend(credential: string, action: 'login' | 'register'): Promise<GoogleAuthResponse> {\r\n    try {\r\n      console.log('üì§ Enviando credential al backend...', {\r\n        action,\r\n        apiUrl: this.baseApiUrl,\r\n        credentialLength: credential.length\r\n      });\r\n\r\n      const response = await fetch(`${this.baseApiUrl}/auth/google/authenticate`, {\r\n        method: 'POST',\r\n        headers: {\r\n          'Content-Type': 'application/json',\r\n          'Accept': 'application/json'\r\n        },\r\n        body: JSON.stringify({\r\n          token: credential,\r\n          action: action\r\n        })\r\n      });\r\n\r\n      console.log('üì• Respuesta del backend:', {\r\n        status: response.status,\r\n        statusText: response.statusText,\r\n        ok: response.ok\r\n      });\r\n\r\n      const data = await response.json();\r\n\r\n      if (!response.ok) {\r\n        throw new Error(data.message || 'Error en la autenticaci√≥n');\r\n      }\r\n\r\n      console.log('‚úÖ Backend response exitosa');\r\n      return {\r\n        success: true,\r\n        user: data\r\n      };\r\n    } catch (error) {\r\n      console.error('‚ùå Error enviando credential al backend:', error);\r\n      return {\r\n        success: false,\r\n        error: error instanceof Error ? error.message : 'Error de comunicaci√≥n'\r\n      };\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Cerrar sesi√≥n\r\n   */\r\n  async signOut(): Promise<void> {\r\n    try {\r\n      if (window.google?.accounts?.id) {\r\n        window.google.accounts.id.disableAutoSelect();\r\n      }\r\n      \r\n      localStorage.removeItem('google_oauth_action');\r\n      localStorage.removeItem('google_oauth_return_url');\r\n      localStorage.removeItem('google_auth_force_redirect');\r\n      \r\n      console.log('‚úÖ Sesi√≥n de Google cerrada');\r\n    } catch (error) {\r\n      console.warn('Error al cerrar sesi√≥n de Google:', error);\r\n    }\r\n  }\r\n\r\n  /**\r\n   * Configurar para usar m√©todo espec√≠fico\r\n   */\r\n  setAuthMethod(method: 'redirect' | 'fedcm'): void {\r\n    console.log('üîß Configurando m√©todo de auth:', method);\r\n    localStorage.setItem('google_auth_force_redirect', method === 'redirect' ? 'true' : 'false');\r\n  }\r\n\r\n  /**\r\n   * Verificar configuraci√≥n\r\n   */\r\n  async checkConfiguration(): Promise<{ isConfigured: boolean; errors: string[]; warnings: string[] }> {\r\n    const errors: string[] = [];\r\n    const warnings: string[] = [];\r\n    \r\n    console.log('üîç Verificando configuraci√≥n de Google OAuth...');\r\n    \r\n    // Verificar Client ID\r\n    if (!this.clientId || this.clientId.includes('your-google-client-id')) {\r\n      errors.push('Client ID de Google no configurado correctamente');\r\n    }\r\n    \r\n    // Verificar API URL\r\n    if (!this.baseApiUrl) {\r\n      errors.push('URL del API no configurada');\r\n    }\r\n    \r\n    // Verificar si estamos en origen seguro\r\n    const isSecureOrigin = location.protocol === 'https:' || location.hostname === 'localhost';\r\n    if (!isSecureOrigin) {\r\n      errors.push('Google OAuth requiere origen seguro (HTTPS o localhost)');\r\n    }\r\n    \r\n    // Verificar FedCM support (solo warning)\r\n    if (!window.CredentialsContainer && !this.isProduction()) {\r\n      warnings.push('FedCM no est√° disponible en este navegador');\r\n    }\r\n    \r\n    // En producci√≥n, recomendar redirect\r\n    if (this.isProduction()) {\r\n      console.log('üè≠ Producci√≥n detectada - usando m√©todo redirect');\r\n    }\r\n    \r\n    // Test b√°sico de conectividad (no bloquear si falla)\r\n    try {\r\n      const testImg = new Image();\r\n      testImg.src = 'https://accounts.google.com/favicon.ico';\r\n    } catch (error) {\r\n      warnings.push('Posible problema con Content Security Policy');\r\n    }\r\n    \r\n    const result = {\r\n      isConfigured: errors.length === 0,\r\n      errors,\r\n      warnings\r\n    };\r\n\r\n    console.log('üìä Resultado de configuraci√≥n:', result);\r\n    \r\n    return result;\r\n  }\r\n\r\n  /**\r\n   * Diagn√≥stico completo para debugging\r\n   */\r\n  async diagnose(): Promise<void> {\r\n    console.log('üî¨ === DIAGN√ìSTICO GOOGLE OAUTH ===');\r\n    \r\n    const config = await this.checkConfiguration();\r\n    \r\n    console.log('üåç Entorno:', {\r\n      hostname: window.location.hostname,\r\n      protocol: window.location.protocol,\r\n      userAgent: navigator.userAgent,\r\n      isProduction: this.isProduction(),\r\n      shouldUseRedirect: this.shouldUseRedirect()\r\n    });\r\n    \r\n    console.log('‚öôÔ∏è Configuraci√≥n:', {\r\n      clientId: this.clientId.substring(0, 20) + '...',\r\n      baseApiUrl: this.baseApiUrl,\r\n      hasGoogleScript: !!window.google,\r\n      isConfigured: config.isConfigured\r\n    });\r\n    \r\n    if (config.errors.length > 0) {\r\n      console.log('‚ùå Errores:', config.errors);\r\n    }\r\n    \r\n    if (config.warnings.length > 0) {\r\n      console.log('‚ö†Ô∏è Advertencias:', config.warnings);\r\n    }\r\n    \r\n    console.log('üíæ LocalStorage:', {\r\n      oauth_action: localStorage.getItem('google_oauth_action'),\r\n      return_url: localStorage.getItem('google_oauth_return_url'),\r\n      force_redirect: localStorage.getItem('google_auth_force_redirect')\r\n    });\r\n    \r\n    console.log('üî¨ === FIN DIAGN√ìSTICO ===');\r\n  }\r\n}\r\n\r\n// Declaraciones globales para TypeScript\r\ndeclare global {\r\n  interface Window {\r\n    google?: {\r\n      accounts: {\r\n        id: {\r\n          initialize: (config: any) => void;\r\n          prompt: (callback?: (notification: any) => void) => void;\r\n          renderButton: (element: HTMLElement | null, config: any) => void;\r\n          disableAutoSelect: () => void;\r\n        };\r\n      };\r\n    };\r\n    CredentialsContainer?: any;\r\n  }\r\n}\r\n\r\nexport default GoogleAuthService;","import axios, { AxiosError } from 'axios';\r\nimport type { \r\n  User, \r\n  UserLoginData, \r\n  UserRegistrationData, \r\n  AuthResponse,\r\n  UserProfileUpdateData\r\n} from '../domain/entities/User';\r\nimport { LocalStorageService } from '../../infrastructure/services/LocalStorageService';\r\nimport appConfig from '../../config/appConfig';\r\nimport { API_ENDPOINTS } from '../../constants/apiEndpoints';\r\nimport axiosInstance from '../../infrastructure/api/axiosConfig';\r\nimport GoogleAuthService from \"../../infrastructure/services/GoogleAuthService\";\r\n\r\n// Instancia del servicio de almacenamiento local\r\nconst storageService = new LocalStorageService();\r\n\r\n/**\r\n * Servicio de autenticaci√≥n\r\n */\r\nexport class AuthService {\r\n\t/**\r\n\t * Inicia sesi√≥n de usuario\r\n\t */\r\n\tasync login(credentials: UserLoginData): Promise<AuthResponse> {\r\n\t\ttry {\r\n\t\t\tconsole.log(\"AuthService: Realizando solicitud de login\");\r\n\t\t\t// Realizar la solicitud de login\r\n\t\t\tconst response = await axiosInstance.post(\r\n\t\t\t\tAPI_ENDPOINTS.AUTH.LOGIN,\r\n\t\t\t\tcredentials\r\n\t\t\t);\r\n\r\n\t\t\t// Verificar si hay datos en la respuesta\r\n\t\t\tif (!response || !response.data) {\r\n\t\t\t\tthrow new Error(\"Respuesta del servidor vac√≠a\");\r\n\t\t\t}\r\n\r\n\t\t\tlet authData: AuthResponse = response.data;\r\n\r\n\t\t\t// Validar token de acceso\r\n\t\t\tif (!authData.access_token) {\r\n\t\t\t\tthrow new Error(\"Token de acceso no encontrado en la respuesta\");\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log(\"AuthService: Login exitoso, token recibido\");\r\n\t\t\tconsole.log(\r\n\t\t\t\t\"Token being saved:\",\r\n\t\t\t\tauthData.access_token.substring(0, 10) + \"...\"\r\n\t\t\t);\r\n\t\t\t// Almacenar token en localStorage\r\n\t\t\tstorageService.setItem(\r\n\t\t\t\tappConfig.storage.authTokenKey,\r\n\t\t\t\tauthData.access_token\r\n\t\t\t);\r\n\r\n\t\t\t// Almacenar informaci√≥n de usuario si existe\r\n\t\t\tif (authData.user) {\r\n\t\t\t\tstorageService.setItem(appConfig.storage.userKey, authData.user);\r\n\t\t\t}\r\n\r\n\t\t\treturn authData;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"AuthService: Error de login:\", error);\r\n\r\n\t\t\t// Manejo detallado de errores\r\n\t\t\tif (axios.isAxiosError(error)) {\r\n\t\t\t\tconst axiosError = error as AxiosError<any>;\r\n\r\n\t\t\t\t// Errores espec√≠ficos seg√∫n el c√≥digo HTTP\r\n\t\t\t\tif (axiosError.response?.status === 401) {\r\n\t\t\t\t\t// Usar mensaje espec√≠fico del servidor si existe\r\n\t\t\t\t\tconst serverMessage = axiosError.response.data?.message || axiosError.response.data?.error;\r\n\t\t\t\t\tthrow new Error(serverMessage || \"Credenciales incorrectas\");\r\n\t\t\t\t} else if (axiosError.response?.status === 404) {\r\n\t\t\t\t\t// Email no encontrado\r\n\t\t\t\t\tconst serverMessage = axiosError.response.data?.message || axiosError.response.data?.error;\r\n\t\t\t\t\tthrow new Error(serverMessage || \"Email no encontrado\");\r\n\t\t\t\t} else if (axiosError.response?.status === 403) {\r\n\t\t\t\t\t// Cuenta bloqueada\r\n\t\t\t\t\tconst serverMessage = axiosError.response.data?.message || axiosError.response.data?.error;\r\n\t\t\t\t\tthrow new Error(serverMessage || \"Cuenta bloqueada\");\r\n\t\t\t\t} else if (axiosError.response?.status === 423) {\r\n\t\t\t\t\t// Cuenta temporalmente bloqueada\r\n\t\t\t\t\tconst serverMessage = axiosError.response.data?.message || axiosError.response.data?.error;\r\n\t\t\t\t\tthrow new Error(serverMessage || \"Cuenta temporalmente bloqueada\");\r\n\t\t\t\t} else if (axiosError.response?.status === 422) {\r\n\t\t\t\t\t// Error de validaci√≥n\r\n\t\t\t\t\tconst validationErrors = axiosError.response.data?.errors;\r\n\t\t\t\t\tif (validationErrors) {\r\n\t\t\t\t\t\t// Convertir errores de validaci√≥n a mensaje legible\r\n\t\t\t\t\t\tconst messages = Object.values(validationErrors).flat();\r\n\t\t\t\t\t\tthrow new Error(messages.join(\". \"));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst serverMessage = axiosError.response.data?.message;\r\n\t\t\t\t\tthrow new Error(serverMessage || \"Datos de formulario inv√°lidos\");\r\n\t\t\t\t} else if (axiosError.response?.data?.message) {\r\n\t\t\t\t\t// Usar mensaje del servidor si existe\r\n\t\t\t\t\tthrow new Error(axiosError.response.data.message);\r\n\t\t\t\t} else if (axiosError.response?.data?.error) {\r\n\t\t\t\t\t// Usar mensaje de error del servidor si existe\r\n\t\t\t\t\tthrow new Error(axiosError.response.data.error);\r\n\t\t\t\t} else if (axiosError.message) {\r\n\t\t\t\t\tthrow new Error(axiosError.message);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(\"Error desconocido al iniciar sesi√≥n\");\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Generate default password validation rules dynamically\r\n\t */\r\n\tprivate getDefaultPasswordRules(minLength = 8, requireUppercase = true, requireNumbers = true, requireSpecial = true) {\r\n\t\tconst requirements: string[] = [];\r\n\t\tlet message = `La contrase√±a debe tener al menos ${minLength} caracteres`;\r\n\t\t\r\n\t\tif (requireUppercase) {\r\n\t\t\trequirements.push('al menos una letra may√∫scula');\r\n\t\t}\r\n\t\tif (requireNumbers) {\r\n\t\t\trequirements.push('al menos un n√∫mero');\r\n\t\t}\r\n\t\tif (requireSpecial) {\r\n\t\t\trequirements.push('al menos un car√°cter especial (!@#$%^&*)');\r\n\t\t}\r\n\t\t\r\n\t\tif (requirements.length > 0) {\r\n\t\t\tmessage += ' y debe incluir ' + requirements.join(', ');\r\n\t\t}\r\n\t\tmessage += '.';\r\n\t\t\r\n\t\treturn {\r\n\t\t\tminLength,\r\n\t\t\trequireSpecial,\r\n\t\t\trequireUppercase,\r\n\t\t\trequireNumbers,\r\n\t\t\tvalidationMessage: message,\r\n\t\t\trequirements\r\n\t\t};\r\n\t}\r\n\r\n\t/**\r\n\t * Obtiene las reglas de validaci√≥n de contrase√±as din√°micas\r\n\t */\r\n\tasync getPasswordValidationRules(): Promise<{\r\n\t\tminLength: number;\r\n\t\trequireSpecial: boolean;\r\n\t\trequireUppercase: boolean;\r\n\t\trequireNumbers: boolean;\r\n\t\tvalidationMessage: string;\r\n\t\trequirements: string[];\r\n\t}> {\r\n\t\ttry {\r\n\t\t\tconst response = await axiosInstance.get(\r\n\t\t\t\tAPI_ENDPOINTS.AUTH.PASSWORD_VALIDATION_RULES\r\n\t\t\t);\r\n\r\n\t\t\tif (response?.data?.status === 'success') {\r\n\t\t\t\treturn response.data.data;\r\n\t\t\t}\r\n\r\n\t\t\t// Valores por defecto si hay error\r\n\t\t\treturn this.getDefaultPasswordRules();\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"Error al obtener reglas de validaci√≥n:\", error);\r\n\t\t\t// Valores por defecto si hay error\r\n\t\t\treturn this.getDefaultPasswordRules();\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Registra un nuevo usuario\r\n\t */\r\n\tasync register(userData: UserRegistrationData): Promise<AuthResponse> {\r\n\t\ttry {\r\n\t\t\tconsole.log(\"AuthService: Realizando solicitud de registro\");\r\n\r\n\t\t\tconst response = await axiosInstance.post(\r\n\t\t\t\tAPI_ENDPOINTS.AUTH.REGISTER,\r\n\t\t\t\tuserData\r\n\t\t\t);\r\n\r\n\t\t\t// Verificar si hay datos en la respuesta\r\n\t\t\tif (!response || !response.data) {\r\n\t\t\t\tthrow new Error(\"Respuesta del servidor vac√≠a\");\r\n\t\t\t}\r\n\r\n\t\t\t// Asignamos authData directamente de la respuesta\r\n\t\t\tconst authData: AuthResponse = response.data;\r\n\r\n\t\t\t// Validar token de acceso\r\n\t\t\tif (!authData.access_token) {\r\n\t\t\t\tthrow new Error(\"Token de acceso no encontrado en la respuesta\");\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log(\"AuthService: Registro exitoso, token recibido\");\r\n\r\n\t\t\t// Almacenar token en localStorage\r\n\t\t\tstorageService.setItem(\r\n\t\t\t\tappConfig.storage.authTokenKey,\r\n\t\t\t\tauthData.access_token\r\n\t\t\t);\r\n\r\n\t\t\t// Almacenar informaci√≥n de usuario si existe\r\n\t\t\tif (authData.user) {\r\n\t\t\t\tstorageService.setItem(appConfig.storage.userKey, authData.user);\r\n\t\t\t}\r\n\r\n\t\t\treturn authData;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"AuthService: Error de registro:\", error);\r\n\r\n\t\t\t// Manejo detallado de errores\r\n\t\t\tif (axios.isAxiosError(error)) {\r\n\t\t\t\tconst axiosError = error as AxiosError<any>;\r\n\r\n\t\t\t\t// Errores espec√≠ficos seg√∫n el c√≥digo HTTP\r\n\t\t\t\tif (axiosError.response?.status === 422) {\r\n\t\t\t\t\t// Error de validaci√≥n\r\n\t\t\t\t\tconst validationErrors = axiosError.response.data?.errors;\r\n\t\t\t\t\tif (validationErrors) {\r\n\t\t\t\t\t\t// Convertir errores de validaci√≥n a mensaje legible\r\n\t\t\t\t\t\tconst messages = Object.values(validationErrors).flat();\r\n\t\t\t\t\t\tthrow new Error(messages.join(\". \"));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tconst serverMessage = axiosError.response.data?.message;\r\n\t\t\t\t\tthrow new Error(serverMessage || \"Datos de registro inv√°lidos\");\r\n\t\t\t\t} else if (axiosError.response?.status === 409) {\r\n\t\t\t\t\t// Conflicto (email ya existe)\r\n\t\t\t\t\tconst serverMessage = axiosError.response.data?.message || axiosError.response.data?.error;\r\n\t\t\t\t\tthrow new Error(serverMessage || \"Este email ya est√° registrado\");\r\n\t\t\t\t} else if (axiosError.response?.data?.message) {\r\n\t\t\t\t\t// Usar mensaje del servidor si existe\r\n\t\t\t\t\tthrow new Error(axiosError.response.data.message);\r\n\t\t\t\t} else if (axiosError.response?.data?.error) {\r\n\t\t\t\t\t// Usar mensaje de error del servidor si existe\r\n\t\t\t\t\tthrow new Error(axiosError.response.data.error);\r\n\t\t\t\t} else if (axiosError.message) {\r\n\t\t\t\t\tthrow new Error(axiosError.message);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(\"Error desconocido al registrar usuario\");\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Cierra la sesi√≥n del usuario\r\n\t */\r\n\tasync logout(): Promise<boolean> {\r\n\t\ttry {\r\n\t\t\tconsole.log(\"AuthService: Iniciando proceso de logout\");\r\n\r\n\t\t\tconst token = storageService.getItem(appConfig.storage.authTokenKey);\r\n\r\n\t\t\tif (token) {\r\n\t\t\t\ttry {\r\n\t\t\t\t\tawait axiosInstance.post(API_ENDPOINTS.AUTH.LOGOUT);\r\n\t\t\t\t\tconsole.log(\"AuthService: Logout en servidor exitoso\");\r\n\t\t\t\t} catch (error) {\r\n\t\t\t\t\tconsole.warn(\r\n\t\t\t\t\t\t\"AuthService: Error al hacer logout en servidor, continuando con logout local:\",\r\n\t\t\t\t\t\terror\r\n\t\t\t\t\t);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\t// Eliminar token y datos de usuario del almacenamiento local\r\n\t\t\tstorageService.removeItem(appConfig.storage.authTokenKey);\r\n\t\t\tstorageService.removeItem(appConfig.storage.refreshTokenKey);\r\n\t\t\tstorageService.removeItem(appConfig.storage.userKey);\r\n\r\n\t\t\tconsole.log(\"AuthService: Datos de sesi√≥n eliminados del localStorage\");\r\n\t\t\treturn true;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"AuthService: Error al cerrar sesi√≥n:\", error);\r\n\r\n\t\t\t// A pesar del error, limpiar almacenamiento local de todas formas\r\n\t\t\tstorageService.removeItem(appConfig.storage.authTokenKey);\r\n\t\t\tstorageService.removeItem(appConfig.storage.refreshTokenKey);\r\n\t\t\tstorageService.removeItem(appConfig.storage.userKey);\r\n\r\n\t\t\tthrow new Error(\"Error al cerrar sesi√≥n\");\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Obtiene los datos del usuario actual\r\n\t */\r\n\tasync getCurrentUser(): Promise<User> {\r\n\t\ttry {\r\n\t\t\tconsole.log(\"AuthService: Obteniendo datos del usuario actual\");\r\n\r\n\t\t\t// Verificar si hay token\r\n\t\t\tconst token = storageService.getItem(appConfig.storage.authTokenKey);\r\n\t\t\tif (!token) {\r\n\t\t\t\tthrow new Error(\"No hay sesi√≥n activa\");\r\n\t\t\t}\r\n\r\n\t\t\t// Primero intentamos obtener desde el almacenamiento local\r\n\t\t\tconst cachedUser = storageService.getItem(appConfig.storage.userKey);\r\n\t\t\tif (cachedUser) {\r\n\t\t\t\tconsole.log(\"AuthService: Usando datos de usuario en cach√©\");\r\n\t\t\t\treturn cachedUser;\r\n\t\t\t}\r\n\r\n\t\t\t// Si no est√° en cach√©, solicitamos al servidor\r\n\t\t\tconsole.log(\"AuthService: Solicitando datos de usuario al servidor\");\r\n\t\t\tconst response = await axiosInstance.get(API_ENDPOINTS.AUTH.ME);\r\n\r\n\t\t\t// Verificar si hay datos en la respuesta\r\n\t\t\tif (!response || !response.data) {\r\n\t\t\t\tthrow new Error(\"Respuesta del servidor vac√≠a\");\r\n\t\t\t}\r\n\r\n\t\t\t// Asignamos userData directamente de la respuesta\r\n\t\t\tconst userData: User = response.data;\r\n\r\n\t\t\t// Validar usuario\r\n\t\t\tif (!userData) {\r\n\t\t\t\tthrow new Error(\"Informaci√≥n de usuario no encontrada en la respuesta\");\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log(\"AuthService: Datos de usuario obtenidos del servidor\");\r\n\r\n\t\t\t// Almacenar en cach√©\r\n\t\t\tstorageService.setItem(appConfig.storage.userKey, userData);\r\n\r\n\t\t\treturn userData;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"AuthService: Error al obtener usuario actual:\", error);\r\n\r\n\t\t\tif (axios.isAxiosError(error) && error.response?.status === 401) {\r\n\t\t\t\t// Token inv√°lido o expirado, limpiar almacenamiento\r\n\t\t\t\tstorageService.removeItem(appConfig.storage.authTokenKey);\r\n\t\t\t\tstorageService.removeItem(appConfig.storage.refreshTokenKey);\r\n\t\t\t\tstorageService.removeItem(appConfig.storage.userKey);\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(\"No se pudo obtener la informaci√≥n del usuario\");\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Actualiza el perfil del usuario\r\n\t */\r\n\tasync updateProfile(data: UserProfileUpdateData): Promise<User> {\r\n\t\ttry {\r\n\t\t\t// Imprimir datos para depuraci√≥n\r\n\t\t\tconsole.log(\"Enviando actualizaci√≥n de perfil:\", data);\r\n\r\n\t\t\t// Usar la ruta correcta seg√∫n la documentaci√≥n de API proporcionada: PUT /api/profile\r\n\t\t\tconst response = await axiosInstance.put(\"/profile\", data);\r\n\r\n\t\t\t// Verificar si hay datos en la respuesta\r\n\t\t\tif (!response || !response.data) {\r\n\t\t\t\tthrow new Error(\"Respuesta del servidor vac√≠a\");\r\n\t\t\t}\r\n\r\n\t\t\t// Asignamos userData directamente de la respuesta\r\n\t\t\tconst userData: User = response.data;\r\n\r\n\t\t\t// Validar usuario\r\n\t\t\tif (!userData) {\r\n\t\t\t\tthrow new Error(\"Informaci√≥n de usuario no encontrada en la respuesta\");\r\n\t\t\t}\r\n\r\n\t\t\t// Actualizar en cach√©\r\n\t\t\tstorageService.setItem(appConfig.storage.userKey, userData);\r\n\r\n\t\t\treturn userData;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"AuthService: Error al actualizar perfil:\", error);\r\n\r\n\t\t\t// Manejo detallado de errores\r\n\t\t\tif (axios.isAxiosError(error)) {\r\n\t\t\t\tconst axiosError = error as AxiosError<any>;\r\n\r\n\t\t\t\tif (axiosError.response?.status === 401) {\r\n\t\t\t\t\tthrow new Error(\"No autorizado para actualizar el perfil\");\r\n\t\t\t\t} else if (axiosError.response?.status === 422) {\r\n\t\t\t\t\t// Error de validaci√≥n\r\n\t\t\t\t\tconst validationErrors = axiosError.response.data?.errors;\r\n\t\t\t\t\tif (validationErrors) {\r\n\t\t\t\t\t\t// Convertir errores de validaci√≥n a mensaje legible\r\n\t\t\t\t\t\tconst messages = Object.values(validationErrors).flat();\r\n\t\t\t\t\t\tthrow new Error(messages.join(\". \"));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthrow new Error(\"Datos de perfil inv√°lidos\");\r\n\t\t\t\t} else if (axiosError.response?.data?.message) {\r\n\t\t\t\t\tthrow new Error(axiosError.response.data.message);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(\"No se pudo actualizar el perfil\");\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Solicita restablecimiento de contrase√±a\r\n\t */\r\n\tasync forgotPasswordEmail(email: string): Promise<boolean> {\r\n\t\ttry {\r\n\t\t\tconst response = await axiosInstance.post(\r\n\t\t\t\tAPI_ENDPOINTS.AUTH.FORGOT_PASSWORD_EMAIL,\r\n\t\t\t\t{email}\r\n\t\t\t);\r\n\r\n\t\t\t// Verificar resultado - debe tener status success y email_sent true\r\n\t\t\tconst success = response.data?.status === \"success\" && response.data?.email_sent === true;\r\n\t\t\treturn success;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"Error al solicitar recuperaci√≥n de contrase√±a:\", error);\r\n\r\n\t\t\tif (axios.isAxiosError(error)) {\r\n\t\t\t\tconst axiosError = error as AxiosError<any>;\r\n\r\n\t\t\t\tif (axiosError.response?.status === 422) {\r\n\t\t\t\t\t// Error de validaci√≥n (email inv√°lido)\r\n\t\t\t\t\tthrow new Error(\"Correo electr√≥nico inv√°lido\");\r\n\t\t\t\t} else if (axiosError.response?.data?.message) {\r\n\t\t\t\t\tthrow new Error(axiosError.response.data.message);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(\r\n\t\t\t\t\"No se pudo procesar la solicitud de recuperaci√≥n de contrase√±a\"\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Solicita restablecimiento de contrase√±a\r\n\t */\r\n\tasync forgotPasswordToken(email: string): Promise<boolean> {\r\n\t\ttry {\r\n\t\t\tconst response = await axiosInstance.post(\r\n\t\t\t\tAPI_ENDPOINTS.AUTH.FORGOT_PASSWORD_TOKEN,\r\n\t\t\t\t{email}\r\n\t\t\t);\r\n\r\n\t\t\t// Verificar resultado\r\n\t\t\tconst success =\r\n\t\t\t\tresponse.data?.success || response.data?.status === \"success\" || false;\r\n\t\t\treturn success;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"Error al solicitar recuperaci√≥n de contrase√±a:\", error);\r\n\r\n\t\t\tif (axios.isAxiosError(error)) {\r\n\t\t\t\tconst axiosError = error as AxiosError<any>;\r\n\r\n\t\t\t\tif (axiosError.response?.status === 422) {\r\n\t\t\t\t\t// Error de validaci√≥n (email inv√°lido)\r\n\t\t\t\t\tthrow new Error(\"Correo electr√≥nico inv√°lido\");\r\n\t\t\t\t} else if (axiosError.response?.data?.message) {\r\n\t\t\t\t\tthrow new Error(axiosError.response.data.message);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(\r\n\t\t\t\t\"No se pudo procesar la solicitud de recuperaci√≥n de contrase√±a\"\r\n\t\t\t);\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Restablece la contrase√±a del usuario\r\n\t */\r\n\tasync resetPassword(\r\n\t\ttoken: string,\r\n\t\temail: string,\r\n\t\tpassword: string,\r\n\t\tpasswordConfirmation: string\r\n\t): Promise<boolean> {\r\n\t\ttry {\r\n\t\t\tconst response = await axiosInstance.post(\r\n\t\t\t\tAPI_ENDPOINTS.AUTH.RESET_PASSWORD,\r\n\t\t\t\t{\r\n\t\t\t\t\ttoken,\r\n\t\t\t\t\temail,\r\n\t\t\t\t\tpassword,\r\n\t\t\t\t\tpassword_confirmation: passwordConfirmation,\r\n\t\t\t\t}\r\n\t\t\t);\r\n\r\n\t\t\t// Verificar resultado\r\n\t\t\tconst success =\r\n\t\t\t\tresponse.data?.success || response.data?.status === \"success\" || false;\r\n\t\t\treturn success;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"Error al restablecer contrase√±a:\", error);\r\n\r\n\t\t\tif (axios.isAxiosError(error)) {\r\n\t\t\t\tconst axiosError = error as AxiosError<any>;\r\n\r\n\t\t\t\tif (axiosError.response?.status === 422) {\r\n\t\t\t\t\t// Error de validaci√≥n\r\n\t\t\t\t\tconst validationErrors = axiosError.response.data?.errors;\r\n\t\t\t\t\tif (validationErrors) {\r\n\t\t\t\t\t\tconst messages = Object.values(validationErrors).flat();\r\n\t\t\t\t\t\tthrow new Error(messages.join(\". \"));\r\n\t\t\t\t\t}\r\n\t\t\t\t\tthrow new Error(\r\n\t\t\t\t\t\t\"Datos inv√°lidos para restablecimiento de contrase√±a\"\r\n\t\t\t\t\t);\r\n\t\t\t\t} else if (axiosError.response?.data?.message) {\r\n\t\t\t\t\tthrow new Error(axiosError.response.data.message);\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(\"No se pudo restablecer la contrase√±a\");\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Verifica si el usuario est√° actualmente autenticado\r\n\t */\r\n\tisAuthenticated(): boolean {\r\n\t\treturn !!storageService.getItem(appConfig.storage.authTokenKey);\r\n\t}\r\n\r\n\t/**\r\n\t * Actualiza el token de acceso usando el token de actualizaci√≥n\r\n\t */\r\n\tasync refreshToken(): Promise<boolean> {\r\n\t\ttry {\r\n\t\t\tconst response = await axiosInstance.post(API_ENDPOINTS.AUTH.REFRESH);\r\n\r\n\t\t\t// Verificar si hay datos en la respuesta\r\n\t\t\tif (!response) {\r\n\t\t\t\tthrow new Error(\"Respuesta del servidor vac√≠a\");\r\n\t\t\t}\r\n\r\n\t\t\t// Acceder al token directamente\r\n\t\t\tconst newToken = response.data?.access_token;\r\n\r\n\t\t\tif (!newToken) {\r\n\t\t\t\tthrow new Error(\"Token no encontrado en la respuesta\");\r\n\t\t\t}\r\n\r\n\t\t\t// Actualizar token en localStorage\r\n\t\t\tstorageService.setItem(appConfig.storage.authTokenKey, newToken);\r\n\r\n\t\t\treturn true;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"Error al actualizar el token:\", error);\r\n\r\n\t\t\tif (axios.isAxiosError(error) && error.response?.status === 401) {\r\n\t\t\t\t// Token de actualizaci√≥n expirado o inv√°lido\r\n\t\t\t\tstorageService.removeItem(appConfig.storage.authTokenKey);\r\n\t\t\t\tstorageService.removeItem(appConfig.storage.userKey);\r\n\t\t\t}\r\n\r\n\t\t\treturn false;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Verifica el correo electr√≥nico del usuario\r\n\t */\r\n\tasync verifyEmail(id: number, hash: string): Promise<boolean> {\r\n\t\ttry {\r\n\t\t\tconst response = await axiosInstance.get(\r\n\t\t\t\tAPI_ENDPOINTS.AUTH.VERIFY_EMAIL(id, hash)\r\n\t\t\t);\r\n\r\n\t\t\t// Verificar resultado\r\n\t\t\tconst success =\r\n\t\t\t\tresponse.data?.success || response.data?.status === \"success\" || false;\r\n\t\t\treturn success;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"Error al verificar email:\", error);\r\n\r\n\t\t\tif (axios.isAxiosError(error) && error.response?.data?.message) {\r\n\t\t\t\tthrow new Error(error.response.data.message);\r\n\t\t\t}\r\n\r\n\t\t\tthrow new Error(\"No se pudo verificar el correo electr√≥nico\");\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Login with Google\r\n\t */\r\n\tasync loginWithGoogle(): Promise<AuthResponse | null> {\r\n\t\ttry {\r\n\t\t\tconsole.log(\"üîê Iniciando login con Google...\");\r\n\r\n\t\t\tconst googleAuthService = GoogleAuthService.getInstance();\r\n\t\t\tconst result = await googleAuthService.authenticateWithGoogle(\"login\");\r\n\r\n\t\t\tif (!result.success) {\r\n\t\t\t\tthrow new Error(result.error || \"Error en el login con Google\");\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log(\"‚úÖ Login con Google exitoso\");\r\n\t\t\treturn result.user;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"‚ùå Error en login con Google:\", error);\r\n\t\t\tthrow error;\r\n\t\t}\r\n\t}\r\n\r\n\t/**\r\n\t * Register with Google\r\n\t */\r\n\tasync registerWithGoogle(): Promise<AuthResponse | null> {\r\n\t\ttry {\r\n\t\t\tconsole.log(\"üîê Iniciando registro con Google...\");\r\n\r\n\t\t\tconst googleAuthService = GoogleAuthService.getInstance();\r\n\t\t\tconst result = await googleAuthService.authenticateWithGoogle(\"register\");\r\n\r\n\t\t\tif (!result.success) {\r\n\t\t\t\tthrow new Error(result.error || \"Error en el registro con Google\");\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log(\"‚úÖ Registro con Google exitoso\");\r\n\t\t\treturn result.user;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"‚ùå Error en registro con Google:\", error);\r\n\t\t\tthrow error;\r\n\t\t}\r\n\t}\r\n}","import { AuthService } from '../../services/AuthService';\r\nimport { LocalStorageService } from '../../../infrastructure/services/LocalStorageService';\r\nimport type { UserLoginData, AuthResponse } from '../../domain/entities/User';\r\nimport appConfig from '../../../config/appConfig';\r\n\r\n/**\r\n * Caso de uso para el inicio de sesi√≥n\r\n * Centraliza la l√≥gica del proceso de login para mantener la\r\n * separaci√≥n de responsabilidades\r\n */\r\nexport class LoginUseCase {\r\n  private authService: AuthService;\r\n  private storageService: LocalStorageService;\r\n\r\n  constructor() {\r\n    this.authService = new AuthService();\r\n    this.storageService = new LocalStorageService();\r\n  }\r\n\r\n  /**\r\n   * Ejecuta el proceso de inicio de sesi√≥n\r\n   * @param credentials Credenciales del usuario\r\n   * @returns Datos de autenticaci√≥n o null si falla\r\n   */\r\n  async execute(credentials: UserLoginData): Promise<AuthResponse | null> {\r\n    try {\r\n      // Llamada al servicio de autenticaci√≥n\r\n      const authResponse = await this.authService.login(credentials);\r\n\r\n      // Verificar que la respuesta sea v√°lida\r\n      if (!authResponse || !authResponse.access_token) {\r\n        throw new Error('Respuesta de autenticaci√≥n inv√°lida');\r\n      }\r\n\r\n      // Guardar el token en el almacenamiento local\r\n      this.storageService.setItem(appConfig.storage.authTokenKey, authResponse.access_token);\r\n\r\n      // Si existe informaci√≥n del usuario, guardarla tambi√©n\r\n      if (authResponse.user) {\r\n        this.storageService.setItem(appConfig.storage.userKey, authResponse.user);\r\n      }\r\n\r\n      // Si existe configuraci√≥n de sesi√≥n, guardarla tambi√©n\r\n      if (authResponse.session_config) {\r\n        this.storageService.setItem('session_config', authResponse.session_config);\r\n        console.log('‚úÖ Session config guardada:', authResponse.session_config);\r\n      }\r\n\r\n      return authResponse;\r\n    } catch (error) {\r\n      console.error('Error en LoginUseCase:', error);\r\n      \r\n      // Propagar el error para que pueda ser manejado en la capa superior\r\n      if (error instanceof Error) {\r\n        throw error;\r\n      } else {\r\n        throw new Error('Error desconocido en el inicio de sesi√≥n');\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport default LoginUseCase;","import { AuthService } from '../../services/AuthService';\r\nimport { LocalStorageService } from '../../../infrastructure/services/LocalStorageService';\r\nimport type { UserRegistrationData, AuthResponse } from '../../domain/entities/User';\r\nimport appConfig from '../../../config/appConfig';\r\n\r\n/**\r\n * Caso de uso para el registro de usuarios\r\n * Centraliza la l√≥gica del proceso de registro para mantener la\r\n * separaci√≥n de responsabilidades\r\n */\r\nexport class RegisterUseCase {\r\n  private authService: AuthService;\r\n  private storageService: LocalStorageService;\r\n\r\n  constructor() {\r\n    this.authService = new AuthService();\r\n    this.storageService = new LocalStorageService();\r\n  }\r\n\r\n  /**\r\n   * Ejecuta el proceso de registro de usuario\r\n   * @param userData Datos de registro del usuario\r\n   * @returns Datos de autenticaci√≥n o null si falla\r\n   */\r\n  async execute(userData: UserRegistrationData): Promise<AuthResponse | null> {\r\n    try {\r\n      // Validaci√≥n b√°sica\r\n      if (!userData.email || !userData.password || !userData.name) {\r\n        throw new Error('Datos de registro incompletos');\r\n      }\r\n\r\n      // Llamada al servicio de autenticaci√≥n\r\n      const authResponse = await this.authService.register(userData);\r\n\r\n      // Verificar que la respuesta sea v√°lida\r\n      if (!authResponse || !authResponse.access_token) {\r\n        throw new Error('Respuesta de registro inv√°lida');\r\n      }\r\n\r\n      // Guardar el token en el almacenamiento local\r\n      this.storageService.setItem(appConfig.storage.authTokenKey, authResponse.access_token);\r\n      \r\n      // Si existe informaci√≥n del usuario, guardarla tambi√©n\r\n      if (authResponse.user) {\r\n        this.storageService.setItem(appConfig.storage.userKey, authResponse.user);\r\n      }\r\n\r\n      return authResponse;\r\n    } catch (error) {\r\n      console.error('Error en RegisterUseCase:', error);\r\n      \r\n      // Propagar el error para que pueda ser manejado en la capa superior\r\n      if (error instanceof Error) {\r\n        throw error;\r\n      } else {\r\n        throw new Error('Error desconocido en el registro');\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\nexport default RegisterUseCase;","import { AuthService } from '../../services/AuthService';\r\nimport { LocalStorageService } from '../../../infrastructure/services/LocalStorageService';\r\nimport type { User, UserProfileUpdateData } from '../../domain/entities/User';\r\nimport appConfig from '../../../config/appConfig';\r\n\r\n/**\r\n * Caso de uso para la actualizaci√≥n del perfil de usuario\r\n * Centraliza la l√≥gica del proceso de actualizaci√≥n para mantener la\r\n * separaci√≥n de responsabilidades\r\n */\r\nexport class UpdateProfileUseCase {\r\n  private authService: AuthService;\r\n  private storageService: LocalStorageService;\r\n\r\n  constructor() {\r\n    this.authService = new AuthService();\r\n    this.storageService = new LocalStorageService();\r\n  }\r\n\r\n  /**\r\n * Ejecuta el proceso de actualizaci√≥n de perfil\r\n * @param profileData Datos de perfil a actualizar\r\n * @returns Usuario actualizado o null si falla\r\n */\r\n  async execute(profileData: UserProfileUpdateData): Promise<User | null> {\r\n    try {\r\n      // Llamada al servicio de autenticaci√≥n para actualizar el perfil\r\n      const updatedUser = await this.authService.updateProfile(profileData);\r\n\r\n      // Verificar que la respuesta sea v√°lida\r\n      if (!updatedUser) {\r\n        throw new Error('Respuesta de actualizaci√≥n inv√°lida');\r\n      }\r\n\r\n      // Actualizar en localStorage\r\n      this.storageService.setItem(appConfig.storage.userKey, updatedUser);\r\n\r\n      return updatedUser;\r\n    } catch (error) {\r\n      console.error('Error en UpdateProfileUseCase:', error);\r\n\r\n      // Propagar el error para que pueda ser manejado en la capa superior\r\n      if (error instanceof Error) {\r\n        throw error;\r\n      } else {\r\n        throw new Error('Error desconocido en la actualizaci√≥n de perfil');\r\n      }\r\n    }\r\n  }\r\n}\r\nexport default UpdateProfileUseCase;","// src/core/useCases/user/GoogleLoginUseCase.ts\r\n\r\nimport {AuthService} from \"../../services/AuthService\";\r\nimport {LocalStorageService} from \"../../../infrastructure/services/LocalStorageService\";\r\nimport type {AuthResponse} from \"../../domain/entities/User\";\r\nimport appConfig from \"../../../config/appConfig\";\r\n\r\n/**\r\n * Caso de uso para el inicio de sesi√≥n con Google\r\n */\r\nexport class GoogleLoginUseCase {\r\n\tprivate authService: AuthService;\r\n\tprivate storageService: LocalStorageService;\r\n\r\n\tconstructor() {\r\n\t\tthis.authService = new AuthService();\r\n\t\tthis.storageService = new LocalStorageService();\r\n\t}\r\n\r\n\t/**\r\n\t * Ejecuta el proceso de inicio de sesi√≥n con Google\r\n\t * @returns Datos de autenticaci√≥n o null si falla\r\n\t */\r\n\tasync execute(): Promise<AuthResponse | null> {\r\n\t\ttry {\r\n\t\t\tconsole.log(\"üîê Ejecutando GoogleLoginUseCase...\");\r\n\r\n\t\t\t// Llamada al servicio de autenticaci√≥n con Google\r\n\t\t\tconst authResponse = await this.authService.loginWithGoogle();\r\n\r\n\t\t\t// Verificar que la respuesta sea v√°lida\r\n\t\t\tif (!authResponse || !authResponse.access_token) {\r\n\t\t\t\tthrow new Error(\"Respuesta de autenticaci√≥n con Google inv√°lida\");\r\n\t\t\t}\r\n\r\n\t\t\t// Guardar el token en el almacenamiento local\r\n\t\t\tthis.storageService.setItem(\r\n\t\t\t\tappConfig.storage.authTokenKey,\r\n\t\t\t\tauthResponse.access_token\r\n\t\t\t);\r\n\r\n\t\t\t// Si existe informaci√≥n del usuario, guardarla tambi√©n\r\n\t\t\tif (authResponse.user) {\r\n\t\t\t\tthis.storageService.setItem(\r\n\t\t\t\t\tappConfig.storage.userKey,\r\n\t\t\t\t\tauthResponse.user\r\n\t\t\t\t);\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log(\"‚úÖ GoogleLoginUseCase completado exitosamente\");\r\n\t\t\treturn authResponse;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"‚ùå Error en GoogleLoginUseCase:\", error);\r\n\r\n\t\t\t// Propagar el error para que pueda ser manejado en la capa superior\r\n\t\t\tif (error instanceof Error) {\r\n\t\t\t\tthrow error;\r\n\t\t\t} else {\r\n\t\t\t\tthrow new Error(\"Error desconocido en el inicio de sesi√≥n con Google\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport default GoogleLoginUseCase;\r\n","// src/core/useCases/user/GoogleRegisterUseCase.ts\r\n\r\nimport {AuthService} from \"../../services/AuthService\";\r\nimport {LocalStorageService} from \"../../../infrastructure/services/LocalStorageService\";\r\nimport type {AuthResponse} from \"../../domain/entities/User\";\r\nimport appConfig from \"../../../config/appConfig\";\r\n\r\n/**\r\n * Caso de uso para el registro con Google\r\n */\r\nexport class GoogleRegisterUseCase {\r\n\tprivate authService: AuthService;\r\n\tprivate storageService: LocalStorageService;\r\n\r\n\tconstructor() {\r\n\t\tthis.authService = new AuthService();\r\n\t\tthis.storageService = new LocalStorageService();\r\n\t}\r\n\r\n\t/**\r\n\t * Ejecuta el proceso de registro con Google\r\n\t * @returns Datos de autenticaci√≥n o null si falla\r\n\t */\r\n\tasync execute(): Promise<AuthResponse | null> {\r\n\t\ttry {\r\n\t\t\tconsole.log(\"üîê Ejecutando GoogleRegisterUseCase...\");\r\n\r\n\t\t\t// Llamada al servicio de autenticaci√≥n con Google\r\n\t\t\tconst authResponse = await this.authService.registerWithGoogle();\r\n\r\n\t\t\t// Verificar que la respuesta sea v√°lida\r\n\t\t\tif (!authResponse || !authResponse.access_token) {\r\n\t\t\t\tthrow new Error(\"Respuesta de registro con Google inv√°lida\");\r\n\t\t\t}\r\n\r\n\t\t\t// Guardar el token en el almacenamiento local\r\n\t\t\tthis.storageService.setItem(\r\n\t\t\t\tappConfig.storage.authTokenKey,\r\n\t\t\t\tauthResponse.access_token\r\n\t\t\t);\r\n\r\n\t\t\t// Si existe informaci√≥n del usuario, guardarla tambi√©n\r\n\t\t\tif (authResponse.user) {\r\n\t\t\t\tthis.storageService.setItem(\r\n\t\t\t\t\tappConfig.storage.userKey,\r\n\t\t\t\t\tauthResponse.user\r\n\t\t\t\t);\r\n\t\t\t}\r\n\r\n\t\t\tconsole.log(\"‚úÖ GoogleRegisterUseCase completado exitosamente\");\r\n\t\t\treturn authResponse;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"‚ùå Error en GoogleRegisterUseCase:\", error);\r\n\r\n\t\t\t// Propagar el error para que pueda ser manejado en la capa superior\r\n\t\t\tif (error instanceof Error) {\r\n\t\t\t\tthrow error;\r\n\t\t\t} else {\r\n\t\t\t\tthrow new Error(\"Error desconocido en el registro con Google\");\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n}\r\n\r\nexport default GoogleRegisterUseCase;\r\n","// src/presentation/hooks/useAuth.ts (OPTIMIZADO)\r\n\r\nimport {useState, useCallback, useContext} from \"react\";\r\nimport {AuthContext} from \"../contexts/AuthContext\";\r\nimport LoginUseCase from \"../../core/useCases/user/LoginUseCase\";\r\nimport RegisterUseCase from \"../../core/useCases/user/RegisterUseCase\";\r\nimport UpdateProfileUseCase from \"../../core/useCases/user/UpdateProfileUseCase\";\r\nimport GoogleLoginUseCase from \"../../core/useCases/user/GoogleLoginUseCase\";\r\nimport GoogleRegisterUseCase from \"../../core/useCases/user/GoogleRegisterUseCase\";\r\nimport type {\r\n\tUserLoginData,\r\n\tUserRegistrationData,\r\n\tUserProfileUpdateData,\r\n} from \"../../core/domain/entities/User\";\r\nimport {CacheService} from \"../../infrastructure/services/CacheService\";\r\n\r\n// Crear instancias de servicios y casos de uso\r\nconst loginUseCase = new LoginUseCase();\r\nconst registerUseCase = new RegisterUseCase();\r\nconst updateProfileUseCase = new UpdateProfileUseCase();\r\nconst googleLoginUseCase = new GoogleLoginUseCase();\r\nconst googleRegisterUseCase = new GoogleRegisterUseCase();\r\n\r\n// Cache keys\r\nconst CACHE_KEYS = {\r\n\tUSER_DATA: \"auth_user_data\",\r\n\tROLE_INFO: \"auth_role_info\",\r\n};\r\n\r\n/**\r\n * Hook optimizado para operaciones de autenticaci√≥n\r\n */\r\nexport const useAuth = () => {\r\n\t// Obtener todo del contexto unificado\r\n\tconst {\r\n\t\tuser,\r\n\t\tsetUser,\r\n\t\tisAuthenticated,\r\n\t\tsetIsAuthenticated,\r\n\t\tlogout: contextLogout,\r\n\t\troleInfo,\r\n\t\tisLoadingRole,\r\n\t\trefreshRoleInfo,\r\n\t\tisInitialized,\r\n\t\tgetDefaultRouteForRole,\r\n\t\tisAdmin: contextIsAdmin,\r\n\t\tisSeller: contextIsSeller,\r\n\t} = useContext(AuthContext);\r\n\r\n\tconst [loading, setLoading] = useState<boolean>(false);\r\n\tconst [error, setError] = useState<string | null>(null);\r\n\r\n\t/**\r\n\t * OPTIMIZADO: Iniciar sesi√≥n de usuario\r\n\t */\r\n\tconst login = useCallback(\r\n\t\tasync (credentials: UserLoginData) => {\r\n\t\t\tsetLoading(true);\r\n\t\t\tsetError(null);\r\n\r\n\t\t\ttry {\r\n\t\t\t\tconsole.log(\"üîë Iniciando login...\");\r\n\t\t\t\tconst response = await loginUseCase.execute(credentials);\r\n\r\n\t\t\t\tif (response && response.user) {\r\n\t\t\t\t\tconsole.log(\"‚úÖ Login exitoso\");\r\n\t\t\t\t\tsetUser(response.user);\r\n\t\t\t\t\tsetIsAuthenticated(true);\r\n\r\n\t\t\t\t\t// Limpiar cache antes del refresh para obtener datos frescos\r\n\t\t\t\t\tCacheService.removeItem(CACHE_KEYS.ROLE_INFO);\r\n\r\n\t\t\t\t\t// Refrescar informaci√≥n de rol despu√©s del login\r\n\t\t\t\t\tawait refreshRoleInfo();\r\n\r\n\t\t\t\t\treturn response;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new Error(\"No se recibi√≥ informaci√≥n de usuario v√°lida\");\r\n\t\t\t\t}\r\n\t\t\t} catch (err: any) {\r\n\t\t\t\tlet errorMessage = \"Error al iniciar sesi√≥n\";\r\n\t\t\t\t\r\n\t\t\t\t// Check if it's an email verification error\r\n\t\t\t\tif (err.response?.status === 409 && err.response?.data?.error_code === 'EMAIL_NOT_VERIFIED') {\r\n\t\t\t\t\terrorMessage = err.response.data.message || \"Debes verificar tu email antes de iniciar sesi√≥n\";\r\n\t\t\t\t} else if (err instanceof Error) {\r\n\t\t\t\t\terrorMessage = err.message;\r\n\t\t\t\t} else if (err.response?.data?.message) {\r\n\t\t\t\t\terrorMessage = err.response.data.message;\r\n\t\t\t\t}\r\n\t\t\t\t\r\n\t\t\t\tconsole.error(\"‚ùå Login error:\", errorMessage);\r\n\t\t\t\tsetError(errorMessage);\r\n\t\t\t\treturn null;\r\n\t\t\t} finally {\r\n\t\t\t\tsetLoading(false);\r\n\t\t\t}\r\n\t\t},\r\n\t\t[setUser, setIsAuthenticated, refreshRoleInfo]\r\n\t);\r\n\r\n\t/**\r\n\t * OPTIMIZADO: Registrar nuevo usuario\r\n\t */\r\n\tconst register = useCallback(\r\n\t\tasync (userData: UserRegistrationData) => {\r\n\t\t\tsetLoading(true);\r\n\t\t\tsetError(null);\r\n\r\n\t\t\ttry {\r\n\t\t\t\tconsole.log(\"üìù Iniciando registro...\");\r\n\t\t\t\tconst response = await registerUseCase.execute(userData);\r\n\r\n\t\t\t\tif (response && response.user) {\r\n\t\t\t\t\tconsole.log(\"‚úÖ Registro exitoso - Usuario creado sin iniciar sesi√≥n autom√°ticamente\");\r\n\t\t\t\t\t\r\n\t\t\t\t\t// NO iniciar sesi√≥n autom√°ticamente\r\n\t\t\t\t\t// El usuario debe verificar su email primero\r\n\t\t\t\t\treturn response;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new Error(\"No se recibi√≥ informaci√≥n de usuario v√°lida\");\r\n\t\t\t\t}\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconst errorMessage =\r\n\t\t\t\t\terr instanceof Error ? err.message : \"Error al registrar usuario\";\r\n\t\t\t\tconsole.error(\"‚ùå Register error:\", errorMessage);\r\n\t\t\t\tsetError(errorMessage);\r\n\t\t\t\treturn null;\r\n\t\t\t} finally {\r\n\t\t\t\tsetLoading(false);\r\n\t\t\t}\r\n\t\t},\r\n\t\t[setUser, setIsAuthenticated, refreshRoleInfo]\r\n\t);\r\n\r\n\t/**\r\n\t * OPTIMIZADO: Login with Google\r\n\t */\r\n\tconst loginWithGoogle = useCallback(async () => {\r\n\t\ttry {\r\n\t\t\tsetLoading(true);\r\n\t\t\tsetError(null);\r\n\r\n\t\t\tconsole.log(\"üîê Iniciando login con Google...\");\r\n\t\t\tconst result = await googleLoginUseCase.execute();\r\n\r\n\t\t\tif (result) {\r\n\t\t\t\tconsole.log(\"‚úÖ Login con Google exitoso\");\r\n\t\t\t\tsetUser(result.user);\r\n\t\t\t\tsetIsAuthenticated(true);\r\n\r\n\t\t\t\t// Limpiar cache antes del refresh\r\n\t\t\t\tCacheService.removeItem(CACHE_KEYS.ROLE_INFO);\r\n\r\n\t\t\t\t// Refrescar informaci√≥n de rol\r\n\t\t\t\tawait refreshRoleInfo();\r\n\r\n\t\t\t\treturn result;\r\n\t\t\t}\r\n\r\n\t\t\treturn null;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"‚ùå Error en login con Google:\", error);\r\n\t\t\tconst errorMessage =\r\n\t\t\t\terror instanceof Error\r\n\t\t\t\t\t? error.message\r\n\t\t\t\t\t: \"Error desconocido al iniciar sesi√≥n con Google\";\r\n\t\t\tsetError(errorMessage);\r\n\t\t\treturn null;\r\n\t\t} finally {\r\n\t\t\tsetLoading(false);\r\n\t\t}\r\n\t}, [setUser, setIsAuthenticated, refreshRoleInfo]);\r\n\r\n\t/**\r\n\t * OPTIMIZADO: Register with Google\r\n\t */\r\n\tconst registerWithGoogle = useCallback(async () => {\r\n\t\ttry {\r\n\t\t\tsetLoading(true);\r\n\t\t\tsetError(null);\r\n\r\n\t\t\tconsole.log(\"üîê Iniciando registro con Google...\");\r\n\t\t\tconst result = await googleRegisterUseCase.execute();\r\n\r\n\t\t\tif (result) {\r\n\t\t\t\tconsole.log(\"‚úÖ Registro con Google exitoso\");\r\n\t\t\t\tsetUser(result.user);\r\n\t\t\t\tsetIsAuthenticated(true);\r\n\r\n\t\t\t\t// Limpiar cache antes del refresh\r\n\t\t\t\tCacheService.removeItem(CACHE_KEYS.ROLE_INFO);\r\n\r\n\t\t\t\t// Refrescar informaci√≥n de rol\r\n\t\t\t\tawait refreshRoleInfo();\r\n\r\n\t\t\t\treturn result;\r\n\t\t\t}\r\n\r\n\t\t\treturn null;\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"‚ùå Error en registro con Google:\", error);\r\n\t\t\tconst errorMessage =\r\n\t\t\t\terror instanceof Error\r\n\t\t\t\t\t? error.message\r\n\t\t\t\t\t: \"Error desconocido al registrarse con Google\";\r\n\t\t\tsetError(errorMessage);\r\n\t\t\treturn null;\r\n\t\t} finally {\r\n\t\t\tsetLoading(false);\r\n\t\t}\r\n\t}, [setUser, setIsAuthenticated, refreshRoleInfo]);\r\n\r\n\t/**\r\n\t * OPTIMIZADO: Cerrar sesi√≥n de usuario\r\n\t */\r\n\tconst logout = useCallback(async () => {\r\n\t\tsetLoading(true);\r\n\t\tsetError(null);\r\n\r\n\t\ttry {\r\n\t\t\tconsole.log(\"üö™ Cerrando sesi√≥n...\");\r\n\t\t\tawait contextLogout();\r\n\t\t\tconsole.log(\"‚úÖ Sesi√≥n cerrada exitosamente\");\r\n\t\t\treturn true;\r\n\t\t} catch (err) {\r\n\t\t\tconst errorMessage =\r\n\t\t\t\terr instanceof Error ? err.message : \"Error al cerrar sesi√≥n\";\r\n\t\t\tconsole.error(\"‚ùå Logout error:\", errorMessage);\r\n\t\t\tsetError(errorMessage);\r\n\t\t\treturn false;\r\n\t\t} finally {\r\n\t\t\tsetLoading(false);\r\n\t\t\t// Redirigir al inicio despu√©s de cerrar sesi√≥n\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\twindow.location.href = \"/\";\r\n\t\t\t}, 100);\r\n\t\t}\r\n\t}, [contextLogout]);\r\n\r\n\t/**\r\n\t * OPTIMIZADO: Actualizar perfil de usuario\r\n\t */\r\n\tconst updateProfile = useCallback(\r\n\t\tasync (profileData: UserProfileUpdateData) => {\r\n\t\t\tsetLoading(true);\r\n\t\t\tsetError(null);\r\n\r\n\t\t\ttry {\r\n\t\t\t\tconsole.log(\"üë§ Actualizando perfil...\");\r\n\t\t\t\tconst updatedUser = await updateProfileUseCase.execute(profileData);\r\n\r\n\t\t\t\tif (updatedUser) {\r\n\t\t\t\t\tconsole.log(\"‚úÖ Perfil actualizado exitosamente\");\r\n\t\t\t\t\tsetUser(updatedUser);\r\n\r\n\t\t\t\t\t// Actualizar cache de usuario\r\n\t\t\t\t\tCacheService.setItem(\r\n\t\t\t\t\t\tCACHE_KEYS.USER_DATA,\r\n\t\t\t\t\t\tupdatedUser,\r\n\t\t\t\t\t\t10 * 60 * 1000\r\n\t\t\t\t\t);\r\n\r\n\t\t\t\t\treturn updatedUser;\r\n\t\t\t\t} else {\r\n\t\t\t\t\tthrow new Error(\"No se recibi√≥ informaci√≥n de usuario actualizada\");\r\n\t\t\t\t}\r\n\t\t\t} catch (err) {\r\n\t\t\t\tconst errorMessage =\r\n\t\t\t\t\terr instanceof Error ? err.message : \"Error al actualizar perfil\";\r\n\t\t\t\tconsole.error(\"‚ùå Update profile error:\", errorMessage);\r\n\t\t\t\tsetError(errorMessage);\r\n\t\t\t\treturn null;\r\n\t\t\t} finally {\r\n\t\t\t\tsetLoading(false);\r\n\t\t\t}\r\n\t\t},\r\n\t\t[setUser]\r\n\t);\r\n\r\n\t/**\r\n\t * OPTIMIZADO: Verificar si el usuario es administrador\r\n\t */\r\n\tconst isAdmin = useCallback(\r\n\t\tasync (critical: boolean = false): Promise<boolean> => {\r\n\t\t\ttry {\r\n\t\t\t\treturn await contextIsAdmin(critical);\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.warn(\r\n\t\t\t\t\t\"‚ö†Ô∏è Error en verificaci√≥n de admin, usando fallback:\",\r\n\t\t\t\t\terror\r\n\t\t\t\t);\r\n\t\t\t\treturn roleInfo.isAdmin;\r\n\t\t\t}\r\n\t\t},\r\n\t\t[contextIsAdmin, roleInfo.isAdmin]\r\n\t);\r\n\r\n\t/**\r\n\t * OPTIMIZADO: Verificar si el usuario es vendedor\r\n\t */\r\n\tconst isSeller = useCallback(\r\n\t\tasync (critical: boolean = false): Promise<boolean> => {\r\n\t\t\ttry {\r\n\t\t\t\treturn await contextIsSeller(critical);\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.warn(\r\n\t\t\t\t\t\"‚ö†Ô∏è Error en verificaci√≥n de seller, usando fallback:\",\r\n\t\t\t\t\terror\r\n\t\t\t\t);\r\n\t\t\t\treturn roleInfo.isSeller;\r\n\t\t\t}\r\n\t\t},\r\n\t\t[contextIsSeller, roleInfo.isSeller]\r\n\t);\r\n\r\n\t// Funci√≥n de utilidad para limpiar errores\r\n\tconst clearError = useCallback(() => {\r\n\t\tsetError(null);\r\n\t}, []);\r\n\r\n\t// Devolver estado y funciones del hook\r\n\treturn {\r\n\t\t// Estados b√°sicos\r\n\t\tuser,\r\n\t\tisAuthenticated,\r\n\t\tloading,\r\n\t\terror,\r\n\r\n\t\t// Funciones de autenticaci√≥n\r\n\t\tlogin,\r\n\t\tregister,\r\n\t\tlogout,\r\n\t\tupdateProfile,\r\n\r\n\t\t// M√©todos de Google OAuth\r\n\t\tloginWithGoogle,\r\n\t\tregisterWithGoogle,\r\n\r\n\t\t// Setters (para compatibilidad, pero se recomienda usar las funciones)\r\n\t\tsetUser,\r\n\t\tsetIsAuthenticated,\r\n\r\n\t\t// Propiedades del contexto\r\n\t\troleInfo,\r\n\t\tisLoadingRole,\r\n\t\trefreshRoleInfo,\r\n\t\tisInitialized,\r\n\t\tgetDefaultRouteForRole,\r\n\r\n\t\t// Funciones optimizadas de roles\r\n\t\tisAdmin,\r\n\t\tisSeller,\r\n\r\n\t\t// Utilidades\r\n\t\tclearError,\r\n\t};\r\n};\r\n\r\n// Re-exportar tambi√©n como useSecureAuth para compatibilidad\r\nexport const useSecureAuth = useAuth;\r\n\r\nexport default useAuth;\r\n","// src/utils/dateUtils.ts - OPTIMIZADO CON CACHE\r\n\r\n/**\r\n * Utilidades para manejo y formateo de fechas\r\n * Configurado para la zona horaria de Ecuador (UTC-5)\r\n * CON CACHE INTELIGENTE PARA EVITAR REC√ÅLCULOS\r\n */\r\n\r\n// Zona horaria de Ecuador\r\nexport const ECUADOR_TIMEZONE = \"America/Guayaquil\";\r\nexport const ECUADOR_UTC_OFFSET = \"-05:00\";\r\n\r\n// ‚úÖ CACHE PARA formatRelativeTime\r\ninterface RelativeTimeCache {\r\n\t[key: string]: {\r\n\t\tresult: string;\r\n\t\ttimestamp: number;\r\n\t\texpiry: number;\r\n\t};\r\n}\r\n\r\nconst relativeTimeCache: RelativeTimeCache = {};\r\nconst CACHE_DURATION = 30 * 1000; // 30 segundos\r\nconst MAX_CACHE_SIZE = 100; // M√°ximo 100 entradas\r\n\r\n/**\r\n * Limpia el cache de tiempo relativo cuando est√° muy lleno\r\n */\r\nconst cleanupRelativeTimeCache = (): void => {\r\n\tconst now = Date.now();\r\n\tconst keys = Object.keys(relativeTimeCache);\r\n\r\n\tif (keys.length > MAX_CACHE_SIZE) {\r\n\t\t// Remover entradas expiradas\r\n\t\tkeys.forEach((key) => {\r\n\t\t\tif (relativeTimeCache[key].expiry < now) {\r\n\t\t\t\tdelete relativeTimeCache[key];\r\n\t\t\t}\r\n\t\t});\r\n\r\n\t\t// Si a√∫n hay muchas, remover las m√°s antiguas\r\n\t\tconst remaining = Object.keys(relativeTimeCache);\r\n\t\tif (remaining.length > MAX_CACHE_SIZE) {\r\n\t\t\tconst sorted = remaining\r\n\t\t\t\t.map((key) => ({key, timestamp: relativeTimeCache[key].timestamp}))\r\n\t\t\t\t.sort((a, b) => a.timestamp - b.timestamp);\r\n\r\n\t\t\tconst toRemove = sorted.slice(0, remaining.length - MAX_CACHE_SIZE);\r\n\t\t\ttoRemove.forEach((item) => delete relativeTimeCache[item.key]);\r\n\t\t}\r\n\t}\r\n};\r\n\r\n/**\r\n * Parsea una fecha que viene del backend Laravel\r\n * Maneja tanto fechas con zona horaria como sin ella\r\n */\r\nexport const parseBackendDate = (dateString: string): Date | null => {\r\n\ttry {\r\n\t\tif (!dateString || dateString.trim() === \"\") {\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\tconst cleanDateString = dateString.trim();\r\n\t\tlet date: Date;\r\n\r\n\t\t// Formato ISO con zona horaria: \"2025-06-25T00:11:24.000000Z\" o \"2025-06-25T00:11:24Z\"\r\n\t\tif (\r\n\t\t\t/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{1,6})?Z?$/i.test(\r\n\t\t\t\tcleanDateString\r\n\t\t\t) ||\r\n\t\t\t/^\\d{4}-\\d{2}-\\d{2}T\\d{2}:\\d{2}:\\d{2}(\\.\\d{1,6})?[+-]\\d{2}:\\d{2}$/.test(\r\n\t\t\t\tcleanDateString\r\n\t\t\t)\r\n\t\t) {\r\n\t\t\t// Es formato ISO v√°lido, parsear directamente\r\n\t\t\tdate = new Date(cleanDateString);\r\n\t\t}\r\n\t\t// Formato Laravel sin zona horaria: \"YYYY-MM-DD HH:mm:ss\"\r\n\t\telse if (/^\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}:\\d{2}$/.test(cleanDateString)) {\r\n\t\t\t// Asumir que es hora local de Ecuador y convertir a ISO string con zona horaria\r\n\t\t\tconst isoString = cleanDateString.replace(\" \", \"T\") + ECUADOR_UTC_OFFSET;\r\n\t\t\tdate = new Date(isoString);\r\n\t\t}\r\n\t\t// Otros formatos, intentar parsear directamente\r\n\t\telse {\r\n\t\t\tdate = new Date(cleanDateString);\r\n\t\t}\r\n\r\n\t\t// Verificar si la fecha es v√°lida\r\n\t\tif (isNaN(date.getTime())) {\r\n\t\t\treturn null;\r\n\t\t}\r\n\r\n\t\treturn date;\r\n\t} catch (error) {\r\n\t\tconsole.error(\"Error al parsear fecha:\", error);\r\n\t\treturn null;\r\n\t}\r\n};\r\n\r\n/**\r\n * Formatea una fecha como tiempo relativo en espa√±ol\r\n * ‚úÖ CON CACHE INTELIGENTE para evitar rec√°lculos\r\n */\r\nexport const formatRelativeTime = (dateString: string): string => {\r\n\ttry {\r\n\t\tif (!dateString || dateString.trim() === \"\") {\r\n\t\t\treturn \"Fecha desconocida\";\r\n\t\t}\r\n\r\n\t\tconst now = Date.now();\r\n\t\tconst cacheKey = `${dateString}_${Math.floor(now / CACHE_DURATION)}`;\r\n\r\n\t\t// ‚úÖ VERIFICAR CACHE PRIMERO\r\n\t\tconst cached = relativeTimeCache[cacheKey];\r\n\t\tif (cached && cached.expiry > now) {\r\n\t\t\treturn cached.result;\r\n\t\t}\r\n\r\n\t\tconst date = parseBackendDate(dateString);\r\n\r\n\t\tif (!date) {\r\n\t\t\treturn \"Fecha inv√°lida\";\r\n\t\t}\r\n\r\n\t\tconst diffInSeconds = Math.floor((now - date.getTime()) / 1000);\r\n\r\n\t\t// Si la diferencia es negativa (fecha en el futuro), mostrar la fecha\r\n\t\tif (diffInSeconds < 0) {\r\n\t\t\treturn formatAbsoluteDate(date);\r\n\t\t}\r\n\r\n\t\tlet result: string;\r\n\t\tif (diffInSeconds < 60) {\r\n\t\t\tresult = \"Ahora mismo\";\r\n\t\t} else if (diffInSeconds < 3600) {\r\n\t\t\tconst minutes = Math.floor(diffInSeconds / 60);\r\n\t\t\tresult = `${minutes} ${minutes === 1 ? \"minuto\" : \"minutos\"}`;\r\n\t\t} else if (diffInSeconds < 86400) {\r\n\t\t\tconst hours = Math.floor(diffInSeconds / 3600);\r\n\t\t\tresult = `${hours} ${hours === 1 ? \"hora\" : \"horas\"}`;\r\n\t\t} else if (diffInSeconds < 604800) {\r\n\t\t\tconst days = Math.floor(diffInSeconds / 86400);\r\n\t\t\tresult = `${days} ${days === 1 ? \"d√≠a\" : \"d√≠as\"}`;\r\n\t\t} else {\r\n\t\t\tresult = formatAbsoluteDate(date);\r\n\t\t}\r\n\r\n\t\t// ‚úÖ GUARDAR EN CACHE\r\n\t\trelativeTimeCache[cacheKey] = {\r\n\t\t\tresult,\r\n\t\t\ttimestamp: now,\r\n\t\t\texpiry: now + CACHE_DURATION,\r\n\t\t};\r\n\r\n\t\t// Limpiar cache si est√° muy lleno\r\n\t\tif (Object.keys(relativeTimeCache).length > MAX_CACHE_SIZE) {\r\n\t\t\tcleanupRelativeTimeCache();\r\n\t\t}\r\n\r\n\t\treturn result;\r\n\t} catch (error) {\r\n\t\tconsole.error(\"Error en formatRelativeTime:\", error);\r\n\t\treturn \"Error en fecha\";\r\n\t}\r\n};\r\n\r\n/**\r\n * Formatea una fecha como tiempo relativo corto (para toasts)\r\n * ‚úÖ CON CACHE TAMBI√âN\r\n */\r\nexport const formatRelativeTimeShort = (dateString: string): string => {\r\n\tconst date = parseBackendDate(dateString);\r\n\r\n\tif (!date) {\r\n\t\treturn \"Ahora\";\r\n\t}\r\n\r\n\tconst now = Date.now();\r\n\tconst cacheKey = `short_${dateString}_${Math.floor(now / CACHE_DURATION)}`;\r\n\r\n\t// ‚úÖ VERIFICAR CACHE\r\n\tconst cached = relativeTimeCache[cacheKey];\r\n\tif (cached && cached.expiry > now) {\r\n\t\treturn cached.result;\r\n\t}\r\n\r\n\tconst diffInSeconds = Math.floor((now - date.getTime()) / 1000);\r\n\r\n\tif (diffInSeconds < 0) {\r\n\t\treturn \"Ahora\";\r\n\t}\r\n\r\n\tlet result: string;\r\n\tif (diffInSeconds < 60) {\r\n\t\tresult = \"Ahora\";\r\n\t} else if (diffInSeconds < 3600) {\r\n\t\tconst minutes = Math.floor(diffInSeconds / 60);\r\n\t\tresult = `${minutes}min`;\r\n\t} else if (diffInSeconds < 86400) {\r\n\t\tconst hours = Math.floor(diffInSeconds / 3600);\r\n\t\tresult = `${hours}h`;\r\n\t} else {\r\n\t\tconst days = Math.floor(diffInSeconds / 86400);\r\n\t\tresult = `${days}d`;\r\n\t}\r\n\r\n\t// ‚úÖ GUARDAR EN CACHE\r\n\trelativeTimeCache[cacheKey] = {\r\n\t\tresult,\r\n\t\ttimestamp: now,\r\n\t\texpiry: now + CACHE_DURATION,\r\n\t};\r\n\r\n\treturn result;\r\n};\r\n\r\n/**\r\n * Formatea una fecha absoluta en formato legible en espa√±ol\r\n */\r\nexport const formatAbsoluteDate = (\r\n\tdate: Date,\r\n\tincludeTime: boolean = false\r\n): string => {\r\n\ttry {\r\n\t\tconst now = new Date();\r\n\r\n\t\tconst options: Intl.DateTimeFormatOptions = {\r\n\t\t\tday: \"numeric\",\r\n\t\t\tmonth: \"short\",\r\n\t\t\tyear: date.getFullYear() !== now.getFullYear() ? \"numeric\" : undefined,\r\n\t\t\ttimeZone: ECUADOR_TIMEZONE,\r\n\t\t};\r\n\r\n\t\tif (includeTime) {\r\n\t\t\toptions.hour = \"2-digit\";\r\n\t\t\toptions.minute = \"2-digit\";\r\n\t\t\toptions.hour12 = false; // Formato 24 horas\r\n\t\t}\r\n\r\n\t\treturn date.toLocaleDateString(\"es-EC\", options);\r\n\t} catch (error) {\r\n\t\tconsole.error(\"Error en formatAbsoluteDate:\", error);\r\n\t\treturn date.toLocaleDateString();\r\n\t}\r\n};\r\n\r\n/**\r\n * Formatea una fecha absoluta desde string\r\n */\r\nexport const formatAbsoluteDateFromString = (\r\n\tdateString: string,\r\n\tincludeTime: boolean = false\r\n): string => {\r\n\tconst date = parseBackendDate(dateString);\r\n\r\n\tif (!date) {\r\n\t\treturn \"Fecha desconocida\";\r\n\t}\r\n\r\n\treturn formatAbsoluteDate(date, includeTime);\r\n};\r\n\r\n/**\r\n * Verifica si una fecha est√° en el rango de \"hoy\"\r\n */\r\nexport const isToday = (dateString: string): boolean => {\r\n\tconst date = parseBackendDate(dateString);\r\n\r\n\tif (!date) {\r\n\t\treturn false;\r\n\t}\r\n\r\n\tconst today = new Date();\r\n\r\n\treturn (\r\n\t\tdate.getDate() === today.getDate() &&\r\n\t\tdate.getMonth() === today.getMonth() &&\r\n\t\tdate.getFullYear() === today.getFullYear()\r\n\t);\r\n};\r\n\r\n/**\r\n * Verifica si una fecha est√° en el rango de \"ayer\"\r\n */\r\nexport const isYesterday = (dateString: string): boolean => {\r\n\tconst date = parseBackendDate(dateString);\r\n\r\n\tif (!date) {\r\n\t\treturn false;\r\n\t}\r\n\r\n\tconst yesterday = new Date();\r\n\tyesterday.setDate(yesterday.getDate() - 1);\r\n\r\n\treturn (\r\n\t\tdate.getDate() === yesterday.getDate() &&\r\n\t\tdate.getMonth() === yesterday.getMonth() &&\r\n\t\tdate.getFullYear() === yesterday.getFullYear()\r\n\t);\r\n};\r\n\r\n/**\r\n * Convierte una fecha del backend a timestamp para comparaciones\r\n */\r\nexport const dateStringToTimestamp = (dateString: string): number => {\r\n\tconst date = parseBackendDate(dateString);\r\n\treturn date ? date.getTime() : 0;\r\n};\r\n\r\n/**\r\n * Formatea una fecha para mostrar en inputs de tipo datetime-local\r\n */\r\nexport const formatForDatetimeInput = (dateString: string): string => {\r\n\tconst date = parseBackendDate(dateString);\r\n\r\n\tif (!date) {\r\n\t\treturn \"\";\r\n\t}\r\n\r\n\t// Formato requerido: YYYY-MM-DDTHH:mm\r\n\tconst year = date.getFullYear();\r\n\tconst month = String(date.getMonth() + 1).padStart(2, \"0\");\r\n\tconst day = String(date.getDate()).padStart(2, \"0\");\r\n\tconst hours = String(date.getHours()).padStart(2, \"0\");\r\n\tconst minutes = String(date.getMinutes()).padStart(2, \"0\");\r\n\r\n\treturn `${year}-${month}-${day}T${hours}:${minutes}`;\r\n};\r\n\r\n/**\r\n * Valida si un string de fecha es v√°lido\r\n */\r\nexport const isValidDateString = (dateString: string): boolean => {\r\n\tconst date = parseBackendDate(dateString);\r\n\treturn date !== null && !isNaN(date.getTime());\r\n};\r\n\r\n/**\r\n * ‚úÖ FUNCI√ìN UTILITARIA para limpiar cache manualmente\r\n */\r\nexport const clearRelativeTimeCache = (): void => {\r\n\tObject.keys(relativeTimeCache).forEach((key) => {\r\n\t\tdelete relativeTimeCache[key];\r\n\t});\r\n};\r\n\r\n/**\r\n * ‚úÖ FUNCI√ìN UTILITARIA para obtener estad√≠sticas del cache\r\n */\r\nexport const getRelativeTimeCacheStats = () => {\r\n\tconst keys = Object.keys(relativeTimeCache);\r\n\tconst now = Date.now();\r\n\tconst active = keys.filter(\r\n\t\t(key) => relativeTimeCache[key].expiry > now\r\n\t).length;\r\n\tconst expired = keys.length - active;\r\n\r\n\treturn {\r\n\t\ttotal: keys.length,\r\n\t\tactive,\r\n\t\texpired,\r\n\t\tmaxSize: MAX_CACHE_SIZE,\r\n\t\tcacheDuration: CACHE_DURATION,\r\n\t};\r\n};\r\n\r\n// Exportar funciones principales para retrocompatibilidad\r\nexport default {\r\n\tparseBackendDate,\r\n\tformatRelativeTime,\r\n\tformatRelativeTimeShort,\r\n\tformatAbsoluteDate,\r\n\tformatAbsoluteDateFromString,\r\n\tisToday,\r\n\tisYesterday,\r\n\tdateStringToTimestamp,\r\n\tformatForDatetimeInput,\r\n\tisValidDateString,\r\n\tclearRelativeTimeCache,\r\n\tgetRelativeTimeCacheStats,\r\n};\r\n","const formatDistanceLocale = {\n  lessThanXSeconds: {\n    one: \"menos de un segundo\",\n    other: \"menos de {{count}} segundos\",\n  },\n\n  xSeconds: {\n    one: \"1 segundo\",\n    other: \"{{count}} segundos\",\n  },\n\n  halfAMinute: \"medio minuto\",\n\n  lessThanXMinutes: {\n    one: \"menos de un minuto\",\n    other: \"menos de {{count}} minutos\",\n  },\n\n  xMinutes: {\n    one: \"1 minuto\",\n    other: \"{{count}} minutos\",\n  },\n\n  aboutXHours: {\n    one: \"alrededor de 1 hora\",\n    other: \"alrededor de {{count}} horas\",\n  },\n\n  xHours: {\n    one: \"1 hora\",\n    other: \"{{count}} horas\",\n  },\n\n  xDays: {\n    one: \"1 d√≠a\",\n    other: \"{{count}} d√≠as\",\n  },\n\n  aboutXWeeks: {\n    one: \"alrededor de 1 semana\",\n    other: \"alrededor de {{count}} semanas\",\n  },\n\n  xWeeks: {\n    one: \"1 semana\",\n    other: \"{{count}} semanas\",\n  },\n\n  aboutXMonths: {\n    one: \"alrededor de 1 mes\",\n    other: \"alrededor de {{count}} meses\",\n  },\n\n  xMonths: {\n    one: \"1 mes\",\n    other: \"{{count}} meses\",\n  },\n\n  aboutXYears: {\n    one: \"alrededor de 1 a√±o\",\n    other: \"alrededor de {{count}} a√±os\",\n  },\n\n  xYears: {\n    one: \"1 a√±o\",\n    other: \"{{count}} a√±os\",\n  },\n\n  overXYears: {\n    one: \"m√°s de 1 a√±o\",\n    other: \"m√°s de {{count}} a√±os\",\n  },\n\n  almostXYears: {\n    one: \"casi 1 a√±o\",\n    other: \"casi {{count}} a√±os\",\n  },\n};\n\nexport const formatDistance = (token, count, options) => {\n  let result;\n\n  const tokenValue = formatDistanceLocale[token];\n  if (typeof tokenValue === \"string\") {\n    result = tokenValue;\n  } else if (count === 1) {\n    result = tokenValue.one;\n  } else {\n    result = tokenValue.other.replace(\"{{count}}\", count.toString());\n  }\n\n  if (options?.addSuffix) {\n    if (options.comparison && options.comparison > 0) {\n      return \"en \" + result;\n    } else {\n      return \"hace \" + result;\n    }\n  }\n\n  return result;\n};\n","import { buildFormatLongFn } from \"../../_lib/buildFormatLongFn.js\";\n\nconst dateFormats = {\n  full: \"EEEE, d 'de' MMMM 'de' y\",\n  long: \"d 'de' MMMM 'de' y\",\n  medium: \"d MMM y\",\n  short: \"dd/MM/y\",\n};\n\nconst timeFormats = {\n  full: \"HH:mm:ss zzzz\",\n  long: \"HH:mm:ss z\",\n  medium: \"HH:mm:ss\",\n  short: \"HH:mm\",\n};\n\nconst dateTimeFormats = {\n  full: \"{{date}} 'a las' {{time}}\",\n  long: \"{{date}} 'a las' {{time}}\",\n  medium: \"{{date}}, {{time}}\",\n  short: \"{{date}}, {{time}}\",\n};\n\nexport const formatLong = {\n  date: buildFormatLongFn({\n    formats: dateFormats,\n    defaultWidth: \"full\",\n  }),\n\n  time: buildFormatLongFn({\n    formats: timeFormats,\n    defaultWidth: \"full\",\n  }),\n\n  dateTime: buildFormatLongFn({\n    formats: dateTimeFormats,\n    defaultWidth: \"full\",\n  }),\n};\n","const formatRelativeLocale = {\n  lastWeek: \"'el' eeee 'pasado a la' p\",\n  yesterday: \"'ayer a la' p\",\n  today: \"'hoy a la' p\",\n  tomorrow: \"'ma√±ana a la' p\",\n  nextWeek: \"eeee 'a la' p\",\n  other: \"P\",\n};\n\nconst formatRelativeLocalePlural = {\n  lastWeek: \"'el' eeee 'pasado a las' p\",\n  yesterday: \"'ayer a las' p\",\n  today: \"'hoy a las' p\",\n  tomorrow: \"'ma√±ana a las' p\",\n  nextWeek: \"eeee 'a las' p\",\n  other: \"P\",\n};\n\nexport const formatRelative = (token, date, _baseDate, _options) => {\n  if (date.getHours() !== 1) {\n    return formatRelativeLocalePlural[token];\n  } else {\n    return formatRelativeLocale[token];\n  }\n};\n","import { buildLocalizeFn } from \"../../_lib/buildLocalizeFn.js\";\n\nconst eraValues = {\n  narrow: [\"AC\", \"DC\"],\n  abbreviated: [\"AC\", \"DC\"],\n  wide: [\"antes de cristo\", \"despu√©s de cristo\"],\n};\n\nconst quarterValues = {\n  narrow: [\"1\", \"2\", \"3\", \"4\"],\n  abbreviated: [\"T1\", \"T2\", \"T3\", \"T4\"],\n  wide: [\"1¬∫ trimestre\", \"2¬∫ trimestre\", \"3¬∫ trimestre\", \"4¬∫ trimestre\"],\n};\n\nconst monthValues = {\n  narrow: [\"e\", \"f\", \"m\", \"a\", \"m\", \"j\", \"j\", \"a\", \"s\", \"o\", \"n\", \"d\"],\n  abbreviated: [\n    \"ene\",\n    \"feb\",\n    \"mar\",\n    \"abr\",\n    \"may\",\n    \"jun\",\n    \"jul\",\n    \"ago\",\n    \"sep\",\n    \"oct\",\n    \"nov\",\n    \"dic\",\n  ],\n\n  wide: [\n    \"enero\",\n    \"febrero\",\n    \"marzo\",\n    \"abril\",\n    \"mayo\",\n    \"junio\",\n    \"julio\",\n    \"agosto\",\n    \"septiembre\",\n    \"octubre\",\n    \"noviembre\",\n    \"diciembre\",\n  ],\n};\n\nconst dayValues = {\n  narrow: [\"d\", \"l\", \"m\", \"m\", \"j\", \"v\", \"s\"],\n  short: [\"do\", \"lu\", \"ma\", \"mi\", \"ju\", \"vi\", \"s√°\"],\n  abbreviated: [\"dom\", \"lun\", \"mar\", \"mi√©\", \"jue\", \"vie\", \"s√°b\"],\n  wide: [\n    \"domingo\",\n    \"lunes\",\n    \"martes\",\n    \"mi√©rcoles\",\n    \"jueves\",\n    \"viernes\",\n    \"s√°bado\",\n  ],\n};\n\nconst dayPeriodValues = {\n  narrow: {\n    am: \"a\",\n    pm: \"p\",\n    midnight: \"mn\",\n    noon: \"md\",\n    morning: \"ma√±ana\",\n    afternoon: \"tarde\",\n    evening: \"tarde\",\n    night: \"noche\",\n  },\n  abbreviated: {\n    am: \"AM\",\n    pm: \"PM\",\n    midnight: \"medianoche\",\n    noon: \"mediodia\",\n    morning: \"ma√±ana\",\n    afternoon: \"tarde\",\n    evening: \"tarde\",\n    night: \"noche\",\n  },\n  wide: {\n    am: \"a.m.\",\n    pm: \"p.m.\",\n    midnight: \"medianoche\",\n    noon: \"mediodia\",\n    morning: \"ma√±ana\",\n    afternoon: \"tarde\",\n    evening: \"tarde\",\n    night: \"noche\",\n  },\n};\n\nconst formattingDayPeriodValues = {\n  narrow: {\n    am: \"a\",\n    pm: \"p\",\n    midnight: \"mn\",\n    noon: \"md\",\n    morning: \"de la ma√±ana\",\n    afternoon: \"de la tarde\",\n    evening: \"de la tarde\",\n    night: \"de la noche\",\n  },\n  abbreviated: {\n    am: \"AM\",\n    pm: \"PM\",\n    midnight: \"medianoche\",\n    noon: \"mediodia\",\n    morning: \"de la ma√±ana\",\n    afternoon: \"de la tarde\",\n    evening: \"de la tarde\",\n    night: \"de la noche\",\n  },\n  wide: {\n    am: \"a.m.\",\n    pm: \"p.m.\",\n    midnight: \"medianoche\",\n    noon: \"mediodia\",\n    morning: \"de la ma√±ana\",\n    afternoon: \"de la tarde\",\n    evening: \"de la tarde\",\n    night: \"de la noche\",\n  },\n};\n\nconst ordinalNumber = (dirtyNumber, _options) => {\n  const number = Number(dirtyNumber);\n  return number + \"¬∫\";\n};\n\nexport const localize = {\n  ordinalNumber: ordinalNumber,\n\n  era: buildLocalizeFn({\n    values: eraValues,\n    defaultWidth: \"wide\",\n  }),\n\n  quarter: buildLocalizeFn({\n    values: quarterValues,\n    defaultWidth: \"wide\",\n    argumentCallback: (quarter) => Number(quarter) - 1,\n  }),\n\n  month: buildLocalizeFn({\n    values: monthValues,\n    defaultWidth: \"wide\",\n  }),\n\n  day: buildLocalizeFn({\n    values: dayValues,\n    defaultWidth: \"wide\",\n  }),\n\n  dayPeriod: buildLocalizeFn({\n    values: dayPeriodValues,\n    defaultWidth: \"wide\",\n    formattingValues: formattingDayPeriodValues,\n    defaultFormattingWidth: \"wide\",\n  }),\n};\n","import { buildMatchPatternFn } from \"../../_lib/buildMatchPatternFn.js\";\nimport { buildMatchFn } from \"../../_lib/buildMatchFn.js\";\n\nconst matchOrdinalNumberPattern = /^(\\d+)(¬∫)?/i;\nconst parseOrdinalNumberPattern = /\\d+/i;\n\nconst matchEraPatterns = {\n  narrow: /^(ac|dc|a|d)/i,\n  abbreviated: /^(a\\.?\\s?c\\.?|a\\.?\\s?e\\.?\\s?c\\.?|d\\.?\\s?c\\.?|e\\.?\\s?c\\.?)/i,\n  wide: /^(antes de cristo|antes de la era com[u√∫]n|despu[e√©]s de cristo|era com[u√∫]n)/i,\n};\nconst parseEraPatterns = {\n  any: [/^ac/i, /^dc/i],\n  wide: [\n    /^(antes de cristo|antes de la era com[u√∫]n)/i,\n    /^(despu[e√©]s de cristo|era com[u√∫]n)/i,\n  ],\n};\n\nconst matchQuarterPatterns = {\n  narrow: /^[1234]/i,\n  abbreviated: /^T[1234]/i,\n  wide: /^[1234](¬∫)? trimestre/i,\n};\nconst parseQuarterPatterns = {\n  any: [/1/i, /2/i, /3/i, /4/i],\n};\n\nconst matchMonthPatterns = {\n  narrow: /^[efmajsond]/i,\n  abbreviated: /^(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)/i,\n  wide: /^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)/i,\n};\nconst parseMonthPatterns = {\n  narrow: [\n    /^e/i,\n    /^f/i,\n    /^m/i,\n    /^a/i,\n    /^m/i,\n    /^j/i,\n    /^j/i,\n    /^a/i,\n    /^s/i,\n    /^o/i,\n    /^n/i,\n    /^d/i,\n  ],\n\n  any: [\n    /^en/i,\n    /^feb/i,\n    /^mar/i,\n    /^abr/i,\n    /^may/i,\n    /^jun/i,\n    /^jul/i,\n    /^ago/i,\n    /^sep/i,\n    /^oct/i,\n    /^nov/i,\n    /^dic/i,\n  ],\n};\n\nconst matchDayPatterns = {\n  narrow: /^[dlmjvs]/i,\n  short: /^(do|lu|ma|mi|ju|vi|s[√°a])/i,\n  abbreviated: /^(dom|lun|mar|mi[√©e]|jue|vie|s[√°a]b)/i,\n  wide: /^(domingo|lunes|martes|mi[√©e]rcoles|jueves|viernes|s[√°a]bado)/i,\n};\nconst parseDayPatterns = {\n  narrow: [/^d/i, /^l/i, /^m/i, /^m/i, /^j/i, /^v/i, /^s/i],\n  any: [/^do/i, /^lu/i, /^ma/i, /^mi/i, /^ju/i, /^vi/i, /^sa/i],\n};\n\nconst matchDayPeriodPatterns = {\n  narrow: /^(a|p|mn|md|(de la|a las) (ma√±ana|tarde|noche))/i,\n  any: /^([ap]\\.?\\s?m\\.?|medianoche|mediodia|(de la|a las) (ma√±ana|tarde|noche))/i,\n};\nconst parseDayPeriodPatterns = {\n  any: {\n    am: /^a/i,\n    pm: /^p/i,\n    midnight: /^mn/i,\n    noon: /^md/i,\n    morning: /ma√±ana/i,\n    afternoon: /tarde/i,\n    evening: /tarde/i,\n    night: /noche/i,\n  },\n};\n\nexport const match = {\n  ordinalNumber: buildMatchPatternFn({\n    matchPattern: matchOrdinalNumberPattern,\n    parsePattern: parseOrdinalNumberPattern,\n    valueCallback: function (value) {\n      return parseInt(value, 10);\n    },\n  }),\n\n  era: buildMatchFn({\n    matchPatterns: matchEraPatterns,\n    defaultMatchWidth: \"wide\",\n    parsePatterns: parseEraPatterns,\n    defaultParseWidth: \"any\",\n  }),\n\n  quarter: buildMatchFn({\n    matchPatterns: matchQuarterPatterns,\n    defaultMatchWidth: \"wide\",\n    parsePatterns: parseQuarterPatterns,\n    defaultParseWidth: \"any\",\n    valueCallback: (index) => index + 1,\n  }),\n\n  month: buildMatchFn({\n    matchPatterns: matchMonthPatterns,\n    defaultMatchWidth: \"wide\",\n    parsePatterns: parseMonthPatterns,\n    defaultParseWidth: \"any\",\n  }),\n\n  day: buildMatchFn({\n    matchPatterns: matchDayPatterns,\n    defaultMatchWidth: \"wide\",\n    parsePatterns: parseDayPatterns,\n    defaultParseWidth: \"any\",\n  }),\n\n  dayPeriod: buildMatchFn({\n    matchPatterns: matchDayPeriodPatterns,\n    defaultMatchWidth: \"any\",\n    parsePatterns: parseDayPeriodPatterns,\n    defaultParseWidth: \"any\",\n  }),\n};\n","import { formatDistance } from \"./es/_lib/formatDistance.js\";\nimport { formatLong } from \"./es/_lib/formatLong.js\";\nimport { formatRelative } from \"./es/_lib/formatRelative.js\";\nimport { localize } from \"./es/_lib/localize.js\";\nimport { match } from \"./es/_lib/match.js\";\n\n/**\n * @category Locales\n * @summary Spanish locale.\n * @language Spanish\n * @iso-639-2 spa\n * @author Juan Angosto [@juanangosto](https://github.com/juanangosto)\n * @author Guillermo Grau [@guigrpa](https://github.com/guigrpa)\n * @author Fernando Ag√ºero [@fjaguero](https://github.com/fjaguero)\n * @author Gast√≥n Haro [@harogaston](https://github.com/harogaston)\n * @author Yago Carballo [@YagoCarballo](https://github.com/YagoCarballo)\n */\nexport const es = {\n  code: \"es\",\n  formatDistance: formatDistance,\n  formatLong: formatLong,\n  formatRelative: formatRelative,\n  localize: localize,\n  match: match,\n  options: {\n    weekStartsOn: 1 /* Monday */,\n    firstWeekContainsDate: 1,\n  },\n};\n\n// Fallback for modularized imports:\nexport default es;\n","import React, {useState, useMemo} from \"react\";\r\nimport {User, Package, Store, Circle, Search, Filter, MessageSquare, Archive, Clock} from \"lucide-react\";\r\nimport type {Chat} from \"../../../core/domain/entities/Chat\";\r\nimport {formatDistanceToNow} from \"date-fns\";\r\nimport {es} from \"date-fns/locale\";\r\n\r\ninterface ChatListProps {\r\n\tchats: Chat[];\r\n\tselectedChatId?: number;\r\n\tonSelectChat: (chat: Chat) => void;\r\n\tloading: boolean;\r\n\tsearchTerm: string;\r\n\tonSearchChange: (value: string) => void;\r\n\tstatusFilter: string;\r\n\tonStatusFilterChange: (value: string) => void;\r\n\tunreadFilter: boolean;\r\n\tonUnreadFilterChange: (value: boolean) => void;\r\n\tisSeller?: boolean;\r\n\t// Nueva prop para tabs\r\n\tshowTabs?: boolean;\r\n}\r\n\r\nconst ChatList: React.FC<ChatListProps> = ({\r\n\tchats,\r\n\tselectedChatId,\r\n\tonSelectChat,\r\n\tloading,\r\n\tsearchTerm,\r\n\tonSearchChange,\r\n\tstatusFilter,\r\n\tonStatusFilterChange,\r\n\tunreadFilter,\r\n\tonUnreadFilterChange,\r\n\tisSeller = false,\r\n\tshowTabs = true,\r\n}) => {\r\n\t// Estado local para la pesta√±a activa\r\n\tconst [activeTab, setActiveTab] = useState<string>('active');\r\n\r\n\t// Contar chats por estado\r\n\tconst chatCounts = useMemo(() => {\r\n\t\tconst counts = {\r\n\t\t\tactive: 0,\r\n\t\t\tclosed: 0,\r\n\t\t\tarchived: 0,\r\n\t\t\tall: chats.length\r\n\t\t};\r\n\r\n\t\tchats.forEach(chat => {\r\n\t\t\tif (chat.status === 'active') counts.active++;\r\n\t\t\telse if (chat.status === 'closed') counts.closed++;\r\n\t\t\telse if (chat.status === 'archived') counts.archived++;\r\n\t\t});\r\n\r\n\t\treturn counts;\r\n\t}, [chats]);\r\n\r\n\t// Pesta√±as disponibles\r\n\tconst tabs = [\r\n\t\t{ id: 'active', label: 'Activos', icon: MessageSquare, count: chatCounts.active },\r\n\t\t{ id: 'closed', label: 'Cerrados', icon: Clock, count: chatCounts.closed },\r\n\t\t{ id: 'archived', label: 'Archivados', icon: Archive, count: chatCounts.archived },\r\n\t];\r\n\r\n\t// Filtrar chats por pesta√±a activa\r\n\tconst chatsByTab = chats.filter(chat => {\r\n\t\tif (activeTab === 'all') return true;\r\n\t\treturn chat.status === activeTab;\r\n\t});\r\n\r\n\t// Aplicar filtros adicionales a los chats filtrados por tab\r\n\tconst filteredChats = chatsByTab.filter((chat) => {\r\n\t\t// Filtro por estado (solo si showTabs es false)\r\n\t\tconst matchesStatus = showTabs || statusFilter === \"all\" || chat.status === statusFilter;\r\n\r\n\t\t// Filtro por mensajes no le√≠dos\r\n\t\tconst matchesUnread = unreadFilter ? (chat.unreadCount ?? 0) > 0 : true;\r\n\r\n\t\t// B√∫squeda por nombre de vendedor o producto\r\n\t\tconst matchesSearch =\r\n\t\t\tsearchTerm === \"\" ||\r\n\t\t\t(chat.product?.name &&\r\n\t\t\t\tchat.product.name.toLowerCase().includes(searchTerm.toLowerCase())) ||\r\n\t\t\t(isSeller \r\n\t\t\t\t? chat.user?.name?.toLowerCase().includes(searchTerm.toLowerCase())\r\n\t\t\t\t: chat.seller?.storeName?.toLowerCase().includes(searchTerm.toLowerCase()));\r\n\r\n\t\treturn matchesStatus && matchesUnread && matchesSearch;\r\n\t});\r\n\r\n\t// Formatear fecha relativa\r\n\tconst formatDate = (dateString: string | undefined) => {\r\n\t\tif (!dateString) return \"fecha desconocida\";\r\n\r\n\t\ttry {\r\n\t\t\treturn formatDistanceToNow(new Date(dateString), {\r\n\t\t\t\taddSuffix: true,\r\n\t\t\t\tlocale: es,\r\n\t\t\t});\r\n\t\t} catch (error) {\r\n\t\t\treturn \"fecha desconocida\";\r\n\t\t}\r\n\t};\r\n\r\n\t// Obtener el nombre y avatar del interlocutor seg√∫n el rol\r\n\tconst getChatParticipant = (chat: Chat) => {\r\n\t\tif (isSeller) {\r\n\t\t\treturn {\r\n\t\t\t\tname: chat.user?.name || `Cliente #${chat.userId}`,\r\n\t\t\t\tavatar: chat.user?.avatar,\r\n\t\t\t\tid: chat.userId,\r\n\t\t\t\ticon: <User className=\"h-6 w-6 text-gray-500\" />,\r\n\t\t\t};\r\n\t\t} else {\r\n\t\t\treturn {\r\n\t\t\t\tname: chat.seller?.storeName || `Vendedor #${chat.sellerId}`,\r\n\t\t\t\tavatar: chat.seller?.avatar,\r\n\t\t\t\tid: chat.sellerId,\r\n\t\t\t\ticon: <Store className=\"h-6 w-6 text-gray-500\" />,\r\n\t\t\t};\r\n\t\t}\r\n\t};\r\n\r\n\treturn (\r\n\t\t<div className=\"flex flex-col h-full bg-white\">\r\n\t\t\t{/* Pesta√±as - Solo mostrar si showTabs es true */}\r\n\t\t\t{showTabs && (\r\n\t\t\t\t<div className=\"border-b border-gray-200 bg-gray-50\">\r\n\t\t\t\t\t<div className=\"flex\">\r\n\t\t\t\t\t\t{tabs.map((tab) => {\r\n\t\t\t\t\t\t\tconst Icon = tab.icon;\r\n\t\t\t\t\t\t\tconst isActive = activeTab === tab.id;\r\n\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\tkey={tab.id}\r\n\t\t\t\t\t\t\t\t\tonClick={() => setActiveTab(tab.id)}\r\n\t\t\t\t\t\t\t\t\tclassName={`flex items-center px-4 py-3 text-sm font-medium border-b-2 transition-all duration-200 ${\r\n\t\t\t\t\t\t\t\t\t\tisActive\r\n\t\t\t\t\t\t\t\t\t\t\t? 'text-primary-600 border-primary-500 bg-white'\r\n\t\t\t\t\t\t\t\t\t\t\t: 'text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300'\r\n\t\t\t\t\t\t\t\t\t}`}\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t<Icon className={`h-4 w-4 mr-2 ${\r\n\t\t\t\t\t\t\t\t\t\tisActive ? 'text-primary-500' : 'text-gray-400'\r\n\t\t\t\t\t\t\t\t\t}`} />\r\n\t\t\t\t\t\t\t\t\t{tab.label}\r\n\t\t\t\t\t\t\t\t\t{tab.count > 0 && (\r\n\t\t\t\t\t\t\t\t\t\t<span className={`ml-2 px-2 py-0.5 rounded-full text-xs font-medium ${\r\n\t\t\t\t\t\t\t\t\t\t\tisActive\r\n\t\t\t\t\t\t\t\t\t\t\t\t? 'bg-primary-100 text-primary-600'\r\n\t\t\t\t\t\t\t\t\t\t\t\t: 'bg-gray-200 text-gray-600'\r\n\t\t\t\t\t\t\t\t\t\t}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t{tab.count}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t})}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t)}\r\n\r\n\t\t\t{/* Filtros y b√∫squeda - Dise√±o mejorado */}\r\n\t\t\t<div className=\"p-4 bg-white border-b border-gray-100\">\r\n\t\t\t\t{/* Barra de b√∫squeda */}\r\n\t\t\t\t<div className=\"relative mb-3\">\r\n\t\t\t\t\t<Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400\" />\r\n\t\t\t\t\t<input\r\n\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\tplaceholder=\"Buscar conversaciones...\"\r\n\t\t\t\t\t\tclassName=\"w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors\"\r\n\t\t\t\t\t\tvalue={searchTerm}\r\n\t\t\t\t\t\tonChange={(e) => onSearchChange(e.target.value)}\r\n\t\t\t\t\t/>\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t{/* Filtros adicionales */}\r\n\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t<div className=\"flex items-center space-x-3\">\r\n\t\t\t\t\t\t{!showTabs && (\r\n\t\t\t\t\t\t\t<div className=\"flex items-center space-x-2\">\r\n\t\t\t\t\t\t\t\t<Filter className=\"h-4 w-4 text-gray-500\" />\r\n\t\t\t\t\t\t\t\t<select\r\n\t\t\t\t\t\t\t\t\tclassName=\"border border-gray-200 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500\"\r\n\t\t\t\t\t\t\t\t\tvalue={statusFilter}\r\n\t\t\t\t\t\t\t\t\tonChange={(e) => onStatusFilterChange(e.target.value)}\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t<option value=\"all\">Todos los estados</option>\r\n\t\t\t\t\t\t\t\t\t<option value=\"active\">Activos</option>\r\n\t\t\t\t\t\t\t\t\t<option value=\"closed\">Cerrados</option>\r\n\t\t\t\t\t\t\t\t\t<option value=\"archived\">Archivados</option>\r\n\t\t\t\t\t\t\t\t</select>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t{/* Filtro de no le√≠dos */}\r\n\t\t\t\t\t<div className=\"flex items-center\">\r\n\t\t\t\t\t\t<label className=\"flex items-center cursor-pointer\">\r\n\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\ttype=\"checkbox\"\r\n\t\t\t\t\t\t\t\tclassName=\"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded\"\r\n\t\t\t\t\t\t\t\tchecked={unreadFilter}\r\n\t\t\t\t\t\t\t\tonChange={(e) => onUnreadFilterChange(e.target.checked)}\r\n\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t<span className=\"ml-2 text-sm text-gray-700\">Solo no le√≠dos</span>\r\n\t\t\t\t\t\t</label>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\r\n\t\t\t{/* Lista de conversaciones - Dise√±o mejorado */}\r\n\t\t\t<div className=\"flex-1 overflow-y-auto\">\r\n\t\t\t\t{loading ? (\r\n\t\t\t\t\t<div className=\"flex justify-center items-center h-full\">\r\n\t\t\t\t\t\t<div className=\"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-600\"></div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t) : filteredChats.length === 0 ? (\r\n\t\t\t\t\t<div className=\"flex flex-col items-center justify-center h-full p-8 text-center\">\r\n\t\t\t\t\t\t<div className=\"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4\">\r\n\t\t\t\t\t\t\t{isSeller ? (\r\n\t\t\t\t\t\t\t\t<User className=\"h-8 w-8 text-gray-400\" />\r\n\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t<Store className=\"h-8 w-8 text-gray-400\" />\r\n\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t<h3 className=\"text-lg font-medium text-gray-900 mb-2\">\r\n\t\t\t\t\t\t\tNo hay conversaciones\r\n\t\t\t\t\t\t</h3>\r\n\t\t\t\t\t\t<p className=\"text-gray-500 max-w-sm\">\r\n\t\t\t\t\t\t\t{searchTerm || statusFilter !== \"all\" || unreadFilter\r\n\t\t\t\t\t\t\t\t? \"No se encontraron resultados con los filtros actuales\"\r\n\t\t\t\t\t\t\t\t: isSeller\r\n\t\t\t\t\t\t\t\t\t? \"Cuando los clientes inicien conversaciones, aparecer√°n aqu√≠\"\r\n\t\t\t\t\t\t\t\t\t: \"Inicia una conversaci√≥n con un vendedor desde la p√°gina de un producto\"}\r\n\t\t\t\t\t\t</p>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t) : (\r\n\t\t\t\t\t<div className=\"divide-y divide-gray-100\">\r\n\t\t\t\t\t\t{filteredChats.map((chat) => {\r\n\t\t\t\t\t\t\tconst participant = getChatParticipant(chat);\r\n\t\t\t\t\t\t\tconst chatId = chat.id || 0;\r\n\r\n\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t<div\r\n\t\t\t\t\t\t\t\t\tkey={`chat-${chatId}`}\r\n\t\t\t\t\t\t\t\t\tclassName={`p-4 hover:bg-gray-50 cursor-pointer transition-all duration-200 border-l-4 group ${\r\n\t\t\t\t\t\t\t\t\t\tselectedChatId === chatId\r\n\t\t\t\t\t\t\t\t\t\t\t? \"bg-primary-50 border-l-primary-500 shadow-sm\"\r\n\t\t\t\t\t\t\t\t\t\t\t: \"border-l-transparent hover:border-l-primary-200\"\r\n\t\t\t\t\t\t\t\t\t}`}\r\n\t\t\t\t\t\t\t\t\tonClick={() => onSelectChat(chat)}\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-start\">\r\n\t\t\t\t\t\t\t\t\t\t{/* Avatar mejorado */}\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"flex-shrink-0 mr-3 relative\">\r\n\t\t\t\t\t\t\t\t\t\t\t{participant.avatar ? (\r\n\t\t\t\t\t\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tsrc={participant.avatar}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\talt={participant.name}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"h-12 w-12 rounded-full border-2 border-white shadow-sm group-hover:shadow-md transition-shadow\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tconst target = e.target as HTMLImageElement;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttarget.onerror = null;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\ttarget.src = \"https://via.placeholder.com/48?text=U\";\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"h-12 w-12 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center border-2 border-white shadow-sm group-hover:shadow-md transition-shadow\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{participant.icon}\r\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t\t\t\t{/* Contenido del chat */}\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"flex-1 min-w-0\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex justify-between items-start mb-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<h3 className={`text-sm font-medium truncate pr-2 transition-colors ${\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tselectedChatId === chatId ? 'text-primary-700' : 'text-gray-900 group-hover:text-primary-600'\r\n\t\t\t\t\t\t\t\t\t\t\t\t}`}>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{participant.name}\r\n\t\t\t\t\t\t\t\t\t\t\t\t</h3>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center space-x-2 flex-shrink-0\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-xs text-gray-500\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{formatDate(chat.updatedAt)}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{/* Indicador de no le√≠dos - CORREGIDO: solo mostrar si > 0 */}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{(chat.unreadCount ?? 0) > 0 && (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"inline-flex items-center justify-center h-5 w-5 rounded-full bg-primary-600 text-white text-xs font-medium animate-pulse\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{(chat.unreadCount ?? 0) > 99 ? '99+' : (chat.unreadCount ?? 0)}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t{/* Informaci√≥n del producto */}\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center text-xs text-gray-500 mb-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<Package className=\"h-3 w-3 mr-1 flex-shrink-0\" />\r\n\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"truncate\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{chat.product?.name || `Producto #${chat.productId}`}\r\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t{/* Estado y √∫ltimo mensaje */}\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex items-center min-w-0 flex-1\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<span\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium mr-2 flex-shrink-0 ${\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tchat.status === \"active\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? \"bg-green-100 text-green-800\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: chat.status === \"closed\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? \"bg-blue-100 text-blue-800\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: \"bg-gray-100 text-gray-800\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}`}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t<Circle\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"w-1.5 h-1.5 mr-1\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tfill=\"currentColor\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t{chat.status === \"active\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? \"Activo\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: chat.status === \"closed\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t? \"Cerrado\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t\t: \"Archivado\"}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t{/* √öltimo mensaje */}\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"mt-1\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"text-sm text-gray-600 truncate\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{chat.lastMessage?.content || \"Sin mensajes\"}\r\n\t\t\t\t\t\t\t\t\t\t\t\t</p>\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t})}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t)}\r\n\t\t\t</div>\r\n\r\n\t\t\t{/* Contador de resultados */}\r\n\t\t\t{filteredChats.length > 5 && (\r\n\t\t\t\t<div className=\"p-3 border-t border-gray-100 bg-gray-50 text-center\">\r\n\t\t\t\t\t<span className=\"text-xs text-gray-500\">\r\n\t\t\t\t\t\t{filteredChats.length} conversaci√≥n{filteredChats.length !== 1 ? 'es' : ''}\r\n\t\t\t\t\t\t{showTabs && activeTab !== 'all' && ` ${tabs.find(t => t.id === activeTab)?.label.toLowerCase()}`}\r\n\t\t\t\t\t</span>\r\n\t\t\t\t</div>\r\n\t\t\t)}\r\n\t\t</div>\r\n\t);\r\n};\r\n\r\nexport default ChatList;\r\n","import React, {useRef, useEffect, useState} from \"react\";\r\nimport {User, Clock, Check, CheckCheck, AlertCircle} from \"lucide-react\";\r\nimport type {Message} from \"../../../core/domain/entities/Chat\";\r\nimport {parseBackendDate, isToday, isYesterday} from \"../../../utils/dateUtils\";\r\n\r\n// Placeholder SVG para avatares de usuario - EVITA BUCLE INFINITO\r\nconst getUserAvatarPlaceholder = (name?: string): string => {\r\n\tconst initial = name?.charAt(0).toUpperCase() || 'U';\r\n\treturn `data:image/svg+xml,${encodeURIComponent(`\r\n<svg width=\"24\" height=\"24\" xmlns=\"http://www.w3.org/2000/svg\">\r\n  <circle cx=\"12\" cy=\"12\" r=\"12\" fill=\"#e5e7eb\"/>\r\n  <text x=\"12\" y=\"16\" font-family=\"Arial, sans-serif\" font-size=\"10\" font-weight=\"bold\" fill=\"#6b7280\" text-anchor=\"middle\">\r\n    ${initial}\r\n  </text>\r\n</svg>\r\n`)}`;\r\n};\r\n\r\ninterface ChatMessagesProps {\r\n\tmessages: Message[];\r\n\tloading: boolean;\r\n\tnoMessagesText?: string;\r\n\tcurrentUserId?: number;\r\n}\r\n\r\n// Enum para estados de mensaje mejorado\r\nenum MessageStatus {\r\n\tSENDING = 'sending',\r\n\tSENT = 'sent',\r\n\tDELIVERED = 'delivered', \r\n\tREAD = 'read',\r\n\tERROR = 'error'\r\n}\r\n\r\n// Funci√≥n mejorada para obtener el estado del mensaje\r\nconst getMessageStatus = (message: Message, isFromCurrentUser: boolean): MessageStatus => {\r\n\t// Si no es del usuario actual, no evaluar estado\r\n\tif (!isFromCurrentUser) {\r\n\t\treturn MessageStatus.DELIVERED;\r\n\t}\r\n\r\n\t// Verificar si hay error en el env√≠o\r\n\tif (message.content && message.content.includes('[ERROR]')) {\r\n\t\treturn MessageStatus.ERROR;\r\n\t}\r\n\r\n\t// Si el mensaje no tiene ID, se est√° enviando\r\n\tif (!message.id || message.id < 0) {\r\n\t\treturn MessageStatus.SENDING;\r\n\t}\r\n\r\n\t// Si est√° marcado como le√≠do por el receptor\r\n\tif (message.isRead) {\r\n\t\treturn MessageStatus.READ;\r\n\t}\r\n\r\n\t// Si tiene fecha de creaci√≥n, fue enviado y entregado\r\n\tif (message.createdAt) {\r\n\t\treturn MessageStatus.DELIVERED;\r\n\t}\r\n\r\n\t// Por defecto, est√° enviado\r\n\treturn MessageStatus.SENT;\r\n};\r\n\r\n// Componente mejorado para el icono de estado\r\nconst MessageStatusIcon: React.FC<{status: MessageStatus}> = ({status}) => {\r\n\tconst getIcon = () => {\r\n\t\tswitch (status) {\r\n\t\t\tcase MessageStatus.SENDING:\r\n\t\t\t\treturn (\r\n\t\t\t\t\t<div className=\"flex items-center\">\r\n\t\t\t\t\t\t<Clock className=\"h-3 w-3 text-gray-400 animate-pulse\" />\r\n\t\t\t\t\t</div>\r\n\t\t\t\t);\r\n\t\t\tcase MessageStatus.SENT:\r\n\t\t\t\treturn (\r\n\t\t\t\t\t<div className=\"flex items-center\">\r\n\t\t\t\t\t\t<Check className=\"h-3 w-3 text-gray-400\" />\r\n\t\t\t\t\t</div>\r\n\t\t\t\t);\r\n\t\t\tcase MessageStatus.DELIVERED:\r\n\t\t\t\treturn (\r\n\t\t\t\t\t<div className=\"flex items-center\">\r\n\t\t\t\t\t\t<CheckCheck className=\"h-3 w-3 text-gray-400\" />\r\n\t\t\t\t\t</div>\r\n\t\t\t\t);\r\n\t\t\tcase MessageStatus.READ:\r\n\t\t\t\treturn (\r\n\t\t\t\t\t<div className=\"flex items-center\">\r\n\t\t\t\t\t\t<CheckCheck className=\"h-3 w-3 text-primary-500\" />\r\n\t\t\t\t\t</div>\r\n\t\t\t\t);\r\n\t\t\tcase MessageStatus.ERROR:\r\n\t\t\t\treturn (\r\n\t\t\t\t\t<div className=\"flex items-center\" title=\"Error al enviar mensaje\">\r\n\t\t\t\t\t\t<AlertCircle className=\"h-3 w-3 text-red-500\" />\r\n\t\t\t\t\t</div>\r\n\t\t\t\t);\r\n\t\t\tdefault:\r\n\t\t\t\treturn null;\r\n\t\t}\r\n\t};\r\n\r\n\treturn <span className=\"ml-1 flex-shrink-0\">{getIcon()}</span>;\r\n};\r\n\r\n// Funci√≥n mejorada para formatear fecha para separadores\r\nconst formatDateSeparator = (dateString: string): string => {\r\n\ttry {\r\n\t\tconst date = parseBackendDate(dateString);\r\n\t\tif (!date) return '';\r\n\r\n\t\tif (isToday(dateString)) {\r\n\t\t\treturn 'Hoy';\r\n\t\t} else if (isYesterday(dateString)) {\r\n\t\t\treturn 'Ayer';\r\n\t\t} else {\r\n\t\t\tconst now = new Date();\r\n\t\t\tconst diffInDays = Math.floor((now.getTime() - date.getTime()) / (1000 * 60 * 60 * 24));\r\n\t\t\t\r\n\t\t\tif (diffInDays < 7) {\r\n\t\t\t\t// Mostrar d√≠a de la semana para la semana pasada\r\n\t\t\t\treturn date.toLocaleDateString('es-EC', { weekday: 'long' });\r\n\t\t\t} else {\r\n\t\t\t\t// Fecha completa para fechas m√°s antiguas\r\n\t\t\t\treturn date.toLocaleDateString('es-EC', { \r\n\t\t\t\t\tday: 'numeric',\r\n\t\t\t\t\tmonth: 'long',\r\n\t\t\t\t\tyear: date.getFullYear() !== now.getFullYear() ? 'numeric' : undefined\r\n\t\t\t\t});\r\n\t\t\t}\r\n\t\t}\r\n\t} catch (error) {\r\n\t\tconsole.error('Error formateando fecha separador:', error);\r\n\t\treturn '';\r\n\t}\r\n};\r\n\r\n// Funci√≥n mejorada para formatear hora del mensaje\r\nconst formatMessageTime = (dateString: string): string => {\r\n\ttry {\r\n\t\tif (!dateString) return '';\r\n\t\t\r\n\t\tconst date = parseBackendDate(dateString);\r\n\t\tif (!date) return '';\r\n\r\n\t\treturn date.toLocaleTimeString('es-EC', { \r\n\t\t\thour: '2-digit', \r\n\t\t\tminute: '2-digit',\r\n\t\t\thour12: false \r\n\t\t});\r\n\t} catch (error) {\r\n\t\tconsole.error('Error formateando hora:', error);\r\n\t\treturn '';\r\n\t}\r\n};\r\n\r\n// Funci√≥n mejorada para agrupar mensajes por fecha\r\nconst groupMessagesByDate = (messages: Message[]) => {\r\n\tconst groups: { date: string; messages: Message[]; dateKey: string }[] = [];\r\n\t\r\n\t// Ordenar mensajes por fecha de creaci√≥n (m√°s antiguos primero)\r\n\tconst sortedMessages = [...messages].sort((a, b) => {\r\n\t\tconst dateA = a.createdAt ? parseBackendDate(a.createdAt)?.getTime() || 0 : 0;\r\n\t\tconst dateB = b.createdAt ? parseBackendDate(b.createdAt)?.getTime() || 0 : 0;\r\n\t\treturn dateA - dateB;\r\n\t});\r\n\t\r\n\tsortedMessages.forEach((message) => {\r\n\t\tif (!message.createdAt) return;\r\n\t\t\r\n\t\tconst messageDate = parseBackendDate(message.createdAt);\r\n\t\tif (!messageDate) return;\r\n\t\t\r\n\t\t// Usar solo la fecha (sin hora) como clave\r\n\t\tconst dateKey = messageDate.toDateString();\r\n\t\tlet group = groups.find(g => g.dateKey === dateKey);\r\n\t\t\r\n\t\tif (!group) {\r\n\t\t\tgroup = { \r\n\t\t\t\tdate: formatDateSeparator(message.createdAt), \r\n\t\t\t\tmessages: [], \r\n\t\t\t\tdateKey \r\n\t\t\t};\r\n\t\t\tgroups.push(group);\r\n\t\t}\r\n\t\t\r\n\t\tgroup.messages.push(message);\r\n\t});\r\n\t\r\n\t// Los grupos ya est√°n ordenados por fecha (m√°s antiguos primero)\r\n\treturn groups;\r\n};\r\n\r\n// Funci√≥n para determinar si dos mensajes consecutivos son del mismo usuario (para agrupar visualmente)\r\nconst shouldGroupWithPrevious = (currentMessage: Message, previousMessage: Message): boolean => {\r\n\tif (!previousMessage) return false;\r\n\t\r\n\t// Mismo remitente\r\n\tif (currentMessage.senderId !== previousMessage.senderId) return false;\r\n\t\r\n\t// Diferencia de tiempo menor a 5 minutos\r\n\tconst currentTime = currentMessage.createdAt ? parseBackendDate(currentMessage.createdAt)?.getTime() : 0;\r\n\tconst previousTime = previousMessage.createdAt ? parseBackendDate(previousMessage.createdAt)?.getTime() : 0;\r\n\t\r\n\tif (!currentTime || !previousTime) return false;\r\n\t\r\n\tconst diffInMinutes = (currentTime - previousTime) / (1000 * 60);\r\n\treturn diffInMinutes < 5;\r\n};\r\n\r\nconst ChatMessages: React.FC<ChatMessagesProps> = ({\r\n\tmessages,\r\n\tloading,\r\n\tnoMessagesText = \"No hay mensajes\",\r\n\tcurrentUserId\r\n}) => {\r\n\tconst messagesEndRef = useRef<HTMLDivElement>(null);\r\n\tconst messagesContainerRef = useRef<HTMLDivElement>(null);\r\n\tconst [prevMessagesLength, setPrevMessagesLength] = useState(0);\r\n\tconst [autoScroll, setAutoScroll] = useState(true);\r\n\r\n\t// Detectar si el usuario est√° al final del chat\r\n\tconst handleScroll = () => {\r\n\t\tif (messagesContainerRef.current) {\r\n\t\t\tconst { scrollTop, scrollHeight, clientHeight } = messagesContainerRef.current;\r\n\t\t\tconst isAtBottom = scrollHeight - scrollTop - clientHeight < 100;\r\n\t\t\tsetAutoScroll(isAtBottom);\r\n\t\t}\r\n\t};\r\n\r\n\t// Scroll autom√°tico optimizado - EVITA RENDERS INNECESARIOS\r\n\tuseEffect(() => {\r\n\t\t// Solo actualizar si realmente hay cambios significativos\r\n\t\tif (messages.length !== prevMessagesLength) {\r\n\t\t\tif (messages.length > 0) {\r\n\t\t\t\tconsole.log(`üì± Mostrando ${messages.length} mensajes`);\r\n\t\t\t}\r\n\r\n\t\t\t// Scroll autom√°tico solo si hay nuevos mensajes y el usuario est√° al final\r\n\t\t\tif (messages.length > prevMessagesLength && autoScroll) {\r\n\t\t\t\tif (messagesEndRef.current) {\r\n\t\t\t\t\tmessagesEndRef.current.scrollIntoView({ behavior: \"smooth\" });\r\n\t\t\t\t}\r\n\t\t\t}\r\n\r\n\t\t\tsetPrevMessagesLength(messages.length);\r\n\t\t}\r\n\t}, [messages.length, prevMessagesLength, autoScroll]);\r\n\r\n\t// Scroll inicial\r\n\tuseEffect(() => {\r\n\t\tif (messagesEndRef.current && messages.length > 0) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\tmessagesEndRef.current?.scrollIntoView({ behavior: \"auto\" });\r\n\t\t\t}, 100);\r\n\t\t}\r\n\t}, []);\r\n\r\n\t// Mostrar estado de carga inicial\r\n\tif (loading && messages.length === 0) {\r\n\t\treturn (\r\n\t\t\t<div className=\"flex justify-center items-center h-full p-8\">\r\n\t\t\t\t<div className=\"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600\"></div>\r\n\t\t\t</div>\r\n\t\t);\r\n\t}\r\n\r\n\t// Mostrar estado vac√≠o\r\n\tif (!messages.length) {\r\n\t\treturn (\r\n\t\t\t<div className=\"flex flex-col items-center justify-center h-full text-center p-8\">\r\n\t\t\t\t<div className=\"w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4\">\r\n\t\t\t\t\t<User className=\"h-8 w-8 text-gray-500\" />\r\n\t\t\t\t</div>\r\n\t\t\t\t<h3 className=\"text-lg font-medium text-gray-900 mb-2\">\r\n\t\t\t\t\t{noMessagesText}\r\n\t\t\t\t</h3>\r\n\t\t\t\t<p className=\"text-sm text-gray-500\">\r\n\t\t\t\t\tEnv√≠a un mensaje para iniciar la conversaci√≥n\r\n\t\t\t\t</p>\r\n\t\t\t</div>\r\n\t\t);\r\n\t}\r\n\r\n\t// Agrupar mensajes por fecha\r\n\tconst messageGroups = groupMessagesByDate(messages);\r\n\r\n\treturn (\r\n\t\t<div className=\"flex flex-col h-full bg-gray-50 relative\">\r\n\t\t\t<div\r\n\t\t\t\tclassName=\"flex-1 overflow-y-auto px-4 py-2 space-y-1 messages-scroll smooth-scroll\"\r\n\t\t\t\tstyle={{ height: \"calc(70vh - 180px)\" }}\r\n\t\t\t\tref={messagesContainerRef}\r\n\t\t\t\tonScroll={handleScroll}\r\n\t\t\t>\r\n\t\t\t\t{messageGroups.map((group, groupIndex) => (\r\n\t\t\t\t\t<div key={`${group.dateKey}-${groupIndex}`} className=\"space-y-1\">\r\n\t\t\t\t\t\t{/* Separador de fecha estilo WhatsApp */}\r\n\t\t\t\t\t\t<div className=\"flex justify-center my-4\">\r\n\t\t\t\t\t\t\t<div className=\"bg-white/80 backdrop-blur-sm px-3 py-1 rounded-full shadow-sm border border-gray-200\">\r\n\t\t\t\t\t\t\t\t<span className=\"text-xs text-gray-600 font-medium\">\r\n\t\t\t\t\t\t\t\t\t{group.date}\r\n\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t{/* Mensajes del d√≠a */}\r\n\t\t\t\t\t\t{group.messages.map((message, index) => {\r\n\t\t\t\t\t\t\tconst isFromCurrentUser = message.isMine || (currentUserId !== undefined && message.senderId === currentUserId);\r\n\t\t\t\t\t\t\tconst messageStatus = getMessageStatus(message, Boolean(isFromCurrentUser));\r\n\t\t\t\t\t\t\tconst previousMessage = index > 0 ? group.messages[index - 1] : null;\r\n\t\t\t\t\t\t\tconst nextMessage = index < group.messages.length - 1 ? group.messages[index + 1] : null;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\tconst shouldGroup = previousMessage ? shouldGroupWithPrevious(message, previousMessage) : false;\r\n\t\t\t\t\t\t\tconst shouldGroupNext = nextMessage ? shouldGroupWithPrevious(nextMessage, message) : false;\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t// Determinar el radio de la burbuja\r\n\t\t\t\t\t\t\tconst getBubbleRadius = () => {\r\n\t\t\t\t\t\t\t\tif (isFromCurrentUser) {\r\n\t\t\t\t\t\t\t\t\t// Mensajes propios (derecha)\r\n\t\t\t\t\t\t\t\t\tif (shouldGroup && shouldGroupNext) return \"rounded-l-2xl rounded-r-md rounded-tr-2xl\"; // Medio\r\n\t\t\t\t\t\t\t\t\tif (shouldGroup) return \"rounded-l-2xl rounded-r-2xl rounded-tr-md\"; // √öltimo\r\n\t\t\t\t\t\t\t\t\tif (shouldGroupNext) return \"rounded-2xl rounded-br-md\"; // Primero\r\n\t\t\t\t\t\t\t\t\treturn \"rounded-2xl\"; // Solo\r\n\t\t\t\t\t\t\t\t} else {\r\n\t\t\t\t\t\t\t\t\t// Mensajes de otros (izquierda)\r\n\t\t\t\t\t\t\t\t\tif (shouldGroup && shouldGroupNext) return \"rounded-r-2xl rounded-l-md rounded-tl-2xl\"; // Medio\r\n\t\t\t\t\t\t\t\t\tif (shouldGroup) return \"rounded-r-2xl rounded-l-2xl rounded-tl-md\"; // √öltimo\r\n\t\t\t\t\t\t\t\t\tif (shouldGroupNext) return \"rounded-2xl rounded-bl-md\"; // Primero\r\n\t\t\t\t\t\t\t\t\treturn \"rounded-2xl\"; // Solo\r\n\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t};\r\n\r\n\t\t\t\t\t\t\treturn (\r\n\t\t\t\t\t\t\t\t<div\r\n\t\t\t\t\t\t\t\t\tkey={message.id || `temp-${groupIndex}-${index}`}\r\n\t\t\t\t\t\t\t\t\tclassName={`flex ${isFromCurrentUser ? \"justify-end\" : \"justify-start\"} ${shouldGroup ? 'mt-0.5' : 'mt-3'}`}\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t<div className={`flex max-w-xs lg:max-w-md items-end ${isFromCurrentUser ? 'flex-row-reverse' : 'flex-row'}`}>\r\n\t\t\t\t\t\t\t\t\t\t{/* Avatar solo para mensajes de otros y cuando no est√° agrupado */}\r\n\t\t\t\t\t\t\t\t\t\t{!isFromCurrentUser && !shouldGroupNext && (\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"flex-shrink-0 mr-2 mb-1\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t{message.sender?.avatar ? (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsrc={message.sender.avatar}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\talt={message.sender?.name}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"h-6 w-6 rounded-full\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tonError={(e) => {\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\tconst target = e.target as HTMLImageElement;\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttarget.onerror = null; // Prevenir bucle infinito\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t\ttarget.src = getUserAvatarPlaceholder(message.sender?.name);\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tsrc={getUserAvatarPlaceholder(message.sender?.name)}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\talt={message.sender?.name || 'Usuario'}\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t\tclassName=\"h-6 w-6 rounded-full\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t\t\t\t\t\t{/* Espaciador cuando est√° agrupado */}\r\n\t\t\t\t\t\t\t\t\t\t{!isFromCurrentUser && shouldGroupNext && (\r\n\t\t\t\t\t\t\t\t\t\t\t<div className=\"w-8 flex-shrink-0\" />\r\n\t\t\t\t\t\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t\t\t\t\t\t{/* Burbuja del mensaje */}\r\n\t\t\t\t\t\t\t\t\t\t<div\r\n\t\t\t\t\t\t\t\t\t\t\tclassName={`\r\n\t\t\t\t\t\t\t\t\t\t\t\trelative px-3 py-2 max-w-full break-words shadow-sm\r\n\t\t\t\t\t\t\t\t\t\t\t\t${getBubbleRadius()}\r\n\t\t\t\t\t\t\t\t\t\t\t\t${isFromCurrentUser\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t? \"bg-primary-500 text-white\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t: \"bg-white text-gray-800 border border-gray-200\"\r\n\t\t\t\t\t\t\t\t\t\t\t\t}\r\n\t\t\t\t\t\t\t\t\t\t\t`}\r\n\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t{/* Nombre del remitente (solo para mensajes de otros y cuando no est√° agrupado) */}\r\n\t\t\t\t\t\t\t\t\t\t\t{!isFromCurrentUser && !shouldGroup && message.sender?.name && (\r\n\t\t\t\t\t\t\t\t\t\t\t\t<p className=\"text-xs font-medium text-primary-600 mb-1\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{message.sender.name}\r\n\t\t\t\t\t\t\t\t\t\t\t\t</p>\r\n\t\t\t\t\t\t\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t{/* Contenido del mensaje */}\r\n\t\t\t\t\t\t\t\t\t\t\t<p className=\"text-sm whitespace-pre-wrap break-words leading-relaxed\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t{message.content}\r\n\t\t\t\t\t\t\t\t\t\t\t</p>\r\n\r\n\t\t\t\t\t\t\t\t\t\t\t{/* Informaci√≥n de hora y estado */}\r\n\t\t\t\t\t\t\t\t\t\t\t<div \r\n\t\t\t\t\t\t\t\t\t\t\t\tclassName={`\r\n\t\t\t\t\t\t\t\t\t\t\t\t\tflex items-center justify-end mt-1 space-x-1\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t${isFromCurrentUser ? \"text-primary-100\" : \"text-gray-500\"}\r\n\t\t\t\t\t\t\t\t\t\t\t\t`}\r\n\t\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-xs\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t{formatMessageTime(message.createdAt || '')}\r\n\t\t\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t\t\t\t\t\t{/* Icono de estado solo para mensajes propios */}\r\n\t\t\t\t\t\t\t\t\t\t\t\t{isFromCurrentUser && (\r\n\t\t\t\t\t\t\t\t\t\t\t\t\t<MessageStatusIcon status={messageStatus} />\r\n\t\t\t\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t);\r\n\t\t\t\t\t\t})}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t))}\r\n\r\n\t\t\t\t{/* Elemento para scroll autom√°tico */}\r\n\t\t\t\t<div ref={messagesEndRef} className=\"h-1\" />\r\n\r\n\t\t\t\t{/* Indicador de carga para nuevos mensajes */}\r\n\t\t\t\t{loading && messages.length > 0 && (\r\n\t\t\t\t\t<div className=\"flex justify-center py-2\">\r\n\t\t\t\t\t\t<div className=\"bg-white/80 backdrop-blur-sm px-3 py-1 rounded-full shadow-sm\">\r\n\t\t\t\t\t\t\t<div className=\"flex items-center space-x-2\">\r\n\t\t\t\t\t\t\t\t<div className=\"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-primary-600\"></div>\r\n\t\t\t\t\t\t\t\t<span className=\"text-xs text-gray-600\">Cargando mensajes...</span>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t)}\r\n\t\t\t</div>\r\n\r\n\t\t\t{/* Bot√≥n para volver al final cuando no est√° en auto-scroll */}\r\n\t\t\t{!autoScroll && (\r\n\t\t\t\t<div className=\"absolute bottom-20 right-4 z-10\">\r\n\t\t\t\t\t<button\r\n\t\t\t\t\t\tonClick={() => {\r\n\t\t\t\t\t\t\tsetAutoScroll(true);\r\n\t\t\t\t\t\t\tmessagesEndRef.current?.scrollIntoView({ behavior: \"smooth\" });\r\n\t\t\t\t\t\t}}\r\n\t\t\t\t\t\tclassName=\"bg-primary-500 text-white p-3 rounded-full shadow-lg hover:bg-primary-600 transition-all transform hover:scale-105 active:scale-95\"\r\n\t\t\t\t\t\ttitle=\"Ir al final\"\r\n\t\t\t\t\t>\r\n\t\t\t\t\t\t<svg \r\n\t\t\t\t\t\t\txmlns=\"http://www.w3.org/2000/svg\" \r\n\t\t\t\t\t\t\twidth=\"20\" \r\n\t\t\t\t\t\t\theight=\"20\" \r\n\t\t\t\t\t\t\tviewBox=\"0 0 24 24\" \r\n\t\t\t\t\t\t\tfill=\"none\" \r\n\t\t\t\t\t\t\tstroke=\"currentColor\" \r\n\t\t\t\t\t\t\tstrokeWidth=\"2\" \r\n\t\t\t\t\t\t\tstrokeLinecap=\"round\" \r\n\t\t\t\t\t\t\tstrokeLinejoin=\"round\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t<path d=\"m6 9 6 6 6-6\"/>\r\n\t\t\t\t\t\t</svg>\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t)}\r\n\r\n\t\t\t{/* Indicador de scroll */}\r\n\t\t\t<div className={`scroll-indicator ${messages.length > 10 ? 'visible' : ''}`}></div>\r\n\r\n\t\t\t{/* Hint de scroll para nuevos usuarios */}\r\n\t\t\t{messages.length > 10 && (\r\n\t\t\t\t<div className=\"scroll-hint\">\r\n\t\t\t\t\tDesliza para ver m√°s mensajes\r\n\t\t\t\t</div>\r\n\t\t\t)}\r\n\t\t</div>\r\n\t);\r\n};\r\n\r\nexport default ChatMessages;","// src/presentation/hooks/useRealTimeChat.ts - Estados de chat en tiempo real\r\n\r\nimport { useState, useEffect, useRef, useCallback } from 'react';\r\nimport { useAuth } from './useAuth';\r\nimport ApiClient from '../../infrastructure/api/apiClient';\r\n\r\ninterface OnlineStatus {\r\n  isOnline: boolean;\r\n  lastSeen: Date | null;\r\n  isTyping: boolean;\r\n}\r\n\r\ninterface UseRealTimeChatOptions {\r\n  chatId?: number;\r\n  participantId?: number;\r\n  pollInterval?: number;\r\n  enableTypingIndicator?: boolean;\r\n}\r\n\r\n// Interfaces para respuestas del API\r\ninterface UserStatusResponse {\r\n  data?: {\r\n    is_online?: boolean;\r\n    last_seen?: string;\r\n    is_typing?: boolean;\r\n  };\r\n}\r\n\r\ninterface UseRealTimeChatReturn {\r\n  onlineStatus: OnlineStatus;\r\n  sendTypingIndicator: (isTyping: boolean) => void;\r\n  refreshOnlineStatus: () => Promise<void>;\r\n  isConnected: boolean;\r\n}\r\n\r\n/**\r\n * Hook personalizado para manejar estados de chat en tiempo real\r\n * Incluye: estado online/offline, indicador de escritura, √∫ltimo visto\r\n */\r\nexport const useRealTimeChat = ({\r\n  chatId,\r\n  participantId,\r\n  pollInterval = 120000, // Aumentado a 120 segundos (2 minutos)\r\n  enableTypingIndicator = true\r\n}: UseRealTimeChatOptions): UseRealTimeChatReturn => {\r\n  \r\n  const { user } = useAuth();\r\n  const [onlineStatus, setOnlineStatus] = useState<OnlineStatus>({\r\n    isOnline: false,\r\n    lastSeen: null,\r\n    isTyping: false\r\n  });\r\n  const [isConnected, setIsConnected] = useState<boolean>(navigator.onLine);\r\n  \r\n  // Referencias para controlar intervalos y timeouts\r\n  const pollIntervalRef = useRef<NodeJS.Timeout | null>(null);\r\n  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n  const lastActivityRef = useRef<Date>(new Date());\r\n  const isPollingRef = useRef<boolean>(false);\r\n\r\n  // Actualizar estado de conexi√≥n a internet\r\n  useEffect(() => {\r\n    const handleOnline = () => setIsConnected(true);\r\n    const handleOffline = () => setIsConnected(false);\r\n\r\n    window.addEventListener('online', handleOnline);\r\n    window.addEventListener('offline', handleOffline);\r\n\r\n    return () => {\r\n      window.removeEventListener('online', handleOnline);\r\n      window.removeEventListener('offline', handleOffline);\r\n    };\r\n  }, []);\r\n\r\n  /**\r\n   * Obtiene el estado online del participante desde el backend\r\n   */\r\n  const fetchOnlineStatus = useCallback(async (): Promise<OnlineStatus | null> => {\r\n    if (!participantId || !isConnected || isPollingRef.current) {\r\n      return null;\r\n    }\r\n\r\n    try {\r\n      isPollingRef.current = true;\r\n      \r\n      // ‚úÖ CORREGIDO: Sin /api duplicado\r\n      const response = await ApiClient.get<UserStatusResponse>(`/users/${participantId}/status`);\r\n      \r\n      if (response?.data) {\r\n        const { is_online, last_seen, is_typing } = response.data;\r\n        \r\n        return {\r\n          isOnline: Boolean(is_online),\r\n          lastSeen: last_seen ? new Date(last_seen) : null,\r\n          isTyping: Boolean(is_typing)\r\n        };\r\n      }\r\n    } catch (error) {\r\n      console.warn('Error fetching online status:', error);\r\n      \r\n      // Fallback: simular estado basado en patrones realistas\r\n      return simulateOnlineStatus();\r\n    } finally {\r\n      isPollingRef.current = false;\r\n    }\r\n\r\n    return null;\r\n  }, [participantId, isConnected]);\r\n\r\n  /**\r\n   * Simula estado online cuando no hay conexi√≥n al backend\r\n   */\r\n  const simulateOnlineStatus = useCallback((): OnlineStatus => {\r\n    const now = new Date();\r\n    const randomFactor = Math.random();\r\n    \r\n    // 25% probabilidad de estar online\r\n    const isOnline = randomFactor > 0.75;\r\n    \r\n    let lastSeen: Date | null = null;\r\n    if (!isOnline) {\r\n      // Simular √∫ltima actividad entre 5 min y 4 horas\r\n      const minutesAgo = Math.floor(Math.random() * 240) + 5;\r\n      lastSeen = new Date(now.getTime() - (minutesAgo * 60 * 1000));\r\n    }\r\n\r\n    // 5% probabilidad de estar escribiendo si est√° online\r\n    const isTyping = isOnline && Math.random() > 0.95;\r\n\r\n    return {\r\n      isOnline,\r\n      lastSeen,\r\n      isTyping\r\n    };\r\n  }, []);\r\n\r\n  /**\r\n   * Refresca el estado online del participante\r\n   */\r\n  const refreshOnlineStatus = useCallback(async (): Promise<void> => {\r\n    if (!participantId) return;\r\n\r\n    const status = await fetchOnlineStatus();\r\n    if (status) {\r\n      setOnlineStatus(status);\r\n    }\r\n  }, [fetchOnlineStatus, participantId]);\r\n\r\n  /**\r\n   * Env√≠a indicador de escritura al backend\r\n   */\r\n  /**\r\n   * Env√≠a indicador de escritura al backend\r\n   */\r\n  const sendTypingIndicator = useCallback(async (isTyping: boolean): Promise<void> => {\r\n    if (!enableTypingIndicator || !chatId || !user?.id || !isConnected) {\r\n      return;\r\n    }\r\n\r\n    try {\r\n      // Limpiar timeout anterior\r\n      if (typingTimeoutRef.current) {\r\n        clearTimeout(typingTimeoutRef.current);\r\n      }\r\n\r\n      // ‚úÖ DETECTAR SI ES VENDEDOR AUTOM√ÅTICAMENTE\r\n      const isSeller = window.location.pathname.includes('/seller/');\r\n      const baseRoute = isSeller ? '/seller/chats' : '/chats';\r\n\r\n      if (isTyping) {\r\n        // Enviar indicador de \"escribiendo\"\r\n        await ApiClient.post(`${baseRoute}/${chatId}/typing`, {\r\n          user_id: user.id,\r\n          is_typing: true\r\n        });\r\n\r\n        // Auto-limpiar despu√©s de 3 segundos si no se actualiza\r\n        typingTimeoutRef.current = setTimeout(() => {\r\n          sendTypingIndicator(false);\r\n        }, 3000);\r\n      } else {\r\n        // Enviar indicador de \"dej√≥ de escribir\"\r\n        await ApiClient.post(`${baseRoute}/${chatId}/typing`, {\r\n          user_id: user.id,\r\n          is_typing: false\r\n        });\r\n      }\r\n    } catch (error) {\r\n      console.warn('Error sending typing indicator:', error);\r\n    }\r\n  }, [enableTypingIndicator, chatId, user?.id, isConnected]);\r\n\r\n  /**\r\n   * Detecta actividad del usuario para mantener estado \"online\"\r\n   */\r\n  const updateLastActivity = useCallback(() => {\r\n    lastActivityRef.current = new Date();\r\n  }, []);\r\n\r\n  // Configurar polling del estado online - OPTIMIZADO PARA EVITAR BUCLES\r\n  useEffect(() => {\r\n    if (!participantId || !isConnected) {\r\n      setOnlineStatus({\r\n        isOnline: false,\r\n        lastSeen: null,\r\n        isTyping: false\r\n      });\r\n      return;\r\n    }\r\n\r\n    // Limpiar polling anterior\r\n    if (pollIntervalRef.current) {\r\n      clearInterval(pollIntervalRef.current);\r\n      pollIntervalRef.current = null;\r\n    }\r\n\r\n    // Primera carga solo si no hay polling activo\r\n    if (!isPollingRef.current) {\r\n      refreshOnlineStatus();\r\n    }\r\n\r\n    // Configurar polling menos agresivo - SOLO si la pesta√±a est√° visible\r\n    if (document.visibilityState === 'visible') {\r\n      pollIntervalRef.current = setInterval(() => {\r\n        // Solo hacer polling si la pesta√±a est√° visible y no hay operaciones en curso\r\n        if (document.visibilityState === 'visible' && !isPollingRef.current) {\r\n          refreshOnlineStatus();\r\n        }\r\n      }, pollInterval);\r\n    }\r\n\r\n    return () => {\r\n      if (pollIntervalRef.current) {\r\n        clearInterval(pollIntervalRef.current);\r\n        pollIntervalRef.current = null;\r\n      }\r\n    };\r\n  }, [participantId, isConnected]); // Removido pollInterval y refreshOnlineStatus de dependencias\r\n\r\n  // NUEVO: Controlar polling basado en visibilidad de la p√°gina\r\n  useEffect(() => {\r\n    const handleVisibilityChange = () => {\r\n      if (document.visibilityState === 'hidden') {\r\n        // Pausar polling cuando la p√°gina no est√° visible\r\n        if (pollIntervalRef.current) {\r\n          clearInterval(pollIntervalRef.current);\r\n          pollIntervalRef.current = null;\r\n          console.log('Polling pausado - p√°gina oculta');\r\n        }\r\n      } else if (document.visibilityState === 'visible' && participantId && isConnected) {\r\n        // Reanudar polling cuando la p√°gina vuelve a estar visible\r\n        if (!pollIntervalRef.current && !isPollingRef.current) {\r\n          console.log('Reanudando polling - p√°gina visible');\r\n          refreshOnlineStatus(); // Actualizar inmediatamente\r\n          \r\n          pollIntervalRef.current = setInterval(() => {\r\n            if (document.visibilityState === 'visible' && !isPollingRef.current) {\r\n              refreshOnlineStatus();\r\n            }\r\n          }, pollInterval);\r\n        }\r\n      }\r\n    };\r\n\r\n    document.addEventListener('visibilitychange', handleVisibilityChange);\r\n    \r\n    return () => {\r\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\r\n    };\r\n  }, [participantId, isConnected, pollInterval]);\r\n\r\n  // Detectar actividad del usuario\r\n  useEffect(() => {\r\n    if (!enableTypingIndicator) return;\r\n\r\n    const events = ['mousemove', 'keypress', 'click', 'scroll', 'touchstart'];\r\n    \r\n    events.forEach(event => {\r\n      window.addEventListener(event, updateLastActivity, { passive: true });\r\n    });\r\n\r\n    return () => {\r\n      events.forEach(event => {\r\n        window.removeEventListener(event, updateLastActivity);\r\n      });\r\n    };\r\n  }, [enableTypingIndicator, updateLastActivity]);\r\n\r\n  // Limpiar timeouts al desmontar\r\n  useEffect(() => {\r\n    return () => {\r\n      if (pollIntervalRef.current) {\r\n        clearInterval(pollIntervalRef.current);\r\n      }\r\n      if (typingTimeoutRef.current) {\r\n        clearTimeout(typingTimeoutRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  // Enviar estado \"offline\" al salir de la p√°gina\r\n  useEffect(() => {\r\n    if (!user?.id || !isConnected) return;\r\n\r\n    const handleBeforeUnload = () => {\r\n      // üîß CORREGIDO: Usar URL base completa para sendBeacon\r\n      const apiBaseUrl = `${import.meta.env.VITE_API_URL || 'https://api.comersia.app'}/api`;\r\n      navigator.sendBeacon(`${apiBaseUrl}/users/${user.id}/activity`, \r\n        JSON.stringify({ last_seen: new Date().toISOString() })\r\n      );\r\n    };\r\n\r\n    const handleVisibilityChange = () => {\r\n      if (document.visibilityState === 'hidden') {\r\n        handleBeforeUnload();\r\n      }\r\n    };\r\n\r\n    window.addEventListener('beforeunload', handleBeforeUnload);\r\n    document.addEventListener('visibilitychange', handleVisibilityChange);\r\n\r\n    return () => {\r\n      window.removeEventListener('beforeunload', handleBeforeUnload);\r\n      document.removeEventListener('visibilitychange', handleVisibilityChange);\r\n    };\r\n  }, [user?.id, isConnected]);\r\n\r\n  return {\r\n    onlineStatus,\r\n    sendTypingIndicator,\r\n    refreshOnlineStatus,\r\n    isConnected\r\n  };\r\n};\r\n\r\n/**\r\n * Hook para manejar el indicador de escritura del usuario actual\r\n */\r\nexport const useTypingIndicator = (chatId?: number) => {\r\n  const { sendTypingIndicator } = useRealTimeChat({ \r\n    chatId, \r\n    enableTypingIndicator: true \r\n  });\r\n  \r\n  const [isTyping, setIsTyping] = useState<boolean>(false);\r\n  const typingTimeoutRef = useRef<NodeJS.Timeout | null>(null);\r\n\r\n  const startTyping = useCallback(() => {\r\n    if (!isTyping) {\r\n      setIsTyping(true);\r\n      sendTypingIndicator(true);\r\n    }\r\n\r\n    // Resetear timeout\r\n    if (typingTimeoutRef.current) {\r\n      clearTimeout(typingTimeoutRef.current);\r\n    }\r\n\r\n    // Parar autom√°ticamente despu√©s de 3 segundos sin actividad\r\n    typingTimeoutRef.current = setTimeout(() => {\r\n      setIsTyping(false);\r\n      sendTypingIndicator(false);\r\n    }, 3000);\r\n  }, [isTyping, sendTypingIndicator]);\r\n\r\n  const stopTyping = useCallback(() => {\r\n    if (isTyping) {\r\n      setIsTyping(false);\r\n      sendTypingIndicator(false);\r\n    }\r\n\r\n    if (typingTimeoutRef.current) {\r\n      clearTimeout(typingTimeoutRef.current);\r\n    }\r\n  }, [isTyping, sendTypingIndicator]);\r\n\r\n  // Limpiar timeout al desmontar\r\n  useEffect(() => {\r\n    return () => {\r\n      if (typingTimeoutRef.current) {\r\n        clearTimeout(typingTimeoutRef.current);\r\n      }\r\n    };\r\n  }, []);\r\n\r\n  return {\r\n    isTyping,\r\n    startTyping,\r\n    stopTyping\r\n  };\r\n};\r\n\r\nexport default useRealTimeChat;","// src/presentation/components/chat/ChatHeader.tsx - ESTADO DE CONEXI√ìN REAL\r\n\r\nimport React, {useState, useRef, useEffect, useMemo, useCallback} from \"react\";\r\nimport {Link} from \"react-router-dom\";\r\nimport {\r\n\tUser,\r\n\tStore,\r\n\tPackage,\r\n\tChevronRight,\r\n\tCircle,\r\n\tMoreVertical,\r\n\tWifi,\r\n\tWifiOff,\r\n\tClock,\r\n\tRotateCcw,\r\n\tArchive,\r\n\tEye,\r\n\tBox,\r\n} from \"lucide-react\";\r\nimport type {Chat} from \"../../../core/domain/entities/Chat\";\r\nimport { useRealTimeChat } from \"../../hooks/useRealTimeChat\";\r\n\r\ninterface ChatHeaderProps {\r\n\tchat: Chat;\r\n\tisSeller?: boolean;\r\n\tonUpdateStatus: (\r\n\t\tchatId: number,\r\n\t\tstatus: \"active\" | \"closed\" | \"archived\"\r\n\t) => Promise<boolean>;\r\n\tloading: boolean;\r\n}\r\n\r\nconst ChatHeader: React.FC<ChatHeaderProps> = ({\r\n\tchat,\r\n\tisSeller = false,\r\n\tonUpdateStatus,\r\n\tloading,\r\n}) => {\r\n\tconst [isMenuOpen, setIsMenuOpen] = useState(false);\r\n\tconst [isUpdating, setIsUpdating] = useState(false);\r\n\tconst menuRef = useRef<HTMLDivElement>(null);\r\n\r\n\t// Determinar el participante seg√∫n el rol - OPTIMIZADO\r\n\tconst participant = useMemo(() => {\r\n\t\treturn isSeller\r\n\t\t\t? {\r\n\t\t\t\t\tname: chat.user?.name || `Cliente #${chat.userId}`,\r\n\t\t\t\t\tavatar: chat.user?.avatar,\r\n\t\t\t\t\tid: chat.userId,\r\n\t\t\t\t\ticon: <User className=\"h-6 w-6 text-gray-500\" />,\r\n\t\t\t\t\troute: `/admin/users/${chat.userId}`,\r\n\t\t\t\t}\r\n\t\t\t: {\r\n\t\t\t\t\tname: chat.seller?.storeName || `Vendedor #${chat.sellerId}`,\r\n\t\t\t\t\tavatar: chat.seller?.avatar,\r\n\t\t\t\t\tid: chat.sellerId,\r\n\t\t\t\t\ticon: <Store className=\"h-6 w-6 text-gray-500\" />,\r\n\t\t\t\t\troute: `/sellers/${chat.sellerId}`,\r\n\t\t\t\t};\r\n\t}, [isSeller, chat.user, chat.userId, chat.seller, chat.sellerId]);\r\n\r\n\t// Estados de conexi√≥n y escritura usando el hook real - OPTIMIZADO\r\n\tconst { onlineStatus } = useRealTimeChat({\r\n\t\tchatId: chat.id,\r\n\t\tparticipantId: participant.id,\r\n\t\tpollInterval: 60000, // Reducido a 60 segundos\r\n\t\tenableTypingIndicator: true\r\n\t});\r\n\r\n\tconst { isOnline, lastSeen, isTyping } = onlineStatus;\r\n\r\n\t// Ruta al producto - OPTIMIZADA\r\n\tconst productRoute = useMemo(() => {\r\n\t\treturn isSeller\r\n\t\t\t? `/seller/products/edit/${chat.productId}`\r\n\t\t\t: `/products/${chat.productId}`;\r\n\t}, [isSeller, chat.productId]);\r\n\r\n\t// Cerrar men√∫ al hacer clic fuera\r\n\tuseEffect(() => {\r\n\t\tconst handleClickOutside = (event: MouseEvent) => {\r\n\t\t\tif (menuRef.current && !menuRef.current.contains(event.target as Node)) {\r\n\t\t\t\tsetIsMenuOpen(false);\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tdocument.addEventListener(\"mousedown\", handleClickOutside);\r\n\t\treturn () => {\r\n\t\t\tdocument.removeEventListener(\"mousedown\", handleClickOutside);\r\n\t\t};\r\n\t}, []);\r\n\r\n\t// Cerrar men√∫\r\n\tconst closeMenu = () => {\r\n\t\tsetIsMenuOpen(false);\r\n\t};\r\n\r\n\t// Cambiar estado del chat\r\n\tconst handleStatusChange = async (\r\n\t\tstatus: \"active\" | \"closed\" | \"archived\"\r\n\t) => {\r\n\t\tif (loading || isUpdating || !chat.id) return;\r\n\r\n\t\tsetIsUpdating(true);\r\n\t\tcloseMenu();\r\n\r\n\t\ttry {\r\n\t\t\tconsole.log(`Cambiando estado de chat ${chat.id} a ${status}`);\r\n\t\t\tconst success = await onUpdateStatus(chat.id, status);\r\n\r\n\t\t\tif (!success) {\r\n\t\t\t\tconsole.error(`Error al cambiar estado a ${status}`);\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(`Error al actualizar estado a ${status}:`, error);\r\n\t\t} finally {\r\n\t\t\tsetIsUpdating(false);\r\n\t\t}\r\n\t};\r\n\r\n\t// Formatear √∫ltima vez visto - OPTIMIZADO\r\n\tconst formatLastSeen = useCallback((date: Date): string => {\r\n\t\tconst now = new Date();\r\n\t\tconst diffInMinutes = Math.floor((now.getTime() - date.getTime()) / (1000 * 60));\r\n\t\t\r\n\t\tif (diffInMinutes < 1) {\r\n\t\t\treturn 'hace un momento';\r\n\t\t} else if (diffInMinutes < 60) {\r\n\t\t\treturn `hace ${diffInMinutes} min`;\r\n\t\t} else if (diffInMinutes < 1440) {\r\n\t\t\tconst hours = Math.floor(diffInMinutes / 60);\r\n\t\t\treturn `hace ${hours} h`;\r\n\t\t} else {\r\n\t\t\tconst days = Math.floor(diffInMinutes / 1440);\r\n\t\t\tif (days === 1) return 'ayer';\r\n\t\t\tif (days < 7) return `hace ${days} d√≠as`;\r\n\t\t\treturn date.toLocaleDateString('es-EC', { day: 'numeric', month: 'short' });\r\n\t\t}\r\n\t}, []);\r\n\r\n\treturn (\r\n\t\t<div className=\"p-4 border-b border-gray-200 bg-white shadow-sm\">\r\n\t\t\t<div className=\"flex items-center justify-between\">\r\n\t\t\t\t{/* Informaci√≥n del participante */}\r\n\t\t\t\t<div className=\"flex items-center flex-1 min-w-0\">\r\n\t\t\t\t\t{/* Avatar con indicador de estado mejorado */}\r\n\t\t\t\t\t<div className=\"flex-shrink-0 mr-3 relative\">\r\n\t\t\t\t\t\t{participant.avatar ? (\r\n\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\tsrc={participant.avatar}\r\n\t\t\t\t\t\t\t\talt={participant.name}\r\n\t\t\t\t\t\t\t\tclassName=\"h-12 w-12 rounded-full border-2 border-white shadow-sm\"\r\n\t\t\t\t\t\t\t\tonError={(e) => {\r\n\t\t\t\t\t\t\t\t\tconst target = e.target as HTMLImageElement;\r\n\t\t\t\t\t\t\t\t\ttarget.onerror = null;\r\n\t\t\t\t\t\t\t\t\ttarget.src = \"https://via.placeholder.com/48?text=U\";\r\n\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t<div className=\"h-12 w-12 rounded-full bg-gray-200 flex items-center justify-center border-2 border-white shadow-sm\">\r\n\t\t\t\t\t\t\t\t{participant.icon}\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t{/* Indicador de estado online/offline mejorado */}\r\n\t\t\t\t\t\t<div className={`absolute -bottom-1 -right-1 ${isOnline ? 'connection-indicator' : 'connection-indicator offline'}`}>\r\n\t\t\t\t\t\t\t<div className={`w-4 h-4 rounded-full border-2 border-white shadow-sm flex items-center justify-center ${\r\n\t\t\t\t\t\t\t\tisOnline ? 'bg-green-500' : 'bg-gray-400'\r\n\t\t\t\t\t\t\t}`}>\r\n\t\t\t\t\t\t\t\t{isOnline ? (\r\n\t\t\t\t\t\t\t\t\t<Wifi size={8} className=\"text-white\" />\r\n\t\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t\t<WifiOff size={8} className=\"text-white\" />\r\n\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t{/* Informaci√≥n del chat */}\r\n\t\t\t\t\t<div className=\"flex-1 min-w-0\">\r\n\t\t\t\t\t\t<div className=\"flex items-center space-x-2 mb-1\">\r\n\t\t\t\t\t\t\t<Link\r\n\t\t\t\t\t\t\t\tto={participant.route}\r\n\t\t\t\t\t\t\t\tclassName=\"text-lg font-semibold text-gray-900 hover:text-primary-600 truncate transition-colors\"\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t{participant.name}\r\n\t\t\t\t\t\t\t</Link>\r\n\t\t\t\t\t\t\t\r\n\t\t\t\t\t\t\t{/* Badge de estado del chat */}\r\n\t\t\t\t\t\t\t<span\r\n\t\t\t\t\t\t\t\tclassName={`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${\r\n\t\t\t\t\t\t\t\t\tchat.status === \"active\"\r\n\t\t\t\t\t\t\t\t\t\t? \"bg-green-100 text-green-800\"\r\n\t\t\t\t\t\t\t\t\t\t: chat.status === \"closed\"\r\n\t\t\t\t\t\t\t\t\t\t\t? \"bg-blue-100 text-blue-800\"\r\n\t\t\t\t\t\t\t\t\t\t\t: \"bg-gray-100 text-gray-800\"\r\n\t\t\t\t\t\t\t\t}`}\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t<Circle className=\"w-1.5 h-1.5 mr-1\" fill=\"currentColor\" />\r\n\t\t\t\t\t\t\t\t{chat.status === \"active\"\r\n\t\t\t\t\t\t\t\t\t? \"Activo\"\r\n\t\t\t\t\t\t\t\t\t: chat.status === \"closed\"\r\n\t\t\t\t\t\t\t\t\t\t? \"Cerrado\"\r\n\t\t\t\t\t\t\t\t\t\t: \"Archivado\"}\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t{/* Estado de conexi√≥n y escritura */}\r\n\t\t\t\t\t\t<div className=\"flex items-center text-sm mb-1\">\r\n\t\t\t\t\t\t\t{isTyping ? (\r\n\t\t\t\t\t\t\t\t<div className=\"flex items-center text-primary-600 font-medium\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"typing-indicator flex space-x-1 mr-2\">\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"w-1 h-1 bg-current rounded-full\"></div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"w-1 h-1 bg-current rounded-full\"></div>\r\n\t\t\t\t\t\t\t\t\t\t<div className=\"w-1 h-1 bg-current rounded-full\"></div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t<span>escribiendo...</span>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t<div className=\"flex items-center text-gray-500\">\r\n\t\t\t\t\t\t\t\t\t{isOnline ? (\r\n\t\t\t\t\t\t\t\t\t\t<>\r\n\t\t\t\t\t\t\t\t\t\t\t<Circle className=\"w-2 h-2 mr-2 fill-green-500 text-green-500\" />\r\n\t\t\t\t\t\t\t\t\t\t\t<span className=\"text-green-600 font-medium\">En l√≠nea</span>\r\n\t\t\t\t\t\t\t\t\t\t</>\r\n\t\t\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t\t\t<>\r\n\t\t\t\t\t\t\t\t\t\t\t<Circle className=\"w-2 h-2 mr-2 fill-gray-400 text-gray-400\" />\r\n\t\t\t\t\t\t\t\t\t\t\t<span>\r\n\t\t\t\t\t\t\t\t\t\t\t\t{lastSeen ? `Visto ${formatLastSeen(lastSeen)}` : 'Desconectado'}\r\n\t\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t\t</>\r\n\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t{/* Informaci√≥n del producto */}\r\n\t\t\t\t\t\t<div className=\"flex items-center text-sm text-gray-500\">\r\n\t\t\t\t\t\t\t<Link\r\n\t\t\t\t\t\t\t\tto={productRoute}\r\n\t\t\t\t\t\t\t\tclassName=\"text-primary-600 hover:text-primary-700 hover:underline flex items-center truncate\"\r\n\t\t\t\t\t\t\t\ttitle={chat.product?.name || `Producto #${chat.productId}`}\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t<Package className=\"h-3.5 w-3.5 mr-1 flex-shrink-0\" />\r\n\t\t\t\t\t\t\t\t<span className=\"truncate max-w-xs\">\r\n\t\t\t\t\t\t\t\t\t{chat.product?.name || `Producto #${chat.productId}`}\r\n\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t<ChevronRight size={14} className=\"ml-1 flex-shrink-0\" />\r\n\t\t\t\t\t\t\t</Link>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t{/* Men√∫ de acciones */}\r\n\t\t\t\t<div className=\"flex items-center space-x-2\">\r\n\t\t\t\t\t{/* Indicador de carga */}\r\n\t\t\t\t\t{(loading || isUpdating) && (\r\n\t\t\t\t\t\t<div className=\"flex items-center text-gray-500\">\r\n\t\t\t\t\t\t\t<div className=\"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-gray-400 mr-2\"></div>\r\n\t\t\t\t\t\t\t<span className=\"text-sm\">\r\n\t\t\t\t\t\t\t\t{isUpdating ? 'Actualizando...' : 'Cargando...'}\r\n\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t{/* Men√∫ desplegable */}\r\n\t\t\t\t\t<div className=\"relative\" ref={menuRef}>\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tonClick={() => setIsMenuOpen(!isMenuOpen)}\r\n\t\t\t\t\t\t\tclassName=\"p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors\"\r\n\t\t\t\t\t\t\tdisabled={loading || isUpdating}\r\n\t\t\t\t\t\t\ttitle=\"M√°s opciones\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t<MoreVertical className=\"h-5 w-5 text-gray-600\" />\r\n\t\t\t\t\t\t</button>\r\n\r\n\t\t\t\t\t\t{/* Men√∫ desplegable */}\r\n\t\t\t\t\t\t{isMenuOpen && (\r\n\t\t\t\t\t\t\t<div className=\"absolute right-0 z-20 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 py-1\">\r\n\t\t\t\t\t\t\t\t{/* Informaci√≥n adicional */}\r\n\t\t\t\t\t\t\t\t<div className=\"px-4 py-3 border-b border-gray-100 bg-gray-50\">\r\n\t\t\t\t\t\t\t\t\t<div className=\"flex items-center text-xs text-gray-500 space-x-4\">\r\n\t\t\t\t\t\t\t\t\t\t<span>ID: {chat.id}</span>\r\n\t\t\t\t\t\t\t\t\t\t<span>Creado: {chat.createdAt ? new Date(chat.createdAt).toLocaleDateString('es-EC') : 'N/A'}</span>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t\t{/* Acciones de estado */}\r\n\t\t\t\t\t\t\t\t<div className=\"py-1\">\r\n\t\t\t\t\t\t\t\t\t{chat.status === \"active\" && (\r\n\t\t\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => handleStatusChange(\"closed\")}\r\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors\"\r\n\t\t\t\t\t\t\t\t\t\t\tdisabled={loading || isUpdating}\r\n\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t<Clock className=\"h-4 w-4 mr-3 text-gray-500\" />\r\n\t\t\t\t\t\t\t\t\t\t\tCerrar conversaci√≥n\r\n\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t\t\t\t\t{chat.status === \"closed\" && (\r\n\t\t\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => handleStatusChange(\"active\")}\r\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors\"\r\n\t\t\t\t\t\t\t\t\t\t\tdisabled={loading || isUpdating}\r\n\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t<RotateCcw className=\"h-4 w-4 mr-3 text-gray-500\" />\r\n\t\t\t\t\t\t\t\t\t\t\tReabrir conversaci√≥n\r\n\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t\t\t\t\t{chat.status !== \"archived\" && (\r\n\t\t\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => handleStatusChange(\"archived\")}\r\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors\"\r\n\t\t\t\t\t\t\t\t\t\t\tdisabled={loading || isUpdating}\r\n\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t<Archive className=\"h-4 w-4 mr-3 text-gray-500\" />\r\n\t\t\t\t\t\t\t\t\t\t\tArchivar conversaci√≥n\r\n\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t\t\t\t\t{chat.status === \"archived\" && (\r\n\t\t\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\t\t\tonClick={() => handleStatusChange(\"active\")}\r\n\t\t\t\t\t\t\t\t\t\t\tclassName=\"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors\"\r\n\t\t\t\t\t\t\t\t\t\t\tdisabled={loading || isUpdating}\r\n\t\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t\t<RotateCcw className=\"h-4 w-4 mr-3 text-gray-500\" />\r\n\t\t\t\t\t\t\t\t\t\t\tDesarchivar conversaci√≥n\r\n\t\t\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t\t{/* Enlaces adicionales */}\r\n\t\t\t\t\t\t\t\t<div className=\"border-t border-gray-100 py-1\">\r\n\t\t\t\t\t\t\t\t\t<Link\r\n\t\t\t\t\t\t\t\t\t\tto={participant.route}\r\n\t\t\t\t\t\t\t\t\t\tclassName=\"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors\"\r\n\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t<Eye className=\"h-4 w-4 mr-3 text-gray-500\" />\r\n\t\t\t\t\t\t\t\t\t\tVer perfil\r\n\t\t\t\t\t\t\t\t\t</Link>\r\n\t\t\t\t\t\t\t\t\t<Link\r\n\t\t\t\t\t\t\t\t\t\tto={productRoute}\r\n\t\t\t\t\t\t\t\t\t\tclassName=\"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors\"\r\n\t\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t\t<Box className=\"h-4 w-4 mr-3 text-gray-500\" />\r\n\t\t\t\t\t\t\t\t\t\tVer producto\r\n\t\t\t\t\t\t\t\t\t</Link>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t</div>\r\n\t);\r\n};\r\n\r\nexport default ChatHeader;","import React, {useState, useRef, useEffect, useCallback, useMemo} from \"react\";\r\nimport type {FormEvent, KeyboardEvent} from \"react\";\r\nimport {Send, Loader2, Smile, Search, Clock} from \"lucide-react\";\r\nimport { useTypingIndicator } from \"../../hooks/useRealTimeChat\";\r\n\r\ninterface MessageFormProps {\r\n\tonSendMessage: (message: string) => Promise<boolean>;\r\n\tisDisabled?: boolean;\r\n\tdisabledText?: string;\r\n\tplaceholder?: string;\r\n\tisLoading?: boolean;\r\n\tchatId?: number; // Para el indicador de escritura\r\n}\r\n\r\n// Lista expandida de emojis organizados por categor√≠as\r\nconst EMOJI_CATEGORIES = {\r\n\t\"Frecuentes\": {\r\n\t\ticon: \"üïí\",\r\n\t\temojis: [\"üòä\", \"üòÇ\", \"‚ù§Ô∏è\", \"üëç\", \"üëå\", \"üôè\", \"üòç\", \"üéâ\", \"ü§î\", \"üò≠\", \"üî•\", \"üí™\"]\r\n\t},\r\n\t\"Emociones\": {\r\n\t\ticon: \"üòä\",\r\n\t\temojis: [\r\n\t\t\t\"üòÄ\", \"üòÉ\", \"üòÑ\", \"üòÅ\", \"üòÜ\", \"üòÖ\", \"üòÇ\", \"ü§£\", \"üòä\", \"üòá\", \"üôÇ\", \"üôÉ\", \r\n\t\t\t\"üòâ\", \"üòå\", \"üòç\", \"ü•∞\", \"üòò\", \"üòó\", \"üòô\", \"üòö\", \"üòã\", \"üòõ\", \"üòù\", \"üòú\", \r\n\t\t\t\"ü§™\", \"ü§®\", \"üßê\", \"ü§ì\", \"üòé\", \"ü§©\", \"ü•≥\", \"üòè\", \"üòí\", \"üòû\", \"üòî\", \"üòü\", \r\n\t\t\t\"üòï\", \"üôÅ\", \"‚òπÔ∏è\", \"üò£\", \"üòñ\", \"üò´\", \"üò©\", \"ü•∫\", \"üò¢\", \"üò≠\", \"üò§\", \"üò†\", \r\n\t\t\t\"üò°\", \"ü§¨\", \"ü§Ø\", \"üò≥\", \"ü•µ\", \"ü•∂\", \"üò±\", \"üò®\", \"üò∞\", \"üò•\", \"üòì\", \"ü§ó\", \r\n\t\t\t\"ü§î\", \"ü§≠\", \"ü§´\", \"ü§•\", \"üò∂\", \"üòê\", \"üòë\", \"üò¨\", \"üôÑ\", \"üòØ\", \"üò¶\", \"üòß\", \r\n\t\t\t\"üòÆ\", \"üò≤\", \"ü•±\", \"üò¥\", \"ü§§\", \"üò™\", \"üòµ\", \"ü§ê\", \"ü•¥\", \"ü§¢\", \"ü§Æ\", \"ü§ß\", \r\n\t\t\t\"üò∑\", \"ü§í\", \"ü§ï\"\r\n\t\t]\r\n\t},\r\n\t\"Gestos\": {\r\n\t\ticon: \"üëç\",\r\n\t\temojis: [\r\n\t\t\t\"üëç\", \"üëé\", \"üëå\", \"ü§å\", \"ü§è\", \"‚úåÔ∏è\", \"ü§û\", \"ü§ü\", \"ü§ò\", \"ü§ô\", \"üëà\", \"üëâ\", \r\n\t\t\t\"üëÜ\", \"üñï\", \"üëá\", \"‚òùÔ∏è\", \"üëè\", \"üôå\", \"üëê\", \"ü§≤\", \"ü§ù\", \"üôè\", \"‚úçÔ∏è\", \"üíÖ\", \r\n\t\t\t\"ü§≥\", \"üí™\", \"ü¶æ\", \"ü¶ø\", \"ü¶µ\", \"ü¶∂\", \"üëÇ\", \"ü¶ª\", \"üëÉ\", \"üß†\", \"ü´Ä\", \"ü´Å\", \r\n\t\t\t\"ü¶∑\", \"ü¶¥\", \"üëÄ\", \"üëÅÔ∏è\", \"üëÖ\", \"üëÑ\", \"üíã\"\r\n\t\t]\r\n\t},\r\n\t\"Objetos\": {\r\n\t\ticon: \"‚ù§Ô∏è\",\r\n\t\temojis: [\r\n\t\t\t\"‚ù§Ô∏è\", \"üß°\", \"üíõ\", \"üíö\", \"üíô\", \"üíú\", \"üñ§\", \"ü§ç\", \"ü§é\", \"üíî\", \"‚ù£Ô∏è\", \"üíï\", \r\n\t\t\t\"üíû\", \"üíì\", \"üíó\", \"üíñ\", \"üíò\", \"üíù\", \"üíü\", \"‚òÆÔ∏è\", \"‚úùÔ∏è\", \"‚ò™Ô∏è\", \"üïâÔ∏è\", \"‚ò∏Ô∏è\", \r\n\t\t\t\"‚ú°Ô∏è\", \"üîØ\", \"üïé\", \"‚òØÔ∏è\", \"‚ò¶Ô∏è\", \"üõê\", \"‚õé\", \"‚ôà\", \"‚ôâ\", \"‚ôä\", \"‚ôã\", \"‚ôå\", \"‚ôç\", \r\n\t\t\t\"‚ôé\", \"‚ôè\", \"‚ôê\", \"‚ôë\", \"‚ôí\", \"‚ôì\", \"üî•\", \"üíØ\", \"üí¢\", \"üí¶\", \"üí®\", \"üéâ\", \"üéä\", \r\n\t\t\t\"üéà\", \"üéÅ\", \"üèÜ\", \"ü•á\", \"ü•à\", \"ü•â\", \"‚≠ê\", \"üåü\", \"üí´\", \"‚ú®\"\r\n\t\t]\r\n\t},\r\n\t\"Animales\": {\r\n\t\ticon: \"üê∂\",\r\n\t\temojis: [\r\n\t\t\t\"üê∂\", \"üê±\", \"üê≠\", \"üêπ\", \"üê∞\", \"ü¶ä\", \"üêª\", \"üêº\", \"üêª‚Äç‚ùÑÔ∏è\", \"üê®\", \"üêØ\", \"ü¶Å\", \r\n\t\t\t\"üêÆ\", \"üê∑\", \"üêΩ\", \"üê∏\", \"üêµ\", \"üôà\", \"üôâ\", \"üôä\", \"üêí\", \"üêî\", \"üêß\", \"üê¶\", \r\n\t\t\t\"üê§\", \"üê£\", \"üê•\", \"ü¶Ü\", \"ü¶Ö\", \"ü¶â\", \"ü¶á\", \"üê∫\", \"üêó\", \"üê¥\", \"ü¶Ñ\", \"üêù\", \r\n\t\t\t\"üêõ\", \"ü¶ã\", \"üêå\", \"üêû\", \"üêú\", \"ü¶ü\", \"ü¶ó\", \"üï∑Ô∏è\", \"ü¶Ç\", \"üê¢\", \"üêç\", \"ü¶é\", \r\n\t\t\t\"ü¶ñ\", \"ü¶ï\", \"üêô\", \"ü¶ë\", \"ü¶ê\", \"ü¶û\", \"ü¶Ä\", \"üê°\", \"üê†\", \"üêü\", \"üê¨\", \"üê≥\", \r\n\t\t\t\"üêã\", \"ü¶à\", \"üêä\", \"üêÖ\", \"üêÜ\", \"ü¶ì\", \"ü¶ç\", \"ü¶ß\", \"üêò\", \"ü¶£\", \"ü¶è\", \"ü¶õ\", \r\n\t\t\t\"üê™\", \"üê´\", \"ü¶í\", \"ü¶ò\", \"üêÉ\", \"üêÇ\", \"üêÑ\", \"üêé\", \"üêñ\", \"üêè\", \"üêë\", \"ü¶ô\", \r\n\t\t\t\"üêê\", \"ü¶å\", \"üêï\", \"üê©\", \"ü¶Æ\", \"üêï‚Äçü¶∫\", \"üêà\", \"üêà‚Äç‚¨õ\", \"üêì\", \"ü¶É\", \"ü¶ö\", \"ü¶ú\", \r\n\t\t\t\"ü¶¢\", \"ü¶©\", \"üïäÔ∏è\", \"üêá\", \"ü¶ù\", \"ü¶®\", \"ü¶°\", \"ü¶¶\", \"ü¶•\", \"üêÅ\", \"üêÄ\", \"üêøÔ∏è\"\r\n\t\t]\r\n\t},\r\n\t\"Comida\": {\r\n\t\ticon: \"üçï\",\r\n\t\temojis: [\r\n\t\t\t\"üçé\", \"üçè\", \"üçê\", \"üçä\", \"üçã\", \"üçå\", \"üçâ\", \"üçá\", \"üçì\", \"ü´ê\", \"üçà\", \"üçí\", \r\n\t\t\t\"üçë\", \"ü•≠\", \"üçç\", \"ü••\", \"ü•ù\", \"üçÖ\", \"üçÜ\", \"ü•ë\", \"ü•¶\", \"ü•¨\", \"ü•í\", \"üå∂Ô∏è\", \r\n\t\t\t\"ü´ë\", \"üåΩ\", \"ü•ï\", \"ü´í\", \"üßÑ\", \"üßÖ\", \"ü•î\", \"üç†\", \"ü•ê\", \"ü•Ø\", \"üçû\", \"ü•ñ\", \r\n\t\t\t\"ü•®\", \"üßÄ\", \"ü•ö\", \"üç≥\", \"üßà\", \"ü•û\", \"üßá\", \"ü•ì\", \"ü•©\", \"üçó\", \"üçñ\", \"ü¶¥\", \r\n\t\t\t\"üå≠\", \"üçî\", \"üçü\", \"üçï\", \"ü´ì\", \"ü•™\", \"ü•ô\", \"üßÜ\", \"üåÆ\", \"üåØ\", \"ü´î\", \"ü•ó\", \r\n\t\t\t\"ü•ò\", \"ü´ï\", \"ü•´\", \"üçù\", \"üçú\", \"üç≤\", \"üçõ\", \"üç£\", \"üç±\", \"ü•ü\", \"ü¶™\", \"üç§\", \r\n\t\t\t\"üçô\", \"üçö\", \"üçò\", \"üç•\", \"ü•†\", \"ü•Æ\", \"üç¢\", \"üç°\", \"üçß\", \"üç®\", \"üç¶\", \"ü•ß\", \r\n\t\t\t\"üßÅ\", \"üç∞\", \"üéÇ\", \"üçÆ\", \"üç≠\", \"üç¨\", \"üç´\", \"üçø\", \"üç©\", \"üç™\", \"üå∞\", \"ü•ú\"\r\n\t\t]\r\n\t},\r\n\t\"Actividades\": {\r\n\t\ticon: \"‚öΩ\",\r\n\t\temojis: [\r\n\t\t\t\"‚öΩ\", \"üèÄ\", \"üèà\", \"‚öæ\", \"ü•é\", \"üéæ\", \"üèê\", \"üèâ\", \"ü•è\", \"üé±\", \"ü™Ä\", \"üèì\", \r\n\t\t\t\"üè∏\", \"üèë\", \"üèí\", \"ü•ç\", \"üèè\", \"ü™É\", \"ü•Ö\", \"‚õ≥\", \"ü™Å\", \"üèπ\", \"üé£\", \"ü§ø\", \r\n\t\t\t\"ü•ä\", \"ü•ã\", \"üéΩ\", \"üõπ\", \"üõ∑\", \"‚õ∏Ô∏è\", \"ü•å\", \"üéø\", \"‚õ∑Ô∏è\", \"üèÇ\", \"ü™Ç\", \"üèãÔ∏è\", \r\n\t\t\t\"ü§º\", \"ü§∏\", \"‚õπÔ∏è\", \"ü§∫\", \"üèåÔ∏è\", \"üèá\", \"üßò\", \"üèÑ\", \"üèä\", \"ü§Ω\", \"üö£\", \"üßó\", \r\n\t\t\t\"üöµ\", \"üö¥\", \"üèÜ\", \"ü•á\", \"ü•à\", \"ü•â\", \"üèÖ\", \"üéñÔ∏è\", \"üèµÔ∏è\", \"üéóÔ∏è\", \"üé´\", \"üéüÔ∏è\", \r\n\t\t\t\"üé™\", \"ü§π\", \"üé≠\", \"ü©∞\", \"üé®\", \"üé¨\", \"üé§\", \"üéß\", \"üéº\", \"üéµ\", \"üé∂\", \"üéπ\", \r\n\t\t\t\"ü•Å\", \"üé∑\", \"üé∫\", \"üé∏\", \"ü™ï\", \"üéª\", \"üé≤\", \"‚ô†Ô∏è\", \"‚ô•Ô∏è\", \"‚ô¶Ô∏è\", \"‚ô£Ô∏è\", \"‚ôüÔ∏è\", \r\n\t\t\t\"üÉè\", \"üÄÑ\", \"üé¥\", \"üéÆ\", \"üïπÔ∏è\", \"üéØ\"\r\n\t\t]\r\n\t},\r\n\t\"Viajes\": {\r\n\t\ticon: \"‚úàÔ∏è\",\r\n\t\temojis: [\r\n\t\t\t\"üöó\", \"üöï\", \"üöô\", \"üöå\", \"üöé\", \"üèéÔ∏è\", \"üöì\", \"üöë\", \"üöí\", \"üöê\", \"üõª\", \"üöö\", \r\n\t\t\t\"üöõ\", \"üöú\", \"üèçÔ∏è\", \"üõµ\", \"üö≤\", \"üõ¥\", \"üõπ\", \"üõº\", \"üöÅ\", \"üõ∏\", \"‚úàÔ∏è\", \"üõ©Ô∏è\", \r\n\t\t\t\"üõ´\", \"üõ¨\", \"ü™Ç\", \"‚õµ\", \"üö§\", \"üõ•Ô∏è\", \"üõ≥Ô∏è\", \"‚õ¥Ô∏è\", \"üö¢\", \"‚öì\", \"‚õΩ\", \"üöß\", \r\n\t\t\t\"üö¶\", \"üö•\", \"üöè\", \"üó∫Ô∏è\", \"üé°\", \"üé¢\", \"üé†\", \"‚õ≤\", \"‚õ±Ô∏è\", \"üèñÔ∏è\", \"üèùÔ∏è\", \"üèúÔ∏è\", \r\n\t\t\t\"üåã\", \"‚õ∞Ô∏è\", \"üèîÔ∏è\", \"üóª\", \"üèïÔ∏è\", \"‚õ∫\", \"üè†\", \"üè°\", \"üèòÔ∏è\", \"üèöÔ∏è\", \"üèóÔ∏è\", \"üè≠\", \r\n\t\t\t\"üè¢\", \"üè¨\", \"üè£\", \"üè§\", \"üè•\", \"üè¶\", \"üè®\", \"üè™\", \"üè´\", \"üè©\", \"üíí\", \"üèõÔ∏è\", \r\n\t\t\t\"‚õ™\", \"üïå\", \"üõï\", \"üïç\", \"üïã\", \"‚õ©Ô∏è\", \"üõ§Ô∏è\", \"üõ£Ô∏è\", \"üóæ\", \"üéë\", \"üèûÔ∏è\", \"üåÖ\", \r\n\t\t\t\"üåÑ\", \"üå†\", \"üéá\", \"üéÜ\", \"üåá\", \"üåÜ\", \"üèôÔ∏è\", \"üåÉ\", \"üåå\", \"üåâ\", \"üåÅ\"\r\n\t\t]\r\n\t}\r\n};\r\n\r\n// Lista de emojis frecuentes que se actualiza din√°micamente\r\nconst getFrequentEmojis = () => {\r\n\ttry {\r\n\t\tconst stored = localStorage.getItem('frequent-emojis');\r\n\t\tif (stored) {\r\n\t\t\tconst frequent = JSON.parse(stored);\r\n\t\t\treturn frequent.slice(0, 12); // Solo los 12 m√°s frecuentes\r\n\t\t}\r\n\t} catch (error) {\r\n\t\tconsole.error('Error loading frequent emojis:', error);\r\n\t}\r\n\treturn EMOJI_CATEGORIES[\"Frecuentes\"].emojis;\r\n};\r\n\r\n// Funci√≥n para guardar uso de emoji\r\nconst saveEmojiUsage = (emoji: string) => {\r\n\ttry {\r\n\t\tconst stored = localStorage.getItem('frequent-emojis');\r\n\t\tlet frequent: string[] = stored ? JSON.parse(stored) : [];\r\n\t\t\r\n\t\t// Remover si ya existe y agregarlo al principio\r\n\t\tfrequent = frequent.filter(e => e !== emoji);\r\n\t\tfrequent.unshift(emoji);\r\n\t\t\r\n\t\t// Mantener solo los 20 m√°s frecuentes\r\n\t\tfrequent = frequent.slice(0, 20);\r\n\t\t\r\n\t\tlocalStorage.setItem('frequent-emojis', JSON.stringify(frequent));\r\n\t} catch (error) {\r\n\t\tconsole.error('Error saving emoji usage:', error);\r\n\t}\r\n};\r\n\r\nconst MessageForm: React.FC<MessageFormProps> = ({\r\n\tonSendMessage,\r\n\tisDisabled = false,\r\n\tdisabledText = \"Esta conversaci√≥n est√° cerrada\",\r\n\tplaceholder = \"Escribe un mensaje...\",\r\n\tisLoading = false,\r\n\tchatId,\r\n}) => {\r\n\tconst [message, setMessage] = useState(\"\");\r\n\tconst [error, setError] = useState<string | null>(null);\r\n\tconst [showEmojiPicker, setShowEmojiPicker] = useState(false);\r\n\tconst [selectedCategory, setSelectedCategory] = useState(\"Frecuentes\");\r\n\tconst [emojiSearch, setEmojiSearch] = useState(\"\");\r\n\tconst [recentEmojis, setRecentEmojis] = useState<string[]>(() => getFrequentEmojis());\r\n\t\r\n\tconst textareaRef = useRef<HTMLTextAreaElement>(null);\r\n\tconst emojiPickerRef = useRef<HTMLDivElement>(null);\r\n\tconst emojiSearchRef = useRef<HTMLInputElement>(null);\r\n\tconst isMounted = useRef(true);\r\n\r\n\t// Hook para indicador de escritura\r\n\tconst { startTyping, stopTyping } = useTypingIndicator(chatId);\r\n\r\n\tuseEffect(() => {\r\n\t\treturn () => {\r\n\t\t\tisMounted.current = false;\r\n\t\t\t// Detener indicador de escritura al desmontar\r\n\t\t\tstopTyping();\r\n\t\t};\r\n\t}, [stopTyping]);\r\n\r\n\t// Actualizar emojis frecuentes cuando se abre el picker\r\n\tuseEffect(() => {\r\n\t\tif (showEmojiPicker) {\r\n\t\t\tsetRecentEmojis(getFrequentEmojis());\r\n\t\t}\r\n\t}, [showEmojiPicker]);\r\n\r\n\t// Al montar el componente, enfocar el textarea\r\n\tuseEffect(() => {\r\n\t\tif (textareaRef.current && !isDisabled) {\r\n\t\t\ttextareaRef.current.focus();\r\n\t\t}\r\n\t}, [isDisabled]);\r\n\r\n\t// Cerrar emoji picker cuando se hace clic fuera\r\n\tuseEffect(() => {\r\n\t\tconst handleClickOutside = (event: MouseEvent) => {\r\n\t\t\tif (emojiPickerRef.current && !emojiPickerRef.current.contains(event.target as Node)) {\r\n\t\t\t\tsetShowEmojiPicker(false);\r\n\t\t\t\tsetEmojiSearch(\"\");\r\n\t\t\t}\r\n\t\t};\r\n\r\n\t\tif (showEmojiPicker) {\r\n\t\t\tdocument.addEventListener(\"mousedown\", handleClickOutside);\r\n\t\t}\r\n\r\n\t\treturn () => {\r\n\t\t\tdocument.removeEventListener(\"mousedown\", handleClickOutside);\r\n\t\t};\r\n\t}, [showEmojiPicker]);\r\n\r\n\t// Focus en b√∫squeda cuando se abre el picker\r\n\tuseEffect(() => {\r\n\t\tif (showEmojiPicker && emojiSearchRef.current) {\r\n\t\t\tsetTimeout(() => {\r\n\t\t\t\temojiSearchRef.current?.focus();\r\n\t\t\t}, 100);\r\n\t\t}\r\n\t}, [showEmojiPicker]);\r\n\r\n\tconst handleSubmit = async (e: FormEvent) => {\r\n\t\te.preventDefault();\r\n\r\n\t\tsetError(null);\r\n\r\n\t\tif (isDisabled || isLoading || !message.trim()) {\r\n\t\t\tconsole.log(\"Env√≠o bloqueado:\", {\r\n\t\t\t\tisDisabled,\r\n\t\t\t\tisLoading,\r\n\t\t\t\tmessageEmpty: !message.trim(),\r\n\t\t\t});\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\tconst messageToSend = message.trim();\r\n\r\n\t\t// Detener indicador de escritura\r\n\t\tstopTyping();\r\n\r\n\t\t// ‚úÖ LIMPIAR INMEDIATAMENTE AL INTENTAR ENVIAR (M√ÅS DIRECTO)\r\n\t\tconsole.log(\"üßπ Limpiando form antes de enviar\");\r\n\t\tsetMessage(\"\");\r\n\t\t\r\n\t\t// Reset altura del textarea inmediatamente\r\n\t\tif (textareaRef.current) {\r\n\t\t\ttextareaRef.current.style.height = \"auto\";\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tconsole.log(\"Enviando mensaje:\", messageToSend);\r\n\t\t\tconst success = await onSendMessage(messageToSend);\r\n\r\n\t\t\tif (isMounted.current) {\r\n\t\t\t\tif (success) {\r\n\t\t\t\t\tconsole.log(\"‚úÖ Mensaje enviado correctamente\");\r\n\t\t\t\t\t// Ya est√° limpio desde arriba\r\n\t\t\t\t\tif (textareaRef.current) {\r\n\t\t\t\t\t\ttextareaRef.current.focus();\r\n\t\t\t\t\t}\r\n\t\t\t\t} else {\r\n\t\t\t\t\tconsole.error(\"‚ùå Error al enviar mensaje - restaurando contenido\");\r\n\t\t\t\t\t// Si falla, restaurar el mensaje\r\n\t\t\t\t\tsetMessage(messageToSend);\r\n\t\t\t\t\tsetError(\"No se pudo enviar el mensaje. Int√©ntalo de nuevo.\");\r\n\t\t\t\t}\r\n\t\t\t}\r\n\t\t} catch (error) {\r\n\t\t\tconsole.error(\"Error al enviar mensaje:\", error);\r\n\t\t\tif (isMounted.current) {\r\n\t\t\t\t// Si hay error, restaurar el mensaje\r\n\t\t\t\tsetMessage(messageToSend);\r\n\t\t\t\tsetError(\"Error al enviar mensaje. Por favor, int√©ntalo de nuevo.\");\r\n\t\t\t}\r\n\t\t}\r\n\t};\r\n\r\n\tconst handleKeyDown = (e: KeyboardEvent<HTMLTextAreaElement>) => {\r\n\t\tif (error) {\r\n\t\t\tsetError(null);\r\n\t\t}\r\n\r\n\t\t// Enviar con Ctrl+Enter o Cmd+Enter (Mac)\r\n\t\tif ((e.ctrlKey || e.metaKey) && e.key === \"Enter\") {\r\n\t\t\te.preventDefault();\r\n\t\t\thandleSubmit(e);\r\n\t\t}\r\n\t};\r\n\r\n\t// Ajustar altura autom√°ticamente y activar indicador de escritura - OPTIMIZADO\r\n\tconst autoAdjustHeight = (e: React.ChangeEvent<HTMLTextAreaElement>) => {\r\n\t\tconst textarea = e.target;\r\n\t\tconst newValue = textarea.value;\r\n\r\n\t\ttextarea.style.height = \"auto\";\r\n\r\n\t\tconst newHeight = Math.min(Math.max(textarea.scrollHeight, 40), 150);\r\n\t\ttextarea.style.height = `${newHeight}px`;\r\n\r\n\t\tsetMessage(newValue);\r\n\r\n\t\t// Manejar indicador de escritura - THROTTLED para evitar demasiadas peticiones\r\n\t\tif (newValue.trim() && !isDisabled && !isLoading) {\r\n\t\t\t// Solo si est√° escribiendo algo y cambi√≥ el contenido\r\n\t\t\tif (newValue !== message) {\r\n\t\t\t\tstartTyping();\r\n\t\t\t}\r\n\t\t} else if (!newValue.trim()) {\r\n\t\t\tstopTyping();\r\n\t\t}\r\n\t};\r\n\r\n\t// Insertar emoji en el mensaje - OPTIMIZADO\r\n\tconst insertEmoji = useCallback((emoji: string) => {\r\n\t\tconst textarea = textareaRef.current;\r\n\t\tif (!textarea) return;\r\n\r\n\t\tconst start = textarea.selectionStart;\r\n\t\tconst end = textarea.selectionEnd;\r\n\t\tconst newMessage = message.slice(0, start) + emoji + message.slice(end);\r\n\t\t\r\n\t\tsetMessage(newMessage);\r\n\t\t\r\n\t\t// Guardar uso del emoji\r\n\t\tsaveEmojiUsage(emoji);\r\n\t\t\r\n\t\t// Restaurar la posici√≥n del cursor despu√©s del emoji\r\n\t\tsetTimeout(() => {\r\n\t\t\tif (textarea) {\r\n\t\t\t\ttextarea.focus();\r\n\t\t\t\ttextarea.setSelectionRange(start + emoji.length, start + emoji.length);\r\n\t\t\t\t// Reajustar altura\r\n\t\t\t\ttextarea.style.height = \"auto\";\r\n\t\t\t\tconst newHeight = Math.min(Math.max(textarea.scrollHeight, 40), 150);\r\n\t\t\t\ttextarea.style.height = `${newHeight}px`;\r\n\t\t\t}\r\n\t\t}, 0);\r\n\t}, [message]);\r\n\r\n\t// Filtrar emojis por b√∫squeda - OPTIMIZADO\r\n\tconst getFilteredEmojis = useCallback((categoryEmojis: string[]) => {\r\n\t\tif (!emojiSearch.trim()) return categoryEmojis;\r\n\t\t\r\n\t\t// Buscar por el texto del emoji (muy b√°sico)\r\n\t\treturn categoryEmojis.filter(emoji => {\r\n\t\t\t// Aqu√≠ podr√≠as implementar una b√∫squeda m√°s sofisticada con nombres de emojis\r\n\t\t\treturn emoji.includes(emojiSearch.trim());\r\n\t\t});\r\n\t}, [emojiSearch]);\r\n\r\n\t// Obtener emojis de la categor√≠a actual - OPTIMIZADO\r\n\tconst getCurrentEmojis = useMemo(() => {\r\n\t\tif (selectedCategory === \"Frecuentes\") {\r\n\t\t\treturn getFilteredEmojis(recentEmojis);\r\n\t\t}\r\n\t\treturn getFilteredEmojis(EMOJI_CATEGORIES[selectedCategory as keyof typeof EMOJI_CATEGORIES].emojis);\r\n\t}, [selectedCategory, recentEmojis, getFilteredEmojis]);\r\n\r\n\t// Si el chat est√° deshabilitado, mostrar mensaje informativo\r\n\tif (isDisabled) {\r\n\t\treturn (\r\n\t\t\t<div className=\"p-4 border-t border-gray-200 bg-gray-50\">\r\n\t\t\t\t<div className=\"flex items-center justify-center space-x-2 text-gray-500\">\r\n\t\t\t\t\t<Clock size={16} />\r\n\t\t\t\t\t<p className=\"text-sm\">{disabledText}</p>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t);\r\n\t}\r\n\r\n\treturn (\r\n\t\t<div className=\"p-4 border-t border-gray-200 bg-white relative\">\r\n\t\t\t{error && (\r\n\t\t\t\t<div className=\"mb-3 p-3 bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg flex items-start space-x-2\">\r\n\t\t\t\t\t<div className=\"flex-shrink-0 mt-0.5\">\r\n\t\t\t\t\t\t‚ö†Ô∏è\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<div className=\"flex-1\">\r\n\t\t\t\t\t\t{error}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t\t<button \r\n\t\t\t\t\t\tonClick={() => setError(null)}\r\n\t\t\t\t\t\tclassName=\"flex-shrink-0 text-red-400 hover:text-red-600\"\r\n\t\t\t\t\t>\r\n\t\t\t\t\t\t√ó\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t)}\r\n\r\n\t\t\t{/* Emoji Picker Mejorado */}\r\n\t\t\t{showEmojiPicker && (\r\n\t\t\t\t<div \r\n\t\t\t\t\tref={emojiPickerRef}\r\n\t\t\t\t\tclassName=\"absolute bottom-full left-4 right-4 mb-2 bg-white border border-gray-300 rounded-xl shadow-xl z-50 overflow-hidden\"\r\n\t\t\t\t\tstyle={{ maxHeight: '320px' }}\r\n\t\t\t\t>\r\n\t\t\t\t\t{/* Header con b√∫squeda */}\r\n\t\t\t\t\t<div className=\"p-3 border-b border-gray-200 bg-gray-50\">\r\n\t\t\t\t\t\t<div className=\"relative\">\r\n\t\t\t\t\t\t\t<Search className=\"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400\" size={16} />\r\n\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\tref={emojiSearchRef}\r\n\t\t\t\t\t\t\t\ttype=\"text\"\r\n\t\t\t\t\t\t\t\tplaceholder=\"Buscar emojis...\"\r\n\t\t\t\t\t\t\t\tvalue={emojiSearch}\r\n\t\t\t\t\t\t\t\tonChange={(e) => setEmojiSearch(e.target.value)}\r\n\t\t\t\t\t\t\t\tclassName=\"w-full pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500\"\r\n\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t{/* Pesta√±as de categor√≠as */}\r\n\t\t\t\t\t<div className=\"border-b border-gray-200 bg-gray-50\">\r\n\t\t\t\t\t\t<div className=\"flex overflow-x-auto scrollbar-hide\">\r\n\t\t\t\t\t\t\t{Object.entries(EMOJI_CATEGORIES).map(([categoryName, categoryData]) => (\r\n\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\tkey={categoryName}\r\n\t\t\t\t\t\t\t\t\tonClick={() => {\r\n\t\t\t\t\t\t\t\t\t\tsetSelectedCategory(categoryName);\r\n\t\t\t\t\t\t\t\t\t\tsetEmojiSearch(\"\");\r\n\t\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t\t\tclassName={`flex-shrink-0 px-3 py-2 text-lg hover:bg-gray-100 transition-colors ${\r\n\t\t\t\t\t\t\t\t\t\tselectedCategory === categoryName\r\n\t\t\t\t\t\t\t\t\t\t\t? \"bg-primary-100 border-b-2 border-primary-500\"\r\n\t\t\t\t\t\t\t\t\t\t\t: \"\"\r\n\t\t\t\t\t\t\t\t\t}`}\r\n\t\t\t\t\t\t\t\t\ttitle={categoryName}\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t{categoryName === \"Frecuentes\" ? \"üïí\" : categoryData.icon}\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t{/* Grid de emojis con scroll personalizado */}\r\n\t\t\t\t\t<div className=\"p-2 max-h-48 overflow-y-auto emoji-scroll\">\r\n\t\t\t\t\t\t<div className=\"grid grid-cols-8 gap-1\">\r\n\t\t\t\t\t\t\t{getCurrentEmojis.map((emoji, index) => (\r\n\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\tkey={`${emoji}-${index}`}\r\n\t\t\t\t\t\t\t\t\tonClick={() => {\r\n\t\t\t\t\t\t\t\t\t\tinsertEmoji(emoji);\r\n\t\t\t\t\t\t\t\t\t\t// No cerrar el picker autom√°ticamente para permitir m√∫ltiples selecciones\r\n\t\t\t\t\t\t\t\t\t}}\r\n\t\t\t\t\t\t\t\t\tclassName=\"p-2 text-lg hover:bg-gray-100 rounded-lg transition-colors transform hover:scale-110 active:scale-95\"\r\n\t\t\t\t\t\t\t\t\ttitle={emoji}\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t{emoji}\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t))}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\r\n\t\t\t\t\t\t{getCurrentEmojis.length === 0 && (\r\n\t\t\t\t\t\t\t<div className=\"text-center py-8 text-gray-500\">\r\n\t\t\t\t\t\t\t\t<div className=\"text-2xl mb-2\">üîç</div>\r\n\t\t\t\t\t\t\t\t<p className=\"text-sm\">No se encontraron emojis</p>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t{/* Footer */}\r\n\t\t\t\t\t<div className=\"p-2 border-t border-gray-200 bg-gray-50 text-center\">\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tonClick={() => setShowEmojiPicker(false)}\r\n\t\t\t\t\t\t\tclassName=\"text-xs text-gray-500 hover:text-gray-700\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\tPresiona ESC para cerrar\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t)}\r\n\r\n\t\t\t<form onSubmit={handleSubmit} className=\"flex items-end space-x-3\">\r\n\t\t\t\t{/* Bot√≥n de emojis */}\r\n\t\t\t\t<button\r\n\t\t\t\t\ttype=\"button\"\r\n\t\t\t\t\tonClick={() => setShowEmojiPicker(!showEmojiPicker)}\r\n\t\t\t\t\tclassName={`flex-shrink-0 p-2 rounded-full transition-colors ${\r\n\t\t\t\t\t\tshowEmojiPicker \r\n\t\t\t\t\t\t\t? \"bg-primary-100 text-primary-600\" \r\n\t\t\t\t\t\t\t: \"text-gray-500 hover:text-gray-700 hover:bg-gray-100\"\r\n\t\t\t\t\t}`}\r\n\t\t\t\t\tdisabled={isLoading}\r\n\t\t\t\t\ttitle=\"Insertar emoji\"\r\n\t\t\t\t>\r\n\t\t\t\t\t<Smile size={20} />\r\n\t\t\t\t</button>\r\n\r\n\t\t\t\t{/* Campo de texto */}\r\n\t\t\t\t<div className=\"flex-1\">\r\n\t\t\t\t\t<textarea\r\n\t\t\t\t\t\tref={textareaRef}\r\n\t\t\t\t\t\tvalue={message}\r\n\t\t\t\t\t\tonChange={autoAdjustHeight}\r\n\t\t\t\t\t\tonKeyDown={handleKeyDown}\r\n\t\t\t\t\t\tplaceholder={placeholder}\r\n\t\t\t\t\t\tclassName=\"w-full border border-gray-300 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent\"\r\n\t\t\t\t\t\trows={1}\r\n\t\t\t\t\t\tstyle={{minHeight: \"44px\", maxHeight: \"150px\"}}\r\n\t\t\t\t\t\tdisabled={isLoading}\r\n\t\t\t\t\t/>\r\n\t\t\t\t\t<div className=\"flex items-center justify-between mt-1 px-1\">\r\n\t\t\t\t\t\t<p className=\"text-xs text-gray-500\">\r\n\t\t\t\t\t\t\t{isLoading ? \"Enviando...\" : \"Ctrl+Enter para enviar\"}\r\n\t\t\t\t\t\t</p>\r\n\t\t\t\t\t\t{message.length > 0 && (\r\n\t\t\t\t\t\t\t<p className=\"text-xs text-gray-400\">\r\n\t\t\t\t\t\t\t\t{message.length}/2000\r\n\t\t\t\t\t\t\t</p>\r\n\t\t\t\t\t\t)}\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\r\n\t\t\t\t{/* Bot√≥n de env√≠o */}\r\n\t\t\t\t<button\r\n\t\t\t\t\ttype=\"submit\"\r\n\t\t\t\t\tclassName={`flex-shrink-0 h-11 w-11 rounded-full flex items-center justify-center transition-all transform ${\r\n\t\t\t\t\t\tmessage.trim() && !isLoading\r\n\t\t\t\t\t\t\t? \"bg-primary-600 text-white hover:bg-primary-700 hover:scale-105 active:scale-95 shadow-lg\"\r\n\t\t\t\t\t\t\t: \"bg-gray-300 text-gray-600 cursor-not-allowed\"\r\n\t\t\t\t\t}`}\r\n\t\t\t\t\tdisabled={!message.trim() || isLoading}\r\n\t\t\t\t\ttitle={isLoading ? \"Enviando...\" : \"Enviar mensaje\"}\r\n\t\t\t\t>\r\n\t\t\t\t\t{isLoading ? (\r\n\t\t\t\t\t\t<Loader2 className=\"h-5 w-5 animate-spin\" />\r\n\t\t\t\t\t) : (\r\n\t\t\t\t\t\t<Send size={18} />\r\n\t\t\t\t\t)}\r\n\t\t\t\t</button>\r\n\t\t\t</form>\r\n\r\n\t\t\t{/* Atajos de teclado */}\r\n\t\t\t{showEmojiPicker && (\r\n\t\t\t\t<div \r\n\t\t\t\t\tclassName=\"fixed inset-0 z-40\" \r\n\t\t\t\t\tonClick={() => setShowEmojiPicker(false)}\r\n\t\t\t\t\tonKeyDown={(e) => {\r\n\t\t\t\t\t\tif (e.key === 'Escape') {\r\n\t\t\t\t\t\t\tsetShowEmojiPicker(false);\r\n\t\t\t\t\t\t}\r\n\t\t\t\t\t}}\r\n\t\t\t\t\ttabIndex={-1}\r\n\t\t\t\t/>\r\n\t\t\t)}\r\n\t\t</div>\r\n\t);\r\n};\r\n\r\nexport default MessageForm;"],"names":["GoogleAuthService","action","error","redirectUrl","resolve","response","result","timeout","notification","momentType","reject","existingScript","script","isProduction","forceRedirect","isLocalhost","credential","data","method","errors","warnings","testImg","config","storageService","LocalStorageService","AuthService","credentials","axiosInstance","API_ENDPOINTS","authData","appConfig","axios","axiosError","serverMessage","validationErrors","messages","minLength","requireUppercase","requireNumbers","requireSpecial","requirements","message","userData","cachedUser","email","token","password","passwordConfirmation","newToken","id","hash","LoginUseCase","authResponse","RegisterUseCase","UpdateProfileUseCase","profileData","updatedUser","GoogleLoginUseCase","GoogleRegisterUseCase","loginUseCase","registerUseCase","updateProfileUseCase","googleLoginUseCase","googleRegisterUseCase","CACHE_KEYS","useAuth","user","setUser","isAuthenticated","setIsAuthenticated","contextLogout","roleInfo","isLoadingRole","refreshRoleInfo","isInitialized","getDefaultRouteForRole","contextIsAdmin","contextIsSeller","useContext","AuthContext","loading","setLoading","useState","setError","login","useCallback","CacheService","err","errorMessage","register","loginWithGoogle","registerWithGoogle","logout","updateProfile","isAdmin","critical","isSeller","clearError","ECUADOR_TIMEZONE","ECUADOR_UTC_OFFSET","relativeTimeCache","CACHE_DURATION","MAX_CACHE_SIZE","cleanupRelativeTimeCache","now","keys","key","remaining","a","b","item","parseBackendDate","dateString","cleanDateString","date","isoString","formatRelativeTime","cacheKey","cached","diffInSeconds","formatAbsoluteDate","minutes","hours","days","includeTime","options","isToday","today","isYesterday","yesterday","formatDistanceLocale","formatDistance","count","tokenValue","dateFormats","timeFormats","dateTimeFormats","formatLong","buildFormatLongFn","formatRelativeLocale","formatRelativeLocalePlural","formatRelative","_baseDate","_options","eraValues","quarterValues","monthValues","dayValues","dayPeriodValues","formattingDayPeriodValues","ordinalNumber","dirtyNumber","localize","buildLocalizeFn","quarter","matchOrdinalNumberPattern","parseOrdinalNumberPattern","matchEraPatterns","parseEraPatterns","matchQuarterPatterns","parseQuarterPatterns","matchMonthPatterns","parseMonthPatterns","matchDayPatterns","parseDayPatterns","matchDayPeriodPatterns","parseDayPeriodPatterns","match","buildMatchPatternFn","value","buildMatchFn","index","es","ChatList","chats","selectedChatId","onSelectChat","searchTerm","onSearchChange","statusFilter","onStatusFilterChange","unreadFilter","onUnreadFilterChange","showTabs","activeTab","setActiveTab","chatCounts","useMemo","counts","chat","tabs","MessageSquare","Clock","Archive","filteredChats","matchesStatus","matchesUnread","matchesSearch","formatDate","formatDistanceToNow","getChatParticipant","jsx","User","Store","jsxs","tab","Icon","isActive","Search","e","Filter","participant","chatId","target","Package","Circle","t","getUserAvatarPlaceholder","name","initial","getMessageStatus","isFromCurrentUser","MessageStatusIcon","status","getIcon","Check","CheckCheck","AlertCircle","formatDateSeparator","formatMessageTime","groupMessagesByDate","groups","dateA","dateB","messageDate","dateKey","group","g","shouldGroupWithPrevious","currentMessage","previousMessage","currentTime","previousTime","ChatMessages","noMessagesText","currentUserId","messagesEndRef","useRef","messagesContainerRef","prevMessagesLength","setPrevMessagesLength","autoScroll","setAutoScroll","handleScroll","scrollTop","scrollHeight","clientHeight","isAtBottom","useEffect","messageGroups","groupIndex","messageStatus","nextMessage","shouldGroup","shouldGroupNext","getBubbleRadius","useRealTimeChat","participantId","pollInterval","enableTypingIndicator","onlineStatus","setOnlineStatus","isConnected","setIsConnected","pollIntervalRef","typingTimeoutRef","lastActivityRef","isPollingRef","handleOnline","handleOffline","fetchOnlineStatus","ApiClient","is_online","last_seen","is_typing","simulateOnlineStatus","isOnline","lastSeen","minutesAgo","isTyping","refreshOnlineStatus","sendTypingIndicator","baseRoute","updateLastActivity","handleVisibilityChange","events","event","handleBeforeUnload","useTypingIndicator","setIsTyping","startTyping","stopTyping","ChatHeader","onUpdateStatus","isMenuOpen","setIsMenuOpen","isUpdating","setIsUpdating","menuRef","productRoute","handleClickOutside","closeMenu","handleStatusChange","formatLastSeen","diffInMinutes","Wifi","WifiOff","Link","Fragment","ChevronRight","MoreVertical","RotateCcw","Eye","Box","EMOJI_CATEGORIES","getFrequentEmojis","stored","saveEmojiUsage","emoji","frequent","MessageForm","onSendMessage","isDisabled","disabledText","placeholder","isLoading","setMessage","showEmojiPicker","setShowEmojiPicker","selectedCategory","setSelectedCategory","emojiSearch","setEmojiSearch","recentEmojis","setRecentEmojis","textareaRef","emojiPickerRef","emojiSearchRef","isMounted","handleSubmit","messageToSend","success","handleKeyDown","autoAdjustHeight","textarea","newValue","newHeight","insertEmoji","start","end","newMessage","getFilteredEmojis","categoryEmojis","getCurrentEmojis","categoryName","categoryData","Smile","Loader2","Send"],"mappings":"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","x_google_ignoreList":[9,10,11,12,13,14]}