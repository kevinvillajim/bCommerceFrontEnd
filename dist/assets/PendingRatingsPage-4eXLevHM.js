import{r as m,j as e,X as O,L as F,q}from"./index-DmNDOrWy.js";import{S as G,R as A}from"./RatingService-DTWTD-sM.js";import{T as V}from"./triangle-alert-B75WTV0P.js";import{P as T}from"./package-CIRlwNqy.js";import{S as $}from"./store-BV-a-_hn.js";import{e as f}from"./errorHandler-ugMJT1nb.js";import{f as B}from"./formatDate-DOKfBcN0.js";import{S as L}from"./star-DFFyFcok.js";import{S as H}from"./search-CbEKe7UQ.js";import{S as Q}from"./shopping-bag-BMmsUIy8.js";class X{static adaptPendingRatings(i){if(!i||!i.data)return[];const{products:v,sellers:n}=i.data,r=new Map;return(v||[]).forEach(c=>{const d=c.order_id;r.has(d)||r.set(d,{orderId:d,orderNumber:c.order_number,orderDate:c.order_date,products:[],sellers:[]}),r.get(d)?.products.push(c)}),(n||[]).forEach(c=>{const d=c.order_id;r.has(d)||r.set(d,{orderId:d,orderNumber:c.order_number,orderDate:c.date,products:[],sellers:[]});const N={id:c.id||c.seller_id,name:c.name||`Vendedor #${c.seller_id}`,order_id:c.order_id,order_number:c.order_number,order_date:c.date,image:c.image};r.get(d)?.sellers.push(N)}),Array.from(r.values()).sort((c,d)=>new Date(d.orderDate).getTime()-new Date(c.orderDate).getTime())}}const J=({type:p,entityId:i,entityName:v,entityImage:n,orderId:r,isOpen:c,onClose:d,onSubmit:N,onReport:h})=>{const[b,w]=m.useState(0),[y,S]=m.useState(""),[R,a]=m.useState(""),[s,l]=m.useState(!1),[o,g]=m.useState(!1),[E,P]=m.useState(""),[C,M]=m.useState(""),[j,k]=m.useState(!1);if(!c)return null;const t=()=>{w(0),S(""),a(""),g(!1),P(""),M(""),k(!1)},u=()=>{t(),d()},_=async()=>{if(b===0){alert("Por favor selecciona una calificación de 1 a 5 estrellas");return}if(b<=2&&!j){k(!0);return}try{l(!0),await N({rating:b,title:y.trim()||void 0,comment:R.trim()||void 0,entityId:i,orderId:r}),t(),d()}catch(x){console.error("Error al enviar valoración:",x)}finally{l(!1)}},z=async()=>{if(h){if(!E){alert("Por favor selecciona el tipo de problema");return}if(!C.trim()){alert("Por favor describe el problema");return}try{l(!0),await h({type:p,entityId:i,orderId:r,problemType:E,description:C}),t(),d()}catch(x){console.error("Error al enviar reporte:",x)}finally{l(!1)}}},I=()=>{g(!o),k(!1)};return console.log("Estado actual de rating:",b),e.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 transition-opacity",onClick:u}),e.jsx("div",{className:"flex min-h-screen items-center justify-center p-4",children:e.jsxs("div",{className:"relative bg-white rounded-lg shadow-xl w-full max-w-md mx-auto",children:[e.jsx("button",{onClick:u,className:"absolute top-3 right-3 text-gray-400 hover:text-gray-500",disabled:s,children:e.jsx(O,{size:24})}),e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:o?e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"mr-2 text-orange-500",size:20}),"Reportar problema"]}):e.jsxs(e.Fragment,{children:[p==="product"?e.jsx(T,{className:"mr-2 text-blue-500",size:20}):e.jsx($,{className:"mr-2 text-green-500",size:20}),"Valorar ",p==="product"?"producto":"vendedor"]})})}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[n?e.jsx("img",{src:n,alt:v,className:"w-16 h-16 object-cover rounded-md mr-4",onError:x=>{const D=x.target;D.onerror=null,D.src="https://via.placeholder.com/64?text=Imagen"}}):e.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-md flex items-center justify-center mr-4",children:p==="product"?e.jsx(T,{size:24,className:"text-gray-400"}):e.jsx($,{size:24,className:"text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900",children:v}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Pedido: #",r]})]})]}),!o&&!j&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tu valoración"}),e.jsx(G,{value:b,onChange:x=>{console.log("Valor de StarRating seleccionado:",x),w(x)},size:"large",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"rating-title",className:"block text-sm font-medium text-gray-700 mb-1",children:"Título (opcional)"}),e.jsx("input",{id:"rating-title",type:"text",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500",placeholder:"Resume tu experiencia",value:y,onChange:x=>S(x.target.value),maxLength:100})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"rating-comment",className:"block text-sm font-medium text-gray-700 mb-1",children:"Comentario (opcional)"}),e.jsx("textarea",{id:"rating-comment",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500",placeholder:"Comparte tu experiencia con este producto",value:R,onChange:x=>a(x.target.value),maxLength:500,rows:4})]})]}),o&&!j&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"problem-type",className:"block text-sm font-medium text-gray-700 mb-1",children:"Tipo de problema"}),e.jsxs("select",{id:"problem-type",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white",value:E,onChange:x=>P(x.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecciona el tipo de problema"}),p==="product"?e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"not_received",children:"Producto no recibido"}),e.jsx("option",{value:"damaged",children:"Producto dañado/defectuoso"}),e.jsx("option",{value:"different",children:"Producto diferente al descrito"}),e.jsx("option",{value:"incomplete",children:"Producto incompleto"})]}):e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"communication",children:"Problemas de comunicación"}),e.jsx("option",{value:"shipping",children:"Problemas de envío"}),e.jsx("option",{value:"customer_service",children:"Mala atención al cliente"})]}),e.jsx("option",{value:"other",children:"Otro problema"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"problem-description",className:"block text-sm font-medium text-gray-700 mb-1",children:"Descripción del problema"}),e.jsx("textarea",{id:"problem-description",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500",placeholder:"Describe el problema en detalle",value:C,onChange:x=>M(x.target.value),rows:4,required:!0})]})]}),j&&e.jsx("div",{className:"bg-yellow-50 p-4 rounded-md",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(V,{className:"text-yellow-600 mt-0.5 mr-3",size:20}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-yellow-800",children:"¿Estás seguro de enviar una valoración baja?"}),e.jsxs("p",{className:"text-sm text-yellow-700 mt-1",children:["Has calificado este"," ",p==="product"?"producto":"vendedor"," con"," ",b," ",b===1?"estrella":"estrellas",". ¿Quieres continuar o prefieres reportar un problema específico?"]})]})]})})]}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 flex justify-between",children:[e.jsx("div",{children:!j&&e.jsx("button",{type:"button",onClick:I,className:"text-sm text-gray-600 hover:text-gray-800 flex items-center",disabled:s,children:o?e.jsx(e.Fragment,{children:"Volver a valoración"}):e.jsxs(e.Fragment,{children:[e.jsx(V,{size:14,className:"mr-1"}),"Reportar problema"]})})}),e.jsxs("div",{className:"space-x-3",children:[e.jsx("button",{type:"button",onClick:u,className:"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300",disabled:s,children:"Cancelar"}),j?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:()=>k(!1),className:"px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500",disabled:s,children:"Modificar valoración"}),e.jsx("button",{type:"button",onClick:_,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:s,children:s?"Enviando...":"Enviar valoración"})]}):e.jsx("button",{type:"button",onClick:o?z:_,className:`px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 ${o?"bg-orange-600 hover:bg-orange-700 focus:ring-orange-500":"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}`,disabled:s||o&&(!E||!C.trim())||!o&&b===0,children:s?"Enviando...":o?"Enviar reporte":"Enviar valoración"})]})]})]})})]})},K=()=>{const[p,i]=m.useState(!1),[v,n]=m.useState(null),r=new A,c=m.useCallback(async()=>{i(!0),n(null);try{console.log("Solicitando valoraciones pendientes...");const a=await r.getPendingRatings();return console.log("Respuesta de valoraciones pendientes:",a),a}catch(a){console.error("Error al obtener valoraciones pendientes:",a);const s=f(a,"Error al obtener valoraciones pendientes");return n(s),{status:"error",message:s,data:{products:[],sellers:[]}}}finally{i(!1)}},[r]),d=m.useCallback(async a=>{i(!0),n(null);try{console.log("Enviando valoración de producto:",a);const s=await r.rateProduct(a);return console.log("Respuesta al valorar producto:",s),s}catch(s){console.error("Error al valorar producto:",s);const l=f(s,"Error al valorar producto");throw n(l),new Error(l)}finally{i(!1)}},[r]),N=m.useCallback(async a=>{i(!0),n(null);try{console.log("Enviando valoración de vendedor:",a);const s=await r.rateSeller(a);return console.log("Respuesta al valorar vendedor:",s),s}catch(s){console.error("Error al valorar vendedor:",s);const l=f(s,"Error al valorar vendedor");throw n(l),new Error(l)}finally{i(!1)}},[r]),h=m.useCallback(async a=>{i(!0),n(null);try{console.log("Enviando reporte de problema:",a);const s=await r.reportProblem(a);return console.log("Respuesta al reportar problema:",s),s}catch(s){console.error("Error al reportar problema:",s);const l=f(s,"Error al reportar problema");throw n(l),new Error(l)}finally{i(!1)}},[r]),b=m.useCallback(async(a,s)=>{i(!0),n(null);try{console.log("Enviando respuesta a valoración:",{ratingId:a,replyText:s});const l={rating_id:a,reply_text:s},o=await r.replyToRating(l);return console.log("Respuesta al responder valoración:",o),o}catch(l){console.error("Error al responder valoración:",l);const o=f(l,"Error al responder valoración");throw n(o),new Error(o)}finally{i(!1)}},[r]),w=m.useCallback(async(a,s)=>{i(!0),n(null);try{console.log("Enviando reporte de valoración:",{ratingId:a,reason:s});const l={rating_id:a,reason:s},o=await r.reportRating(l);return console.log("Respuesta al reportar valoración:",o),o}catch(l){console.error("Error al reportar valoración:",l);const o=f(l,"Error al reportar valoración");throw n(o),new Error(o)}finally{i(!1)}},[r]),y=m.useCallback(async(a,s=1,l=10)=>{i(!0),n(null);try{console.log(`Obteniendo valoraciones del producto ${a}...`);const o=await r.getProductRatings(a,s,l);return console.log(`Valoraciones del producto ${a}:`,o),o}catch(o){console.error(`Error al obtener valoraciones del producto ${a}:`,o);const g=f(o,"Error al obtener valoraciones del producto");throw n(g),new Error(g)}finally{i(!1)}},[r]),S=m.useCallback(async(a,s=1,l=10)=>{i(!0),n(null);try{console.log(`Obteniendo valoraciones del vendedor ${a}...`);const o=await r.getSellerRatings(a,s,l);return console.log(`Valoraciones del vendedor ${a}:`,o),o}catch(o){console.error(`Error al obtener valoraciones del vendedor ${a}:`,o);const g=f(o,"Error al obtener valoraciones del vendedor");throw n(g),new Error(g)}finally{i(!1)}},[r]),R=m.useCallback(async(a=1,s=10,l)=>{i(!0),n(null);try{console.log("Obteniendo mis valoraciones recibidas...");const o=await r.getMyReceivedRatings(a,s,l);return console.log("Mis valoraciones recibidas:",o),o}catch(o){console.error("Error al obtener mis valoraciones recibidas:",o);const g=f(o,"Error al obtener mis valoraciones recibidas");throw n(g),new Error(g)}finally{i(!1)}},[r]);return{loading:p,error:v,getPendingRatings:c,rateProduct:d,rateSeller:N,reportProblem:h,replyToRating:b,reportRating:w,getProductRatings:y,getSellerRatings:S,getMyReceivedRatings:R}},U=({orderGroups:p,onRateProduct:i,onRateSeller:v})=>e.jsx("div",{className:"space-y-6",children:p.map(n=>e.jsxs("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-center",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900",children:["Pedido #",n.orderNumber]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Fecha: ",B(n.orderDate)]})]}),e.jsxs(F,{to:`/orders/${n.orderId}`,className:"text-primary-600 hover:text-primary-800 flex items-center mt-2 md:mt-0",children:[e.jsx(q,{className:"w-4 h-4 mr-1"}),"Ver detalles del pedido"]})]})}),n.products.length>0&&e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("h4",{className:"text-md font-medium text-gray-900 mb-3 flex items-center",children:[e.jsx(T,{className:"w-5 h-5 mr-2 text-primary-600"}),"Productos"]}),e.jsx("div",{className:"space-y-4",children:n.products.map(r=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center p-3 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center flex-grow mb-3 sm:mb-0",children:[r.image?e.jsx("img",{src:r.image,alt:r.name,className:"w-16 h-16 object-cover rounded-md mr-4",onError:c=>{const d=c.target;d.onerror=null,d.src="https://via.placeholder.com/64?text=Producto"}}):e.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-md flex items-center justify-center mr-4",children:e.jsx(T,{className:"h-8 w-8 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium text-gray-900",children:r.name}),e.jsx(F,{to:`/products/${r.id}`,className:"text-sm text-primary-600 hover:text-primary-800",children:"Ver producto"})]})]}),e.jsx("div",{children:e.jsxs("button",{onClick:()=>i(r),className:"w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 flex items-center justify-center",children:[e.jsx(L,{className:"h-4 w-4 mr-2"}),"Valorar producto"]})})]},`product-${r.id}-order-${n.orderId}`))})]}),n.sellers.length>0&&e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200",children:[e.jsxs("h4",{className:"text-md font-medium text-gray-900 mb-3 flex items-center",children:[e.jsx($,{className:"w-5 h-5 mr-2 text-green-600"}),"Vendedores"]}),e.jsx("div",{className:"space-y-4",children:n.sellers.map(r=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center p-3 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center flex-grow mb-3 sm:mb-0",children:[r.image?e.jsx("img",{src:r.image,alt:r.name,className:"w-16 h-16 object-cover rounded-md mr-4",onError:c=>{const d=c.target;d.onerror=null,d.src="https://via.placeholder.com/64?text=Tienda"}}):e.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-md flex items-center justify-center mr-4",children:e.jsx($,{className:"h-8 w-8 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium text-gray-900",children:r.name||`Vendedor #${r.seller_id||r.id}`}),e.jsx("span",{className:"text-sm text-gray-500",children:"Tienda"})]})]}),e.jsx("div",{children:e.jsxs("button",{onClick:()=>v(r),className:"w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center",children:[e.jsx(L,{className:"h-4 w-4 mr-2"}),"Valorar vendedor"]})})]},`seller-${r.id||r.seller_id}-order-${n.orderId}`))})]})]},`order-${n.orderId}`))}),le=()=>{const[p,i]=m.useState(""),[v,n]=m.useState(!1),[r,c]=m.useState(!1),[d,N]=m.useState("product"),[h,b]=m.useState(null),{loading:w,error:y,getPendingRatings:S,rateProduct:R,rateSeller:a,reportProblem:s}=K(),[l,o]=m.useState([]);m.useEffect(()=>{g()},[]);const g=async()=>{try{const t=await S();if(t.status!=="success")throw new Error("Error al obtener las valoraciones pendientes");const u=X.adaptPendingRatings(t);o(u)}catch(t){console.error("Error al cargar valoraciones pendientes:",t)}},E=(t,u)=>{N(t),b(u),c(!0)},P=()=>{c(!1),b(null)},C=async t=>{try{d==="product"?await R({product_id:t.entityId,order_id:t.orderId,rating:t.rating,title:t.title,comment:t.comment}):await a({seller_id:t.entityId,order_id:t.orderId,rating:t.rating,title:t.title,comment:t.comment}),await g(),alert("Valoración enviada con éxito"),P()}catch(u){console.error("Error al enviar valoración:",u),alert(f(u,"Error al enviar la valoración"))}},M=async t=>{try{await s({type:t.type,entity_id:t.entityId,order_id:t.orderId,problem_type:t.problemType,description:t.description}),await g(),alert("Problema reportado con éxito"),P()}catch(u){console.error("Error al reportar problema:",u),alert(f(u,"Error al reportar el problema"))}},j=l.filter(t=>{if(p==="")return!0;const u=p.toLowerCase();return!!(t.orderNumber.toLowerCase().includes(u)||t.products.some(_=>_.name.toLowerCase().includes(u))||t.sellers.some(_=>(_.name||"").toLowerCase().includes(u)))}),k=l.some(t=>t.products.length>0||t.sellers.length>0);return e.jsxs("div",{className:"container mx-auto p-4",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Valoraciones pendientes"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"relative flex-grow",children:[e.jsx("input",{type:"text",placeholder:"Buscar por pedido o producto...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500",value:p,onChange:t=>i(t.target.value)}),e.jsx(H,{className:"absolute left-3 top-2.5 h-5 w-5 text-gray-400"})]}),e.jsx("div",{className:"flex items-center",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 text-primary-600",checked:v,onChange:t=>n(t.target.checked)}),e.jsx("span",{className:"ml-2 text-gray-700",children:"Mostrar también valorados"})]})})]}),w&&e.jsx("div",{className:"flex justify-center my-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600"})}),y&&e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6",children:[e.jsx("strong",{className:"font-bold",children:"Error: "}),e.jsx("span",{className:"block sm:inline",children:y})]}),!w&&!y&&!k&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-8 text-center",children:[e.jsx(Q,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No tienes valoraciones pendientes"}),e.jsx("p",{className:"text-gray-600 max-w-md mx-auto",children:"Todas tus compras recientes han sido valoradas. ¡Gracias por compartir tu opinión!"}),e.jsx(F,{to:"/orders",className:"mt-4 inline-block px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700",children:"Ver mis pedidos"})]}),!w&&!y&&j.length>0&&e.jsx(U,{orderGroups:j,onRateProduct:t=>E("product",t),onRateSeller:t=>E("seller",t)}),h&&e.jsx(J,{type:d,entityId:h.id??h.seller_id??0,entityName:h.name||`Vendedor #${h.seller_id||h.id}`,entityImage:h.image,orderId:h.order_id,isOpen:r,onClose:P,onSubmit:C,onReport:M})]})};export{le as default};
//# sourceMappingURL=PendingRatingsPage-4eXLevHM.js.map
