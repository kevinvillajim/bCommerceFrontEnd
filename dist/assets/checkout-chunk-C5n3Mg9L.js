import{j as e,D as Te,ag as Re,G as ge,r as De,c as we,J as Oe,ah as Pe,ai as ke,aj as $e,ak as Le,R as ie,al as Ue,am as de,T as Fe,Z as _e}from"./ui-vendor-BUNMIuFe.js";import{r as g,R as te,u as be}from"./react-vendor-Cy458wKG.js";import{A as Ve,L as Me}from"./seller-chunk-6swISJwY.js";import{c as J,A as X,C as ce,b as ue,g as Ie,h as ne,f as G}from"./admin-chunk-BNcFjXlJ.js";import{u as Ee}from"./chat-chunk-BRsdDZXf.js";class qe{async getCart(){try{console.log("CartService: Obteniendo carrito del usuario");const t=await J.get(X.CART.GET);return console.log("CartService: Respuesta del carrito:",t),t}catch(t){return console.error("CartService: Error al obtener carrito:",t),{status:"error",message:t instanceof Error?t.message:"Error al obtener carrito",data:{id:0,total:0,items:[],item_count:0}}}}async addToCart(t){try{console.log("CartService: Añadiendo producto al carrito:",t);const o={product_id:t.productId,quantity:t.quantity,attributes:t.attributes},s=await J.post(X.CART.ADD_ITEM,o);return console.log("CartService: Producto añadido al carrito:",s),s}catch(o){throw console.error("CartService: Error al añadir al carrito:",o),o}}async removeFromCart(t){try{console.log(`CartService: Eliminando producto ${t} del carrito`);const o=await J.delete(X.CART.REMOVE_ITEM(t));return console.log(`CartService: Producto ${t} eliminado del carrito:`,o),o}catch(o){throw console.error(`CartService: Error al eliminar producto ${t} del carrito:`,o),o}}async updateCartItem(t,o){try{console.log(`CartService: Actualizando cantidad de producto ${t} a ${o}`);const s=await J.put(X.CART.UPDATE_ITEM(t),{quantity:o});return console.log(`CartService: Cantidad actualizada para producto ${t}:`,s),s}catch(s){throw console.error(`CartService: Error al actualizar cantidad de producto ${t}:`,s),s}}async clearCart(){try{console.log("CartService: Vaciando carrito");const t=await J.post(X.CART.EMPTY);return console.log("CartService: Carrito vaciado:",t),t}catch(t){throw console.error("CartService: Error al vaciar carrito:",t),t}}async validateDiscountCode(t){try{console.log("CartService: Validando código de descuento:",t);const o=await J.post(X.CART.DISCOUNT.VALIDATE,{code:t});return console.log("CartService: Código de descuento validado:",o),o}catch(o){throw console.error("CartService: Error al validar código de descuento:",o),o}}async applyDiscountCode(t){try{console.log("CartService: Aplicando código de descuento:",t);const o=await J.post(X.CART.DISCOUNT.APPLY,{code:t});return console.log("CartService: Código de descuento aplicado:",o),o}catch(o){throw console.error("CartService: Error al aplicar código de descuento:",o),o}}async removeDiscountCode(){try{console.log("CartService: Removiendo código de descuento");const t=await J.post(X.CART.DISCOUNT.REMOVE);return console.log("CartService: Código de descuento removido:",t),t}catch(t){throw console.error("CartService: Error al remover código de descuento:",t),t}}}var A=(y=>(y.SUCCESS="success",y.ERROR="error",y.INFO="info",y.WARNING="warning",y))(A||{});const je=g.createContext({cart:null,loading:!1,error:null,addToCart:async()=>!1,removeFromCart:async()=>!1,updateCartItem:async()=>!1,clearCart:async()=>!1,fetchCart:async()=>{},itemCount:0,totalAmount:0,notification:null,showNotification:()=>{},hideNotification:()=>{},cartItemCount:0,appliedDiscount:null,validateDiscountCode:async()=>({success:!1,message:"Not implemented"}),applyDiscountCode:async()=>({success:!1,message:"Not implemented"}),removeDiscountCode:async()=>({success:!1,message:"Not implemented"})}),me=new Me,ae=new qe,pe={CART_USER:"cart_user_data",CART_GUEST:"cart_guest_data"},Be={CART:3*60*1e3},lt=({children:y})=>{const[t,o]=g.useState(null),[s,a]=g.useState(!1),[r,c]=g.useState(null),[p,b]=g.useState(0),[f,i]=g.useState(0),[m,x]=g.useState(null),[_,S]=g.useState(null),{isAuthenticated:w}=g.useContext(Ve),V=g.useRef(!1),$=g.useRef(""),B=g.useRef(w),L=g.useRef(null),D=g.useRef(null),F=g.useRef(!1),H=g.useRef(null);g.useEffect(()=>{B.current=w},[w]);const Z=g.useCallback((u,l)=>{L.current&&clearTimeout(L.current),x({id:Date.now().toString(),type:u,message:l}),L.current=setTimeout(()=>{x(null),L.current=null},3e3)},[]),z=g.useCallback(()=>{L.current&&(clearTimeout(L.current),L.current=null),x(null)},[]);g.useEffect(()=>()=>{L.current&&clearTimeout(L.current),D.current&&clearTimeout(D.current),H.current&&clearTimeout(H.current)},[]);const M=g.useCallback(()=>{ce.removeItem(pe.CART_USER),ce.removeItem(pe.CART_GUEST),ce.removeItem("header_counters"),console.log("🗑️ Cart cache invalidated")},[]),K=g.useCallback(u=>!u||u.length===0?0:u.reduce((l,O)=>l+O.quantity,0),[]),se=g.useCallback(async()=>{if(F.current)return null;F.current=!0;try{a(!0),c(null);const u=B.current?pe.CART_USER:pe.CART_GUEST,l=ce.getItem(u);if(l)return console.log("📦 Using cached cart data"),o(l),b(l.items?l.items.length:0),i(l.total||0),$.current=JSON.stringify(l),a(!1),F.current=!1,l;console.log("🌐 Fetching cart from API...");const O=await ae.getCart();if(O&&O.status==="success"&&O.data){const n={id:O.data.id,total:O.data.total,items:O.data.items.map(P=>{const v=P.product||{};return{id:P.id,productId:v.id||0,quantity:P.quantity,price:P.price,subtotal:P.subtotal,attributes:P.attributes,final_price:P.final_price||P.price,original_price:P.original_price||P.price,volume_discount_percentage:P.volume_discount_percentage||0,volume_savings:P.volume_savings||0,discount_label:P.discount_label||void 0,product:{id:v.id||0,name:v.name||"Producto sin nombre",slug:v.slug,price:v.price||0,final_price:v.final_price??v.price??0,discount_percentage:v.discount_percentage??0,rating:v.rating??0,rating_count:v.rating_count??0,image:v.main_image||v.image||(v.images&&v.images.length>0?typeof v.images[0]=="string"?v.images[0]:v.images[0].original||v.images[0].medium||v.images[0].thumbnail:void 0),main_image:v.main_image||v.image||(v.images&&v.images.length>0?typeof v.images[0]=="string"?v.images[0]:v.images[0].original||v.images[0].medium||v.images[0].thumbnail:void 0),stockAvailable:v.stock||0,sellerId:v.sellerId||v.seller_id||(v.seller?v.seller.id:void 0)||v.user_id,seller_id:v.seller_id||v.sellerId||(v.seller?v.seller.id:void 0)||v.user_id,seller:v.seller,user_id:v.user_id,stock:v.stock||0,is_in_stock:v.is_in_stock??!0}}}),item_count:O.data.item_count||0,subtotal:O.data.subtotal||O.data.total,total_volume_savings:O.data.total_volume_savings||0,volume_discounts_applied:O.data.volume_discounts_applied||!1};ce.setItem(u,n,Be.CART);const E=K(n.items),R=O.data.item_count||E;return o(n),b(R),i(n.total),$.current=JSON.stringify(n),console.log("✅ Cart loaded successfully:",{itemCount:R,total:n.total,items:n.items.length,volume_discounts_applied:n.volume_discounts_applied}),n}throw new Error("Formato de respuesta de carrito inválido")}catch(u){console.error("Error al obtener carrito desde la API:",u),c(u instanceof Error?u.message:"Error al obtener carrito");const l=me.getItem(ue.storage.cartKey);if(l)try{const O=typeof l=="string"?JSON.parse(l):l;o(O),$.current=JSON.stringify(O);const n=K(O.items||[]);b(n),i(O.total||0)}catch(O){console.error("Error al usar caché local del carrito:",O)}return null}finally{a(!1),F.current=!1}},[K]),W=g.useCallback(async()=>{D.current&&clearTimeout(D.current),D.current=setTimeout(async()=>{if(B.current)await se();else{const u=me.getItem(ue.storage.cartKey);if(u)try{const l=typeof u=="string"?JSON.parse(u):u;o(l),$.current=JSON.stringify(l);const O=K(l.items||[]);b(O),i(l.total||0)}catch(l){console.error("Error al parsear carrito del localStorage:",l)}else o({id:0,items:[],total:0}),b(0),i(0)}D.current=null},100)},[se,K]);g.useEffect(()=>{V.current=!0},[w]),g.useEffect(()=>{if(!t){b(0),i(0);return}H.current&&clearTimeout(H.current),H.current=setTimeout(()=>{const u=t.items?t.items.length:0;p!==u&&b(u),f!==t.total&&i(t.total);const l=JSON.stringify(t);!B.current&&l!==$.current&&(me.setItem(ue.storage.cartKey,l),$.current=l),H.current=null},100)},[t,K,p,f]);const oe=g.useCallback(async u=>{try{if(!t)return!1;const l=t.items.findIndex(n=>n.productId===u.productId);let O;if(l>=0){const n=[...t.items];n[l].quantity+=u.quantity,n[l].subtotal=n[l].price*n[l].quantity;const E=n.reduce((R,P)=>R+P.subtotal,0);O={...t,items:n,total:E}}else{const E={id:Date.now(),productId:u.productId,quantity:u.quantity,price:0,subtotal:0*u.quantity},R=[...t.items,E],P=R.reduce((v,q)=>v+q.subtotal,0);O={...t,items:R,total:P}}return o(O),$.current=JSON.stringify(O),!0}catch(l){return console.error("Error al añadir producto al carrito:",l),!1}},[t]),N=g.useCallback(async u=>{if(!B.current){const l=await oe(u);return await W(),l}try{a(!0);const l=await ae.addToCart(u);if(l&&l.status==="success")return M(),await W(),!0;throw new Error(l?.message||"No se pudo agregar al carrito")}catch(l){return console.error("Error al agregar producto al carrito:",l),c(l instanceof Error?l.message:"Error al agregar producto al carrito"),!1}finally{a(!1)}},[oe,W,M]),C=g.useCallback(async u=>{try{if(!t)return!1;const l=t.items.filter(E=>E.id!==u),O=l.reduce((E,R)=>E+R.subtotal,0),n={...t,items:l,total:O};return o(n),$.current=JSON.stringify(n),!0}catch(l){return console.error("Error al eliminar producto del carrito:",l),!1}},[t]),h=g.useCallback(async u=>{if(!B.current){const l=await C(u);return await W(),l}try{a(!0);const l=await ae.removeFromCart(u);if(l&&l.status==="success")return M(),await W(),!0;throw new Error(l?.message||"No se pudo eliminar del carrito")}catch(l){return console.error("Error al eliminar producto del carrito:",l),c(l instanceof Error?l.message:"Error al eliminar producto del carrito"),!1}finally{a(!1)}},[C,W,M]),T=g.useCallback(async u=>{try{if(!t)return!1;const l=t.items.map(E=>E.id===u.itemId?{...E,quantity:u.quantity,subtotal:E.price*u.quantity}:E),O=l.reduce((E,R)=>E+R.subtotal,0),n={...t,items:l,total:O};return o(n),$.current=JSON.stringify(n),!0}catch(l){return console.error("Error al actualizar producto del carrito:",l),!1}},[t]),j=g.useCallback(async u=>{if(!B.current){const l=await T(u);return await W(),l}try{a(!0);const l=await ae.updateCartItem(u.itemId,u.quantity);if(l&&l.status==="success")return M(),await W(),!0;throw new Error(l?.message||"No se pudo actualizar el carrito")}catch(l){return console.error("Error al actualizar producto del carrito:",l),c(l instanceof Error?l.message:"Error al actualizar producto del carrito"),!1}finally{a(!1)}},[T,W,M]),d=g.useCallback(async()=>{try{if(!t)return!1;const u={id:t.id,items:[],total:0};return o(u),$.current=JSON.stringify(u),me.setItem(ue.storage.cartKey,JSON.stringify(u)),!0}catch(u){return console.error("Error al vaciar carrito:",u),!1}},[t]),k=g.useCallback(async()=>{if(!B.current){const u=await d();return await W(),u}try{a(!0);const u=await ae.clearCart();if(u&&u.status==="success")return M(),!0;throw new Error(u?.message||"No se pudo vaciar el carrito")}catch(u){return console.error("Error al vaciar carrito:",u),c(u instanceof Error?u.message:"Error al vaciar carrito"),!1}finally{a(!1)}},[d,W,M]),U=g.useCallback(async u=>{try{a(!0);const l=await ae.validateDiscountCode(u);return l&&l.status==="success"?{success:!0,message:l.message||"Código válido",data:l.data}:{success:!1,message:l?.message||"Código de descuento inválido"}}catch(l){return console.error("Error validating discount code:",l),{success:!1,message:l.response?.data?.message||l.message||"Error al validar código de descuento"}}finally{a(!1)}},[]),I=g.useCallback(async u=>{try{a(!0);const l=await ae.applyDiscountCode(u);return l&&l.status==="success"?(l.data?.cart&&(o(l.data.cart),$.current=JSON.stringify(l.data.cart)),l.data?.discount_code&&S({discountCode:l.data.discount_code,appliedAt:new Date}),M(),{success:!0,message:l.message||"Descuento aplicado exitosamente",cart:l.data?.cart}):{success:!1,message:l?.message||"No se pudo aplicar el código de descuento"}}catch(l){return console.error("Error applying discount code:",l),{success:!1,message:l.response?.data?.message||l.message||"Error al aplicar código de descuento"}}finally{a(!1)}},[M]),Q=g.useCallback(async()=>{try{a(!0);const u=await ae.removeDiscountCode();return u&&u.status==="success"?(u.data?.cart&&(o(u.data.cart),$.current=JSON.stringify(u.data.cart)),S(null),M(),{success:!0,message:u.message||"Descuento removido exitosamente",cart:u.data?.cart}):{success:!1,message:u?.message||"No se pudo remover el código de descuento"}}catch(u){return console.error("Error removing discount code:",u),{success:!1,message:u.response?.data?.message||u.message||"Error al remover código de descuento"}}finally{a(!1)}},[M]);return e.jsxs(je.Provider,{value:{cart:t,loading:s,error:r,addToCart:N,removeFromCart:h,updateCartItem:j,clearCart:k,fetchCart:W,itemCount:p,totalAmount:f,notification:m,showNotification:Z,hideNotification:z,cartItemCount:p,appliedDiscount:_,validateDiscountCode:U,applyDiscountCode:I,removeDiscountCode:Q},children:[y,m&&e.jsx("div",{className:"fixed bottom-4 right-4 z-50 max-w-sm",children:e.jsxs("div",{className:`px-4 py-3 rounded-lg shadow-lg flex items-center ${m.type==="success"?"bg-green-600 text-white":m.type==="error"?"bg-red-500 text-white":m.type==="warning"?"bg-yellow-500 text-white":"bg-blue-500 text-white"}`,children:[e.jsx("span",{className:"flex-1",children:m.message}),e.jsx("button",{onClick:z,className:"ml-2 text-white",children:"×"})]})})]})},he=()=>{const y=g.useContext(je);if(!y)throw new Error("useCart debe usarse dentro de un CartProvider");return y};class Ge{static extractUserMessage(t){if(t?.response?.data){const o=t.response.data;if(o.message)return this.translateErrorMessage(o.message);if(o.errors&&Array.isArray(o.errors))return o.errors.map(s=>s.message||s).join(", ");if(o.error)return this.translateErrorMessage(o.error)}return t?.message?this.translateErrorMessage(t.message):typeof t=="string"?this.translateErrorMessage(t):t?.code==="NETWORK_ERROR"||t?.message?.includes("Network Error")?"Error de conexión. Verifica tu conexión a internet.":t?.code==="ECONNABORTED"||t?.message?.includes("timeout")?"La solicitud tardó demasiado. Inténtalo de nuevo.":"Ha ocurrido un error inesperado. Inténtalo de nuevo."}static translateErrorMessage(t){const o={"Stock insuficiente":"No hay suficiente stock disponible. Reduce la cantidad.","Insufficient stock":"No hay suficiente stock disponible. Reduce la cantidad.","Out of stock":"Producto agotado. No hay unidades disponibles.","No hay suficiente stock":"No hay suficiente stock disponible. Reduce la cantidad.","Producto agotado":"Producto agotado. No hay unidades disponibles.",Unauthorized:"Debes iniciar sesión para realizar esta acción.","Token expired":"Tu sesión ha expirado. Inicia sesión nuevamente.","Invalid credentials":"Credenciales incorrectas. Verifica tu email y contraseña.","Validation failed":"Los datos ingresados no son válidos.","Required field missing":"Faltan campos obligatorios.","Invalid email format":"El formato del email no es válido.","Password too weak":"La contraseña debe ser más segura.","Product not found":"El producto no fue encontrado.","Product unavailable":"El producto no está disponible temporalmente.","Price changed":"El precio del producto ha cambiado. Actualiza la página.","Cart empty":"Tu carrito está vacío.","Cart item not found":"El producto no se encuentra en tu carrito.","Cannot update cart":"No se pudo actualizar el carrito. Inténtalo de nuevo.","Payment failed":"El pago no pudo ser procesado. Verifica tus datos.","Invalid payment method":"Método de pago no válido.","Insufficient funds":"Fondos insuficientes en tu cuenta.","Invalid shipping address":"La dirección de envío no es válida.","Shipping not available":"Envío no disponible para tu ubicación.","Server error":"Error del servidor. Inténtalo más tarde.","Service unavailable":"Servicio temporalmente no disponible.","Rate limit exceeded":"Has realizado demasiadas solicitudes. Espera un momento."};if(o[t])return o[t];const s=t.toLowerCase();return s.includes("stock")||s.includes("existencia")?"Problema con el stock del producto. Verifica la disponibilidad.":s.includes("payment")||s.includes("pago")?"Error en el procesamiento del pago. Verifica tus datos.":s.includes("network")||s.includes("connection")||s.includes("conexión")?"Error de conexión. Verifica tu conexión a internet.":s.includes("timeout")||s.includes("tiempo")?"La operación tardó demasiado. Inténtalo de nuevo.":s.includes("cantidad")||s.includes("disponible")?"Cantidad solicitada no disponible. Verifica el stock.":t}static getNotificationType(t){const s=(t?.response?.data?.message||t?.message||"").toLowerCase();return s.includes("stock")||s.includes("existencia")||s.includes("cantidad")||s.includes("validation")||s.includes("required")?"warning":s.includes("unauthorized")||s.includes("token")||s.includes("login")||s.includes("sesión")?"info":"error"}static handleApiError(t,o){const s=this.extractUserMessage(t),a=this.getNotificationType(t),r=this.shouldRetry(t);return console.error(`Error${o?` in ${o}`:""}:`,{originalError:t,userMessage:s,type:a,shouldRetry:r}),{message:s,type:a,shouldRetry:r}}static shouldRetry(t){if(t?.code==="NETWORK_ERROR"||t?.code==="ECONNABORTED"||t?.message?.includes("timeout")||t?.message?.includes("Network Error")||t?.response?.status>=500)return!0;if(t?.response?.status>=400&&t?.response?.status<500)return[408,429].includes(t.response.status);const o=t?.response?.data?.message||t?.message||"";return o.toLowerCase().includes("stock")||o.toLowerCase().includes("existencia")||o.toLowerCase().includes("cantidad"),!1}static handleStockError(t,o){return{message:`Solo hay ${t} unidad${t!==1?"es":""} disponible${t!==1?"s":""} en stock. Solicitaste ${o}.`,type:"warning",shouldRetry:!1}}static handleValidationError(t){const o=Object.values(t).flat();return{message:o.length>0?o.join(". "):"Error de validación",type:"warning",shouldRetry:!1}}}const He=({showNotification:y,context:t})=>{const o=g.useCallback((r,c)=>{const p=Ge.handleApiError(r,t),b=c||p.message,i={error:A.ERROR,warning:A.WARNING,info:A.INFO}[p.type]||A.ERROR;return y(i,b),p.shouldRetry},[y,t]),s=g.useCallback(r=>{y(A.SUCCESS,r)},[y]),a=g.useCallback((r,c)=>{const p=`Solo hay ${r} unidad${r!==1?"es":""} disponible${r!==1?"s":""} en stock. Solicitaste ${c}.`;y(A.WARNING,p)},[y]);return{handleError:o,handleSuccess:s,handleStockError:a}},ze=Ie.getInstance(),xe=[{quantity:3,discount:5,label:"3+"},{quantity:6,discount:10,label:"6+"},{quantity:12,discount:15,label:"12+"}];function Je(y,t,o){const s=xe;let a=null;for(const b of s)if(t>=b.quantity)a=b;else break;if(!a)return{originalPrice:y,discountedPrice:y,discountPercentage:0,savings:0,savingsTotal:0,hasDiscount:!1,tierLabel:null};const r=y*(1-a.discount/100),c=y-r,p=c*t;return{originalPrice:y,discountedPrice:r,discountPercentage:a.discount,savings:c,savingsTotal:p,hasDiscount:!0,tierLabel:a.label}}async function We(y,t,o){let s=o;if(!s)try{const f=await ze.getUnifiedConfig();f.config.volume_discounts&&Array.isArray(f.config.volume_discounts)&&f.config.volume_discounts.length>0&&(s=f.config.volume_discounts)}catch(f){console.warn("Error obteniendo configuración de descuentos, usando defaults:",f),s=xe}(!s||s.length===0)&&(s=xe);let a=null;const r=[...s].sort((f,i)=>f.quantity-i.quantity);for(const f of r)if(t>=f.quantity)a=f;else break;if(!a)return{originalPrice:y,discountedPrice:y,discountPercentage:0,savings:0,savingsTotal:0,hasDiscount:!1,tierLabel:null};const c=y*(1-a.discount/100),p=y-c,b=p*t;return{originalPrice:y,discountedPrice:c,discountPercentage:a.discount,savings:p,savingsTotal:b,hasDiscount:!0,tierLabel:a.label}}function it(y){const t=y.product?.price||y.price||0,o=y.product?.discount_percentage||0,s=y.quantity||1,a=t*(o/100),r=t-a,c=Je(r,s),p=c.discountedPrice,b=a*s,f=c.savingsTotal,i=b+f,m=c.hasDiscount,x=m?c.discountPercentage:o;return{originalPrice:t,discountedPrice:p,discountPercentage:x,savings:t-p,savingsTotal:i,hasDiscount:o>0||m,sellerDiscountAmount:a,volumeDiscountAmount:c.savings,finalPricePerUnit:p}}async function Qe(y,t){const o=y.product?.price||y.price||0,s=y.product?.discount_percentage||0,a=y.quantity||1,r=o*(s/100),c=o-r,p=await We(c,a,t),b=p.discountedPrice,f=r*a,i=p.savingsTotal,m=f+i,x=p.hasDiscount,_=x?p.discountPercentage:s;return{originalPrice:o,discountedPrice:b,discountPercentage:_,savings:o-b,savingsTotal:m,hasDiscount:s>0||x,sellerDiscountAmount:r,volumeDiscountAmount:p.savings,finalPricePerUnit:b}}class ye{static configManager=Ie.getInstance();static async calculateTotals(t,o,s=!1){console.log("🧮 JORDAN CALCULADORA - INICIANDO CON CONFIGURACIÓN UNIFICADA",{forceRefresh:s,itemsCount:t.length});const a=await this.configManager.getUnifiedConfig(s),r=a.config;console.log("✅ JORDAN - Configuración obtenida:",{source:a.source,isStale:a.is_stale,taxRate:r.tax_rate,commissionRate:r.platform_commission_rate,shippingCost:r.shipping.default_cost,volumeTiers:r.volume_discounts.length});const c=this.calculateOriginalSubtotal(t);console.log(`1️⃣ Subtotal original: $${c.toFixed(2)}`);const{subtotal:p,totalDiscount:b}=this.calculateSellerDiscounts(t,c);console.log(`2️⃣ Después descuento vendedor: $${p.toFixed(2)}`);const{subtotal:f,totalDiscount:i}=this.calculateVolumeDiscounts(t,p,r.volume_discounts);console.log(`3️⃣ Después descuento volumen: $${f.toFixed(2)}`);const{subtotal:m,discount:x}=this.calculateCouponDiscount(f,o);console.log(`4️⃣ Después cupón: $${m.toFixed(2)}`);const _=this.calculateShipping(m,r.shipping),S=m+_;console.log(`5️⃣ Con envío: $${S.toFixed(2)} (envío: $${_.toFixed(2)})`);const w=S*r.tax_rate;console.log(`6️⃣ IVA calculado: $${w.toFixed(2)} (${(r.tax_rate*100).toFixed(1)}%)`);const V=S+w;console.log(`7️⃣ TOTAL FINAL: $${V.toFixed(2)}`);const $=b+i+x,B=i>0,L=_===0;return console.log("📊 JORDAN - RESUMEN CON CONFIGURACIÓN UNIFICADA:"),console.log(`   💰 Configuración: ${a.source} (${r.version})`),console.log(`   💰 Tax rate: ${(r.tax_rate*100).toFixed(1)}% (dinámico)`),console.log(`   💰 Volume tiers: ${r.volume_discounts.length} configurados`),console.log(`   💰 Shipping: $${r.shipping.default_cost} (umbral: $${r.shipping.free_threshold})`),{step1_originalSubtotal:c,step2_afterSellerDiscount:p,step3_afterVolumeDiscount:f,step4_afterCoupon:m,step5_withShipping:S,step6_tax:w,step7_finalTotal:V,sellerDiscounts:b,volumeDiscounts:i,couponDiscount:x,totalDiscounts:$,shipping:_,freeShipping:L,volumeDiscountsApplied:B,configMetadata:{source:a.source,version:r.version,isStale:a.is_stale,warnings:a.warnings},originalSubtotal:c,subtotalAfterSellerDiscount:p,subtotalAfterVolumeDiscount:f,subtotalAfterCoupon:m,subtotalWithShipping:S,tax:w,total:V}}static calculateOriginalSubtotal(t){let o=0;return t.forEach(s=>{const a=this.getBasePrice(s),r=s.quantity||0,c=a*r;console.log(`📦 Item: precio base $${a} × ${r} = $${c}`),o+=c}),o}static calculateSellerDiscounts(t,o){let s=0,a=0;return t.forEach(r=>{const c=this.getBasePrice(r),p=r.quantity||0,b=this.getSellerDiscountPercentage(r),f=c*(b/100),i=c-f,m=f*p,x=i*p;s+=m,a+=x,console.log(`🏪 Seller discount: ${b}% sobre $${c} = descuento $${f}/unidad`)}),{subtotal:a,totalDiscount:s}}static calculateVolumeDiscounts(t,o,s){let a=0,r=0;return t.forEach(c=>{const p=c.quantity||0,b=this.getVolumeDiscountPercentage(p,s);if(b>0){const f=this.getPriceAfterSellerDiscount(c),i=f*b,m=f-i,x=i*p,_=m*p;a+=x,r+=_,console.log(`📦 Volume discount: ${(b*100).toFixed(1)}% sobre $${f} = descuento $${i}/unidad`)}else{const f=this.getPriceAfterSellerDiscount(c);r+=f*p}}),{subtotal:r,totalDiscount:a}}static calculateCouponDiscount(t,o){if(!o?.discountCode)return{subtotal:t,discount:0};let s=0;const a=o.discountCode;if(a.discount_percentage){const r=parseFloat(a.discount_percentage);s=t*(r/100)}else a.percentage?s=t*(a.percentage/100):a.value&&(s=Math.min(a.value,t));return console.log(`🎫 Cupón ${a.code}: ${a.discount_percentage||a.percentage||a.value}% = descuento $${s.toFixed(2)}`),{subtotal:t-s,discount:s}}static calculateShipping(t,o){return o.enabled?t>=o.free_threshold?0:o.default_cost:0}static getBasePrice(t){return t.base_price!==void 0?t.base_price:t.product?.price!==void 0?t.product.price:t.price!==void 0&&t.final_price===void 0?t.price:2}static getSellerDiscountPercentage(t){return t.product?.discount_percentage!==void 0?t.product.discount_percentage:50}static getPriceAfterSellerDiscount(t){const o=this.getBasePrice(t),s=this.getSellerDiscountPercentage(t);return o*(1-s/100)}static getVolumeDiscountPercentage(t,o){const s=[...o].sort((a,r)=>r.quantity-a.quantity);for(const a of s)if(t>=a.quantity)return a.discount/100;return 0}static roundForDisplay(t){return parseFloat(t.toFixed(2))}static async prepareCheckoutData(t,o,s=!1){const a=await this.calculateTotals(t,o,s),c=(await this.configManager.getUnifiedConfig(s)).config;return{items:t.map(b=>{const f=this.getBasePrice(b),i=this.getSellerDiscountPercentage(b),m=this.getVolumeDiscountPercentage(b.quantity||0,c.volume_discounts),x=f*(1-i/100),_=m>0?x*(1-m):x;return{product_id:b.product_id||b.product?.id||b.productId,quantity:b.quantity,price:_,base_price:f,original_price:f,final_price:_,volume_discount_percentage:m*100,volume_savings:(x-_)*(b.quantity||0),seller_discount_amount:(f-x)*(b.quantity||0)}}),totals:a}}}class Y{static async prepareItemsForCheckout(t,o=null,s=!1){console.log("🛒 JORDAN CheckoutItemsService - Preparando items con configuración unificada",{forceRefresh:s}),console.log("🎫 Cupón para items:",o?.discountCode?.code||"NINGUNO");const{items:a}=await ye.prepareCheckoutData(t,o,s);return a.map((c,p)=>(console.log(`✅ Item ${p+1} preparado para checkout:`,{product_id:c.product_id,quantity:c.quantity,price:c.price,base_price:c.base_price,final_price:c.final_price}),c))}static async calculateCheckoutTotals(t,o=null,s=!1){console.log("🔍 JORDAN - FLUJO CHECKOUT MIGRADO CON CONFIGURACIÓN UNIFICADA:",{forceRefresh:s});const a=await ye.calculateTotals(t,o,s);return console.log("📊 PASO A PASO:"),console.log(`   1️⃣ Subtotal original (sin descuentos): ${a.step1_originalSubtotal}`),console.log(`   2️⃣ Después de seller + volume: ${a.step3_afterVolumeDiscount} ✅ DEBE SER $2.85`),console.log(`   3️⃣ - Cupón 5% sobre subtotal: ${a.couponDiscount} -> Subtotal: ${a.step4_afterCoupon}`),console.log(`   4️⃣ + Envío: ${a.step5_withShipping}`),console.log(`   5️⃣ + IVA 15% sobre ${a.step5_withShipping} : ${a.step6_tax}`),console.log(`   6️⃣ TOTAL FINAL: ${a.step7_finalTotal} ✅ DEBE SER $8.87`),console.log("💰 DESGLOSE COMPLETO:"),console.log(`   - Descuentos seller: ${a.sellerDiscounts}`),console.log(`   - Descuentos volume: ${a.volumeDiscounts}`),console.log(`   - Descuento cupón: ${a.couponDiscount}`),console.log(`   - Total descuentos: ${a.totalDiscounts}`),console.log(`   - Envío: ${a.shipping}`),console.log(`   - IVA (15%): ${a.tax}`),console.log(`🎯 VALOR CORRECTO PARA BACKEND: ${a.total}`),{subtotal:a.step3_afterVolumeDiscount,originalSubtotal:a.originalSubtotal,sellerDiscounts:a.sellerDiscounts,volumeDiscounts:a.volumeDiscounts,totalDiscounts:a.totalDiscounts,couponDiscount:a.couponDiscount,tax:a.tax,shipping:a.shipping,total:a.total,freeShipping:a.freeShipping}}static validateItemsForCheckout(t){const o=[];console.log(`🔍 Validando ${t.length} items para checkout:`),t.forEach((a,r)=>{if(console.log(`📋 Validando Item ${r+1}:`,{product_id:a.product_id,product_id_type:typeof a.product_id,quantity:a.quantity,quantity_type:typeof a.quantity,price:a.price,price_type:typeof a.price}),!a.product_id||typeof a.product_id!="number"||isNaN(a.product_id)||a.product_id<=0){const c=`Item ${r+1}: product_id inválido (${a.product_id}, tipo: ${typeof a.product_id})`;console.error("❌",c),o.push(c)}if(!a.quantity||typeof a.quantity!="number"||isNaN(a.quantity)||a.quantity<=0){const c=`Item ${r+1}: quantity inválida (${a.quantity}, tipo: ${typeof a.quantity})`;console.error("❌",c),o.push(c)}if(typeof a.price!="number"||isNaN(a.price)||a.price<=0){const c=`Item ${r+1}: price inválido (${a.price}, tipo: ${typeof a.price})`;console.error("❌",c),o.push(c)}});const s={valid:o.length===0,errors:o};return console.log("📊 Validación resultado:",s),s}static async debugItemPricing(t,o){console.log("🔍 DEBUG: Comparación usando calculadora centralizada");const a=(await ye.prepareCheckoutData(t)).items;t.forEach((r,c)=>{const p=o[c],b=a[c];console.log(`📦 Item ${c+1}:`,{product_id:r.productId||r.product?.id,quantity:r.quantity,calculated_final_price:b?.price,checkout_price:p?.price,prices_match:Math.abs((p?.price||0)-(b?.price||0))<.01,"✅":"USANDO CALCULADORA CENTRALIZADA"})})}}const le={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_ANALYTICS_ENABLED:"true",VITE_API_BASE_URL:"https://api.comersia.app/api",VITE_APP_DESCRIPTION:"Plataforma de e-commerce ecuatoriana",VITE_APP_ENV:"production",VITE_APP_NAME:"Comersia",VITE_BACKEND_URL:"https://api.comersia.app",VITE_BUNDLE_ANALYZER:"false",VITE_CACHE_DURATION:"3600000",VITE_CACHE_ENABLED:"true",VITE_CSP_ENABLED:"true",VITE_DATAFAST_MODE:"production",VITE_DEBUG_MODE:"false",VITE_DEUNA_MODE:"production",VITE_ENABLE_DEVTOOLS:"false",VITE_ERROR_REPORTING:"true",VITE_FRONTEND_URL:"https://comersia.app",VITE_GOOGLE_CLIENT_ID:"581090375629-kds9jjgs2pk60iqe05fmjhpf6pps2nsv.apps.googleusercontent.com",VITE_HOT_RELOAD:"false",VITE_HTTPS_ONLY:"true",VITE_IMAGE_BASE_URL:"https://api.comersia.app/storage/",VITE_LOG_LEVEL:"error",VITE_MINIFY:"true",VITE_NODE_ENV:"production",VITE_PAYPAL_MODE:"live",VITE_PERFORMANCE_MONITORING:"true",VITE_SENTRY_ENABLED:"true",VITE_SITE_URL:"https://comersia.app",VITE_SOURCE_MAPS:"false",VITE_STORAGE_PREFIX:"comersia_",VITE_TRACKING_ENABLED:"true",VITE_TREE_SHAKING:"true",VITE_URL_BASE:"http://localhost:8000"},Ne=(y,t)=>{const o=le?.[y];return o&&!isNaN(Number(o))?Number(o):t},fe={PRECISION:{PRICE_COMPARISON_TOLERANCE:Ne("VITE_PRICE_TOLERANCE",.001)},VALIDATIONS:{CHECKOUT_TOLERANCE:Ne("VITE_CHECKOUT_TOLERANCE",.001)},DEBUG:{SHOW_CALCULATION_LOGS:le?.VITE_DEBUG_CALCULATIONS==="true"||le?.NODE_ENV==="development",SHOW_PRECISION_WARNINGS:le?.VITE_DEBUG_PRECISION==="true"||le?.NODE_ENV==="development"}},dt=(y,t,o=fe.PRECISION.PRICE_COMPARISON_TOLERANCE)=>{const s=Math.abs(y-t),a=s<=o;return fe.DEBUG.SHOW_PRECISION_WARNINGS&&s>0&&s<=o&&console.warn(`⚠️ Diferencia de precisión detectada: ${y} vs ${t} (diff: ${s.toFixed(6)}, tolerance: ${o})`),a},Ke=(y,t,o="Comparación de totales",s)=>{const a=s??fe.VALIDATIONS.CHECKOUT_TOLERANCE,r=Math.abs(y-t),c=r<=a;return fe.DEBUG.SHOW_CALCULATION_LOGS&&console.log(`🔍 ${o}:`,{frontendTotal:y.toFixed(6),backendTotal:t.toFixed(6),difference:r.toFixed(6),tolerance:a.toFixed(6),isValid:c,status:c?"✅ VÁLIDO":"❌ DISCREPANCIA"}),c};class re{static getSellerIdFromCart(t){if(!t||!t.items||t.items.length===0)return console.log("🛒 getSellerIdFromCart: Carrito vacío o sin items"),null;console.log("🛒 getSellerIdFromCart: Analizando carrito:",{totalItems:t.items.length,items:t.items.map(s=>({id:s.id,productId:s.productId,quantity:s.quantity,productData:s.product}))});const o=t.items[0];if(console.log("🛒 getSellerIdFromCart: Primer item del carrito:",o),o.product){if(console.log("🛒 getSellerIdFromCart: Producto encontrado:",{sellerId:o.product.sellerId,seller_id:o.product.seller_id,seller:o.product.seller,user_id:o.product.user_id}),o.product.sellerId)return console.log("✅ getSellerIdFromCart: Usando sellerId:",o.product.sellerId),o.product.sellerId;if(o.product.seller_id)return console.log("✅ getSellerIdFromCart: Usando seller_id:",o.product.seller_id),o.product.seller_id;if(o.product.seller&&o.product.seller.id)return console.log("✅ getSellerIdFromCart: Usando seller.id:",o.product.seller.id),o.product.seller.id;if(o.product.user_id)return console.log("✅ getSellerIdFromCart: Usando user_id como fallback:",o.product.user_id),o.product.user_id}return console.warn("❌ getSellerIdFromCart: No se pudo obtener seller ID del carrito:",t),null}async processCheckout(t,o){try{if(console.log("🚀 CheckoutService.processCheckout INICIADO CON DESCUENTOS POR VOLUMEN"),console.log("📦 Datos de checkout enviados:",JSON.stringify(t,null,2)),!t.shippingAddress.name)throw new Error("El nombre en la dirección de envío es requerido");let s=t.payment.method;const a={transfer:"datafast",credit_card:"credit_card",debit_card:"debit_card",paypal:"paypal",qr:"de_una",datafast:"datafast",de_una:"de_una"};a[s]&&(s=a[s]),console.log("🔍 DEBUGGING - Método después de mapear:",s);const r=t.items||[];console.log("🔍 DEBUGGING - Items recibidos:",r),r.length===0&&console.warn("⚠️ No se recibieron items en checkoutData");const c=Y.validateItemsForCheckout(r);if(!c.valid)throw new Error(`Validación de items falló: ${c.errors.join(", ")}`);console.log("✅ Items validados correctamente:",r);const p=t.discount_info||(t.discount_code?{discountCode:{code:t.discount_code,discount_percentage:5,discount_amount:0}}:null);console.log("🔍 USANDO TOTALES PRECALCULADOS (NO SE RECALCULA):"),console.log("   📊 calculated_totals recibidos:",t.calculated_totals),console.log("🔍 FLUJO COMPLETO DE CHECKOUT CORREGIDO:"),console.log("1️⃣ Items del carrito:",t.items?.length||0),console.log("2️⃣ Código de descuento:",t.discount_code||"NINGUNO"),console.log("3️⃣ appliedDiscount:",p),console.log("4️⃣ TOTALES EXACTOS CALCULADOS (CALCULADORA CENTRALIZADA):",t.calculated_totals),console.log("5️⃣ Total final CORRECTO que debe guardarse en DB:",t.calculated_totals?.total,"✅ DEBE SER $8.87");const b=(t.shippingAddress.name||"").split(" "),f={payment:{...t.payment,method:s},shipping:{first_name:b[0]||"",last_name:b.slice(1).join(" ")||"",email:o||"",phone:t.shippingAddress.phone||"",address:t.shippingAddress.street||"",city:t.shippingAddress.city||"",state:t.shippingAddress.state||"",postal_code:t.shippingAddress.postalCode||"",country:t.shippingAddress.country||""},seller_id:t.seller_id,items:r,calculated_totals:t.calculated_totals||{subtotal:0,tax:0,shipping:0,total:0,total_discounts:0}};if(t.discount_code&&t.discount_code.trim()!==""?(f.discount_code=t.discount_code.trim(),console.log("✅ Cupón aplicado enviado al backend:",f.discount_code)):console.log("✅ No hay cupón - campo discount_code omitido del request"),console.log("🔍 DEBUGGING - Datos completos enviados al backend:",JSON.stringify(f,null,2)),console.log("💰 TOTALES CRÍTICOS CORREGIDOS QUE DEBE USAR EL BACKEND:"),console.log("   📊 Subtotal:",t.calculated_totals?.subtotal),console.log("   📊 IVA:",t.calculated_totals?.tax),console.log("   📊 Envío:",t.calculated_totals?.shipping),console.log("   📊 TOTAL FINAL:",t.calculated_totals?.total,"✅ DEBE SER $8.87"),console.log("   📊 Total descuentos:",t.calculated_totals?.total_discounts),console.log("🚨 EL BACKEND NO DEBE RECALCULAR - USAR ESTOS TOTALES EXACTOS"),console.log("🚨 TOTAL ESPERADO EN RESPUESTA:",t.calculated_totals?.total),f.items&&f.items.length>0){for(let m=0;m<f.items.length;m++){const x=f.items[m];if(!x.hasOwnProperty("price")||x.price===void 0||x.price===null)throw new Error(`FATAL: Item ${m} no tiene campo 'price' definido. Item: ${JSON.stringify(x)}`);if(typeof x.price!="number"||x.price<=0)throw new Error(`FATAL: Item ${m} tiene precio inválido: ${x.price} (tipo: ${typeof x.price})`)}console.log("✅ VALIDACIÓN FINAL: Todos los items tienen precios finales válidos")}const i=await J.post(X.CHECKOUT.PROCESS,f);if(console.log("✅ CheckoutService: Respuesta del backend:"),console.log("📊 Status:",i.status),console.log("💬 Message:",i.message),console.log("📦 Data:",JSON.stringify(i.data,null,2)),i.data&&typeof i.data=="object"){const m=i.data;m.total_savings&&m.total_savings>0&&(console.log("💰 DESCUENTOS APLICADOS EN LA ORDEN:"),console.log(`💵 Total ahorrado: $${m.total_savings}`),m.volume_discount_savings&&console.log(`📈 Descuentos por volumen: $${m.volume_discount_savings}`),m.seller_discount_savings&&console.log(`🏪 Descuentos del seller: $${m.seller_discount_savings}`))}return console.log("🎉 CheckoutService.processCheckout COMPLETADO CON DESCUENTOS POR VOLUMEN"),i}catch(s){console.error("❌ CheckoutService: Error al procesar checkout:"),console.error("📊 Error object:",s),console.error("📊 Error message:",s?.message),console.error("📊 Error response:",s?.response?.data),s?.response?.status===400&&(console.error("🔍 ERROR 400 DETECTADO - Analizando request enviada:"),console.error("📊 Payment method enviado:",t.payment.method),console.error("📊 Items enviados:",t.items),console.error("📊 Seller ID enviado:",t.seller_id));const a=ne(s,"Error al procesar el pago. Por favor, intenta de nuevo más tarde.");throw console.error("📊 Error message final:",a),new Error(a)}}async getCurrentCart(){try{return console.log("🛒 Obteniendo carrito actual..."),null}catch(t){return console.error("❌ Error al obtener carrito actual:",t),null}}static async prepareCartItemsForCheckout(t,o=null){console.log("🛒 Preparando items del carrito con descuentos"),console.log("🎫 Cupón aplicado:",o?.discountCode?.code||"NINGUNO");const s=await Y.prepareItemsForCheckout(t,o);return await Y.debugItemPricing(t,s),console.log("✅ Items preparados para checkout:",s),s}static calculateCheckoutTotals(t){return Y.calculateCheckoutTotals(t)}static validateCheckoutTotals(t,o,s){return Ke(t,o,"Validación CheckoutService",s)}}const Ye=({content:y})=>e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"mb-4 text-gray-600",children:"Paga con Datafast!, ingresa los datos personales para pagar de forma rápida y segura."}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-[linear-gradient(to_right,_rgba(0,184,110,1)_0%,_rgba(0,77,112,1)_46%,_rgba(0,77,112,1)_100%)] border-purple-200 rounded-lg p-6",children:e.jsx("div",{className:"flex items-center justify-center mb-4 h-50",children:e.jsx("img",{src:"https://www.datafast.com.ec/images/logo.png",alt:"DeUna Logo",className:"h-20"})})}),y]}),e.jsxs("div",{className:"mt-4 text-sm text-gray-500",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"1."}),' Haz clic en "Pagar con Datafast!"']}),e.jsxs("p",{children:[e.jsx("strong",{children:"2."})," Completa los datos de tu tarjeta de crédito o débito."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"3."})," Confirma tu compra al finalizar."]})]})]})});class ee{static BASE_PATH="/deuna";static async createPayment(t){try{console.log("DeunaService: Creating payment",t),console.log("🔍 DEUNA SERVICE - EXACT PAYLOAD TO SEND:",{path:`${this.BASE_PATH}/payments`,payload:t,payload_json:JSON.stringify(t),items_in_payload:t.items,items_count:t.items?.length||0,first_item_keys:t.items&&t.items.length>0?Object.keys(t.items[0]):"no_items"});const o=await J.post(`${this.BASE_PATH}/payments`,t);return console.log("DeunaService: Payment created successfully",o),o}catch(o){throw console.error("DeunaService: Error creating payment",o),new Error(o.response?.data?.message||o.message||"Error creating payment")}}static async generateQR(t){try{console.log("DeunaService: Generating QR code",t);const o=await J.post(`${this.BASE_PATH}/payments/qr`,t);return console.log("DeunaService: QR code generated successfully",o),o}catch(o){throw console.error("DeunaService: Error generating QR code",o),new Error(o.response?.data?.message||o.message||"Error generating QR code")}}static async getPaymentStatus(t){try{console.log("DeunaService: Getting payment status",{paymentId:t});const o=await J.get(`${this.BASE_PATH}/payments/${t}/status`);return console.log("DeunaService: Payment status retrieved",o),o}catch(o){throw console.error("DeunaService: Error getting payment status",o),new Error(o.response?.data?.message||o.message||"Error getting payment status")}}static async getPaymentByOrderId(t){try{console.log("DeunaService: Getting payment by order ID",{orderId:t});const o=await J.get(`${this.BASE_PATH}/orders/${t}/payment`);return console.log("DeunaService: Payment retrieved by order ID",o),o}catch(o){throw console.error("DeunaService: Error getting payment by order ID",o),new Error(o.response?.data?.message||o.message||"Error getting payment")}}static async cancelPayment(t,o){try{console.log("DeunaService: Cancelling payment",{paymentId:t,reason:o});const s=await J.post(`${this.BASE_PATH}/payments/${t}/cancel`,{reason:o||"Cancelled by user"});return console.log("DeunaService: Payment cancelled successfully",s),s}catch(s){throw console.error("DeunaService: Error cancelling payment",s),new Error(s.response?.data?.message||s.message||"Error cancelling payment")}}static async voidPayment(t,o,s){try{console.log("DeunaService: Processing void/refund",{paymentId:t,amount:o,reason:s});const a=await J.post(`${this.BASE_PATH}/payments/${t}/void`,{amount:o,reason:s||"Void/refund requested by user"});return console.log("DeunaService: Payment void/refund processed successfully",a),a}catch(a){throw console.error("DeunaService: Error processing void/refund",a),new Error(a.response?.data?.message||a.message||"Error processing void/refund")}}static async listPayments(t){try{console.log("DeunaService: Listing payments",t);const o=new URLSearchParams;t&&Object.entries(t).forEach(([a,r])=>{r!=null&&r!==""&&o.append(a,String(r))});const s=await J.get(`${this.BASE_PATH}/payments?${o.toString()}`);return console.log("DeunaService: Payments listed successfully",s),s}catch(o){throw console.error("DeunaService: Error listing payments",o),new Error(o.response?.data?.message||o.message||"Error listing payments")}}static pollPaymentStatus(t,o){const s=o?.maxAttempts||60,a=o?.interval||5e3,r=o?.onStatusChange,c=new AbortController;return{promise:new Promise(async(b,f)=>{let i=0,m="",x=null;const _=()=>{x&&(clearTimeout(x),x=null)},S=()=>{_(),f(new Error("Payment polling was cancelled"))};c.signal.addEventListener("abort",S);try{for(;i<s&&!c.signal.aborted;)try{const w=await this.getPaymentStatus(t),V=w.data.status;if(c.signal.aborted){_();return}if(V!==m&&r&&(r(V),m=V),["completed","failed","cancelled","refunded"].includes(V)){console.log(`DeunaService: Payment reached final status: ${V}`),_(),c.signal.removeEventListener("abort",S),b(w);return}i++,i<s&&!c.signal.aborted&&await new Promise(($,B)=>{x=setTimeout(()=>{x=null,c.signal.aborted?B(new Error("Cancelled")):$()},a);const L=()=>{x&&(clearTimeout(x),x=null),B(new Error("Cancelled"))};c.signal.addEventListener("abort",L,{once:!0})})}catch(w){if(c.signal.aborted){_();return}console.warn(`DeunaService: Error polling payment status (attempt ${i+1})`,w),i++,i<s&&await new Promise((V,$)=>{x=setTimeout(()=>{x=null,c.signal.aborted?$(new Error("Cancelled")):V()},a);const B=()=>{x&&(clearTimeout(x),x=null),$(new Error("Cancelled"))};c.signal.addEventListener("abort",B,{once:!0})})}_(),c.signal.removeEventListener("abort",S),c.signal.aborted?f(new Error("Payment polling was cancelled")):f(new Error(`Payment status polling timed out after ${s} attempts`))}catch(w){_(),c.signal.removeEventListener("abort",S),w.message==="Cancelled"?f(new Error("Payment polling was cancelled")):f(w)}}),cancel:()=>{console.log("DeunaService: Cancelling payment polling"),c.abort()}}}static isValidQRCode(t){if(!t||t.trim()==="")return!1;if(t.startsWith("data:image/"))return!0;try{return new URL(t),!0}catch{return!1}}static formatCurrency(t,o="USD"){return new Intl.NumberFormat("es-EC",{style:"currency",currency:o,minimumFractionDigits:2,maximumFractionDigits:2}).format(t)}static getPaymentMethodDisplayName(t){return{qr_code:"Código QR",payment_link:"Enlace de Pago",numeric_code:"Código Numérico",deuna:"DeUna"}[t]||t}static getStatusDisplay(t){return{created:{label:"Creado",color:"blue",icon:te.createElement(Oe,{className:"w-4 h-4"})},pending:{label:"Pendiente",color:"yellow",icon:te.createElement(we,{className:"w-4 h-4"})},completed:{label:"Completado",color:"green",icon:te.createElement(De,{className:"w-4 h-4"})},failed:{label:"Fallido",color:"red",icon:te.createElement(ge,{className:"w-4 h-4"})},cancelled:{label:"Cancelado",color:"gray",icon:te.createElement(Re,{className:"w-4 h-4"})},refunded:{label:"Reembolsado",color:"purple",icon:te.createElement(Te,{className:"w-4 h-4"})}}[t]||{label:t,color:"gray",icon:te.createElement(Pe,{className:"w-4 h-4"})}}static async simulatePaymentSuccess(t,o,s){try{console.log("🧪 Simulating payment success for testing",{paymentId:t,amount:o,customerEmail:s});const a=await J.post("/webhooks/deuna/simulate-payment-success",{payment_id:t,amount:o||100,currency:"USD",customer_email:s||"test@example.com",customer_name:"Test Customer"});return console.log("🎉 Payment simulation response:",a),a}catch(a){throw console.error("❌ Error simulating payment:",a),new Error(a.response?.data?.message||a.message||"Error simulando el pago")}}static isDevelopmentMode(){return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"}}const Ze=({total:y,onPaymentSuccess:t,onPaymentError:o})=>{const{cart:s}=he(),{user:a}=Ee(),[r,c]=g.useState(!1),[p,b]=g.useState(null),[f,i]=g.useState(""),[m,x]=g.useState(!1),[_,S]=g.useState(""),[w,V]=g.useState(600),[$,B]=g.useState(!1),[L,D]=g.useState(!1),F=te.useRef(null),H=te.useRef(null),Z=te.useRef([]),z=y??s?.total??0,M=g.useCallback(()=>`ORDER-${Date.now()}-${Math.random().toString(36).substr(2,9).toUpperCase()}`,[]),K=async d=>{try{await navigator.clipboard.writeText(d),B(!0),setTimeout(()=>B(!1),2e3)}catch(k){console.error("Failed to copy to clipboard:",k)}};g.useEffect(()=>{if(p&&m&&w>0){const d=setInterval(()=>{V(k=>k<=1?(x(!1),i("El tiempo de pago ha expirado. El pago ha sido cancelado automáticamente."),p?.payment_id&&(console.log("⏰ Timer expired - automatically cancelling payment:",p.payment_id),ee.cancelPayment(p.payment_id,"Timer expired - automatic cancellation").then(()=>{console.log("✅ Payment automatically cancelled due to timer expiration"),S("cancelled"),F.current?.cancel&&(F.current.cancel(),F.current=null)}).catch(U=>{console.error("❌ Error automatically cancelling expired payment:",U),S("cancelled")})),0):k-1)},1e3);H.current=d,Z.current.push(()=>{d&&clearInterval(d)})}return()=>{H.current&&(clearInterval(H.current),H.current=null)}},[p,m,w]),g.useEffect(()=>()=>{console.log("🚨 QRPaymentForm: Component unmounting, executing critical cleanup"),N()},[]);const se=d=>{const k=Math.floor(d/60),U=d%60;return`${k.toString().padStart(2,"0")}:${U.toString().padStart(2,"0")}`},W=g.useCallback(d=>{console.log("Payment status changed:",d),S(d);const k=ee.getStatusDisplay(d);switch(d){case"completed":x(!1),console.log("✅ Payment completed successfully, calling onPaymentSuccess"),setTimeout(()=>{t&&t({...p,status:"completed",completed_at:new Date().toISOString()})},2e3);break;case"failed":case"cancelled":x(!1);const U=`Pago ${k.label.toLowerCase()}`;i(U),o&&o(U);break}},[p,t,o]),oe=async()=>{if(!a||!s?.items?.length){i("Información de usuario o carrito no disponible");return}c(!0),i("");try{const d=M();console.log("🔍 CART ITEMS BEFORE TRANSFORMATION:",s.items.map((I,Q)=>({index:Q,productId:I.productId,product_name:I.product?.name,quantity:I.quantity,final_price:I.final_price,price:I.price,subtotal:I.subtotal,all_keys:Object.keys(I)})));const k={order_id:d,amount:z,currency:"USD",customer:{name:a.name||"Cliente",email:a.email,phone:a.phone||void 0},items:s.items.map((I,Q)=>{const u=I.productId||I.product?.id||I.product?.product_id;if(!u)throw console.error(`❌ CRITICAL: Missing product_id for cart item ${Q}:`,{item_keys:Object.keys(I),item_productId:I.productId,product_id_alternatives:{"item.product?.id":I.product?.id,"item.product?.product_id":I.product?.product_id,"item.id":I.id},full_item:I}),new Error(`Cart item ${Q} is missing product_id. Cannot proceed with payment.`);const l={name:I.product?.name||"Producto",quantity:I.quantity,price:I.final_price||I.price||I.subtotal||0,description:I.product?.description||"",product_id:u};return console.log(`✅ ITEM ${Q} TRANSFORMATION SUCCESS:`,{original_productId:I.productId,mapped_product_id:l.product_id,product_id_source:I.productId?"item.productId":I.product?.id?"item.product.id":"other",mapped_item_keys:Object.keys(l),mapped_item:l}),l}),qr_type:"dynamic",format:"2",metadata:{source:"bcommerce_frontend",user_id:a.id,cart_id:s.id,checkout_timestamp:new Date().toISOString()}};console.log("🚀 FINAL PAYMENT REQUEST TO SEND:",{order_id:k.order_id,amount:k.amount,items_count:k.items?.length||0,items:k.items,first_item_keys:k.items&&k.items.length>0?Object.keys(k.items[0]):"no_items"}),console.log("Creating DeUna payment:",k);const U=await ee.createPayment(k);if(console.log("DeUna API Response:",U),console.log("Response structure:",Object.keys(U)),U.success){console.log("Payment data from response:",U.data),console.log("QR code in response:",U.data?.qr_code_base64),b(U.data),S(U.data.status),V(600),x(!0);const I=ee.pollPaymentStatus(U.data.payment_id,{maxAttempts:120,interval:5e3,onStatusChange:W});F.current=I,I.promise.catch(Q=>{Q.message==="Payment polling was cancelled"?console.log("DeunaService: Polling cancelled successfully"):(console.error("Polling error:",Q),m&&i("Error monitoreando el estado del pago"))})}else throw new Error(U.message||"Error creating payment")}catch(d){console.error("Error generating QR payment:",d),i(d.message||"Error al generar el código QR"),o&&o(d.message)}finally{c(!1)}},N=()=>{F.current?.cancel&&(F.current.cancel(),F.current=null),H.current&&(clearInterval(H.current),H.current=null),Z.current.forEach(d=>{try{d()}catch(k){console.error("Error during cleanup:",k)}}),Z.current=[],b(null),i(""),S(""),x(!1),V(600),B(!1),console.log("🧹 QRPaymentForm: Complete cleanup executed")},C=async()=>{if(!p?.payment_id||_==="completed"){N();return}if(!m){N();return}try{console.log("Cancelling payment:",p.payment_id),F.current?.cancel&&(F.current.cancel(),F.current=null),x(!1),await ee.cancelPayment(p.payment_id,"Cancelled by user"),S("cancelled"),i("Pago cancelado por el usuario"),console.log("Payment successfully cancelled by user")}catch(d){console.error("Error cancelling payment:",d),i("Error al cancelar el pago: "+d.message),x(!1)}},h=async()=>{try{if(c(!0),i(""),p?.payment_id&&m&&!["completed","cancelled","failed"].includes(_))try{console.log("Cancelling current payment before generating new QR:",p.payment_id),F.current?.cancel&&(F.current.cancel(),F.current=null),x(!1),await ee.cancelPayment(p.payment_id,"Cancelled to generate new QR"),console.log("Current payment cancelled successfully")}catch(d){console.error("Error cancelling current payment:",d)}await oe()}catch(d){console.error("Error generating new QR:",d),i("Error al generar nuevo código QR: "+d.message)}finally{c(!1)}},T=async()=>{if(!p?.payment_id){i("No hay un pago activo para simular");return}D(!0),i("");try{console.log("🧪 Simulating payment success for testing purposes");const d=await ee.simulatePaymentSuccess(p.payment_id,p.amount,a?.email);if(d.success)console.log("✅ Payment simulation successful:",d),S("completed"),x(!1),F.current?.cancel&&(F.current.cancel(),F.current=null),t&&t({...p,status:"completed",completed_at:new Date().toISOString(),simulated:!0});else throw new Error(d.message||"Simulation failed")}catch(d){console.error("❌ Error simulating payment:",d),i("Error simulando el pago: "+d.message)}finally{D(!1)}},j=()=>{if(!_)return null;const d=ee.getStatusDisplay(_);return e.jsxs("div",{className:`flex items-center justify-center p-3 rounded-lg mb-4 ${d.color==="green"?"bg-green-50 text-green-700":d.color==="red"?"bg-red-50 text-red-700":d.color==="yellow"?"bg-yellow-50 text-yellow-700":"bg-blue-50 text-blue-700"}`,children:[e.jsx("span",{className:"mr-2",children:d.icon}),e.jsx("span",{className:"font-medium",children:d.label}),m&&d.color==="yellow"&&e.jsx(ie,{className:"w-4 h-4 ml-2 animate-spin"})]})};return p?e.jsxs("div",{className:"space-y-6",children:[e.jsx(j,{}),m&&e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"inline-flex items-center bg-blue-50 text-blue-700 px-4 py-2 rounded-lg",children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"font-mono text-lg",children:se(w)})]}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Tiempo restante para completar el pago"})]}),p.qr_code_base64&&!["cancelled","failed"].includes(_)?e.jsx("div",{className:"mb-4 mx-auto",children:e.jsxs("div",{className:"bg-[#2fd8a8] p-6 rounded-lg text-white",children:[e.jsx("div",{className:"w-24 h-24 mx-auto mb-4 bg-white rounded-full flex items-center justify-center",children:e.jsx("img",{src:"https://deuna.app/assets/img/brand/logo-deuna.svg",alt:"DeUna Logo",className:"w-20 h-20"})}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Pago con Deuna"}),e.jsxs("p",{className:"text-purple-100 mb-4",children:["Monto a pagar: ",G(z)]}),e.jsx("div",{className:"bg-white rounded-lg p-4 mb-4",children:e.jsx("img",{src:p.qr_code_base64,alt:"Código QR para pago",className:"w-full h-auto max-w-64 mx-auto"})}),e.jsxs("p",{className:"text-purple-100 text-sm mb-4 flex items-center justify-center",children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"Escanea con tu app Deuna"]}),e.jsx("button",{onClick:C,className:"bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-4 rounded-md transition-colors",disabled:!m||_==="completed",children:m?"Cancelar Pago":"Cerrar"})]})}):["cancelled","failed"].includes(_)&&e.jsx("div",{className:"mb-4 mx-auto",children:e.jsxs("div",{className:"bg-gray-100 border-2 border-gray-300 p-6 rounded-lg text-center",children:[e.jsx("div",{className:"w-24 h-24 mx-auto mb-4 bg-gray-300 rounded-full flex items-center justify-center",children:e.jsx(ge,{className:"w-12 h-12 text-gray-500"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-700 mb-2",children:_==="cancelled"?"Pago Cancelado":"Pago Fallido"}),e.jsx("p",{className:"text-gray-600 mb-4",children:_==="cancelled"?"El pago fue cancelado. Puedes generar un nuevo código QR.":"El pago falló. Puedes intentar generar un nuevo código QR."})]})}),p.payment_url&&!["cancelled","failed"].includes(_)&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("input",{type:"text",value:p.payment_url,readOnly:!0,className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"}),e.jsxs("button",{onClick:()=>K(p.payment_url),className:"px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx($e,{className:"w-4 h-4 mr-1"}),$?"Copiado!":"Copiar"]})]}),e.jsxs("a",{href:p.payment_url,target:"_blank",rel:"noopener noreferrer",className:"w-full bg-[#3f2b57] hover:bg-[#3f2b45] text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx(Le,{className:"w-4 h-4 mr-2"}),"Abrir enlace de pago"]})]}),p.numeric_code&&!["cancelled","failed"].includes(_)&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Código numérico:"}),e.jsx("p",{className:"text-2xl font-mono font-bold text-gray-900 tracking-wider",children:p.numeric_code})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-lg font-semibold text-gray-900",children:["Monto a pagar: ",G(z)]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["ID de Pago: ",p.payment_id]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("button",{onClick:h,disabled:r,className:"flex-1 bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:r?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-4 h-4 mr-2 animate-spin"}),"Generando..."]}):"Generar Nuevo QR"}),ee.isDevelopmentMode()&&m&&!["completed","cancelled","failed"].includes(_)&&e.jsx("button",{onClick:T,disabled:L,className:"flex-1 bg-orange-500 hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:L?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-4 h-4 mr-2 animate-spin"}),"Simulando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ue,{className:"w-4 h-4 mr-2"}),"🧪 Simular Pago"]})}),_==="completed"&&e.jsxs("button",{onClick:()=>t&&t(p),className:"flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"Continuar"]})]}),f&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ge,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("p",{className:"text-red-700",children:f})]})}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Instrucciones:"}),e.jsxs("ol",{className:"text-sm text-blue-800 space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"1."})," Escanea el código QR con tu app de pagos"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"2."})," O usa el enlace de pago en tu dispositivo móvil"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"3."})," Completa el pago en la aplicación"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"4."})," Espera la confirmación automática"]})]}),ee.isDevelopmentMode()&&m&&e.jsx("div",{className:"mt-3 pt-3 border-t border-blue-300",children:e.jsxs("p",{className:"text-xs text-orange-700 bg-orange-50 p-2 rounded",children:["🧪 ",e.jsx("strong",{children:"Modo de desarrollo:"}),' Puedes usar el botón "Simular Pago" para testear el flujo completo sin necesidad de realizar un pago real.']})})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"mb-4 text-center text-gray-600",children:"Paga con DeUna!, Genera el código qr y escanealo desde tu app para pagar de forma rápida y segura."}),e.jsx("div",{className:"bg-[#2fd8a8] border-purple-200 rounded-lg p-6",children:e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx("img",{src:"https://deuna.app/assets/img/brand/logo-deuna.svg",alt:"DeUna Logo",className:"w-50 h-50"})})}),e.jsx("button",{type:"button",onClick:oe,disabled:r||!a||!s?.items?.length,className:"w-full bg-[#3f2b57] hover:bg-[#342843] disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-101 disabled:transform-none flex items-center justify-center",children:r?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-5 h-5 mr-2 animate-spin"}),"Generando código QR..."]}):`Pagar con DeUna! - ${G(z)}`}),f&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ge,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("p",{className:"text-red-700",children:f})]})}),e.jsxs("div",{className:"mt-4 text-sm text-center text-gray-500",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"1."}),' Haz clic en "Pagar con DeUna!"']}),e.jsxs("p",{children:[e.jsx("strong",{children:"2."})," Completa el pago con el QR"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"3."})," Confirma tu compra al finalizar."]})]})]})},Se=({title:y,address:t,onAddressChange:o,errors:s})=>{const a=y.replace(/\s+/g,"-").toLowerCase();return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:y}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`name-${a}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre Completo *"}),e.jsx("input",{type:"text",id:`name-${a}`,value:t.name||"",onChange:r=>o("name",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${s.name?"border-red-500":"border-gray-300"}`,placeholder:"Nombre y Apellido"}),s.name&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:s.name})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`street-${a}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Dirección / Calle Principal *"}),e.jsx("input",{type:"text",id:`street-${a}`,value:t.street||"",onChange:r=>o("street",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${s.street?"border-red-500":"border-gray-300"}`,placeholder:"Calle, número, piso, etc."}),s.street&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:s.street})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`city-${a}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Ciudad *"}),e.jsx("input",{type:"text",id:`city-${a}`,value:t.city||"",onChange:r=>o("city",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${s.city?"border-red-500":"border-gray-300"}`,placeholder:"Ciudad"}),s.city&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:s.city})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`state-${a}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Provincia/Estado *"}),e.jsx("input",{type:"text",id:`state-${a}`,value:t.state||"",onChange:r=>o("state",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${s.state?"border-red-500":"border-gray-300"}`,placeholder:"Provincia o Estado"}),s.state&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:s.state})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`postalCode-${a}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Código Postal *"}),e.jsx("input",{type:"text",id:`postalCode-${a}`,value:t.postalCode||"",onChange:r=>o("postalCode",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${s.postalCode?"border-red-500":"border-gray-300"}`,placeholder:"Código Postal"}),s.postalCode&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:s.postalCode})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`country-${a}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"País *"}),e.jsx("input",{type:"text",id:`country-${a}`,value:t.country||"",onChange:r=>o("country",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${s.country?"border-red-500":"border-gray-300"}`,placeholder:"País"}),s.country&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:s.country})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`phone-${a}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Teléfono *"}),e.jsx("input",{type:"tel",id:`phone-${a}`,value:t.phone||"",onChange:r=>o("phone",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${s.phone?"border-red-500":"border-gray-300"}`,placeholder:"Número de teléfono"}),s.phone&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:s.phone})]})]})]})},Xe=()=>{const y=be(),{cart:t,clearCart:o,showNotification:s,appliedDiscount:a}=he(),r=new re,[c,p]=g.useState(!1),b=async()=>{if(console.log("🧪 TestCheckoutButton.handleTestCheckout INICIADO"),!t||t.items.length===0){console.log("❌ Carrito vacío, abortando checkout"),s(A.ERROR,"El carrito está vacío");return}console.log("🛒 ANÁLISIS COMPLETO DEL CARRITO ANTES DEL CHECKOUT:"),console.log("📊 Cart completo:",JSON.stringify(t,null,2)),console.log("📊 Total de items en carrito:",t.items.length),console.log("📊 Total del carrito:",t.total),console.log("🔍 ANÁLISIS ITEM POR ITEM:"),t.items.forEach((i,m)=>{console.log(`📋 Item ${m+1}:`,{id:i.id,productId:i.productId,quantity:i.quantity,price:i.price,product:i.product?{id:i.product.id,name:i.product.name,price:i.product.price,sellerId:i.product.sellerId,seller_id:i.product.seller_id,user_id:i.product.user_id}:null,completeItem:i})}),console.log("🔍 VERIFICANDO DUPLICADOS EN EL CARRITO:");const f=t.items.reduce((i,m,x)=>(i[m.productId]||(i[m.productId]=[]),i[m.productId].push({index:x,item:m}),i),{});console.log("📊 Items agrupados por productId:",f),Object.keys(f).forEach(i=>{const m=f[i];m.length>1?(console.warn(`⚠️ DUPLICADO EN CARRITO DETECTADO para productId ${i}:`),console.warn(`❌ Se encontraron ${m.length} items para el mismo producto`),m.forEach((x,_)=>{console.warn(`   ${_+1}. Item[${x.index}]:`,x.item)})):console.log(`✅ Producto ${i}: Sin duplicados (${m[0].item.quantity} unidades)`)}),p(!0);try{const i=re.getSellerIdFromCart(t);console.log("🏪 Seller ID obtenido para test:",i);const m=t.items.map(S=>{let w=0;return S.product?.final_price&&S.product.final_price>0?w=S.product.final_price:S.product?.price&&S.product.price>0?w=S.product.price:S.price&&S.price>0?w=S.price:S.subtotal&&S.quantity>0?w=S.subtotal/S.quantity:(console.warn(`⚠️ No se pudo determinar precio para producto ${S.productId}, usando 1.00`),w=1),{product_id:S.productId,quantity:S.quantity,price:w}});console.log("🛒 Items formateados para backend:",JSON.stringify(m,null,2));const x={payment:{method:"credit_card",card_number:"4111111111111111",card_expiry:"12/25",card_cvc:"123"},shippingAddress:{name:"Test User",street:"Calle de Prueba 123",city:"Ciudad de Prueba",state:"Estado de Prueba",postalCode:"12345",country:"País de Prueba",phone:"123456789"},seller_id:i||void 0,items:m,discount_code:a?.discountCode?.code||null,discount_info:a||null};console.log("📦 Datos completos de checkout de prueba:",JSON.stringify(x,null,2)),console.log("🚀 Enviando checkout al backend...");const _=await r.processCheckout(x);if(console.log("✅ Respuesta del checkout recibida:",_),_.status==="success"){if(console.log("🎉 Checkout exitoso, limpiando carrito..."),o(),s(A.SUCCESS,"¡Pedido de prueba completado con éxito!"),console.log("📊 Detalles COMPLETOS de la orden:",JSON.stringify(_.data,null,2)),_.data&&typeof _.data=="object"){const S=_.data;console.log("🔍 ANÁLISIS DE LA ORDEN CREADA:"),console.log("📊 Order ID:",S.order_id),console.log("📊 Order Number:",S.order_number),console.log("📊 Total:",S.total),S.items&&(console.log("📊 Items en la orden creada:",S.items.length),S.items.forEach((w,V)=>{console.log(`📋 Order Item ${V+1}:`,{id:w.id,product_id:w.product_id,product_name:w.product_name,quantity:w.quantity,price:w.price})}))}y("/orders")}else throw new Error(_.message||"Error en el checkout de prueba")}catch(i){console.error("❌ Error COMPLETO en el checkout de prueba:"),console.error("📊 Error object:",i),console.error("📊 Error stack:",i?.stack);const m=ne(i,"Error en el checkout de prueba. Por favor, intenta de nuevo más tarde.");console.error("📊 Error message final:",m),s(A.ERROR,m)}finally{p(!1),console.log("🧪 TestCheckoutButton.handleTestCheckout FINALIZADO")}};return e.jsxs("button",{onClick:b,disabled:c,className:"px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors flex items-center disabled:opacity-50",children:[c?e.jsx("span",{className:"inline-block h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}):null,"Prueba rápida de checkout"]})};class et{async createCheckout(t){try{console.log("DatafastService: Creando checkout",t);const o=await J.post(X.DATAFAST.CREATE_CHECKOUT,t);return console.log("DatafastService: Respuesta de checkout",o),o}catch(o){console.error("DatafastService: Error al crear checkout:",o);const s=ne(o,"Error al crear el checkout de Datafast");throw new Error(s)}}async verifyPayment(t){try{console.log("DatafastService: Verificando pago",t);const o=await J.post(X.DATAFAST.VERIFY_PAYMENT,t);return console.log("DatafastService: Respuesta de verificación",o),o}catch(o){console.error("DatafastService: Error al verificar pago:",o);const s=ne(o,"Error al verificar el pago de Datafast");throw new Error(s)}}async simulateSuccessfulPayment(t,o,s){if(!t)throw new Error("checkout_id es requerido para simular el pago");if(!o)throw new Error("transaction_id es requerido para simular el pago");const a=`/v1/checkouts/${t}/payment`;console.log("DatafastService: Simulando pago exitoso",{checkoutId:t,transactionId:o,mockResourcePath:a});try{const r={resource_path:a,transaction_id:o,calculated_total:s};console.log("🔄 Enviando datos de simulación:",r);const c=await J.post(X.DATAFAST.VERIFY_PAYMENT+"?simulate_success=true",r);return console.log("DatafastService: Respuesta de simulación:",c),c}catch(r){console.error("DatafastService: Error en simulación:",r);const c=ne(r,"Error al simular el pago de Datafast");throw new Error(c)}}async handleDatafastResult(t,o,s){try{console.log("DatafastService: Manejando resultado real de Datafast",{resourcePath:t,transactionId:o,calculatedTotal:s});const a=await this.verifyPayment({resource_path:t,transaction_id:o,calculated_total:s});return a.status!=="success"&&a.result_code==="800.900.300"?{success:!1,message:'No se completó un pago real. Este es el comportamiento esperado en Fase 1 de pruebas. Use "Simular Pago Exitoso" para probar el flujo completo.',result_code:a.result_code,is_phase_1_error:!0}:a}catch(a){console.error("DatafastService: Error al manejar resultado:",a);const r=ne(a,"Error al procesar el resultado de Datafast");throw new Error(r)}}extractResourcePath(t){try{const s=new URLSearchParams(t.split("?")[1]).get("resourcePath");return console.log("DatafastService: ResourcePath extraído:",s),s}catch(o){return console.error("DatafastService: Error al extraer resourcePath:",o),null}}}const tt=({onSuccess:y,onError:t})=>{const o=be(),{cart:s,clearCart:a,showNotification:r,appliedDiscount:c}=he(),{user:p}=Ee(),[b,f]=g.useState(!1),[i,m]=g.useState(!1),[x,_]=g.useState(null),[S,w]=g.useState(!1),[V,$]=g.useState(!1),[B,L]=g.useState(null),[D,F]=g.useState({address:"Av. Test 123",city:"Quito",country:"EC",given_name:"Juan",middle_name:"Carlos",surname:"Pérez",phone:"0999999999",doc_id:"1234567890"}),H=new et,Z=new re;g.useEffect(()=>()=>{const C=document.getElementById("datafast-widget-script");C&&C.remove()},[]);const z=(C,h)=>{F(T=>({...T,[C]:h}))},M=()=>{const C=["address","city","country","given_name","surname","phone","doc_id"];for(const h of C)if(!D[h]||D[h].trim()==="")return r(A.ERROR,`El campo ${h.replace("_"," ")} es obligatorio`),!1;return D.doc_id.length!==10||!/^\d+$/.test(D.doc_id)?(r(A.ERROR,"La cédula debe tener exactamente 10 dígitos"),!1):!0},K=async()=>{if(!s||s.items.length===0){r(A.ERROR,"El carrito está vacío");return}if(M()){f(!0);try{const C=await Y.prepareItemsForCheckout(s.items),h=await Y.calculateCheckoutTotals(s.items,c);L(h),console.log("💰 Totales calculados para Datafast:",h),console.log("🛒 Items para Datafast (preparados como Prueba Completa):",C);const T={shipping:{address:D.address,city:D.city,country:D.country.toUpperCase()},customer:{given_name:D.given_name,middle_name:D.middle_name,surname:D.surname,phone:D.phone,doc_id:D.doc_id},items:C,total:h.total,subtotal:h.subtotal,shipping_cost:h.shipping,tax:h.tax,discount_code:c?.discountCode.code||null,discount_info:c||null};console.log("Iniciando checkout con Datafast...",T),console.log("💰 Total enviado a Datafast: $",h.total);const j=await H.createCheckout(T);if(console.log("Respuesta del checkout:",j),j.status==="success"&&j.data)_(j.data),w(!1),m(!0),localStorage.setItem("datafast_transaction_id",j.data.transaction_id),localStorage.setItem("datafast_checkout_id",j.data.checkout_id),localStorage.setItem("datafast_calculated_total",h.total.toString()),r(A.SUCCESS,"Checkout creado. Preparando formulario de pago..."),setTimeout(()=>{j.data?se(j.data.checkout_id):r(A.ERROR,"Datos de checkout no disponibles")},100);else throw new Error(j.message||"Error al crear checkout")}catch(C){console.error("Error al iniciar pago con Datafast:",C);const h=C instanceof Error?C.message:"Error desconocido";r(A.ERROR,h),t?.(h)}finally{f(!1)}}},se=C=>{try{console.log("Cargando widget de Datafast...",C);const h=document.getElementById("datafast-widget-script");h&&h.remove(),window.wpwlOptions={onReady:function(){console.log("✅ Widget de Datafast listo!"),$(!0),r(A.SUCCESS,"Formulario de pago cargado correctamente.")},onBeforeSubmitCard:function(d){console.log("🔄 Widget Datafast: Usuario hizo clic en Pagar, procesando..."),console.log("🔍 Datos de la tarjeta que se están enviando:",d),r(A.INFO,"Procesando pago con Datafast...")},onAfterSubmitCard:function(d){console.log("⏳ Widget Datafast: Datos enviados, esperando respuesta..."),console.log("📤 Respuesta después del envío:",d)},onLoadThreeDSecure:function(){console.log("🔐 Widget Datafast: Cargando 3D Secure...")},onBeforeRedirectToResult:function(d){console.log("🔄 Widget Datafast: Redirigiendo a página de resultado..."),console.log("🔗 Datos de redirección:",d)},onChangeBrand:function(d){console.log("💳 Widget Datafast: Marca de tarjeta detectada:",d.brand),console.log("💳 Datos completos del evento:",d)},onError:function(d){console.error("❌ Widget Datafast: Error en el pago",d),console.error("❌ Detalles completos del error:",{message:d.message,code:d.code,name:d.name,full:d}),r(A.ERROR,"Error al procesar el pago: "+(d.message||d.code||"Error desconocido"))},onSubmit:function(d){console.log("📋 Widget Datafast: Formulario enviado"),console.log("📋 Datos del formulario:",d)},style:"card",locale:"es",labels:{cvv:"CVV",cardHolder:"Nombre (igual que en la tarjeta)"}};const T=document.createElement("script");T.src="https://www.datafast.com.ec/js/dfAdditionalValidations1.js",T.async=!0,document.head.appendChild(T);const j=document.createElement("script");j.id="datafast-widget-script",j.src=x?.widget_url||`https://eu-test.oppwa.com/v1/paymentWidgets.js?checkoutId=${C}`,j.async=!0,j.onload=()=>{console.log("Script de widget cargado")},j.onerror=()=>{console.error("Error al cargar script del widget"),r(A.ERROR,"Error al cargar el formulario de pago")},document.head.appendChild(j)}catch(h){console.error("Error al configurar widget:",h),r(A.ERROR,"Error al configurar el formulario de pago")}},W=async()=>{if(console.log("🧪 DatafastPaymentButton.handleCompleteTestCheckout INICIADO"),!s||s.items.length===0){console.log("❌ Carrito vacío o null, abortando checkout"),r(A.ERROR,"El carrito está vacío");return}if(!M()){console.log("❌ Validación de formulario falló");return}console.log("🛒 ANÁLISIS COMPLETO DEL CARRITO ANTES DEL CHECKOUT (DATAFAST):"),console.log("📊 Cart completo:",JSON.stringify(s,null,2)),console.log("📊 Total de items en carrito:",s.items.length),console.log("📊 Total del carrito:",s.total),s.items.forEach((h,T)=>{console.log(`📋 Item ${T+1}:`,{id:h.id,productId:h.productId,quantity:h.quantity,price:h.price,subtotal:h.subtotal,product:h.product?{id:h.product.id,name:h.product.name,price:h.product.price,final_price:h.product.final_price,sellerId:h.product.sellerId,seller_id:h.product.seller_id,user_id:h.product.user_id}:null,completeItem:h})}),console.log("🔍 VERIFICANDO DUPLICADOS EN EL CARRITO (DATAFAST):");const C=s.items.reduce((h,T,j)=>(h[T.productId]||(h[T.productId]=[]),h[T.productId].push({index:j,item:T}),h),{});console.log("📊 Items agrupados por productId:",C),Object.keys(C).forEach(h=>{const T=C[h];T.length>1?(console.warn(`⚠️ DUPLICADO EN CARRITO DETECTADO para productId ${h}:`),console.warn(`❌ Se encontraron ${T.length} items para el mismo producto`),T.forEach((j,d)=>{console.warn(`   ${d+1}. Item[${j.index}]:`,j.item)})):console.log(`✅ Producto ${h}: Sin duplicados (${T[0].item.quantity} unidades)`)}),f(!0);try{console.log("🚀 Iniciando checkout de prueba completo (DATAFAST)...");const h=s?re.getSellerIdFromCart(s):null;console.log("🏪 Seller ID obtenido (DATAFAST):",h);const T=await Y.prepareItemsForCheckout(s.items);console.log("🛒 Items formateados con descuentos aplicados (DATAFAST):",JSON.stringify(T,null,2)),console.log("🔍 DEBUG: cart.items antes de calcular:",s.items),console.log("🔍 DEBUG: appliedDiscount antes de calcular:",c);const j=await Y.calculateCheckoutTotals(s.items,c);console.log("💰 Totales calculados para backend (DATAFAST):",j),console.log("🔍 DEBUG: calculatedTotals es null?",j===null),console.log("🔍 DEBUG: calculatedTotals es undefined?",j===void 0),console.log("🔍 DEBUG: tipo de calculatedTotals:",typeof j),console.log("🛒 Items formateados para backend (DATAFAST):",JSON.stringify(T,null,2));const d={payment:{method:"datafast"},shippingAddress:{name:D.given_name+" "+D.surname,street:D.address||"Calle de Prueba 123",city:D.city||"Quito",state:D.country||"Pichincha",postalCode:"170000",country:D.country||"Ecuador",phone:D.phone||"0999999999"},seller_id:h||void 0,items:T,calculated_totals:{subtotal:j?.subtotal||0,tax:j?.tax||0,shipping:j?.shipping||0,total:j?.total||0,total_discounts:j?.totalDiscounts||0},discount_code:c?.discountCode.code||null,discount_info:c||null};console.log("📦 Datos completos de checkout (DATAFAST):",JSON.stringify(d,null,2)),console.log("🔍 DEBUG: testCheckoutData.calculated_totals:",d.calculated_totals),console.log("🔍 DEBUG: Estructura del objeto calculated_totals:"),console.log("   - subtotal:",d.calculated_totals.subtotal),console.log("   - tax:",d.calculated_totals.tax),console.log("   - shipping:",d.calculated_totals.shipping),console.log("   - total:",d.calculated_totals.total),console.log("   - total_discounts:",d.calculated_totals.total_discounts),console.log("🔄 PRUEBA COMPLETA DATAFAST: Usando handleStartPayment + simulación automática"),await K(),setTimeout(async()=>{try{const k=localStorage.getItem("datafast_transaction_id"),U=localStorage.getItem("datafast_checkout_id");if(!k)throw new Error("No se encontró transaction_id para simular pago");if(!U)throw new Error("No se encontró checkout_id para simular pago");console.log("🎯 Simulando pago exitoso automáticamente con:",{checkoutId:U,transactionId:k,total:j.total});const I=await H.simulateSuccessfulPayment(U,k,j.total);if(console.log("✅ Respuesta de simulación DATAFAST:",I),I.status==="success"){if(console.log("🎉 Simulación exitosa - orden DATAFAST creada, limpiando carrito..."),a(),m(!1),w(!1),r(A.SUCCESS,"¡Pedido de prueba DATAFAST completado con éxito!"),console.log("📊 Detalles COMPLETOS de la orden DATAFAST:",JSON.stringify(I.data,null,2)),I.data&&typeof I.data=="object"){const Q=I.data;console.log("🔍 ANÁLISIS DE LA ORDEN CREADA (DATAFAST):"),console.log("📊 Order ID:",Q.order_id),console.log("📊 Order Number:",Q.order_number),console.log("📊 Total:",Q.total),Q.items&&(console.log("📊 Items en la orden creada:",Q.items?.length),Q.items?.forEach((u,l)=>{console.log(`📋 Order Item ${l+1}:`,{id:u.id,product_id:u.product_id,product_name:u.product_name,quantity:u.quantity,price:u.price})}))}y?.(I.data),o("/orders")}else throw new Error(I.message||"Error en simulación de pago DATAFAST")}catch(k){console.error("❌ Error en simulación automática:",k),r(A.ERROR,"Error en simulación automática de pago")}},2e3);return}catch(h){console.error("❌ Error COMPLETO en el checkout de prueba (DATAFAST):"),console.error("📊 Error object:",h),console.error("📊 Error stack:",h?.stack);const T=h instanceof Error?h.message:"Error al procesar el checkout de prueba";console.error("📊 Error message final:",T),r(A.ERROR,T),t?.(T)}finally{f(!1),console.log("🧪 DatafastPaymentButton.handleCompleteTestCheckout FINALIZADO")}},oe=async()=>{if(!x){r(A.ERROR,"No hay datos de checkout");return}f(!0);try{console.log("Simulando pago exitoso completo...");const C=s?await Y.calculateCheckoutTotals(s.items,c):null,h=await H.simulateSuccessfulPayment(x.checkout_id,x.transaction_id,C?.total||0);if(console.log("Respuesta de verificación Datafast:",h),h.success&&h.data){console.log("Procesando checkout completo en el sistema...");const T=s?re.getSellerIdFromCart(s):null;console.log("Seller ID obtenido:",T);const j=s?await Y.prepareItemsForCheckout(s.items):[];console.log("🔍 DEBUG SIMULATE: cart.items antes de calcular:",s?.items),console.log("🔍 DEBUG SIMULATE: appliedDiscount antes de calcular:",c);const d=s?await Y.calculateCheckoutTotals(s.items,c):null;console.log("💰 DEBUG SIMULATE: Totales calculados:",d),console.log("🔍 DEBUG SIMULATE: calculatedTotals es null?",d===null),console.log("🔍 DEBUG SIMULATE: calculatedTotals es undefined?",d===void 0);const k={payment:{method:"datafast"},shippingAddress:{name:D.given_name+" "+D.surname,street:D.address,city:D.city,state:D.country,postalCode:"00000",country:D.country,phone:D.phone},seller_id:T||void 0,items:j,calculated_totals:d?{subtotal:d.subtotal,tax:d.tax,shipping:d.shipping,total:d.total,total_discounts:d.totalDiscounts}:void 0},U=await Z.processCheckout(k,p?.email);if(console.log("Respuesta del checkout completo:",U),U.status==="success")a(),m(!1),r(A.SUCCESS,"¡Pago y pedido completados exitosamente!"),console.log("Detalles completos de la orden:",{datafast:h.data,checkout:U.data}),y?.(U.data),o("/orders");else throw new Error(U.message||"Error al procesar el checkout completo")}else throw new Error(h.message||"Error en la simulación de Datafast")}catch(C){console.error("Error en la simulación completa:",C);const h=C instanceof Error?C.message:"Error al procesar la simulación completa";r(A.ERROR,h),t?.(h)}finally{f(!1)}},N=async()=>{if(!x){r(A.ERROR,"No hay datos de checkout disponibles");return}try{f(!0);const C=s?await Y.calculateCheckoutTotals(s.items,c):null;C&&(localStorage.setItem("datafast_calculated_total",C.total.toString()),console.log("💰 Total calculado guardado para verificación:",C.total)),localStorage.setItem("datafast_cart_backup",JSON.stringify(s)),window.wpwlOptions={onReady:function(){console.log("🎯 Widget Datafast listo para pago real"),r(A.INFO,"Complete los datos de su tarjeta en el formulario y haga clic en 'Pagar'.")},onSuccess:function(h){console.log("🎉 Pago real exitoso:",h),window.location.href=`/datafast-result?resourcePath=${encodeURIComponent(h.resourcePath)}`},onError:function(h){console.error("❌ Error en pago real:",h),f(!1),r(A.ERROR,"Error al procesar el pago. Inténtelo nuevamente.")}},console.log("🔄 Configuración lista para pago real con Datafast")}catch(C){console.error("❌ Error configurando pago real:",C),f(!1),r(A.ERROR,"Error al configurar el pago real")}};return i?e.jsx("div",{className:"datafast-payment-widget",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Pagar con Datafast"}),e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-blue-800",children:"Información del pedido:"}),e.jsxs("p",{className:"text-blue-700",children:["Monto: $",B?.total?.toFixed(2)||x?.amount||s?.total]}),e.jsxs("p",{className:"text-blue-700",children:["ID: ",x?.transaction_id]})]}),e.jsx("div",{className:"min-h-[400px] border border-gray-200 rounded-lg p-4",children:e.jsx("form",{action:"http://localhost:8000/datafast-result",className:"paymentWidgets","data-brands":"VISA MASTER AMEX DINERS DISCOVER",children:!V&&e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"Cargando formulario de pago..."})]})})})}),e.jsxs("div",{className:"mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-yellow-800 mb-2",children:"Datos de prueba para usar:"}),e.jsxs("div",{className:"text-sm text-yellow-700 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Tarjeta VISA:"})," 4200 0000 0000 0000"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fecha:"})," 07/26"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"CVV:"})," 246"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Titular:"})," ",D.given_name," ",D.surname]}),e.jsxs("p",{className:"text-xs mt-2 text-blue-600",children:[e.jsx("strong",{children:"Fase 2:"})," Credenciales de testing avanzado con transacciones reales limitadas"]})]})]}),e.jsxs("div",{className:"mt-6 space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx("button",{onClick:N,disabled:!V,className:"bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-md transition-colors disabled:opacity-50",children:"Pago Real"}),e.jsx("button",{onClick:oe,disabled:b,className:"bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-md transition-colors disabled:opacity-50",children:b?"Verificando...":"Simular Pago Exitoso"})]}),e.jsxs("div",{className:"border-t pt-4",children:[e.jsx("button",{onClick:W,disabled:b,className:"w-full bg-yellow-500 hover:bg-yellow-600 text-white font-medium py-3 px-4 rounded-md transition-colors disabled:opacity-50 flex items-center justify-center",children:b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Procesando..."]}):e.jsxs(e.Fragment,{children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"})}),"Prueba Completa de Checkout"]})}),e.jsx("p",{className:"text-xs text-gray-500 text-center mt-2",children:"Simula el proceso completo de checkout como el botón de prueba original"})]}),e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:()=>{m(!1),w(!0),$(!1);const C=document.getElementById("datafast-widget-script");C&&C.remove()},disabled:b,className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors",children:"Volver"})})]})]})}):S?e.jsx("div",{className:"datafast-form",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Información para Datafast"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre *"}),e.jsx("input",{type:"text",value:D.given_name,onChange:C=>z("given_name",C.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Segundo Nombre"}),e.jsx("input",{type:"text",value:D.middle_name,onChange:C=>z("middle_name",C.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Apellido *"}),e.jsx("input",{type:"text",value:D.surname,onChange:C=>z("surname",C.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Teléfono *"}),e.jsx("input",{type:"text",value:D.phone,onChange:C=>z("phone",C.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",placeholder:"0999999999"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cédula/ID * (10 dígitos)"}),e.jsx("input",{type:"text",value:D.doc_id,onChange:C=>{const h=C.target.value.replace(/\D/g,"").slice(0,10);z("doc_id",h)},className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",placeholder:"1234567890",maxLength:10})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Dirección *"}),e.jsx("input",{type:"text",value:D.address,onChange:C=>z("address",C.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ciudad *"}),e.jsx("input",{type:"text",value:D.city,onChange:C=>z("city",C.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"País *"}),e.jsxs("select",{value:D.country,onChange:C=>z("country",C.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",children:[e.jsx("option",{value:"EC",children:"Ecuador"}),e.jsx("option",{value:"CO",children:"Colombia"}),e.jsx("option",{value:"PE",children:"Perú"}),e.jsx("option",{value:"US",children:"Estados Unidos"})]})]})]}),e.jsxs("div",{className:"mt-6 flex gap-4",children:[e.jsx("button",{onClick:K,disabled:b,className:"flex-1 bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-md transition-colors disabled:opacity-50 flex items-center justify-center",children:b?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Creando checkout..."]}):"Continuar con Datafast"}),e.jsx("button",{onClick:()=>w(!1),disabled:b,className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors",children:"Cancelar"})]})]})}):e.jsxs("div",{className:"datafast-payment-button",children:[e.jsxs("button",{onClick:()=>w(!0),disabled:b||!s||s.items.length===0,className:"w-full transition-all duration-200 transform hover:scale-101 bg-[#003c58] border-1 hover:bg-[#00B86E] text-white font-medium py-3 px-4 rounded-md disabled:opacity-50 flex items-center justify-center",children:[e.jsx("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"})}),"Pagar con Datafast"]}),(!s||s.items.length===0)&&e.jsx("p",{className:"mt-2 text-sm text-gray-500 text-center",children:"Agrega productos al carrito para continuar"})]})},ot=()=>{const y=be(),{cart:t,clearCart:o,showNotification:s,appliedDiscount:a}=he(),{user:r}=Ee(),[c,p]=g.useState(!1),b={name:"",street:"",city:"",state:"",postalCode:"",country:"Ecuador",phone:""},{handleSuccess:f,handleError:i}=He({showNotification:s,context:"CheckoutPage"}),[m,x]=g.useState("credit_card"),[_,S]=g.useState(b),[w,V]=g.useState(b),[$,B]=g.useState(!0),[L,D]=g.useState({method:"credit_card",card_number:"",card_expiry:"",card_cvc:""}),[F,H]=g.useState({}),[Z,z]=g.useState(!1),[M,K]=g.useState(null),[se,W]=g.useState(8),oe=new re,[N,C]=g.useState({items:[],totals:{subtotal:0,originalSubtotal:0,sellerDiscounts:0,volumeDiscounts:0,totalDiscounts:0,couponDiscount:0,tax:0,shipping:0,total:0,freeShipping:!1},stockIssues:[],checkoutItems:[]});g.useEffect(()=>{(async()=>{if(!t?.items?.length){C({items:[],totals:{subtotal:0,originalSubtotal:0,sellerDiscounts:0,volumeDiscounts:0,totalDiscounts:0,couponDiscount:0,tax:0,shipping:0,total:0,freeShipping:!1},stockIssues:[],checkoutItems:[]});return}console.log("🔄 CheckoutPage: Calculando descuentos con configuración dinámica");const E=await Promise.all(t.items.map(async q=>{const Ce=await Qe(q),ve=q.product?.stockAvailable||q.product?.stock||0,Ae=q.quantity>ve||!q.product?.is_in_stock;return{...q,discount:Ce,itemTotal:Ce.finalPricePerUnit*q.quantity,availableStock:ve,hasStockIssue:Ae}}));console.log("✅ CheckoutPage: Descuentos calculados para",E.length,"items");const R=E.filter(q=>q.hasStockIssue).map(q=>({productName:q.product?.name||"Producto",requested:q.quantity,available:q.availableStock,isOutOfStock:!q.product?.is_in_stock}));console.log("🔍 FLUJO CHECKOUT - Calculando totales"),console.log("📊 Items en checkout:",t.items.length),console.log("📊 Cupón en checkout:",a?.discountCode?.code||"NINGUNO");const P=await Y.calculateCheckoutTotals(t.items,a,!0);console.log("🎯 TOTAL CHECKOUT:",P.total);const v=await Y.prepareItemsForCheckout(t.items,a,!0);C({items:E,totals:P,stockIssues:R,checkoutItems:v})})()},[t?.items,t?.total,t?.subtotal,a]);const h=n=>typeof n.stockAvailable=="number"?n.stockAvailable:typeof n.stock=="number"?n.stock:0,T=()=>{if(!t?.items)return{valid:!0,errors:[]};const n=[];return t.items.forEach(E=>{const R=h(E.product);E.product?.is_in_stock?E.quantity>R&&n.push(`${E.product?.name||"Producto"}: solo hay ${R} unidades disponibles (solicitaste ${E.quantity})`):n.push(`${E.product?.name||"Producto"} está agotado`)}),{valid:n.length===0,errors:n}};g.useEffect(()=>{if(r){const n={name:`${r.name}`,street:r.address||"",city:r.city||"",state:r.state||r.province||"",postalCode:r.postal_code||r.zip_code||"",country:r.country||"Ecuador",phone:r.phone||""};S(n),V(n)}},[r]);const j=n=>{console.log("Pago exitoso:",n)},d=n=>{console.error("Error:",n)};g.useEffect(()=>{if(Z&&M){console.log("✅ Order complete - skipping cart validation to show receipt");return}if(!t||t.items.length===0){s(A.ERROR,"El carrito está vacío"),y("/cart");return}const n=T();n.valid||(console.warn("⚠️ Problemas de stock detectados:",n.errors),n.errors.length>0&&s(A.WARNING,`Problema de stock: ${n.errors[0]}`))},[t,y,s,Z,M]),g.useEffect(()=>{if(Z){W(8);const n=setInterval(()=>{W(E=>E<=1?(clearInterval(n),setTimeout(()=>{console.log("🔄 Auto-redirecting to orders page after 8 seconds"),y("/orders")},0),0):E-1)},1e3);return()=>clearInterval(n)}},[Z,y]);const k=n=>{x(n),D({...L,method:n==="deuna"?"transfer":"credit_card"})},U=(n,E)=>{const R={..._,[n]:E};S(R),$&&V(R)},I=(n,E)=>{V({...w,[n]:E})},Q=(n,E)=>{if(D({...L,[n]:E}),E.trim()&&F[n]){const R={...F};delete R[n],H(R)}},u=()=>{const n={},E=(R,P)=>{["name","street","city","state","postalCode","country","phone"].forEach(q=>{R[q]||(n[`${P}${q}`]=`El campo ${q.replace("_"," ")} es obligatorio`)})};return E(_,"shipping"),$||E(w,"billing"),m==="credit_card"&&(L.card_number?/^\d{16}$/.test(L.card_number||"")||(n.card_number="El número de tarjeta debe tener 16 dígitos"):n.card_number="El número de tarjeta es obligatorio",L.card_expiry?/^\d{2}\/\d{2}$/.test(L.card_expiry||"")||(n.card_expiry="El formato debe ser MM/YY"):n.card_expiry="La fecha de expiración es obligatoria",L.card_cvc?/^\d{3,4}$/.test(L.card_cvc||"")||(n.card_cvc="El código debe tener 3 o 4 dígitos"):n.card_cvc="El código de seguridad es obligatorio"),H(n),Object.keys(n).length===0},l=async()=>{console.log("🛒 CheckoutPage.processCheckout INICIADO CON DESCUENTOS POR VOLUMEN");const n=T();if(!n.valid){console.log("❌ Validación de stock falló:",n.errors),n.errors.forEach(E=>{s(A.ERROR,E)}),s(A.WARNING,"Por favor, ajusta las cantidades en tu carrito antes de continuar");return}if(!u()){console.log("❌ Validación de formulario falló"),s(A.ERROR,"Por favor, completa todos los campos obligatorios");return}console.log("🛒 ANÁLISIS COMPLETO DEL CARRITO CON DESCUENTOS POR VOLUMEN:"),console.log("📊 Totales calculados:",N.totals),console.log("📊 Items para checkout:",N.checkoutItems),p(!0);try{const E=re.getSellerIdFromCart(t),R={payment:{...L,method:m==="deuna"?"qr":m==="credit_card"?"credit_card":L.method},shippingAddress:_,billingAddress:$?_:w,seller_id:E||void 0,items:N.checkoutItems,discount_code:a?.discountCode?.code||null,discount_info:a||null,calculated_totals:{subtotal:N.totals.subtotal,tax:N.totals.tax,shipping:N.totals.shipping,total:N.totals.total,total_discounts:N.totals.totalDiscounts}};console.log("📦 Datos completos de checkout con descuentos por volumen:",JSON.stringify(R,null,2)),console.log("🚀 Enviando checkout al backend...");const P=await oe.processCheckout(R,r?.email);if(console.log("✅ Respuesta del checkout recibida:",P),P.status==="success"){console.log("🎉 Checkout exitoso con descuentos por volumen, limpiando carrito..."),z(!0),K(P.data);let v="¡Pedido completado con éxito!";if(N.totals.totalDiscounts>0&&(v+=` Has ahorrado ${G(N.totals.totalDiscounts)} con descuentos aplicados.`),f(v),o(),P.data&&typeof P.data=="object"){const q=P.data;console.log("🔍 ORDEN CREADA CON DESCUENTOS:"),console.log("📊 Order ID:",q.order_id),console.log("📊 Order Number:",q.order_number),console.log("📊 Total:",q.total),console.log("📊 Total Savings:",q.total_savings),console.log("📊 Volume Discounts Applied:",q.volume_discounts_applied)}}else throw new Error(P.message||"Error al procesar el pedido")}catch(E){console.error("❌ Error COMPLETO al procesar checkout con descuentos por volumen:"),console.error("📊 Error object:",E),console.error("📊 Error message:",E?.message),i(E,"Error al procesar el pago. Por favor, intenta de nuevo más tarde.")}finally{p(!1),console.log("🛒 CheckoutPage.processCheckout FINALIZADO")}},O=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"Resumen del pedido"}),N.stockIssues.length>0&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(Fe,{size:18,className:"text-red-600 mr-2 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-red-800 text-sm mb-2",children:"Problemas de stock detectados"}),e.jsx("div",{className:"space-y-1",children:N.stockIssues.map((n,E)=>e.jsxs("div",{className:"text-xs text-red-700",children:[e.jsxs("strong",{children:[n.productName,":"]})," ",n.isOutOfStock?"Producto agotado":`Solo ${n.available} disponibles (solicitaste ${n.requested})`]},E))}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{onClick:()=>y("/cart"),className:"text-xs text-red-600 underline hover:no-underline",children:"Ir al carrito para ajustar cantidades"})})]})]})}),N.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-green-800 text-sm",children:"¡Descuentos Aplicados!"}),e.jsxs("div",{className:"text-xs text-green-600 mt-1 space-y-1",children:[N.totals.sellerDiscounts>0&&e.jsxs("p",{children:["Descuentos del vendedor: ",G(N.totals.sellerDiscounts)]}),N.totals.volumeDiscounts>0&&e.jsxs("p",{children:["Descuentos por volumen: ",G(N.totals.volumeDiscounts)]})]})]}),e.jsx("div",{className:"text-lg font-bold text-green-600",children:G(N.totals.totalDiscounts)})]})}),e.jsx("div",{className:"space-y-3 mb-6",children:N.items.map((n,E)=>e.jsxs("div",{className:`flex items-center justify-between py-2 border-b border-gray-100 ${n.hasStockIssue?"bg-red-50 px-2 rounded":""}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h4",{className:`text-sm font-medium ${n.hasStockIssue?"text-red-900":"text-gray-900"}`,children:[n.product?.name||`Producto ${n.productId}`,n.hasStockIssue&&e.jsx("span",{className:"ml-2 text-xs text-red-600",children:"⚠️"})]}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:["Cantidad: ",n.quantity]}),n.discount.sellerDiscountAmount>0&&e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded flex items-center",children:[e.jsx(de,{size:10,className:"mr-1"}),"Seller: ",n.product?.discount_percentage||0,"% OFF"]}),n.discount.volumeDiscountAmount>0&&e.jsxs("span",{className:"text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded flex items-center",children:[e.jsx(_e,{size:10,className:"mr-1"}),"Volumen: ",n.discount.discountPercentage,"% OFF"]})]}),n.discount.hasDiscount&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Precio unitario: ",G(n.discount.finalPricePerUnit),e.jsx("span",{className:"line-through text-gray-400 ml-1",children:G(n.discount.originalPrice)}),n.discount.savingsTotal>0&&e.jsxs("span",{className:"text-green-600 ml-1",children:["(Ahorras: ",G(n.discount.savingsTotal),")"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("span",{className:`text-sm font-medium ${n.hasStockIssue?"text-red-900":"text-gray-900"}`,children:G(n.itemTotal)})})]},E))}),e.jsxs("div",{className:"space-y-3 border-t border-gray-200 pt-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal (con descuentos):"}),e.jsx("span",{className:"font-medium",children:G(N.totals.subtotal)})]}),N.totals.sellerDiscounts>0&&e.jsxs("div",{className:"flex justify-between text-sm text-blue-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(de,{size:14,className:"mr-1"}),"Descuentos del vendedor:"]}),e.jsxs("span",{className:"font-medium",children:["-",G(N.totals.sellerDiscounts)]})]}),N.totals.volumeDiscounts>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(_e,{size:14,className:"mr-1"}),"Descuentos por volumen:"]}),e.jsxs("span",{className:"font-medium",children:["-",G(N.totals.volumeDiscounts)]})]}),a&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(de,{size:14,className:"mr-1"}),"Código de descuento (",a.discountCode.code,"):"]}),e.jsxs("span",{className:"font-medium",children:["-",G(N.totals.couponDiscount||0)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"IVA (15%):"}),e.jsx("span",{className:"font-medium",children:G(N.totals.tax)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Envío:"}),e.jsx("span",{className:"font-medium",children:N.totals.freeShipping?"Gratis":G(N.totals.shipping)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t border-gray-200 pt-3",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:G(N.totals.total)})]}),N.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3 mt-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Total ahorrado:"}),e.jsx("span",{className:"text-lg font-bold text-green-600",children:G(N.totals.totalDiscounts)})]})})]})]});return Z&&M?e.jsx("div",{className:"container mx-auto px-4 py-10",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8 max-w-3xl mx-auto",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-10 w-10 text-green-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("h2",{className:"text-3xl font-bold text-gray-800 mb-4",children:"¡Pago con DeUna completado!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Tu pago se procesó correctamente y tu pedido está siendo preparado. Recibirás un correo electrónico con los detalles."}),N.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(de,{className:"h-5 w-5 text-green-600 mr-2"}),e.jsxs("span",{className:"text-green-800 font-medium",children:["¡Has ahorrado ",G(N.totals.totalDiscounts),"!"]})]})})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-4 pb-2 mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Detalles del pedido:"}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Número de orden:"}),e.jsx("span",{className:"font-medium",children:M.order_number})]}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Total:"}),e.jsx("span",{className:"font-medium",children:G(M.total||N.totals.total)})]}),N.totals.totalDiscounts>0&&e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Total ahorrado:"}),e.jsx("span",{className:"font-medium text-green-600",children:G(N.totals.totalDiscounts)})]}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Estado del pago:"}),e.jsx("span",{className:`font-medium ${M.payment_status==="paid"?"text-green-600":"text-yellow-600"}`,children:M.payment_status==="paid"?"Pagado":M.payment_status})]})]}),e.jsx("div",{className:"text-center mb-6",children:e.jsxs("p",{className:"text-sm text-gray-500",children:["Serás redirigido a tus pedidos en"," ",e.jsx("span",{className:"font-medium text-primary-600",children:se})," ","segundos..."]})}),e.jsxs("div",{className:"flex justify-center space-x-4 mt-6",children:[e.jsx("button",{onClick:()=>y("/"),className:"px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:"Volver a la tienda"}),e.jsx("button",{onClick:()=>y("/orders"),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"Ver mis pedidos"})]})]})}):e.jsxs("div",{className:"container mx-auto px-4 py-10",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Finalizar compra"}),e.jsx(Xe,{})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-8",children:[e.jsxs("div",{className:"lg:w-2/3",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Información de envío y facturación"}),e.jsx("div",{className:"mb-4",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 text-primary-600",checked:$,onChange:n=>B(n.target.checked)}),e.jsx("span",{className:"ml-2 text-gray-700",children:"Usar la misma dirección para facturación"})]})}),e.jsx(Se,{title:$?"Dirección de Envío y Facturación":"Dirección de Envío",address:_,onAddressChange:U,errors:F}),!$&&e.jsx("div",{className:"mt-8 pt-8 border-t border-gray-200",children:e.jsx(Se,{title:"Dirección de Facturación",address:w,onAddressChange:I,errors:F})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Método de pago"}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[e.jsx("button",{type:"button",onClick:()=>k("credit_card"),className:`flex items-center border rounded-lg px-4 py-3 ${m==="credit_card"?"border-primary-600 bg-primary-50 text-primary-600":"border-gray-300 hover:bg-gray-50"}`,children:e.jsx("span",{children:"Tarjeta de crédito"})}),e.jsx("button",{type:"button",onClick:()=>k("deuna"),className:`flex items-center border rounded-lg px-4 py-3 ${m==="deuna"?"border-primary-600 bg-primary-50 text-primary-600":"border-gray-300 hover:bg-gray-50"}`,children:e.jsx("span",{children:"Pago con Deuna!"})})]}),m==="credit_card"&&e.jsx(Ye,{paymentInfo:L,errors:F,onChange:Q,content:e.jsx(tt,{onSuccess:j,onError:d})}),m==="deuna"&&e.jsx(Ze,{total:N.totals.total,onPaymentSuccess:async n=>{console.log("✅ DeUna payment successful, processing completion:",n);try{if(!n||!n.payment_id)throw new Error("Datos de pago de DeUna incompletos");let E=null,R=0;const P=3;for(;!E&&R<P;){R++,console.log(`🔄 Intento ${R}/${P} - Verificando orden creada por webhook...`);try{await new Promise(v=>setTimeout(v,1e3*R)),E={order_id:n.order_id||`DEUNA-${Date.now()}`,order_number:n.payment_id,total:N.totals.total,payment_status:"paid",payment_method:"deuna",payment_id:n.payment_id,created_via:"deuna_webhook",completed_at:n.completed_at||new Date().toISOString()};break}catch(v){console.warn(`⚠️ Intento ${R} falló:`,v),R>=P&&(E={order_id:n.payment_id||`DEUNA-${Date.now()}`,order_number:n.payment_id||`DEUNA-${Date.now()}`,total:N.totals.total,payment_status:"processing",payment_method:"deuna",payment_id:n.payment_id,created_via:"deuna_frontend_fallback",completed_at:new Date().toISOString()},console.log("🆘 Usando datos de fallback para mostrar recibo"))}}console.log("🎯 Setting orderComplete to true and orderDetails"),K(E),z(!0),o(),E&&E.created_via==="deuna_frontend_fallback"?s(A.WARNING,"Pago completado. Si no aparece en tus órdenes inmediatamente, revisa en unos minutos."):s(A.SUCCESS,"¡Pago completado exitosamente con DeUna!"),console.log("✅ DeUna payment completion processed successfully - should show receipt now"),console.log("📊 Order details set:",{order_id:E?.order_id,total:E?.total,created_via:E?.created_via})}catch(E){console.error("❌ Error processing DeUna payment completion:",E);const R={order_id:n?.payment_id||`DEUNA-ERROR-${Date.now()}`,order_number:n?.payment_id||`ERROR-${Date.now()}`,total:N.totals.total,payment_status:"unknown",payment_method:"deuna",payment_id:n?.payment_id||"unknown",created_via:"deuna_error_fallback",completed_at:new Date().toISOString(),error_message:"Error procesando la confirmación. Verifica tus órdenes."};K(R),z(!0),s(A.ERROR,"Error procesando la confirmación del pago. Si el pago fue exitoso, aparecerá en tus órdenes."),i(E,"Error procesando la confirmación del pago. Por favor, verifica tus órdenes.")}},onPaymentError:n=>{console.error("❌ DeUna payment error:",n),i(new Error(n),"Error en el pago con DeUna. Por favor, intenta de nuevo.")}})]})]}),e.jsx("div",{className:"lg:w-1/3",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 sticky top-24",children:[e.jsx(O,{}),e.jsx("button",{onClick:l,disabled:c||N.stockIssues.length>0,className:"mt-6 w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-4 rounded-md transition-colors disabled:opacity-50 flex items-center justify-center",children:c?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Procesando..."]}):N.stockIssues.length>0?"Resuelve problemas de stock":`Finalizar compra - ${G(N.totals.total)}`}),N.stockIssues.length>0&&e.jsx("div",{className:"mt-3 text-xs text-center text-red-600",children:"⚠️ Ajusta las cantidades en tu carrito antes de continuar"}),e.jsxs("p",{className:"mt-4 text-xs text-gray-500 text-center",children:['Al hacer clic en "Finalizar compra", aceptas nuestros'," ",e.jsx("a",{href:"/terms",className:"text-primary-600 hover:underline",children:"Términos y condiciones"})," ","y"," ",e.jsx("a",{href:"/privacy",className:"text-primary-600 hover:underline",children:"Política de privacidad"}),"."]})]})})]})]})},ut=Object.freeze(Object.defineProperty({__proto__:null,default:ot},Symbol.toStringTag,{value:"Module"}));export{lt as C,et as D,ye as E,A as N,He as a,it as b,Qe as c,ut as d,dt as i,he as u};
//# sourceMappingURL=checkout-chunk-C5n3Mg9L.js.map
