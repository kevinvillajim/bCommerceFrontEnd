import{j as e}from"./ui-vendor-BUNMIuFe.js";import{u as F,j as H,r as g}from"./react-vendor-Cy458wKG.js";import{d as W,u as J,N as b,D as K,e as R,f as O,v as q,g as w}from"./checkout-chunk-DAros4Zm.js";import{f as G}from"./admin-chunk-BNcFjXlJ.js";import{u as Q}from"./seller-chunk-6swISJwY.js";import"./chat-chunk-BRsdDZXf.js";import"./utils-vendor-DeGC_a19.js";const se=()=>{W();const n=F(),[v]=H(),{cart:u,clearCart:S,showNotification:j,appliedDiscount:P}=J(),{user:L}=Q(),[M,V]=g.useState(!0),[m,N]=g.useState(null),[_,$]=g.useState(null),[C]=g.useState(5),B=new K,U=new R;return g.useEffect(()=>{(async()=>{try{console.log("üöÄ Iniciando procesamiento de resultado de Datafast");const c=v.get("resourcePath");console.log("üìç ResourcePath recibido:",c);const p=localStorage.getItem("datafast_order_result"),I=localStorage.getItem("datafast_order_timestamp");if(p&&!c){const i=Date.now(),s=I?parseInt(I):0;if(i-s<5*60*1e3)try{const a=JSON.parse(p);console.log("‚úÖ Mostrando orden ya procesada (reciente):",a),N({success:!0,data:a,message:"Pago procesado exitosamente"}),localStorage.removeItem("datafast_order_result"),localStorage.removeItem("datafast_order_timestamp"),localStorage.removeItem("datafast_transaction_id"),localStorage.removeItem("datafast_calculated_total"),localStorage.removeItem("datafast_form_data"),localStorage.removeItem("datafast_cart_backup"),setTimeout(()=>{j(b.SUCCESS,"¬°Pago completado exitosamente!")},100),setTimeout(()=>{n("/orders")},8e3);return}catch(a){console.error("Error parseando datos de orden:",a)}else console.log("‚ö†Ô∏è Datos de orden antiguos, procesando nuevo pago"),localStorage.removeItem("datafast_order_result"),localStorage.removeItem("datafast_order_timestamp")}if(!c)throw new Error("No se encontr√≥ informaci√≥n del pago");console.log("Procesando resultado de Datafast:",{resourcePath:c,allParams:Object.fromEntries(v.entries())});let x=localStorage.getItem("datafast_transaction_id");if(!x){const i=c.match(/\/checkouts\/([^\/]+)/),s=i?i[1]:Date.now().toString();x=`ORDER_${Date.now()}_${s}`,console.warn("No se encontr√≥ transaction_id en localStorage, usando:",x)}const E=localStorage.getItem("datafast_calculated_total"),D=E?parseFloat(E):void 0;console.log("Verificando pago con:",{resourcePath:c,transactionId:x,calculatedTotal:D});const o=await B.verifyPayment({resource_path:c,transaction_id:x,calculated_total:D});if(console.log("Respuesta de verificaci√≥n:",o),o.success&&o.data){console.log("‚úÖ Pago verificado exitosamente, creando orden...");const i=localStorage.getItem("datafast_form_data"),s=localStorage.getItem("datafast_cart_backup");let r={given_name:"Cliente",surname:"Datafast",address:"N/A",city:"N/A",country:"EC",phone:"N/A"};if(i)try{r=JSON.parse(i)}catch(t){console.error("Error parseando datos del formulario:",t)}let a=u;if((!u||u.items.length===0)&&s)try{a=JSON.parse(s),console.log("üì¶ Usando carrito backup para procesar orden",a)}catch(t){console.error("Error parseando carrito backup:",t)}if(!a||!a.items||a.items.length===0)throw console.error("‚ùå CR√çTICO: No hay carrito disponible para procesar"),console.error("   - cart:",u),console.error("   - cartBackupStr:",s),new Error("No se encontraron items para procesar la orden. Por favor, vuelva al carrito.");console.log("üîç VALIDACI√ìN PRE-CHECKOUT DATAFAST:"),console.log("   ‚úÖ Carrito encontrado con",a.items.length,"items"),console.log("   - Items del carrito:",a.items);const y=a?R.getSellerIdFromCart(a):null,d=a?await O.prepareItemsForCheckout(a.items,null,!0):[];if(d.length===0)throw console.error("‚ùå CR√çTICO: No se pudieron preparar items para checkout"),new Error("Error preparando items para el pago");const T=d.filter(t=>!t.price||t.price<=0);if(T.length>0)throw console.error("‚ùå CR√çTICO: Items con precio inv√°lido:",T),new Error("Algunos productos no tienen precio v√°lido");console.log("   ‚úÖ Items preparados correctamente:",d.length),console.log("   - Precios de items:",d.map(t=>({id:t.product_id,price:t.price})));const l=a?await O.calculateCheckoutTotals(a.items,P,!0):null;if(!l||l.total<=0)throw console.error("‚ùå CR√çTICO: Total calculado es $0.00 o inv√°lido"),console.error("   - calculatedTotals:",l),console.error("   - cartToProcess:",a),console.error("   - items preparados:",d),new Error(`El total calculado es inv√°lido: $${l?.total||0}`);const f=typeof o.data.total=="string"?parseFloat(o.data.total):o.data.total,h=l.total,k=q(f,h,"Datafast vs Sistema (DatafastResultPage)",w.VALIDATIONS.CHECKOUT_TOLERANCE);console.log("üí∞ VALIDACI√ìN DE MONTOS CON SISTEMA CENTRALIZADO:"),console.log("   - Total de Datafast:",f),console.log("   - Total calculado (EcommerceCalculator):",h),console.log("   - Tolerancia aplicada:",w.VALIDATIONS.CHECKOUT_TOLERANCE),console.log("   - Validaci√≥n:",k?"‚úÖ MONTOS V√ÅLIDOS":"‚ö†Ô∏è DISCREPANCIA DETECTADA"),k||(console.warn("‚ö†Ô∏è ADVERTENCIA: Los totales tienen una discrepancia mayor a la tolerancia permitida"),console.warn(`   Datafast: $${f} vs Calculado: $${h}`),console.warn(`   Diferencia: $${Math.abs(f-h).toFixed(6)}`),console.warn(`   Tolerancia m√°xima: $${w.VALIDATIONS.CHECKOUT_TOLERANCE}`)),console.log("‚úÖ TODAS LAS VALIDACIONES PASADAS:"),console.log("   - Total v√°lido: $",l.total),console.log("   - Items v√°lidos:",d.length),console.log("   - Seller ID:",y),console.log("üì¶ Preparando checkout con:",{sellerId:y,items:d.length,total:l.total,formData:r?"Datos de formulario presentes":"Sin datos de formulario"});const z={payment:{method:"datafast",transaction_id:o.data.payment_id,amount:o.data.total},shippingAddress:{name:r.given_name+" "+r.surname,street:r.address,city:r.city,state:r.country,postalCode:"00000",country:r.country,phone:r.phone},seller_id:y||void 0,items:d,calculated_totals:l?{subtotal:l.subtotal,tax:l.tax,shipping:l.shipping,total:l.total,total_discounts:l.totalDiscounts}:void 0};try{const t=await U.processCheckout(z,L?.email);if(t.status==="success"){console.log("‚úÖ Orden creada exitosamente:",t.data);const A={...o.data,order_id:t.data.order_id||o.data.order_id,order_number:t.data.order_number||o.data.order_number};N({success:!0,data:A,message:"Pago y orden procesados exitosamente"}),localStorage.setItem("datafast_order_result",JSON.stringify(A)),localStorage.setItem("datafast_order_timestamp",Date.now().toString()),setTimeout(()=>{S(),j(b.SUCCESS,"¬°Pago y orden completados exitosamente!")},100)}else throw new Error(t.message||"Error al crear la orden")}catch(t){console.error("Error creando orden:",t),N({success:!0,data:o.data,message:"Pago procesado (orden pendiente de creaci√≥n)"}),setTimeout(()=>{S()},100)}localStorage.removeItem("datafast_transaction_id"),localStorage.removeItem("datafast_calculated_total"),localStorage.removeItem("datafast_form_data"),localStorage.removeItem("datafast_cart_backup"),localStorage.removeItem("datafast_checkout_id"),localStorage.removeItem("datafast_resource_path"),setTimeout(()=>{n("/orders")},8e3)}else{const i=o.message||"El pago no fue completado",s=o.result_code;console.warn("Pago no exitoso:",{message:i,resultCode:s,fullResponse:o});let r=i;throw s==="000.200.100"?r="El checkout fue creado pero el pago no se complet√≥. Por favor, intente nuevamente.":s==="200.300.404"?r="La sesi√≥n de pago expir√≥. Si el pago fue exitoso, aparecer√° en sus √≥rdenes.":s&&s.startsWith("800")&&(r="El pago fue rechazado por el banco. Verifique sus datos e intente nuevamente."),new Error(r)}}catch(c){console.error("Error al procesar resultado de Datafast:",c);const p=c instanceof Error?c.message:"Error desconocido al procesar el pago";$(p),setTimeout(()=>{j(b.ERROR,p)},100),setTimeout(()=>{n("/cart")},8e3)}finally{V(!1)}})()},[v,n,u]),M?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsx("div",{className:"bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-b-2 border-primary-600 mx-auto mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Procesando pago..."}),e.jsx("p",{className:"text-gray-600",children:"Estamos verificando tu pago con Datafast. Por favor espera."}),e.jsx("div",{className:"mt-4 text-sm text-gray-500",children:e.jsx("p",{children:"Este proceso puede tomar unos segundos."})})]})})}):_?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsx("div",{className:"bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-red-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M6 18L18 6M6 6l12 12"})})}),e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Error en el pago"}),e.jsx("p",{className:"text-gray-600 mb-6",children:_}),e.jsx("div",{className:"text-sm text-gray-500 mb-6",children:e.jsxs("p",{children:["Ser√°s redirigido al carrito en ",C," segundos..."]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("button",{onClick:()=>n("/cart"),className:"flex-1 bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-md transition-colors",children:"Volver al carrito"}),e.jsx("button",{onClick:()=>n("/"),className:"flex-1 border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium py-2 px-4 rounded-md transition-colors",children:"Ir a inicio"})]})]})})}):m&&m.success&&m.data?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsx("div",{className:"bg-white rounded-lg shadow-lg p-8 max-w-lg w-full mx-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{className:"w-8 h-8 text-green-500",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("h2",{className:"text-2xl font-bold text-gray-800 mb-2",children:"¬°Pago exitoso!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Tu pago ha sido procesado correctamente con Datafast."}),e.jsxs("div",{className:"bg-gray-50 rounded-lg p-6 mb-6 text-left",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800 mb-4 text-center",children:"Detalles del pedido"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"N√∫mero de orden:"}),e.jsx("span",{className:"font-medium text-gray-800",children:m.data.order_number})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"ID de pago:"}),e.jsx("span",{className:"font-medium text-gray-800",children:m.data.payment_id})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Total pagado:"}),e.jsx("span",{className:"font-bold text-lg text-primary-600",children:G(m.data.total)})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Estado del pago:"}),e.jsxs("span",{className:"inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800",children:[e.jsx("svg",{className:"w-3 h-3 mr-1",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z",clipRule:"evenodd"})}),"Completado"]})]})]})]}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx("svg",{className:"w-5 h-5 text-blue-500 mt-0.5 mr-2 flex-shrink-0",fill:"currentColor",viewBox:"0 0 20 20",children:e.jsx("path",{fillRule:"evenodd",d:"M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z",clipRule:"evenodd"})}),e.jsxs("div",{className:"text-sm text-blue-700",children:[e.jsx("p",{className:"font-medium mb-1",children:"¬øQu√© sigue?"}),e.jsxs("ul",{className:"text-xs space-y-1",children:[e.jsx("li",{children:"‚Ä¢ Recibir√°s un correo de confirmaci√≥n"}),e.jsx("li",{children:"‚Ä¢ Procesaremos tu pedido en las pr√≥ximas 24 horas"}),e.jsx("li",{children:"‚Ä¢ Te notificaremos cuando tu pedido sea enviado"})]})]})]})}),e.jsx("div",{className:"text-sm text-gray-500 mb-6",children:e.jsxs("p",{children:["Ser√°s redirigido a tus pedidos en"," ",e.jsx("span",{className:"font-medium text-primary-600",children:C})," ","segundos..."]})}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsxs("button",{onClick:()=>n("/orders"),className:"flex-1 bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-4 rounded-md transition-colors flex items-center justify-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"})}),"Ver mis pedidos"]}),e.jsxs("button",{onClick:()=>n("/"),className:"flex-1 border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium py-3 px-4 rounded-md transition-colors flex items-center justify-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6"})}),"Ir a inicio"]}),e.jsxs("button",{onClick:()=>n("/products"),className:"flex-1 border border-primary-600 text-primary-600 hover:bg-primary-50 font-medium py-3 px-4 rounded-md transition-colors flex items-center justify-center",children:[e.jsx("svg",{className:"w-4 h-4 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z"})}),"Seguir comprando"]})]})]})})}):e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsx("div",{className:"bg-white rounded-lg shadow-lg p-8 max-w-md w-full mx-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("h2",{className:"text-xl font-semibold text-gray-800 mb-2",children:"Estado desconocido"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"No se pudo determinar el estado del pago."}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("button",{onClick:()=>n("/cart"),className:"flex-1 bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-md transition-colors",children:"Volver al carrito"}),e.jsx("button",{onClick:()=>n("/"),className:"flex-1 border border-gray-300 text-gray-700 hover:bg-gray-50 font-medium py-2 px-4 rounded-md transition-colors",children:"Ir a inicio"})]})]})})})};export{se as default};
//# sourceMappingURL=DatafastResultPage-B-kWdqfT.js.map
