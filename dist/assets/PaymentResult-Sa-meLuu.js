import{j as e,a0 as E,H as P,a as b,e as S}from"./ui-vendor-DEBjJ4HS.js";import{d as I,j as A,u as C,r as o}from"./react-vendor-Cy458wKG.js";import{A as x,c as p}from"./admin-chunk-C7Ad4l4I.js";const L=()=>{const{linkCode:t}=I(),[r]=A(),l=C(),[c,u]=o.useState(null),[_,h]=o.useState(!0),[f,n]=o.useState(null),[j,d]=o.useState(null),g=o.useRef(!1),[v,N]=o.useState(!1);o.useEffect(()=>{if(!t){l("/");return}y()},[t,r]);const y=async()=>{if(g.current||v){console.log("⚠️ Verificación de pago externo ya procesada, omitiendo llamada duplicada");return}g.current=!0,N(!0);try{console.log("🔄 Iniciando verificación única de pago externo"),h(!0);const s=r.get("resourcePath")||r.get("resource_path"),m=localStorage.getItem("datafast_transaction_id")||r.get("transaction_id")||r.get("transactionId")||r.get("id");if(console.log("🔍 Parámetros extraídos para verificación:",{linkCode:t,resourcePath:s,transactionId:m,searchParamsAll:Object.fromEntries(r.entries()),localStorage_transaction_id:localStorage.getItem("datafast_transaction_id"),external_session_id:localStorage.getItem("external_datafast_session_id")}),s&&m){console.log("🔄 Verificando pago Datafast externo:",{endpoint:x.EXTERNAL_PAYMENT.PUBLIC.DATAFAST_VERIFY(t),resource_path:s,transaction_id:m});const a=await p.post(x.EXTERNAL_PAYMENT.PUBLIC.DATAFAST_VERIFY(t),{resource_path:s,transaction_id:m});if(console.log("📡 Respuesta del backend:",{success:a.success,has_data:!!a.data,error_code:a.error_code,message:a.message}),a.success&&a.data)console.log("✅ Pago externo verificado exitosamente"),u(a.data),n(!0);else{if(a.error_code==="200.300.404"){console.log("🔍 Error 200.300.404 detectado - verificando si el link ya está pagado");const i=await p.get(x.EXTERNAL_PAYMENT.PUBLIC.SHOW(t));if(i.success&&i.data?.status==="paid"){console.log("✅ Link ya está marcado como pagado, mostrando como éxito"),u({payment_method:"datafast",transaction_id:i.data.transaction_id||"Procesado exitosamente",amount:i.data.amount,customer_name:i.data.customer_name,paid_at:i.data.paid_at||new Date().toISOString()}),n(!0);return}}d(a.message||"Error verificando el pago"),n(!1)}}else{const a=await p.get(x.EXTERNAL_PAYMENT.PUBLIC.SHOW(t));a.success&&a.data?a.data.status==="paid"?(n(!0),u({payment_method:"deuna",transaction_id:"Procesado automáticamente",amount:a.data.amount,customer_name:a.data.customer_name,paid_at:new Date().toISOString()})):(d("El pago no fue completado"),n(!1)):(d("Error verificando el estado del pago"),n(!1))}}catch(s){console.error("❌ Error procesando resultado de pago externo:",s),g.current=!1,N(!1),d(s.response?.data?.message||"Error procesando el resultado del pago"),n(!1)}finally{h(!1)}},w=s=>new Date(s).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return _?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(E,{className:"h-16 w-16 animate-spin mx-auto text-blue-600 mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Procesando tu pago..."}),e.jsx("p",{className:"text-gray-600",children:"Por favor espera mientras verificamos tu transacción"})]})}):f===!1||j?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-8 text-center",children:[e.jsx(P,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Error en el pago"}),e.jsx("p",{className:"text-gray-600 mb-6",children:j||"Ocurrió un error procesando tu pago"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>l(`/pay/${t}`),className:"w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors",children:"Intentar de nuevo"}),e.jsx("button",{onClick:()=>l("/"),className:"w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors",children:"Ir al inicio"})]})]})}):f&&c?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-8 text-center",children:[e.jsx(b,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"¡Pago exitoso!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Tu pago ha sido procesado correctamente"}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-4 mb-6 text-left",children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Cliente:"}),e.jsx("span",{className:"font-medium",children:c.customer_name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Monto:"}),e.jsxs("span",{className:"font-medium text-green-600",children:["$",Number(c.amount).toFixed(2)," USD"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Método:"}),e.jsx("span",{className:"font-medium capitalize",children:c.payment_method})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Transacción:"}),e.jsx("span",{className:"font-medium text-xs break-all",children:c.transaction_id})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Fecha:"}),e.jsx("span",{className:"font-medium text-xs",children:w(c.paid_at)})]})]})}),e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(b,{className:"h-5 w-5 text-green-600 mr-2"}),e.jsx("span",{className:"text-sm text-green-800 font-medium",children:"Pago procesado exitosamente"})]})}),e.jsx("button",{onClick:()=>l("/"),className:"w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors",children:"Finalizar"}),e.jsx("div",{className:"mt-4 text-xs text-gray-500",children:e.jsx("p",{children:"Guarda esta información para tus registros"})})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-8 text-center",children:[e.jsx(S,{className:"h-16 w-16 text-yellow-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Estado desconocido"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"No podemos determinar el estado de tu pago en este momento"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:y,className:"w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors",children:"Verificar nuevamente"}),e.jsx("button",{onClick:()=>l("/"),className:"w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors",children:"Ir al inicio"})]})]})})};export{L as default};
//# sourceMappingURL=PaymentResult-Sa-meLuu.js.map
