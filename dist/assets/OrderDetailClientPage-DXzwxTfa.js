import{j as e,aP as _,Z as w,q as k,H as N,P as f,a0 as D,J as I}from"./ui-vendor-BUNMIuFe.js";import{r as g,d as E,u as P,L as O}from"./react-vendor-Cy458wKG.js";import{O as S,f as b}from"./seller-chunk-6swISJwY.js";import{O as y}from"./OrderStatusBadge-CiQIj6sS.js";import{O as C}from"./OrderServiceAdapter-BkjA8NLO.js";import{f as d}from"./admin-chunk-BNcFjXlJ.js";import{u as B}from"./useImageCache-BZuULX8l.js";import"./utils-vendor-DeGC_a19.js";import"./checkout-chunk-C5n3Mg9L.js";import"./chat-chunk-BRsdDZXf.js";const T=({originalSubtotal:c,sellerDiscounts:i,volumeDiscounts:s,couponDiscount:u,couponCode:x,subtotalAfterDiscounts:h,shipping:j,freeShipping:p,tax:o,total:n,isSellerView:t=!1})=>{const m=i+s+u;return e.jsxs("div",{className:"bg-white dark:bg-gray-800 rounded-lg shadow-sm border border-gray-200 dark:border-gray-700 p-6",children:[e.jsxs("h3",{className:"text-lg font-semibold mb-4 text-gray-900 dark:text-white flex items-center",children:[e.jsx(_,{className:"w-5 h-5 mr-2"}),t?"Desglose de Ganancias":"Desglose de Precio"]}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Subtotal original:"}),e.jsx("span",{className:"text-gray-900 dark:text-white font-medium",children:d(c)})]}),m>0&&e.jsxs("div",{className:"border-t pt-3 space-y-2",children:[e.jsxs("div",{className:"flex items-center text-sm font-medium text-gray-700 dark:text-gray-300",children:[e.jsx(w,{className:"w-4 h-4 mr-2 text-green-600"}),"Descuentos aplicados:"]}),i>0&&e.jsxs("div",{className:"flex justify-between text-sm pl-6",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Descuento del vendedor:"}),e.jsxs("span",{className:"text-green-600 dark:text-green-400",children:["-",d(i)]})]}),s>0&&e.jsxs("div",{className:"flex justify-between text-sm pl-6",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"Descuento por volumen:"}),e.jsxs("span",{className:"text-green-600 dark:text-green-400",children:["-",d(s)]})]}),!t&&u>0&&e.jsxs("div",{className:"flex justify-between text-sm pl-6",children:[e.jsxs("span",{className:"text-gray-600 dark:text-gray-400 flex items-center",children:[e.jsx(k,{className:"w-3 h-3 mr-1"}),"Cupón ",x?`(${x})`:"",":"]}),e.jsxs("span",{className:"text-green-600 dark:text-green-400",children:["-",d(u)]})]})]}),e.jsxs("div",{className:"flex justify-between text-sm font-medium border-t pt-3",children:[e.jsx("span",{className:"text-gray-700 dark:text-gray-300",children:t?"Tu ganancia por productos:":"Subtotal con descuentos:"}),e.jsx("span",{className:"text-gray-900 dark:text-white",children:d(h)})]}),!t&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsxs("span",{className:"text-gray-600 dark:text-gray-400 flex items-center",children:[e.jsx(N,{className:"w-4 h-4 mr-2"}),"Envío ",p&&"(Gratis)",":"]}),e.jsx("span",{className:p?"text-green-600":"text-gray-900 dark:text-white",children:p?"GRATIS":d(j)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600 dark:text-gray-400",children:"IVA (15%):"}),e.jsx("span",{className:"text-gray-900 dark:text-white",children:d(o)})]})]}),e.jsxs("div",{className:"flex justify-between text-base font-bold border-t pt-3 mt-3",children:[e.jsx("span",{className:"text-gray-900 dark:text-white",children:t?"Total a recibir:":"Total pagado:"}),e.jsx("span",{className:"text-xl text-gray-900 dark:text-white",children:d(t?h:n)})]}),!t&&m>0&&e.jsx("div",{className:"bg-green-50 dark:bg-green-900/20 rounded-lg p-3 mt-3",children:e.jsxs("p",{className:"text-sm text-green-700 dark:text-green-400 font-medium text-center",children:["¡Has ahorrado ",d(m)," en esta compra!"]})}),t&&u>0&&e.jsx("div",{className:"bg-blue-50 dark:bg-blue-900/20 rounded-lg p-3 mt-3",children:e.jsxs("p",{className:"text-xs text-blue-700 dark:text-blue-400",children:[e.jsx("strong",{children:"Nota:"})," El cupón de descuento (",x,") es asumido por la plataforma. Recibirás el monto completo mostrado arriba."]})})]})]})},L=({order:c,viewType:i,sellerId:s})=>{const{getOptimizedImageUrl:u}=B(),[x,h]=g.useState([]),[j,p]=g.useState(!1);g.useEffect(()=>{(async()=>{if(c.id){p(!0);try{const m=await S.getInstance().getOrderItemsBreakdown(c.id,i);console.log("📊 Desglose recibido en componente (viewType: "+i+"):",m),console.log("📦 Items del orden:",c.items),h(m.items)}catch(t){console.error("Error cargando desglose:",t)}finally{p(!1)}}})()},[c.id]);const o=c.items;return!o||o.length===0?e.jsx("div",{className:"bg-white rounded-lg shadow-md p-6",children:e.jsx("div",{className:"text-center text-gray-500",children:"No hay productos en esta orden"})}):e.jsxs("div",{className:"bg-white rounded-lg shadow-md p-6",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx(f,{className:"w-5 h-5 text-gray-600 mr-2"}),e.jsxs("h3",{className:"text-lg font-semibold text-gray-900",children:["Productos ",i==="seller"?"de tu Tienda":"Comprados"]}),e.jsxs("span",{className:"ml-2 text-sm text-gray-500",children:["(",o.length," ",o.length===1?"producto":"productos",")"]})]}),e.jsx("div",{className:"space-y-4",children:o.map((n,t)=>{const m=u({image:n.image,main_image:n.image},"thumbnail");return e.jsx("div",{className:"border border-gray-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start space-x-4",children:[e.jsxs("div",{className:"flex-shrink-0",children:[n.image?e.jsx("img",{src:m,alt:n.name,className:"w-16 h-16 object-cover rounded-lg border border-gray-200",onError:a=>{const r=a.target;r.style.display="none",r.parentElement?.querySelector(".fallback-icon")?.classList.remove("hidden")}}):e.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center",children:e.jsx(f,{className:"w-8 h-8 text-gray-400"})}),e.jsx("div",{className:"hidden fallback-icon w-16 h-16 bg-gray-100 rounded-lg flex items-center justify-center",children:e.jsx(f,{className:"w-8 h-8 text-gray-400"})})]}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:"text-lg font-medium text-gray-900 truncate",children:n.name}),(()=>{const a=n.productId||n.product_id;console.log("🔍 Buscando breakdown para producto:",{itemProductId:a,item:n,itemsBreakdown:x,breakdownProductIds:x.map(l=>l.product_id)});const r=x.find(l=>l.product_id===a||l.product_id===Number(a));return j?e.jsx("div",{className:"mt-4 bg-gray-50 p-4 rounded-lg",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-4 bg-gray-200 rounded w-1/2 mb-2"}),e.jsx("div",{className:"h-3 bg-gray-200 rounded w-3/4"})]})}):r?e.jsx("div",{className:"mt-4 bg-gray-50 p-4 rounded-lg",children:e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center border-b border-gray-200 pb-2",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:" Cantidad a enviar:"}),e.jsx("span",{className:"text-lg font-bold text-primary-600",children:r.quantity})]}),e.jsxs("div",{className:"space-y-1",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Precio unitario original:"}),e.jsx("span",{className:"text-sm text-gray-900",children:d(r.original_price_per_unit)})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm text-gray-600",children:"Precio unitario final:"}),e.jsx("span",{className:"text-sm font-medium text-gray-900",children:d(r.final_price_per_unit)})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700",children:"Subtotal del producto:"}),e.jsx("span",{className:"text-sm font-bold text-gray-900",children:d(r.subtotal)})]})]}),r.breakdown_steps&&r.breakdown_steps.length>1&&e.jsxs("div",{className:"border-t border-gray-200 pt-2",children:[e.jsx("span",{className:"text-sm font-semibold text-gray-700 mb-2 block",children:"Descuentos aplicados:"}),r.breakdown_steps.filter(l=>l.is_discount).map((l,v)=>e.jsxs("div",{className:"flex justify-between items-center text-sm",children:[e.jsxs("span",{className:"text-green-600",children:["• ",l.label]}),e.jsxs("span",{className:"text-green-600 font-medium",children:["-",l.percentage,"%"]})]},v))]}),i==="seller"&&e.jsxs("div",{className:"border-t border-gray-200 pt-2 bg-blue-50 p-3 rounded -m-3 mt-3",children:[e.jsx("span",{className:"text-sm font-semibold text-blue-800 mb-2 block",children:"💰 Información de ganancias:"}),e.jsxs("div",{className:"space-y-1 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-700",children:"Comisión de plataforma:"}),e.jsx("span",{className:"text-blue-900 font-medium",children:"10%"})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-blue-700",children:"Tu ganancia (productos):"}),e.jsx("span",{className:"text-blue-900 font-bold",children:d(r.subtotal*.9)})]})]})]})]})}):null})()]})]})},n.id||t)})}),o.some(n=>n.hasVolumeDiscount)&&e.jsxs("div",{className:"mt-6 p-4 bg-green-50 rounded-lg border border-green-200",children:[e.jsx("h4",{className:"text-sm font-semibold text-green-800 mb-2",children:"🎉 Descuentos por Volumen Aplicados"}),e.jsxs("div",{className:"text-sm text-green-700",children:[o.filter(n=>n.hasVolumeDiscount).length," producto(s) con descuentos automáticos por cantidad comprada."]})]}),i==="seller"&&e.jsx("div",{className:"mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200",children:e.jsxs("p",{className:"text-sm text-blue-800",children:[e.jsx("strong",{children:"Información del Vendedor:"})," Los precios mostrados son los finales que se usaron para calcular tu comisión. Los descuentos ya están aplicados."]})})]})},J=()=>{const{id:c}=E(),i=P(),[s,u]=g.useState(null),[x,h]=g.useState(!0),[j,p]=g.useState(null),o=new C;g.useEffect(()=>{n()},[c]);const n=async()=>{if(c){h(!0);try{const a=await o.getOrderDetails(c);console.log("🛍️ Detalles de la orden recibidos:",a),console.log("📦 Items de la orden:",a?.items),console.log("🔢 Cantidad de items:",a?.items?.length),a?.items?.forEach((r,l)=>{console.log(`📋 Item ${l+1}:`,{id:r.id,product_name:r.product_name,product_image:r.product_image,price:r.price,quantity:r.quantity,productId:r.productId,completeItem:r})}),u(a),p(null)}catch(a){p("No se pudo cargar el detalle de la orden"),console.error("Error al cargar detalles de orden:",a)}finally{h(!1)}}},t=g.useMemo(()=>{if(!s)return null;console.log("🔍 OrderDetailClientPage - Analizando totales:"),console.log("📊 order.pricing_breakdown:",s.pricing_breakdown),console.log("📊 order.original_total (directo):",s.original_total),console.log("📊 order.total_discounts (directo):",s.total_discounts),console.log("📊 order.volume_discount_savings (directo):",s.volume_discount_savings);let a={};if(s.pricing_breakdown)try{a=typeof s.pricing_breakdown=="string"?JSON.parse(s.pricing_breakdown):s.pricing_breakdown}catch(l){console.warn("⚠️ Error parsing pricing_breakdown:",l),a={}}const r={subtotal_products:a.subtotal_with_discounts??s.subtotal_products??0,original_total:a.subtotal_original??s.original_total??0,iva_amount:a.iva_amount??s.iva_amount??0,shipping_cost:a.shipping_cost??s.shipping_cost??0,total:a.final_total??s.total??0,seller_discount_savings:a.seller_discounts??s.volume_discount_savings??0,volume_discount_savings:a.volume_discounts??s.volume_discount_savings??0,feedback_discount_amount:0,total_discounts:a.total_discounts??s.total_discounts??0,feedback_discount_code:null,volume_discounts_applied:s.volume_discounts_applied||!1,free_shipping:a.free_shipping??s.free_shipping??!1};return console.log("🎯 Totales finales calculados:",r),r},[s]),m=g.useMemo(()=>!s||!t?null:{id:String(s.id),orderNumber:s.orderNumber||String(s.id),date:s.created_at||new Date().toISOString(),customer:{id:s.userId||0,name:s.user_name||"Cliente",email:s.user_email||"email@example.com"},subtotal:t.subtotal_products,taxAmount:t.iva_amount,total:t.total,items:(s.items||[]).map(a=>({id:a.id||0,productId:a.product_id||a.productId||0,name:a.product_name||"Producto",quantity:a.quantity||1,price:a.price||0,subtotal:a.price||0,image:a.product_image,originalPrice:a.original_price||a.price,volumeDiscountPercentage:a.volume_discount_percentage||0,volumeSavings:a.volume_savings||0,discountLabel:a.discount_label||null,hasVolumeDiscount:(a.volume_discount_percentage||0)>0})),status:s.status||"pending",paymentStatus:s.payment_status||"pending",shippingAddress:s.shippingData?`${s.shippingData.address}, ${s.shippingData.city}, ${s.shippingData.state}`:void 0,notes:s.shippingData?.notes,itemCount:s.items?.length,originalTotal:t.original_total,volumeDiscountSavings:t.volume_discount_savings,volumeDiscountsApplied:t.volume_discounts_applied,shippingCost:t.shipping_cost,freeShipping:t.free_shipping,totalDiscounts:t.total_discounts,pricingBreakdown:s.pricing_breakdown},[s,t]);return x?e.jsxs("div",{className:"flex flex-col items-center justify-center min-h-screen p-4",children:[e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-500"}),e.jsx("p",{className:"mt-4 text-gray-700",children:"Cargando detalles del pedido..."})]}):j||!s?e.jsx("div",{className:"bg-white rounded-lg shadow p-6 max-w-4xl mx-auto my-8",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-red-500 text-5xl mb-4",children:"❌"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Error al cargar el pedido"}),e.jsx("p",{className:"text-gray-700 mb-6",children:j||"No se pudo encontrar el pedido solicitado"}),e.jsx("button",{onClick:()=>i("/orders"),className:"bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg transition-colors",children:"Volver a mis pedidos"})]})}):e.jsx("div",{className:"py-8 px-4 md:px-8 max-w-7xl mx-auto",children:e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col md:flex-row justify-between items-start md:items-center gap-4",children:[e.jsxs("div",{children:[e.jsxs("button",{onClick:()=>i("/orders"),className:"cursor-pointer flex items-center text-gray-600 hover:text-primary-600 mb-2",children:[e.jsx(D,{size:16,className:"mr-1"}),e.jsx("span",{children:"Volver a mis pedidos"})]}),e.jsxs("h1",{className:"text-2xl font-bold text-gray-800",children:["Pedido #",s.orderNumber||s.id]})]}),e.jsx("div",{className:"flex space-x-3",children:["completed","delivered"].includes(s.status)&&e.jsxs(O,{to:`/invoices/${s.id}`,className:"bg-gray-600 text-white px-4 py-2 rounded-lg hover:bg-gray-700 flex items-center gap-2",children:[e.jsx(I,{size:18}),e.jsx("span",{children:"Ver factura"})]})})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-6",children:[e.jsxs("div",{className:"col-span-3 md:col-span-1 space-y-6",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"Estado del pedido"}),e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Estado:"}),e.jsx(y,{status:s.status})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Pago:"}),e.jsx(y,{status:s.payment_status,type:"payment"})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Método de pago:"}),e.jsxs("span",{className:"text-gray-900",children:[s.payment_method==="credit_card"&&"Tarjeta de crédito",s.payment_method==="datafast"&&"Datafast",s.payment_method==="deuna"&&"DeUna",s.payment_method==="transfer"&&"Transferencia",s.payment_method==="other"&&"Otro",!s.payment_method&&"No especificado"]})]}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("span",{className:"text-gray-600",children:"Fecha:"}),e.jsx("span",{className:"text-gray-900",children:s.created_at?b(s.created_at):"Sin fecha"})]})]})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow p-6",children:[e.jsx("h2",{className:"text-lg font-medium text-gray-900 mb-4",children:"Información de envío"}),e.jsx("div",{className:"space-y-3",children:s.shippingData?e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-600 mb-1",children:"Dirección de envío:"}),e.jsx("p",{className:"text-gray-900",children:s.shippingData.address}),e.jsxs("p",{className:"text-gray-900",children:[s.shippingData.city,", ",s.shippingData.state]}),e.jsxs("p",{className:"text-gray-900",children:[s.shippingData.country,","," ",s.shippingData.postalCode]})]}),s.shippingData.phone&&e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-600",children:"Teléfono:"}),e.jsx("p",{className:"text-gray-900",children:s.shippingData.phone})]}),s.shippingData.tracking_number&&e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-600",children:"Número de seguimiento:"}),e.jsx("p",{className:"text-primary-600 font-medium",children:s.shippingData.tracking_number})]}),s.shippingData.shipping_company&&e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-600",children:"Empresa de transporte:"}),e.jsx("p",{className:"text-gray-900",children:s.shippingData.shipping_company})]}),s.shippingData.estimated_delivery&&e.jsxs("div",{children:[e.jsx("span",{className:"block text-sm font-medium text-gray-600",children:"Entrega estimada:"}),e.jsx("p",{className:"text-gray-900",children:b(s.shippingData.estimated_delivery)})]})]}):e.jsx("p",{className:"text-gray-600",children:"No hay información de envío disponible"})}),e.jsx("div",{className:"mt-6",children:e.jsx("div",{className:"relative",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${s.status!=="pending"?"bg-green-100 text-green-600":"bg-gray-100 text-gray-400"}`,children:e.jsx(f,{size:20})}),e.jsx("span",{className:"text-xs mt-1",children:s.status!=="pending"?"Procesando":"Pendiente"})]}),e.jsx("div",{className:"flex-1 h-1 mx-2 bg-gray-200"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${s.status==="shipped"||s.status==="delivered"||s.status==="completed"?"bg-green-100 text-green-600":"bg-gray-100 text-gray-400"}`,children:e.jsx(N,{size:20})}),e.jsx("span",{className:"text-xs mt-1",children:"Enviado"})]}),e.jsx("div",{className:"flex-1 h-1 mx-2 bg-gray-200"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("div",{className:`w-10 h-10 rounded-full flex items-center justify-center ${s.status==="delivered"||s.status==="completed"?"bg-green-100 text-green-600":"bg-gray-100 text-gray-400"}`,children:e.jsx(f,{size:20})}),e.jsx("span",{className:"text-xs mt-1",children:"Entregado"})]})]})})})]})]}),e.jsxs("div",{className:"col-span-3 md:col-span-2 space-y-6",children:[m&&e.jsx(L,{order:m,viewType:"customer"}),t&&e.jsx(T,{originalSubtotal:t.original_total,sellerDiscounts:t.seller_discount_savings,volumeDiscounts:t.volume_discount_savings,couponDiscount:t.feedback_discount_amount,couponCode:t.feedback_discount_code||void 0,subtotalAfterDiscounts:t.subtotal_products,shipping:t.shipping_cost,freeShipping:t.free_shipping,tax:t.iva_amount,total:t.total,isSellerView:!1})]})]})]})})};export{J as default};
//# sourceMappingURL=OrderDetailClientPage-DXzwxTfa.js.map
