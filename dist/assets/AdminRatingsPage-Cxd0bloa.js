import{d as X,c as K,r as D,G as z,j as e,$ as te,R as se,F as re,I as oe,h as J,E as le,aV as ne,T as H,n as ce,P as ie}from"./ui-vendor-BUNMIuFe.js";import{r as n,L as de}from"./react-vendor-Cy458wKG.js";import{c as A,A as F,h as k,T as ue}from"./admin-chunk-BNcFjXlJ.js";import{S as me}from"./StatCardList--GkL7aJm.js";class ge{async getRatings(l={}){try{return await A.get(F.ADMIN.RATINGS.LIST,l)}catch(i){throw console.error("Error al obtener valoraciones:",i),i}}async approveRating(l,i){try{return await A.post(F.ADMIN.RATINGS.APPROVE(l),{note:i})}catch(c){throw console.error(`Error al aprobar valoración ${l}:`,c),c}}async rejectRating(l,i){try{return await A.post(F.ADMIN.RATINGS.REJECT(l),{note:i})}catch(c){throw console.error(`Error al rechazar valoración ${l}:`,c),c}}async flagRating(l,i){try{return await A.post(F.ADMIN.RATINGS.FLAG(l),{reason:i})}catch(c){throw console.error(`Error al marcar/desmarcar valoración ${l}:`,c),c}}async getRatingStats(){try{return await A.get(F.ADMIN.RATINGS.STATS)}catch(l){throw console.error("Error al obtener estadísticas de valoraciones:",l),l}}}const xe=()=>{const[u,l]=n.useState([]),[i,c]=n.useState(!0),[M,j]=n.useState(null),[P,E]=n.useState(!0),[g,w]=n.useState("all"),[r,$]=n.useState("all"),[x,_]=n.useState(null),[p,V]=n.useState({from:"",to:""}),[d,b]=n.useState({currentPage:1,totalPages:1,totalItems:0,itemsPerPage:10}),[R,N]=n.useState({total:0,pending:0,approved:0,rejected:0}),[L,S]=n.useState(null),[U,T]=n.useState(!1),[C,y]=n.useState(""),[I,G]=n.useState(!1),h=new ge,a=n.useCallback(async()=>{c(!0),j(null);try{console.log("Obteniendo valoraciones con filtros:",{page:d.currentPage,per_page:d.itemsPerPage,statusFilter:g,typeFilter:r,ratingFilter:x,dateRangeFilter:p});const t={page:d.currentPage,per_page:d.itemsPerPage};g!=="all"&&(t.status=g),r!=="all"&&(t.type=r),x!==null&&(t.rating=x),p.from&&(t.from_date=p.from),p.to&&(t.to_date=p.to),console.log("Filtros enviados a la API:",t);const s=await h.getRatings(t);console.log("Respuesta recibida de la API:",s),s&&s.data?(console.log("Datos de valoraciones:",s.data),l(Array.isArray(s.data)?s.data:[]),s.meta&&b({currentPage:s.meta.current_page||d.currentPage,totalPages:s.meta.last_page||d.totalPages,totalItems:s.meta.total||0,itemsPerPage:s.meta.per_page||d.itemsPerPage})):(console.warn("Respuesta sin datos válidos:",s),l([]))}catch(t){console.error("Error al obtener valoraciones:",t);const s=k(t,"Error al cargar las valoraciones");j(s),l([])}finally{c(!1)}},[h,d.currentPage,d.itemsPerPage,g,r,x,p]),o=n.useCallback(async()=>{E(!0);try{console.log("Obteniendo estadísticas de ratings...");const t=await h.getRatingStats();console.log("Respuesta de estadísticas:",t),t&&t.data?(console.log("Datos de estadísticas:",t.data),N({total:t.data.total||0,pending:t.data.pending||0,approved:t.data.approved||0,rejected:t.data.rejected||0})):t&&t.status==="success"?(console.log("Usando respuesta directa como datos:",t),N({total:t.total||0,pending:t.pending||0,approved:t.approved||0,rejected:t.rejected||0})):(console.warn("Respuesta de estadísticas sin datos válidos:",t),N({total:0,pending:0,approved:0,rejected:0}))}catch(t){console.error("Error al obtener estadísticas:",t),N({total:0,pending:0,approved:0,rejected:0})}finally{E(!1)}},[h]);n.useEffect(()=>{a(),o()},[]),n.useEffect(()=>{I&&a()},[g,r,x,p,d.currentPage]),n.useEffect(()=>{G(!0)},[]);const f=n.useCallback(()=>{if(u.length>0){const t={total:u.length,pending:u.filter(s=>s.status==="pending").length,approved:u.filter(s=>s.status==="approved").length,rejected:u.filter(s=>s.status==="rejected").length};console.log("Estadísticas calculadas desde los datos:",t),N(t)}},[u]);n.useEffect(()=>{u.length>0&&R.total===0&&!P&&(console.log("Estadísticas del servidor no disponibles, calculando desde los datos locales..."),f())},[u,R.total,P,f]);const Q=t=>{w(t),b(s=>({...s,currentPage:1}))},W=t=>{$(t),b(s=>({...s,currentPage:1}))},Y=t=>{_(t),b(s=>({...s,currentPage:1}))},Z=t=>{V(t),b(s=>({...s,currentPage:1}))},ee=t=>{b(s=>({...s,currentPage:t}))},ae=t=>{S(t),y(""),T(!0)},O=()=>{S(null),T(!1),y("")};return{ratings:u,loading:i,error:M,statsLoading:P,stats:R,statusFilter:g,typeFilter:r,ratingFilter:x,dateRangeFilter:p,pagination:d,selectedRating:L,showRatingModal:U,moderationNote:C,setStatusFilter:Q,setTypeFilter:W,setRatingFilter:Y,setDateRangeFilter:Z,handlePageChange:ee,openRatingModal:ae,closeRatingModal:O,setModerationNote:y,approveRating:async t=>{try{const s=await h.approveRating(t,C);if(s.status==="success")return l(m=>m.map(v=>v.id===t?{...v,status:"approved"}:v)),o(),O(),!0;throw new Error(s.message||"Error al aprobar la valoración")}catch(s){return console.error(`Error al aprobar valoración ${t}:`,s),j(k(s,"Error al aprobar la valoración")),!1}},rejectRating:async t=>{if(!C)return j("Es necesario proporcionar una nota de moderación para rechazar una valoración"),!1;try{const s=await h.rejectRating(t,C);if(s.status==="success")return l(m=>m.map(v=>v.id===t?{...v,status:"rejected"}:v)),o(),O(),!0;throw new Error(s.message||"Error al rechazar la valoración")}catch(s){return console.error(`Error al rechazar valoración ${t}:`,s),j(k(s,"Error al rechazar la valoración")),!1}},flagRating:async(t,s)=>{try{const m=await h.flagRating(t,s);if(m.status==="success")return m.data&&m.data.newStatus&&l(v=>v.map(B=>B.id===t?{...B,status:m.data.newStatus}:B)),o(),!0;throw new Error(m.message||"Error al modificar el estado de la valoración")}catch(m){return console.error(`Error al modificar estado de valoración ${t}:`,m),j(k(m,"Error al modificar estado de valoración")),!1}},refreshData:()=>{a(),o()}}},q={pending:{label:"Pendiente",color:"bg-yellow-100 text-yellow-800",icon:e.jsx(K,{className:"w-3 h-3 mr-1"})},approved:{label:"Aprobada",color:"bg-green-100 text-green-800",icon:e.jsx(D,{className:"w-3 h-3 mr-1"})},rejected:{label:"Rechazada",color:"bg-red-100 text-red-800",icon:e.jsx(z,{className:"w-3 h-3 mr-1"})}},pe={product:{label:"Producto",color:"bg-blue-100 text-blue-800",icon:e.jsx(ie,{className:"w-3 h-3 mr-1"})},seller:{label:"Vendedor",color:"bg-purple-100 text-purple-800",icon:e.jsx(ce,{className:"w-3 h-3 mr-1"})},user:{label:"Usuario",color:"bg-orange-100 text-orange-800",icon:e.jsx(J,{className:"w-3 h-3 mr-1"})}},Re=()=>{const{ratings:u,loading:l,error:i,stats:c,statsLoading:M,statusFilter:j,typeFilter:P,ratingFilter:E,dateRangeFilter:g,pagination:w,selectedRating:r,showRatingModal:$,moderationNote:x,setStatusFilter:_,setTypeFilter:p,setRatingFilter:V,setDateRangeFilter:d,handlePageChange:b,openRatingModal:R,closeRatingModal:N,setModerationNote:L,approveRating:S,rejectRating:U,flagRating:T,refreshData:C}=xe(),y=a=>{if(!a)return"N/A";try{const o=new Date(a);return isNaN(o.getTime())?"Fecha inválida":new Intl.DateTimeFormat("es-ES",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}).format(o)}catch(o){return console.error("Error al formatear fecha:",o),"Error en fecha"}},I=a=>e.jsxs("div",{className:"flex items-center",children:[[...Array(5)].map((o,f)=>e.jsx(X,{className:`w-4 h-4 ${f<a?"text-yellow-500 fill-current":"text-gray-300"}`},f)),e.jsx("span",{className:"ml-1 text-sm font-medium",children:a})]}),G=[{key:"user",header:"Usuario",sortable:!0,render:a=>e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden",children:a.user?.avatar?e.jsx("img",{src:`/images/avatars/${a.user.avatar}`,alt:a.user?.name,className:"h-8 w-8 object-cover",onError:o=>{o.target.src="https://via.placeholder.com/40?text=User"}}):e.jsx(J,{className:"h-4 w-4 text-gray-500"})}),e.jsxs("div",{className:"ml-3",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:a.user?.name||`Usuario #${a.userId}`}),e.jsxs("div",{className:"text-xs text-gray-500",children:["ID: ",a.userId,a.isVerifiedPurchase&&e.jsx("span",{className:"ml-2 text-green-600",children:"✓ Compra verificada"})]})]})]})},{key:"ratingScore",header:"Valoración",sortable:!0,render:a=>I(a.rating)},{key:"type",header:"Tipo",sortable:!0,render:a=>{const o=pe[a.type]||{label:a.type,color:"bg-gray-100 text-gray-800",icon:e.jsx(H,{className:"w-3 h-3 mr-1"})};return e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${o.color}`,children:[o.icon,o.label]})}},{key:"title",header:"Título",sortable:!0,render:a=>e.jsx("div",{className:"text-sm font-medium text-gray-900 line-clamp-2",children:a.title||"Sin título"})},{key:"date",header:"Fecha",sortable:!0,render:a=>{const o=a.createdAt||a.created_at,f=a.updatedAt||a.updated_at;return e.jsxs("div",{className:"text-xs text-gray-500",children:[e.jsxs("div",{children:["Creado: ",y(o)]}),f&&f!==o&&e.jsxs("div",{children:["Actualizado: ",y(f)]})]})}},{key:"status",header:"Estado",sortable:!0,render:a=>{const o=q[a.status]||{label:a.status,color:"bg-gray-100 text-gray-800",icon:e.jsx(H,{className:"w-3 h-3 mr-1"})};return e.jsxs("span",{className:`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${o.color}`,children:[o.icon,o.label]})}},{key:"actions",header:"Acciones",render:a=>e.jsxs("div",{className:"flex justify-end space-x-2",children:[e.jsx("button",{onClick:()=>R(a),className:"p-1 text-blue-600 hover:bg-blue-100 rounded-md",title:"Ver detalles",children:e.jsx(le,{size:18})}),a.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:async()=>{if(!a.id){alert("ID de valoración no válido");return}await S(a.id)&&console.log("Valoración aprobada exitosamente")},className:"p-1 text-green-600 hover:bg-green-100 rounded-md",title:"Aprobar valoración",children:e.jsx(D,{size:18})}),e.jsx("button",{onClick:async()=>{if(!a.id){alert("ID de valoración no válido");return}R(a)},className:"p-1 text-red-600 hover:bg-red-100 rounded-md",title:"Rechazar valoración",children:e.jsx(z,{size:18})})]}),e.jsx("button",{onClick:async()=>{if(!a.id){alert("ID de valoración no válido");return}await T(a.id,a.status==="flagged"?"Desmarcada por administrador":"Marcada para revisión por administrador")&&console.log("Estado de flag actualizado exitosamente")},className:`p-1 ${a.status==="flagged"?"text-green-600 hover:bg-green-100":"text-orange-600 hover:bg-orange-100"} rounded-md`,title:a.status==="flagged"?"Desmarcar valoración":"Reportar valoración",children:a.status==="flagged"?e.jsx(D,{size:18}):e.jsx(ne,{size:18})})]})}],h=[{title:"Total",value:c.total,description:"Valoraciones y reseñas",icon:X,bgColor:"bg-blue-50/20",textColor:"text-blue-800",valueColor:"text-blue-900 ",descriptionColor:"text-blue-700",iconColor:"text-blue-600"},{title:"Pendientes",value:c.pending,description:"Esperando moderación",icon:K,bgColor:"bg-yellow-50/20",textColor:"text-yellow-800",valueColor:"text-yellow-900",descriptionColor:"text-yellow-700",iconColor:"text-yellow-6000"},{title:"Aprobadas",value:c.approved,description:"Publicadas",icon:D,bgColor:"bg-green-50/20",textColor:"text-green-800",valueColor:"text-green-900",descriptionColor:"text-green-700",iconColor:"text-green-600"},{title:"Rechazadas",value:c.rejected,description:"Ocultadas del público",icon:z,bgColor:"bg-red-50/20",textColor:"text-red-800",valueColor:"text-red-900",descriptionColor:"text-red-700",iconColor:"text-red-600"}];return e.jsxs("div",{className:"space-y-6",children:[i&&e.jsx("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative",children:e.jsx("span",{className:"block sm:inline",children:i})}),e.jsxs("div",{className:"flex justify-between items-center",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Gestión de Valoraciones y Reseñas"}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs(de,{to:"/admin/ratings/dashboard",className:"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors",children:[e.jsx(te,{size:18,className:"inline mr-2"}),"Estadísticas"]}),e.jsxs("button",{onClick:C,className:"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:[e.jsx(se,{size:18,className:`inline mr-2 ${l?"animate-spin":""}`}),"Actualizar"]})]})]}),M?e.jsx("div",{className:"bg-white rounded-lg shadow-sm p-8",children:e.jsxs("div",{className:"flex justify-center items-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600"}),e.jsx("span",{className:"ml-3 text-gray-600",children:"Cargando estadísticas..."})]})}):e.jsx(me,{items:h}),e.jsx("div",{className:"bg-white rounded-lg shadow-sm p-4",children:e.jsxs("div",{className:"flex flex-col md:flex-row gap-4",children:[e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(re,{className:"h-5 w-5 text-gray-500"}),e.jsxs("select",{className:"border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500",value:j,onChange:a=>_(a.target.value),children:[e.jsx("option",{value:"all",children:"Todos los Estados"}),e.jsx("option",{value:"pending",children:"Pendientes"}),e.jsx("option",{value:"approved",children:"Aprobados"}),e.jsx("option",{value:"rejected",children:"Rechazados"})]})]}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs("select",{className:"border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500",value:P,onChange:a=>p(a.target.value),children:[e.jsx("option",{value:"all",children:"Todos los Tipos"}),e.jsx("option",{value:"product",children:"Producto"}),e.jsx("option",{value:"seller",children:"Vendedor"})]})}),e.jsx("div",{className:"flex items-center space-x-2",children:e.jsxs("select",{className:"border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500",value:E!==null?E.toString():"all",onChange:a=>V(a.target.value==="all"?null:parseInt(a.target.value)),children:[e.jsx("option",{value:"all",children:"Todas las Puntuaciones"}),e.jsx("option",{value:"5",children:"5 Estrellas"}),e.jsx("option",{value:"4",children:"4 Estrellas"}),e.jsx("option",{value:"3",children:"3 Estrellas"}),e.jsx("option",{value:"2",children:"2 Estrellas"}),e.jsx("option",{value:"1",children:"1 Estrella"})]})}),e.jsxs("div",{className:"flex items-center space-x-2",children:[e.jsx(oe,{className:"h-5 w-5 text-gray-500"}),e.jsx("input",{type:"date",className:"border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500",value:g.from,onChange:a=>d({...g,from:a.target.value}),placeholder:"Desde"}),e.jsx("input",{type:"date",className:"border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500",value:g.to,onChange:a=>d({...g,to:a.target.value}),placeholder:"Hasta"})]})]})}),e.jsx(ue,{data:u,columns:G,searchFields:["title","comment"],loading:l,emptyMessage:"No se encontraron valoraciones",pagination:{currentPage:w.currentPage,totalPages:w.totalPages,totalItems:w.totalItems,itemsPerPage:w.itemsPerPage,onPageChange:b}}),$&&r&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-xl max-w-3xl w-full max-h-[90vh] overflow-y-auto",children:[e.jsxs("div",{className:"px-6 py-4 border-b border-gray-200 flex justify-between items-center",children:[e.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Detalles de Valoración"}),e.jsx("button",{onClick:N,className:"text-gray-400 hover:text-gray-500",children:e.jsx(z,{className:"h-5 w-5"})})]}),e.jsxs("div",{className:"p-6",children:[e.jsxs("div",{className:"mb-6",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 mb-2",children:"Usuario"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"flex-shrink-0 h-10 w-10 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden",children:r.user?.avatar?e.jsx("img",{src:`/images/avatars/${r.user.avatar}`,alt:r.user?.name,className:"h-10 w-10 object-cover",onError:a=>{a.target.src="https://via.placeholder.com/40?text=User"}}):e.jsx(J,{className:"h-6 w-6 text-gray-500"})}),e.jsxs("div",{className:"ml-4",children:[e.jsx("div",{className:"text-sm font-medium text-gray-900",children:r.user?.name||`Usuario #${r.userId}`}),e.jsxs("div",{className:"text-xs text-gray-500",children:["ID: ",r.userId,r.isVerifiedPurchase&&e.jsx("span",{className:"ml-2 text-green-600",children:"✓ Compra verificada"})]})]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 mb-2",children:"Valoración"}),e.jsx("div",{className:"flex items-center mb-2",children:I(r.rating)}),e.jsxs("div",{className:"text-gray-900 mb-2",children:[e.jsx("span",{className:"font-medium",children:"Título:"})," ",r.title]}),e.jsx("div",{className:"bg-gray-50 p-3 rounded-lg text-gray-800 mb-2 whitespace-pre-wrap",children:r.comment}),e.jsxs("div",{className:"text-sm text-gray-500",children:[e.jsxs("div",{children:["Creado: ",y(r.createdAt||r.created_at)]}),(r.updatedAt||r.updated_at)&&(r.updatedAt||r.updated_at)!==(r.createdAt||r.created_at)&&e.jsxs("div",{children:["Actualizado: ",y(r.updatedAt||r.updated_at)]})]})]}),e.jsxs("div",{className:"mb-6",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 mb-2",children:"Estado Actual"}),e.jsx("div",{className:"flex items-center",children:(()=>{const a=q[r.status]||{label:r.status,color:"bg-gray-100 text-gray-800",icon:e.jsx(H,{className:"w-4 h-4 mr-1"})};return e.jsxs("span",{className:`inline-flex items-center px-3 py-1 rounded-full text-sm font-medium ${a.color}`,children:[a.icon,a.label]})})()})]}),r.status==="pending"&&e.jsxs("div",{className:"mb-6",children:[e.jsx("h4",{className:"text-sm font-medium text-gray-500 mb-2",children:"Moderación"}),e.jsxs("div",{className:"mb-4",children:[e.jsx("label",{htmlFor:"moderationNote",className:"block text-sm font-medium text-gray-700 mb-1",children:"Nota de Moderación (obligatoria para rechazar)"}),e.jsx("textarea",{id:"moderationNote",rows:3,className:"w-full border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500",placeholder:"Razón del rechazo o notas adicionales...",value:x,onChange:a=>L(a.target.value)})]}),e.jsxs("div",{className:"flex space-x-2",children:[e.jsxs("button",{onClick:async()=>{if(!r.id){alert("ID de valoración no válido");return}await S(r.id)&&console.log("Valoración aprobada desde modal")},className:"flex items-center justify-center px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition-colors",children:[e.jsx(D,{size:18,className:"mr-2"}),"Aprobar"]}),e.jsxs("button",{onClick:async()=>{if(!r.id){alert("ID de valoración no válido");return}if(!x.trim()){alert("Es necesario agregar una nota de moderación para rechazar");return}await U(r.id)&&console.log("Valoración rechazada desde modal")},className:"flex items-center justify-center px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition-colors disabled:opacity-50",disabled:!x.trim(),children:[e.jsx(z,{size:18,className:"mr-2"}),"Rechazar"]})]})]})]})]})})]})};export{Re as default};
//# sourceMappingURL=AdminRatingsPage-Cxd0bloa.js.map
