import{j as e,a0 as S,H as P,a as v,e as A}from"./ui-vendor-DEBjJ4HS.js";import{d as T,j as C,u as k,r as c}from"./react-vendor-Cy458wKG.js";import{A as x,c as p}from"./admin-chunk-bhOJ3jtA.js";function R(a){return a.get("transaction_id")||a.get("transactionId")||a.get("id")||null}function L(){try{return localStorage.getItem("external_datafast_session_id")||localStorage.getItem("datafast_session_id")||localStorage.getItem("checkout_session_id")}catch{return null}}const Y=()=>{const{linkCode:a}=T(),[r]=C(),d=k(),[i,u]=c.useState(null),[w,h]=c.useState(!0),[j,o]=c.useState(null),[N,m]=c.useState(null),g=c.useRef(!1),[I,y]=c.useState(!1);c.useEffect(()=>{if(!a){d("/");return}b()},[a,r]);const b=async()=>{if(g.current||I){console.log("⚠️ Verificación de pago externo ya procesada, omitiendo llamada duplicada");return}g.current=!0,y(!0);try{console.log("🔄 Iniciando verificación única de pago externo"),h(!0);const n=r.get("resourcePath")||r.get("resource_path"),f=localStorage.getItem("datafast_transaction_id")||r.get("transaction_id")||r.get("transactionId")||r.get("id");if(console.log("🔍 Parámetros extraídos para verificación:",{linkCode:a,resourcePath:n,transactionId:f,searchParamsAll:Object.fromEntries(r.entries()),localStorage_transaction_id:localStorage.getItem("datafast_transaction_id"),external_session_id:localStorage.getItem("external_datafast_session_id")}),n&&f){const s=L(),_={transaction_id:R(r)||f,resource_path:n,...s&&{session_id:s}};console.log("🔄 Verificando pago Datafast externo:",{endpoint:x.EXTERNAL_PAYMENT.PUBLIC.DATAFAST_VERIFY(a),requestData:_,sessionId_included:!!s});const t=await p.post(x.EXTERNAL_PAYMENT.PUBLIC.DATAFAST_VERIFY(a),_);if(console.log("📡 Respuesta del backend:",{success:t.success,has_data:!!t.data,error_code:t.error_code,message:t.message}),t.success&&t.data)console.log("✅ Pago externo verificado exitosamente"),u(t.data),o(!0);else{if(t.error_code==="200.300.404"){console.log("🔍 Error 200.300.404 detectado - verificando si el link ya está pagado");const l=await p.get(x.EXTERNAL_PAYMENT.PUBLIC.SHOW(a));if(l.success&&l.data?.status==="paid"){console.log("✅ Link ya está marcado como pagado, mostrando como éxito"),u({payment_method:"datafast",transaction_id:l.data.transaction_id||"Procesado exitosamente",amount:l.data.amount,customer_name:l.data.customer_name,paid_at:l.data.paid_at||new Date().toISOString()}),o(!0);return}}m(t.message||"Error verificando el pago"),o(!1)}}else{const s=await p.get(x.EXTERNAL_PAYMENT.PUBLIC.SHOW(a));s.success&&s.data?s.data.status==="paid"?(o(!0),u({payment_method:"deuna",transaction_id:"Procesado automáticamente",amount:s.data.amount,customer_name:s.data.customer_name,paid_at:new Date().toISOString()})):(m("El pago no fue completado"),o(!1)):(m("Error verificando el estado del pago"),o(!1))}}catch(n){console.error("❌ Error procesando resultado de pago externo:",n),g.current=!1,y(!1),m(n.response?.data?.message||"Error procesando el resultado del pago"),o(!1)}finally{h(!1)}},E=n=>new Date(n).toLocaleDateString("es-ES",{year:"numeric",month:"long",day:"numeric",hour:"2-digit",minute:"2-digit"});return w?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx(S,{className:"h-16 w-16 animate-spin mx-auto text-blue-600 mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Procesando tu pago..."}),e.jsx("p",{className:"text-gray-600",children:"Por favor espera mientras verificamos tu transacción"})]})}):j===!1||N?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-8 text-center",children:[e.jsx(P,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Error en el pago"}),e.jsx("p",{className:"text-gray-600 mb-6",children:N||"Ocurrió un error procesando tu pago"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>d(`/pay/${a}`),className:"w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors",children:"Intentar de nuevo"}),e.jsx("button",{onClick:()=>d("/"),className:"w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors",children:"Ir al inicio"})]})]})}):j&&i?e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-8 text-center",children:[e.jsx(v,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"¡Pago exitoso!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Tu pago ha sido procesado correctamente"}),e.jsx("div",{className:"bg-gray-50 rounded-lg p-4 mb-6 text-left",children:e.jsxs("div",{className:"space-y-3 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Cliente:"}),e.jsx("span",{className:"font-medium",children:i.customer_name})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Monto:"}),e.jsxs("span",{className:"font-medium text-green-600",children:["$",i.amount.toFixed(2)," USD"]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Método:"}),e.jsx("span",{className:"font-medium capitalize",children:i.payment_method})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Transacción:"}),e.jsx("span",{className:"font-medium text-xs break-all",children:i.transaction_id})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Fecha:"}),e.jsx("span",{className:"font-medium text-xs",children:E(i.paid_at)})]})]})}),e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(v,{className:"h-5 w-5 text-green-600 mr-2"}),e.jsx("span",{className:"text-sm text-green-800 font-medium",children:"Pago procesado exitosamente"})]})}),e.jsx("button",{onClick:()=>d("/"),className:"w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors",children:"Finalizar"}),e.jsx("div",{className:"mt-4 text-xs text-gray-500",children:e.jsx("p",{children:"Guarda esta información para tus registros"})})]})}):e.jsx("div",{className:"min-h-screen bg-gray-50 flex items-center justify-center px-4",children:e.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-8 text-center",children:[e.jsx(A,{className:"h-16 w-16 text-yellow-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Estado desconocido"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"No podemos determinar el estado de tu pago en este momento"}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:b,className:"w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors",children:"Verificar nuevamente"}),e.jsx("button",{onClick:()=>d("/"),className:"w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors",children:"Ir al inicio"})]})]})})};export{Y as default};
//# sourceMappingURL=PaymentResult-D7ISFQmP.js.map
