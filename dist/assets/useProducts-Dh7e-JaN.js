import{r as c}from"./react-vendor-Cy458wKG.js";import{P as z}from"./seller-chunk-CL4v7LiS.js";import{u as R,C as i,b as I}from"./admin-chunk-C7Ad4l4I.js";import{u as F}from"./useImageCache-DterQKOY.js";const b=new z,N=C=>{if(!C)return"products_default";const n={...C};return n.categoryIds&&(n.categoryIds=[...n.categoryIds].sort((S,l)=>S-l)),`products_${JSON.stringify(n)}`},q=()=>{const[C,n]=c.useState(!1),[S,l]=c.useState(null),[k,f]=c.useState([]),[w,m]=c.useState(null),[A,_]=c.useState(null),[v,$]=c.useState(!1),{invalidate:E}=R(),{getMultipleImageUrls:y,preloadImages:p}=F(),h=c.useCallback(e=>{if(!e||typeof e!="object")return console.error("Producto inválido para adaptar:",e),{};let o=[];return Array.isArray(e.images)&&e.images.length>0&&(o=e.images.map(t=>typeof t=="string"?t:typeof t=="object"&&t!==null&&(t.original||t.large||t.medium||t.thumbnail||t.url||t.path||t.src)||"").filter(Boolean)),o.length===0&&e.image&&(o=[e.image]),o.length===0&&e.main_image&&(o=[e.main_image]),o.length===0&&e.featured_image&&(o=[e.featured_image]),o.length===0&&e.thumbnail&&(o=[e.thumbnail]),{id:e.id,userId:e.userId||e.user_id,categoryId:e.categoryId||e.category_id,name:e.name,slug:e.slug,description:e.description||"",price:Number(e.price||0),stock:Number(e.stock||0),weight:e.weight,width:e.width,height:e.height,depth:e.depth,dimensions:e.dimensions,colors:e.colors,sizes:e.sizes,tags:e.tags,sku:e.sku,attributes:e.attributes,images:o,featured:!!e.featured,published:!!e.published,status:e.status||"active",viewCount:e.viewCount||e.view_count||0,salesCount:e.salesCount||e.sales_count||0,discountPercentage:e.discountPercentage||e.discount_percentage||0,finalPrice:e.finalPrice||e.final_price,isInStock:e.isInStock||e.is_in_stock,rating:e.rating||e.rating_avg,ratingCount:e.rating_count||e.rating_avg_count,createdAt:e.createdAt||e.created_at,updatedAt:e.updatedAt||e.updated_at,created_at:e.created_at||e.createdAt||new Date().toISOString(),category_name:e.category?.name||e.category_name||"Sin categoría",isNew:void 0}},[]),d=c.useCallback(async e=>{try{const o=e.map(t=>{const a=g=>{if(typeof g=="string")return g;if(g&&typeof g=="object")return g.url||g.original||g.medium||g.thumbnail},u=t.images?.[0]?a(t.images[0]):void 0,s=t.images?t.images.map(a).filter(g=>g!==void 0):void 0;return{image:u,images:s}}),r=y(o,"medium");r.length>0&&setTimeout(()=>{p(r).catch(t=>console.log("⚠️ Error precargando imágenes (no crítico):",t))},100)}catch(o){console.log("⚠️ Error configurando precarga de imágenes:",o)}},[y,p]);c.useEffect(()=>{if(!v){const e=i.getItem("products_featured");e&&(f(e.data||[]),_(e.meta||null),e.data?.length>0&&d(e.data)),$(!0)}},[v,d]);const B=c.useCallback(async e=>{n(!0),l(null);try{const o=N(e),r=i.getItem(o);if(r)return console.log("💾 Usando datos en caché"),f(r.data||[]),_(r.meta||null),n(!1),r.data?.length>0&&d(r.data),r;console.log("🌐 Realizando petición a la API");const t=await b.getProducts(e);if(t){let a=[];Array.isArray(t.data)?a=t.data.map(h):t.data&&typeof t.data=="object"?a=[h(t.data)]:Array.isArray(t)&&(a=t.map(h));const u={data:a,meta:t.meta||{total:a.length,limit:e?.limit||10,offset:e?.offset||0}};return i.setItem(o,u,I.cache.productCacheTime),f(a),_(u.meta),a.length>0&&d(a),u}else return f([]),_({total:0,limit:0,offset:0}),{data:[],meta:{total:0,limit:0,offset:0}}}catch(o){const r=o instanceof Error?o.message:"Error al obtener productos";return l(r),f([]),_({total:0,limit:0,offset:0}),null}finally{n(!1)}},[h,d]),T=c.useCallback(async e=>{n(!0),l(null);const o=`product_${e}`;try{const r=i.getItem(o);if(r)return console.log(`💾 Usando producto en caché con ID ${e}`),m(r),n(!1),r;console.log(`🌐 Obteniendo producto con ID ${e} desde API`);const t=await b.getProductById(e);if(t){if(i.setItem(o,t,I.cache.productCacheTime),m(t),t.images&&t.images.length>0){const a=t.images.map(s=>typeof s=="string"?s:s&&typeof s=="object"&&(s.url||s.original||s.medium||s.thumbnail)||"").filter(Boolean),u=y([{images:a}],"original");setTimeout(()=>{p(u).catch(s=>console.log("⚠️ Error precargando imágenes del producto:",s))},50)}return t}return m(null),null}catch(r){console.error("❌ Error obteniendo detalles de producto:",r);const t=r instanceof Error?r.message:"Error al obtener detalles del producto";return l(t),m(null),null}finally{n(!1)}},[y,p]),U=c.useCallback(async e=>{n(!0),l(null);const o=`product_slug_${e}`;try{const r=i.getItem(o);if(r)return console.log(`💾 Usando producto en caché con slug ${e}`),m(r),n(!1),r;console.log(`🌐 Obteniendo producto con slug ${e} desde API`);const t=await b.getProductBySlug(e);if(t){if(i.setItem(o,t,I.cache.productCacheTime),m(t),t.images&&t.images.length>0){const a=t.images.map(s=>typeof s=="string"?s:s&&typeof s=="object"&&(s.url||s.original||s.medium||s.thumbnail)||"").filter(Boolean),u=y([{images:a}],"original");setTimeout(()=>{p(u).catch(s=>console.log("⚠️ Error precargando imágenes del producto:",s))},50)}return t}return m(null),null}catch(r){console.error("❌ Error obteniendo detalles de producto por slug:",r);const t=r instanceof Error?r.message:"Error al obtener detalles del producto";return l(t),m(null),null}finally{n(!1)}},[y,p]),j=c.useCallback(async(e=8)=>{n(!0),l(null);const o=`products_featured_${e}`;try{const r=i.getItem(o);if(r)return console.log(`💾 Usando productos destacados en caché (límite: ${e})`),f(r),n(!1),d(r),r;console.log(`🌐 Obteniendo productos destacados desde API (límite: ${e})`);const t=await b.getFeaturedProducts(e);if(t&&t.length>0){const a=t.map(h);return i.setItem(o,a,I.cache.productCacheTime),f(a),d(a),a}return f([]),[]}catch(r){console.error("❌ Error obteniendo productos destacados:",r);const t=r instanceof Error?r.message:"Error al obtener productos destacados";return l(t),f([]),[]}finally{n(!1)}},[h,d]),D=c.useCallback(async(e,o=4)=>{n(!0),l(null);const r=`products_related_${e}_${o}`;try{const t=i.getItem(r);if(t)return console.log(`💾 Usando productos relacionados en caché para producto ${e}`),n(!1),d(t),t;console.log(`🌐 Obteniendo productos relacionados desde API para producto ${e}`);const a=await b.getRelatedProducts(e,o);if(a&&a.length>0){const u=a.map(h);return i.setItem(r,u,I.cache.productCacheTime),d(u),u}return[]}catch(t){console.error("❌ Error obteniendo productos relacionados:",t);const a=t instanceof Error?t.message:"Error al obtener productos relacionados";return l(a),[]}finally{n(!1)}},[h,d]),K=c.useCallback(async e=>{try{await b.trackProductView(e)}catch(o){console.error("❌ Error registrando visualización de producto:",o)}},[]),M=c.useCallback(()=>{console.log("🧩 useProducts: Limpiando producto actual"),m(null),l(null)},[]),O=c.useCallback(e=>{e?(i.removeItem(`product_${e}`),E(`product_${e}`),console.log(`🗑️ Caché del producto ${e} eliminada`)):(E("products_*"),E("product_*"),console.log("🗑️ Toda la caché de productos invalidada"))},[E]);return{loading:C,error:S,products:k,product:w,meta:A,fetchProducts:B,fetchProductById:T,fetchProductBySlug:U,fetchFeaturedProducts:j,fetchRelatedProducts:D,trackProductView:K,clearCurrentProduct:M,clearProductCache:O,preloadProductImages:d}};export{q as u};
//# sourceMappingURL=useProducts-Dh7e-JaN.js.map
