import{j as e,a0 as v,H as S,a as w}from"./ui-vendor-DEBjJ4HS.js";import{u as I,j as P,r as n}from"./react-vendor-Cy458wKG.js";import{g as E,c as R,A as C,N as l}from"./admin-chunk-bhOJ3jtA.js";const $=()=>{const s=I(),[t]=P(),{showToast:r}=E(),[y,j]=n.useState(!0),[a,x]=n.useState(null),[p,N]=n.useState(null),d=n.useRef(!1),[b,f]=n.useState(!1);return n.useEffect(()=>{(async()=>{if(d.current||b){console.log("‚ö†Ô∏è Verificaci√≥n ya procesada, omitiendo duplicada");return}d.current=!0,f(!0);try{console.log("üîÑ Iniciando verificaci√≥n de pago Datafast (√∫nica ejecuci√≥n)");const o=t.get("resourcePath")||t.get("resource_path"),c=k(t),u=t.get("simulate")==="true";if(!o||!c)throw new Error("Par√°metros de pago faltantes en la URL");console.log("üîÑ Verificando pago Datafast:",{resourcePath:o,transactionId:c,simulate:u});const m=T(),h={transaction_id:c,resource_path:o,...m&&{session_id:m},...u&&{simulate_success:!0}};console.log("üì§ Enviando datos de verificaci√≥n:",{...h,sessionId_included:!!m,simulation_mode:u});const i=await R.post(C.DATAFAST.VERIFY_PAYMENT,h);if(x(i),i.success)r("¬°Pago procesado exitosamente!",l.SUCCESS),_(),setTimeout(()=>{s(`/orders/${i.data?.order_id}`,{replace:!0})},3e3);else{if(i.error_code==="200.300.404"){console.log("üîç Error 200.300.404 detectado - verificando si hay datos de pago exitoso previo");const g=D();if(g){console.log("‚úÖ Encontrados datos de pago exitoso previo, mostrando como √©xito"),x({success:!0,status:"success",data:g,message:"Pago procesado exitosamente"}),r("¬°Pago procesado exitosamente!",l.SUCCESS),_(),setTimeout(()=>{s(`/orders/${g.order_id}`,{replace:!0})},3e3);return}}r(i.message||"Error procesando el pago",l.ERROR)}}catch(o){console.error("‚ùå Error procesando resultado de pago:",o),d.current=!1,f(!1);const c=o.response?.data?.message||o.message||"Error interno procesando el pago";N(c),r(c,l.ERROR)}finally{j(!1)}})()},[t,s,r]),y?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"text-center",children:[e.jsx(v,{className:"h-12 w-12 animate-spin mx-auto text-blue-600 mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Procesando tu pago..."}),e.jsx("p",{className:"text-gray-600",children:"Por favor espera mientras verificamos tu transacci√≥n"})]})}):p||a&&!a.success?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-8 text-center",children:[e.jsx(S,{className:"h-16 w-16 text-red-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"Error en el pago"}),e.jsx("p",{className:"text-gray-600 mb-6",children:p||a?.message||"Ocurri√≥ un error procesando tu pago"}),a?.error_code&&e.jsxs("p",{className:"text-sm text-gray-500 mb-6",children:["C√≥digo de error: ",a.error_code]}),e.jsxs("div",{className:"space-y-3",children:[e.jsx("button",{onClick:()=>s("/cart",{replace:!0}),className:"w-full bg-blue-600 text-white py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors",children:"Volver al carrito"}),e.jsx("button",{onClick:()=>s("/",{replace:!0}),className:"w-full bg-gray-200 text-gray-800 py-2 px-4 rounded-lg hover:bg-gray-300 transition-colors",children:"Ir al inicio"})]})]})}):a?.success?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gray-50",children:e.jsxs("div",{className:"max-w-md w-full bg-white shadow-lg rounded-lg p-8 text-center",children:[e.jsx(w,{className:"h-16 w-16 text-green-500 mx-auto mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-4",children:"¬°Pago exitoso!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Tu pago ha sido procesado correctamente"}),a.data&&e.jsx("div",{className:"bg-gray-50 rounded-lg p-4 mb-6 text-left",children:e.jsxs("div",{className:"space-y-2 text-sm",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Orden:"}),e.jsxs("span",{className:"font-medium",children:["#",a.data.order_number]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Monto:"}),e.jsxs("span",{className:"font-medium",children:["$",a.data.total]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Transacci√≥n:"}),e.jsx("span",{className:"font-medium text-xs",children:a.data.transaction_id})]})]})}),e.jsx("div",{className:"text-sm text-gray-500 mb-4",children:"Redirigiendo a los detalles de tu orden en 3 segundos..."}),e.jsx("button",{onClick:()=>s(`/orders/${a.data?.order_id}`,{replace:!0}),className:"w-full bg-green-600 text-white py-2 px-4 rounded-lg hover:bg-green-700 transition-colors",children:"Ver mi orden"})]})}):null};function k(s){const t=localStorage.getItem("datafast_transaction_id");return t||s.get("transaction_id")||s.get("transactionId")||s.get("id")}function T(){try{return localStorage.getItem("datafast_session_id")||localStorage.getItem("checkout_session_id")}catch{return null}}function D(){try{const s=localStorage.getItem("datafast_transaction_id"),t=localStorage.getItem("datafast_checkout_data");if(s&&t){const r=JSON.parse(t);return console.log("üîç Datos de checkout encontrados:",{transactionId:s,sessionId:r.sessionId,total:r.totals?.final_total}),{order_id:r.userId||1,order_number:s,transaction_id:s,total:r.totals?.final_total||0,payment_status:"completed",payment_id:s,processed_at:new Date().toISOString()}}return null}catch(s){return console.warn("‚ö†Ô∏è Error verificando pago previo:",s),null}}function _(){try{["datafast_session_id","checkout_session_id","datafast_transaction_id","checkout_data_backup","payment_processing_state","datafast_form_data","datafast_cart_backup","datafast_calculated_total","datafast_order_result","datafast_order_timestamp","datafast_checkout_data"].forEach(t=>{localStorage.removeItem(t)}),console.log("‚úÖ localStorage limpiado despu√©s del pago exitoso")}catch(s){console.warn("‚ö†Ô∏è No se pudo limpiar localStorage:",s)}}export{$ as default};
//# sourceMappingURL=DatafastResultPage-rYBqflLC.js.map
