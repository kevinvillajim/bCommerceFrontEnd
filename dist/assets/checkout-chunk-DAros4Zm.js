import{j as e,D as Te,ag as Re,G as ge,r as we,c as De,J as Oe,ah as Pe,ai as ke,aj as $e,ak as Le,R as ie,al as Ue,am as de,T as Fe,Z as Ne}from"./ui-vendor-BUNMIuFe.js";import{r as p,R as oe,u as ve}from"./react-vendor-Cy458wKG.js";import{A as Ve,L as Me}from"./seller-chunk-6swISJwY.js";import{c as J,A as ee,C as ce,b as ue,g as Ie,h as ne,f as H}from"./admin-chunk-BNcFjXlJ.js";import{u as Ee}from"./chat-chunk-BRsdDZXf.js";class qe{async getCart(){try{console.log("CartService: Obteniendo carrito del usuario");const t=await J.get(ee.CART.GET);return console.log("CartService: Respuesta del carrito:",t),t}catch(t){return console.error("CartService: Error al obtener carrito:",t),{status:"error",message:t instanceof Error?t.message:"Error al obtener carrito",data:{id:0,total:0,items:[],item_count:0}}}}async addToCart(t){try{console.log("CartService: Añadiendo producto al carrito:",t);const o={product_id:t.productId,quantity:t.quantity,attributes:t.attributes},r=await J.post(ee.CART.ADD_ITEM,o);return console.log("CartService: Producto añadido al carrito:",r),r}catch(o){throw console.error("CartService: Error al añadir al carrito:",o),o}}async removeFromCart(t){try{console.log(`CartService: Eliminando producto ${t} del carrito`);const o=await J.delete(ee.CART.REMOVE_ITEM(t));return console.log(`CartService: Producto ${t} eliminado del carrito:`,o),o}catch(o){throw console.error(`CartService: Error al eliminar producto ${t} del carrito:`,o),o}}async updateCartItem(t,o){try{console.log(`CartService: Actualizando cantidad de producto ${t} a ${o}`);const r=await J.put(ee.CART.UPDATE_ITEM(t),{quantity:o});return console.log(`CartService: Cantidad actualizada para producto ${t}:`,r),r}catch(r){throw console.error(`CartService: Error al actualizar cantidad de producto ${t}:`,r),r}}async clearCart(){try{console.log("CartService: Vaciando carrito");const t=await J.post(ee.CART.EMPTY);return console.log("CartService: Carrito vaciado:",t),t}catch(t){throw console.error("CartService: Error al vaciar carrito:",t),t}}async validateDiscountCode(t){try{console.log("CartService: Validando código de descuento:",t);const o=await J.post(ee.CART.DISCOUNT.VALIDATE,{code:t});return console.log("CartService: Código de descuento validado:",o),o}catch(o){throw console.error("CartService: Error al validar código de descuento:",o),o}}async applyDiscountCode(t){try{console.log("CartService: Aplicando código de descuento:",t);const o=await J.post(ee.CART.DISCOUNT.APPLY,{code:t});return console.log("CartService: Código de descuento aplicado:",o),o}catch(o){throw console.error("CartService: Error al aplicar código de descuento:",o),o}}async removeDiscountCode(){try{console.log("CartService: Removiendo código de descuento");const t=await J.post(ee.CART.DISCOUNT.REMOVE);return console.log("CartService: Código de descuento removido:",t),t}catch(t){throw console.error("CartService: Error al remover código de descuento:",t),t}}}var L=(g=>(g.SUCCESS="success",g.ERROR="error",g.INFO="info",g.WARNING="warning",g))(L||{});const je=p.createContext({cart:null,loading:!1,error:null,addToCart:async()=>!1,removeFromCart:async()=>!1,updateCartItem:async()=>!1,clearCart:async()=>!1,fetchCart:async()=>{},itemCount:0,totalAmount:0,notification:null,showNotification:()=>{},hideNotification:()=>{},cartItemCount:0,appliedDiscount:null,validateDiscountCode:async()=>({success:!1,message:"Not implemented"}),applyDiscountCode:async()=>({success:!1,message:"Not implemented"}),removeDiscountCode:async()=>({success:!1,message:"Not implemented"})}),me=new Me,se=new qe,pe={CART_USER:"cart_user_data",CART_GUEST:"cart_guest_data"},Be={CART:3*60*1e3},it=({children:g})=>{const[t,o]=p.useState(null),[r,s]=p.useState(!1),[a,c]=p.useState(null),[i,v]=p.useState(0),[f,d]=p.useState(0),[m,h]=p.useState(null),[E,N]=p.useState(null),{isAuthenticated:D}=p.useContext(Ve),V=p.useRef(!1),k=p.useRef(""),w=p.useRef(D),$=p.useRef(null),Y=p.useRef(null),A=p.useRef(!1),W=p.useRef(null);p.useEffect(()=>{w.current=D},[D]);const X=p.useCallback((u,l)=>{$.current&&clearTimeout($.current),h({id:Date.now().toString(),type:u,message:l}),$.current=setTimeout(()=>{h(null),$.current=null},3e3)},[]),Z=p.useCallback(()=>{$.current&&(clearTimeout($.current),$.current=null),h(null)},[]);p.useEffect(()=>()=>{$.current&&clearTimeout($.current),Y.current&&clearTimeout(Y.current),W.current&&clearTimeout(W.current)},[]);const M=p.useCallback(()=>{ce.removeItem(pe.CART_USER),ce.removeItem(pe.CART_GUEST),ce.removeItem("header_counters"),console.log("🗑️ Cart cache invalidated")},[]),S=p.useCallback(u=>!u||u.length===0?0:u.reduce((l,R)=>l+R.quantity,0),[]),P=p.useCallback(async()=>{if(A.current)return null;A.current=!0;try{s(!0),c(null);const u=w.current?pe.CART_USER:pe.CART_GUEST,l=ce.getItem(u);if(l)return console.log("📦 Using cached cart data"),o(l),v(l.items?l.items.length:0),d(l.total||0),k.current=JSON.stringify(l),s(!1),A.current=!1,l;console.log("🌐 Fetching cart from API...");const R=await se.getCart();if(R&&R.status==="success"&&R.data){const n={id:R.data.id,total:R.data.total,items:R.data.items.map(O=>{const C=O.product||{};return{id:O.id,productId:C.id||0,quantity:O.quantity,price:O.price,subtotal:O.subtotal,attributes:O.attributes,final_price:O.final_price||O.price,original_price:O.original_price||O.price,volume_discount_percentage:O.volume_discount_percentage||0,volume_savings:O.volume_savings||0,discount_label:O.discount_label||void 0,product:{id:C.id||0,name:C.name||"Producto sin nombre",slug:C.slug,price:C.price||0,final_price:C.final_price??C.price??0,discount_percentage:C.discount_percentage??0,rating:C.rating??0,rating_count:C.rating_count??0,image:C.main_image||C.image||(C.images&&C.images.length>0?typeof C.images[0]=="string"?C.images[0]:C.images[0].original||C.images[0].medium||C.images[0].thumbnail:void 0),main_image:C.main_image||C.image||(C.images&&C.images.length>0?typeof C.images[0]=="string"?C.images[0]:C.images[0].original||C.images[0].medium||C.images[0].thumbnail:void 0),stockAvailable:C.stock||0,sellerId:C.sellerId||C.seller_id||(C.seller?C.seller.id:void 0)||C.user_id,seller_id:C.seller_id||C.sellerId||(C.seller?C.seller.id:void 0)||C.user_id,seller:C.seller,user_id:C.user_id,stock:C.stock||0,is_in_stock:C.is_in_stock??!0}}}),item_count:R.data.item_count||0,subtotal:R.data.subtotal||R.data.total,total_volume_savings:R.data.total_volume_savings||0,volume_discounts_applied:R.data.volume_discounts_applied||!1};ce.setItem(u,n,Be.CART);const y=S(n.items),T=R.data.item_count||y;return o(n),v(T),d(n.total),k.current=JSON.stringify(n),console.log("✅ Cart loaded successfully:",{itemCount:T,total:n.total,items:n.items.length,volume_discounts_applied:n.volume_discounts_applied}),n}throw new Error("Formato de respuesta de carrito inválido")}catch(u){console.error("Error al obtener carrito desde la API:",u),c(u instanceof Error?u.message:"Error al obtener carrito");const l=me.getItem(ue.storage.cartKey);if(l)try{const R=typeof l=="string"?JSON.parse(l):l;o(R),k.current=JSON.stringify(R);const n=S(R.items||[]);v(n),d(R.total||0)}catch(R){console.error("Error al usar caché local del carrito:",R)}return null}finally{s(!1),A.current=!1}},[S]),B=p.useCallback(async()=>{Y.current&&clearTimeout(Y.current),Y.current=setTimeout(async()=>{if(w.current)await P();else{const u=me.getItem(ue.storage.cartKey);if(u)try{const l=typeof u=="string"?JSON.parse(u):u;o(l),k.current=JSON.stringify(l);const R=S(l.items||[]);v(R),d(l.total||0)}catch(l){console.error("Error al parsear carrito del localStorage:",l)}else o({id:0,items:[],total:0}),v(0),d(0)}Y.current=null},100)},[P,S]);p.useEffect(()=>{V.current=!0},[D]),p.useEffect(()=>{if(!t){v(0),d(0);return}W.current&&clearTimeout(W.current),W.current=setTimeout(()=>{const u=t.items?t.items.length:0;i!==u&&v(u),f!==t.total&&d(t.total);const l=JSON.stringify(t);!w.current&&l!==k.current&&(me.setItem(ue.storage.cartKey,l),k.current=l),W.current=null},100)},[t,S,i,f]);const G=p.useCallback(async u=>{try{if(!t)return!1;const l=t.items.findIndex(n=>n.productId===u.productId);let R;if(l>=0){const n=[...t.items];n[l].quantity+=u.quantity,n[l].subtotal=n[l].price*n[l].quantity;const y=n.reduce((T,O)=>T+O.subtotal,0);R={...t,items:n,total:y}}else{const y={id:Date.now(),productId:u.productId,quantity:u.quantity,price:0,subtotal:0*u.quantity},T=[...t.items,y],O=T.reduce((C,F)=>C+F.subtotal,0);R={...t,items:T,total:O}}return o(R),k.current=JSON.stringify(R),!0}catch(l){return console.error("Error al añadir producto al carrito:",l),!1}},[t]),_=p.useCallback(async u=>{if(!w.current){const l=await G(u);return await B(),l}try{s(!0);const l=await se.addToCart(u);if(l&&l.status==="success")return M(),await B(),!0;throw new Error(l?.message||"No se pudo agregar al carrito")}catch(l){return console.error("Error al agregar producto al carrito:",l),c(l instanceof Error?l.message:"Error al agregar producto al carrito"),!1}finally{s(!1)}},[G,B,M]),b=p.useCallback(async u=>{try{if(!t)return!1;const l=t.items.filter(y=>y.id!==u),R=l.reduce((y,T)=>y+T.subtotal,0),n={...t,items:l,total:R};return o(n),k.current=JSON.stringify(n),!0}catch(l){return console.error("Error al eliminar producto del carrito:",l),!1}},[t]),q=p.useCallback(async u=>{if(!w.current){const l=await b(u);return await B(),l}try{s(!0);const l=await se.removeFromCart(u);if(l&&l.status==="success")return M(),await B(),!0;throw new Error(l?.message||"No se pudo eliminar del carrito")}catch(l){return console.error("Error al eliminar producto del carrito:",l),c(l instanceof Error?l.message:"Error al eliminar producto del carrito"),!1}finally{s(!1)}},[b,B,M]),Q=p.useCallback(async u=>{try{if(!t)return!1;const l=t.items.map(y=>y.id===u.itemId?{...y,quantity:u.quantity,subtotal:y.price*u.quantity}:y),R=l.reduce((y,T)=>y+T.subtotal,0),n={...t,items:l,total:R};return o(n),k.current=JSON.stringify(n),!0}catch(l){return console.error("Error al actualizar producto del carrito:",l),!1}},[t]),K=p.useCallback(async u=>{if(!w.current){const l=await Q(u);return await B(),l}try{s(!0);const l=await se.updateCartItem(u.itemId,u.quantity);if(l&&l.status==="success")return M(),await B(),!0;throw new Error(l?.message||"No se pudo actualizar el carrito")}catch(l){return console.error("Error al actualizar producto del carrito:",l),c(l instanceof Error?l.message:"Error al actualizar producto del carrito"),!1}finally{s(!1)}},[Q,B,M]),x=p.useCallback(async()=>{try{if(!t)return!1;const u={id:t.id,items:[],total:0};return o(u),k.current=JSON.stringify(u),me.setItem(ue.storage.cartKey,JSON.stringify(u)),!0}catch(u){return console.error("Error al vaciar carrito:",u),!1}},[t]),j=p.useCallback(async()=>{if(!w.current){const u=await x();return await B(),u}try{s(!0);const u=await se.clearCart();if(u&&u.status==="success")return M(),!0;throw new Error(u?.message||"No se pudo vaciar el carrito")}catch(u){return console.error("Error al vaciar carrito:",u),c(u instanceof Error?u.message:"Error al vaciar carrito"),!1}finally{s(!1)}},[x,B,M]),U=p.useCallback(async u=>{try{s(!0);const l=await se.validateDiscountCode(u);return l&&l.status==="success"?{success:!0,message:l.message||"Código válido",data:l.data}:{success:!1,message:l?.message||"Código de descuento inválido"}}catch(l){return console.error("Error validating discount code:",l),{success:!1,message:l.response?.data?.message||l.message||"Error al validar código de descuento"}}finally{s(!1)}},[]),I=p.useCallback(async u=>{try{s(!0);const l=await se.applyDiscountCode(u);return l&&l.status==="success"?(l.data?.cart&&(o(l.data.cart),k.current=JSON.stringify(l.data.cart)),l.data?.discount_code&&N({discountCode:l.data.discount_code,appliedAt:new Date}),M(),{success:!0,message:l.message||"Descuento aplicado exitosamente",cart:l.data?.cart}):{success:!1,message:l?.message||"No se pudo aplicar el código de descuento"}}catch(l){return console.error("Error applying discount code:",l),{success:!1,message:l.response?.data?.message||l.message||"Error al aplicar código de descuento"}}finally{s(!1)}},[M]),z=p.useCallback(async()=>{try{s(!0);const u=await se.removeDiscountCode();return u&&u.status==="success"?(u.data?.cart&&(o(u.data.cart),k.current=JSON.stringify(u.data.cart)),N(null),M(),{success:!0,message:u.message||"Descuento removido exitosamente",cart:u.data?.cart}):{success:!1,message:u?.message||"No se pudo remover el código de descuento"}}catch(u){return console.error("Error removing discount code:",u),{success:!1,message:u.response?.data?.message||u.message||"Error al remover código de descuento"}}finally{s(!1)}},[M]);return e.jsxs(je.Provider,{value:{cart:t,loading:r,error:a,addToCart:_,removeFromCart:q,updateCartItem:K,clearCart:j,fetchCart:B,itemCount:i,totalAmount:f,notification:m,showNotification:X,hideNotification:Z,cartItemCount:i,appliedDiscount:E,validateDiscountCode:U,applyDiscountCode:I,removeDiscountCode:z},children:[g,m&&e.jsx("div",{className:"fixed bottom-4 right-4 z-50 max-w-sm",children:e.jsxs("div",{className:`px-4 py-3 rounded-lg shadow-lg flex items-center ${m.type==="success"?"bg-green-600 text-white":m.type==="error"?"bg-red-500 text-white":m.type==="warning"?"bg-yellow-500 text-white":"bg-blue-500 text-white"}`,children:[e.jsx("span",{className:"flex-1",children:m.message}),e.jsx("button",{onClick:Z,className:"ml-2 text-white",children:"×"})]})})]})},ye=()=>{const g=p.useContext(je);if(!g)throw new Error("useCart debe usarse dentro de un CartProvider");return g};class Ge{static extractUserMessage(t){if(t?.response?.data){const o=t.response.data;if(o.message)return this.translateErrorMessage(o.message);if(o.errors&&Array.isArray(o.errors))return o.errors.map(r=>r.message||r).join(", ");if(o.error)return this.translateErrorMessage(o.error)}return t?.message?this.translateErrorMessage(t.message):typeof t=="string"?this.translateErrorMessage(t):t?.code==="NETWORK_ERROR"||t?.message?.includes("Network Error")?"Error de conexión. Verifica tu conexión a internet.":t?.code==="ECONNABORTED"||t?.message?.includes("timeout")?"La solicitud tardó demasiado. Inténtalo de nuevo.":"Ha ocurrido un error inesperado. Inténtalo de nuevo."}static translateErrorMessage(t){const o={"Stock insuficiente":"No hay suficiente stock disponible. Reduce la cantidad.","Insufficient stock":"No hay suficiente stock disponible. Reduce la cantidad.","Out of stock":"Producto agotado. No hay unidades disponibles.","No hay suficiente stock":"No hay suficiente stock disponible. Reduce la cantidad.","Producto agotado":"Producto agotado. No hay unidades disponibles.",Unauthorized:"Debes iniciar sesión para realizar esta acción.","Token expired":"Tu sesión ha expirado. Inicia sesión nuevamente.","Invalid credentials":"Credenciales incorrectas. Verifica tu email y contraseña.","Validation failed":"Los datos ingresados no son válidos.","Required field missing":"Faltan campos obligatorios.","Invalid email format":"El formato del email no es válido.","Password too weak":"La contraseña debe ser más segura.","Product not found":"El producto no fue encontrado.","Product unavailable":"El producto no está disponible temporalmente.","Price changed":"El precio del producto ha cambiado. Actualiza la página.","Cart empty":"Tu carrito está vacío.","Cart item not found":"El producto no se encuentra en tu carrito.","Cannot update cart":"No se pudo actualizar el carrito. Inténtalo de nuevo.","Payment failed":"El pago no pudo ser procesado. Verifica tus datos.","Invalid payment method":"Método de pago no válido.","Insufficient funds":"Fondos insuficientes en tu cuenta.","Invalid shipping address":"La dirección de envío no es válida.","Shipping not available":"Envío no disponible para tu ubicación.","Server error":"Error del servidor. Inténtalo más tarde.","Service unavailable":"Servicio temporalmente no disponible.","Rate limit exceeded":"Has realizado demasiadas solicitudes. Espera un momento."};if(o[t])return o[t];const r=t.toLowerCase();return r.includes("stock")||r.includes("existencia")?"Problema con el stock del producto. Verifica la disponibilidad.":r.includes("payment")||r.includes("pago")?"Error en el procesamiento del pago. Verifica tus datos.":r.includes("network")||r.includes("connection")||r.includes("conexión")?"Error de conexión. Verifica tu conexión a internet.":r.includes("timeout")||r.includes("tiempo")?"La operación tardó demasiado. Inténtalo de nuevo.":r.includes("cantidad")||r.includes("disponible")?"Cantidad solicitada no disponible. Verifica el stock.":t}static getNotificationType(t){const r=(t?.response?.data?.message||t?.message||"").toLowerCase();return r.includes("stock")||r.includes("existencia")||r.includes("cantidad")||r.includes("validation")||r.includes("required")?"warning":r.includes("unauthorized")||r.includes("token")||r.includes("login")||r.includes("sesión")?"info":"error"}static handleApiError(t,o){const r=this.extractUserMessage(t),s=this.getNotificationType(t),a=this.shouldRetry(t);return console.error(`Error${o?` in ${o}`:""}:`,{originalError:t,userMessage:r,type:s,shouldRetry:a}),{message:r,type:s,shouldRetry:a}}static shouldRetry(t){if(t?.code==="NETWORK_ERROR"||t?.code==="ECONNABORTED"||t?.message?.includes("timeout")||t?.message?.includes("Network Error")||t?.response?.status>=500)return!0;if(t?.response?.status>=400&&t?.response?.status<500)return[408,429].includes(t.response.status);const o=t?.response?.data?.message||t?.message||"";return o.toLowerCase().includes("stock")||o.toLowerCase().includes("existencia")||o.toLowerCase().includes("cantidad"),!1}static handleStockError(t,o){return{message:`Solo hay ${t} unidad${t!==1?"es":""} disponible${t!==1?"s":""} en stock. Solicitaste ${o}.`,type:"warning",shouldRetry:!1}}static handleValidationError(t){const o=Object.values(t).flat();return{message:o.length>0?o.join(". "):"Error de validación",type:"warning",shouldRetry:!1}}}const ze=({showNotification:g,context:t})=>{const o=p.useCallback((a,c)=>{const i=Ge.handleApiError(a,t),v=c||i.message,d={error:L.ERROR,warning:L.WARNING,info:L.INFO}[i.type]||L.ERROR;return g(d,v),i.shouldRetry},[g,t]),r=p.useCallback(a=>{g(L.SUCCESS,a)},[g]),s=p.useCallback((a,c)=>{const i=`Solo hay ${a} unidad${a!==1?"es":""} disponible${a!==1?"s":""} en stock. Solicitaste ${c}.`;g(L.WARNING,i)},[g]);return{handleError:o,handleSuccess:r,handleStockError:s}},He=Ie.getInstance(),be=[{quantity:3,discount:5,label:"3+"},{quantity:6,discount:10,label:"6+"},{quantity:12,discount:15,label:"12+"}];function Je(g,t,o){const r=be;let s=null;for(const v of r)if(t>=v.quantity)s=v;else break;if(!s)return{originalPrice:g,discountedPrice:g,discountPercentage:0,savings:0,savingsTotal:0,hasDiscount:!1,tierLabel:null};const a=g*(1-s.discount/100),c=g-a,i=c*t;return{originalPrice:g,discountedPrice:a,discountPercentage:s.discount,savings:c,savingsTotal:i,hasDiscount:!0,tierLabel:s.label}}async function We(g,t,o){let r=o;if(!r)try{const f=await He.getUnifiedConfig();f.config.volume_discounts&&Array.isArray(f.config.volume_discounts)&&f.config.volume_discounts.length>0&&(r=f.config.volume_discounts)}catch(f){console.warn("Error obteniendo configuración de descuentos, usando defaults:",f),r=be}(!r||r.length===0)&&(r=be);let s=null;const a=[...r].sort((f,d)=>f.quantity-d.quantity);for(const f of a)if(t>=f.quantity)s=f;else break;if(!s)return{originalPrice:g,discountedPrice:g,discountPercentage:0,savings:0,savingsTotal:0,hasDiscount:!1,tierLabel:null};const c=g*(1-s.discount/100),i=g-c,v=i*t;return{originalPrice:g,discountedPrice:c,discountPercentage:s.discount,savings:i,savingsTotal:v,hasDiscount:!0,tierLabel:s.label}}function dt(g){const t=g.product?.price||g.price||0,o=g.product?.discount_percentage||0,r=g.quantity||1,s=t*(o/100),a=t-s,c=Je(a,r),i=c.discountedPrice,v=s*r,f=c.savingsTotal,d=v+f,m=c.hasDiscount,h=m?c.discountPercentage:o;return{originalPrice:t,discountedPrice:i,discountPercentage:h,savings:t-i,savingsTotal:d,hasDiscount:o>0||m,sellerDiscountAmount:s,volumeDiscountAmount:c.savings,finalPricePerUnit:i}}async function Qe(g,t){const o=g.product?.price||g.price||0,r=g.product?.discount_percentage||0,s=g.quantity||1,a=o*(r/100),c=o-a,i=await We(c,s,t),v=i.discountedPrice,f=a*s,d=i.savingsTotal,m=f+d,h=i.hasDiscount,E=h?i.discountPercentage:r;return{originalPrice:o,discountedPrice:v,discountPercentage:E,savings:o-v,savingsTotal:m,hasDiscount:r>0||h,sellerDiscountAmount:a,volumeDiscountAmount:i.savings,finalPricePerUnit:v}}class xe{static configManager=Ie.getInstance();static async calculateTotals(t,o,r=!1){console.log("🧮 JORDAN CALCULADORA - INICIANDO CON CONFIGURACIÓN UNIFICADA",{forceRefresh:r,itemsCount:t.length});const s=await this.configManager.getUnifiedConfig(r),a=s.config;console.log("✅ JORDAN - Configuración obtenida:",{source:s.source,isStale:s.is_stale,taxRate:a.tax_rate,commissionRate:a.platform_commission_rate,shippingCost:a.shipping.default_cost,volumeTiers:a.volume_discounts.length});const c=this.calculateOriginalSubtotal(t);console.log(`1️⃣ Subtotal original: $${c.toFixed(2)}`);const{subtotal:i,totalDiscount:v}=this.calculateSellerDiscounts(t,c);console.log(`2️⃣ Después descuento vendedor: $${i.toFixed(2)}`);const{subtotal:f,totalDiscount:d}=this.calculateVolumeDiscounts(t,i,a.volume_discounts);console.log(`3️⃣ Después descuento volumen: $${f.toFixed(2)}`);const{subtotal:m,discount:h}=this.calculateCouponDiscount(f,o);console.log(`4️⃣ Después cupón: $${m.toFixed(2)}`);const E=this.calculateShipping(m,a.shipping),N=m+E;console.log(`5️⃣ Con envío: $${N.toFixed(2)} (envío: $${E.toFixed(2)})`);const D=N*a.tax_rate;console.log(`6️⃣ IVA calculado: $${D.toFixed(2)} (${(a.tax_rate*100).toFixed(1)}%)`);const V=N+D;console.log(`7️⃣ TOTAL FINAL: $${V.toFixed(2)}`);const k=v+d+h,w=d>0,$=E===0;return console.log("📊 JORDAN - RESUMEN CON CONFIGURACIÓN UNIFICADA:"),console.log(`   💰 Configuración: ${s.source} (${a.version})`),console.log(`   💰 Tax rate: ${(a.tax_rate*100).toFixed(1)}% (dinámico)`),console.log(`   💰 Volume tiers: ${a.volume_discounts.length} configurados`),console.log(`   💰 Shipping: $${a.shipping.default_cost} (umbral: $${a.shipping.free_threshold})`),{step1_originalSubtotal:c,step2_afterSellerDiscount:i,step3_afterVolumeDiscount:f,step4_afterCoupon:m,step5_withShipping:N,step6_tax:D,step7_finalTotal:V,sellerDiscounts:v,volumeDiscounts:d,couponDiscount:h,totalDiscounts:k,shipping:E,freeShipping:$,volumeDiscountsApplied:w,configMetadata:{source:s.source,version:a.version,isStale:s.is_stale,warnings:s.warnings},originalSubtotal:c,subtotalAfterSellerDiscount:i,subtotalAfterVolumeDiscount:f,subtotalAfterCoupon:m,subtotalWithShipping:N,tax:D,total:V}}static calculateOriginalSubtotal(t){let o=0;return t.forEach(r=>{const s=this.getBasePrice(r),a=r.quantity||0,c=s*a;console.log(`📦 Item: precio base $${s} × ${a} = $${c}`),o+=c}),o}static calculateSellerDiscounts(t,o){let r=0,s=0;return t.forEach(a=>{const c=this.getBasePrice(a),i=a.quantity||0,v=this.getSellerDiscountPercentage(a),f=c*(v/100),d=c-f,m=f*i,h=d*i;r+=m,s+=h,console.log(`🏪 Seller discount: ${v}% sobre $${c} = descuento $${f}/unidad`)}),{subtotal:s,totalDiscount:r}}static calculateVolumeDiscounts(t,o,r){let s=0,a=0;return t.forEach(c=>{const i=c.quantity||0,v=this.getVolumeDiscountPercentage(i,r);if(v>0){const f=this.getPriceAfterSellerDiscount(c),d=f*v,m=f-d,h=d*i,E=m*i;s+=h,a+=E,console.log(`📦 Volume discount: ${(v*100).toFixed(1)}% sobre $${f} = descuento $${d}/unidad`)}else{const f=this.getPriceAfterSellerDiscount(c);a+=f*i}}),{subtotal:a,totalDiscount:s}}static calculateCouponDiscount(t,o){if(!o?.discountCode)return{subtotal:t,discount:0};let r=0;const s=o.discountCode;if(s.discount_percentage){const a=parseFloat(s.discount_percentage);r=t*(a/100)}else s.percentage?r=t*(s.percentage/100):s.value&&(r=Math.min(s.value,t));return console.log(`🎫 Cupón ${s.code}: ${s.discount_percentage||s.percentage||s.value}% = descuento $${r.toFixed(2)}`),{subtotal:t-r,discount:r}}static calculateShipping(t,o){return o.enabled?t>=o.free_threshold?0:o.default_cost:0}static getBasePrice(t){return t.base_price!==void 0?t.base_price:t.product?.price!==void 0?t.product.price:t.price!==void 0&&t.final_price===void 0?t.price:2}static getSellerDiscountPercentage(t){return t.product?.discount_percentage!==void 0?t.product.discount_percentage:50}static getPriceAfterSellerDiscount(t){const o=this.getBasePrice(t),r=this.getSellerDiscountPercentage(t);return o*(1-r/100)}static getVolumeDiscountPercentage(t,o){const r=[...o].sort((s,a)=>a.quantity-s.quantity);for(const s of r)if(t>=s.quantity)return s.discount/100;return 0}static roundForDisplay(t){return parseFloat(t.toFixed(2))}static async prepareCheckoutData(t,o,r=!1){const s=await this.calculateTotals(t,o,r),c=(await this.configManager.getUnifiedConfig(r)).config;return{items:t.map(v=>{const f=this.getBasePrice(v),d=this.getSellerDiscountPercentage(v),m=this.getVolumeDiscountPercentage(v.quantity||0,c.volume_discounts),h=f*(1-d/100),E=m>0?h*(1-m):h;return{product_id:v.product_id||v.product?.id||v.productId,quantity:v.quantity,price:E,base_price:f,original_price:f,final_price:E,volume_discount_percentage:m*100,volume_savings:(h-E)*(v.quantity||0),seller_discount_amount:(f-h)*(v.quantity||0)}}),totals:s}}}class re{static async prepareItemsForCheckout(t,o=null,r=!1){console.log("🛒 JORDAN CheckoutItemsService - Preparando items con configuración unificada",{forceRefresh:r}),console.log("🎫 Cupón para items:",o?.discountCode?.code||"NINGUNO");const{items:s}=await xe.prepareCheckoutData(t,o,r);return s.map((c,i)=>(console.log(`✅ Item ${i+1} preparado para checkout:`,{product_id:c.product_id,quantity:c.quantity,price:c.price,base_price:c.base_price,final_price:c.final_price}),c))}static async calculateCheckoutTotals(t,o=null,r=!1){console.log("🔍 JORDAN - FLUJO CHECKOUT MIGRADO CON CONFIGURACIÓN UNIFICADA:",{forceRefresh:r});const s=await xe.calculateTotals(t,o,r);return console.log("📊 PASO A PASO:"),console.log(`   1️⃣ Subtotal original (sin descuentos): ${s.step1_originalSubtotal}`),console.log(`   2️⃣ Después de seller + volume: ${s.step3_afterVolumeDiscount} ✅ DEBE SER $2.85`),console.log(`   3️⃣ - Cupón 5% sobre subtotal: ${s.couponDiscount} -> Subtotal: ${s.step4_afterCoupon}`),console.log(`   4️⃣ + Envío: ${s.step5_withShipping}`),console.log(`   5️⃣ + IVA 15% sobre ${s.step5_withShipping} : ${s.step6_tax}`),console.log(`   6️⃣ TOTAL FINAL: ${s.step7_finalTotal} ✅ DEBE SER $8.87`),console.log("💰 DESGLOSE COMPLETO:"),console.log(`   - Descuentos seller: ${s.sellerDiscounts}`),console.log(`   - Descuentos volume: ${s.volumeDiscounts}`),console.log(`   - Descuento cupón: ${s.couponDiscount}`),console.log(`   - Total descuentos: ${s.totalDiscounts}`),console.log(`   - Envío: ${s.shipping}`),console.log(`   - IVA (15%): ${s.tax}`),console.log(`🎯 VALOR CORRECTO PARA BACKEND: ${s.total}`),{subtotal:s.step3_afterVolumeDiscount,originalSubtotal:s.originalSubtotal,sellerDiscounts:s.sellerDiscounts,volumeDiscounts:s.volumeDiscounts,totalDiscounts:s.totalDiscounts,couponDiscount:s.couponDiscount,tax:s.tax,shipping:s.shipping,total:s.total,freeShipping:s.freeShipping}}static validateItemsForCheckout(t){const o=[];console.log(`🔍 Validando ${t.length} items para checkout:`),t.forEach((s,a)=>{if(console.log(`📋 Validando Item ${a+1}:`,{product_id:s.product_id,product_id_type:typeof s.product_id,quantity:s.quantity,quantity_type:typeof s.quantity,price:s.price,price_type:typeof s.price}),!s.product_id||typeof s.product_id!="number"||isNaN(s.product_id)||s.product_id<=0){const c=`Item ${a+1}: product_id inválido (${s.product_id}, tipo: ${typeof s.product_id})`;console.error("❌",c),o.push(c)}if(!s.quantity||typeof s.quantity!="number"||isNaN(s.quantity)||s.quantity<=0){const c=`Item ${a+1}: quantity inválida (${s.quantity}, tipo: ${typeof s.quantity})`;console.error("❌",c),o.push(c)}if(typeof s.price!="number"||isNaN(s.price)||s.price<=0){const c=`Item ${a+1}: price inválido (${s.price}, tipo: ${typeof s.price})`;console.error("❌",c),o.push(c)}});const r={valid:o.length===0,errors:o};return console.log("📊 Validación resultado:",r),r}static async debugItemPricing(t,o){console.log("🔍 DEBUG: Comparación usando calculadora centralizada");const s=(await xe.prepareCheckoutData(t)).items;t.forEach((a,c)=>{const i=o[c],v=s[c];console.log(`📦 Item ${c+1}:`,{product_id:a.productId||a.product?.id,quantity:a.quantity,calculated_final_price:v?.price,checkout_price:i?.price,prices_match:Math.abs((i?.price||0)-(v?.price||0))<.01,"✅":"USANDO CALCULADORA CENTRALIZADA"})})}}const le={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_ANALYTICS_ENABLED:"true",VITE_API_BASE_URL:"https://api.comersia.app/api",VITE_APP_DESCRIPTION:"Plataforma de e-commerce ecuatoriana",VITE_APP_ENV:"production",VITE_APP_NAME:"Comersia",VITE_BACKEND_URL:"https://api.comersia.app",VITE_BUNDLE_ANALYZER:"false",VITE_CACHE_DURATION:"3600000",VITE_CACHE_ENABLED:"true",VITE_CSP_ENABLED:"true",VITE_DATAFAST_LOGO_URL:"https://www.datafast.com.ec/images/logo.png",VITE_DATAFAST_MODE:"production",VITE_DATAFAST_WIDGET_URL:"https://eu-test.oppwa.com/v1/paymentWidgets.js",VITE_DEBUG_MODE:"false",VITE_DEUNA_MODE:"production",VITE_ENABLE_DEVTOOLS:"false",VITE_ERROR_REPORTING:"true",VITE_FRONTEND_URL:"https://comersia.app",VITE_GOOGLE_CLIENT_ID:"581090375629-kds9jjgs2pk60iqe05fmjhpf6pps2nsv.apps.googleusercontent.com",VITE_HOT_RELOAD:"false",VITE_HTTPS_ONLY:"true",VITE_IMAGE_BASE_URL:"https://api.comersia.app/storage/",VITE_LOG_LEVEL:"error",VITE_MINIFY:"true",VITE_NODE_ENV:"production",VITE_PAYPAL_MODE:"live",VITE_PERFORMANCE_MONITORING:"true",VITE_SENTRY_ENABLED:"true",VITE_SITE_URL:"https://comersia.app",VITE_SOURCE_MAPS:"false",VITE_STORAGE_PREFIX:"comersia_",VITE_TRACKING_ENABLED:"true",VITE_TREE_SHAKING:"true",VITE_URL_BASE:"http://localhost:8000"},ae=(g,t)=>{const o=le?.[g];return o&&!isNaN(Number(o))?Number(o):t},fe={PRECISION:{PRICE_COMPARISON_TOLERANCE:ae("VITE_PRICE_TOLERANCE",.001),DISPLAY_DECIMALS:ae("VITE_PRICE_DECIMALS",2),DISCOUNT_TOLERANCE:ae("VITE_DISCOUNT_TOLERANCE",.001)},VALIDATIONS:{CHECKOUT_TOLERANCE:ae("VITE_CHECKOUT_TOLERANCE",.001),SUBTOTAL_TOLERANCE:ae("VITE_SUBTOTAL_TOLERANCE",.001),TAX_TOLERANCE:ae("VITE_TAX_TOLERANCE",.001)},DEBUG:{SHOW_CALCULATION_LOGS:le?.VITE_DEBUG_CALCULATIONS==="true"||le?.NODE_ENV==="development",SHOW_PRECISION_WARNINGS:le?.VITE_DEBUG_PRECISION==="true"||le?.NODE_ENV==="development"}},ut=(g,t,o=fe.PRECISION.PRICE_COMPARISON_TOLERANCE)=>{const r=Math.abs(g-t),s=r<=o;return fe.DEBUG.SHOW_PRECISION_WARNINGS&&r>0&&r<=o&&console.warn(`⚠️ Diferencia de precisión detectada: ${g} vs ${t} (diff: ${r.toFixed(6)}, tolerance: ${o})`),s},Ke=(g,t,o="Comparación de totales",r)=>{const s=r??fe.VALIDATIONS.CHECKOUT_TOLERANCE,a=Math.abs(g-t),c=a<=s;return fe.DEBUG.SHOW_CALCULATION_LOGS&&console.log(`🔍 ${o}:`,{frontendTotal:g.toFixed(6),backendTotal:t.toFixed(6),difference:a.toFixed(6),tolerance:s.toFixed(6),isValid:c,status:c?"✅ VÁLIDO":"❌ DISCREPANCIA"}),c};class he{static getSellerIdFromCart(t){if(!t||!t.items||t.items.length===0)return console.log("🛒 getSellerIdFromCart: Carrito vacío o sin items"),null;console.log("🛒 getSellerIdFromCart: Analizando carrito:",{totalItems:t.items.length,items:t.items.map(r=>({id:r.id,productId:r.productId,quantity:r.quantity,productData:r.product}))});const o=t.items[0];if(console.log("🛒 getSellerIdFromCart: Primer item del carrito:",o),o.product){if(console.log("🛒 getSellerIdFromCart: Producto encontrado:",{sellerId:o.product.sellerId,seller_id:o.product.seller_id,seller:o.product.seller,user_id:o.product.user_id}),o.product.sellerId)return console.log("✅ getSellerIdFromCart: Usando sellerId:",o.product.sellerId),o.product.sellerId;if(o.product.seller_id)return console.log("✅ getSellerIdFromCart: Usando seller_id:",o.product.seller_id),o.product.seller_id;if(o.product.seller&&o.product.seller.id)return console.log("✅ getSellerIdFromCart: Usando seller.id:",o.product.seller.id),o.product.seller.id;if(o.product.user_id)return console.log("✅ getSellerIdFromCart: Usando user_id como fallback:",o.product.user_id),o.product.user_id}return console.warn("❌ getSellerIdFromCart: No se pudo obtener seller ID del carrito:",t),null}async processCheckout(t,o){try{if(console.log("🚀 CheckoutService.processCheckout INICIADO CON DESCUENTOS POR VOLUMEN"),console.log("📦 Datos de checkout enviados:",JSON.stringify(t,null,2)),!t.shippingAddress.name)throw new Error("El nombre en la dirección de envío es requerido");let r=t.payment.method;const s={transfer:"datafast",credit_card:"credit_card",debit_card:"debit_card",paypal:"paypal",qr:"de_una",datafast:"datafast",de_una:"de_una"};s[r]&&(r=s[r]),console.log("🔍 DEBUGGING - Método después de mapear:",r);const a=t.items||[];console.log("🔍 DEBUGGING - Items recibidos:",a),a.length===0&&console.warn("⚠️ No se recibieron items en checkoutData");const c=re.validateItemsForCheckout(a);if(!c.valid)throw new Error(`Validación de items falló: ${c.errors.join(", ")}`);console.log("✅ Items validados correctamente:",a);const i=t.discount_info||(t.discount_code?{discountCode:{code:t.discount_code,discount_percentage:5,discount_amount:0}}:null);console.log("🔍 USANDO TOTALES PRECALCULADOS (NO SE RECALCULA):"),console.log("   📊 calculated_totals recibidos:",t.calculated_totals),console.log("🔍 FLUJO COMPLETO DE CHECKOUT CORREGIDO:"),console.log("1️⃣ Items del carrito:",t.items?.length||0),console.log("2️⃣ Código de descuento:",t.discount_code||"NINGUNO"),console.log("3️⃣ appliedDiscount:",i),console.log("4️⃣ TOTALES EXACTOS CALCULADOS (CALCULADORA CENTRALIZADA):",t.calculated_totals),console.log("5️⃣ Total final CORRECTO que debe guardarse en DB:",t.calculated_totals?.total,"✅ DEBE SER $8.87");const v=(t.shippingAddress.name||"").split(" "),f={payment:{...t.payment,method:r},shipping:{first_name:v[0]||"",last_name:v.slice(1).join(" ")||"",email:o||"",phone:t.shippingAddress.phone||"",address:t.shippingAddress.street||"",city:t.shippingAddress.city||"",state:t.shippingAddress.state||"",postal_code:t.shippingAddress.postalCode||"",country:t.shippingAddress.country||""},seller_id:t.seller_id,items:a,calculated_totals:t.calculated_totals||{subtotal:0,tax:0,shipping:0,total:0,total_discounts:0}};if(t.discount_code&&t.discount_code.trim()!==""?(f.discount_code=t.discount_code.trim(),console.log("✅ Cupón aplicado enviado al backend:",f.discount_code)):console.log("✅ No hay cupón - campo discount_code omitido del request"),console.log("🔍 DEBUGGING - Datos completos enviados al backend:",JSON.stringify(f,null,2)),console.log("💰 TOTALES CRÍTICOS CORREGIDOS QUE DEBE USAR EL BACKEND:"),console.log("   📊 Subtotal:",t.calculated_totals?.subtotal),console.log("   📊 IVA:",t.calculated_totals?.tax),console.log("   📊 Envío:",t.calculated_totals?.shipping),console.log("   📊 TOTAL FINAL:",t.calculated_totals?.total,"✅ DEBE SER $8.87"),console.log("   📊 Total descuentos:",t.calculated_totals?.total_discounts),console.log("🚨 EL BACKEND NO DEBE RECALCULAR - USAR ESTOS TOTALES EXACTOS"),console.log("🚨 TOTAL ESPERADO EN RESPUESTA:",t.calculated_totals?.total),f.items&&f.items.length>0){for(let m=0;m<f.items.length;m++){const h=f.items[m];if(!h.hasOwnProperty("price")||h.price===void 0||h.price===null)throw new Error(`FATAL: Item ${m} no tiene campo 'price' definido. Item: ${JSON.stringify(h)}`);if(typeof h.price!="number"||h.price<=0)throw new Error(`FATAL: Item ${m} tiene precio inválido: ${h.price} (tipo: ${typeof h.price})`)}console.log("✅ VALIDACIÓN FINAL: Todos los items tienen precios finales válidos")}const d=await J.post(ee.CHECKOUT.PROCESS,f);if(console.log("✅ CheckoutService: Respuesta del backend:"),console.log("📊 Status:",d.status),console.log("💬 Message:",d.message),console.log("📦 Data:",JSON.stringify(d.data,null,2)),d.data&&typeof d.data=="object"){const m=d.data;m.total_savings&&m.total_savings>0&&(console.log("💰 DESCUENTOS APLICADOS EN LA ORDEN:"),console.log(`💵 Total ahorrado: $${m.total_savings}`),m.volume_discount_savings&&console.log(`📈 Descuentos por volumen: $${m.volume_discount_savings}`),m.seller_discount_savings&&console.log(`🏪 Descuentos del seller: $${m.seller_discount_savings}`))}return console.log("🎉 CheckoutService.processCheckout COMPLETADO CON DESCUENTOS POR VOLUMEN"),d}catch(r){console.error("❌ CheckoutService: Error al procesar checkout:"),console.error("📊 Error object:",r),console.error("📊 Error message:",r?.message),console.error("📊 Error response:",r?.response?.data),r?.response?.status===400&&(console.error("🔍 ERROR 400 DETECTADO - Analizando request enviada:"),console.error("📊 Payment method enviado:",t.payment.method),console.error("📊 Items enviados:",t.items),console.error("📊 Seller ID enviado:",t.seller_id));const s=ne(r,"Error al procesar el pago. Por favor, intenta de nuevo más tarde.");throw console.error("📊 Error message final:",s),new Error(s)}}async getCurrentCart(){try{return console.log("🛒 Obteniendo carrito actual..."),null}catch(t){return console.error("❌ Error al obtener carrito actual:",t),null}}static async prepareCartItemsForCheckout(t,o=null){console.log("🛒 Preparando items del carrito con descuentos"),console.log("🎫 Cupón aplicado:",o?.discountCode?.code||"NINGUNO");const r=await re.prepareItemsForCheckout(t,o);return await re.debugItemPricing(t,r),console.log("✅ Items preparados para checkout:",r),r}static calculateCheckoutTotals(t){return re.calculateCheckoutTotals(t)}static validateCheckoutTotals(t,o,r){return Ke(t,o,"Validación CheckoutService",r)}}const Ye=({content:g})=>e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"mb-4 text-gray-600",children:"Paga con Datafast!, ingresa los datos personales para pagar de forma rápida y segura."}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-[linear-gradient(to_right,_rgba(0,184,110,1)_0%,_rgba(0,77,112,1)_46%,_rgba(0,77,112,1)_100%)] border-purple-200 rounded-lg p-6",children:e.jsx("div",{className:"flex items-center justify-center mb-4 h-50",children:e.jsx("img",{src:"https://www.datafast.com.ec/images/logo.png",alt:"Datafast Logo",className:"h-20"})})}),g]}),e.jsxs("div",{className:"mt-4 text-sm text-gray-500",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"1."}),' Haz clic en "Pagar con Datafast!"']}),e.jsxs("p",{children:[e.jsx("strong",{children:"2."})," Completa los datos de tu tarjeta de crédito o débito."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"3."})," Confirma tu compra al finalizar."]})]})]})});class te{static BASE_PATH="/deuna";static async createPayment(t){try{console.log("DeunaService: Creating payment",t),console.log("🔍 DEUNA SERVICE - EXACT PAYLOAD TO SEND:",{path:`${this.BASE_PATH}/payments`,payload:t,payload_json:JSON.stringify(t),items_in_payload:t.items,items_count:t.items?.length||0,first_item_keys:t.items&&t.items.length>0?Object.keys(t.items[0]):"no_items"});const o=await J.post(`${this.BASE_PATH}/payments`,t);return console.log("DeunaService: Payment created successfully",o),o}catch(o){throw console.error("DeunaService: Error creating payment",o),new Error(o.response?.data?.message||o.message||"Error creating payment")}}static async generateQR(t){try{console.log("DeunaService: Generating QR code",t);const o=await J.post(`${this.BASE_PATH}/payments/qr`,t);return console.log("DeunaService: QR code generated successfully",o),o}catch(o){throw console.error("DeunaService: Error generating QR code",o),new Error(o.response?.data?.message||o.message||"Error generating QR code")}}static async getPaymentStatus(t){try{console.log("DeunaService: Getting payment status",{paymentId:t});const o=await J.get(`${this.BASE_PATH}/payments/${t}/status`);return console.log("DeunaService: Payment status retrieved",o),o}catch(o){throw console.error("DeunaService: Error getting payment status",o),new Error(o.response?.data?.message||o.message||"Error getting payment status")}}static async getPaymentByOrderId(t){try{console.log("DeunaService: Getting payment by order ID",{orderId:t});const o=await J.get(`${this.BASE_PATH}/orders/${t}/payment`);return console.log("DeunaService: Payment retrieved by order ID",o),o}catch(o){throw console.error("DeunaService: Error getting payment by order ID",o),new Error(o.response?.data?.message||o.message||"Error getting payment")}}static async cancelPayment(t,o){try{console.log("DeunaService: Cancelling payment",{paymentId:t,reason:o});const r=await J.post(`${this.BASE_PATH}/payments/${t}/cancel`,{reason:o||"Cancelled by user"});return console.log("DeunaService: Payment cancelled successfully",r),r}catch(r){throw console.error("DeunaService: Error cancelling payment",r),new Error(r.response?.data?.message||r.message||"Error cancelling payment")}}static async voidPayment(t,o,r){try{console.log("DeunaService: Processing void/refund",{paymentId:t,amount:o,reason:r});const s=await J.post(`${this.BASE_PATH}/payments/${t}/void`,{amount:o,reason:r||"Void/refund requested by user"});return console.log("DeunaService: Payment void/refund processed successfully",s),s}catch(s){throw console.error("DeunaService: Error processing void/refund",s),new Error(s.response?.data?.message||s.message||"Error processing void/refund")}}static async listPayments(t){try{console.log("DeunaService: Listing payments",t);const o=new URLSearchParams;t&&Object.entries(t).forEach(([s,a])=>{a!=null&&a!==""&&o.append(s,String(a))});const r=await J.get(`${this.BASE_PATH}/payments?${o.toString()}`);return console.log("DeunaService: Payments listed successfully",r),r}catch(o){throw console.error("DeunaService: Error listing payments",o),new Error(o.response?.data?.message||o.message||"Error listing payments")}}static pollPaymentStatus(t,o){const r=o?.maxAttempts||60,s=o?.interval||5e3,a=o?.onStatusChange,c=new AbortController;return{promise:new Promise(async(v,f)=>{let d=0,m="",h=null;const E=()=>{h&&(clearTimeout(h),h=null)},N=()=>{E(),f(new Error("Payment polling was cancelled"))};c.signal.addEventListener("abort",N);try{for(;d<r&&!c.signal.aborted;)try{const D=await this.getPaymentStatus(t),V=D.data.status;if(c.signal.aborted){E();return}if(V!==m&&a&&(a(V),m=V),["completed","failed","cancelled","refunded"].includes(V)){console.log(`DeunaService: Payment reached final status: ${V}`),E(),c.signal.removeEventListener("abort",N),v(D);return}d++,d<r&&!c.signal.aborted&&await new Promise((k,w)=>{h=setTimeout(()=>{h=null,c.signal.aborted?w(new Error("Cancelled")):k()},s);const $=()=>{h&&(clearTimeout(h),h=null),w(new Error("Cancelled"))};c.signal.addEventListener("abort",$,{once:!0})})}catch(D){if(c.signal.aborted){E();return}console.warn(`DeunaService: Error polling payment status (attempt ${d+1})`,D),d++,d<r&&await new Promise((V,k)=>{h=setTimeout(()=>{h=null,c.signal.aborted?k(new Error("Cancelled")):V()},s);const w=()=>{h&&(clearTimeout(h),h=null),k(new Error("Cancelled"))};c.signal.addEventListener("abort",w,{once:!0})})}E(),c.signal.removeEventListener("abort",N),c.signal.aborted?f(new Error("Payment polling was cancelled")):f(new Error(`Payment status polling timed out after ${r} attempts`))}catch(D){E(),c.signal.removeEventListener("abort",N),D.message==="Cancelled"?f(new Error("Payment polling was cancelled")):f(D)}}),cancel:()=>{console.log("DeunaService: Cancelling payment polling"),c.abort()}}}static isValidQRCode(t){if(!t||t.trim()==="")return!1;if(t.startsWith("data:image/"))return!0;try{return new URL(t),!0}catch{return!1}}static formatCurrency(t,o="USD"){return new Intl.NumberFormat("es-EC",{style:"currency",currency:o,minimumFractionDigits:2,maximumFractionDigits:2}).format(t)}static getPaymentMethodDisplayName(t){return{qr_code:"Código QR",payment_link:"Enlace de Pago",numeric_code:"Código Numérico",deuna:"DeUna"}[t]||t}static getStatusDisplay(t){return{created:{label:"Creado",color:"blue",icon:oe.createElement(Oe,{className:"w-4 h-4"})},pending:{label:"Pendiente",color:"yellow",icon:oe.createElement(De,{className:"w-4 h-4"})},completed:{label:"Completado",color:"green",icon:oe.createElement(we,{className:"w-4 h-4"})},failed:{label:"Fallido",color:"red",icon:oe.createElement(ge,{className:"w-4 h-4"})},cancelled:{label:"Cancelado",color:"gray",icon:oe.createElement(Re,{className:"w-4 h-4"})},refunded:{label:"Reembolsado",color:"purple",icon:oe.createElement(Te,{className:"w-4 h-4"})}}[t]||{label:t,color:"gray",icon:oe.createElement(Pe,{className:"w-4 h-4"})}}static async simulatePaymentSuccess(t,o,r){try{console.log("🧪 Simulating payment success for testing",{paymentId:t,amount:o,customerEmail:r});const s=await J.post("/webhooks/deuna/simulate-payment-success",{payment_id:t,amount:o||100,currency:"USD",customer_email:r||"test@example.com",customer_name:"Test Customer"});return console.log("🎉 Payment simulation response:",s),s}catch(s){throw console.error("❌ Error simulating payment:",s),new Error(s.response?.data?.message||s.message||"Error simulando el pago")}}static isDevelopmentMode(){return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"}}const Xe=({total:g,onPaymentSuccess:t,onPaymentError:o})=>{const{cart:r}=ye(),{user:s}=Ee(),[a,c]=p.useState(!1),[i,v]=p.useState(null),[f,d]=p.useState(""),[m,h]=p.useState(!1),[E,N]=p.useState(""),[D,V]=p.useState(600),[k,w]=p.useState(!1),[$,Y]=p.useState(!1),A=oe.useRef(null),W=oe.useRef(null),X=oe.useRef([]),Z=g??r?.total??0,M=p.useCallback(()=>`ORDER-${Date.now()}-${Math.random().toString(36).substr(2,9).toUpperCase()}`,[]),S=async x=>{try{await navigator.clipboard.writeText(x),w(!0),setTimeout(()=>w(!1),2e3)}catch(j){console.error("Failed to copy to clipboard:",j)}};p.useEffect(()=>{if(i&&m&&D>0){const x=setInterval(()=>{V(j=>j<=1?(h(!1),d("El tiempo de pago ha expirado. El pago ha sido cancelado automáticamente."),i?.payment_id&&(console.log("⏰ Timer expired - automatically cancelling payment:",i.payment_id),te.cancelPayment(i.payment_id,"Timer expired - automatic cancellation").then(()=>{console.log("✅ Payment automatically cancelled due to timer expiration"),N("cancelled"),A.current?.cancel&&(A.current.cancel(),A.current=null)}).catch(U=>{console.error("❌ Error automatically cancelling expired payment:",U),N("cancelled")})),0):j-1)},1e3);W.current=x,X.current.push(()=>{x&&clearInterval(x)})}return()=>{W.current&&(clearInterval(W.current),W.current=null)}},[i,m,D]),p.useEffect(()=>()=>{console.log("🚨 QRPaymentForm: Component unmounting, executing critical cleanup"),_()},[]);const P=x=>{const j=Math.floor(x/60),U=x%60;return`${j.toString().padStart(2,"0")}:${U.toString().padStart(2,"0")}`},B=p.useCallback(x=>{console.log("Payment status changed:",x),N(x);const j=te.getStatusDisplay(x);switch(x){case"completed":h(!1),console.log("✅ Payment completed successfully, processing order creation"),(async()=>{try{if(i){console.log("🎯 Processing real QR payment completion using simulation endpoint");const z=await te.simulatePaymentSuccess(i.payment_id,i.amount,s?.email);z.success&&console.log("✅ Order created successfully from real QR payment:",z)}t&&t({...i,status:"completed",completed_at:new Date().toISOString()})}catch(z){console.error("Error processing completed payment:",z),t&&t({...i,status:"completed",completed_at:new Date().toISOString()})}})();break;case"failed":case"cancelled":h(!1);const I=`Pago ${j.label.toLowerCase()}`;d(I),o&&o(I);break}},[i,t,o]),G=async()=>{if(!s||!r?.items?.length){d("Información de usuario o carrito no disponible");return}c(!0),d("");try{const x=M();console.log("🔍 CART ITEMS BEFORE TRANSFORMATION:",r.items.map((I,z)=>({index:z,productId:I.productId,product_name:I.product?.name,quantity:I.quantity,final_price:I.final_price,price:I.price,subtotal:I.subtotal,all_keys:Object.keys(I)})));const j={order_id:x,amount:Z,currency:"USD",customer:{name:s.name||"Cliente",email:s.email,phone:s.phone||void 0},items:r.items.map((I,z)=>{const u=I.productId||I.product?.id||I.product?.product_id;if(!u)throw console.error(`❌ CRITICAL: Missing product_id for cart item ${z}:`,{item_keys:Object.keys(I),item_productId:I.productId,product_id_alternatives:{"item.product?.id":I.product?.id,"item.product?.product_id":I.product?.product_id,"item.id":I.id},full_item:I}),new Error(`Cart item ${z} is missing product_id. Cannot proceed with payment.`);const l={name:I.product?.name||"Producto",quantity:I.quantity,price:I.final_price||I.price||I.subtotal||0,description:I.product?.description||"",product_id:u};return console.log(`✅ ITEM ${z} TRANSFORMATION SUCCESS:`,{original_productId:I.productId,mapped_product_id:l.product_id,product_id_source:I.productId?"item.productId":I.product?.id?"item.product.id":"other",mapped_item_keys:Object.keys(l),mapped_item:l}),l}),qr_type:"dynamic",format:"2",metadata:{source:"bcommerce_frontend",user_id:s.id,cart_id:r.id,checkout_timestamp:new Date().toISOString()}};console.log("🚀 FINAL PAYMENT REQUEST TO SEND:",{order_id:j.order_id,amount:j.amount,items_count:j.items?.length||0,items:j.items,first_item_keys:j.items&&j.items.length>0?Object.keys(j.items[0]):"no_items"}),console.log("Creating DeUna payment:",j);const U=await te.createPayment(j);if(console.log("DeUna API Response:",U),console.log("Response structure:",Object.keys(U)),U.success){console.log("Payment data from response:",U.data),console.log("QR code in response:",U.data?.qr_code_base64),v(U.data),N(U.data.status),V(600),h(!0);const I=te.pollPaymentStatus(U.data.payment_id,{maxAttempts:120,interval:5e3,onStatusChange:B});A.current=I,I.promise.catch(z=>{z.message==="Payment polling was cancelled"?console.log("DeunaService: Polling cancelled successfully"):(console.error("Polling error:",z),m&&d("Error monitoreando el estado del pago"))})}else throw new Error(U.message||"Error creating payment")}catch(x){console.error("Error generating QR payment:",x),d(x.message||"Error al generar el código QR"),o&&o(x.message)}finally{c(!1)}},_=()=>{A.current?.cancel&&(A.current.cancel(),A.current=null),W.current&&(clearInterval(W.current),W.current=null),X.current.forEach(x=>{try{x()}catch(j){console.error("Error during cleanup:",j)}}),X.current=[],v(null),d(""),N(""),h(!1),V(600),w(!1),console.log("🧹 QRPaymentForm: Complete cleanup executed")},b=async()=>{if(!i?.payment_id||E==="completed"){_();return}if(!m){_();return}try{console.log("Cancelling payment:",i.payment_id),A.current?.cancel&&(A.current.cancel(),A.current=null),h(!1),await te.cancelPayment(i.payment_id,"Cancelled by user"),N("cancelled"),d("Pago cancelado por el usuario"),console.log("Payment successfully cancelled by user")}catch(x){console.error("Error cancelling payment:",x),d("Error al cancelar el pago: "+x.message),h(!1)}},q=async()=>{try{if(c(!0),d(""),i?.payment_id&&m&&!["completed","cancelled","failed"].includes(E))try{console.log("Cancelling current payment before generating new QR:",i.payment_id),A.current?.cancel&&(A.current.cancel(),A.current=null),h(!1),await te.cancelPayment(i.payment_id,"Cancelled to generate new QR"),console.log("Current payment cancelled successfully")}catch(x){console.error("Error cancelling current payment:",x)}await G()}catch(x){console.error("Error generating new QR:",x),d("Error al generar nuevo código QR: "+x.message)}finally{c(!1)}},Q=async()=>{if(!i?.payment_id){d("No hay un pago activo para simular");return}Y(!0),d("");try{console.log("🧪 Simulating payment success for testing purposes");const x=await te.simulatePaymentSuccess(i.payment_id,i.amount,s?.email);if(x.success)console.log("✅ Payment simulation successful:",x),N("completed"),h(!1),A.current?.cancel&&(A.current.cancel(),A.current=null),t&&t({...i,status:"completed",completed_at:new Date().toISOString(),simulated:!0});else throw new Error(x.message||"Simulation failed")}catch(x){console.error("❌ Error simulating payment:",x),d("Error simulando el pago: "+x.message)}finally{Y(!1)}},K=()=>{if(!E)return null;const x=te.getStatusDisplay(E);return e.jsxs("div",{className:`flex items-center justify-center p-3 rounded-lg mb-4 ${x.color==="green"?"bg-green-50 text-green-700":x.color==="red"?"bg-red-50 text-red-700":x.color==="yellow"?"bg-yellow-50 text-yellow-700":"bg-blue-50 text-blue-700"}`,children:[e.jsx("span",{className:"mr-2",children:x.icon}),e.jsx("span",{className:"font-medium",children:x.label}),m&&x.color==="yellow"&&e.jsx(ie,{className:"w-4 h-4 ml-2 animate-spin"})]})};return i?e.jsxs("div",{className:"space-y-6",children:[e.jsx(K,{}),m&&e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"inline-flex items-center bg-blue-50 text-blue-700 px-4 py-2 rounded-lg",children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"font-mono text-lg",children:P(D)})]}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Tiempo restante para completar el pago"})]}),i.qr_code_base64&&!["cancelled","failed"].includes(E)?e.jsx("div",{className:"mb-4 mx-auto",children:e.jsxs("div",{className:"bg-[#2fd8a8] p-6 rounded-lg text-white",children:[e.jsx("div",{className:"w-24 h-24 mx-auto mb-4 bg-white rounded-full flex items-center justify-center",children:e.jsx("img",{src:"https://deuna.app/assets/img/brand/logo-deuna.svg",alt:"DeUna Logo",className:"w-20 h-20"})}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Pago con Deuna"}),e.jsxs("p",{className:"text-purple-100 mb-4",children:["Monto a pagar: ",H(Z)]}),e.jsx("div",{className:"bg-white rounded-lg p-4 mb-4",children:e.jsx("img",{src:i.qr_code_base64,alt:"Código QR para pago",className:"w-full h-auto max-w-64 mx-auto"})}),e.jsxs("p",{className:"text-purple-100 text-sm mb-4 flex items-center justify-center",children:[e.jsx(ke,{className:"w-4 h-4 mr-2"}),"Escanea con tu app Deuna"]}),e.jsx("button",{onClick:b,className:"bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-4 rounded-md transition-colors",disabled:!m||E==="completed",children:m?"Cancelar Pago":"Cerrar"})]})}):["cancelled","failed"].includes(E)&&e.jsx("div",{className:"mb-4 mx-auto",children:e.jsxs("div",{className:"bg-gray-100 border-2 border-gray-300 p-6 rounded-lg text-center",children:[e.jsx("div",{className:"w-24 h-24 mx-auto mb-4 bg-gray-300 rounded-full flex items-center justify-center",children:e.jsx(ge,{className:"w-12 h-12 text-gray-500"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-700 mb-2",children:E==="cancelled"?"Pago Cancelado":"Pago Fallido"}),e.jsx("p",{className:"text-gray-600 mb-4",children:E==="cancelled"?"El pago fue cancelado. Puedes generar un nuevo código QR.":"El pago falló. Puedes intentar generar un nuevo código QR."})]})}),i.payment_url&&!["cancelled","failed"].includes(E)&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("input",{type:"text",value:i.payment_url,readOnly:!0,className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"}),e.jsxs("button",{onClick:()=>S(i.payment_url),className:"px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx($e,{className:"w-4 h-4 mr-1"}),k?"Copiado!":"Copiar"]})]}),e.jsxs("a",{href:i.payment_url,target:"_blank",rel:"noopener noreferrer",className:"w-full bg-[#3f2b57] hover:bg-[#3f2b45] text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx(Le,{className:"w-4 h-4 mr-2"}),"Abrir enlace de pago"]})]}),i.numeric_code&&!["cancelled","failed"].includes(E)&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"Código numérico:"}),e.jsx("p",{className:"text-2xl font-mono font-bold text-gray-900 tracking-wider",children:i.numeric_code})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-lg font-semibold text-gray-900",children:["Monto a pagar: ",H(Z)]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["ID de Pago: ",i.payment_id]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("button",{onClick:q,disabled:a,className:"flex-1 bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:a?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-4 h-4 mr-2 animate-spin"}),"Generando..."]}):"Generar Nuevo QR"}),te.isDevelopmentMode()&&m&&!["completed","cancelled","failed"].includes(E)&&e.jsx("button",{onClick:Q,disabled:$,className:"flex-1 bg-orange-500 hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:$?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-4 h-4 mr-2 animate-spin"}),"Simulando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Ue,{className:"w-4 h-4 mr-2"}),"🧪 Simular Pago"]})}),E==="completed"&&e.jsxs("button",{onClick:()=>t&&t(i),className:"flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx(we,{className:"w-4 h-4 mr-2"}),"Continuar"]})]}),f&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ge,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("p",{className:"text-red-700",children:f})]})}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Instrucciones:"}),e.jsxs("ol",{className:"text-sm text-blue-800 space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"1."})," Escanea el código QR con tu app de pagos"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"2."})," O usa el enlace de pago en tu dispositivo móvil"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"3."})," Completa el pago en la aplicación"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"4."})," Espera la confirmación automática"]})]}),te.isDevelopmentMode()&&m&&e.jsx("div",{className:"mt-3 pt-3 border-t border-blue-300",children:e.jsxs("p",{className:"text-xs text-orange-700 bg-orange-50 p-2 rounded",children:["🧪 ",e.jsx("strong",{children:"Modo de desarrollo:"}),' Puedes usar el botón "Simular Pago" para testear el flujo completo sin necesidad de realizar un pago real.']})})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"mb-4 text-center text-gray-600",children:"Paga con DeUna!, Genera el código qr y escanealo desde tu app para pagar de forma rápida y segura."}),e.jsx("div",{className:"bg-[#2fd8a8] border-purple-200 rounded-lg p-6",children:e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx("img",{src:"https://deuna.app/assets/img/brand/logo-deuna.svg",alt:"DeUna Logo",className:"w-50 h-50"})})}),e.jsx("button",{type:"button",onClick:G,disabled:a||!s||!r?.items?.length,className:"w-full bg-[#3f2b57] hover:bg-[#342843] disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-101 disabled:transform-none flex items-center justify-center",children:a?e.jsxs(e.Fragment,{children:[e.jsx(ie,{className:"w-5 h-5 mr-2 animate-spin"}),"Generando código QR..."]}):`Pagar con DeUna! - ${H(Z)}`}),f&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(ge,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("p",{className:"text-red-700",children:f})]})}),e.jsxs("div",{className:"mt-4 text-sm text-center text-gray-500",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"1."}),' Haz clic en "Pagar con DeUna!"']}),e.jsxs("p",{children:[e.jsx("strong",{children:"2."})," Completa el pago con el QR"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"3."})," Confirma tu compra al finalizar."]})]})]})},Se=({title:g,address:t,onAddressChange:o,errors:r})=>{const s=g.replace(/\s+/g,"-").toLowerCase();return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:g}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`name-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre Completo *"}),e.jsx("input",{type:"text",id:`name-${s}`,value:t.name||"",onChange:a=>o("name",a.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${r.name?"border-red-500":"border-gray-300"}`,placeholder:"Nombre y Apellido"}),r.name&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.name})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`street-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Dirección / Calle Principal *"}),e.jsx("input",{type:"text",id:`street-${s}`,value:t.street||"",onChange:a=>o("street",a.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${r.street?"border-red-500":"border-gray-300"}`,placeholder:"Calle, número, piso, etc."}),r.street&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.street})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`city-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Ciudad *"}),e.jsx("input",{type:"text",id:`city-${s}`,value:t.city||"",onChange:a=>o("city",a.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${r.city?"border-red-500":"border-gray-300"}`,placeholder:"Ciudad"}),r.city&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.city})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`state-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Provincia/Estado *"}),e.jsx("input",{type:"text",id:`state-${s}`,value:t.state||"",onChange:a=>o("state",a.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${r.state?"border-red-500":"border-gray-300"}`,placeholder:"Provincia o Estado"}),r.state&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.state})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`postalCode-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Código Postal *"}),e.jsx("input",{type:"text",id:`postalCode-${s}`,value:t.postalCode||"",onChange:a=>o("postalCode",a.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${r.postalCode?"border-red-500":"border-gray-300"}`,placeholder:"Código Postal"}),r.postalCode&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.postalCode})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`country-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"País *"}),e.jsx("input",{type:"text",id:`country-${s}`,value:t.country||"",onChange:a=>o("country",a.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${r.country?"border-red-500":"border-gray-300"}`,placeholder:"País"}),r.country&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.country})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`phone-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Teléfono *"}),e.jsx("input",{type:"tel",id:`phone-${s}`,value:t.phone||"",onChange:a=>o("phone",a.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${r.phone?"border-red-500":"border-gray-300"}`,placeholder:"Número de teléfono"}),r.phone&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:r.phone})]})]})]})},Ze=()=>{const g=ve(),{cart:t,clearCart:o,showNotification:r,appliedDiscount:s}=ye(),a=new he,[c,i]=p.useState(!1),v=async()=>{if(console.log("🧪 TestCheckoutButton.handleTestCheckout INICIADO"),!t||t.items.length===0){console.log("❌ Carrito vacío, abortando checkout"),r(L.ERROR,"El carrito está vacío");return}console.log("🛒 ANÁLISIS COMPLETO DEL CARRITO ANTES DEL CHECKOUT:"),console.log("📊 Cart completo:",JSON.stringify(t,null,2)),console.log("📊 Total de items en carrito:",t.items.length),console.log("📊 Total del carrito:",t.total),console.log("🔍 ANÁLISIS ITEM POR ITEM:"),t.items.forEach((d,m)=>{console.log(`📋 Item ${m+1}:`,{id:d.id,productId:d.productId,quantity:d.quantity,price:d.price,product:d.product?{id:d.product.id,name:d.product.name,price:d.product.price,sellerId:d.product.sellerId,seller_id:d.product.seller_id,user_id:d.product.user_id}:null,completeItem:d})}),console.log("🔍 VERIFICANDO DUPLICADOS EN EL CARRITO:");const f=t.items.reduce((d,m,h)=>(d[m.productId]||(d[m.productId]=[]),d[m.productId].push({index:h,item:m}),d),{});console.log("📊 Items agrupados por productId:",f),Object.keys(f).forEach(d=>{const m=f[d];m.length>1?(console.warn(`⚠️ DUPLICADO EN CARRITO DETECTADO para productId ${d}:`),console.warn(`❌ Se encontraron ${m.length} items para el mismo producto`),m.forEach((h,E)=>{console.warn(`   ${E+1}. Item[${h.index}]:`,h.item)})):console.log(`✅ Producto ${d}: Sin duplicados (${m[0].item.quantity} unidades)`)}),i(!0);try{const d=he.getSellerIdFromCart(t);console.log("🏪 Seller ID obtenido para test:",d);const m=t.items.map(N=>{let D=0;return N.product?.final_price&&N.product.final_price>0?D=N.product.final_price:N.product?.price&&N.product.price>0?D=N.product.price:N.price&&N.price>0?D=N.price:N.subtotal&&N.quantity>0?D=N.subtotal/N.quantity:(console.warn(`⚠️ No se pudo determinar precio para producto ${N.productId}, usando 1.00`),D=1),{product_id:N.productId,quantity:N.quantity,price:D}});console.log("🛒 Items formateados para backend:",JSON.stringify(m,null,2));const h={payment:{method:"credit_card",card_number:"4111111111111111",card_expiry:"12/25",card_cvc:"123"},shippingAddress:{name:"Test User",street:"Calle de Prueba 123",city:"Ciudad de Prueba",state:"Estado de Prueba",postalCode:"12345",country:"País de Prueba",phone:"123456789"},seller_id:d||void 0,items:m,discount_code:s?.discountCode?.code||null,discount_info:s||null};console.log("📦 Datos completos de checkout de prueba:",JSON.stringify(h,null,2)),console.log("🚀 Enviando checkout al backend...");const E=await a.processCheckout(h);if(console.log("✅ Respuesta del checkout recibida:",E),E.status==="success"){if(console.log("🎉 Checkout exitoso, limpiando carrito..."),o(),r(L.SUCCESS,"¡Pedido de prueba completado con éxito!"),console.log("📊 Detalles COMPLETOS de la orden:",JSON.stringify(E.data,null,2)),E.data&&typeof E.data=="object"){const N=E.data;console.log("🔍 ANÁLISIS DE LA ORDEN CREADA:"),console.log("📊 Order ID:",N.order_id),console.log("📊 Order Number:",N.order_number),console.log("📊 Total:",N.total),N.items&&(console.log("📊 Items en la orden creada:",N.items.length),N.items.forEach((D,V)=>{console.log(`📋 Order Item ${V+1}:`,{id:D.id,product_id:D.product_id,product_name:D.product_name,quantity:D.quantity,price:D.price})}))}g("/orders")}else throw new Error(E.message||"Error en el checkout de prueba")}catch(d){console.error("❌ Error COMPLETO en el checkout de prueba:"),console.error("📊 Error object:",d),console.error("📊 Error stack:",d?.stack);const m=ne(d,"Error en el checkout de prueba. Por favor, intenta de nuevo más tarde.");console.error("📊 Error message final:",m),r(L.ERROR,m)}finally{i(!1),console.log("🧪 TestCheckoutButton.handleTestCheckout FINALIZADO")}};return e.jsxs("button",{onClick:v,disabled:c,className:"px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 transition-colors flex items-center disabled:opacity-50",children:[c?e.jsx("span",{className:"inline-block h-4 w-4 border-2 border-white border-t-transparent rounded-full animate-spin mr-2"}):null,"Prueba rápida de checkout"]})};class et{async createCheckout(t){try{console.log("DatafastService: Creando checkout",t);const o=await J.post(ee.DATAFAST.CREATE_CHECKOUT,t);return console.log("DatafastService: Respuesta de checkout",o),o}catch(o){console.error("DatafastService: Error al crear checkout:",o);const r=ne(o,"Error al crear el checkout de Datafast");throw new Error(r)}}async verifyPayment(t){try{console.log("DatafastService: Verificando pago",t);const o=await J.post(ee.DATAFAST.VERIFY_PAYMENT,t);return console.log("DatafastService: Respuesta de verificación",o),o}catch(o){console.error("DatafastService: Error al verificar pago:",o);const r=ne(o,"Error al verificar el pago de Datafast");throw new Error(r)}}async simulateSuccessfulPayment(t,o,r){if(!t)throw new Error("checkout_id es requerido para simular el pago");if(!o)throw new Error("transaction_id es requerido para simular el pago");const s=`/v1/checkouts/${t}/payment`;console.log("DatafastService: Simulando pago exitoso",{checkoutId:t,transactionId:o,mockResourcePath:s});try{const a={resource_path:s,transaction_id:o,calculated_total:r};console.log("🔄 Enviando datos de simulación:",a);const c=await J.post(ee.DATAFAST.VERIFY_PAYMENT+"?simulate_success=true",a);return console.log("DatafastService: Respuesta de simulación:",c),c}catch(a){console.error("DatafastService: Error en simulación:",a);const c=ne(a,"Error al simular el pago de Datafast");throw new Error(c)}}async handleDatafastResult(t,o,r){try{console.log("DatafastService: Manejando resultado real de Datafast",{resourcePath:t,transactionId:o,calculatedTotal:r});const s=await this.verifyPayment({resource_path:t,transaction_id:o,calculated_total:r});return s.status!=="success"&&s.result_code==="800.900.300"?{success:!1,message:'No se completó un pago real. Este es el comportamiento esperado en Fase 1 de pruebas. Use "Simular Pago Exitoso" para probar el flujo completo.',result_code:s.result_code,is_phase_1_error:!0}:s}catch(s){console.error("DatafastService: Error al manejar resultado:",s);const a=ne(s,"Error al procesar el resultado de Datafast");throw new Error(a)}}extractResourcePath(t){try{const r=new URLSearchParams(t.split("?")[1]).get("resourcePath");return console.log("DatafastService: ResourcePath extraído:",r),r}catch(o){return console.error("DatafastService: Error al extraer resourcePath:",o),null}}}const tt=()=>{p.useEffect(()=>{console.log("🔓 Hook useDatafastCSP activado - Desactivando CSP para Datafast");const g=()=>{const s=document.querySelectorAll('meta[http-equiv="Content-Security-Policy"]');s.length>0&&(s.forEach(c=>c.remove()),console.log(`🗑️ Removidos ${s.length} meta tags de CSP`)),document.querySelectorAll("meta").forEach(c=>{const i=c.getAttribute("http-equiv")?.toLowerCase();i&&i.includes("content-security")&&(c.remove(),console.log("🗑️ Removido meta tag con CSP alternativo"))})};g();const t=new MutationObserver(s=>{s.forEach(a=>{a.type==="childList"&&a.addedNodes.forEach(c=>{if(c.nodeType===1){const i=c;if(i.tagName==="META"){const v=i.getAttribute("http-equiv")?.toLowerCase();v&&v.includes("content-security")&&(console.log("🚨 CSP detectado por MutationObserver - removiendo inmediatamente"),i.remove())}}})})});t.observe(document.head,{childList:!0,subtree:!0});const o=setInterval(()=>{g()},100),r=setInterval(()=>{document.querySelector('meta[http-equiv="Content-Security-Policy"]')&&(console.log("⚠️ CSP detectado en verificación regular - removiendo"),g())},1e3);return()=>{console.log("🔄 Limpiando hook useDatafastCSP"),t.disconnect(),clearInterval(o),clearInterval(r)}},[])},ot=({onSuccess:g,onError:t})=>{tt(),ve();const{cart:o,clearCart:r,showNotification:s,appliedDiscount:a}=ye();Ee();const[c,i]=p.useState(!1),[v,f]=p.useState(!1),[d,m]=p.useState(null),[h,E]=p.useState(!1),[N,D]=p.useState(!1),[V,k]=p.useState(null),[w,$]=p.useState({address:"Av. Test 123",city:"Quito",country:"EC",given_name:"Juan",middle_name:"Carlos",surname:"Pérez",phone:"0999999999",doc_id:"1234567890"}),Y=new et;p.useEffect(()=>()=>{const S=document.getElementById("datafast-widget-script");S&&S.remove()},[]);const A=(S,P)=>{$(B=>({...B,[S]:P}))},W=()=>{const S=["address","city","country","given_name","surname","phone","doc_id"];for(const P of S)if(!w[P]||w[P].trim()==="")return s(L.ERROR,`El campo ${P.replace("_"," ")} es obligatorio`),!1;return w.doc_id.length!==10||!/^\d+$/.test(w.doc_id)?(s(L.ERROR,"La cédula debe tener exactamente 10 dígitos"),!1):!0},X=async()=>{if(!o||o.items.length===0){s(L.ERROR,"El carrito está vacío");return}if(W()){i(!0);try{const S=await re.prepareItemsForCheckout(o.items),P=await re.calculateCheckoutTotals(o.items,a);k(P),console.log("💰 Totales calculados para Datafast:",P),console.log("🛒 Items para Datafast (preparados como Prueba Completa):",S);const B={shipping:{address:w.address,city:w.city,country:w.country.toUpperCase()},customer:{given_name:w.given_name,middle_name:w.middle_name,surname:w.surname,phone:w.phone,doc_id:w.doc_id},items:S,total:P.total,subtotal:P.subtotal,shipping_cost:P.shipping,tax:P.tax,discount_code:a?.discountCode.code||null,discount_info:a||null};console.log("Iniciando checkout con Datafast...",B),console.log("💰 Total enviado a Datafast: $",P.total);const G=await Y.createCheckout(B);if(console.log("Respuesta del checkout:",G),G.status==="success"&&G.data)m(G.data),E(!1),f(!0),localStorage.setItem("datafast_transaction_id",G.data.transaction_id),localStorage.setItem("datafast_checkout_id",G.data.checkout_id),localStorage.setItem("datafast_calculated_total",P.total.toString()),localStorage.setItem("datafast_form_data",JSON.stringify(w)),console.log("💾 GUARDANDO BACKUP DEL CARRITO EN LOCALSTORAGE"),console.log("   - Items en carrito:",o?.items?.length||0),console.log("   - Carrito completo:",o),localStorage.setItem("datafast_cart_backup",JSON.stringify(o)),console.log("   ✅ Backup guardado en 'datafast_cart_backup'"),s(L.SUCCESS,"Checkout creado. Preparando formulario de pago..."),setTimeout(()=>{G.data?Z(G.data.checkout_id):s(L.ERROR,"Datos de checkout no disponibles")},100);else throw new Error(G.message||"Error al crear checkout")}catch(S){console.error("Error al iniciar pago con Datafast:",S);const P=S instanceof Error?S.message:"Error desconocido";s(L.ERROR,P),t?.(P)}finally{i(!1)}}},Z=S=>{try{console.log("Cargando widget de Datafast...",S);const P=document.getElementById("datafast-widget-script");P&&P.remove(),window.wpwlOptions={onReady:function(){console.log("✅ Widget de Datafast listo!"),D(!0),s(L.SUCCESS,"Formulario de pago cargado correctamente."),setTimeout(()=>{const b=document.querySelector("form.paymentWidgets");b&&(console.log("📝 Agregando listener adicional al formulario"),b.addEventListener("submit",function(K){console.log("🚀 FORMULARIO ENVIADO - Evento capturado!"),console.log("   - Action actual:",b.getAttribute("action")),console.log("   - Method:",b.getAttribute("method")),console.log("   - Target:",b.getAttribute("target"))}),new MutationObserver(K=>{K.forEach(x=>{x.type==="attributes"&&x.attributeName==="action"&&console.log("🔄 Action del formulario cambió a:",b.getAttribute("action"))})}).observe(b,{attributes:!0,attributeFilter:["action","method"]}),new MutationObserver(K=>{K.forEach(x=>{x.addedNodes.forEach(j=>{j.tagName==="IFRAME"&&(console.log("🖼️ Nuevo iframe detectado:",{name:j.name,src:j.src,id:j.id}),j.addEventListener("load",()=>{console.log("✅ Iframe cargado:",j.name);try{(j.contentDocument||j.contentWindow?.document)&&console.log("📄 Contenido del iframe accesible")}catch{console.log("🔒 Iframe cross-origin, no se puede acceder al contenido")}}))})})}).observe(document.body,{childList:!0,subtree:!0}))},500)},onBeforeSubmitCard:function(b){console.log("🔄 Widget Datafast: Usuario hizo clic en Pagar, procesando..."),console.log("🔍 Datos de la tarjeta que se están enviando:",b);const q=document.querySelector("form.paymentWidgets");if(q){console.log("📝 Estado del formulario al hacer submit:"),console.log("   - Action:",q.action),console.log("   - Method:",q.method),console.log("   - Target:",q.target);const Q=q.querySelector('input[name="checkoutId"]');Q&&console.log("   - CheckoutId field:",Q.getAttribute("value"));const K=document.querySelector(`iframe[name="${q.target}"]`);K?console.log("   - Target iframe encontrado:",K):console.log("   - ⚠️ No se encontró iframe target")}return s(L.INFO,"Procesando pago con Datafast..."),!0},onAfterSubmitCard:async function(b){if(console.log("⏳ Widget Datafast: Datos enviados, esperando respuesta..."),console.log("📤 Respuesta completa después del envío:",b),console.log("🔍 DEBUG: Analizando estructura de la respuesta:"),console.log("   - Tipo de data:",typeof b),console.log("   - Es un array?:",Array.isArray(b)),console.log("   - Keys del objeto:",b?Object.keys(b):"data es null/undefined"),b&&b.originalEvent&&console.log("📋 Evento original detectado:",b.originalEvent),b&&b.target){console.log("🎯 Target del evento:",b.target);const x=b.target;x&&x.tagName==="FORM"&&(console.log("📝 Formulario encontrado en evento:"),console.log("   - Action:",x.action),console.log("   - Method:",x.method))}try{console.log("   - JSON stringified:",JSON.stringify(b,null,2))}catch{console.log("   - No se puede convertir a JSON (referencia circular)")}b&&b.redirect&&console.log("🔗 Información de redirect encontrada:",b.redirect),b&&b.resourcePath&&(console.log("📍 ResourcePath encontrado:",b.resourcePath),console.log("🔄 Intentando redirección manual a:",`/datafast-result?resourcePath=${encodeURIComponent(b.resourcePath)}`),setTimeout(()=>{console.log("⏰ Esperando 3 segundos para ver si hay redirección automática...")},3e3));let q=0;const Q=10,K=setInterval(async()=>{q++,console.log(`🔄 Verificación ${q}/${Q} del estado del pago...`);const x=document.querySelector('iframe[name*="oppwa"], iframe[src*="oppwa"], iframe[src*="datafast"]');x&&console.log("🖼️ iFrame de pago detectado:",{name:x.getAttribute("name"),src:x.getAttribute("src"),visible:x.style.display!=="none"});const j=document.querySelector("form.paymentWidgets");if(j){const U=j.getAttribute("action");if(U&&U.includes("resourcePath")){console.log("📝 Formulario actualizado con resourcePath:",U),clearInterval(K);const z=new URLSearchParams(U.split("?")[1]).get("resourcePath");z&&(console.log("🎯 ResourcePath extraído:",z),localStorage.setItem("datafast_resource_path",z),setTimeout(()=>{console.log("🚀 Redirigiendo manualmente al resultado..."),window.location.href=U},2e3))}}if(q>=3){const U=localStorage.getItem("datafast_checkout_id"),I=localStorage.getItem("datafast_transaction_id");if(U&&I)try{const u=await(await fetch(`/api/datafast/verify-payment/${I}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`}})).json();console.log(`📊 Estado del pago (intento ${q}):`,u.data?.payment_status),u.status==="success"&&u.data?.payment_status==="completed"&&(console.log("🎉 Pago completado exitosamente!"),clearInterval(K),window.location.href=`/datafast-result?status=success&transactionId=${I}`)}catch(z){console.error(`❌ Error verificando estado (intento ${q}):`,z)}}q>=Q&&(console.log("⏰ Se alcanzó el límite de verificaciones"),clearInterval(K))},3e3)},onLoadThreeDSecure:function(){console.log("🔐 Widget Datafast: Cargando 3D Secure...")},onBeforeRedirectToResult:function(b){return console.log("🔄 Widget Datafast: Redirigiendo a página de resultado..."),console.log("🔗 Datos completos de redirección:",b),console.log("🔍 DEBUG Redirect - Keys:",b?Object.keys(b):"null"),console.log("🔍 DEBUG Redirect - JSON:",JSON.stringify(b,null,2)),b&&b.resourcePath&&(localStorage.setItem("datafast_resource_path",b.resourcePath),console.log("💾 ResourcePath guardado en localStorage:",b.resourcePath)),!0},onChangeBrand:function(b){console.log("💳 Widget Datafast: Marca de tarjeta detectada:",b.brand),console.log("💳 Datos completos del evento:",b)},onError:function(b){console.error("❌ Widget Datafast: Error en el pago",b),console.error("❌ Detalles completos del error:",{message:b.message,code:b.code,name:b.name,full:b}),s(L.ERROR,"Error al procesar el pago: "+(b.message||b.code||"Error desconocido"))},onSubmit:function(b){console.log("📋 Widget Datafast: Formulario enviado"),console.log("📋 Datos completos del formulario:",b),console.log("📋 DEBUG Submit - Keys:",b?Object.keys(b):"null"),console.log("📋 DEBUG Submit - JSON:",JSON.stringify(b,null,2));const q=document.querySelector("form.paymentWidgets");if(q){console.log("📝 Formulario encontrado:"),console.log("   - Action:",q.getAttribute("action")),console.log("   - Method:",q.getAttribute("method")),console.log("   - Target:",q.getAttribute("target"));const Q=document.querySelector('iframe[name*="oppwa"]');Q&&console.log("🖼️ iFrame de pago encontrado:",Q)}return!0},style:"card",locale:"es",labels:{cvv:"CVV",cardHolder:"Nombre (igual que en la tarjeta)"}};const B=void 0,G=document.createElement("script");G.id="datafast-widget-script";const _="https://eu-test.oppwa.com/v1/paymentWidgets.js";G.src=d?.widget_url||`${_}?checkoutId=${S}`,G.async=!0,G.onload=()=>{console.log("Script de widget cargado")},G.onerror=()=>{console.error("Error al cargar script del widget"),s(L.ERROR,"Error al cargar el formulario de pago")},document.head.appendChild(G)}catch(P){console.error("Error al configurar widget:",P),s(L.ERROR,"Error al configurar el formulario de pago")}},M=!1;return v?e.jsx("div",{className:"datafast-payment-widget",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Pagar con Datafast"}),e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-blue-800",children:"Información del pedido:"}),e.jsxs("p",{className:"text-blue-700",children:["Monto: $",V?.total?.toFixed(2)||d?.amount||o?.total]}),e.jsxs("p",{className:"text-blue-700",children:["ID: ",d?.transaction_id]})]}),e.jsx("div",{className:"min-h-[400px] border border-gray-200 rounded-lg p-4",children:e.jsx("form",{action:window.location.origin+"/datafast-result",className:"paymentWidgets","data-brands":"VISA MASTER AMEX DINERS DISCOVER",children:!N&&e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"Cargando formulario de pago..."})]})})})}),e.jsxs("div",{className:"mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-yellow-800 mb-2",children:"Datos de prueba para usar:"}),e.jsxs("div",{className:"text-sm text-yellow-700 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Tarjeta VISA:"})," 4200 0000 0000 0000"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fecha:"})," 07/26"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"CVV:"})," 246"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Titular:"})," ",w.given_name," ",w.surname]}),e.jsxs("p",{className:"text-xs mt-2 text-blue-600",children:[e.jsx("strong",{children:"Fase 2:"})," Credenciales de testing avanzado con transacciones reales limitadas"]})]})]}),M,e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:()=>{f(!1),E(!0),D(!1);const S=document.getElementById("datafast-widget-script");S&&S.remove()},disabled:c,className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors",children:"Volver"})})]})}):h?e.jsx("div",{className:"datafast-form",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Información para Datafast"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre *"}),e.jsx("input",{type:"text",value:w.given_name,onChange:S=>A("given_name",S.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Segundo Nombre"}),e.jsx("input",{type:"text",value:w.middle_name,onChange:S=>A("middle_name",S.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Apellido *"}),e.jsx("input",{type:"text",value:w.surname,onChange:S=>A("surname",S.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Teléfono *"}),e.jsx("input",{type:"text",value:w.phone,onChange:S=>A("phone",S.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",placeholder:"0999999999"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Cédula/ID * (10 dígitos)"}),e.jsx("input",{type:"text",value:w.doc_id,onChange:S=>{const P=S.target.value.replace(/\D/g,"").slice(0,10);A("doc_id",P)},className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",placeholder:"1234567890",maxLength:10})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Dirección *"}),e.jsx("input",{type:"text",value:w.address,onChange:S=>A("address",S.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ciudad *"}),e.jsx("input",{type:"text",value:w.city,onChange:S=>A("city",S.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"País *"}),e.jsxs("select",{value:w.country,onChange:S=>A("country",S.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",children:[e.jsx("option",{value:"EC",children:"Ecuador"}),e.jsx("option",{value:"CO",children:"Colombia"}),e.jsx("option",{value:"PE",children:"Perú"}),e.jsx("option",{value:"US",children:"Estados Unidos"})]})]})]}),e.jsxs("div",{className:"mt-6 flex gap-4",children:[e.jsx("button",{onClick:X,disabled:c,className:"flex-1 bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-md transition-colors disabled:opacity-50 flex items-center justify-center",children:c?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Creando checkout..."]}):"Continuar con Datafast"}),e.jsx("button",{onClick:()=>E(!1),disabled:c,className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors",children:"Cancelar"})]})]})}):e.jsxs("div",{className:"datafast-payment-button",children:[e.jsxs("button",{onClick:()=>E(!0),disabled:c||!o||o.items.length===0,className:"w-full transition-all duration-200 transform hover:scale-101 bg-[#003c58] border-1 hover:bg-[#00B86E] text-white font-medium py-3 px-4 rounded-md disabled:opacity-50 flex items-center justify-center",children:[e.jsx("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"})}),"Pagar con Datafast"]}),(!o||o.items.length===0)&&e.jsx("p",{className:"mt-2 text-sm text-gray-500 text-center",children:"Agrega productos al carrito para continuar"})]})},st=()=>{const g=ve(),{cart:t,clearCart:o,showNotification:r,appliedDiscount:s}=ye(),{user:a}=Ee(),[c,i]=p.useState(!1),v={name:"",street:"",city:"",state:"",postalCode:"",country:"Ecuador",phone:""},{handleSuccess:f,handleError:d}=ze({showNotification:r,context:"CheckoutPage"}),[m,h]=p.useState("credit_card"),[E,N]=p.useState(v),[D,V]=p.useState(v),[k,w]=p.useState(!0),[$,Y]=p.useState({method:"credit_card",card_number:"",card_expiry:"",card_cvc:""}),[A,W]=p.useState({}),[X,Z]=p.useState(!1),[M,S]=p.useState(null),[P,B]=p.useState(8),G=new he,[_,b]=p.useState({items:[],totals:{subtotal:0,originalSubtotal:0,sellerDiscounts:0,volumeDiscounts:0,totalDiscounts:0,couponDiscount:0,tax:0,shipping:0,total:0,freeShipping:!1},stockIssues:[],checkoutItems:[]});p.useEffect(()=>{(async()=>{if(!t?.items?.length){b({items:[],totals:{subtotal:0,originalSubtotal:0,sellerDiscounts:0,volumeDiscounts:0,totalDiscounts:0,couponDiscount:0,tax:0,shipping:0,total:0,freeShipping:!1},stockIssues:[],checkoutItems:[]});return}console.log("🔄 CheckoutPage: Calculando descuentos con configuración dinámica");const y=await Promise.all(t.items.map(async F=>{const Ce=await Qe(F),_e=F.product?.stockAvailable||F.product?.stock||0,Ae=F.quantity>_e||!F.product?.is_in_stock;return{...F,discount:Ce,itemTotal:Ce.finalPricePerUnit*F.quantity,availableStock:_e,hasStockIssue:Ae}}));console.log("✅ CheckoutPage: Descuentos calculados para",y.length,"items");const T=y.filter(F=>F.hasStockIssue).map(F=>({productName:F.product?.name||"Producto",requested:F.quantity,available:F.availableStock,isOutOfStock:!F.product?.is_in_stock}));console.log("🔍 FLUJO CHECKOUT - Calculando totales"),console.log("📊 Items en checkout:",t.items.length),console.log("📊 Cupón en checkout:",s?.discountCode?.code||"NINGUNO");const O=await re.calculateCheckoutTotals(t.items,s,!0);console.log("🎯 TOTAL CHECKOUT:",O.total);const C=await re.prepareItemsForCheckout(t.items,s,!0);b({items:y,totals:O,stockIssues:T,checkoutItems:C})})()},[t?.items,t?.total,t?.subtotal,s]);const q=n=>typeof n.stockAvailable=="number"?n.stockAvailable:typeof n.stock=="number"?n.stock:0,Q=()=>{if(!t?.items)return{valid:!0,errors:[]};const n=[];return t.items.forEach(y=>{const T=q(y.product);y.product?.is_in_stock?y.quantity>T&&n.push(`${y.product?.name||"Producto"}: solo hay ${T} unidades disponibles (solicitaste ${y.quantity})`):n.push(`${y.product?.name||"Producto"} está agotado`)}),{valid:n.length===0,errors:n}};p.useEffect(()=>{if(a){const n={name:`${a.name}`,street:a.address||"",city:a.city||"",state:a.state||a.province||"",postalCode:a.postal_code||a.zip_code||"",country:a.country||"Ecuador",phone:a.phone||""};N(n),V(n)}},[a]);const K=n=>{console.log("Pago exitoso:",n)},x=n=>{console.error("Error:",n)};p.useEffect(()=>{if(X&&M){console.log("✅ Order complete - skipping cart validation to show receipt");return}if(!t||t.items.length===0){r(L.ERROR,"El carrito está vacío"),g("/cart");return}const n=Q();n.valid||(console.warn("⚠️ Problemas de stock detectados:",n.errors),n.errors.length>0&&r(L.WARNING,`Problema de stock: ${n.errors[0]}`))},[t,g,r,X,M]),p.useEffect(()=>{if(X){B(8);const n=setInterval(()=>{B(y=>y<=1?(clearInterval(n),setTimeout(()=>{console.log("🔄 Auto-redirecting to orders page after 8 seconds"),g("/orders")},0),0):y-1)},1e3);return()=>clearInterval(n)}},[X,g]);const j=n=>{h(n),Y({...$,method:n==="deuna"?"transfer":"credit_card"})},U=(n,y)=>{const T={...E,[n]:y};N(T),k&&V(T)},I=(n,y)=>{V({...D,[n]:y})},z=(n,y)=>{if(Y({...$,[n]:y}),y.trim()&&A[n]){const T={...A};delete T[n],W(T)}},u=()=>{const n={},y=(T,O)=>{["name","street","city","state","postalCode","country","phone"].forEach(F=>{T[F]||(n[`${O}${F}`]=`El campo ${F.replace("_"," ")} es obligatorio`)})};return y(E,"shipping"),k||y(D,"billing"),m==="credit_card"&&($.card_number?/^\d{16}$/.test($.card_number||"")||(n.card_number="El número de tarjeta debe tener 16 dígitos"):n.card_number="El número de tarjeta es obligatorio",$.card_expiry?/^\d{2}\/\d{2}$/.test($.card_expiry||"")||(n.card_expiry="El formato debe ser MM/YY"):n.card_expiry="La fecha de expiración es obligatoria",$.card_cvc?/^\d{3,4}$/.test($.card_cvc||"")||(n.card_cvc="El código debe tener 3 o 4 dígitos"):n.card_cvc="El código de seguridad es obligatorio"),W(n),Object.keys(n).length===0},l=async()=>{console.log("🛒 CheckoutPage.processCheckout INICIADO CON DESCUENTOS POR VOLUMEN");const n=Q();if(!n.valid){console.log("❌ Validación de stock falló:",n.errors),n.errors.forEach(y=>{r(L.ERROR,y)}),r(L.WARNING,"Por favor, ajusta las cantidades en tu carrito antes de continuar");return}if(!u()){console.log("❌ Validación de formulario falló"),r(L.ERROR,"Por favor, completa todos los campos obligatorios");return}console.log("🛒 ANÁLISIS COMPLETO DEL CARRITO CON DESCUENTOS POR VOLUMEN:"),console.log("📊 Totales calculados:",_.totals),console.log("📊 Items para checkout:",_.checkoutItems),i(!0);try{const y=he.getSellerIdFromCart(t),T={payment:{...$,method:m==="deuna"?"qr":m==="credit_card"?"credit_card":$.method},shippingAddress:E,billingAddress:k?E:D,seller_id:y||void 0,items:_.checkoutItems,discount_code:s?.discountCode?.code||null,discount_info:s||null,calculated_totals:{subtotal:_.totals.subtotal,tax:_.totals.tax,shipping:_.totals.shipping,total:_.totals.total,total_discounts:_.totals.totalDiscounts}};console.log("📦 Datos completos de checkout con descuentos por volumen:",JSON.stringify(T,null,2)),console.log("🚀 Enviando checkout al backend...");const O=await G.processCheckout(T,a?.email);if(console.log("✅ Respuesta del checkout recibida:",O),O.status==="success"){console.log("🎉 Checkout exitoso con descuentos por volumen, limpiando carrito..."),Z(!0),S(O.data);let C="¡Pedido completado con éxito!";if(_.totals.totalDiscounts>0&&(C+=` Has ahorrado ${H(_.totals.totalDiscounts)} con descuentos aplicados.`),f(C),o(),O.data&&typeof O.data=="object"){const F=O.data;console.log("🔍 ORDEN CREADA CON DESCUENTOS:"),console.log("📊 Order ID:",F.order_id),console.log("📊 Order Number:",F.order_number),console.log("📊 Total:",F.total),console.log("📊 Total Savings:",F.total_savings),console.log("📊 Volume Discounts Applied:",F.volume_discounts_applied)}}else throw new Error(O.message||"Error al procesar el pedido")}catch(y){console.error("❌ Error COMPLETO al procesar checkout con descuentos por volumen:"),console.error("📊 Error object:",y),console.error("📊 Error message:",y?.message),d(y,"Error al procesar el pago. Por favor, intenta de nuevo más tarde.")}finally{i(!1),console.log("🛒 CheckoutPage.processCheckout FINALIZADO")}},R=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"Resumen del pedido"}),_.stockIssues.length>0&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(Fe,{size:18,className:"text-red-600 mr-2 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-red-800 text-sm mb-2",children:"Problemas de stock detectados"}),e.jsx("div",{className:"space-y-1",children:_.stockIssues.map((n,y)=>e.jsxs("div",{className:"text-xs text-red-700",children:[e.jsxs("strong",{children:[n.productName,":"]})," ",n.isOutOfStock?"Producto agotado":`Solo ${n.available} disponibles (solicitaste ${n.requested})`]},y))}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{onClick:()=>g("/cart"),className:"text-xs text-red-600 underline hover:no-underline",children:"Ir al carrito para ajustar cantidades"})})]})]})}),_.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-green-800 text-sm",children:"¡Descuentos Aplicados!"}),e.jsxs("div",{className:"text-xs text-green-600 mt-1 space-y-1",children:[_.totals.sellerDiscounts>0&&e.jsxs("p",{children:["Descuentos del vendedor: ",H(_.totals.sellerDiscounts)]}),_.totals.volumeDiscounts>0&&e.jsxs("p",{children:["Descuentos por volumen: ",H(_.totals.volumeDiscounts)]})]})]}),e.jsx("div",{className:"text-lg font-bold text-green-600",children:H(_.totals.totalDiscounts)})]})}),e.jsx("div",{className:"space-y-3 mb-6",children:_.items.map((n,y)=>e.jsxs("div",{className:`flex items-center justify-between py-2 border-b border-gray-100 ${n.hasStockIssue?"bg-red-50 px-2 rounded":""}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h4",{className:`text-sm font-medium ${n.hasStockIssue?"text-red-900":"text-gray-900"}`,children:[n.product?.name||`Producto ${n.productId}`,n.hasStockIssue&&e.jsx("span",{className:"ml-2 text-xs text-red-600",children:"⚠️"})]}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:["Cantidad: ",n.quantity]}),n.discount.sellerDiscountAmount>0&&e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded flex items-center",children:[e.jsx(de,{size:10,className:"mr-1"}),"Seller: ",n.product?.discount_percentage||0,"% OFF"]}),n.discount.volumeDiscountAmount>0&&e.jsxs("span",{className:"text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded flex items-center",children:[e.jsx(Ne,{size:10,className:"mr-1"}),"Volumen: ",n.discount.discountPercentage,"% OFF"]})]}),n.discount.hasDiscount&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Precio unitario: ",H(n.discount.finalPricePerUnit),e.jsx("span",{className:"line-through text-gray-400 ml-1",children:H(n.discount.originalPrice)}),n.discount.savingsTotal>0&&e.jsxs("span",{className:"text-green-600 ml-1",children:["(Ahorras: ",H(n.discount.savingsTotal),")"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("span",{className:`text-sm font-medium ${n.hasStockIssue?"text-red-900":"text-gray-900"}`,children:H(n.itemTotal)})})]},y))}),e.jsxs("div",{className:"space-y-3 border-t border-gray-200 pt-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal (con descuentos):"}),e.jsx("span",{className:"font-medium",children:H(_.totals.subtotal)})]}),_.totals.sellerDiscounts>0&&e.jsxs("div",{className:"flex justify-between text-sm text-blue-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(de,{size:14,className:"mr-1"}),"Descuentos del vendedor:"]}),e.jsxs("span",{className:"font-medium",children:["-",H(_.totals.sellerDiscounts)]})]}),_.totals.volumeDiscounts>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(Ne,{size:14,className:"mr-1"}),"Descuentos por volumen:"]}),e.jsxs("span",{className:"font-medium",children:["-",H(_.totals.volumeDiscounts)]})]}),s&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(de,{size:14,className:"mr-1"}),"Código de descuento (",s.discountCode.code,"):"]}),e.jsxs("span",{className:"font-medium",children:["-",H(_.totals.couponDiscount||0)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"IVA (15%):"}),e.jsx("span",{className:"font-medium",children:H(_.totals.tax)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Envío:"}),e.jsx("span",{className:"font-medium",children:_.totals.freeShipping?"Gratis":H(_.totals.shipping)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t border-gray-200 pt-3",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:H(_.totals.total)})]}),_.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3 mt-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Total ahorrado:"}),e.jsx("span",{className:"text-lg font-bold text-green-600",children:H(_.totals.totalDiscounts)})]})})]})]});return X&&M?e.jsx("div",{className:"container mx-auto px-4 py-10",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8 max-w-3xl mx-auto",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-10 w-10 text-green-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("h2",{className:"text-3xl font-bold text-gray-800 mb-4",children:"¡Pago con DeUna completado!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Tu pago se procesó correctamente y tu pedido está siendo preparado. Recibirás un correo electrónico con los detalles."}),_.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(de,{className:"h-5 w-5 text-green-600 mr-2"}),e.jsxs("span",{className:"text-green-800 font-medium",children:["¡Has ahorrado ",H(_.totals.totalDiscounts),"!"]})]})})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-4 pb-2 mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Detalles del pedido:"}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Número de orden:"}),e.jsx("span",{className:"font-medium",children:M.order_number})]}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Total:"}),e.jsx("span",{className:"font-medium",children:H(M.total||_.totals.total)})]}),_.totals.totalDiscounts>0&&e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Total ahorrado:"}),e.jsx("span",{className:"font-medium text-green-600",children:H(_.totals.totalDiscounts)})]}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Estado del pago:"}),e.jsx("span",{className:`font-medium ${M.payment_status==="paid"?"text-green-600":"text-yellow-600"}`,children:M.payment_status==="paid"?"Pagado":M.payment_status})]})]}),e.jsx("div",{className:"text-center mb-6",children:e.jsxs("p",{className:"text-sm text-gray-500",children:["Serás redirigido a tus pedidos en"," ",e.jsx("span",{className:"font-medium text-primary-600",children:P})," ","segundos..."]})}),e.jsxs("div",{className:"flex justify-center space-x-4 mt-6",children:[e.jsx("button",{onClick:()=>g("/"),className:"px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:"Volver a la tienda"}),e.jsx("button",{onClick:()=>g("/orders"),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"Ver mis pedidos"})]})]})}):e.jsxs("div",{className:"container mx-auto px-4 py-10",children:[e.jsxs("div",{className:"flex justify-between items-center mb-8",children:[e.jsx("h1",{className:"text-3xl font-bold",children:"Finalizar compra"}),e.jsx(Ze,{})]}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-8",children:[e.jsxs("div",{className:"lg:w-2/3",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Información de envío y facturación"}),e.jsx("div",{className:"mb-4",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 text-primary-600",checked:k,onChange:n=>w(n.target.checked)}),e.jsx("span",{className:"ml-2 text-gray-700",children:"Usar la misma dirección para facturación"})]})}),e.jsx(Se,{title:k?"Dirección de Envío y Facturación":"Dirección de Envío",address:E,onAddressChange:U,errors:A}),!k&&e.jsx("div",{className:"mt-8 pt-8 border-t border-gray-200",children:e.jsx(Se,{title:"Dirección de Facturación",address:D,onAddressChange:I,errors:A})})]}),e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Método de pago"}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[e.jsx("button",{type:"button",onClick:()=>j("credit_card"),className:`flex items-center border rounded-lg px-4 py-3 ${m==="credit_card"?"border-primary-600 bg-primary-50 text-primary-600":"border-gray-300 hover:bg-gray-50"}`,children:e.jsx("span",{children:"Tarjeta de crédito"})}),e.jsx("button",{type:"button",onClick:()=>j("deuna"),className:`flex items-center border rounded-lg px-4 py-3 ${m==="deuna"?"border-primary-600 bg-primary-50 text-primary-600":"border-gray-300 hover:bg-gray-50"}`,children:e.jsx("span",{children:"Pago con Deuna!"})})]}),m==="credit_card"&&e.jsx(Ye,{paymentInfo:$,errors:A,onChange:z,content:e.jsx(ot,{onSuccess:K,onError:x})}),m==="deuna"&&e.jsx(Xe,{total:_.totals.total,onPaymentSuccess:async n=>{console.log("✅ DeUna payment successful, processing completion:",n);try{if(!n||!n.payment_id)throw new Error("Datos de pago de DeUna incompletos");let y=null,T=0;const O=3;for(;!y&&T<O;){T++,console.log(`🔄 Intento ${T}/${O} - Verificando orden creada por webhook...`);try{await new Promise(C=>setTimeout(C,1e3*T)),y={order_id:n.order_id||`DEUNA-${Date.now()}`,order_number:n.payment_id,total:_.totals.total,payment_status:"paid",payment_method:"deuna",payment_id:n.payment_id,created_via:"deuna_webhook",completed_at:n.completed_at||new Date().toISOString()};break}catch(C){console.warn(`⚠️ Intento ${T} falló:`,C),T>=O&&(y={order_id:n.payment_id||`DEUNA-${Date.now()}`,order_number:n.payment_id||`DEUNA-${Date.now()}`,total:_.totals.total,payment_status:"processing",payment_method:"deuna",payment_id:n.payment_id,created_via:"deuna_frontend_fallback",completed_at:new Date().toISOString()},console.log("🆘 Usando datos de fallback para mostrar recibo"))}}console.log("🎯 Setting orderComplete to true and orderDetails"),S(y),Z(!0),o(),y&&y.created_via==="deuna_frontend_fallback"?r(L.WARNING,"Pago completado. Si no aparece en tus órdenes inmediatamente, revisa en unos minutos."):r(L.SUCCESS,"¡Pago completado exitosamente con DeUna!"),console.log("✅ DeUna payment completion processed successfully - should show receipt now"),console.log("📊 Order details set:",{order_id:y?.order_id,total:y?.total,created_via:y?.created_via})}catch(y){console.error("❌ Error processing DeUna payment completion:",y);const T={order_id:n?.payment_id||`DEUNA-ERROR-${Date.now()}`,order_number:n?.payment_id||`ERROR-${Date.now()}`,total:_.totals.total,payment_status:"unknown",payment_method:"deuna",payment_id:n?.payment_id||"unknown",created_via:"deuna_error_fallback",completed_at:new Date().toISOString(),error_message:"Error procesando la confirmación. Verifica tus órdenes."};S(T),Z(!0),r(L.ERROR,"Error procesando la confirmación del pago. Si el pago fue exitoso, aparecerá en tus órdenes."),d(y,"Error procesando la confirmación del pago. Por favor, verifica tus órdenes.")}},onPaymentError:n=>{console.error("❌ DeUna payment error:",n),d(new Error(n),"Error en el pago con DeUna. Por favor, intenta de nuevo.")}})]})]}),e.jsx("div",{className:"lg:w-1/3",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 sticky top-24",children:[e.jsx(R,{}),e.jsx("button",{onClick:l,disabled:c||_.stockIssues.length>0,className:"mt-6 w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-4 rounded-md transition-colors disabled:opacity-50 flex items-center justify-center",children:c?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Procesando..."]}):_.stockIssues.length>0?"Resuelve problemas de stock":`Finalizar compra - ${H(_.totals.total)}`}),_.stockIssues.length>0&&e.jsx("div",{className:"mt-3 text-xs text-center text-red-600",children:"⚠️ Ajusta las cantidades en tu carrito antes de continuar"}),e.jsxs("p",{className:"mt-4 text-xs text-gray-500 text-center",children:['Al hacer clic en "Finalizar compra", aceptas nuestros'," ",e.jsx("a",{href:"/terms",className:"text-primary-600 hover:underline",children:"Términos y condiciones"})," ","y"," ",e.jsx("a",{href:"/privacy",className:"text-primary-600 hover:underline",children:"Política de privacidad"}),"."]})]})})]})]})},mt=Object.freeze(Object.defineProperty({__proto__:null,default:st},Symbol.toStringTag,{value:"Module"}));export{it as C,et as D,xe as E,L as N,ze as a,dt as b,Qe as c,tt as d,he as e,re as f,fe as g,mt as h,ut as i,ye as u,Ke as v};
//# sourceMappingURL=checkout-chunk-DAros4Zm.js.map
