{"version":3,"file":"FavoritePage-eG5LO-vE.js","sources":["../../src/presentation/hooks/useFavoriteApi.ts","../../src/presentation/pages/FavoritePage.tsx"],"sourcesContent":["// src/presentation/hooks/useFavoriteApi.ts - OPTIMIZADO PARA CACHE REACTIVO\r\nimport {useState} from \"react\";\r\nimport ApiClient from \"../../infrastructure/api/apiClient\";\r\nimport {API_ENDPOINTS} from \"../../constants/apiEndpoints\";\r\nimport type {Favorite} from \"../../core/domain/entities/Favorite\";\r\nimport {useAuth} from \"./useAuth\";\r\nimport {useCacheInvalidation} from \"./useReactiveCache\";\r\n\r\n// Interfaces para las respuestas de la API\r\ninterface ApiResponse<T> {\r\n\tstatus: string;\r\n\tdata: T;\r\n\tmessage?: string;\r\n\tmeta?: any;\r\n}\r\n\r\ninterface FavoriteApiResponse {\r\n\tis_favorite: boolean;\r\n\tfavorite_id: number | null;\r\n\tnotification_preferences?: {\r\n\t\tnotify_price_change: boolean;\r\n\t\tnotify_promotion: boolean;\r\n\t\tnotify_low_stock: boolean;\r\n\t} | null;\r\n}\r\n\r\ninterface FavoritesResponse {\r\n\tfavorites: Array<{\r\n\t\tfavorite: Favorite;\r\n\t\tproduct?: any;\r\n\t}>;\r\n\tmeta: {\r\n\t\ttotal: number;\r\n\t\tlimit: number;\r\n\t\toffset: number;\r\n\t\thas_more: boolean;\r\n\t};\r\n}\r\n\r\ninterface UseFavoriteApiReturn {\r\n\tloading: boolean;\r\n\terror: string | null;\r\n\tgetUserFavorites: (\r\n\t\tlimit?: number,\r\n\t\toffset?: number\r\n\t) => Promise<FavoritesResponse>;\r\n\ttoggleFavorite: (\r\n\t\tproductId: number,\r\n\t\tnotificationPreferences?: {\r\n\t\t\tnotify_price_change?: boolean;\r\n\t\t\tnotify_promotion?: boolean;\r\n\t\t\tnotify_low_stock?: boolean;\r\n\t\t}\r\n\t) => Promise<{\r\n\t\tis_favorite: boolean;\r\n\t\tfavorite_id: number | null;\r\n\t\tmessage: string;\r\n\t}>;\r\n\tcheckIsFavorite: (productId: number) => Promise<{\r\n\t\tis_favorite: boolean;\r\n\t\tfavorite_id: number | null;\r\n\t\tnotification_preferences: {\r\n\t\t\tnotify_price_change: boolean;\r\n\t\t\tnotify_promotion: boolean;\r\n\t\t\tnotify_low_stock: boolean;\r\n\t\t} | null;\r\n\t}>;\r\n\tupdateNotificationPreferences: (\r\n\t\tfavoriteId: number,\r\n\t\tpreferences: {\r\n\t\t\tnotify_price_change: boolean;\r\n\t\t\tnotify_promotion: boolean;\r\n\t\t\tnotify_low_stock: boolean;\r\n\t\t}\r\n\t) => Promise<{success: boolean; message: string; favorite?: any}>;\r\n}\r\n\r\nexport const useFavoriteApi = (): UseFavoriteApiReturn => {\r\n\tconst [loading, setLoading] = useState<boolean>(false);\r\n\tconst [error, setError] = useState<string | null>(null);\r\n\tconst {isAuthenticated} = useAuth();\r\n\tconst {invalidateMany} = useCacheInvalidation();\r\n\r\n\tconst getUserFavorites = async (\r\n\t\tlimit = 10,\r\n\t\toffset = 0\r\n\t): Promise<FavoritesResponse> => {\r\n\t\ttry {\r\n\t\t\tsetLoading(true);\r\n\t\t\tsetError(null);\r\n\r\n\t\t\tif (!isAuthenticated) {\r\n\t\t\t\tthrow new Error(\"User must be authenticated to get favorites\");\r\n\t\t\t}\r\n\r\n\t\t\tconst response = await ApiClient.get<ApiResponse<any[]>>(\r\n\t\t\t\tAPI_ENDPOINTS.FAVORITES.LIST,\r\n\t\t\t\t{limit, offset}\r\n\t\t\t);\r\n\r\n\t\t\tconst apiData = response?.data || [];\r\n\t\t\tconst favorites = apiData.map((item, index) => ({\r\n\t\t\t\tfavorite: {\r\n\t\t\t\t\tid: item.product?.id ? item.product.id + 1000 : index + 1000,\r\n\t\t\t\t\tuserId: 0,\r\n\t\t\t\t\tproductId: item.product?.id || 0,\r\n\t\t\t\t\tnotifyPriceChange: true,\r\n\t\t\t\t\tnotifyPromotion: true,\r\n\t\t\t\t\tnotifyLowStock: true,\r\n\t\t\t\t},\r\n\t\t\t\tproduct: item.product,\r\n\t\t\t}));\r\n\r\n\t\t\treturn {\r\n\t\t\t\tfavorites,\r\n\t\t\t\tmeta: response?.meta || {\r\n\t\t\t\t\ttotal: favorites.length,\r\n\t\t\t\t\tlimit,\r\n\t\t\t\t\toffset,\r\n\t\t\t\t\thas_more: false,\r\n\t\t\t\t},\r\n\t\t\t};\r\n\t\t} catch (err) {\r\n\t\t\tconst errorMessage =\r\n\t\t\t\terr instanceof Error ? err.message : \"Failed to fetch favorites\";\r\n\t\t\tsetError(errorMessage);\r\n\t\t\treturn {\r\n\t\t\t\tfavorites: [],\r\n\t\t\t\tmeta: {total: 0, limit, offset, has_more: false},\r\n\t\t\t};\r\n\t\t} finally {\r\n\t\t\tsetLoading(false);\r\n\t\t}\r\n\t};\r\n\r\n\tconst toggleFavorite = async (\r\n\t\tproductId: number,\r\n\t\tnotificationPreferences?: {\r\n\t\t\tnotify_price_change?: boolean;\r\n\t\t\tnotify_promotion?: boolean;\r\n\t\t\tnotify_low_stock?: boolean;\r\n\t\t}\r\n\t) => {\r\n\t\ttry {\r\n\t\t\tsetLoading(true);\r\n\t\t\tsetError(null);\r\n\r\n\t\t\tif (!isAuthenticated) {\r\n\t\t\t\tthrow new Error(\"User must be authenticated to toggle favorites\");\r\n\t\t\t}\r\n\r\n\t\t\tconst preferences = {\r\n\t\t\t\tnotify_price_change:\r\n\t\t\t\t\tnotificationPreferences?.notify_price_change ?? true,\r\n\t\t\t\tnotify_promotion: notificationPreferences?.notify_promotion ?? true,\r\n\t\t\t\tnotify_low_stock: notificationPreferences?.notify_low_stock ?? true,\r\n\t\t\t};\r\n\r\n\t\t\tconst response = await ApiClient.post<ApiResponse<FavoriteApiResponse>>(\r\n\t\t\t\tAPI_ENDPOINTS.FAVORITES.TOGGLE,\r\n\t\t\t\t{\r\n\t\t\t\t\tproduct_id: productId,\r\n\t\t\t\t\tnotification_preferences: preferences,\r\n\t\t\t\t}\r\n\t\t\t);\r\n\r\n\t\t\t// ✅ INVALIDAR CACHE AUTOMÁTICAMENTE\r\n\t\t\tinvalidateMany([\"favorites_*\", \"header_counters\"]);\r\n\r\n\t\t\treturn {\r\n\t\t\t\tis_favorite: response?.data?.is_favorite || false,\r\n\t\t\t\tfavorite_id: response?.data?.favorite_id || null,\r\n\t\t\t\tmessage: response?.message || \"Favorite status updated\",\r\n\t\t\t};\r\n\t\t} catch (err) {\r\n\t\t\tconst errorMessage =\r\n\t\t\t\terr instanceof Error ? err.message : \"Failed to toggle favorite\";\r\n\t\t\tsetError(errorMessage);\r\n\t\t\tthrow new Error(errorMessage);\r\n\t\t} finally {\r\n\t\t\tsetLoading(false);\r\n\t\t}\r\n\t};\r\n\r\n\tconst checkIsFavorite = async (productId: number) => {\r\n\t\ttry {\r\n\t\t\tsetLoading(true);\r\n\t\t\tsetError(null);\r\n\r\n\t\t\tif (!isAuthenticated) {\r\n\t\t\t\treturn {\r\n\t\t\t\t\tis_favorite: false,\r\n\t\t\t\t\tfavorite_id: null,\r\n\t\t\t\t\tnotification_preferences: null,\r\n\t\t\t\t};\r\n\t\t\t}\r\n\r\n\t\t\tconst response = await ApiClient.get<ApiResponse<FavoriteApiResponse>>(\r\n\t\t\t\tAPI_ENDPOINTS.FAVORITES.CHECK(productId)\r\n\t\t\t);\r\n\r\n\t\t\treturn {\r\n\t\t\t\tis_favorite: response?.data?.is_favorite || false,\r\n\t\t\t\tfavorite_id: response?.data?.favorite_id || null,\r\n\t\t\t\tnotification_preferences:\r\n\t\t\t\t\tresponse?.data?.notification_preferences || null,\r\n\t\t\t};\r\n\t\t} catch (err) {\r\n\t\t\tconst errorMessage =\r\n\t\t\t\terr instanceof Error ? err.message : \"Failed to check favorite status\";\r\n\t\t\tsetError(errorMessage);\r\n\t\t\tconsole.error(errorMessage);\r\n\r\n\t\t\treturn {\r\n\t\t\t\tis_favorite: false,\r\n\t\t\t\tfavorite_id: null,\r\n\t\t\t\tnotification_preferences: null,\r\n\t\t\t};\r\n\t\t} finally {\r\n\t\t\tsetLoading(false);\r\n\t\t}\r\n\t};\r\n\r\n\tconst updateNotificationPreferences = async (\r\n\t\tfavoriteId: number,\r\n\t\tpreferences: {\r\n\t\t\tnotify_price_change: boolean;\r\n\t\t\tnotify_promotion: boolean;\r\n\t\t\tnotify_low_stock: boolean;\r\n\t\t}\r\n\t) => {\r\n\t\ttry {\r\n\t\t\tsetLoading(true);\r\n\t\t\tsetError(null);\r\n\r\n\t\t\tif (!isAuthenticated) {\r\n\t\t\t\tthrow new Error(\r\n\t\t\t\t\t\"User must be authenticated to update notification preferences\"\r\n\t\t\t\t);\r\n\t\t\t}\r\n\r\n\t\t\tconst response = await ApiClient.put<ApiResponse<any>>(\r\n\t\t\t\tAPI_ENDPOINTS.FAVORITES.UPDATE_NOTIFICATIONS(favoriteId),\r\n\t\t\t\tpreferences\r\n\t\t\t);\r\n\r\n\t\t\t// ✅ INVALIDAR CACHE TRAS ACTUALIZACIÓN\r\n\t\t\tinvalidateMany([\"favorites_*\"]);\r\n\r\n\t\t\treturn {\r\n\t\t\t\tsuccess: true,\r\n\t\t\t\tmessage: response?.message || \"Notification preferences updated\",\r\n\t\t\t\tfavorite: response?.data,\r\n\t\t\t};\r\n\t\t} catch (err) {\r\n\t\t\tconst errorMessage =\r\n\t\t\t\terr instanceof Error\r\n\t\t\t\t\t? err.message\r\n\t\t\t\t\t: \"Failed to update notification preferences\";\r\n\t\t\tsetError(errorMessage);\r\n\t\t\tthrow new Error(errorMessage);\r\n\t\t} finally {\r\n\t\t\tsetLoading(false);\r\n\t\t}\r\n\t};\r\n\r\n\treturn {\r\n\t\tloading,\r\n\t\terror,\r\n\t\tgetUserFavorites,\r\n\t\ttoggleFavorite,\r\n\t\tcheckIsFavorite,\r\n\t\tupdateNotificationPreferences,\r\n\t};\r\n};\r\n\r\nexport default useFavoriteApi;\r\n","import React, {useState, useEffect, useMemo, useCallback} from \"react\";\r\nimport {Link, useNavigate} from \"react-router-dom\";\r\nimport {\r\n\tHeart,\r\n\tTrash2,\r\n\tShoppingCart,\r\n\tStar,\r\n\tCheck,\r\n\tAlertTriangle,\r\n\tSettings,\r\n} from \"lucide-react\";\r\nimport {useFavoriteApi} from \"../hooks/useFavoriteApi\";\r\nimport {useAuth} from \"../hooks/useAuth\";\r\nimport {useCart} from \"../hooks/useCart\";\r\nimport {useInvalidateCounters} from \"../hooks/useHeaderCounters\";\r\nimport {formatCurrency} from \"../../utils/formatters/formatCurrency\";\r\nimport CacheService from \"../../infrastructure/services/CacheService\";\r\n\r\n// ✅ IMPORTAR HOOKS OPTIMIZADOS Y CACHE\r\nimport {useImageCache} from \"../hooks/useImageCache\";\r\nimport {useAutoPrefetch} from \"../hooks/useAutoPrefetch\";\r\n\r\n// Tipo para los datos del producto favorito\r\ninterface FavoriteProduct {\r\n\tid: number;\r\n\tname: string;\r\n\tprice: number | string;\r\n\tdiscount?: number | string;\r\n\tdiscount_percentage?: number | string;\r\n\trating?: number | string;\r\n\trating_count?: number | string;\r\n\timage?: string;\r\n\timages?: {\r\n\t\toriginal: string;\r\n\t\tthumbnail: string;\r\n\t\tmedium: string;\r\n\t\tlarge: string;\r\n\t}[];\r\n\tcategory?: string;\r\n\tisNew?: boolean;\r\n\tstock: number;\r\n\tslug: string;\r\n\tcategory_id?: number;\r\n\tis_in_stock?: boolean;\r\n}\r\n\r\n// Tipo para el elemento favorito completo\r\ninterface FavoriteItem {\r\n\tfavorite: {\r\n\t\tid: number;\r\n\t\tuserId: number;\r\n\t\tproductId: number;\r\n\t\tnotifyPriceChange: boolean;\r\n\t\tnotifyPromotion: boolean;\r\n\t\tnotifyLowStock: boolean;\r\n\t};\r\n\tproduct?: FavoriteProduct;\r\n}\r\n\r\n// Componente de preferencias de notificación\r\ninterface NotificationPreferencesProps {\r\n\tfavoriteId: number;\r\n\tinitialPreferences: {\r\n\t\tnotifyPriceChange: boolean;\r\n\t\tnotifyPromotion: boolean;\r\n\t\tnotifyLowStock: boolean;\r\n\t};\r\n\tonClose: () => void;\r\n}\r\n\r\nconst NotificationPreferences: React.FC<NotificationPreferencesProps> =\r\n\tReact.memo(({favoriteId, initialPreferences, onClose}) => {\r\n\t\tconst [preferences, setPreferences] = useState({\r\n\t\t\tnotify_price_change: initialPreferences.notifyPriceChange,\r\n\t\t\tnotify_promotion: initialPreferences.notifyPromotion,\r\n\t\t\tnotify_low_stock: initialPreferences.notifyLowStock,\r\n\t\t});\r\n\t\tconst [isSaving, setIsSaving] = useState(false);\r\n\t\tconst {updateNotificationPreferences} = useFavoriteApi();\r\n\r\n\t\tconst handleChange = useCallback(\r\n\t\t\t(e: React.ChangeEvent<HTMLInputElement>) => {\r\n\t\t\t\tconst {name, checked} = e.target;\r\n\t\t\t\tsetPreferences((prev) => ({...prev, [name]: checked}));\r\n\t\t\t},\r\n\t\t\t[]\r\n\t\t);\r\n\r\n\t\tconst handleSave = useCallback(async () => {\r\n\t\t\ttry {\r\n\t\t\t\tsetIsSaving(true);\r\n\t\t\t\tawait updateNotificationPreferences(favoriteId, preferences);\r\n\t\t\t\tonClose();\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.error(\"Error saving preferences:\", error);\r\n\t\t\t} finally {\r\n\t\t\t\tsetIsSaving(false);\r\n\t\t\t}\r\n\t\t}, [favoriteId, preferences, updateNotificationPreferences, onClose]);\r\n\r\n\t\treturn (\r\n\t\t\t<div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50\">\r\n\t\t\t\t<div className=\"bg-white rounded-lg p-6 max-w-md w-full shadow-xl\">\r\n\t\t\t\t\t<div className=\"flex justify-between items-center mb-4\">\r\n\t\t\t\t\t\t<h3 className=\"text-lg font-semibold\">\r\n\t\t\t\t\t\t\tPreferencias de notificación\r\n\t\t\t\t\t\t</h3>\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tonClick={onClose}\r\n\t\t\t\t\t\t\tclassName=\"text-gray-500 hover:text-gray-700\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t<span className=\"sr-only\">Cerrar</span>\r\n\t\t\t\t\t\t\t<svg\r\n\t\t\t\t\t\t\t\tclassName=\"h-6 w-6\"\r\n\t\t\t\t\t\t\t\tfill=\"none\"\r\n\t\t\t\t\t\t\t\tviewBox=\"0 0 24 24\"\r\n\t\t\t\t\t\t\t\tstroke=\"currentColor\"\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t<path\r\n\t\t\t\t\t\t\t\t\tstrokeLinecap=\"round\"\r\n\t\t\t\t\t\t\t\t\tstrokeLinejoin=\"round\"\r\n\t\t\t\t\t\t\t\t\tstrokeWidth={2}\r\n\t\t\t\t\t\t\t\t\td=\"M6 18L18 6M6 6l12 12\"\r\n\t\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t</svg>\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"space-y-4\">\r\n\t\t\t\t\t\t<div className=\"flex items-center\">\r\n\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\ttype=\"checkbox\"\r\n\t\t\t\t\t\t\t\tid=\"notify_price_change\"\r\n\t\t\t\t\t\t\t\tname=\"notify_price_change\"\r\n\t\t\t\t\t\t\t\tchecked={preferences.notify_price_change}\r\n\t\t\t\t\t\t\t\tonChange={handleChange}\r\n\t\t\t\t\t\t\t\tclassName=\"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded\"\r\n\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t<label\r\n\t\t\t\t\t\t\t\thtmlFor=\"notify_price_change\"\r\n\t\t\t\t\t\t\t\tclassName=\"ml-2 block text-sm text-gray-700\"\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\tNotificarme cambios de precio\r\n\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t<div className=\"flex items-center\">\r\n\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\ttype=\"checkbox\"\r\n\t\t\t\t\t\t\t\tid=\"notify_promotion\"\r\n\t\t\t\t\t\t\t\tname=\"notify_promotion\"\r\n\t\t\t\t\t\t\t\tchecked={preferences.notify_promotion}\r\n\t\t\t\t\t\t\t\tonChange={handleChange}\r\n\t\t\t\t\t\t\t\tclassName=\"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded\"\r\n\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t<label\r\n\t\t\t\t\t\t\t\thtmlFor=\"notify_promotion\"\r\n\t\t\t\t\t\t\t\tclassName=\"ml-2 block text-sm text-gray-700\"\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\tNotificarme promociones\r\n\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t<div className=\"flex items-center\">\r\n\t\t\t\t\t\t\t<input\r\n\t\t\t\t\t\t\t\ttype=\"checkbox\"\r\n\t\t\t\t\t\t\t\tid=\"notify_low_stock\"\r\n\t\t\t\t\t\t\t\tname=\"notify_low_stock\"\r\n\t\t\t\t\t\t\t\tchecked={preferences.notify_low_stock}\r\n\t\t\t\t\t\t\t\tonChange={handleChange}\r\n\t\t\t\t\t\t\t\tclassName=\"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded\"\r\n\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t\t<label\r\n\t\t\t\t\t\t\t\thtmlFor=\"notify_low_stock\"\r\n\t\t\t\t\t\t\t\tclassName=\"ml-2 block text-sm text-gray-700\"\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\tNotificarme cuando haya poco stock\r\n\t\t\t\t\t\t\t</label>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t<div className=\"mt-6 flex justify-end space-x-3\">\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tonClick={onClose}\r\n\t\t\t\t\t\t\tclassName=\"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\tCancelar\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tonClick={handleSave}\r\n\t\t\t\t\t\t\tdisabled={isSaving}\r\n\t\t\t\t\t\t\tclassName=\"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t{isSaving ? \"Guardando...\" : \"Guardar\"}\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\t\t);\r\n\t});\r\n\r\nconst FavoritePage: React.FC = () => {\r\n\tconst [favorites, setFavorites] = useState<FavoriteItem[]>([]);\r\n\tconst [isLoading, setIsLoading] = useState(true);\r\n\tconst [isEmpty, setIsEmpty] = useState(false);\r\n\tconst [error, setError] = useState<string | null>(null);\r\n\tconst [activePreferences, setActivePreferences] = useState<number | null>(null);\r\n\tconst [currentPage, setCurrentPage] = useState(1);\r\n\tconst [hasMore, setHasMore] = useState(false);\r\n\tconst [total, setTotal] = useState(0);\r\n\tconst [isUpdating, setIsUpdating] = useState(false);\r\n\r\n\tconst limit = 10;\r\n\tconst {getUserFavorites, toggleFavorite} = useFavoriteApi();\r\n\tconst {isAuthenticated} = useAuth();\r\n\tconst {addToCart} = useCart();\r\n\tconst navigate = useNavigate();\r\n\r\n\t// ✅ HOOKS OPTIMIZADOS\r\n\tconst {getOptimizedImageUrl} = useImageCache();\r\n\tconst {prefetchFavoritesPageData} = useAutoPrefetch({\r\n\t\tenabled: true,\r\n\t\tdelay: 300,\r\n\t\tonPrefetchComplete: () =>\r\n\t\t\tconsole.log(\"✅ Favorites page prefetch completed\"),\r\n\t});\r\n\r\n\t// ✅ HOOK PARA ACTUALIZACIONES OPTIMISTAS\r\n\tconst {\r\n\t\toptimisticCartAdd,\r\n\t\toptimisticFavoriteRemove\r\n\t} = useInvalidateCounters();\r\n\r\n\t// ✅ FUNCIÓN SIMPLE PARA INVALIDAR CACHE\r\n\tconst invalidateRelatedPages = useCallback(() => {\r\n\t\tCacheService.removeItem(\"cart_user_data\");\r\n\t\tCacheService.removeItem(\"cart_guest_data\");\r\n\t\tCacheService.removeItem(\"header_counters\");\r\n\t\t\r\n\t\t// Invalidar cache de favoritos\r\n\t\tfor (let page = 1; page <= 10; page++) {\r\n\t\t\tCacheService.removeItem(`user_favorites_${page}_10`);\r\n\t\t}\r\n\t\t\r\n\t\tconsole.log(\"🔄 Cache invalidado desde FavoritePage\");\r\n\t}, []);\r\n\r\n\t// ✅ FUNCIÓN OPTIMIZADA PARA OBTENER IMAGEN DEL PRODUCTO\r\n\tconst getProductImage = useCallback(\r\n\t\t(product: FavoriteProduct): string => {\r\n\t\t\treturn getOptimizedImageUrl(product, \"medium\");\r\n\t\t},\r\n\t\t[getOptimizedImageUrl]\r\n\t);\r\n\r\n\t// ✅ FUNCIÓN MEMOIZADA PARA CALCULAR PRECIO CON DESCUENTO\r\n\tconst calculateDiscountedPrice = useCallback((product: FavoriteProduct) => {\r\n\t\tif (!product) return {original: 0, discounted: 0, discount: 0};\r\n\r\n\t\t// CONVERTIR STRINGS A NÚMEROS\r\n\t\tconst originalPrice = parseFloat(product.price?.toString() || \"0\");\r\n\t\tconst discountPercentage = parseFloat(\r\n\t\t\t(product.discount_percentage || product.discount)?.toString() || \"0\"\r\n\t\t);\r\n\r\n\t\t// Calcular precio con descuento\r\n\t\tlet discountedPrice = originalPrice;\r\n\t\tif (discountPercentage > 0) {\r\n\t\t\tdiscountedPrice =\r\n\t\t\t\toriginalPrice - originalPrice * (discountPercentage / 100);\r\n\t\t}\r\n\r\n\t\treturn {\r\n\t\t\toriginal: originalPrice,\r\n\t\t\tdiscounted: discountedPrice,\r\n\t\t\tdiscount: discountPercentage,\r\n\t\t};\r\n\t}, []);\r\n\r\n\t// ✅ FUNCIÓN MEMOIZADA PARA RENDERIZAR ESTRELLAS\r\n\tconst renderRatingStars = useCallback(\r\n\t\t(rating: number | string = 0, ratingCount: number | string = 0) => {\r\n\t\t\t// CONVERTIR STRINGS A NÚMEROS\r\n\t\t\tconst safeRating = parseFloat(rating?.toString() || \"0\");\r\n\t\t\tconst safeRatingCount = parseInt(ratingCount?.toString() || \"0\");\r\n\r\n\t\t\treturn (\r\n\t\t\t\t<div className=\"flex items-center\">\r\n\t\t\t\t\t{[1, 2, 3, 4, 5].map((star) => (\r\n\t\t\t\t\t\t<Star\r\n\t\t\t\t\t\t\tkey={star}\r\n\t\t\t\t\t\t\tsize={14}\r\n\t\t\t\t\t\t\tclassName={`${\r\n\t\t\t\t\t\t\t\tstar <= Math.round(safeRating)\r\n\t\t\t\t\t\t\t\t\t? \"text-yellow-400 fill-current\"\r\n\t\t\t\t\t\t\t\t\t: \"text-gray-300\"\r\n\t\t\t\t\t\t\t}`}\r\n\t\t\t\t\t\t/>\r\n\t\t\t\t\t))}\r\n\t\t\t\t\t<span className=\"ml-2 text-sm text-gray-600\">\r\n\t\t\t\t\t\t{safeRating.toFixed(1)} ({safeRatingCount})\r\n\t\t\t\t\t</span>\r\n\t\t\t\t</div>\r\n\t\t\t);\r\n\t\t},\r\n\t\t[]\r\n\t);\r\n\r\n\t// ✅ FUNCIÓN PARA INVALIDAR CACHE DE FAVORITOS\r\n\tconst invalidateFavoritesCache = useCallback(() => {\r\n\t\t// Limpiar cache de todas las páginas de favoritos\r\n\t\tfor (let page = 1; page <= Math.ceil(total / limit); page++) {\r\n\t\t\tCacheService.removeItem(`user_favorites_${page}_${limit}`);\r\n\t\t}\r\n\t\tconsole.log(\"🗑️ Cache de favoritos invalidado\");\r\n\t}, [total, limit]);\r\n\r\n\t// ✅ FUNCIÓN PRINCIPAL PARA OBTENER FAVORITOS CON CACHE\r\n\tconst fetchFavorites = useCallback(async () => {\r\n\t\t// ✅ CACHE INTELIGENTE - Verificar cache primero\r\n\t\tconst cacheKey = `user_favorites_${currentPage}_${limit}`;\r\n\t\tconst cachedFavorites = CacheService.getItem(cacheKey);\r\n\r\n\t\tif (cachedFavorites && currentPage === 1) {\r\n\t\t\tconsole.log(\"💾 Usando favoritos desde cache\");\r\n\t\t\tsetFavorites(cachedFavorites.favorites);\r\n\t\t\tsetTotal(cachedFavorites.meta.total);\r\n\t\t\tsetHasMore(cachedFavorites.meta.has_more);\r\n\t\t\tsetIsEmpty(cachedFavorites.favorites.length === 0);\r\n\t\t\tsetIsLoading(false);\r\n\r\n\t\t\t// ✅ PREFETCH DE DATOS RELACIONADOS DESDE CACHE\r\n\t\t\tif (cachedFavorites.favorites.length > 0) {\r\n\t\t\t\tprefetchFavoritesPageData();\r\n\t\t\t}\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\ttry {\r\n\t\t\tsetIsLoading(true);\r\n\t\t\tconsole.log(\"🌐 Cargando favoritos desde API\");\r\n\r\n\t\t\tconst offset = (currentPage - 1) * limit;\r\n\t\t\tconst result = await getUserFavorites(limit, offset);\r\n\r\n\t\t\t// Asegúrate de que los datos tengan el formato correcto\r\n\t\t\tconst formattedFavorites = result.favorites.map((item) => ({\r\n\t\t\t\tfavorite: {\r\n\t\t\t\t\tid: item.favorite.id || 0,\r\n\t\t\t\t\tuserId: item.favorite.userId,\r\n\t\t\t\t\tproductId: item.favorite.productId,\r\n\t\t\t\t\tnotifyPriceChange: item.favorite.notifyPriceChange || false,\r\n\t\t\t\t\tnotifyPromotion: item.favorite.notifyPromotion || false,\r\n\t\t\t\t\tnotifyLowStock: item.favorite.notifyLowStock || false,\r\n\t\t\t\t},\r\n\t\t\t\tproduct: item.product,\r\n\t\t\t}));\r\n\r\n\t\t\tsetFavorites(formattedFavorites);\r\n\t\t\tsetTotal(result.meta.total);\r\n\t\t\tsetHasMore(result.meta.has_more);\r\n\t\t\tsetIsEmpty(formattedFavorites.length === 0 && currentPage === 1);\r\n\r\n\t\t\t// ✅ GUARDAR EN CACHE - 3 minutos para datos de favoritos\r\n\t\t\tconst cacheData = {\r\n\t\t\t\tfavorites: formattedFavorites,\r\n\t\t\t\tmeta: result.meta,\r\n\t\t\t};\r\n\t\t\tCacheService.setItem(cacheKey, cacheData, 3 * 60 * 1000); // 3 minutos\r\n\r\n\t\t\t// ✅ PREFETCH DE DATOS RELACIONADOS DESPUÉS DE CARGAR FAVORITOS\r\n\t\t\tif (currentPage === 1 && formattedFavorites.length > 0) {\r\n\t\t\t\tprefetchFavoritesPageData();\r\n\t\t\t}\r\n\t\t} catch (err) {\r\n\t\t\tconsole.error(\"Error fetching favorites:\", err);\r\n\t\t\tsetError(\r\n\t\t\t\t\"No se pudieron cargar los favoritos. Por favor, inténtalo de nuevo.\"\r\n\t\t\t);\r\n\t\t} finally {\r\n\t\t\tsetIsLoading(false);\r\n\t\t}\r\n\t}, [getUserFavorites, currentPage, limit, prefetchFavoritesPageData]);\r\n\r\n\t// ✅ FUNCIÓN PARA REFRESCAR MANUALMENTE (LIMPIAR CACHE)\r\n\tconst forceRefresh = useCallback(() => {\r\n\t\tconsole.log(\"🔄 Forzando refresh de favoritos\");\r\n\t\tinvalidateFavoritesCache();\r\n\t\tsetCurrentPage(1);\r\n\t\tsetIsLoading(true);\r\n\t\tfetchFavorites();\r\n\t}, [invalidateFavoritesCache, fetchFavorites]);\r\n\r\n\t// ✅ HANDLER PARA REMOVER DE FAVORITOS CON OPTIMIZACIÓN\r\n\tconst handleRemoveFromWishlist = useCallback(\r\n\t\tasync (productId: number) => {\r\n\t\t\t// ✅ PREVENIR DOBLES CLICKS\r\n\t\t\tif (isUpdating) {\r\n\t\t\t\tconsole.log(\"Ya se está procesando una acción, ignorando click\");\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\ttry {\r\n\t\t\t\tsetIsUpdating(true);\r\n\r\n\t\t\t\t// ✅ ACTUALIZACIÓN OPTIMISTA INMEDIATA\r\n\t\t\t\toptimisticFavoriteRemove();\r\n\r\n\t\t\t\tawait toggleFavorite(productId);\r\n\r\n\t\t\t\t// ✅ INVALIDAR CACHE Y RECARGAR\r\n\t\t\t\tinvalidateRelatedPages();\r\n\r\n\t\t\t\t// Recargar favoritos\r\n\t\t\t\tawait fetchFavorites();\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.error(\"Error removing from favorites:\", error);\r\n\t\t\t} finally {\r\n\t\t\t\t// ✅ TIMEOUT PARA PREVENIR SPAM\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tsetIsUpdating(false);\r\n\t\t\t\t}, 500);\r\n\t\t\t}\r\n\t\t},\r\n\t\t[toggleFavorite, invalidateRelatedPages, fetchFavorites, optimisticFavoriteRemove, isUpdating]\r\n\t);\r\n\r\n\t// ✅ HANDLER PARA AGREGAR AL CARRITO CON OPTIMIZACIÓN\r\n\tconst handleAddToCart = useCallback(\r\n\t\tasync (product: FavoriteProduct) => {\r\n\t\t\t// ✅ PREVENIR DOBLES CLICKS\r\n\t\t\tif (isUpdating) {\r\n\t\t\t\tconsole.log(\"Ya se está procesando una acción, ignorando click\");\r\n\t\t\t\treturn;\r\n\t\t\t}\r\n\r\n\t\t\ttry {\r\n\t\t\t\tif (!product.stock || product.stock <= 0) {\r\n\t\t\t\t\treturn;\r\n\t\t\t\t}\r\n\r\n\t\t\t\tsetIsUpdating(true);\r\n\r\n\t\t\t\t// ✅ ACTUALIZACIÓN OPTIMISTA INMEDIATA\r\n\t\t\t\toptimisticCartAdd();\r\n\r\n\t\t\t\tawait addToCart({\r\n\t\t\t\t\tproductId: product.id,\r\n\t\t\t\t\tquantity: 1,\r\n\t\t\t\t});\r\n\r\n\t\t\t\t// ✅ INVALIDAR CACHE DE CARRITO (no afecta favoritos)\r\n\t\t\t\tinvalidateRelatedPages();\r\n\t\t\t} catch (error) {\r\n\t\t\t\tconsole.error(`Error adding product ${product.id} to cart:`, error);\r\n\t\t\t} finally {\r\n\t\t\t\t// ✅ TIMEOUT PARA PREVENIR SPAM\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tsetIsUpdating(false);\r\n\t\t\t\t}, 500);\r\n\t\t\t}\r\n\t\t},\r\n\t\t[addToCart, optimisticCartAdd, invalidateRelatedPages, isUpdating]\r\n\t);\r\n\r\n\t// ✅ HANDLER PARA ABRIR PREFERENCIAS\r\n\tconst openPreferences = useCallback((favoriteId: number) => {\r\n\t\tif (favoriteId) {\r\n\t\t\tsetActivePreferences(favoriteId);\r\n\t\t}\r\n\t}, []);\r\n\r\n\t// ✅ HANDLER PARA CERRAR PREFERENCIAS\r\n\tconst closePreferences = useCallback(() => {\r\n\t\tsetActivePreferences(null);\r\n\t}, []);\r\n\r\n\t// ✅ HANDLER PARA CARGAR MÁS\r\n\tconst loadMore = useCallback(() => {\r\n\t\tif (hasMore && !isLoading) {\r\n\t\t\tconsole.log(\"📄 Cargando más favoritos - página\", currentPage + 1);\r\n\t\t\tsetCurrentPage((prev) => prev + 1);\r\n\t\t}\r\n\t}, [hasMore, isLoading, currentPage]);\r\n\r\n\t// ✅ MEMOIZAR FAVORITOS CON DATOS CALCULADOS\r\n\tconst favoritesWithCalculatedData = useMemo(() => {\r\n\t\treturn favorites.map((item) => {\r\n\t\t\tconst product = item.product;\r\n\t\t\tif (!product)\r\n\t\t\t\treturn {\r\n\t\t\t\t\t...item,\r\n\t\t\t\t\tprices: null,\r\n\t\t\t\t\timageUrl: \"\",\r\n\t\t\t\t\tisInStock: false,\r\n\t\t\t\t\tratingStars: (\r\n\t\t\t\t\t\t<div className=\"flex items-center\">\r\n\t\t\t\t\t\t\t<span className=\"text-sm text-gray-600\">Sin valorar</span>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t),\r\n\t\t\t\t};\r\n\r\n\t\t\tconst isInStock =\r\n\t\t\t\tproduct.is_in_stock !== undefined\r\n\t\t\t\t\t? product.is_in_stock\r\n\t\t\t\t\t: product.stock > 0;\r\n\r\n\t\t\treturn {\r\n\t\t\t\t...item,\r\n\t\t\t\tprices: calculateDiscountedPrice(product),\r\n\t\t\t\timageUrl: getProductImage(product),\r\n\t\t\t\tisInStock,\r\n\t\t\t\tratingStars: renderRatingStars(\r\n\t\t\t\t\tproduct.rating || 0,\r\n\t\t\t\t\tproduct.rating_count || 0\r\n\t\t\t\t),\r\n\t\t\t};\r\n\t\t});\r\n\t}, [favorites, calculateDiscountedPrice, getProductImage, renderRatingStars]);\r\n\r\n\t// ✅ CARGA INICIAL SIMPLE - Solo cache y fetch\r\n\tuseEffect(() => {\r\n\t\tif (!isAuthenticated) {\r\n\t\t\tnavigate(\"/login\", {state: {from: \"/favorites\"}});\r\n\t\t\treturn;\r\n\t\t}\r\n\r\n\t\t// Solo ejecutar en primera carga\r\n\t\tif (currentPage !== 1) return;\r\n\r\n\t\t// Verificar cache de la primera página inmediatamente\r\n\t\tconst cacheKey = `user_favorites_1_${limit}`;\r\n\t\tconst cachedFavorites = CacheService.getItem(cacheKey);\r\n\r\n\t\tif (cachedFavorites) {\r\n\t\t\tconsole.log(\"⚡ Carga instantánea desde cache\");\r\n\t\t\tsetFavorites(cachedFavorites.favorites);\r\n\t\t\tsetTotal(cachedFavorites.meta.total);\r\n\t\t\tsetHasMore(cachedFavorites.meta.has_more);\r\n\t\t\tsetIsEmpty(cachedFavorites.favorites.length === 0);\r\n\t\t\tsetIsLoading(false);\r\n\r\n\t\t\t// Opcional: refrescar en background si el cache es viejo\r\n\t\t\tconst cacheAge = Date.now() - (cachedFavorites.timestamp || 0);\r\n\t\t\tif (cacheAge > 60 * 1000) {\r\n\t\t\t\t// Si tiene más de 1 minuto, refrescar en background\r\n\t\t\t\tsetTimeout(() => {\r\n\t\t\t\t\tfetchFavorites();\r\n\t\t\t\t}, 100);\r\n\t\t\t}\r\n\t\t} else {\r\n\t\t\tfetchFavorites();\r\n\t\t}\r\n\t}, [isAuthenticated, navigate]); // ✅ DEPENDENCIAS MÍNIMAS\r\n\r\n\t// ✅ EFFECT SEPARADO PARA PÁGINAS ADICIONALES\r\n\tuseEffect(() => {\r\n\t\tif (isAuthenticated && currentPage > 1) {\r\n\t\t\tfetchFavorites();\r\n\t\t}\r\n\t}, [isAuthenticated, currentPage, fetchFavorites]);\r\n\r\n\t// ✅ COMPONENTE MEMOIZADO PARA ITEM DE FAVORITO\r\n\tconst FavoriteItem = React.memo(\r\n\t\t({\r\n\t\t\titem,\r\n\t\t\tprices,\r\n\t\t\timageUrl,\r\n\t\t\tisInStock,\r\n\t\t\tratingStars,\r\n\t\t\tonRemove,\r\n\t\t\tonAddToCart,\r\n\t\t\tonOpenPreferences,\r\n\t\t\tisUpdating,\r\n\t\t}: {\r\n\t\t\titem: FavoriteItem;\r\n\t\t\tprices: any;\r\n\t\t\timageUrl: string;\r\n\t\t\tisInStock: boolean;\r\n\t\t\tratingStars: React.ReactElement;\r\n\t\t\tonRemove: () => void;\r\n\t\t\tonAddToCart: () => void;\r\n\t\t\tonOpenPreferences: () => void;\r\n\t\t\tisUpdating: boolean;\r\n\t\t}) => {\r\n\t\t\tconst product = item.product;\r\n\t\t\tif (!product) return null;\r\n\r\n\t\t\treturn (\r\n\t\t\t\t<div className=\"flex flex-col sm:flex-row p-6 border-b border-gray-200 last:border-b-0 hover:bg-gray-50 transition-colors\">\r\n\t\t\t\t\t{/* Imagen del producto con badges */}\r\n\t\t\t\t\t<div className=\"sm:w-40 sm:h-40 h-60 w-full flex-shrink-0 mx-auto sm:mx-0 relative\">\r\n\t\t\t\t\t\t<Link to={`/products/${product.id}`}>\r\n\t\t\t\t\t\t\t<img\r\n\t\t\t\t\t\t\t\tsrc={imageUrl}\r\n\t\t\t\t\t\t\t\talt={product.name}\r\n\t\t\t\t\t\t\t\tclassName=\"w-full h-full object-contain sm:object-cover rounded-lg shadow-sm\"\r\n\t\t\t\t\t\t\t/>\r\n\t\t\t\t\t\t</Link>\r\n\r\n\t\t\t\t\t\t{/* Badges */}\r\n\t\t\t\t\t\t<div className=\"absolute top-2 left-2 flex flex-col space-y-1\">\r\n\t\t\t\t\t\t\t{prices.discount > 0 && (\r\n\t\t\t\t\t\t\t\t<span className=\"bg-red-500 text-white text-xs font-bold px-2 py-1 rounded-md shadow-sm\">\r\n\t\t\t\t\t\t\t\t\t{prices.discount}% OFF\r\n\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t{product.isNew && (\r\n\t\t\t\t\t\t\t\t<span className=\"bg-green-500 text-white text-xs font-bold px-2 py-1 rounded-md shadow-sm\">\r\n\t\t\t\t\t\t\t\t\tNUEVO\r\n\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t{/* Información del producto */}\r\n\t\t\t\t\t<div className=\"flex-1 sm:ml-6 mt-4 sm:mt-0 flex flex-col\">\r\n\t\t\t\t\t\t<div className=\"flex justify-between\">\r\n\t\t\t\t\t\t\t<div>\r\n\t\t\t\t\t\t\t\t{/* Categoría */}\r\n\t\t\t\t\t\t\t\t{product.category && (\r\n\t\t\t\t\t\t\t\t\t<span className=\"inline-block text-xs font-medium text-gray-500 bg-gray-100 px-2 py-1 rounded-md mb-2 uppercase tracking-wide\">\r\n\t\t\t\t\t\t\t\t\t\t{product.category}\r\n\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t\t\t\t{/* Nombre del producto */}\r\n\t\t\t\t\t\t\t\t<Link to={`/products/${product.id}`} className=\"block\">\r\n\t\t\t\t\t\t\t\t\t<h3 className=\"text-xl font-medium text-gray-800 hover:text-primary-600 transition-colors mb-2\">\r\n\t\t\t\t\t\t\t\t\t\t{product.name}\r\n\t\t\t\t\t\t\t\t\t</h3>\r\n\t\t\t\t\t\t\t\t</Link>\r\n\r\n\t\t\t\t\t\t\t\t{/* Valoración */}\r\n\t\t\t\t\t\t\t\t<div className=\"mb-2\">{ratingStars}</div>\r\n\r\n\t\t\t\t\t\t\t\t{/* Disponibilidad */}\r\n\t\t\t\t\t\t\t\t<div className=\"mb-3\">\r\n\t\t\t\t\t\t\t\t\t{isInStock ? (\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"inline-flex items-center text-sm text-green-600\">\r\n\t\t\t\t\t\t\t\t\t\t\t<Check size={14} className=\"mr-1\" />\r\n\t\t\t\t\t\t\t\t\t\t\tEn stock\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"inline-flex items-center text-sm text-amber-600\">\r\n\t\t\t\t\t\t\t\t\t\t\t<AlertTriangle size={14} className=\"mr-1\" />\r\n\t\t\t\t\t\t\t\t\t\t\tAgotado\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t{/* Botones de acciones */}\r\n\t\t\t\t\t\t\t<div className=\"flex space-x-2\">\r\n\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\tonClick={onOpenPreferences}\r\n\t\t\t\t\t\t\t\t\tdisabled={isUpdating}\r\n\t\t\t\t\t\t\t\t\tclassName=\"cursor-pointer text-gray-400 hover:text-blue-500 transition-colors disabled:opacity-50\"\r\n\t\t\t\t\t\t\t\t\taria-label=\"Configurar notificaciones\"\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t<Settings size={20} className=\"stroke-current\" />\r\n\t\t\t\t\t\t\t\t</button>\r\n\r\n\t\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\t\tonClick={onRemove}\r\n\t\t\t\t\t\t\t\t\tdisabled={isUpdating}\r\n\t\t\t\t\t\t\t\t\tclassName=\"cursor-pointer text-gray-400 hover:text-red-500 transition-colors disabled:opacity-50\"\r\n\t\t\t\t\t\t\t\t\taria-label=\"Eliminar de favoritos\"\r\n\t\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t\t<Trash2 size={20} className=\"stroke-current\" />\r\n\t\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t{/* Precio y botón de añadir al carrito */}\r\n\t\t\t\t\t\t<div className=\"mt-auto pt-4 flex flex-wrap sm:flex-nowrap items-center justify-between\">\r\n\t\t\t\t\t\t\t<div className=\"flex items-center mb-3 sm:mb-0\">\r\n\t\t\t\t\t\t\t\t{prices.discount > 0 ? (\r\n\t\t\t\t\t\t\t\t\t<>\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"font-bold text-primary-600 text-xl\">\r\n\t\t\t\t\t\t\t\t\t\t\t{formatCurrency(prices.discounted)}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"text-sm text-gray-500 line-through ml-2\">\r\n\t\t\t\t\t\t\t\t\t\t\t{formatCurrency(prices.original)}\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t\t<span className=\"ml-3 px-2 py-1 text-xs font-semibold text-white bg-red-500 rounded\">\r\n\t\t\t\t\t\t\t\t\t\t\t{prices.discount}% DESCUENTO\r\n\t\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t\t</>\r\n\t\t\t\t\t\t\t\t) : (\r\n\t\t\t\t\t\t\t\t\t<span className=\"font-bold text-primary-600 text-xl\">\r\n\t\t\t\t\t\t\t\t\t\t{formatCurrency(prices.original)}\r\n\t\t\t\t\t\t\t\t\t</span>\r\n\t\t\t\t\t\t\t\t)}\r\n\t\t\t\t\t\t\t</div>\r\n\r\n\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\tonClick={onAddToCart}\r\n\t\t\t\t\t\t\t\tdisabled={!isInStock || isUpdating}\r\n\t\t\t\t\t\t\t\tclassName={`cursor-pointer inline-flex items-center px-5 py-2.5 rounded-lg text-white font-medium transition-all disabled:opacity-50 ${\r\n\t\t\t\t\t\t\t\t\tisInStock && !isUpdating\r\n\t\t\t\t\t\t\t\t\t\t? \"bg-primary-600 hover:bg-primary-700 shadow-sm hover:shadow\"\r\n\t\t\t\t\t\t\t\t\t\t: \"bg-gray-400 cursor-not-allowed\"\r\n\t\t\t\t\t\t\t\t}`}\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t<ShoppingCart size={18} className=\"mr-2\" />\r\n\t\t\t\t\t\t\t\t{isUpdating ? \"Agregando...\" : isInStock ? \"Añadir al carrito\" : \"Agotado\"}\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t</div>\r\n\t\t\t\t</div>\r\n\t\t\t);\r\n\t\t}\r\n\t);\r\n\r\n\treturn (\r\n\t\t<div className=\"container mx-auto px-10 lg:px-20 py-10\">\r\n\t\t\t<div className=\"flex flex-wrap justify-between items-center mb-8\">\r\n\t\t\t\t<h1 className=\"text-3xl font-bold\">Mis Favoritos</h1>\r\n\r\n\t\t\t\t<div className=\"flex items-center space-x-4\">\r\n\t\t\t\t\t{!isEmpty && !isLoading && (\r\n\t\t\t\t\t\t<div className=\"text-sm text-gray-500 px-3 py-1.5 bg-gray-100 rounded-full\">\r\n\t\t\t\t\t\t\t{total} {total === 1 ? \"producto\" : \"productos\"} en tu lista\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t)}\r\n\r\n\t\t\t\t\t{/* ✅ BOTÓN DE REFRESH OPCIONAL */}\r\n\t\t\t\t\t{!isEmpty && (\r\n\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\tonClick={forceRefresh}\r\n\t\t\t\t\t\t\tdisabled={isLoading || isUpdating}\r\n\t\t\t\t\t\t\tclassName=\"text-sm text-blue-600 hover:text-blue-700 disabled:opacity-50 px-3 py-1.5 border border-blue-200 rounded-lg hover:bg-blue-50 transition-colors\"\r\n\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t{isLoading ? \"Actualizando...\" : \"Actualizar\"}\r\n\t\t\t\t\t\t</button>\r\n\t\t\t\t\t)}\r\n\t\t\t\t</div>\r\n\t\t\t</div>\r\n\r\n\t\t\t{error && (\r\n\t\t\t\t<div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg mb-6\">\r\n\t\t\t\t\t{error}\r\n\t\t\t\t\t<button className=\"ml-2 underline\" onClick={forceRefresh}>\r\n\t\t\t\t\t\tReintentar\r\n\t\t\t\t\t</button>\r\n\t\t\t\t</div>\r\n\t\t\t)}\r\n\r\n\t\t\t{isLoading ? (\r\n\t\t\t\t<div className=\"flex justify-center items-center h-64\">\r\n\t\t\t\t\t<div className=\"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600\"></div>\r\n\t\t\t\t</div>\r\n\t\t\t) : isEmpty ? (\r\n\t\t\t\t<div className=\"text-center py-20 bg-gradient-to-b from-gray-50 to-white rounded-xl shadow-md\">\r\n\t\t\t\t\t<Heart className=\"mx-auto h-16 w-16 text-red-100 mb-6\" />\r\n\t\t\t\t\t<h2 className=\"text-2xl font-semibold text-gray-700 mb-3\">\r\n\t\t\t\t\t\tTu lista de favoritos está vacía\r\n\t\t\t\t\t</h2>\r\n\t\t\t\t\t<p className=\"text-gray-500 mb-8 max-w-md mx-auto\">\r\n\t\t\t\t\t\tGuarda los productos que te gusten para verlos más tarde.\r\n\t\t\t\t\t</p>\r\n\t\t\t\t\t<Link\r\n\t\t\t\t\t\tto=\"/products\"\r\n\t\t\t\t\t\tclassName=\"inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-lg text-white bg-primary-600 hover:bg-primary-700 shadow-sm hover:shadow transition-all\"\r\n\t\t\t\t\t>\r\n\t\t\t\t\t\tExplorar productos\r\n\t\t\t\t\t</Link>\r\n\t\t\t\t</div>\r\n\t\t\t) : (\r\n\t\t\t\t<div className=\"bg-white rounded-xl shadow-lg overflow-hidden\">\r\n\t\t\t\t\t{/* USANDO FAVORITOS MEMOIZADOS */}\r\n\t\t\t\t\t{favoritesWithCalculatedData.map((item) => (\r\n\t\t\t\t\t\t<FavoriteItem\r\n\t\t\t\t\t\t\tkey={item.favorite.id}\r\n\t\t\t\t\t\t\titem={item}\r\n\t\t\t\t\t\t\tprices={item.prices}\r\n\t\t\t\t\t\t\timageUrl={item.imageUrl}\r\n\t\t\t\t\t\t\tisInStock={item.isInStock}\r\n\t\t\t\t\t\t\tratingStars={item.ratingStars}\r\n\t\t\t\t\t\t\tonRemove={() => handleRemoveFromWishlist(item.product!.id)}\r\n\t\t\t\t\t\t\tonAddToCart={() => handleAddToCart(item.product!)}\r\n\t\t\t\t\t\t\tonOpenPreferences={() => openPreferences(item.favorite.id)}\r\n\t\t\t\t\t\t\tisUpdating={isUpdating}\r\n\t\t\t\t\t\t/>\r\n\t\t\t\t\t))}\r\n\r\n\t\t\t\t\t{/* Paginación o botón \"cargar más\" */}\r\n\t\t\t\t\t{hasMore && (\r\n\t\t\t\t\t\t<div className=\"flex justify-center py-4\">\r\n\t\t\t\t\t\t\t<button\r\n\t\t\t\t\t\t\t\tonClick={loadMore}\r\n\t\t\t\t\t\t\t\tdisabled={isLoading || isUpdating}\r\n\t\t\t\t\t\t\t\tclassName=\"px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 disabled:opacity-50\"\r\n\t\t\t\t\t\t\t>\r\n\t\t\t\t\t\t\t\t{isLoading ? \"Cargando...\" : \"Cargar más favoritos\"}\r\n\t\t\t\t\t\t\t</button>\r\n\t\t\t\t\t\t</div>\r\n\t\t\t\t\t)}\r\n\t\t\t\t</div>\r\n\t\t\t)}\r\n\r\n\t\t\t{/* Modal para las preferencias de notificación */}\r\n\t\t\t{activePreferences !== null && (\r\n\t\t\t\t<NotificationPreferences\r\n\t\t\t\t\tfavoriteId={activePreferences}\r\n\t\t\t\t\tinitialPreferences={{\r\n\t\t\t\t\t\tnotifyPriceChange:\r\n\t\t\t\t\t\t\tfavorites.find((f) => f.favorite.id === activePreferences)\r\n\t\t\t\t\t\t\t\t?.favorite.notifyPriceChange || true,\r\n\t\t\t\t\t\tnotifyPromotion:\r\n\t\t\t\t\t\t\tfavorites.find((f) => f.favorite.id === activePreferences)\r\n\t\t\t\t\t\t\t\t?.favorite.notifyPromotion || true,\r\n\t\t\t\t\t\tnotifyLowStock:\r\n\t\t\t\t\t\t\tfavorites.find((f) => f.favorite.id === activePreferences)\r\n\t\t\t\t\t\t\t\t?.favorite.notifyLowStock || true,\r\n\t\t\t\t\t}}\r\n\t\t\t\t\tonClose={closePreferences}\r\n\t\t\t\t/>\r\n\t\t\t)}\r\n\t\t</div>\r\n\t);\r\n};\r\n\r\nexport default FavoritePage;"],"names":["useFavoriteApi","loading","setLoading","useState","error","setError","isAuthenticated","useAuth","invalidateMany","useCacheInvalidation","limit","offset","response","ApiClient","API_ENDPOINTS","favorites","item","index","err","errorMessage","productId","notificationPreferences","preferences","favoriteId","NotificationPreferences","React","initialPreferences","onClose","setPreferences","isSaving","setIsSaving","updateNotificationPreferences","handleChange","useCallback","e","name","checked","prev","handleSave","jsxs","jsx","FavoritePage","setFavorites","isLoading","setIsLoading","isEmpty","setIsEmpty","activePreferences","setActivePreferences","currentPage","setCurrentPage","hasMore","setHasMore","total","setTotal","isUpdating","setIsUpdating","getUserFavorites","toggleFavorite","addToCart","useCart","navigate","useNavigate","getOptimizedImageUrl","useImageCache","prefetchFavoritesPageData","useAutoPrefetch","optimisticCartAdd","optimisticFavoriteRemove","useInvalidateCounters","invalidateRelatedPages","CacheService","page","getProductImage","product","calculateDiscountedPrice","originalPrice","discountPercentage","discountedPrice","renderRatingStars","rating","ratingCount","safeRating","safeRatingCount","star","Star","invalidateFavoritesCache","fetchFavorites","cacheKey","cachedFavorites","result","formattedFavorites","cacheData","forceRefresh","handleRemoveFromWishlist","handleAddToCart","openPreferences","closePreferences","loadMore","favoritesWithCalculatedData","useMemo","isInStock","useEffect","FavoriteItem","prices","imageUrl","ratingStars","onRemove","onAddToCart","onOpenPreferences","Link","Check","AlertTriangle","Settings","Trash2","Fragment","formatCurrency","ShoppingCart","Heart","f"],"mappings":"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"}