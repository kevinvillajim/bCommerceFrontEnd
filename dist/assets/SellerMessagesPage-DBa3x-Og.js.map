{"version":3,"file":"SellerMessagesPage-DBa3x-Og.js","sources":["../../src/presentation/pages/seller/SellerMessagesPage.tsx"],"sourcesContent":["// src/presentation/pages/seller/SellerMessagesPage.tsx - LOADING INFINITO CORREGIDO\n\nimport React, {useState, useEffect, useRef, useCallback} from \"react\";\nimport {useParams, useNavigate} from \"react-router-dom\";\nimport {MessageSquare, ArrowLeft, RefreshCw} from \"lucide-react\";\nimport {useChat} from \"../../hooks/useChat\";\nimport {useAuth} from \"../../hooks/useAuth\";\nimport ChatList from \"../../components/chat/ChatList\";\nimport ChatMessages from \"../../components/chat/ChatMessages\";\nimport ChatHeader from \"../../components/chat/ChatHeader\";\nimport MessageForm from \"../../components/chat/MessageForm\";\nimport {useChatFilterNotifications} from \"../../components/notifications/ChatFilterToast\";\nimport type {Chat} from \"../../../core/domain/entities/Chat\";\n\nconst SellerMessagesPage: React.FC = () => {\n\tconst navigate = useNavigate();\n\tconst {chatId: chatIdParam} = useParams<{chatId?: string}>();\n\tconst {user} = useAuth();\n\n\t// Estados para filtros y búsqueda\n\tconst [searchTerm, setSearchTerm] = useState<string>(\"\");\n\tconst [statusFilter, setStatusFilter] = useState<string>(\"all\");\n\tconst [unreadFilter, setUnreadFilter] = useState<boolean>(false);\n\tconst [isMobileView, setIsMobileView] = useState<boolean>(\n\t\twindow.innerWidth < 768\n\t);\n\tconst [showChatList, setShowChatList] = useState<boolean>(!chatIdParam);\n\tconst [isLoadingChat, setIsLoadingChat] = useState<boolean>(false);\n\tconst [loadingMessage, setLoadingMessage] = useState<string>(\n\t\t\"Cargando conversaciones...\"\n\t);\n\n\t// Referencias para evitar bucles infinitos\n\tconst initialLoadComplete = useRef<boolean>(false);\n\tconst chatIdRef = useRef<string | undefined>(chatIdParam);\n\tconst loadAttempts = useRef<number>(0);\n\tconst isInitialNavRef = useRef<boolean>(true);\n\tconst markAllAsReadCalledRef = useRef<Record<number, boolean>>({});\n\tconst lastSelectedChatRef = useRef<number | null>(null);\n\n\t// Hook para notificaciones de filtro\n\tconst {\n\t\tshowSellerStrike,\n\t\tshowSellerBlocked,\n\t\tNotificationComponent\n\t} = useChatFilterNotifications();\n\n\t// Obtener datos del chat usando el hook personalizado para vendedores\n\tconst {\n\t\tchats,\n\t\tselectedChat,\n\t\tmessages,\n\t\tloading,\n\t\terror,\n\t\tfetchChats,\n\t\tfetchChatMessages,\n\t\tsendMessage,\n\t\tupdateChatStatus,\n\t\tsetSelectedChat,\n\t\tstartMessagesPolling,\n\t\tstopMessagesPolling,\n\t\tmarkAllAsRead,\n\t} = useChat(true); // IMPORTANTE: true para vendedor\n\n\t// Función para detectar cambios en el tamaño de la ventana\n\tuseEffect(() => {\n\t\tconst handleResize = () => {\n\t\t\tsetIsMobileView(window.innerWidth < 768);\n\t\t};\n\n\t\twindow.addEventListener(\"resize\", handleResize);\n\t\treturn () => window.removeEventListener(\"resize\", handleResize);\n\t}, []);\n\n\t// Cargar chats al iniciar\n\tuseEffect(() => {\n\t\tif (!initialLoadComplete.current && user?.id) {\n\t\t\tconsole.log(\"Cargando lista inicial de chats para vendedor...\");\n\t\t\tsetIsLoadingChat(true);\n\n\t\t\tfetchChats()\n\t\t\t\t.then((fetchedChats) => {\n\t\t\t\t\tinitialLoadComplete.current = true;\n\t\t\t\t\tsetIsLoadingChat(false);\n\t\t\t\t\tconsole.log(`Lista inicial de ${fetchedChats.length} chats cargada`);\n\n\t\t\t\t\tif (chatIdParam && fetchedChats.length > 0) {\n\t\t\t\t\t\tconst chatId = parseInt(chatIdParam, 10);\n\t\t\t\t\t\tconst chat = fetchedChats.find((c) => c.id === chatId);\n\n\t\t\t\t\t\tif (chat) {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`Chat ${chatId} encontrado en carga inicial, seleccionando...`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tsetSelectedChat(chat);\n\t\t\t\t\t\t\tsetShowChatList(false);\n\t\t\t\t\t\t\tlastSelectedChatRef.current = chatId;\n\n\t\t\t\t\t\t\t// Marcar como leído después de un delay\n\t\t\t\t\t\t\tif (chat.unreadCount && chat.unreadCount > 0 && !markAllAsReadCalledRef.current[chatId]) {\n\t\t\t\t\t\t\t\tmarkAllAsReadCalledRef.current[chatId] = true;\n\t\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t\tmarkAllAsRead(chatId).catch(console.error);\n\t\t\t\t\t\t\t\t}, 1000);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconsole.log(\n\t\t\t\t\t\t\t\t`Chat ${chatId} no encontrado en lista inicial, intentando carga directa...`\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t\tloadSpecificChat(chatId);\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch((err) => {\n\t\t\t\t\tconsole.error(\"Error al cargar chats iniciales:\", err);\n\t\t\t\t\tsetIsLoadingChat(false);\n\t\t\t\t\tinitialLoadComplete.current = true;\n\t\t\t\t});\n\t\t}\n\t}, [fetchChats, chatIdParam, setSelectedChat, user?.id, markAllAsRead]);\n\n\t// Función para cargar un chat específico\n\tconst loadSpecificChat = useCallback(\n\t\tasync (chatId: number) => {\n\t\t\tif (lastSelectedChatRef.current === chatId) {\n\t\t\t\tconsole.log(`Chat ${chatId} ya está seleccionado, omitiendo carga.`);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!user?.id) return;\n\n\t\t\tconsole.log(`Intentando cargar chat específico ${chatId}...`);\n\t\t\tsetIsLoadingChat(true);\n\t\t\tsetLoadingMessage(`Cargando conversación #${chatId}...`);\n\t\t\tloadAttempts.current += 1;\n\n\t\t\ttry {\n\t\t\t\tconst chat = chats.find((c) => c.id === chatId);\n\n\t\t\t\tif (chat) {\n\t\t\t\t\tconsole.log(`Chat ${chatId} encontrado en la lista, seleccionando...`);\n\t\t\t\t\tsetSelectedChat(chat);\n\t\t\t\t\tsetShowChatList(false);\n\t\t\t\t\tlastSelectedChatRef.current = chatId;\n\n\t\t\t\t\tstartMessagesPolling(chatId);\n\n\t\t\t\t\t// Marcar como leído\n\t\t\t\t\tif (chat.unreadCount && chat.unreadCount > 0 && !markAllAsReadCalledRef.current[chatId]) {\n\t\t\t\t\t\tmarkAllAsReadCalledRef.current[chatId] = true;\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tmarkAllAsRead(chatId).catch(console.error);\n\t\t\t\t\t\t}, 1000);\n\t\t\t\t\t}\n\t\t\t\t} else {\n\t\t\t\t\tconsole.log(`Chat ${chatId} no encontrado en la lista, cargando desde API...`);\n\t\t\t\t\ttry {\n\t\t\t\t\t\tconst result = await fetchChatMessages(chatId);\n\n\t\t\t\t\t\tif (result) {\n\t\t\t\t\t\t\tconsole.log(`Chat ${chatId} cargado correctamente desde API`);\n\t\t\t\t\t\t\tsetShowChatList(false);\n\t\t\t\t\t\t\tlastSelectedChatRef.current = chatId;\n\t\t\t\t\t\t\tstartMessagesPolling(chatId);\n\n\t\t\t\t\t\t\t// Marcar como leído\n\t\t\t\t\t\t\tif (!markAllAsReadCalledRef.current[chatId]) {\n\t\t\t\t\t\t\t\tmarkAllAsReadCalledRef.current[chatId] = true;\n\t\t\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\t\t\tmarkAllAsRead(chatId).catch(console.error);\n\t\t\t\t\t\t\t\t}, 1000);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconsole.warn(`Chat ${chatId} no encontrado en API`);\n\n\t\t\t\t\t\t\tif (loadAttempts.current >= 3) {\n\t\t\t\t\t\t\t\tnavigate(\"/seller/messages\", {replace: true});\n\t\t\t\t\t\t\t\tlastSelectedChatRef.current = null;\n\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\tconst updatedChats = await fetchChats();\n\t\t\t\t\t\t\t\tconst updatedChat = updatedChats.find((c) => c.id === chatId);\n\t\t\t\t\t\t\t\tif (updatedChat) {\n\t\t\t\t\t\t\t\t\tsetSelectedChat(updatedChat);\n\t\t\t\t\t\t\t\t\tsetShowChatList(false);\n\t\t\t\t\t\t\t\t\tlastSelectedChatRef.current = chatId;\n\t\t\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t\t\tnavigate(\"/seller/messages\", {replace: true});\n\t\t\t\t\t\t\t\t\tlastSelectedChatRef.current = null;\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t} catch (error) {\n\t\t\t\t\t\tconsole.error(`Error al cargar chat ${chatId} desde API:`, error);\n\t\t\t\t\t\tnavigate(\"/seller/messages\", {replace: true});\n\t\t\t\t\t\tlastSelectedChatRef.current = null;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t} catch (error) {\n\t\t\t\tconsole.error(`Error al cargar chat ${chatId}:`, error);\n\t\t\t\tnavigate(\"/seller/messages\", {replace: true});\n\t\t\t\tlastSelectedChatRef.current = null;\n\t\t\t} finally {\n\t\t\t\tsetIsLoadingChat(false);\n\t\t\t}\n\t\t},\n\t\t[\n\t\t\tchats,\n\t\t\tfetchChatMessages,\n\t\t\tnavigate,\n\t\t\tsetSelectedChat,\n\t\t\tfetchChats,\n\t\t\tstartMessagesPolling,\n\t\t\tmarkAllAsRead,\n\t\t\tuser?.id,\n\t\t]\n\t);\n\n\t// Manejar cambios en la URL\n\tuseEffect(() => {\n\t\tif (!initialLoadComplete.current || !user?.id) {\n\t\t\treturn;\n\t\t}\n\n\t\tif (isInitialNavRef.current) {\n\t\t\tisInitialNavRef.current = false;\n\t\t\treturn;\n\t\t}\n\n\t\tif (chatIdParam === chatIdRef.current && lastSelectedChatRef.current !== null) {\n\t\t\treturn;\n\t\t}\n\n\t\tstopMessagesPolling();\n\t\tchatIdRef.current = chatIdParam;\n\t\tloadAttempts.current = 0;\n\n\t\tif (chatIdParam) {\n\t\t\tconst chatId = parseInt(chatIdParam, 10);\n\n\t\t\tif (isNaN(chatId)) {\n\t\t\t\tnavigate(\"/seller/messages\", {replace: true});\n\t\t\t\tlastSelectedChatRef.current = null;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (lastSelectedChatRef.current !== chatId) {\n\t\t\t\tmarkAllAsReadCalledRef.current[chatId] = false;\n\t\t\t\tloadSpecificChat(chatId);\n\t\t\t}\n\t\t} else {\n\t\t\tif (lastSelectedChatRef.current !== null) {\n\t\t\t\tsetSelectedChat(null);\n\t\t\t\tlastSelectedChatRef.current = null;\n\t\t\t\tsetShowChatList(true);\n\t\t\t}\n\t\t}\n\t}, [\n\t\tchatIdParam,\n\t\tloadSpecificChat,\n\t\tnavigate,\n\t\tsetSelectedChat,\n\t\tstopMessagesPolling,\n\t\tuser?.id,\n\t]);\n\n\t// Filtrar chats según los criterios - OPTIMIZADO con useMemo\n\tconst filteredChats = React.useMemo(() => {\n\t\treturn chats.filter((chat) => {\n\t\t\tconst matchesStatus = statusFilter === \"all\" || chat.status === statusFilter;\n\t\t\t// Filtro por mensajes no leídos - CORREGIDO como UserChatPage\n\t\t\tconst matchesUnread = unreadFilter ? (chat.unreadCount ?? 0) > 0 : true;\n\n\t\t\t// Búsqueda por nombre de usuario y producto\n\t\t\tconst matchesSearch =\n\t\t\t\tsearchTerm === \"\" ||\n\t\t\t\t(chat.product?.name &&\n\t\t\t\t\tchat.product.name.toLowerCase().includes(searchTerm.toLowerCase())) ||\n\t\t\t\t(chat.user?.name &&\n\t\t\t\t\tchat.user.name.toLowerCase().includes(searchTerm.toLowerCase()));\n\n\t\t\treturn matchesStatus && matchesUnread && matchesSearch;\n\t\t});\n\t}, [chats, statusFilter, unreadFilter, searchTerm]);\n\n\t// Seleccionar un chat\n\tconst handleSelectChat = (chat: Chat) => {\n\t\tif (chat && chat.id) {\n\t\t\tif (lastSelectedChatRef.current === chat.id) {\n\t\t\t\tconsole.log(`Chat ${chat.id} ya está seleccionado, omitiendo selección.`);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconsole.log(`Vendedor seleccionó chat ${chat.id}`);\n\n\t\t\tstopMessagesPolling();\n\n\t\t\tnavigate(`/seller/messages/${chat.id}`, {replace: true});\n\t\t\tchatIdRef.current = String(chat.id);\n\t\t\tlastSelectedChatRef.current = chat.id;\n\n\t\t\tsetSelectedChat(chat);\n\n\t\t\tif (isMobileView) {\n\t\t\t\tsetShowChatList(false);\n\t\t\t}\n\n\t\t\t// Marcar como leído\n\t\t\tif (chat.unreadCount && chat.unreadCount > 0 && !markAllAsReadCalledRef.current[chat.id]) {\n\t\t\t\tmarkAllAsReadCalledRef.current[chat.id] = true;\n\t\t\t\tsetTimeout(() => {\n\t\t\t\t\tif (chat.id !== undefined) {\n\t\t\t\t\t\tmarkAllAsRead(chat.id).catch(console.error);\n\t\t\t\t\t}\n\t\t\t\t}, 1000);\n\t\t\t}\n\t\t}\n\t};\n\n\t// CORREGIDO: Enviar mensaje sin estado local de loading\n\tconst handleSendMessage = async (content: string): Promise<boolean> => {\n\t\tconsole.log(\"Enviando mensaje como vendedor...\");\n\n\t\ttry {\n\t\t\tconst result = await sendMessage(content);\n\t\t\t\n\t\t\tif (result && selectedChat?.id) {\n\t\t\t\t// Recargar mensajes después de enviar exitosamente\n\t\t\t\tawait fetchChatMessages(selectedChat.id);\n\t\t\t}\n\t\t\t\n\t\t\treturn result;\n\t\t} catch (error: any) {\n\t\t\tconsole.error(\"Error al enviar mensaje:\", error);\n\n\t\t\t// Manejar errores específicos del filtro de chat\n\t\t\tif (error?.response?.data?.status === 'error') {\n\t\t\t\tconst errorData = error.response.data;\n\t\t\t\tconst strikeCount = errorData.data?.strike_count || 0;\n\t\t\t\tconst isBlocked = errorData.data?.is_blocked || false;\n\t\t\t\tconst censoredContent = errorData.data?.censored_content;\n\n\t\t\t\tif (isBlocked) {\n\t\t\t\t\t// Cuenta bloqueada\n\t\t\t\t\tshowSellerBlocked(\n\t\t\t\t\t\t\"Tu cuenta ha sido bloqueada por acumular múltiples strikes. Contacta al soporte.\"\n\t\t\t\t\t);\n\t\t\t\t} else {\n\t\t\t\t\t// Strike aplicado\n\t\t\t\t\tshowSellerStrike(\n\t\t\t\t\t\terrorData.message,\n\t\t\t\t\t\tstrikeCount,\n\t\t\t\t\t\tcensoredContent\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\n\t\t\treturn false;\n\t\t}\n\t};\n\n\t// Actualizar estado del chat\n\tconst handleUpdateStatus = async (\n\t\tchatId: number,\n\t\tstatus: \"active\" | \"closed\" | \"archived\"\n\t) => {\n\t\tconsole.log(`Actualizando estado de chat ${chatId} a ${status}...`);\n\t\treturn await updateChatStatus(chatId, status);\n\t};\n\n\t// Volver a la lista en móvil\n\tconst handleBackToList = () => {\n\t\tconsole.log(\"Volviendo a lista de chats\");\n\n\t\tstopMessagesPolling();\n\t\tsetShowChatList(true);\n\t\tnavigate(\"/seller/messages\", {replace: true});\n\t\tchatIdRef.current = undefined;\n\t\tlastSelectedChatRef.current = null;\n\t};\n\n\t// Refrescar lista de chats\n\tconst refreshChats = () => {\n\t\tconsole.log(\"Refrescando lista de chats\");\n\n\t\tif (selectedChat && selectedChat.id) {\n\t\t\tmarkAllAsReadCalledRef.current[selectedChat.id] = false;\n\t\t}\n\n\t\tfetchChats().then(() => {\n\t\t\tconsole.log(\"Lista de chats refrescada\");\n\t\t});\n\t};\n\n\t// Contenido principal a renderizar\n\tconst renderChatContent = () => {\n\t\tif ((loading || isLoadingChat) && !selectedChat) {\n\t\t\treturn (\n\t\t\t\t<div className=\"flex flex-col justify-center items-center h-full\">\n\t\t\t\t\t<div className=\"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4\"></div>\n\t\t\t\t\t<p className=\"text-gray-600\">{loadingMessage}</p>\n\t\t\t\t</div>\n\t\t\t);\n\t\t}\n\n\t\tif (selectedChat) {\n\t\t\treturn (\n\t\t\t\t<>\n\t\t\t\t\t<ChatHeader\n\t\t\t\t\t\tchat={selectedChat}\n\t\t\t\t\t\tisSeller={true}\n\t\t\t\t\t\tonUpdateStatus={handleUpdateStatus}\n\t\t\t\t\t\tloading={loading}\n\t\t\t\t\t/>\n\n\t\t\t\t\t<div className=\"flex-1 overflow-y-auto\">\n\t\t\t\t\t\t<ChatMessages\n\t\t\t\t\t\t\tmessages={messages}\n\t\t\t\t\t\t\tloading={loading}\n\t\t\t\t\t\t\tnoMessagesText=\"No hay mensajes todavía\"\n\t\t\t\t\t\t\tcurrentUserId={user?.id ?? undefined} // ← CORREGIDO: Manejar null como undefined\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\n\t\t\t\t\t<MessageForm\n\t\t\t\t\t\tonSendMessage={handleSendMessage}\n\t\t\t\t\t\tisDisabled={selectedChat.status !== \"active\"}\n\t\t\t\t\t\tdisabledText={\n\t\t\t\t\t\t\tselectedChat.status === \"closed\"\n\t\t\t\t\t\t\t\t? \"Esta conversación está cerrada\"\n\t\t\t\t\t\t\t\t: \"Esta conversación está archivada\"\n\t\t\t\t\t\t}\n\t\t\t\t\t\tisLoading={loading}\n\t\t\t\t\t\tchatId={selectedChat.id} // ← NUEVO: Para indicador de escritura\n\t\t\t\t\t/>\n\t\t\t\t</>\n\t\t\t);\n\t\t}\n\n\t\treturn (\n\t\t\t<div className=\"flex flex-col items-center justify-center h-full p-4 text-center\">\n\t\t\t\t<div className=\"w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4\">\n\t\t\t\t\t<MessageSquare className=\"h-8 w-8 text-gray-500\" />\n\t\t\t\t</div>\n\t\t\t\t<h3 className=\"text-lg font-medium text-gray-900\">\n\t\t\t\t\tSelecciona una conversación\n\t\t\t\t</h3>\n\t\t\t\t<p className=\"text-gray-500 mt-2 max-w-md\">\n\t\t\t\t\t{chats.length > 0\n\t\t\t\t\t\t? \"Elige una conversación de la lista para ver los mensajes y responder a tus clientes\"\n\t\t\t\t\t\t: \"No tienes conversaciones activas. Cuando los clientes inicien conversaciones sobre tus productos, aparecerán aquí.\"}\n\t\t\t\t</p>\n\t\t\t</div>\n\t\t);\n\t};\n\n\treturn (\n\t\t<div className=\"container mx-auto p-6 max-w-7xl\">\n\t\t\t<div className=\"mb-6 flex justify-between items-center\">\n\t\t\t\t<div className=\"flex items-center space-x-3\">\n\t\t\t\t\t<div className=\"h-10 w-10 bg-primary-100 rounded-lg flex items-center justify-center\">\n\t\t\t\t\t\t<MessageSquare className=\"w-5 h-5 text-primary-600\" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<div>\n\t\t\t\t\t\t<h1 className=\"text-2xl font-bold text-gray-900\">Conversaciones con Clientes</h1>\n\t\t\t\t\t\t<p className=\"text-sm text-gray-500\">Gestiona tus chats con compradores</p>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div className=\"flex items-center space-x-3\">\n\t\t\t\t\t{isMobileView && selectedChat && !showChatList && (\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tonClick={handleBackToList}\n\t\t\t\t\t\t\tclassName=\"inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t<ArrowLeft size={16} className=\"mr-2\" />\n\t\t\t\t\t\t\tVolver\n\t\t\t\t\t\t</button>\n\t\t\t\t\t)}\n\t\t\t\t\t<button\n\t\t\t\t\t\tonClick={refreshChats}\n\t\t\t\t\t\tclassName=\"inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors shadow-sm\"\n\t\t\t\t\t\tdisabled={loading || isLoadingChat}\n\t\t\t\t\t>\n\t\t\t\t\t\t<RefreshCw\n\t\t\t\t\t\t\tsize={16}\n\t\t\t\t\t\t\tclassName={`mr-2 ${loading || isLoadingChat ? \"animate-spin\" : \"\"}`}\n\t\t\t\t\t\t/>\n\t\t\t\t\t\tActualizar\n\t\t\t\t\t</button>\n\t\t\t\t</div>\n\t\t\t</div>\n\n\t\t\t{error && (\n\t\t\t\t<div className=\"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg relative mb-6 flex items-start space-x-3\">\n\t\t\t\t\t<div className=\"flex-shrink-0\">\n\t\t\t\t\t\t<svg className=\"h-5 w-5 text-red-500\" viewBox=\"0 0 20 20\" fill=\"currentColor\">\n\t\t\t\t\t\t\t<path fillRule=\"evenodd\" d=\"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z\" clipRule=\"evenodd\" />\n\t\t\t\t\t\t</svg>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div className=\"flex-1\">\n\t\t\t\t\t\t<h3 className=\"text-sm font-medium text-red-800\">Error al cargar conversaciones</h3>\n\t\t\t\t\t\t<p className=\"text-sm text-red-700 mt-1\">{error}</p>\n\t\t\t\t\t\t<button\n\t\t\t\t\t\t\tonClick={refreshChats}\n\t\t\t\t\t\t\tclassName=\"text-sm text-red-700 hover:text-red-900 underline mt-2 inline-block\"\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\tReintentar\n\t\t\t\t\t\t</button>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t)}\n\n\t\t\t<div\n\t\t\t\tclassName=\"bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row overflow-hidden\"\n\t\t\t\tstyle={{minHeight: \"75vh\"}}\n\t\t\t>\n\t\t\t\t{(!isMobileView || showChatList) && (\n\t\t\t\t\t<div className=\"w-full md:w-1/3 border-r border-gray-200 flex flex-col bg-white\">\n\t\t\t\t\t\t<ChatList\n\t\t\t\t\t\t\tchats={filteredChats}\n\t\t\t\t\t\t\tselectedChatId={selectedChat?.id}\n\t\t\t\t\t\t\tonSelectChat={handleSelectChat}\n\t\t\t\t\t\t\tloading={loading || isLoadingChat}\n\t\t\t\t\t\t\tsearchTerm={searchTerm}\n\t\t\t\t\t\t\tonSearchChange={setSearchTerm}\n\t\t\t\t\t\t\tstatusFilter={statusFilter}\n\t\t\t\t\t\t\tonStatusFilterChange={setStatusFilter}\n\t\t\t\t\t\t\tunreadFilter={unreadFilter}\n\t\t\t\t\t\t\tonUnreadFilterChange={setUnreadFilter}\n\t\t\t\t\t\t\tisSeller={true}\n\t\t\t\t\t\t\tshowTabs={true}\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\n\t\t\t\t{(!isMobileView || !showChatList) && (\n\t\t\t\t\t<div className=\"w-full md:w-2/3 flex flex-col\">\n\t\t\t\t\t\t{renderChatContent()}\n\t\t\t\t\t</div>\n\t\t\t\t)}\n\t\t\t</div>\n\n\t\t\t{/* Componente de notificaciones flotantes */}\n\t\t\t<NotificationComponent />\n\t\t</div>\n\t);\n};\n\nexport default SellerMessagesPage;"],"names":["SellerMessagesPage","navigate","useNavigate","chatIdParam","useParams","user","useAuth","searchTerm","setSearchTerm","useState","statusFilter","setStatusFilter","unreadFilter","setUnreadFilter","isMobileView","setIsMobileView","showChatList","setShowChatList","isLoadingChat","setIsLoadingChat","loadingMessage","setLoadingMessage","initialLoadComplete","useRef","chatIdRef","loadAttempts","isInitialNavRef","markAllAsReadCalledRef","lastSelectedChatRef","showSellerStrike","showSellerBlocked","NotificationComponent","useChatFilterNotifications","chats","selectedChat","messages","loading","error","fetchChats","fetchChatMessages","sendMessage","updateChatStatus","setSelectedChat","startMessagesPolling","stopMessagesPolling","markAllAsRead","useChat","useEffect","handleResize","fetchedChats","chatId","chat","c","loadSpecificChat","err","useCallback","updatedChat","filteredChats","React","matchesStatus","matchesUnread","matchesSearch","handleSelectChat","handleSendMessage","content","result","errorData","strikeCount","isBlocked","censoredContent","handleUpdateStatus","status","handleBackToList","refreshChats","renderChatContent","jsxs","jsx","Fragment","ChatHeader","ChatMessages","MessageForm","MessageSquare","ArrowLeft","RefreshCw","ChatList"],"mappings":"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"}