import{c as G,A as Z,g as Ue,C as ae,b as ue,N as k,h as je,i as de,f as B}from"./admin-chunk-C7Ad4l4I.js";import{j as e,D as Le,ah as Fe,H as he,a as De,e as Ie,N as Ve,ai as Me,aj as qe,ak as Be,al as Ge,R as me,am as He,an as ge,T as We,a3 as Ee}from"./ui-vendor-DEBjJ4HS.js";import{r as g,R as se,u as Ae}from"./react-vendor-Cy458wKG.js";import{A as ze,L as Je}from"./seller-chunk-CL4v7LiS.js";import{u as ye}from"./chat-chunk-dxmpBB-S.js";class Qe{async getCart(){try{console.log("CartService: Obteniendo carrito del usuario");const t=await G.get(Z.CART.GET);return console.log("CartService: Respuesta del carrito:",t),t}catch(t){return console.error("CartService: Error al obtener carrito:",t),{status:"error",message:t instanceof Error?t.message:"Error al obtener carrito",data:{id:0,total:0,items:[],item_count:0}}}}async addToCart(t){try{console.log("CartService: A√±adiendo producto al carrito:",t);const s={product_id:t.productId,quantity:t.quantity,attributes:t.attributes},a=await G.post(Z.CART.ADD_ITEM,s);return console.log("CartService: Producto a√±adido al carrito:",a),a}catch(s){throw console.error("CartService: Error al a√±adir al carrito:",s),s}}async removeFromCart(t){try{console.log(`CartService: Eliminando producto ${t} del carrito`);const s=await G.delete(Z.CART.REMOVE_ITEM(t));return console.log(`CartService: Producto ${t} eliminado del carrito:`,s),s}catch(s){throw console.error(`CartService: Error al eliminar producto ${t} del carrito:`,s),s}}async updateCartItem(t,s){try{console.log(`CartService: Actualizando cantidad de producto ${t} a ${s}`);const a=await G.put(Z.CART.UPDATE_ITEM(t),{quantity:s});return console.log(`CartService: Cantidad actualizada para producto ${t}:`,a),a}catch(a){throw console.error(`CartService: Error al actualizar cantidad de producto ${t}:`,a),a}}async clearCart(){try{console.log("CartService: Vaciando carrito");const t=await G.post(Z.CART.EMPTY);return console.log("CartService: Carrito vaciado:",t),t}catch(t){throw console.error("CartService: Error al vaciar carrito:",t),t}}async validateDiscountCode(t){try{console.log("CartService: Validando c√≥digo de descuento:",t);const s=await G.post(Z.CART.DISCOUNT.VALIDATE,{code:t});return console.log("CartService: C√≥digo de descuento validado:",s),s}catch(s){throw console.error("CartService: Error al validar c√≥digo de descuento:",s),s}}async applyDiscountCode(t){try{console.log("CartService: Aplicando c√≥digo de descuento:",t);const s=await G.post(Z.CART.DISCOUNT.APPLY,{code:t});return console.log("CartService: C√≥digo de descuento aplicado:",s),s}catch(s){throw console.error("CartService: Error al aplicar c√≥digo de descuento:",s),s}}async removeDiscountCode(){try{console.log("CartService: Removiendo c√≥digo de descuento");const t=await G.post(Z.CART.DISCOUNT.REMOVE);return console.log("CartService: C√≥digo de descuento removido:",t),t}catch(t){throw console.error("CartService: Error al remover c√≥digo de descuento:",t),t}}}const Re=g.createContext({cart:null,loading:!1,error:null,addToCart:async()=>!1,removeFromCart:async()=>!1,updateCartItem:async()=>!1,clearCart:async()=>!1,fetchCart:async()=>{},itemCount:0,totalAmount:0,showNotification:()=>{},cartItemCount:0,appliedDiscount:null,validateDiscountCode:async()=>({success:!1,message:"Not implemented"}),applyDiscountCode:async()=>({success:!1,message:"Not implemented"}),removeDiscountCode:async()=>({success:!1,message:"Not implemented"})}),pe=new Je,ce=new Qe,fe={CART_USER:"cart_user_data",CART_GUEST:"cart_guest_data"},Ke={CART:3*60*1e3},ft=({children:u})=>{const[t,s]=g.useState(null),[a,o]=g.useState(!1),[r,c]=g.useState(null),[d,y]=g.useState(0),[b,x]=g.useState(0),[I,E]=g.useState(null),{isAuthenticated:j}=g.useContext(ze),{showToast:N}=Ue(),M=g.useRef(!1),D=g.useRef(""),$=g.useRef(j),R=g.useRef(null),z=g.useRef(!1),J=g.useRef(null);g.useEffect(()=>{$.current=j},[j]);const q=g.useCallback((l,n)=>{N(l,n,{duration:3e3})},[N]);g.useEffect(()=>()=>{R.current&&clearTimeout(R.current),J.current&&clearTimeout(J.current)},[]);const _=g.useCallback(()=>{ae.removeItem(fe.CART_USER),ae.removeItem(fe.CART_GUEST),ae.removeItem("header_counters"),console.log("üóëÔ∏è Cart cache invalidated")},[]),Q=g.useCallback(l=>!l||l.length===0?0:l.reduce((n,v)=>n+v.quantity,0),[]),X=g.useCallback(async()=>{if(z.current)return null;z.current=!0;try{o(!0),c(null);const l=$.current?fe.CART_USER:fe.CART_GUEST,n=ae.getItem(l);if(n)return console.log("üì¶ Using cached cart data"),s(n),y(n.items?n.items.length:0),x(n.total||0),D.current=JSON.stringify(n),o(!1),z.current=!1,n;console.log("üåê Fetching cart from API...");const v=await ce.getCart();if(v&&v.status==="success"&&v.data){const w={id:v.data.id,total:v.data.total,items:v.data.items.map(F=>{if(!F.product)throw console.error("Item sin producto asociado:",F),new Error("Error en carrito: item sin producto v√°lido");const f=F.product;if(!f.id||f.id<=0)throw console.error("Producto sin ID v√°lido:",f),new Error("Error en carrito: producto sin ID v√°lido");if(!f.name||f.name.trim()==="")throw console.error("Producto sin nombre:",f),new Error("Error en carrito: producto sin nombre");if(typeof f.price!="number"||f.price<=0)throw console.error("Producto sin precio v√°lido:",f),new Error("Error en carrito: producto sin precio v√°lido");const le=f.sellerId||f.seller_id||(f.seller?f.seller.id:void 0)||f.user_id;if(!le||le<=0)throw console.error("Producto sin seller v√°lido:",f),new Error("Error en carrito: producto sin vendedor v√°lido");return{id:F.id,productId:f.id,quantity:F.quantity,price:F.price,subtotal:F.subtotal,attributes:F.attributes,final_price:F.final_price||F.price,original_price:F.original_price||F.price,volume_discount_percentage:F.volume_discount_percentage||0,volume_savings:F.volume_savings||0,discount_label:F.discount_label||void 0,product:{id:f.id,name:f.name,slug:f.slug,price:f.price,final_price:f.final_price??f.price??0,discount_percentage:f.discount_percentage??0,rating:f.rating??0,rating_count:f.rating_count??0,image:f.main_image||f.image||(f.images&&f.images.length>0?typeof f.images[0]=="string"?f.images[0]:f.images[0].original||f.images[0].medium||f.images[0].thumbnail:void 0),main_image:f.main_image||f.image||(f.images&&f.images.length>0?typeof f.images[0]=="string"?f.images[0]:f.images[0].original||f.images[0].medium||f.images[0].thumbnail:void 0),stockAvailable:f.stock||0,sellerId:f.sellerId||f.seller_id||(f.seller?f.seller.id:void 0)||f.user_id,seller_id:f.seller_id||f.sellerId||(f.seller?f.seller.id:void 0)||f.user_id,seller:f.seller,user_id:f.user_id,stock:f.stock||0,is_in_stock:f.is_in_stock??!0}}}),item_count:v.data.item_count||0,subtotal:v.data.subtotal||v.data.total,total_volume_savings:v.data.total_volume_savings||0,volume_discounts_applied:v.data.volume_discounts_applied||!1};ae.setItem(l,w,Ke.CART);const V=Q(w.items),W=v.data.item_count||V;return s(w),y(W),x(w.total),D.current=JSON.stringify(w),console.log("‚úÖ Cart loaded successfully:",{itemCount:W,total:w.total,items:w.items.length,volume_discounts_applied:w.volume_discounts_applied}),w}throw new Error("Formato de respuesta de carrito inv√°lido")}catch(l){console.error("Error al obtener carrito desde la API:",l),c(l instanceof Error?l.message:"Error al obtener carrito");const n=pe.getItem(ue.storage.cartKey);if(n)try{const v=typeof n=="string"?JSON.parse(n):n;s(v),D.current=JSON.stringify(v);const w=Q(v.items||[]);y(w),x(v.total||0)}catch(v){console.error("Error al usar cach√© local del carrito:",v)}return null}finally{o(!1),z.current=!1}},[Q]),U=g.useCallback(async()=>{R.current&&clearTimeout(R.current),R.current=setTimeout(async()=>{if($.current)await X();else{const l=pe.getItem(ue.storage.cartKey);if(l)try{const n=typeof l=="string"?JSON.parse(l):l;s(n),D.current=JSON.stringify(n);const v=Q(n.items||[]);y(v),x(n.total||0)}catch(n){console.error("Error al parsear carrito del localStorage:",n)}else s({id:0,items:[],total:0}),y(0),x(0)}R.current=null},100)},[X,Q]);g.useEffect(()=>{M.current=!0},[j]),g.useEffect(()=>{if(!t){y(0),x(0);return}J.current&&clearTimeout(J.current),J.current=setTimeout(()=>{const l=t.items?t.items.length:0;d!==l&&y(l),b!==t.total&&x(t.total);const n=JSON.stringify(t);!$.current&&n!==D.current&&(pe.setItem(ue.storage.cartKey,n),D.current=n),J.current=null},100)},[t,Q,d,b]);const Y=g.useCallback(async l=>{try{if(!t)return!1;const n=t.items.findIndex(w=>w.productId===l.productId);let v;if(n>=0){const w=[...t.items];w[n].quantity+=l.quantity,w[n].subtotal=w[n].price*w[n].quantity;const V=w.reduce((W,F)=>W+F.subtotal,0);v={...t,items:w,total:V}}else{const V={id:Date.now(),productId:l.productId,quantity:l.quantity,price:0,subtotal:0*l.quantity},W=[...t.items,V],F=W.reduce((f,le)=>f+le.subtotal,0);v={...t,items:W,total:F}}return s(v),D.current=JSON.stringify(v),!0}catch(n){return console.error("Error al a√±adir producto al carrito:",n),!1}},[t]),re=g.useCallback(async l=>{if(!$.current){const n=await Y(l);return await U(),n}try{o(!0);const n=await ce.addToCart(l);if(n&&n.status==="success")return _(),await U(),!0;throw new Error(n?.message||"No se pudo agregar al carrito")}catch(n){return console.error("Error al agregar producto al carrito:",n),c(n instanceof Error?n.message:"Error al agregar producto al carrito"),!1}finally{o(!1)}},[Y,U,_]),ne=g.useCallback(async l=>{try{if(!t)return!1;const n=t.items.filter(V=>V.id!==l),v=n.reduce((V,W)=>V+W.subtotal,0),w={...t,items:n,total:v};return s(w),D.current=JSON.stringify(w),!0}catch(n){return console.error("Error al eliminar producto del carrito:",n),!1}},[t]),oe=g.useCallback(async l=>{if(!$.current){const n=await ne(l);return await U(),n}try{o(!0);const n=await ce.removeFromCart(l);if(n&&n.status==="success")return _(),await U(),!0;throw new Error(n?.message||"No se pudo eliminar del carrito")}catch(n){return console.error("Error al eliminar producto del carrito:",n),c(n instanceof Error?n.message:"Error al eliminar producto del carrito"),!1}finally{o(!1)}},[ne,U,_]),h=g.useCallback(async l=>{try{if(!t)return!1;const n=t.items.map(V=>V.id===l.itemId?{...V,quantity:l.quantity,subtotal:V.price*l.quantity}:V),v=n.reduce((V,W)=>V+W.subtotal,0),w={...t,items:n,total:v};return s(w),D.current=JSON.stringify(w),!0}catch(n){return console.error("Error al actualizar producto del carrito:",n),!1}},[t]),S=g.useCallback(async l=>{if(!$.current){const n=await h(l);return await U(),n}try{o(!0);const n=await ce.updateCartItem(l.itemId,l.quantity);if(n&&n.status==="success")return _(),await U(),!0;throw new Error(n?.message||"No se pudo actualizar el carrito")}catch(n){return console.error("Error al actualizar producto del carrito:",n),c(n instanceof Error?n.message:"Error al actualizar producto del carrito"),!1}finally{o(!1)}},[h,U,_]),T=g.useCallback(async()=>{try{if(!t)return!1;const l={id:t.id,items:[],total:0};return s(l),D.current=JSON.stringify(l),pe.setItem(ue.storage.cartKey,JSON.stringify(l)),!0}catch(l){return console.error("Error al vaciar carrito:",l),!1}},[t]),H=g.useCallback(async()=>{if(!$.current){const l=await T();return await U(),l}try{o(!0);const l=await ce.clearCart();if(l&&l.status==="success")return _(),await U(),!0;throw new Error(l?.message||"No se pudo vaciar el carrito")}catch(l){return console.error("Error al vaciar carrito:",l),c(l instanceof Error?l.message:"Error al vaciar carrito"),!1}finally{o(!1)}},[T,U,_]),p=g.useCallback(async l=>{try{o(!0);const n=await ce.validateDiscountCode(l);return n&&n.status==="success"?{success:!0,message:n.message||"C√≥digo v√°lido",data:n.data}:{success:!1,message:n?.message||"C√≥digo de descuento inv√°lido"}}catch(n){return console.error("Error validating discount code:",n),{success:!1,message:n.response?.data?.message||n.message||"Error al validar c√≥digo de descuento"}}finally{o(!1)}},[]),i=g.useCallback(async l=>{try{o(!0);const n=await ce.applyDiscountCode(l);return n&&n.status==="success"?(n.data?.cart&&(s(n.data.cart),D.current=JSON.stringify(n.data.cart)),n.data?.discount_code&&E({discountCode:n.data.discount_code,appliedAt:new Date}),_(),{success:!0,message:n.message||"Descuento aplicado exitosamente",cart:n.data?.cart}):{success:!1,message:n?.message||"No se pudo aplicar el c√≥digo de descuento"}}catch(n){return console.error("Error applying discount code:",n),{success:!1,message:n.response?.data?.message||n.message||"Error al aplicar c√≥digo de descuento"}}finally{o(!1)}},[_]),A=g.useCallback(async()=>{try{o(!0);const l=await ce.removeDiscountCode();return l&&l.status==="success"?(l.data?.cart&&(s(l.data.cart),D.current=JSON.stringify(l.data.cart)),E(null),_(),{success:!0,message:l.message||"Descuento removido exitosamente",cart:l.data?.cart}):{success:!1,message:l?.message||"No se pudo remover el c√≥digo de descuento"}}catch(l){return console.error("Error removing discount code:",l),{success:!1,message:l.response?.data?.message||l.message||"Error al remover c√≥digo de descuento"}}finally{o(!1)}},[_]);return e.jsx(Re.Provider,{value:{cart:t,loading:a,error:r,addToCart:re,removeFromCart:oe,updateCartItem:S,clearCart:H,fetchCart:U,itemCount:d,totalAmount:b,showNotification:q,cartItemCount:d,appliedDiscount:I,validateDiscountCode:p,applyDiscountCode:i,removeDiscountCode:A},children:u})};class ie{static instance;subscribers=new Set;currentCounters={cartItemCount:0,favoriteCount:0,notificationCount:0};isLoading=!1;error=null;lastFetch=0;CACHE_KEY="header_counters";CACHE_TIME=2*60*1e3;MIN_FETCH_INTERVAL=30*1e3;static getInstance(){return ie.instance||(ie.instance=new ie),ie.instance}subscribe(t){return this.subscribers.add(t),t(this.currentCounters),()=>this.subscribers.delete(t)}notify(){this.subscribers.forEach(t=>t(this.currentCounters))}async fetchCounters(t=!1){const s=Date.now();if(!(!t&&s-this.lastFetch<this.MIN_FETCH_INTERVAL)){if(!t){const a=ae.getItem(this.CACHE_KEY);if(a){this.currentCounters=a,this.notify();return}}if(!this.isLoading){this.isLoading=!0,this.error=null,this.notify();try{const a=await G.get(Z.HEADER_COUNTERS);let o=0,r=0,c=0;a?.data&&(o=a.data.cart_count||0,r=a.data.favorites_count||0,c=a.data.notifications_count||0),this.currentCounters={cartItemCount:o,favoriteCount:r,notificationCount:c},this.lastFetch=s,ae.setItem(this.CACHE_KEY,this.currentCounters,this.CACHE_TIME)}catch(a){this.error=a instanceof Error?a.message:"Error al cargar contadores",this.currentCounters={cartItemCount:0,favoriteCount:0,notificationCount:0}}finally{this.isLoading=!1,this.notify()}}}}invalidateCache(){ae.removeItem(this.CACHE_KEY),this.lastFetch=0}getState(){return{counters:this.currentCounters,loading:this.isLoading,error:this.error}}updateCounter(t,s){this.currentCounters={...this.currentCounters,[t]:Math.max(0,s)},ae.setItem(this.CACHE_KEY,this.currentCounters,this.CACHE_TIME),this.notify()}incrementCart(){this.updateCounter("cartItemCount",this.currentCounters.cartItemCount+1)}decrementCart(){this.updateCounter("cartItemCount",this.currentCounters.cartItemCount-1)}incrementFavorites(){this.updateCounter("favoriteCount",this.currentCounters.favoriteCount+1)}decrementFavorites(){this.updateCounter("favoriteCount",this.currentCounters.favoriteCount-1)}markNotificationAsRead(){this.updateCounter("notificationCount",this.currentCounters.notificationCount-1)}}const ht=()=>{const[u,t]=g.useState(()=>ie.getInstance().getState()),{isAuthenticated:s}=ye(),a=g.useRef(ie.getInstance());g.useEffect(()=>{if(!s){t({counters:{cartItemCount:0,favoriteCount:0,notificationCount:0},loading:!1,error:null});return}const r=a.current,c=r.subscribe(d=>{t({counters:d,loading:r.getState().loading,error:r.getState().error})});return r.fetchCounters(),c},[s]);const o=g.useCallback(async()=>{s&&await a.current.fetchCounters(!0)},[s]);return{counters:u.counters,loading:u.loading,error:u.error,refetch:o}},Ye=()=>{const u=g.useRef(ie.getInstance());return{invalidateCounters:()=>u.current.invalidateCache(),optimisticCartAdd:()=>u.current.incrementCart(),optimisticCartRemove:()=>u.current.decrementCart(),optimisticFavoriteAdd:()=>u.current.incrementFavorites(),optimisticFavoriteRemove:()=>u.current.decrementFavorites(),optimisticNotificationRead:()=>u.current.markNotificationAsRead(),forceRefresh:()=>u.current.fetchCounters(!0)}},_e=()=>{const u=g.useContext(Re);if(!u)throw new Error("useCart debe usarse dentro de un CartProvider");return u};class Xe{static extractUserMessage(t){if(t?.response?.data){const s=t.response.data;if(s.message)return this.translateErrorMessage(s.message);if(s.errors&&Array.isArray(s.errors))return s.errors.map(a=>a.message||a).join(", ");if(s.error)return this.translateErrorMessage(s.error)}return t?.message?this.translateErrorMessage(t.message):typeof t=="string"?this.translateErrorMessage(t):t?.code==="NETWORK_ERROR"||t?.message?.includes("Network Error")?"Error de conexi√≥n. Verifica tu conexi√≥n a internet.":t?.code==="ECONNABORTED"||t?.message?.includes("timeout")?"La solicitud tard√≥ demasiado. Int√©ntalo de nuevo.":"Ha ocurrido un error inesperado. Int√©ntalo de nuevo."}static translateErrorMessage(t){const s={"Stock insuficiente":"No hay suficiente stock disponible. Reduce la cantidad.","Insufficient stock":"No hay suficiente stock disponible. Reduce la cantidad.","Out of stock":"Producto agotado. No hay unidades disponibles.","No hay suficiente stock":"No hay suficiente stock disponible. Reduce la cantidad.","Producto agotado":"Producto agotado. No hay unidades disponibles.",Unauthorized:"Debes iniciar sesi√≥n para realizar esta acci√≥n.","Token expired":"Tu sesi√≥n ha expirado. Inicia sesi√≥n nuevamente.","Invalid credentials":"Credenciales incorrectas. Verifica tu email y contrase√±a.","Validation failed":"Los datos ingresados no son v√°lidos.","Required field missing":"Faltan campos obligatorios.","Invalid email format":"El formato del email no es v√°lido.","Password too weak":"La contrase√±a debe ser m√°s segura.","Product not found":"El producto no fue encontrado.","Product unavailable":"El producto no est√° disponible temporalmente.","Price changed":"El precio del producto ha cambiado. Actualiza la p√°gina.","Cart empty":"Tu carrito est√° vac√≠o.","Cart item not found":"El producto no se encuentra en tu carrito.","Cannot update cart":"No se pudo actualizar el carrito. Int√©ntalo de nuevo.","Payment failed":"El pago no pudo ser procesado. Verifica tus datos.","Invalid payment method":"M√©todo de pago no v√°lido.","Insufficient funds":"Fondos insuficientes en tu cuenta.","Invalid shipping address":"La direcci√≥n de env√≠o no es v√°lida.","Shipping not available":"Env√≠o no disponible para tu ubicaci√≥n.","Server error":"Error del servidor. Int√©ntalo m√°s tarde.","Service unavailable":"Servicio temporalmente no disponible.","Rate limit exceeded":"Has realizado demasiadas solicitudes. Espera un momento."};if(s[t])return s[t];const a=t.toLowerCase();return a.includes("stock")||a.includes("existencia")?"Problema con el stock del producto. Verifica la disponibilidad.":a.includes("payment")||a.includes("pago")?"Error en el procesamiento del pago. Verifica tus datos.":a.includes("network")||a.includes("connection")||a.includes("conexi√≥n")?"Error de conexi√≥n. Verifica tu conexi√≥n a internet.":a.includes("timeout")||a.includes("tiempo")?"La operaci√≥n tard√≥ demasiado. Int√©ntalo de nuevo.":a.includes("cantidad")||a.includes("disponible")?"Cantidad solicitada no disponible. Verifica el stock.":t}static getNotificationType(t){const a=(t?.response?.data?.message||t?.message||"").toLowerCase();return a.includes("stock")||a.includes("existencia")||a.includes("cantidad")||a.includes("validation")||a.includes("required")?k.WARNING:a.includes("unauthorized")||a.includes("token")||a.includes("login")||a.includes("sesi√≥n")?k.INFO:k.ERROR}static handleApiError(t,s){const a=this.extractUserMessage(t),o=this.getNotificationType(t),r=this.shouldRetry(t);return console.error(`Error${s?` in ${s}`:""}:`,{originalError:t,userMessage:a,type:o,shouldRetry:r}),{message:a,type:o,shouldRetry:r}}static shouldRetry(t){if(t?.code==="NETWORK_ERROR"||t?.code==="ECONNABORTED"||t?.message?.includes("timeout")||t?.message?.includes("Network Error")||t?.response?.status>=500)return!0;if(t?.response?.status>=400&&t?.response?.status<500)return[408,429].includes(t.response.status);const s=t?.response?.data?.message||t?.message||"";return s.toLowerCase().includes("stock")||s.toLowerCase().includes("existencia")||s.toLowerCase().includes("cantidad"),!1}static handleStockError(t,s){return{message:`Solo hay ${t} unidad${t!==1?"es":""} disponible${t!==1?"s":""} en stock. Solicitaste ${s}.`,type:k.WARNING,shouldRetry:!1}}static handleValidationError(t){const s=Object.values(t).flat();return{message:s.length>0?s.join(". "):"Error de validaci√≥n",type:k.WARNING,shouldRetry:!1}}}const Ze=({showNotification:u,context:t})=>{const s=g.useCallback((r,c)=>{const d=Xe.handleApiError(r,t),y=c||d.message;return u(d.type,y),d.shouldRetry},[u,t]),a=g.useCallback(r=>{u(k.SUCCESS,r)},[u]),o=g.useCallback((r,c)=>{const d=`Solo hay ${r} unidad${r!==1?"es":""} disponible${r!==1?"s":""} en stock. Solicitaste ${c}.`;u(k.WARNING,d)},[u]);return{handleError:s,handleSuccess:a,handleStockError:o}},et=je.getInstance(),ve=[{quantity:3,discount:5,label:"3+"},{quantity:6,discount:10,label:"6+"},{quantity:12,discount:15,label:"12+"}];function tt(u,t,s){const a=ve;let o=null;for(const y of a)if(t>=y.quantity)o=y;else break;if(!o)return{originalPrice:u,discountedPrice:u,discountPercentage:0,savings:0,savingsTotal:0,hasDiscount:!1,tierLabel:null};const r=u*(1-o.discount/100),c=u-r,d=c*t;return{originalPrice:u,discountedPrice:r,discountPercentage:o.discount,savings:c,savingsTotal:d,hasDiscount:!0,tierLabel:o.label}}async function st(u,t,s){let a=s;if(!a)try{const b=await et.getUnifiedConfig();b.config.volume_discounts&&Array.isArray(b.config.volume_discounts)&&b.config.volume_discounts.length>0&&(a=b.config.volume_discounts)}catch(b){console.warn("Error obteniendo configuraci√≥n de descuentos, usando defaults:",b),a=ve}(!a||a.length===0)&&(a=ve);let o=null;const r=[...a].sort((b,x)=>b.quantity-x.quantity);for(const b of r)if(t>=b.quantity)o=b;else break;if(!o)return{originalPrice:u,discountedPrice:u,discountPercentage:0,savings:0,savingsTotal:0,hasDiscount:!1,tierLabel:null};const c=u*(1-o.discount/100),d=u-c,y=d*t;return{originalPrice:u,discountedPrice:c,discountPercentage:o.discount,savings:d,savingsTotal:y,hasDiscount:!0,tierLabel:o.label}}function yt(u){const t=u.product?.price||u.price||0,s=u.product?.discount_percentage||0,a=u.quantity||1,o=t*(s/100),r=t-o,c=tt(r,a),d=c.discountedPrice,y=o*a,b=c.savingsTotal,x=y+b,I=c.hasDiscount,E=I?c.discountPercentage:s;return{originalPrice:t,discountedPrice:d,discountPercentage:E,savings:t-d,savingsTotal:x,hasDiscount:s>0||I,sellerDiscountAmount:o,volumeDiscountAmount:c.savings,finalPricePerUnit:d}}async function ot(u,t){const s=u.product?.price||u.price||0,a=u.product?.discount_percentage||0,o=u.quantity||1,r=s*(a/100),c=s-r,d=await st(c,o,t),y=d.discountedPrice,b=r*o,x=d.savingsTotal,I=b+x,E=d.hasDiscount,j=E?d.discountPercentage:a;return{originalPrice:s,discountedPrice:y,discountPercentage:j,savings:s-y,savingsTotal:I,hasDiscount:a>0||E,sellerDiscountAmount:r,volumeDiscountAmount:d.savings,finalPricePerUnit:y}}class be{static configManager=je.getInstance();static async calculateTotals(t,s,a=!1){console.log("üßÆ JORDAN CALCULADORA - INICIANDO CON CONFIGURACI√ìN UNIFICADA",{forceRefresh:a,itemsCount:t.length});const o=await this.configManager.getUnifiedConfig(a),r=o.config;console.log("‚úÖ JORDAN - Configuraci√≥n obtenida:",{source:o.source,isStale:o.is_stale,taxRate:r.tax_rate,commissionRate:r.platform_commission_rate,shippingCost:r.shipping.default_cost,volumeTiers:r.volume_discounts.length});const c=this.calculateOriginalSubtotal(t);console.log(`1Ô∏è‚É£ Subtotal original: $${c.toFixed(2)}`);const{subtotal:d,totalDiscount:y}=this.calculateSellerDiscounts(t,c);console.log(`2Ô∏è‚É£ Despu√©s descuento vendedor: $${d.toFixed(2)}`);const{subtotal:b,totalDiscount:x}=this.calculateVolumeDiscounts(t,d,r.volume_discounts);console.log(`3Ô∏è‚É£ Despu√©s descuento volumen: $${b.toFixed(2)}`);const{subtotal:I,discount:E}=this.calculateCouponDiscount(b,s);console.log(`4Ô∏è‚É£ Despu√©s cup√≥n: $${I.toFixed(2)}`);const j=this.calculateShipping(I,r.shipping),N=I+j;console.log(`5Ô∏è‚É£ Con env√≠o: $${N.toFixed(2)} (env√≠o: $${j.toFixed(2)})`);const M=N*r.tax_rate;console.log(`6Ô∏è‚É£ IVA calculado: $${M.toFixed(2)} (${(r.tax_rate*100).toFixed(1)}%)`);const D=N+M;console.log(`7Ô∏è‚É£ TOTAL FINAL: $${D.toFixed(2)}`);const $=y+x+E,R=x>0,z=j===0;return console.log("üìä JORDAN - RESUMEN CON CONFIGURACI√ìN UNIFICADA:"),console.log(`   üí∞ Configuraci√≥n: ${o.source} (${r.version})`),console.log(`   üí∞ Tax rate: ${(r.tax_rate*100).toFixed(1)}% (din√°mico)`),console.log(`   üí∞ Volume tiers: ${r.volume_discounts.length} configurados`),console.log(`   üí∞ Shipping: $${r.shipping.default_cost} (umbral: $${r.shipping.free_threshold})`),{step1_originalSubtotal:c,step2_afterSellerDiscount:d,step3_afterVolumeDiscount:b,step4_afterCoupon:I,step5_withShipping:N,step6_tax:M,step7_finalTotal:D,sellerDiscounts:y,volumeDiscounts:x,couponDiscount:E,totalDiscounts:$,shipping:j,freeShipping:z,volumeDiscountsApplied:R,configMetadata:{source:o.source,version:r.version,isStale:o.is_stale,warnings:o.warnings},originalSubtotal:c,subtotalAfterSellerDiscount:d,subtotalAfterVolumeDiscount:b,subtotalAfterCoupon:I,subtotalWithShipping:N,tax:M,total:D}}static calculateOriginalSubtotal(t){let s=0;return t.forEach(a=>{const o=this.getBasePrice(a),r=a.quantity||0,c=o*r;console.log(`üì¶ Item: precio base $${o} √ó ${r} = $${c}`),s+=c}),s}static calculateSellerDiscounts(t,s){let a=0,o=0;return t.forEach(r=>{const c=this.getBasePrice(r),d=r.quantity||0,y=this.getSellerDiscountPercentage(r),b=c*(y/100),x=c-b,I=b*d,E=x*d;a+=I,o+=E,console.log(`üè™ Seller discount: ${y}% sobre $${c} = descuento $${b}/unidad`)}),{subtotal:o,totalDiscount:a}}static calculateVolumeDiscounts(t,s,a){let o=0,r=0;return t.forEach(c=>{const d=c.quantity||0,y=this.getVolumeDiscountPercentage(d,a);if(y>0){const b=this.getPriceAfterSellerDiscount(c),x=b*y,I=b-x,E=x*d,j=I*d;o+=E,r+=j,console.log(`üì¶ Volume discount: ${(y*100).toFixed(1)}% sobre $${b} = descuento $${x}/unidad`)}else{const b=this.getPriceAfterSellerDiscount(c);r+=b*d}}),{subtotal:r,totalDiscount:o}}static calculateCouponDiscount(t,s){if(!s?.discountCode)return{subtotal:t,discount:0};let a=0;const o=s.discountCode;if(o.discount_percentage){const r=parseFloat(o.discount_percentage);a=t*(r/100)}else o.percentage?a=t*(o.percentage/100):o.value&&(a=Math.min(o.value,t));return console.log(`üé´ Cup√≥n ${o.code}: ${o.discount_percentage||o.percentage||o.value}% = descuento $${a.toFixed(2)}`),{subtotal:t-a,discount:a}}static calculateShipping(t,s){return s.enabled?t>=s.free_threshold?0:s.default_cost:0}static getBasePrice(t){return t.base_price!==void 0?t.base_price:t.product?.price!==void 0?t.product.price:t.price!==void 0&&t.final_price===void 0?t.price:2}static getSellerDiscountPercentage(t){return t.product?.discount_percentage!==void 0?t.product.discount_percentage:50}static getPriceAfterSellerDiscount(t){const s=this.getBasePrice(t),a=this.getSellerDiscountPercentage(t);return s*(1-a/100)}static getVolumeDiscountPercentage(t,s){const a=[...s].sort((o,r)=>r.quantity-o.quantity);for(const o of a)if(t>=o.quantity)return o.discount/100;return 0}static roundForDisplay(t){return parseFloat(t.toFixed(2))}static async prepareCheckoutData(t,s,a=!1){const o=await this.calculateTotals(t,s,a),c=(await this.configManager.getUnifiedConfig(a)).config;return{items:t.map(y=>{const b=this.getBasePrice(y),x=this.getSellerDiscountPercentage(y),I=this.getVolumeDiscountPercentage(y.quantity||0,c.volume_discounts),E=b*(1-x/100),j=I>0?E*(1-I):E;return{product_id:y.product_id||y.product?.id||y.productId,quantity:y.quantity,price:j,base_price:b,original_price:b,final_price:j,volume_discount_percentage:I*100,volume_savings:(E-j)*(y.quantity||0),seller_discount_amount:(b-E)*(y.quantity||0)}}),totals:o}}}class Ne{static async prepareItemsForCheckout(t,s=null,a=!1){console.log("üõí JORDAN CheckoutItemsService - Preparando items con configuraci√≥n unificada",{forceRefresh:a}),console.log("üé´ Cup√≥n para items:",s?.discountCode?.code||"NINGUNO");const{items:o}=await be.prepareCheckoutData(t,s,a);return o.map((c,d)=>(console.log(`‚úÖ Item ${d+1} preparado para checkout:`,{product_id:c.product_id,quantity:c.quantity,price:c.price,base_price:c.base_price,final_price:c.final_price}),c))}static async calculateCheckoutTotals(t,s=null,a=!1){console.log("üîç JORDAN - FLUJO CHECKOUT MIGRADO CON CONFIGURACI√ìN UNIFICADA:",{forceRefresh:a});const o=await be.calculateTotals(t,s,a);return console.log("üìä PASO A PASO:"),console.log(`   1Ô∏è‚É£ Subtotal original (sin descuentos): ${o.step1_originalSubtotal}`),console.log(`   2Ô∏è‚É£ Despu√©s de seller + volume: ${o.step3_afterVolumeDiscount} ‚úÖ DEBE SER $2.85`),console.log(`   3Ô∏è‚É£ - Cup√≥n 5% sobre subtotal: ${o.couponDiscount} -> Subtotal: ${o.step4_afterCoupon}`),console.log(`   4Ô∏è‚É£ + Env√≠o: ${o.step5_withShipping}`),console.log(`   5Ô∏è‚É£ + IVA 15% sobre ${o.step5_withShipping} : ${o.step6_tax}`),console.log(`   6Ô∏è‚É£ TOTAL FINAL: ${o.step7_finalTotal} ‚úÖ DEBE SER $8.87`),console.log("üí∞ DESGLOSE COMPLETO:"),console.log(`   - Descuentos seller: ${o.sellerDiscounts}`),console.log(`   - Descuentos volume: ${o.volumeDiscounts}`),console.log(`   - Descuento cup√≥n: ${o.couponDiscount}`),console.log(`   - Total descuentos: ${o.totalDiscounts}`),console.log(`   - Env√≠o: ${o.shipping}`),console.log(`   - IVA (15%): ${o.tax}`),console.log(`üéØ VALOR CORRECTO PARA BACKEND: ${o.total}`),{subtotal:o.step3_afterVolumeDiscount,originalSubtotal:o.originalSubtotal,sellerDiscounts:o.sellerDiscounts,volumeDiscounts:o.volumeDiscounts,totalDiscounts:o.totalDiscounts,couponDiscount:o.couponDiscount,tax:o.tax,shipping:o.shipping,total:o.total,freeShipping:o.freeShipping}}static validateItemsForCheckout(t){const s=[];console.log(`üîç Validando ${t.length} items para checkout:`),t.forEach((o,r)=>{if(console.log(`üìã Validando Item ${r+1}:`,{product_id:o.product_id,product_id_type:typeof o.product_id,quantity:o.quantity,quantity_type:typeof o.quantity,price:o.price,price_type:typeof o.price}),!o.product_id||typeof o.product_id!="number"||isNaN(o.product_id)||o.product_id<=0){const c=`Item ${r+1}: product_id inv√°lido (${o.product_id}, tipo: ${typeof o.product_id})`;console.error("‚ùå",c),s.push(c)}if(!o.quantity||typeof o.quantity!="number"||isNaN(o.quantity)||o.quantity<=0){const c=`Item ${r+1}: quantity inv√°lida (${o.quantity}, tipo: ${typeof o.quantity})`;console.error("‚ùå",c),s.push(c)}if(typeof o.price!="number"||isNaN(o.price)||o.price<=0){const c=`Item ${r+1}: price inv√°lido (${o.price}, tipo: ${typeof o.price})`;console.error("‚ùå",c),s.push(c)}});const a={valid:s.length===0,errors:s};return console.log("üìä Validaci√≥n resultado:",a),a}static async debugItemPricing(t,s){console.log("üîç DEBUG: Comparaci√≥n usando calculadora centralizada");const o=(await be.prepareCheckoutData(t)).items;t.forEach((r,c)=>{const d=s[c],y=o[c];console.log(`üì¶ Item ${c+1}:`,{product_id:r.productId||r.product?.id,quantity:r.quantity,calculated_final_price:y?.price,checkout_price:d?.price,prices_match:Math.abs((d?.price||0)-(y?.price||0))<.01,"‚úÖ":"USANDO CALCULADORA CENTRALIZADA"})})}}const Ce={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_ANALYTICS_ENABLED:"true",VITE_API_BASE_URL:"https://api.comersia.app/api",VITE_APP_DESCRIPTION:"Plataforma de e-commerce ecuatoriana",VITE_APP_ENV:"production",VITE_APP_NAME:"Comersia",VITE_AUTO_REFRESH_ENABLED:"true",VITE_BACKEND_URL:"https://api.comersia.app",VITE_BUNDLE_ANALYZER:"false",VITE_CACHE_DURATION:"3600000",VITE_CACHE_ENABLED:"true",VITE_CSP_ENABLED:"true",VITE_DATAFAST_LOGO_URL:"https://www.datafast.com.ec/images/logo.png",VITE_DATAFAST_MODE:"production",VITE_DATAFAST_WIDGET_URL:"https://eu-test.oppwa.com/v1/paymentWidgets.js",VITE_DEBUG_MODE:"false",VITE_DEUNA_MODE:"production",VITE_ENABLE_DEVTOOLS:"false",VITE_ERROR_REPORTING:"true",VITE_EXPIRES_IN_SECONDS:"900",VITE_FRONTEND_URL:"https://comersia.app",VITE_GOOGLE_CLIENT_ID:"581090375629-kds9jjgs2pk60iqe05fmjhpf6pps2nsv.apps.googleusercontent.com",VITE_HOT_RELOAD:"false",VITE_HTTPS_ONLY:"true",VITE_IMAGE_BASE_URL:"https://api.comersia.app/storage/",VITE_LOG_LEVEL:"error",VITE_MINIFY:"true",VITE_NODE_ENV:"production",VITE_PAYPAL_MODE:"live",VITE_PERFORMANCE_MONITORING:"true",VITE_PORT:"3000",VITE_SENTRY_ENABLED:"true",VITE_SESSION_TIMEOUT_MINUTES:"15",VITE_SITE_URL:"https://comersia.app",VITE_SOURCE_MAPS:"false",VITE_SRI_API_URL:"http://localhost:3100",VITE_SRI_EMAIL:"businessconnect@businessconnect.com.ec",VITE_SRI_PASSWORD:"dalcroze77aA@",VITE_STORAGE_PREFIX:"comersia_",VITE_TRACKING_ENABLED:"true",VITE_TREE_SHAKING:"true",VITE_URL_BASE:"http://localhost:8000"},at=(u,t)=>{const s=Ce?.[u];return s&&!isNaN(Number(s))?Number(s):t},Se={PRECISION:{PRICE_COMPARISON_TOLERANCE:at("VITE_PRICE_TOLERANCE",.001)},DEBUG:{SHOW_PRECISION_WARNINGS:Ce?.VITE_DEBUG_PRECISION==="true"||Ce?.NODE_ENV==="development"}},xt=(u,t,s=Se.PRECISION.PRICE_COMPARISON_TOLERANCE)=>{const a=Math.abs(u-t),o=a<=s;return Se.DEBUG.SHOW_PRECISION_WARNINGS&&a>0&&a<=s&&console.warn(`‚ö†Ô∏è Diferencia de precisi√≥n detectada: ${u} vs ${t} (diff: ${a.toFixed(6)}, tolerance: ${s})`),o};class Pe{async storeCheckoutData(t){try{console.log("DatafastService: Almacenando CheckoutData temporal",t);const s=await G.post(Z.DATAFAST.STORE_CHECKOUT_DATA,t);return console.log("DatafastService: CheckoutData almacenado exitosamente",s),s}catch(s){console.error("DatafastService: Error al almacenar CheckoutData:",s);const a=de(s,"Error al almacenar datos de checkout");throw new Error(a)}}async createCheckout(t){try{console.log("DatafastService: Creando checkout",t);const s=await G.post(Z.DATAFAST.CREATE_CHECKOUT,t);return console.log("DatafastService: Respuesta de checkout",s),s}catch(s){console.error("DatafastService: Error al crear checkout:",s);const a=de(s,"Error al crear el checkout de Datafast");throw new Error(a)}}async verifyPayment(t){try{console.log("DatafastService: Verificando pago",t);const s=await G.post(Z.DATAFAST.VERIFY_PAYMENT,t);return console.log("DatafastService: Respuesta de verificaci√≥n",s),s}catch(s){console.error("DatafastService: Error al verificar pago:",s);const a=de(s,"Error al verificar el pago de Datafast");throw new Error(a)}}async simulateSuccessfulPayment(t,s,a){if(!t)throw new Error("checkout_id es requerido para simular el pago");if(!s)throw new Error("transaction_id es requerido para simular el pago");const o=`/v1/checkouts/${t}/payment`;console.log("DatafastService: Simulando pago exitoso",{checkoutId:t,transactionId:s,mockResourcePath:o});try{const r={resource_path:o,transaction_id:s,calculated_total:a,simulate_success:!0};console.log("üîÑ Enviando datos de simulaci√≥n:",r);const c=await G.post(Z.DATAFAST.VERIFY_PAYMENT,r);return console.log("DatafastService: Respuesta de simulaci√≥n:",c),c}catch(r){console.error("DatafastService: Error en simulaci√≥n:",r);const c=de(r,"Error al simular el pago de Datafast");throw new Error(c)}}async handleDatafastResult(t,s,a){try{console.log("DatafastService: Manejando resultado real de Datafast",{resourcePath:t,transactionId:s,calculatedTotal:a});const o=await this.verifyPayment({resource_path:t,transaction_id:s,calculated_total:a});return o.status!=="success"&&o.result_code==="800.900.300"?{success:!1,status:"error",message:'No se complet√≥ un pago real. Este es el comportamiento esperado en Fase 1 de pruebas. Use "Simular Pago Exitoso" para probar el flujo completo.',result_code:o.result_code,is_phase_1_error:!0}:o}catch(o){console.error("DatafastService: Error al manejar resultado:",o);const r=de(o,"Error al procesar el resultado de Datafast");throw new Error(r)}}async simulateCompleteWidgetFlow(t,s,a,o){try{console.log("üéØ DatafastService: Simulando flujo COMPLETO del widget (orden + factura + SRI)"),console.log("üìä Par√°metros:",{checkoutId:t,transactionId:s,calculatedTotal:a});const r=`/v1/checkouts/${t}/payment`;console.log("üîó ResourcePath simulado:",r),console.log("üíæ Guardando datos en localStorage (id√©ntico a widget real)..."),localStorage.setItem("datafast_resource_path",r),localStorage.setItem("datafast_form_data",JSON.stringify(o)),localStorage.setItem("datafast_calculated_total",a.toString()),localStorage.setItem("datafast_transaction_id",s),localStorage.setItem("datafast_checkout_id",t),console.log("‚úÖ Datos guardados en localStorage:"),console.log("   - datafast_resource_path:",r),console.log("   - datafast_form_data:","guardado"),console.log("   - datafast_calculated_total:",a),console.log("   - datafast_transaction_id:",s),console.log("   - datafast_checkout_id:",t),console.log("üìã Configuraci√≥n lista - DatafastResultPage procesar√° el pago"),console.log("‚ö†Ô∏è NO hacer request aqu√≠ para evitar doble procesamiento"),console.log("‚è≥ Simulando delay de procesamiento del widget..."),await new Promise(d=>setTimeout(d,1e3));const c=`/datafast-result?resourcePath=${encodeURIComponent(r)}&status=pending&transactionId=${s}&simulate=true`;return console.log("üöÄ URL de redirecci√≥n generada (flujo completo):",c),console.log("üìã DatafastResultPage ejecutar√°:"),console.log("   1. verifyPayment() - verificaci√≥n (simulada como exitosa)"),console.log("   2. processCheckout() - crear orden + factura + enviar SRI"),console.log("   3. clearCart() - limpiar carrito"),console.log("   4. navigate('/orders') - redirigir a √≥rdenes"),c}catch(r){throw console.error("‚ùå Error en simulaci√≥n de widget flow:",r),new Error("Error al simular el flujo del widget")}}extractResourcePath(t){try{const a=new URLSearchParams(t.split("?")[1]).get("resourcePath");return console.log("DatafastService: ResourcePath extra√≠do:",a),a}catch(s){return console.error("DatafastService: Error al extraer resourcePath:",s),null}}}const rt=({content:u})=>e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"mb-4 text-gray-600",children:"Paga con Datafast!, ingresa los datos personales para pagar de forma r√°pida y segura."}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-[linear-gradient(to_right,_rgba(0,184,110,1)_0%,_rgba(0,77,112,1)_46%,_rgba(0,77,112,1)_100%)] border-purple-200 rounded-lg p-6",children:e.jsx("div",{className:"flex items-center justify-center mb-4 h-50",children:e.jsx("img",{src:"https://www.datafast.com.ec/images/logo.png",alt:"Datafast Logo",className:"h-20"})})}),u]}),e.jsxs("div",{className:"mt-4 text-sm text-gray-500",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"1."}),' Haz clic en "Pagar con Datafast!"']}),e.jsxs("p",{children:[e.jsx("strong",{children:"2."})," Completa los datos de tu tarjeta de cr√©dito o d√©bito."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"3."})," Confirma tu compra al finalizar."]})]})]})});class te{static BASE_PATH="/deuna";static async createPayment(t){try{console.log("DeunaService: Creating payment",t),console.log("üîç DEUNA SERVICE - EXACT PAYLOAD TO SEND:",{path:`${this.BASE_PATH}/payments`,payload:t,payload_json:JSON.stringify(t),items_in_payload:t.items,items_count:t.items?.length||0,first_item_keys:t.items&&t.items.length>0?Object.keys(t.items[0]):"no_items"});const s=await G.post(`${this.BASE_PATH}/payments`,t);return console.log("DeunaService: Payment created successfully",s),s}catch(s){throw console.error("DeunaService: Error creating payment",s),new Error(s.response?.data?.message||s.message||"Error creating payment")}}static async generateQR(t){try{console.log("DeunaService: Generating QR code",t);const s=await G.post(`${this.BASE_PATH}/payments/qr`,t);return console.log("DeunaService: QR code generated successfully",s),s}catch(s){throw console.error("DeunaService: Error generating QR code",s),new Error(s.response?.data?.message||s.message||"Error generating QR code")}}static async getPaymentStatus(t){try{console.log("DeunaService: Getting payment status",{paymentId:t});const s=await G.get(`${this.BASE_PATH}/payments/${t}/status`);return console.log("DeunaService: Payment status retrieved",s),s}catch(s){throw console.error("DeunaService: Error getting payment status",s),new Error(s.response?.data?.message||s.message||"Error getting payment status")}}static async getPaymentByOrderId(t){try{console.log("DeunaService: Getting payment by order ID",{orderId:t});const s=await G.get(`${this.BASE_PATH}/orders/${t}/payment`);return console.log("DeunaService: Payment retrieved by order ID",s),s}catch(s){throw console.error("DeunaService: Error getting payment by order ID",s),new Error(s.response?.data?.message||s.message||"Error getting payment")}}static async cancelPayment(t,s){try{console.log("DeunaService: Cancelling payment",{paymentId:t,reason:s});const a=await G.post(`${this.BASE_PATH}/payments/${t}/cancel`,{reason:s||"Cancelled by user"});return console.log("DeunaService: Payment cancelled successfully",a),a}catch(a){throw console.error("DeunaService: Error cancelling payment",a),new Error(a.response?.data?.message||a.message||"Error cancelling payment")}}static async voidPayment(t,s,a){try{console.log("DeunaService: Processing void/refund",{paymentId:t,amount:s,reason:a});const o=await G.post(`${this.BASE_PATH}/payments/${t}/void`,{amount:s,reason:a||"Void/refund requested by user"});return console.log("DeunaService: Payment void/refund processed successfully",o),o}catch(o){throw console.error("DeunaService: Error processing void/refund",o),new Error(o.response?.data?.message||o.message||"Error processing void/refund")}}static async listPayments(t){try{console.log("DeunaService: Listing payments",t);const s=new URLSearchParams;t&&Object.entries(t).forEach(([o,r])=>{r!=null&&r!==""&&s.append(o,String(r))});const a=await G.get(`${this.BASE_PATH}/payments?${s.toString()}`);return console.log("DeunaService: Payments listed successfully",a),a}catch(s){throw console.error("DeunaService: Error listing payments",s),new Error(s.response?.data?.message||s.message||"Error listing payments")}}static pollPaymentStatus(t,s){const a=s?.maxAttempts||60,o=s?.interval||5e3,r=s?.onStatusChange,c=new AbortController;return{promise:new Promise(async(y,b)=>{let x=0,I="",E=null;const j=()=>{E&&(clearTimeout(E),E=null)},N=()=>{j(),b(new Error("Payment polling was cancelled"))};c.signal.addEventListener("abort",N);try{for(;x<a&&!c.signal.aborted;)try{const M=await this.getPaymentStatus(t),D=M.data.status;if(c.signal.aborted){j();return}if(D!==I&&r&&(r(D),I=D),["completed","failed","cancelled","refunded"].includes(D)){console.log(`DeunaService: Payment reached final status: ${D}`),j(),c.signal.removeEventListener("abort",N),y(M);return}x++,x<a&&!c.signal.aborted&&await new Promise(($,R)=>{E=setTimeout(()=>{E=null,c.signal.aborted?R(new Error("Cancelled")):$()},o);const z=()=>{E&&(clearTimeout(E),E=null),R(new Error("Cancelled"))};c.signal.addEventListener("abort",z,{once:!0})})}catch(M){if(c.signal.aborted){j();return}console.warn(`DeunaService: Error polling payment status (attempt ${x+1})`,M),x++,x<a&&await new Promise((D,$)=>{E=setTimeout(()=>{E=null,c.signal.aborted?$(new Error("Cancelled")):D()},o);const R=()=>{E&&(clearTimeout(E),E=null),$(new Error("Cancelled"))};c.signal.addEventListener("abort",R,{once:!0})})}j(),c.signal.removeEventListener("abort",N),c.signal.aborted?b(new Error("Payment polling was cancelled")):b(new Error(`Payment status polling timed out after ${a} attempts`))}catch(M){j(),c.signal.removeEventListener("abort",N),M.message==="Cancelled"?b(new Error("Payment polling was cancelled")):b(M)}}),cancel:()=>{console.log("DeunaService: Cancelling payment polling"),c.abort()}}}static isValidQRCode(t){if(!t||t.trim()==="")return!1;if(t.startsWith("data:image/"))return!0;try{return new URL(t),!0}catch{return!1}}static formatCurrency(t,s="USD"){return new Intl.NumberFormat("es-EC",{style:"currency",currency:s,minimumFractionDigits:2,maximumFractionDigits:2}).format(t)}static getPaymentMethodDisplayName(t){return{qr_code:"C√≥digo QR",payment_link:"Enlace de Pago",numeric_code:"C√≥digo Num√©rico",deuna:"DeUna"}[t]||t}static getStatusDisplay(t){return{created:{label:"Creado",color:"blue",icon:se.createElement(Ve,{className:"w-4 h-4"})},pending:{label:"Pendiente",color:"yellow",icon:se.createElement(Ie,{className:"w-4 h-4"})},completed:{label:"Completado",color:"green",icon:se.createElement(De,{className:"w-4 h-4"})},failed:{label:"Fallido",color:"red",icon:se.createElement(he,{className:"w-4 h-4"})},cancelled:{label:"Cancelado",color:"gray",icon:se.createElement(Fe,{className:"w-4 h-4"})},refunded:{label:"Reembolsado",color:"purple",icon:se.createElement(Le,{className:"w-4 h-4"})}}[t]||{label:t,color:"gray",icon:se.createElement(Me,{className:"w-4 h-4"})}}static async simulatePaymentSuccess(t,s,a,o,r){if(!t||t.trim()==="")throw new Error("payment_id es obligatorio para la simulaci√≥n");if(!s||s<=0)throw new Error("amount v√°lido es obligatorio para la simulaci√≥n");if(!a||a.trim()==="")throw new Error("customer_email es obligatorio para la simulaci√≥n");try{console.log("üß™ Simulating payment success for testing",{paymentId:t,amount:s,customerEmail:a});const c={payment_id:t,transaction_id:t,simulate_deuna:!0,amount:s,currency:"USD",customer_email:a,customer_name:o||"Test User",calculated_total:s,session_id:r},d=await G.post("/webhooks/deuna/simulate-payment-success",c);return console.log("üéâ Payment simulation response:",d),d}catch(c){throw console.error("‚ùå Error simulating payment:",c),new Error(c.response?.data?.message||c.message||"Error simulando el pago")}}static async processRealPaymentCompletion(t,s,a){try{console.log("‚úÖ Processing REAL payment completion (not simulation)",{paymentId:t,amount:s,customerEmail:a}),console.log("üìã Real payment flow: webhook processing ‚Üí order creation ‚Üí invoice ‚Üí SRI");const o=await this.getPaymentStatus(t);if(o.success&&o.data?.status==="completed"){console.log("‚úÖ Payment confirmed as completed, processing real webhook flow");const r={event:"payment.completed",payment_id:t,status:"completed",amount:s||o.data.amount,currency:"USD",customer_email:a||"default@deuna.com",completed_at:new Date().toISOString(),source:"real_payment_completion"};console.log("üîÑ Processing real payment through webhook handler");const c=await G.post("/webhooks/deuna",r);return console.log("üéâ Real payment processed successfully:",c),console.log("üìä This payment went through: HandleDeunaWebhookUseCase ‚Üí createOrderFromPayment() ‚Üí order + invoice + SRI"),c}else throw console.warn("‚ö†Ô∏è Payment status is not completed, cannot process real completion"),new Error("Payment is not in completed status")}catch(o){throw console.error("‚ùå Error processing real payment completion:",o),console.error("üîÑ Real payment processing failed, this should be investigated"),console.error("üí° Consider checking: payment status, webhook endpoint, HandleDeunaWebhookUseCase"),new Error(o.response?.data?.message||o.message||"Error procesando el pago completado real")}}static isDevelopmentMode(){return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"}}const nt=({checkoutData:u,onPaymentSuccess:t,onPaymentError:s})=>{const{cart:a}=_e(),{user:o}=ye(),[r,c]=g.useState(!1),[d,y]=g.useState(null),[b,x]=g.useState(""),[I,E]=g.useState(!1),[j,N]=g.useState(""),[M,D]=g.useState(600),[$,R]=g.useState(!1),[z,J]=g.useState(!1),q=se.useRef(null),_=se.useRef(null),Q=se.useRef([]);if(!u||!u.totals)throw new Error("QRPaymentForm requiere CheckoutData v√°lido con totales");if(!u.totals.final_total||u.totals.final_total<=0)throw new Error("QRPaymentForm requiere total v√°lido mayor a $0");const X=u.totals.final_total,U=g.useCallback(()=>`ORDER-${Date.now()}-${Math.random().toString(36).substr(2,9).toUpperCase()}`,[]),Y=async i=>{try{await navigator.clipboard.writeText(i),R(!0),setTimeout(()=>R(!1),2e3)}catch(A){console.error("Failed to copy to clipboard:",A)}};g.useEffect(()=>{if(d&&I&&M>0){const i=setInterval(()=>{D(A=>A<=1?(E(!1),x("El tiempo de pago ha expirado. El pago ha sido cancelado autom√°ticamente."),d?.payment_id&&(console.log("‚è∞ Timer expired - automatically cancelling payment:",d.payment_id),te.cancelPayment(d.payment_id,"Timer expired - automatic cancellation").then(()=>{console.log("‚úÖ Payment automatically cancelled due to timer expiration"),N("cancelled"),q.current?.cancel&&(q.current.cancel(),q.current=null)}).catch(l=>{console.error("‚ùå Error automatically cancelling expired payment:",l),N("cancelled")})),0):A-1)},1e3);_.current=i,Q.current.push(()=>{i&&clearInterval(i)})}return()=>{_.current&&(clearInterval(_.current),_.current=null)}},[d,I,M]),g.useEffect(()=>()=>{console.log("üö® QRPaymentForm: Component unmounting, executing critical cleanup"),h()},[]);const re=i=>{const A=Math.floor(i/60),l=i%60;return`${A.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`},ne=g.useCallback(i=>{console.log("Payment status changed:",i),N(i);const A=te.getStatusDisplay(i);switch(i){case"completed":E(!1),console.log("‚úÖ Payment completed successfully, processing REAL payment completion"),(async()=>{try{if(d){console.log("üéØ Processing REAL QR payment completion through actual webhook flow"),console.log("üìã This will trigger: webhook ‚Üí HandleDeunaWebhookUseCase ‚Üí createOrderFromPayment() ‚Üí order + invoice + SRI");const v=await te.processRealPaymentCompletion(d.payment_id,d.amount,o?.email);v.success&&(console.log("‚úÖ Order created successfully from REAL QR payment:",v),console.log("üèÜ Real payment processed with complete flow: order + invoice + SRI generation"))}t&&t({...d,status:"completed",completed_at:new Date().toISOString()})}catch(v){console.error("Error processing completed payment:",v),t&&t({...d,status:"completed",completed_at:new Date().toISOString()})}})();break;case"failed":case"cancelled":E(!1);const n=`Pago ${A.label.toLowerCase()}`;x(n),s&&s(n);break}},[d,t,s]),oe=async()=>{if(!u){x("No se puede generar QR sin datos de checkout validados");return}if(!o){x("Informaci√≥n de usuario no disponible");return}c(!0),x("");try{const i=U();console.log("üéØ USANDO CHECKOUTDATA PARA QR DEUNA:",{sessionId:u.sessionId,userId:u.userId,total:u.totals.final_total,itemsCount:u.items.length,validatedAt:u.validatedAt});const A={order_id:i,amount:u.totals.final_total,currency:"USD",customer:{name:u.shippingData.name,email:u.shippingData.email,phone:u.shippingData.phone},items:u.items.map((n,v)=>{const w={name:n.name,quantity:n.quantity,price:n.price,description:n.name,product_id:n.product_id};return console.log(`‚úÖ ITEM ${v} FROM CHECKOUTDATA:`,{product_id:w.product_id,name:w.name,quantity:w.quantity,price:w.price}),w}),qr_type:"dynamic",format:"2",metadata:{source:"bcommerce_checkout_validated",user_id:o.id,session_id:u.sessionId,validated_at:u.validatedAt,checkout_timestamp:new Date().toISOString()},session_id:u.sessionId,validated_at:u.validatedAt,checkout_data:u};console.log("üöÄ FINAL PAYMENT REQUEST TO SEND:",{order_id:A.order_id,amount:A.amount,items_count:A.items?.length||0,items:A.items,first_item_keys:A.items&&A.items.length>0?Object.keys(A.items[0]):"no_items"}),console.log("Creating DeUna payment:",A);const l=await te.createPayment(A);if(console.log("DeUna API Response:",l),console.log("Response structure:",Object.keys(l)),l.success){console.log("Payment data from response:",l.data),console.log("QR code in response:",l.data?.qr_code_base64),y(l.data),N(l.data.status),D(600),E(!0);const n=te.pollPaymentStatus(l.data.payment_id,{maxAttempts:40,interval:15e3,onStatusChange:ne});q.current=n,n.promise.catch(v=>{v.message==="Payment polling was cancelled"?console.log("DeunaService: Polling cancelled successfully"):(console.error("Polling error:",v),I&&x("Error monitoreando el estado del pago"))})}else throw new Error(l.message||"Error creating payment")}catch(i){console.error("Error generating QR payment:",i),x(i.message||"Error al generar el c√≥digo QR"),s&&s(i.message)}finally{c(!1)}},h=()=>{q.current?.cancel&&(q.current.cancel(),q.current=null),_.current&&(clearInterval(_.current),_.current=null),Q.current.forEach(i=>{try{i()}catch(A){console.error("Error during cleanup:",A)}}),Q.current=[],y(null),x(""),N(""),E(!1),D(600),R(!1),console.log("üßπ QRPaymentForm: Complete cleanup executed")},S=async()=>{if(!d?.payment_id||j==="completed"){h();return}if(!I){h();return}try{console.log("Cancelling payment:",d.payment_id),q.current?.cancel&&(q.current.cancel(),q.current=null),E(!1),await te.cancelPayment(d.payment_id,"Cancelled by user"),N("cancelled"),x("Pago cancelado por el usuario"),console.log("Payment successfully cancelled by user")}catch(i){console.error("Error cancelling payment:",i),x("Error al cancelar el pago: "+i.message),E(!1)}},T=async()=>{try{if(c(!0),x(""),d?.payment_id&&I&&!["completed","cancelled","failed"].includes(j))try{console.log("Cancelling current payment before generating new QR:",d.payment_id),q.current?.cancel&&(q.current.cancel(),q.current=null),E(!1),await te.cancelPayment(d.payment_id,"Cancelled to generate new QR"),console.log("Current payment cancelled successfully")}catch(i){console.error("Error cancelling current payment:",i)}await oe()}catch(i){console.error("Error generating new QR:",i),x("Error al generar nuevo c√≥digo QR: "+i.message)}finally{c(!1)}},H=async()=>{if(!d?.payment_id){x("No hay un pago activo para simular");return}if(!d?.amount||d.amount<=0){x("Monto del pago inv√°lido o faltante");return}if(!o?.email){x("Email del usuario requerido para la simulaci√≥n");return}J(!0),x("");try{console.log("üß™ SIMULATING payment success for testing purposes"),console.log("üìã This will trigger: simulation webhook ‚Üí HandleDeunaWebhookUseCase ‚Üí createOrderFromPayment() ‚Üí order + invoice + SRI");const i=await te.simulatePaymentSuccess(d.payment_id,d.amount,o.email,o.name||void 0,u?.sessionId);if(i.success)console.log("‚úÖ Payment simulation successful:",i),N("completed"),E(!1),q.current?.cancel&&(q.current.cancel(),q.current=null),t&&t({...d,status:"completed",completed_at:new Date().toISOString(),simulated:!0});else throw new Error(i.message||"Simulation failed")}catch(i){console.error("‚ùå Error simulating payment:",i),x("Error simulando el pago: "+i.message)}finally{J(!1)}},p=()=>{if(!j)return null;const i=te.getStatusDisplay(j);return e.jsxs("div",{className:`flex items-center justify-center p-3 rounded-lg mb-4 ${i.color==="green"?"bg-green-50 text-green-700":i.color==="red"?"bg-red-50 text-red-700":i.color==="yellow"?"bg-yellow-50 text-yellow-700":"bg-blue-50 text-blue-700"}`,children:[e.jsx("span",{className:"mr-2",children:i.icon}),e.jsx("span",{className:"font-medium",children:i.label}),I&&i.color==="yellow"&&e.jsx(me,{className:"w-4 h-4 ml-2 animate-spin"})]})};return d?e.jsxs("div",{className:"space-y-6",children:[e.jsx(p,{}),I&&e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"inline-flex items-center bg-blue-50 text-blue-700 px-4 py-2 rounded-lg",children:[e.jsx(Ie,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"font-mono text-lg",children:re(M)})]}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Tiempo restante para completar el pago"})]}),d.qr_code_base64&&!["cancelled","failed"].includes(j)?e.jsx("div",{className:"mb-4 mx-auto",children:e.jsxs("div",{className:"bg-[#2fd8a8] p-6 rounded-lg text-white",children:[e.jsx("div",{className:"w-24 h-24 mx-auto mb-4 bg-white rounded-full flex items-center justify-center",children:e.jsx("img",{src:"https://deuna.app/assets/img/brand/logo-deuna.svg",alt:"DeUna Logo",className:"w-20 h-20"})}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Pago con Deuna"}),e.jsxs("p",{className:"text-purple-100 mb-4",children:["Monto a pagar: ",B(X)]}),e.jsx("div",{className:"bg-white rounded-lg p-4 mb-4",children:e.jsx("img",{src:d.qr_code_base64,alt:"C√≥digo QR para pago",className:"w-full h-auto max-w-64 mx-auto"})}),e.jsxs("p",{className:"text-purple-100 text-sm mb-4 flex items-center justify-center",children:[e.jsx(qe,{className:"w-4 h-4 mr-2"}),"Escanea con tu app Deuna"]}),e.jsx("button",{onClick:S,className:"bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-4 rounded-md transition-colors",disabled:!I||j==="completed",children:I?"Cancelar Pago":"Cerrar"})]})}):["cancelled","failed"].includes(j)&&e.jsx("div",{className:"mb-4 mx-auto",children:e.jsxs("div",{className:"bg-gray-100 border-2 border-gray-300 p-6 rounded-lg text-center",children:[e.jsx("div",{className:"w-24 h-24 mx-auto mb-4 bg-gray-300 rounded-full flex items-center justify-center",children:e.jsx(he,{className:"w-12 h-12 text-gray-500"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-700 mb-2",children:j==="cancelled"?"Pago Cancelado":"Pago Fallido"}),e.jsx("p",{className:"text-gray-600 mb-4",children:j==="cancelled"?"El pago fue cancelado. Puedes generar un nuevo c√≥digo QR.":"El pago fall√≥. Puedes intentar generar un nuevo c√≥digo QR."})]})}),d.payment_url&&!["cancelled","failed"].includes(j)&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("input",{type:"text",value:d.payment_url,readOnly:!0,className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"}),e.jsxs("button",{onClick:()=>Y(d.payment_url),className:"px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx(Be,{className:"w-4 h-4 mr-1"}),$?"Copiado!":"Copiar"]})]}),e.jsxs("a",{href:d.payment_url,target:"_blank",rel:"noopener noreferrer",className:"w-full bg-[#3f2b57] hover:bg-[#3f2b45] text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx(Ge,{className:"w-4 h-4 mr-2"}),"Abrir enlace de pago"]})]}),d.numeric_code&&!["cancelled","failed"].includes(j)&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"C√≥digo num√©rico:"}),e.jsx("p",{className:"text-2xl font-mono font-bold text-gray-900 tracking-wider",children:d.numeric_code})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-lg font-semibold text-gray-900",children:["Monto a pagar: ",B(X)]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["ID de Pago: ",d.payment_id]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("button",{onClick:T,disabled:r,className:"flex-1 bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:r?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-4 h-4 mr-2 animate-spin"}),"Generando..."]}):"Generar Nuevo QR"}),te.isDevelopmentMode()&&I&&!["completed","cancelled","failed"].includes(j)&&e.jsx("button",{onClick:H,disabled:z,className:"flex-1 bg-orange-500 hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:z?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-4 h-4 mr-2 animate-spin"}),"Simulando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),"üß™ Simular Pago"]})}),j==="completed"&&e.jsxs("button",{onClick:()=>t&&t(d),className:"flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"Continuar"]})]}),b&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(he,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("p",{className:"text-red-700",children:b})]})}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Instrucciones:"}),e.jsxs("ol",{className:"text-sm text-blue-800 space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"1."})," Escanea el c√≥digo QR con tu app de pagos"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"2."})," O usa el enlace de pago en tu dispositivo m√≥vil"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"3."})," Completa el pago en la aplicaci√≥n"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"4."})," Espera la confirmaci√≥n autom√°tica"]})]}),te.isDevelopmentMode()&&I&&e.jsx("div",{className:"mt-3 pt-3 border-t border-blue-300",children:e.jsxs("p",{className:"text-xs text-orange-700 bg-orange-50 p-2 rounded",children:["üß™ ",e.jsx("strong",{children:"Modo de desarrollo:"}),' Puedes usar el bot√≥n "Simular Pago" para testear el flujo completo sin necesidad de realizar un pago real.']})})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"mb-4 text-center text-gray-600",children:"Paga con DeUna!, Genera el c√≥digo qr y escanealo desde tu app para pagar de forma r√°pida y segura."}),e.jsx("div",{className:"bg-[#2fd8a8] border-purple-200 rounded-lg p-6",children:e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx("img",{src:"https://deuna.app/assets/img/brand/logo-deuna.svg",alt:"DeUna Logo",className:"w-50 h-50"})})}),e.jsx("button",{type:"button",onClick:oe,disabled:r||!o||!a?.items?.length,className:"w-full bg-[#3f2b57] hover:bg-[#342843] disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-101 disabled:transform-none flex items-center justify-center",children:r?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-5 h-5 mr-2 animate-spin"}),"Generando c√≥digo QR..."]}):`Pagar con DeUna! - ${B(X)}`}),b&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(he,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("p",{className:"text-red-700",children:b})]})}),e.jsxs("div",{className:"mt-4 text-sm text-center text-gray-500",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"1."}),' Haz clic en "Pagar con DeUna!"']}),e.jsxs("p",{children:[e.jsx("strong",{children:"2."})," Completa el pago con el QR"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"3."})," Confirma tu compra al finalizar."]})]})]})},we=({title:u,address:t,onAddressChange:s,errors:a})=>{const o=u.replace(/\s+/g,"-").toLowerCase();return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:u}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`name-${o}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre Completo *"}),e.jsx("input",{type:"text",id:`name-${o}`,value:t.name||"",onChange:r=>s("name",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.name?"border-red-500":"border-gray-300"}`,placeholder:"Nombre y Apellido"}),a.name&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.name})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`identification-${o}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"C√©dula/RUC *"}),e.jsx("input",{type:"text",id:`identification-${o}`,value:t.identification||"",onChange:r=>s("identification",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.identification?"border-red-500":"border-gray-300"}`,placeholder:"1234567890 (c√©dula) o 1234567890001 (RUC)",maxLength:13}),a.identification&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.identification})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`street-${o}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Direcci√≥n / Calle Principal *"}),e.jsx("input",{type:"text",id:`street-${o}`,value:t.street||"",onChange:r=>s("street",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.street?"border-red-500":"border-gray-300"}`,placeholder:"Calle, n√∫mero, piso, etc."}),a.street&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.street})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`city-${o}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Ciudad *"}),e.jsx("input",{type:"text",id:`city-${o}`,value:t.city||"",onChange:r=>s("city",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.city?"border-red-500":"border-gray-300"}`,placeholder:"Ciudad"}),a.city&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.city})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`state-${o}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Provincia/Estado *"}),e.jsx("input",{type:"text",id:`state-${o}`,value:t.state||"",onChange:r=>s("state",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.state?"border-red-500":"border-gray-300"}`,placeholder:"Provincia o Estado"}),a.state&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.state})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`postalCode-${o}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"C√≥digo Postal"}),e.jsx("input",{type:"text",id:`postalCode-${o}`,value:t.postalCode||"",onChange:r=>s("postalCode",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.postalCode?"border-red-500":"border-gray-300"}`,placeholder:"C√≥digo Postal"}),a.postalCode&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.postalCode})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`country-${o}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Pa√≠s *"}),e.jsx("input",{type:"text",id:`country-${o}`,value:t.country||"",onChange:r=>s("country",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.country?"border-red-500":"border-gray-300"}`,placeholder:"Pa√≠s"}),a.country&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.country})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`phone-${o}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Tel√©fono *"}),e.jsx("input",{type:"tel",id:`phone-${o}`,value:t.phone||"",onChange:r=>s("phone",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.phone?"border-red-500":"border-gray-300"}`,placeholder:"N√∫mero de tel√©fono"}),a.phone&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.phone})]})]})]})},ct=()=>{g.useEffect(()=>{console.log("üîì Hook useDatafastCSP activado - Desactivando CSP para Datafast");const u=()=>{const o=document.querySelectorAll('meta[http-equiv="Content-Security-Policy"]');o.length>0&&(o.forEach(c=>c.remove()),console.log(`üóëÔ∏è Removidos ${o.length} meta tags de CSP`)),document.querySelectorAll("meta").forEach(c=>{const d=c.getAttribute("http-equiv")?.toLowerCase();d&&d.includes("content-security")&&(c.remove(),console.log("üóëÔ∏è Removido meta tag con CSP alternativo"))})};u();const t=new MutationObserver(o=>{o.forEach(r=>{r.type==="childList"&&r.addedNodes.forEach(c=>{if(c.nodeType===1){const d=c;if(d.tagName==="META"){const y=d.getAttribute("http-equiv")?.toLowerCase();y&&y.includes("content-security")&&(console.log("üö® CSP detectado por MutationObserver - removiendo inmediatamente"),d.remove())}}})})});t.observe(document.head,{childList:!0,subtree:!0});const s=setInterval(()=>{u()},100),a=setInterval(()=>{document.querySelector('meta[http-equiv="Content-Security-Policy"]')&&(console.log("‚ö†Ô∏è CSP detectado en verificaci√≥n regular - removiendo"),u())},1e3);return()=>{console.log("üîÑ Limpiando hook useDatafastCSP"),t.disconnect(),clearInterval(s),clearInterval(a)}},[])},it=({onSuccess:u,onError:t,checkoutData:s})=>{ct();const a={Ecuador:"EC",Colombia:"CO",Per√∫:"PE",Peru:"PE","Estados Unidos":"US","United States":"US",USA:"US",EC:"EC",CO:"CO",PE:"PE",US:"US"};Ae();const{cart:o,clearCart:r,showNotification:c,appliedDiscount:d}=_e();ye();const[y,b]=g.useState(!1),x=h=>a[h]||h.substring(0,2).toUpperCase(),I=h=>{const S=h.replace(/\D/g,"");if(S.length===10)return/^\d{10}$/.test(S)?{cedula:S,wasRuc:!1}:{cedula:S,wasRuc:!1,message:"C√©dula debe tener 10 d√≠gitos num√©ricos"};if(S.length===13){const T=S.substring(0,10);return{cedula:T,wasRuc:!0,message:`Se extrajo autom√°ticamente la c√©dula ${T} del RUC ${S}`}}else return{cedula:S,wasRuc:!1,message:"Identificaci√≥n inv√°lida: debe tener 10 d√≠gitos (c√©dula) o 13 d√≠gitos (RUC)"}},[E,j]=g.useState(!1),[N,M]=g.useState(null),[D,$]=g.useState(!1),[R,z]=g.useState(!1),[J,q]=g.useState(null),[_,Q]=g.useState(()=>{if(!s?.shippingData)throw new Error("DatafastPaymentButton requiere CheckoutData v√°lido");const h=s.shippingData,S=h.name.split(" "),T=S[0],H=S.slice(1).join(" "),p=I(h.identification);return console.log("üîç DatafastPaymentButton: Procesando identificaci√≥n:",{original:h.identification,extracted:p.cedula,wasRuc:p.wasRuc,message:p.message}),{address:h.street,city:h.city,country:x(h.country),given_name:T,middle_name:"",surname:H,phone:h.phone,doc_id:p.cedula}}),X=new Pe;g.useEffect(()=>()=>{const h=document.getElementById("datafast-widget-script");h&&h.remove()},[]),g.useEffect(()=>{s?(console.log("‚úÖ DatafastPaymentButton: Usando CheckoutData validado:",{sessionId:s.sessionId,userId:s.userId,total:s.totals.final_total,itemsCount:s.items.length,validatedAt:s.validatedAt}),I(s.shippingData.identification)):console.error("‚ùå DatafastPaymentButton: No se recibi√≥ CheckoutData v√°lido")},[s,c]);const U=(h,S)=>{if(h==="doc_id"){const T=I(S);T.message&&!T.wasRuc&&T.cedula.length!==10&&c(k.WARNING,T.message),Q(H=>({...H,[h]:T.cedula}))}else Q(T=>({...T,[h]:S}))},Y=()=>{const h=["address","city","country","given_name","surname","phone","doc_id"];for(const S of h)if(!_[S]||_[S].trim()==="")return c(k.ERROR,`El campo ${S.replace("_"," ")} es obligatorio`),!1;return _.doc_id.length!==10||!/^\d+$/.test(_.doc_id)?(c(k.ERROR,"La c√©dula debe tener exactamente 10 d√≠gitos"),!1):!0},re=async()=>{if(!o||o.items.length===0){c(k.ERROR,"El carrito est√° vac√≠o");return}if(Y()){b(!0);try{if(!s)throw new Error("No se puede proceder sin CheckoutData validado");console.log("üí∞ Usando totales pre-calculados de CheckoutData:",s.totals),console.log("üõí Usando items pre-preparados de CheckoutData:",s.items),q(s.totals);const h={given_name:_.given_name,surname:_.surname,phone:_.phone,doc_id:_.doc_id};_.middle_name&&_.middle_name.trim()!==""&&(h.middle_name=_.middle_name.trim());const S={shippingAddress:{street:_.address,city:_.city,country:x(_.country)},customer:h,items:s.items,total:s.totals.final_total,subtotal:s.totals.subtotal_with_discounts,shipping_cost:s.totals.shipping_cost,tax:s.totals.iva_amount,discount_code:s.discountCode||null,discount_info:s.discountInfo||null,session_id:s.sessionId,validated_at:s.validatedAt};console.log("Iniciando checkout con Datafast usando CheckoutData...",S),console.log("üí∞ Total enviado a Datafast: $",s.totals.final_total),console.log("üîç DEBUG - Datos de CheckoutData enviados:"),console.log("   - sessionId:",s.sessionId),console.log("   - customer.middle_name:",S.customer?.middle_name!==void 0?`"${S.customer.middle_name}" (tipo: ${typeof S.customer.middle_name})`:"OMITIDO - campo no enviado"),console.log("   - shippingAddress.country:",`"${S.shippingAddress.country}" (tipo: ${typeof S.shippingAddress.country})`),console.log("üîç DEBUG - Customer completo:",JSON.stringify(S.customer,null,2));const T=await X.createCheckout(S);if(console.log("Respuesta del checkout:",T),T.status==="success"&&T.data)M(T.data),$(!1),j(!0),localStorage.setItem("datafast_transaction_id",T.data.transaction_id),localStorage.setItem("datafast_checkout_id",T.data.checkout_id),localStorage.setItem("datafast_calculated_total",s.totals.final_total.toString()),localStorage.setItem("datafast_form_data",JSON.stringify(_)),console.log("üíæ GUARDANDO CHECKOUTDATA VALIDADO EN LOCALSTORAGE"),console.log("   - Items en CheckoutData:",s.items.length),console.log("   - SessionId:",s.sessionId),localStorage.setItem("datafast_checkout_data",JSON.stringify(s)),console.log("   ‚úÖ CheckoutData guardado en 'datafast_checkout_data'"),localStorage.setItem("datafast_session_id",s.sessionId),console.log("   ‚úÖ SessionId guardado para backend:",s.sessionId),c(k.SUCCESS,"Checkout creado. Preparando formulario de pago..."),setTimeout(()=>{T.data?ne(T.data.checkout_id):c(k.ERROR,"Datos de checkout no disponibles")},100);else throw new Error(T.message||"Error al crear checkout")}catch(h){console.error("Error al iniciar pago con Datafast:",h);const S=h instanceof Error?h.message:"Error desconocido";c(k.ERROR,S),t?.(S)}finally{b(!1)}}},ne=h=>{try{console.log("Cargando widget de Datafast...",h);const S=document.getElementById("datafast-widget-script");S&&S.remove(),window.wpwlOptions={onReady:function(){console.log("‚úÖ Widget de Datafast listo!"),z(!0),c(k.SUCCESS,"Formulario de pago cargado correctamente."),setTimeout(()=>{const p=document.querySelector("form.paymentWidgets");p&&(console.log("üìù Agregando listener adicional al formulario"),p.addEventListener("submit",function(l){console.log("üöÄ FORMULARIO ENVIADO - Evento capturado!"),console.log("   - Action actual:",p.getAttribute("action")),console.log("   - Method:",p.getAttribute("method")),console.log("   - Target:",p.getAttribute("target"))}),new MutationObserver(l=>{l.forEach(n=>{n.type==="attributes"&&n.attributeName==="action"&&console.log("üîÑ Action del formulario cambi√≥ a:",p.getAttribute("action"))})}).observe(p,{attributes:!0,attributeFilter:["action","method"]}),new MutationObserver(l=>{l.forEach(n=>{n.addedNodes.forEach(v=>{v.tagName==="IFRAME"&&(console.log("üñºÔ∏è Nuevo iframe detectado:",{name:v.name,src:v.src,id:v.id}),v.addEventListener("load",()=>{console.log("‚úÖ Iframe cargado:",v.name);try{(v.contentDocument||v.contentWindow?.document)&&console.log("üìÑ Contenido del iframe accesible")}catch{console.log("üîí Iframe cross-origin, no se puede acceder al contenido")}}))})})}).observe(document.body,{childList:!0,subtree:!0}))},500)},onBeforeSubmitCard:function(p){console.log("üîÑ Widget Datafast: Usuario hizo clic en Pagar, procesando..."),console.log("üîç Datos de la tarjeta que se est√°n enviando:",p);const i=document.querySelector("form.paymentWidgets");if(i){console.log("üìù Estado del formulario al hacer submit:"),console.log("   - Action:",i.action),console.log("   - Method:",i.method),console.log("   - Target:",i.target);const A=i.querySelector('input[name="checkoutId"]');A&&console.log("   - CheckoutId field:",A.getAttribute("value"));const l=document.querySelector(`iframe[name="${i.target}"]`);l?console.log("   - Target iframe encontrado:",l):console.log("   - ‚ö†Ô∏è No se encontr√≥ iframe target")}return c(k.INFO,"Procesando pago con Datafast..."),!0},onAfterSubmitCard:async function(p){if(console.log("‚è≥ Widget Datafast: Datos enviados, esperando respuesta..."),console.log("üì§ Respuesta completa despu√©s del env√≠o:",p),console.log("üîç DEBUG: Analizando estructura de la respuesta:"),console.log("   - Tipo de data:",typeof p),console.log("   - Es un array?:",Array.isArray(p)),console.log("   - Keys del objeto:",p?Object.keys(p):"data es null/undefined"),p&&p.originalEvent&&console.log("üìã Evento original detectado:",p.originalEvent),p&&p.target){console.log("üéØ Target del evento:",p.target);const n=p.target;n&&n.tagName==="FORM"&&(console.log("üìù Formulario encontrado en evento:"),console.log("   - Action:",n.action),console.log("   - Method:",n.method))}try{console.log("   - JSON stringified:",JSON.stringify(p,null,2))}catch{console.log("   - No se puede convertir a JSON (referencia circular)")}p&&p.redirect&&console.log("üîó Informaci√≥n de redirect encontrada:",p.redirect),p&&p.resourcePath&&(console.log("üìç ResourcePath encontrado:",p.resourcePath),console.log("üîÑ Intentando redirecci√≥n manual a:",`/datafast-result?resourcePath=${encodeURIComponent(p.resourcePath)}`),setTimeout(()=>{console.log("‚è∞ Esperando 3 segundos para ver si hay redirecci√≥n autom√°tica...")},3e3));let i=0;const A=10,l=setInterval(async()=>{i++,console.log(`üîÑ Verificaci√≥n ${i}/${A} del estado del pago...`);const n=document.querySelector('iframe[name*="oppwa"], iframe[src*="oppwa"], iframe[src*="datafast"]');n&&console.log("üñºÔ∏è iFrame de pago detectado:",{name:n.getAttribute("name"),src:n.getAttribute("src"),visible:n.style.display!=="none"});const v=document.querySelector("form.paymentWidgets");if(v){const w=v.getAttribute("action");if(w&&w.includes("resourcePath")){console.log("üìù Formulario actualizado con resourcePath:",w),clearInterval(l);const W=new URLSearchParams(w.split("?")[1]).get("resourcePath");W&&(console.log("üéØ ResourcePath extra√≠do:",W),localStorage.setItem("datafast_resource_path",W),setTimeout(()=>{console.log("üöÄ Redirigiendo manualmente al resultado..."),window.location.href=w},2e3))}}if(i>=3){const w=localStorage.getItem("datafast_checkout_id"),V=localStorage.getItem("datafast_transaction_id");if(w&&V)try{const F=await(await fetch(`/api/datafast/verify-payment/${V}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`}})).json();console.log(`üìä Estado del pago (intento ${i}):`,F.data?.payment_status),F.status===k.SUCCESS&&F.data?.payment_status==="completed"&&(console.log("üéâ Pago completado exitosamente!"),clearInterval(l),window.location.href=`/datafast-result?status=success&transactionId=${V}`)}catch(W){console.error(`‚ùå Error verificando estado (intento ${i}):`,W)}}i>=A&&(console.log("‚è∞ Se alcanz√≥ el l√≠mite de verificaciones"),clearInterval(l))},3e3)},onLoadThreeDSecure:function(){console.log("üîê Widget Datafast: Cargando 3D Secure...")},onBeforeRedirectToResult:function(p){return console.log("üîÑ Widget Datafast: Redirigiendo a p√°gina de resultado..."),console.log("üîó Datos completos de redirecci√≥n:",p),console.log("üîç DEBUG Redirect - Keys:",p?Object.keys(p):"null"),console.log("üîç DEBUG Redirect - JSON:",JSON.stringify(p,null,2)),p&&p.resourcePath&&(localStorage.setItem("datafast_resource_path",p.resourcePath),console.log("üíæ ResourcePath guardado en localStorage:",p.resourcePath)),!0},onChangeBrand:function(p){console.log("üí≥ Widget Datafast: Marca de tarjeta detectada:",p.brand),console.log("üí≥ Datos completos del evento:",p)},onError:function(p){console.error("‚ùå Widget Datafast: Error en el pago",p),console.error("‚ùå Detalles completos del error:",{message:p.message,code:p.code,name:p.name,full:p}),c(k.ERROR,"Error al procesar el pago: "+(p.message||p.code||"Error desconocido"))},onSubmit:function(p){console.log("üìã Widget Datafast: Formulario enviado"),console.log("üìã Datos completos del formulario:",p),console.log("üìã DEBUG Submit - Keys:",p?Object.keys(p):"null"),console.log("üìã DEBUG Submit - JSON:",JSON.stringify(p,null,2));const i=document.querySelector("form.paymentWidgets");if(i){console.log("üìù Formulario encontrado:"),console.log("   - Action:",i.getAttribute("action")),console.log("   - Method:",i.getAttribute("method")),console.log("   - Target:",i.getAttribute("target"));const A=document.querySelector('iframe[name*="oppwa"]');A&&console.log("üñºÔ∏è iFrame de pago encontrado:",A)}return!0},style:"card",locale:"es",labels:{cvv:"CVV",cardHolder:"Nombre (igual que en la tarjeta)"}};const T=void 0,H=document.createElement("script");if(H.id="datafast-widget-script",N?.widget_url)H.src=N.widget_url,console.log("üìå Usando widget_url del backend:",N.widget_url);else{const p="https://eu-test.oppwa.com/v1/paymentWidgets.js";H.src=`${p}?checkoutId=${h}`,console.log("‚ö†Ô∏è Usando fallback URL con checkoutId:",H.src)}H.async=!0,H.onload=()=>{console.log("‚úÖ Script de widget Datafast cargado exitosamente"),setTimeout(()=>{const p=document.querySelectorAll("form.paymentWidgets");console.log("üìù Formularios de pago encontrados:",p.length),p.length===0?console.warn("‚ö†Ô∏è No se encontraron formularios con clase 'paymentWidgets'"):p.forEach((A,l)=>{console.log(`üìã Formulario ${l+1}:`,{action:A.getAttribute("action"),method:A.getAttribute("method"),"data-brands":A.getAttribute("data-brands")})});const i=document.querySelectorAll('script[src*="techlab-cdn"], script[src*="oppwa"]');console.log("üìú Scripts de Datafast cargados:",i.length),i.forEach(A=>{console.log("  - ",A.src)})},1e3)},H.onerror=p=>{console.error("‚ùå Error al cargar script del widget:",p),c(k.ERROR,"Error al cargar el formulario de pago. Por favor, recargue la p√°gina.")},document.head.appendChild(H),console.log("üìå Script del widget a√±adido al DOM:",H.src)}catch(S){console.error("Error al configurar widget:",S),c(k.ERROR,"Error al configurar el formulario de pago")}},oe=!1;return E?e.jsx("div",{className:"datafast-payment-widget",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Pagar con Datafast"}),e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-blue-800",children:"Informaci√≥n del pedido:"}),e.jsxs("p",{className:"text-blue-700",children:["Monto: $",J?.total?.toFixed(2)||N?.amount||o?.total]}),e.jsxs("p",{className:"text-blue-700",children:["ID: ",N?.transaction_id]})]}),e.jsx("div",{className:"min-h-[400px] border border-gray-200 rounded-lg p-4",children:e.jsx("form",{className:"paymentWidgets","data-brands":"VISA MASTER AMEX DINERS DISCOVER",children:!R&&e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"Cargando formulario de pago..."})]})})})}),e.jsxs("div",{className:"mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-yellow-800 mb-2",children:"Datos de prueba para usar:"}),e.jsxs("div",{className:"text-sm text-yellow-700 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Tarjeta VISA:"})," 4200 0000 0000 0000"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fecha:"})," 07/26"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"CVV:"})," 246"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Titular:"})," ",_.given_name," ",_.surname]}),e.jsxs("p",{className:"text-xs mt-2 text-blue-600",children:[e.jsx("strong",{children:"Fase 2:"})," Credenciales de testing avanzado con transacciones reales limitadas"]})]})]}),oe,e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:()=>{j(!1),$(!0),z(!1);const h=document.getElementById("datafast-widget-script");h&&h.remove()},disabled:y,className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors",children:"Volver"})})]})}):D?e.jsx("div",{className:"datafast-form",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Informaci√≥n para Datafast"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre *"}),e.jsx("input",{type:"text",value:_.given_name,onChange:h=>U("given_name",h.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Segundo Nombre"}),e.jsx("input",{type:"text",value:_.middle_name,onChange:h=>U("middle_name",h.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Apellido *"}),e.jsx("input",{type:"text",value:_.surname,onChange:h=>U("surname",h.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tel√©fono *"}),e.jsx("input",{type:"text",value:_.phone,onChange:h=>U("phone",h.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",placeholder:"0999999999"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"C√©dula * (10 d√≠gitos)"}),e.jsx("input",{type:"text",value:_.doc_id,onChange:h=>{const S=h.target.value.replace(/\D/g,"").slice(0,13);U("doc_id",S)},className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",placeholder:"1234567890 (si ingresa RUC se extraer√° autom√°ticamente la c√©dula)",maxLength:13})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Direcci√≥n *"}),e.jsx("input",{type:"text",value:_.address,onChange:h=>U("address",h.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ciudad *"}),e.jsx("input",{type:"text",value:_.city,onChange:h=>U("city",h.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Pa√≠s *"}),e.jsxs("select",{value:_.country,onChange:h=>U("country",h.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",children:[e.jsx("option",{value:"EC",children:"Ecuador"}),e.jsx("option",{value:"CO",children:"Colombia"}),e.jsx("option",{value:"PE",children:"Per√∫"}),e.jsx("option",{value:"US",children:"Estados Unidos"})]})]})]}),e.jsxs("div",{className:"mt-6 flex gap-4",children:[e.jsx("button",{onClick:re,disabled:y,className:"flex-1 bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-md transition-colors disabled:opacity-50 flex items-center justify-center",children:y?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Creando checkout..."]}):"Continuar con Datafast"}),e.jsx("button",{onClick:()=>$(!1),disabled:y,className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors",children:"Cancelar"})]})]})}):e.jsxs("div",{className:"datafast-payment-button",children:[e.jsxs("button",{onClick:()=>$(!0),disabled:y||!o||o.items.length===0,className:"w-full transition-all duration-200 transform hover:scale-101 bg-[#003c58] border-1 hover:bg-[#00B86E] text-white font-medium py-3 px-4 rounded-md disabled:opacity-50 flex items-center justify-center",children:[e.jsx("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"})}),"Pagar con Datafast"]}),(!o||o.items.length===0)&&e.jsx("p",{className:"mt-2 text-sm text-gray-500 text-center",children:"Agrega productos al carrito para continuar"})]})},lt=()=>{const u=Ae(),{cart:t,clearCart:s,showNotification:a,appliedDiscount:o}=_e(),{user:r}=ye(),[c,d]=g.useState(!1),y=new Pe,b={name:"",identification:"",street:"",city:"",state:"",postalCode:"",country:"Ecuador",phone:""},{handleError:x}=Ze({showNotification:a,context:"CheckoutPage"}),{optimisticCartRemove:I}=Ye(),[E,j]=g.useState("credit_card"),[N,M]=g.useState(b),[D,$]=g.useState(b),[R,z]=g.useState(!0),[J,q]=g.useState({method:"credit_card",card_number:"",card_expiry:"",card_cvc:""}),[_,Q]=g.useState({}),[X,U]=g.useState(!1),[Y,re]=g.useState(null),[ne,oe]=g.useState(8),[,h]=g.useState("forms_filling"),[S,T]=g.useState(null),[H,p]=g.useState(!1),[i,A]=g.useState({items:[],totals:{subtotal:0,originalSubtotal:0,sellerDiscounts:0,volumeDiscounts:0,totalDiscounts:0,couponDiscount:0,tax:0,shipping:0,total:0,freeShipping:!1},stockIssues:[],checkoutItems:[]});g.useEffect(()=>{(async()=>{if(!t?.items?.length){A({items:[],totals:{subtotal:0,originalSubtotal:0,sellerDiscounts:0,volumeDiscounts:0,totalDiscounts:0,couponDiscount:0,tax:0,shipping:0,total:0,freeShipping:!1},stockIssues:[],checkoutItems:[]});return}console.log("üîÑ CheckoutPage: Calculando descuentos con configuraci√≥n din√°mica");const C=await Promise.all(t.items.map(async P=>{const ee=await ot(P),xe=P.product?.stockAvailable||P.product?.stock||0,$e=P.quantity>xe||!P.product?.is_in_stock;return{...P,discount:ee,itemTotal:ee.finalPricePerUnit*P.quantity,availableStock:xe,hasStockIssue:$e}}));console.log("‚úÖ CheckoutPage: Descuentos calculados para",C.length,"items");const O=C.filter(P=>P.hasStockIssue).map(P=>({productName:P.product?.name||"Producto",requested:P.quantity,available:P.availableStock,isOutOfStock:!P.product?.is_in_stock}));console.log("üîç FLUJO CHECKOUT - Calculando totales"),console.log("üìä Items en checkout:",t.items.length),console.log("üìä Cup√≥n en checkout:",o?.discountCode?.code||"NINGUNO");const L=await Ne.calculateCheckoutTotals(t.items,o,!0);console.log("üéØ TOTAL CHECKOUT:",L.total);const K=await Ne.prepareItemsForCheckout(t.items,o,!0);A({items:C,totals:L,stockIssues:O,checkoutItems:K})})()},[t?.items,t?.total,t?.subtotal,o]);const l=m=>typeof m.stockAvailable=="number"?m.stockAvailable:typeof m.stock=="number"?m.stock:0,n=()=>{if(!t?.items)return{valid:!0,errors:[]};const m=[];return t.items.forEach(C=>{const O=l(C.product);C.product?.is_in_stock?C.quantity>O&&m.push(`${C.product?.name||"Producto"}: solo hay ${O} unidades disponibles (solicitaste ${C.quantity})`):m.push(`${C.product?.name||"Producto"} est√° agotado`)}),{valid:m.length===0,errors:m}};g.useEffect(()=>{if(r){const m={name:`${r.name}`,street:r.address||"",city:r.city||"",state:r.state||r.province||"",postalCode:r.postal_code||r.zip_code||"",country:r.country||"Ecuador",phone:r.phone||""};M(m),$(m)}},[r]);const v=m=>{console.log("Pago exitoso:",m)},w=m=>{console.error("Error:",m)};g.useEffect(()=>{if(X&&Y){console.log("‚úÖ Order complete - skipping cart validation to show receipt");return}if(!t||t.items.length===0){a(k.ERROR,"El carrito est√° vac√≠o"),u("/cart");return}const m=n();m.valid||(console.warn("‚ö†Ô∏è Problemas de stock detectados:",m.errors),m.errors.length>0&&a(k.WARNING,`Problema de stock: ${m.errors[0]}`))},[t,u,a,X,Y]),g.useEffect(()=>{if(X){oe(8);const m=setInterval(()=>{oe(C=>C<=1?(clearInterval(m),setTimeout(()=>{console.log("üîÑ Auto-redirecting to orders page after 8 seconds"),u("/orders")},0),0):C-1)},1e3);return()=>clearInterval(m)}},[X,u]);const V=m=>{j(m),q({...J,method:m==="deuna"?"transfer":"credit_card"})},W=(m,C)=>{const O={...N,[m]:C};M(O),R&&$(O)},F=(m,C)=>{$({...D,[m]:C})},f=(m,C)=>{if(q({...J,[m]:C}),C.trim()&&_[m]){const O={..._};delete O[m],Q(O)}},le=()=>{const m={},C=(L,K)=>{["name","identification","street","city","state","country","phone"].forEach(ee=>{L[ee]||(m[`${K}${ee}`]=`El campo ${ee.replace("_"," ")} es obligatorio`),ee==="name"&&L[ee]&&L[ee].trim().split(/\s+/).length<2&&(m[`${K}${ee}`]="Debe ingresar al menos un nombre y un apellido separados por espacio")})};C(N,"shipping"),R||C(D,"billing"),Q(m);const O=Object.keys(m).length===0;return O?console.log("‚úÖ VALIDACI√ìN DE DIRECCIONES EXITOSA"):(console.log("‚ùå VALIDACI√ìN FALL√ì - Errores encontrados:",m),console.log("üìä Estado actual de direcciones:"),console.log("   - useSameAddress:",R),console.log("   - shippingAddress:",N),R||console.log("   - billingAddress:",D)),O},Te=(m,C)=>(console.log("üîÑ Combinando datos del cart con c√°lculos validados (estrategia h√≠brida)"),m.map((O,L)=>{const K=C[L],P={product_id:O.productId||O.product_id,name:O.product?.name||`Product ${O.productId||O.product_id}`,subtotal:K.price*K.quantity,quantity:K.quantity,price:K.price,original_price:K.original_price||K.base_price,discount_percentage:K.volume_discount_percentage||0};return console.log(`   Item ${L+1}: ${P.name} - $${P.price} x ${P.quantity}`),P})),Oe=async()=>{console.log("üîç VALIDACI√ìN DE CHECKOUT: Iniciando validaci√≥n centralizada");const m=n();if(!m.valid)return console.log("‚ùå Validaci√≥n de stock fall√≥:",m.errors),m.errors.forEach(C=>{a(k.ERROR,C)}),a(k.WARNING,"Por favor, ajusta las cantidades en tu carrito antes de continuar"),!1;if(!le())return console.log("‚ùå Validaci√≥n de direcciones fall√≥"),a(k.ERROR,"Por favor, completa todos los campos de direcci√≥n obligatorios"),!1;if(!r?.id)return a(k.ERROR,"Debes iniciar sesi√≥n para completar la compra"),!1;console.log("‚úÖ VALIDACI√ìN EXITOSA: Creando objeto temporal de checkout");try{d(!0);const C=new Date,O=`checkout_${r.id}_${C.getTime()}`,L={userId:r.id,shippingData:{name:N.name||"",email:r.email||"",phone:N.phone||"",street:N.street||"",city:N.city||"",state:N.state||"",country:N.country||"",postal_code:N.postalCode||"",identification:N.identification||""},billingData:{name:(R?N:D).name||"",email:r.email||"",phone:(R?N:D).phone||"",street:(R?N:D).street||"",city:(R?N:D).city||"",state:(R?N:D).state||"",country:(R?N:D).country||"",postal_code:(R?N:D).postalCode||"",identification:(R?N:D).identification||"",same_as_shipping:R},items:Te(t?.items||[],i.checkoutItems),totals:{subtotal_original:i.totals.originalSubtotal,subtotal_with_discounts:i.totals.subtotal,seller_discounts:i.totals.sellerDiscounts,volume_discounts:i.totals.volumeDiscounts,coupon_discount:i.totals.couponDiscount,total_discounts:i.totals.totalDiscounts,iva_amount:i.totals.tax,shipping_cost:i.totals.shipping,free_shipping:i.totals.freeShipping,free_shipping_threshold:50,final_total:i.totals.total},discountCode:o?.discountCode?.code,discountInfo:o?{code:o.discountCode.code,discount_percentage:o.discountCode.discount_percentage,discount_amount:i.totals.couponDiscount}:void 0,timestamp:C.toISOString(),sessionId:O,validatedAt:C.toISOString(),expiresAt:new Date(C.getTime()+30*60*1e3).toISOString()};console.log("üíæ Almacenando CheckoutData en backend (arquitectura centralizada)...");const K={shippingData:L.shippingData,billingData:L.billingData,items:L.items,totals:L.totals,sessionId:L.sessionId,discountCode:L.discountCode,discountInfo:L.discountInfo},P=await y.storeCheckoutData(K);if(!P.success)throw new Error(P.message||"Error al almacenar datos de checkout");return console.log("‚úÖ CheckoutData almacenado en backend:",{sessionId:P.data.session_id,expiresAt:P.data.expires_at,finalTotal:P.data.final_total}),T(L),h("forms_validated"),p(!0),console.log("‚úÖ OBJETO TEMPORAL CREADO Y ALMACENADO:",{sessionId:L.sessionId,userId:L.userId,total:L.totals.final_total,itemsCount:L.items.length,expiresAt:L.expiresAt,backendSessionId:P.data.session_id}),a(k.SUCCESS,"Formularios validados y datos seguros almacenados. Selecciona tu m√©todo de pago preferido."),!0}catch(C){return console.error("‚ùå Error creando objeto temporal:",C),x(C,"Error validando los datos. Por favor, intenta de nuevo."),!1}finally{d(!1)}},ke=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"Resumen del pedido"}),i.stockIssues.length>0&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(We,{size:18,className:"text-red-600 mr-2 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-red-800 text-sm mb-2",children:"Problemas de stock detectados"}),e.jsx("div",{className:"space-y-1",children:i.stockIssues.map((m,C)=>e.jsxs("div",{className:"text-xs text-red-700",children:[e.jsxs("strong",{children:[m.productName,":"]})," ",m.isOutOfStock?"Producto agotado":`Solo ${m.available} disponibles (solicitaste ${m.requested})`]},C))}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{onClick:()=>u("/cart"),className:"text-xs text-red-600 underline hover:no-underline",children:"Ir al carrito para ajustar cantidades"})})]})]})}),i.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-green-800 text-sm",children:"¬°Descuentos Aplicados!"}),e.jsxs("div",{className:"text-xs text-green-600 mt-1 space-y-1",children:[i.totals.sellerDiscounts>0&&e.jsxs("p",{children:["Descuentos del vendedor: ",B(i.totals.sellerDiscounts)]}),i.totals.volumeDiscounts>0&&e.jsxs("p",{children:["Descuentos por volumen: ",B(i.totals.volumeDiscounts)]})]})]}),e.jsx("div",{className:"text-lg font-bold text-green-600",children:B(i.totals.totalDiscounts)})]})}),e.jsx("div",{className:"space-y-3 mb-6",children:i.items.map((m,C)=>e.jsxs("div",{className:`flex items-center justify-between py-2 border-b border-gray-100 ${m.hasStockIssue?"bg-red-50 px-2 rounded":""}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h4",{className:`text-sm font-medium ${m.hasStockIssue?"text-red-900":"text-gray-900"}`,children:[m.product?.name||`Producto ${m.productId}`,m.hasStockIssue&&e.jsx("span",{className:"ml-2 text-xs text-red-600",children:"‚ö†Ô∏è"})]}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:["Cantidad: ",m.quantity]}),m.discount.sellerDiscountAmount>0&&e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded flex items-center",children:[e.jsx(ge,{size:10,className:"mr-1"}),"Seller: ",m.product?.discount_percentage||0,"% OFF"]}),m.discount.volumeDiscountAmount>0&&e.jsxs("span",{className:"text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded flex items-center",children:[e.jsx(Ee,{size:10,className:"mr-1"}),"Volumen: ",m.discount.discountPercentage,"% OFF"]})]}),m.discount.hasDiscount&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Precio unitario: ",B(m.discount.finalPricePerUnit),e.jsx("span",{className:"line-through text-gray-400 ml-1",children:B(m.discount.originalPrice)}),m.discount.savingsTotal>0&&e.jsxs("span",{className:"text-green-600 ml-1",children:["(Ahorras: ",B(m.discount.savingsTotal),")"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("span",{className:`text-sm font-medium ${m.hasStockIssue?"text-red-900":"text-gray-900"}`,children:B(m.itemTotal)})})]},C))}),e.jsxs("div",{className:"space-y-3 border-t border-gray-200 pt-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal (con descuentos):"}),e.jsx("span",{className:"font-medium",children:B(i.totals.subtotal)})]}),i.totals.sellerDiscounts>0&&e.jsxs("div",{className:"flex justify-between text-sm text-blue-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(ge,{size:14,className:"mr-1"}),"Descuentos del vendedor:"]}),e.jsxs("span",{className:"font-medium",children:["-",B(i.totals.sellerDiscounts)]})]}),i.totals.volumeDiscounts>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(Ee,{size:14,className:"mr-1"}),"Descuentos por volumen:"]}),e.jsxs("span",{className:"font-medium",children:["-",B(i.totals.volumeDiscounts)]})]}),o&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(ge,{size:14,className:"mr-1"}),"C√≥digo de descuento (",o.discountCode.code,"):"]}),e.jsxs("span",{className:"font-medium",children:["-",B(i.totals.couponDiscount||0)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"IVA (15%):"}),e.jsx("span",{className:"font-medium",children:B(i.totals.tax)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Env√≠o:"}),e.jsx("span",{className:"font-medium",children:i.totals.freeShipping?"Gratis":B(i.totals.shipping)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t border-gray-200 pt-3",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:B(i.totals.total)})]}),i.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3 mt-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Total ahorrado:"}),e.jsx("span",{className:"text-lg font-bold text-green-600",children:B(i.totals.totalDiscounts)})]})})]})]});return X&&Y?e.jsx("div",{className:"container mx-auto px-4 py-10",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8 max-w-3xl mx-auto",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-10 w-10 text-green-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("h2",{className:"text-3xl font-bold text-gray-800 mb-4",children:"¬°Pago con DeUna completado!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Tu pago se proces√≥ correctamente y tu pedido est√° siendo preparado. Recibir√°s un correo electr√≥nico con los detalles."}),i.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(ge,{className:"h-5 w-5 text-green-600 mr-2"}),e.jsxs("span",{className:"text-green-800 font-medium",children:["¬°Has ahorrado ",B(i.totals.totalDiscounts),"!"]})]})})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-4 pb-2 mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Detalles del pedido:"}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"N√∫mero de orden:"}),e.jsx("span",{className:"font-medium",children:Y.order_number})]}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Total:"}),e.jsx("span",{className:"font-medium",children:B(Y.total||i.totals.total)})]}),i.totals.totalDiscounts>0&&e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Total ahorrado:"}),e.jsx("span",{className:"font-medium text-green-600",children:B(i.totals.totalDiscounts)})]}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Estado del pago:"}),e.jsx("span",{className:`font-medium ${Y.payment_status==="paid"?"text-green-600":"text-yellow-600"}`,children:Y.payment_status==="paid"?"Pagado":Y.payment_status})]})]}),e.jsx("div",{className:"text-center mb-6",children:e.jsxs("p",{className:"text-sm text-gray-500",children:["Ser√°s redirigido a tus pedidos en"," ",e.jsx("span",{className:"font-medium text-primary-600",children:ne})," ","segundos..."]})}),e.jsxs("div",{className:"flex justify-center space-x-4 mt-6",children:[e.jsx("button",{onClick:()=>u("/"),className:"px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:"Volver a la tienda"}),e.jsx("button",{onClick:()=>u("/orders"),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"Ver mis pedidos"})]})]})}):e.jsxs("div",{className:"container mx-auto px-4 py-10",children:[e.jsx("div",{className:"flex justify-between items-center mb-8",children:e.jsx("h1",{className:"text-3xl font-bold",children:"Finalizar compra"})}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-8",children:[e.jsxs("div",{className:"lg:w-2/3",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"Informaci√≥n de env√≠o y facturaci√≥n"}),e.jsx("div",{className:"mb-4",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 text-primary-600",checked:R,onChange:m=>{const C=m.target.checked;z(C),C||$({...N})}}),e.jsx("span",{className:"ml-2 text-gray-700",children:"Usar la misma direcci√≥n para facturaci√≥n"})]})}),e.jsx(we,{title:R?"Direcci√≥n de Env√≠o y Facturaci√≥n":"Direcci√≥n de Env√≠o",address:N,onAddressChange:W,errors:_}),!R&&e.jsx("div",{className:"mt-8 pt-8 border-t border-gray-200",children:e.jsx(we,{title:"Direcci√≥n de Facturaci√≥n",address:D,onAddressChange:F,errors:_})})]}),H&&S&&e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"M√©todo de pago"}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-4 h-4 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"text-sm text-green-800 font-medium",children:"Datos validados correctamente"})]}),e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["Total a pagar: ",B(S.totals.final_total)]})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[e.jsx("button",{type:"button",onClick:()=>V("credit_card"),className:`flex items-center border rounded-lg px-4 py-3 ${E==="credit_card"?"border-primary-600 bg-primary-50 text-primary-600":"border-gray-300 hover:bg-gray-50"}`,children:e.jsx("span",{children:"Tarjeta de cr√©dito"})}),e.jsx("button",{type:"button",onClick:()=>V("deuna"),className:`flex items-center border rounded-lg px-4 py-3 ${E==="deuna"?"border-primary-600 bg-primary-50 text-primary-600":"border-gray-300 hover:bg-gray-50"}`,children:e.jsx("span",{children:"Pago con Deuna!"})})]}),E==="credit_card"&&e.jsx(rt,{paymentInfo:J,errors:_,onChange:f,content:e.jsx(it,{onSuccess:v,onError:w,checkoutData:S})}),E==="deuna"&&e.jsx(nt,{checkoutData:S,onPaymentSuccess:async m=>{console.log("‚úÖ DeUna payment successful, processing completion:",m);try{if(!m||!m.payment_id)throw new Error("Datos de pago de DeUna incompletos");let C=null,O=0;const L=3;for(;!C&&O<L;){O++,console.log(`üîÑ Intento ${O}/${L} - Verificando orden creada por webhook...`);try{await new Promise(P=>setTimeout(P,1e3*O)),C={order_id:m.order_id||`DEUNA-${Date.now()}`,order_number:m.payment_id,total:S.totals.final_total,payment_status:"paid",payment_method:"deuna",payment_id:m.payment_id,created_via:"deuna_webhook",completed_at:m.completed_at||new Date().toISOString()};break}catch(P){console.warn(`‚ö†Ô∏è Intento ${O} fall√≥:`,P),O>=L&&(C={order_id:m.payment_id||`DEUNA-${Date.now()}`,order_number:m.payment_id||`DEUNA-${Date.now()}`,total:S.totals.final_total,payment_status:"processing",payment_method:"deuna",payment_id:m.payment_id,created_via:"deuna_frontend_fallback",completed_at:new Date().toISOString()},console.log("üÜò Usando datos de fallback para mostrar recibo"))}}console.log("üéØ Setting orderComplete to true and orderDetails"),re(C),U(!0);const K=t?.items.reduce((P,ee)=>P+ee.quantity,0)||0;for(let P=0;P<K;P++)I();s(),C&&C.created_via==="deuna_frontend_fallback"?a(k.WARNING,"Pago completado. Si no aparece en tus √≥rdenes inmediatamente, revisa en unos minutos."):a(k.SUCCESS,"¬°Pago completado exitosamente con DeUna!"),console.log("‚úÖ DeUna payment completion processed successfully - should show receipt now"),console.log("üìä Order details set:",{order_id:C?.order_id,total:C?.total,created_via:C?.created_via})}catch(C){console.error("‚ùå Error processing DeUna payment completion:",C);const O={order_id:m?.payment_id||`DEUNA-ERROR-${Date.now()}`,order_number:m?.payment_id||`ERROR-${Date.now()}`,total:S.totals.final_total,payment_status:"unknown",payment_method:"deuna",payment_id:m?.payment_id||"unknown",created_via:"deuna_error_fallback",completed_at:new Date().toISOString(),error_message:"Error procesando la confirmaci√≥n. Verifica tus √≥rdenes."};re(O),U(!0),a(k.ERROR,"Error procesando la confirmaci√≥n del pago. Si el pago fue exitoso, aparecer√° en tus √≥rdenes."),x(C,"Error procesando la confirmaci√≥n del pago. Por favor, verifica tus √≥rdenes.")}},onPaymentError:m=>{console.error("‚ùå DeUna payment error:",m),x(new Error(m),"Error en el pago con DeUna. Por favor, intenta de nuevo.")}})]}),!H&&e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"M√©todo de pago"}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsx("p",{className:"text-blue-800 text-sm",children:"Los m√©todos de pago se mostrar√°n despu√©s de validar tu informaci√≥n de env√≠o y facturaci√≥n."})})]})]}),e.jsx("div",{className:"lg:w-1/3",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 sticky top-24",children:[e.jsx(ke,{}),H?e.jsx("div",{className:"mt-6 bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-green-800",children:"‚úÖ Datos validados"}),e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Selecciona tu m√©todo de pago para continuar"})]}),e.jsx("button",{onClick:()=>{p(!1),T(null),h("forms_filling")},className:"text-xs text-green-600 underline hover:no-underline",children:"Editar datos"})]})}):e.jsx("button",{onClick:Oe,disabled:c||i.stockIssues.length>0,className:"mt-6 w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-4 rounded-md transition-colors disabled:opacity-50 flex items-center justify-center",children:c?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Validando datos..."]}):i.stockIssues.length>0?"Resuelve problemas de stock":`Validar datos y continuar - ${B(i.totals.total)}`}),i.stockIssues.length>0&&e.jsx("div",{className:"mt-3 text-xs text-center text-red-600",children:"‚ö†Ô∏è Ajusta las cantidades en tu carrito antes de continuar"}),e.jsxs("p",{className:"mt-4 text-xs text-gray-500 text-center",children:['Al hacer clic en "Finalizar compra", aceptas nuestros'," ",e.jsx("a",{href:"/terms",className:"text-primary-600 hover:underline",children:"T√©rminos y condiciones"})," ","y"," ",e.jsx("a",{href:"/privacy",className:"text-primary-600 hover:underline",children:"Pol√≠tica de privacidad"}),"."]})]})})]})]})},bt=Object.freeze(Object.defineProperty({__proto__:null,default:lt},Symbol.toStringTag,{value:"Module"}));export{ft as C,be as E,ht as a,_e as b,Ze as c,ot as d,yt as e,bt as f,xt as i,Ye as u};
//# sourceMappingURL=checkout-chunk-BfPZCzS8.js.map
