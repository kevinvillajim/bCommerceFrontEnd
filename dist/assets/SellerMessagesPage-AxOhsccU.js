import{d as re,h as te,u as ae,r as a,j as s}from"./index-DmNDOrWy.js";import{u as ne}from"./useChat-CTw3ZN82.js";import{u as oe,C as le,a as ie,b as ce,M as de}from"./ChatFilterToast-DPT1PUcO.js";import{M as U}from"./message-square-C6QrtgNg.js";import{A as ue}from"./arrow-left-sVt-VeaA.js";import{R as me}from"./refresh-cw-BOPCg90x.js";import"./errorHandler-ugMJT1nb.js";import"./search-CbEKe7UQ.js";import"./funnel-CAFb7hhq.js";import"./user-nLts-VnI.js";import"./store-BV-a-_hn.js";import"./package-CIRlwNqy.js";import"./dateUtils-CfeftkgG.js";import"./check-CHNPnXXq.js";import"./loader-circle-D95e5ckH.js";import"./send-BCk3tQWd.js";import"./triangle-alert-B75WTV0P.js";import"./ban-DWyykPX6.js";import"./shield-C7SSAF2o.js";const Ae=()=>{const c=re(),{chatId:l}=te(),{user:u}=ae(),[C,V]=a.useState(""),[L,q]=a.useState("all"),[T,B]=a.useState(!1),[v,_]=a.useState(window.innerWidth<768),[R,m]=a.useState(!l),[w,x]=a.useState(!1),[D,H]=a.useState("Cargando conversaciones..."),j=a.useRef(!1),b=a.useRef(l),$=a.useRef(0),F=a.useRef(!0),i=a.useRef({}),t=a.useRef(null),{showSellerStrike:W,showSellerBlocked:G,NotificationComponent:J}=oe(),{chats:y,selectedChat:o,messages:K,loading:f,error:P,fetchChats:p,fetchChatMessages:M,sendMessage:O,updateChatStatus:Q,setSelectedChat:d,startMessagesPolling:E,stopMessagesPolling:N,markAllAsRead:g}=ne(!0);a.useEffect(()=>{const e=()=>{_(window.innerWidth<768)};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),a.useEffect(()=>{!j.current&&u?.id&&(console.log("Cargando lista inicial de chats para vendedor..."),x(!0),p().then(e=>{if(j.current=!0,x(!1),console.log(`Lista inicial de ${e.length} chats cargada`),l&&e.length>0){const r=parseInt(l,10),n=e.find(h=>h.id===r);n?(console.log(`Chat ${r} encontrado en carga inicial, seleccionando...`),d(n),m(!1),t.current=r,n.unreadCount&&n.unreadCount>0&&!i.current[r]&&(i.current[r]=!0,setTimeout(()=>{g(r).catch(console.error)},1e3))):(console.log(`Chat ${r} no encontrado en lista inicial, intentando carga directa...`),k(r))}}).catch(e=>{console.error("Error al cargar chats iniciales:",e),x(!1),j.current=!0}))},[p,l,d,u?.id,g]);const k=a.useCallback(async e=>{if(t.current===e){console.log(`Chat ${e} ya está seleccionado, omitiendo carga.`);return}if(u?.id){console.log(`Intentando cargar chat específico ${e}...`),x(!0),H(`Cargando conversación #${e}...`),$.current+=1;try{const r=y.find(n=>n.id===e);if(r)console.log(`Chat ${e} encontrado en la lista, seleccionando...`),d(r),m(!1),t.current=e,E(e),r.unreadCount&&r.unreadCount>0&&!i.current[e]&&(i.current[e]=!0,setTimeout(()=>{g(e).catch(console.error)},1e3));else{console.log(`Chat ${e} no encontrado en la lista, cargando desde API...`);try{if(await M(e))console.log(`Chat ${e} cargado correctamente desde API`),m(!1),t.current=e,E(e),i.current[e]||(i.current[e]=!0,setTimeout(()=>{g(e).catch(console.error)},1e3));else if(console.warn(`Chat ${e} no encontrado en API`),$.current>=3)c("/seller/messages",{replace:!0}),t.current=null;else{const S=(await p()).find(A=>A.id===e);S?(d(S),m(!1),t.current=e):(c("/seller/messages",{replace:!0}),t.current=null)}}catch(n){console.error(`Error al cargar chat ${e} desde API:`,n),c("/seller/messages",{replace:!0}),t.current=null}}}catch(r){console.error(`Error al cargar chat ${e}:`,r),c("/seller/messages",{replace:!0}),t.current=null}finally{x(!1)}}},[y,M,c,d,p,E,g,u?.id]);a.useEffect(()=>{if(!(!j.current||!u?.id)){if(F.current){F.current=!1;return}if(!(l===b.current&&t.current!==null))if(N(),b.current=l,$.current=0,l){const e=parseInt(l,10);if(isNaN(e)){c("/seller/messages",{replace:!0}),t.current=null;return}t.current!==e&&(i.current[e]=!1,k(e))}else t.current!==null&&(d(null),t.current=null,m(!0))}},[l,k,c,d,N,u?.id]);const X=y.filter(e=>{const r=L==="all"||e.status===L,n=T?e.unreadCount&&e.unreadCount>0:!0,h=C===""||e.product?.name&&e.product.name.toLowerCase().includes(C.toLowerCase())||e.user?.name&&e.user.name.toLowerCase().includes(C.toLowerCase());return r&&n&&h}),Y=e=>{if(e&&e.id){if(t.current===e.id){console.log(`Chat ${e.id} ya está seleccionado, omitiendo selección.`);return}console.log(`Vendedor seleccionó chat ${e.id}`),N(),c(`/seller/messages/${e.id}`,{replace:!0}),b.current=String(e.id),t.current=e.id,d(e),v&&m(!1),e.unreadCount&&e.unreadCount>0&&!i.current[e.id]&&(i.current[e.id]=!0,setTimeout(()=>{e.id!==void 0&&g(e.id).catch(console.error)},1e3))}},Z=async e=>{console.log("Enviando mensaje como vendedor...");try{const r=await O(e);return r&&o?.id&&await M(o.id),r}catch(r){if(console.error("Error al enviar mensaje:",r),r?.response?.data?.status==="error"){const n=r.response.data,h=n.data?.strike_count||0,S=n.data?.is_blocked||!1,A=n.data?.censored_content;S?G("Tu cuenta ha sido bloqueada por acumular múltiples strikes. Contacta al soporte."):W(n.message,h,A)}return!1}},I=async(e,r)=>(console.log(`Actualizando estado de chat ${e} a ${r}...`),await Q(e,r)),ee=()=>{console.log("Volviendo a lista de chats"),N(),m(!0),c("/seller/messages",{replace:!0}),b.current=void 0,t.current=null},z=()=>{console.log("Refrescando lista de chats"),o&&o.id&&(i.current[o.id]=!1),p().then(()=>{console.log("Lista de chats refrescada")})},se=()=>(f||w)&&!o?s.jsxs("div",{className:"flex flex-col justify-center items-center h-full",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4"}),s.jsx("p",{className:"text-gray-600",children:D})]}):o?s.jsxs(s.Fragment,{children:[s.jsx(ie,{chat:o,isSeller:!0,onUpdateStatus:I,loading:f}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx(ce,{messages:K,loading:f,noMessagesText:"No hay mensajes todavía",currentUserId:u?.id??void 0})}),s.jsx(de,{onSendMessage:Z,isDisabled:o.status!=="active",disabledText:o.status==="closed"?"Esta conversación está cerrada":"Esta conversación está archivada",isLoading:f,chatId:o.id})]}):s.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-4 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4",children:s.jsx(U,{className:"h-8 w-8 text-gray-500"})}),s.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Selecciona una conversación"}),s.jsx("p",{className:"text-gray-500 mt-2 max-w-md",children:y.length>0?"Elige una conversación de la lista para ver los mensajes y responder a tus clientes":"No tienes conversaciones activas. Cuando los clientes inicien conversaciones sobre tus productos, aparecerán aquí."})]});return s.jsxs("div",{className:"container mx-auto p-4",children:[s.jsxs("div",{className:"mb-4 flex justify-between items-center",children:[s.jsxs("h1",{className:"text-2xl font-bold text-gray-900 flex items-center",children:[s.jsx(U,{className:"w-6 h-6 mr-2"}),"Conversaciones con Clientes"]}),s.jsxs("div",{className:"flex space-x-2",children:[v&&o&&!R&&s.jsxs("button",{onClick:ee,className:"px-3 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 flex items-center",children:[s.jsx(ue,{size:16,className:"mr-1"}),"Volver"]}),s.jsxs("button",{onClick:z,className:"px-3 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center",disabled:f||w,children:[s.jsx(me,{size:16,className:`mr-1 ${f||w?"animate-spin":""}`}),"Actualizar"]})]})]}),P&&s.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-4",children:[s.jsx("strong",{className:"font-bold",children:"Error: "}),s.jsx("span",{className:"block sm:inline",children:P}),s.jsx("button",{onClick:z,className:"underline ml-2 text-red-700 hover:text-red-900",children:"Reintentar"})]}),s.jsxs("div",{className:"bg-white rounded-lg shadow-sm flex flex-col md:flex-row overflow-hidden",style:{minHeight:"70vh"},children:[(!v||R)&&s.jsx("div",{className:"w-full md:w-1/3 border-r border-gray-200 flex flex-col",children:s.jsx(le,{chats:X,selectedChatId:o?.id,onSelectChat:Y,loading:f||w,searchTerm:C,onSearchChange:V,statusFilter:L,onStatusFilterChange:q,unreadFilter:T,onUnreadFilterChange:B,isSeller:!0})}),(!v||!R)&&s.jsx("div",{className:"w-full md:w-2/3 flex flex-col",children:se()})]}),s.jsx(J,{})]})};export{Ae as default};
//# sourceMappingURL=SellerMessagesPage-AxOhsccU.js.map
