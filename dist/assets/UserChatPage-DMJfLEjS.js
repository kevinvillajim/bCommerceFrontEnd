import{j as s,M as F,a0 as Z,R as ee}from"./ui-vendor-BUNMIuFe.js";import{u as se,d as ae,r,R as te}from"./react-vendor-Cy458wKG.js";import{u as re}from"./useChat-CLovqvUZ.js";import{u as ne,C as oe,a as ie,b as le,M as ce}from"./chat-chunk-BRsdDZXf.js";import{u as de}from"./ChatFilterToast-DUfxz0BJ.js";import"./admin-chunk-BNcFjXlJ.js";import"./utils-vendor-DeGC_a19.js";import"./seller-chunk-6swISJwY.js";const Ce=()=>{const i=se(),{chatId:o}=ae(),{user:c}=ne(),[h,T]=r.useState(""),[p,U]=r.useState("all"),[S,k]=r.useState(!1),[v,V]=r.useState(window.innerWidth<768),[L,d]=r.useState(!o),[C,f]=r.useState(!1),[I,W]=r.useState("Cargando conversaciones..."),j=r.useRef(!1),w=r.useRef(o),M=r.useRef(0),$=r.useRef(!0),{showUserWarning:B,NotificationComponent:D}=de(),{chats:x,selectedChat:t,messages:H,loading:u,error:A,fetchChats:g,fetchChatMessages:N,sendMessage:q,updateChatStatus:G,setSelectedChat:l,startMessagesPolling:R,stopMessagesPolling:b,markAllAsRead:y}=re();r.useEffect(()=>{const e=()=>{V(window.innerWidth<768)};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),r.useEffect(()=>{!j.current&&c?.id&&(console.log("Cargando lista inicial de chats..."),f(!0),g().then(e=>{if(j.current=!0,f(!1),console.log(`Lista inicial de ${e.length} chats cargada`),o&&e.length>0){const a=parseInt(o,10),n=e.find(m=>m.id===a);n?(console.log(`Chat ${a} encontrado en carga inicial, seleccionando...`),l(n),d(!1)):(console.log(`Chat ${a} no encontrado en lista inicial, intentando carga directa...`),E(a))}}).catch(e=>{console.error("Error al cargar chats iniciales:",e),f(!1),j.current=!0}))},[g,o,l,c?.id]);const E=r.useCallback(async e=>{if(c?.id){console.log(`Intentando cargar chat específico ${e}...`),f(!0),W(`Cargando conversación #${e}...`),M.current+=1;try{const a=x.find(n=>n.id===e);if(a)console.log(`Chat ${e} encontrado en la lista, seleccionando...`),l(a),d(!1),R(e),a.unreadCount&&a.unreadCount>0&&setTimeout(()=>{y(e).catch(console.error)},1e3);else{console.log(`Chat ${e} no encontrado en la lista, cargando desde API...`);try{if(await N(e))console.log(`Chat ${e} cargado correctamente desde API`),d(!1),R(e),setTimeout(()=>{y(e).catch(console.error)},1e3);else if(console.warn(`Chat ${e} no encontrado en API, mostrando lista de chats`),M.current>=3)i("/chats",{replace:!0});else{const z=(await g()).find(Y=>Y.id===e);z?(l(z),d(!1)):i("/chats",{replace:!0})}}catch(n){console.error(`Error al cargar chat ${e} desde API:`,n),i("/chats",{replace:!0})}}}catch(a){console.error(`Error al cargar chat ${e}:`,a),i("/chats",{replace:!0})}finally{f(!1)}}},[x,N,i,l,g,R,y,c?.id]);r.useEffect(()=>{if(!(!j.current||!c?.id)){if($.current){$.current=!1;return}if(!(o===w.current&&t))if(b(),w.current=o,M.current=0,o){const e=parseInt(o,10);if(isNaN(e)){i("/chats",{replace:!0});return}E(e)}else l(null),d(!0)}},[o,E,i,t,l,b,c?.id]);const _=te.useMemo(()=>x.filter(e=>{const a=p==="all"||e.status===p,n=S?(e.unreadCount??0)>0:!0,m=h===""||e.product?.name&&e.product.name.toLowerCase().includes(h.toLowerCase())||e.seller?.storeName&&e.seller.storeName.toLowerCase().includes(h.toLowerCase());return a&&n&&m}),[x,p,S,h]),J=e=>{e&&e.id&&(console.log(`Usuario seleccionó chat ${e.id}`),b(),i(`/chats/${e.id}`,{replace:!0}),w.current=String(e.id),l(e),v&&d(!1),e.unreadCount&&e.unreadCount>0&&setTimeout(()=>{e.id!==void 0&&y(e.id).catch(console.error)},1e3))},K=async e=>{console.log("Enviando mensaje como usuario...");try{const a=await q(e);return a&&t?.id&&await N(t.id),a}catch(a){if(console.error("Error al enviar mensaje:",a),a?.response?.data?.status==="error"){const n=a.response.data,m=n.data?.censored_content;B(n.message,m)}return!1}},O=async(e,a)=>(console.log(`Actualizando estado de chat ${e} a ${a}...`),await G(e,a)),Q=()=>{console.log("Volviendo a lista de chats"),b(),d(!0),i("/chats",{replace:!0}),w.current=void 0},P=()=>{console.log("Refrescando lista de chats"),g(),t&&t.id&&N(t.id)},X=()=>(u||C)&&!t?s.jsxs("div",{className:"flex flex-col justify-center items-center h-full",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4"}),s.jsx("p",{className:"text-gray-600",children:I})]}):t?s.jsxs(s.Fragment,{children:[s.jsx(ie,{chat:t,isSeller:!1,onUpdateStatus:O,loading:u}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx(le,{messages:H,loading:u,noMessagesText:"No hay mensajes todavía",currentUserId:c?.id??void 0})}),s.jsx(ce,{onSendMessage:K,isDisabled:t.status!=="active",disabledText:t.status==="closed"?"Esta conversación está cerrada":"Esta conversación está archivada",isLoading:u,chatId:t.id})]}):s.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-4 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4",children:s.jsx(F,{className:"h-8 w-8 text-gray-500"})}),s.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Selecciona una conversación"}),s.jsx("p",{className:"text-gray-500 mt-2 max-w-md",children:x.length>0?"Elige una conversación de la lista para ver los mensajes y responder":"No tienes conversaciones activas. Puedes iniciar una desde la página de un producto."})]});return s.jsxs("div",{className:"container mx-auto p-6 max-w-7xl",children:[s.jsxs("div",{className:"mb-6 flex justify-between items-center",children:[s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx("div",{className:"h-10 w-10 bg-primary-100 rounded-lg flex items-center justify-center",children:s.jsx(F,{className:"w-5 h-5 text-primary-600"})}),s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Mis Conversaciones"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Gestiona tus chats con vendedores"})]})]}),s.jsxs("div",{className:"flex items-center space-x-3",children:[v&&t&&!L&&s.jsxs("button",{onClick:Q,className:"inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors",children:[s.jsx(Z,{size:16,className:"mr-2"}),"Volver"]}),s.jsxs("button",{onClick:P,className:"inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors shadow-sm",disabled:u||C,children:[s.jsx(ee,{size:16,className:`mr-2 ${u||C?"animate-spin":""}`}),"Actualizar"]})]})]}),A&&s.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg relative mb-6 flex items-start space-x-3",children:[s.jsx("div",{className:"flex-shrink-0",children:s.jsx("svg",{className:"h-5 w-5 text-red-500",viewBox:"0 0 20 20",fill:"currentColor",children:s.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h3",{className:"text-sm font-medium text-red-800",children:"Error al cargar conversaciones"}),s.jsx("p",{className:"text-sm text-red-700 mt-1",children:A}),s.jsx("button",{onClick:P,className:"text-sm text-red-700 hover:text-red-900 underline mt-2 inline-block",children:"Reintentar"})]})]}),s.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row overflow-hidden",style:{minHeight:"75vh"},children:[(!v||L)&&s.jsx("div",{className:"w-full md:w-1/3 border-r border-gray-200 flex flex-col bg-white",children:s.jsx(oe,{chats:_,selectedChatId:t?.id,onSelectChat:J,loading:u||C,searchTerm:h,onSearchChange:T,statusFilter:p,onStatusFilterChange:U,unreadFilter:S,onUnreadFilterChange:k,isSeller:!1,showTabs:!0})}),(!v||!L)&&s.jsx("div",{className:"w-full md:w-2/3 flex flex-col",children:X()})]}),s.jsx(D,{})]})};export{Ce as default};
//# sourceMappingURL=UserChatPage-DMJfLEjS.js.map
