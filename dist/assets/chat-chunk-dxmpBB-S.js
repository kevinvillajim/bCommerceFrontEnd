import{M as ve,e as J,u as me,j as r,S as ge,F as we,h as X,i as te,P as he,$ as q,C as ye,ab as ae,a7 as be,ac as je,ad as Ee,c as Ne,ae as Se,G as ne,E as Ce,af as Ie,ag as Ae,a0 as ke,n as Te}from"./ui-vendor-DEBjJ4HS.js";import{r as l,L as H}from"./react-vendor-Cy458wKG.js";import{b as ee,a as z,c as W,d as Re,f as Me}from"./utils-vendor-DeGC_a19.js";import{L as F,A as Pe}from"./seller-chunk-CL4v7LiS.js";import{a as _,A as U,b as y,e as O,C as V,c as re}from"./admin-chunk-C7Ad4l4I.js";class G{static instance;isInitialized=!1;clientId="581090375629-kds9jjgs2pk60iqe05fmjhpf6pps2nsv.apps.googleusercontent.com";baseApiUrl="http://localhost:8000/api";constructor(){}static getInstance(){return G.instance||(G.instance=new G),G.instance}async authenticateWithGoogle(e){try{return console.log(`üîê Iniciando ${e} con Google...`),console.log("üîç Debug OAuth:",{hostname:window.location.hostname,protocol:window.location.protocol,isProduction:this.isProduction(),baseApiUrl:this.baseApiUrl,clientId:this.clientId.substring(0,20)+"..."}),this.shouldUseRedirect()?(console.log("üîÑ Usando m√©todo redirect (recomendado para producci√≥n)"),this.authenticateWithRedirect(e)):(console.log("üÜï Intentando m√©todo FedCM..."),await this.initialize(),this.authenticateWithFedCM(e))}catch(t){return console.error("‚ùå Error en authenticateWithGoogle:",t),console.log("üîÑ Fallback a m√©todo redirect..."),this.authenticateWithRedirect(e)}}async authenticateWithRedirect(e){try{if(console.log(`üîÑ Usando m√©todo de redirect para ${e}...`),localStorage.setItem("google_oauth_action",e),localStorage.setItem("google_oauth_return_url",window.location.pathname),!this.clientId||!this.baseApiUrl)throw new Error("Configuraci√≥n de Google OAuth incompleta");const t=`${this.baseApiUrl}/auth/google/redirect?action=${e}`;return console.log("üåê Redirigiendo a:",t),window.location.href=t,new Promise(()=>{})}catch(t){return console.error("‚ùå Error en m√©todo de redirect:",t),{success:!1,error:"Error al iniciar autenticaci√≥n con Google"}}}async authenticateWithFedCM(e){try{if(console.log(`üÜï Usando m√©todo FedCM para ${e}...`),!window.google?.accounts?.id)throw new Error("Google Identity Services no est√° disponible");return new Promise(t=>{if(!window.google?.accounts?.id){t({success:!1,error:"Google Identity Services no disponible"});return}window.google.accounts.id.initialize({client_id:this.clientId,callback:async a=>{try{const i=await this.sendCredentialToBackend(a.credential,e);t(i)}catch(i){console.error("‚ùå Error procesando credential:",i),t({success:!1,error:i instanceof Error?i.message:"Error desconocido"})}},auto_select:!1,cancel_on_tap_outside:!0,context:"signin",ux_mode:"popup",itp_support:!0});const s=setTimeout(()=>{t({success:!1,error:"Timeout en la autenticaci√≥n con Google"})},3e4);window.google?.accounts?.id&&window.google.accounts.id.disableAutoSelect(),window.google?.accounts?.id&&window.google.accounts.id.prompt(a=>{console.log("üìä Notification:",a),clearTimeout(s);const i=a.getMomentType?.();i?(i==="dismissed"||i==="skipped")&&(console.log("‚ùå Prompt fue cerrado o saltado (nuevo API)"),t({success:!1,error:"Autenticaci√≥n cancelada por el usuario"})):a.isNotDisplayed?.()?(console.log("‚ùå Prompt no se mostr√≥"),t({success:!1,error:"No se pudo mostrar el prompt de Google"})):a.isSkippedMoment?.()?(console.log("‚è≠Ô∏è Prompt fue omitido"),t({success:!1,error:"Autenticaci√≥n omitida por el usuario"})):a.isDismissedMoment?.()&&(console.log("‚ùå Prompt fue cerrado"),t({success:!1,error:"Autenticaci√≥n cancelada por el usuario"}))})})}catch(t){return console.error("‚ùå Error en m√©todo FedCM:",t),{success:!1,error:t instanceof Error?t.message:"Error en FedCM"}}}async initialize(){if(!this.isInitialized)try{await this.loadGoogleScript(),this.isInitialized=!0,console.log("‚úÖ Google Identity Services inicializado")}catch(e){throw console.error("‚ùå Error inicializando Google Identity Services:",e),e}}async loadGoogleScript(){return new Promise((e,t)=>{if(window.google?.accounts?.id){e();return}const s=document.querySelector('script[src*="accounts.google.com"]');if(s){s.addEventListener("load",()=>e()),s.addEventListener("error",()=>t(new Error("Error cargando script")));return}const a=document.createElement("script");a.src="https://accounts.google.com/gsi/client",a.async=!0,a.defer=!0,a.onload=()=>{setTimeout(()=>e(),200)},a.onerror=()=>{t(new Error("Error cargando script de Google"))},document.head.appendChild(a)})}shouldUseRedirect(){const e=this.isProduction(),t=localStorage.getItem("google_auth_force_redirect")==="true",s=window.location.hostname==="localhost";return e||t||s}isProduction(){return window.location.hostname==="comersia.app"}async sendCredentialToBackend(e,t){try{console.log("üì§ Enviando credential al backend...",{action:t,apiUrl:this.baseApiUrl,credentialLength:e.length});const s=await fetch(`${this.baseApiUrl}/auth/google/authenticate`,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify({token:e,action:t})});console.log("üì• Respuesta del backend:",{status:s.status,statusText:s.statusText,ok:s.ok});const a=await s.json();if(!s.ok)throw new Error(a.message||"Error en la autenticaci√≥n");return console.log("‚úÖ Backend response exitosa"),{success:!0,user:a}}catch(s){return console.error("‚ùå Error enviando credential al backend:",s),{success:!1,error:s instanceof Error?s.message:"Error de comunicaci√≥n"}}}async signOut(){try{window.google?.accounts?.id&&window.google.accounts.id.disableAutoSelect(),localStorage.removeItem("google_oauth_action"),localStorage.removeItem("google_oauth_return_url"),localStorage.removeItem("google_auth_force_redirect"),console.log("‚úÖ Sesi√≥n de Google cerrada")}catch(e){console.warn("Error al cerrar sesi√≥n de Google:",e)}}setAuthMethod(e){console.log("üîß Configurando m√©todo de auth:",e),localStorage.setItem("google_auth_force_redirect",e==="redirect"?"true":"false")}async checkConfiguration(){const e=[],t=[];console.log("üîç Verificando configuraci√≥n de Google OAuth..."),(!this.clientId||this.clientId.includes("your-google-client-id"))&&e.push("Client ID de Google no configurado correctamente"),this.baseApiUrl||e.push("URL del API no configurada"),location.protocol==="https:"||location.hostname==="localhost"||e.push("Google OAuth requiere origen seguro (HTTPS o localhost)"),!window.CredentialsContainer&&!this.isProduction()&&t.push("FedCM no est√° disponible en este navegador"),this.isProduction()&&console.log("üè≠ Producci√≥n detectada - usando m√©todo redirect");try{const i=new Image;i.src="https://accounts.google.com/favicon.ico"}catch{t.push("Posible problema con Content Security Policy")}const a={isConfigured:e.length===0,errors:e,warnings:t};return console.log("üìä Resultado de configuraci√≥n:",a),a}async diagnose(){console.log("üî¨ === DIAGN√ìSTICO GOOGLE OAUTH ===");const e=await this.checkConfiguration();console.log("üåç Entorno:",{hostname:window.location.hostname,protocol:window.location.protocol,userAgent:navigator.userAgent,isProduction:this.isProduction(),shouldUseRedirect:this.shouldUseRedirect()}),console.log("‚öôÔ∏è Configuraci√≥n:",{clientId:this.clientId.substring(0,20)+"...",baseApiUrl:this.baseApiUrl,hasGoogleScript:!!window.google,isConfigured:e.isConfigured}),e.errors.length>0&&console.log("‚ùå Errores:",e.errors),e.warnings.length>0&&console.log("‚ö†Ô∏è Advertencias:",e.warnings),console.log("üíæ LocalStorage:",{oauth_action:localStorage.getItem("google_oauth_action"),return_url:localStorage.getItem("google_oauth_return_url"),force_redirect:localStorage.getItem("google_auth_force_redirect")}),console.log("üî¨ === FIN DIAGN√ìSTICO ===")}}const A=new F;class K{async login(e){try{console.log("AuthService: Realizando solicitud de login");const t=await _.post(U.AUTH.LOGIN,e);if(!t||!t.data)throw new Error("Respuesta del servidor vac√≠a");let s=t.data;if(!s.access_token)throw new Error("Token de acceso no encontrado en la respuesta");return console.log("AuthService: Login exitoso, token recibido"),console.log("Token being saved:",s.access_token.substring(0,10)+"..."),A.setItem(y.storage.authTokenKey,s.access_token),s.user&&A.setItem(y.storage.userKey,s.user),s}catch(t){if(console.error("AuthService: Error de login:",t),O.isAxiosError(t)){const s=t;if(s.response?.status===401){const a=s.response.data?.message||s.response.data?.error;throw new Error(a||"Credenciales incorrectas")}else if(s.response?.status===404){const a=s.response.data?.message||s.response.data?.error;throw new Error(a||"Email no encontrado")}else if(s.response?.status===403){const a=s.response.data?.message||s.response.data?.error;throw new Error(a||"Cuenta bloqueada")}else if(s.response?.status===423){const a=s.response.data?.message||s.response.data?.error;throw new Error(a||"Cuenta temporalmente bloqueada")}else if(s.response?.status===422){const a=s.response.data?.errors;if(a){const c=Object.values(a).flat();throw new Error(c.join(". "))}const i=s.response.data?.message;throw new Error(i||"Datos de formulario inv√°lidos")}else{if(s.response?.data?.message)throw new Error(s.response.data.message);if(s.response?.data?.error)throw new Error(s.response.data.error);if(s.message)throw new Error(s.message)}}throw new Error("Error desconocido al iniciar sesi√≥n")}}getDefaultPasswordRules(e=8,t=!0,s=!0,a=!0){const i=[];let c=`La contrase√±a debe tener al menos ${e} caracteres`;return t&&i.push("al menos una letra may√∫scula"),s&&i.push("al menos un n√∫mero"),a&&i.push("al menos un car√°cter especial (!@#$%^&*)"),i.length>0&&(c+=" y debe incluir "+i.join(", ")),c+=".",{minLength:e,requireSpecial:a,requireUppercase:t,requireNumbers:s,validationMessage:c,requirements:i}}async getPasswordValidationRules(){try{const e=await _.get(U.AUTH.PASSWORD_VALIDATION_RULES);return e?.data?.status==="success"?e.data.data:this.getDefaultPasswordRules()}catch(e){return console.error("Error al obtener reglas de validaci√≥n:",e),this.getDefaultPasswordRules()}}async register(e){try{console.log("AuthService: Realizando solicitud de registro");const t=await _.post(U.AUTH.REGISTER,e);if(!t||!t.data)throw new Error("Respuesta del servidor vac√≠a");const s=t.data;if(!s.access_token)throw new Error("Token de acceso no encontrado en la respuesta");return console.log("AuthService: Registro exitoso, token recibido"),A.setItem(y.storage.authTokenKey,s.access_token),s.user&&A.setItem(y.storage.userKey,s.user),s}catch(t){if(console.error("AuthService: Error de registro:",t),O.isAxiosError(t)){const s=t;if(s.response?.status===422){const a=s.response.data?.errors;if(a){const c=Object.values(a).flat();throw new Error(c.join(". "))}const i=s.response.data?.message;throw new Error(i||"Datos de registro inv√°lidos")}else if(s.response?.status===409){const a=s.response.data?.message||s.response.data?.error;throw new Error(a||"Este email ya est√° registrado")}else{if(s.response?.data?.message)throw new Error(s.response.data.message);if(s.response?.data?.error)throw new Error(s.response.data.error);if(s.message)throw new Error(s.message)}}throw new Error("Error desconocido al registrar usuario")}}async logout(){try{if(console.log("AuthService: Iniciando proceso de logout"),A.getItem(y.storage.authTokenKey))try{await _.post(U.AUTH.LOGOUT),console.log("AuthService: Logout en servidor exitoso")}catch(t){console.warn("AuthService: Error al hacer logout en servidor, continuando con logout local:",t)}return A.removeItem(y.storage.authTokenKey),A.removeItem(y.storage.refreshTokenKey),A.removeItem(y.storage.userKey),console.log("AuthService: Datos de sesi√≥n eliminados del localStorage"),!0}catch(e){throw console.error("AuthService: Error al cerrar sesi√≥n:",e),A.removeItem(y.storage.authTokenKey),A.removeItem(y.storage.refreshTokenKey),A.removeItem(y.storage.userKey),new Error("Error al cerrar sesi√≥n")}}async getCurrentUser(){try{if(console.log("AuthService: Obteniendo datos del usuario actual"),!A.getItem(y.storage.authTokenKey))throw new Error("No hay sesi√≥n activa");const t=A.getItem(y.storage.userKey);if(t)return console.log("AuthService: Usando datos de usuario en cach√©"),t;console.log("AuthService: Solicitando datos de usuario al servidor");const s=await _.get(U.AUTH.ME);if(!s||!s.data)throw new Error("Respuesta del servidor vac√≠a");const a=s.data;if(!a)throw new Error("Informaci√≥n de usuario no encontrada en la respuesta");return console.log("AuthService: Datos de usuario obtenidos del servidor"),A.setItem(y.storage.userKey,a),a}catch(e){throw console.error("AuthService: Error al obtener usuario actual:",e),O.isAxiosError(e)&&e.response?.status===401&&(A.removeItem(y.storage.authTokenKey),A.removeItem(y.storage.refreshTokenKey),A.removeItem(y.storage.userKey)),new Error("No se pudo obtener la informaci√≥n del usuario")}}async updateProfile(e){try{console.log("Enviando actualizaci√≥n de perfil:",e);const t=await _.put("/profile",e);if(!t||!t.data)throw new Error("Respuesta del servidor vac√≠a");const s=t.data;if(!s)throw new Error("Informaci√≥n de usuario no encontrada en la respuesta");return A.setItem(y.storage.userKey,s),s}catch(t){if(console.error("AuthService: Error al actualizar perfil:",t),O.isAxiosError(t)){const s=t;if(s.response?.status===401)throw new Error("No autorizado para actualizar el perfil");if(s.response?.status===422){const a=s.response.data?.errors;if(a){const i=Object.values(a).flat();throw new Error(i.join(". "))}throw new Error("Datos de perfil inv√°lidos")}else if(s.response?.data?.message)throw new Error(s.response.data.message)}throw new Error("No se pudo actualizar el perfil")}}async forgotPasswordEmail(e){try{const t=await _.post(U.AUTH.FORGOT_PASSWORD_EMAIL,{email:e});return t.data?.status==="success"&&t.data?.email_sent===!0}catch(t){if(console.error("Error al solicitar recuperaci√≥n de contrase√±a:",t),O.isAxiosError(t)){const s=t;if(s.response?.status===422)throw new Error("Correo electr√≥nico inv√°lido");if(s.response?.data?.message)throw new Error(s.response.data.message)}throw new Error("No se pudo procesar la solicitud de recuperaci√≥n de contrase√±a")}}async forgotPasswordToken(e){try{const t=await _.post(U.AUTH.FORGOT_PASSWORD_TOKEN,{email:e});return t.data?.success||t.data?.status==="success"||!1}catch(t){if(console.error("Error al solicitar recuperaci√≥n de contrase√±a:",t),O.isAxiosError(t)){const s=t;if(s.response?.status===422)throw new Error("Correo electr√≥nico inv√°lido");if(s.response?.data?.message)throw new Error(s.response.data.message)}throw new Error("No se pudo procesar la solicitud de recuperaci√≥n de contrase√±a")}}async resetPassword(e,t,s,a){try{const i=await _.post(U.AUTH.RESET_PASSWORD,{token:e,email:t,password:s,password_confirmation:a});return i.data?.success||i.data?.status==="success"||!1}catch(i){if(console.error("Error al restablecer contrase√±a:",i),O.isAxiosError(i)){const c=i;if(c.response?.status===422){const u=c.response.data?.errors;if(u){const C=Object.values(u).flat();throw new Error(C.join(". "))}throw new Error("Datos inv√°lidos para restablecimiento de contrase√±a")}else if(c.response?.data?.message)throw new Error(c.response.data.message)}throw new Error("No se pudo restablecer la contrase√±a")}}isAuthenticated(){return!!A.getItem(y.storage.authTokenKey)}async refreshToken(){try{const e=await _.post(U.AUTH.REFRESH);if(!e)throw new Error("Respuesta del servidor vac√≠a");const t=e.data?.access_token;if(!t)throw new Error("Token no encontrado en la respuesta");return A.setItem(y.storage.authTokenKey,t),!0}catch(e){return console.error("Error al actualizar el token:",e),O.isAxiosError(e)&&e.response?.status===401&&(A.removeItem(y.storage.authTokenKey),A.removeItem(y.storage.userKey)),!1}}async verifyEmail(e,t){try{const s=await _.get(U.AUTH.VERIFY_EMAIL(e,t));return s.data?.success||s.data?.status==="success"||!1}catch(s){throw console.error("Error al verificar email:",s),O.isAxiosError(s)&&s.response?.data?.message?new Error(s.response.data.message):new Error("No se pudo verificar el correo electr√≥nico")}}async loginWithGoogle(){try{console.log("üîê Iniciando login con Google...");const t=await G.getInstance().authenticateWithGoogle("login");if(!t.success)throw new Error(t.error||"Error en el login con Google");return console.log("‚úÖ Login con Google exitoso"),t.user}catch(e){throw console.error("‚ùå Error en login con Google:",e),e}}async registerWithGoogle(){try{console.log("üîê Iniciando registro con Google...");const t=await G.getInstance().authenticateWithGoogle("register");if(!t.success)throw new Error(t.error||"Error en el registro con Google");return console.log("‚úÖ Registro con Google exitoso"),t.user}catch(e){throw console.error("‚ùå Error en registro con Google:",e),e}}}class _e{authService;storageService;constructor(){this.authService=new K,this.storageService=new F}async execute(e){try{const t=await this.authService.login(e);if(!t||!t.access_token)throw new Error("Respuesta de autenticaci√≥n inv√°lida");return this.storageService.setItem(y.storage.authTokenKey,t.access_token),t.user&&this.storageService.setItem(y.storage.userKey,t.user),t.session_config&&(this.storageService.setItem("session_config",t.session_config),console.log("‚úÖ Session config guardada:",t.session_config)),t}catch(t){throw console.error("Error en LoginUseCase:",t),t instanceof Error?t:new Error("Error desconocido en el inicio de sesi√≥n")}}}class De{authService;storageService;constructor(){this.authService=new K,this.storageService=new F}async execute(e){try{if(!e.email||!e.password||!e.name)throw new Error("Datos de registro incompletos");const t=await this.authService.register(e);if(!t||!t.access_token)throw new Error("Respuesta de registro inv√°lida");return this.storageService.setItem(y.storage.authTokenKey,t.access_token),t.user&&this.storageService.setItem(y.storage.userKey,t.user),t}catch(t){throw console.error("Error en RegisterUseCase:",t),t instanceof Error?t:new Error("Error desconocido en el registro")}}}class Ue{authService;storageService;constructor(){this.authService=new K,this.storageService=new F}async execute(e){try{const t=await this.authService.updateProfile(e);if(!t)throw new Error("Respuesta de actualizaci√≥n inv√°lida");return this.storageService.setItem(y.storage.userKey,t),t}catch(t){throw console.error("Error en UpdateProfileUseCase:",t),t instanceof Error?t:new Error("Error desconocido en la actualizaci√≥n de perfil")}}}class $e{authService;storageService;constructor(){this.authService=new K,this.storageService=new F}async execute(){try{console.log("üîê Ejecutando GoogleLoginUseCase...");const e=await this.authService.loginWithGoogle();if(!e||!e.access_token)throw new Error("Respuesta de autenticaci√≥n con Google inv√°lida");return this.storageService.setItem(y.storage.authTokenKey,e.access_token),e.user&&this.storageService.setItem(y.storage.userKey,e.user),console.log("‚úÖ GoogleLoginUseCase completado exitosamente"),e}catch(e){throw console.error("‚ùå Error en GoogleLoginUseCase:",e),e instanceof Error?e:new Error("Error desconocido en el inicio de sesi√≥n con Google")}}}class Oe{authService;storageService;constructor(){this.authService=new K,this.storageService=new F}async execute(){try{console.log("üîê Ejecutando GoogleRegisterUseCase...");const e=await this.authService.registerWithGoogle();if(!e||!e.access_token)throw new Error("Respuesta de registro con Google inv√°lida");return this.storageService.setItem(y.storage.authTokenKey,e.access_token),e.user&&this.storageService.setItem(y.storage.userKey,e.user),console.log("‚úÖ GoogleRegisterUseCase completado exitosamente"),e}catch(e){throw console.error("‚ùå Error en GoogleRegisterUseCase:",e),e instanceof Error?e:new Error("Error desconocido en el registro con Google")}}}const Le=new _e,Ge=new De,Fe=new Ue,ze=new $e,We=new Oe,B={USER_DATA:"auth_user_data",ROLE_INFO:"auth_role_info"},Ke=()=>{const{user:o,setUser:e,isAuthenticated:t,setIsAuthenticated:s,logout:a,roleInfo:i,isLoadingRole:c,refreshRoleInfo:u,isInitialized:C,getDefaultRouteForRole:h,isAdmin:j,isSeller:I}=l.useContext(Pe),[w,N]=l.useState(!1),[v,f]=l.useState(null),S=l.useCallback(async b=>{N(!0),f(null);try{console.log("üîë Iniciando login...");const m=await Le.execute(b);if(m&&m.user)return console.log("‚úÖ Login exitoso"),e(m.user),s(!0),V.removeItem(B.ROLE_INFO),await u(),m;throw new Error("No se recibi√≥ informaci√≥n de usuario v√°lida")}catch(m){let M="Error al iniciar sesi√≥n";return m.response?.status===409&&m.response?.data?.error_code==="EMAIL_NOT_VERIFIED"?M=m.response.data.message||"Debes verificar tu email antes de iniciar sesi√≥n":m instanceof Error?M=m.message:m.response?.data?.message&&(M=m.response.data.message),console.error("‚ùå Login error:",M),f(M),null}finally{N(!1)}},[e,s,u]),k=l.useCallback(async b=>{N(!0),f(null);try{console.log("üìù Iniciando registro...");const m=await Ge.execute(b);if(m&&m.user)return console.log("‚úÖ Registro exitoso - Usuario creado sin iniciar sesi√≥n autom√°ticamente"),m;throw new Error("No se recibi√≥ informaci√≥n de usuario v√°lida")}catch(m){const M=m instanceof Error?m.message:"Error al registrar usuario";return console.error("‚ùå Register error:",M),f(M),null}finally{N(!1)}},[e,s,u]),d=l.useCallback(async()=>{try{N(!0),f(null),console.log("üîê Iniciando login con Google...");const b=await ze.execute();return b?(console.log("‚úÖ Login con Google exitoso"),e(b.user),s(!0),V.removeItem(B.ROLE_INFO),await u(),b):null}catch(b){console.error("‚ùå Error en login con Google:",b);const m=b instanceof Error?b.message:"Error desconocido al iniciar sesi√≥n con Google";return f(m),null}finally{N(!1)}},[e,s,u]),x=l.useCallback(async()=>{try{N(!0),f(null),console.log("üîê Iniciando registro con Google...");const b=await We.execute();return b?(console.log("‚úÖ Registro con Google exitoso"),e(b.user),s(!0),V.removeItem(B.ROLE_INFO),await u(),b):null}catch(b){console.error("‚ùå Error en registro con Google:",b);const m=b instanceof Error?b.message:"Error desconocido al registrarse con Google";return f(m),null}finally{N(!1)}},[e,s,u]),n=l.useCallback(async()=>{N(!0),f(null);try{return console.log("üö™ Cerrando sesi√≥n..."),await a(),console.log("‚úÖ Sesi√≥n cerrada exitosamente"),!0}catch(b){const m=b instanceof Error?b.message:"Error al cerrar sesi√≥n";return console.error("‚ùå Logout error:",m),f(m),!1}finally{N(!1),setTimeout(()=>{window.location.href="/"},100)}},[a]),g=l.useCallback(async b=>{N(!0),f(null);try{console.log("üë§ Actualizando perfil...");const m=await Fe.execute(b);if(m)return console.log("‚úÖ Perfil actualizado exitosamente"),e(m),V.setItem(B.USER_DATA,m,10*60*1e3),m;throw new Error("No se recibi√≥ informaci√≥n de usuario actualizada")}catch(m){const M=m instanceof Error?m.message:"Error al actualizar perfil";return console.error("‚ùå Update profile error:",M),f(M),null}finally{N(!1)}},[e]),T=l.useCallback(async(b=!1)=>{try{return await j(b)}catch(m){return console.warn("‚ö†Ô∏è Error en verificaci√≥n de admin, usando fallback:",m),i.isAdmin}},[j,i.isAdmin]),R=l.useCallback(async(b=!1)=>{try{return await I(b)}catch(m){return console.warn("‚ö†Ô∏è Error en verificaci√≥n de seller, usando fallback:",m),i.isSeller}},[I,i.isSeller]),D=l.useCallback(()=>{f(null)},[]);return{user:o,isAuthenticated:t,loading:w,error:v,login:S,register:k,logout:n,updateProfile:g,loginWithGoogle:d,registerWithGoogle:x,setUser:e,setIsAuthenticated:s,roleInfo:i,isLoadingRole:c,refreshRoleInfo:u,isInitialized:C,getDefaultRouteForRole:h,isAdmin:T,isSeller:R,clearError:D}},He="America/Guayaquil",Ve="-05:00",L={},ie=30*1e3,Y=100,Be=()=>{const o=Date.now(),e=Object.keys(L);if(e.length>Y){e.forEach(s=>{L[s].expiry<o&&delete L[s]});const t=Object.keys(L);t.length>Y&&t.map(i=>({key:i,timestamp:L[i].timestamp})).sort((i,c)=>i.timestamp-c.timestamp).slice(0,t.length-Y).forEach(i=>delete L[i.key])}},$=o=>{try{if(!o||o.trim()==="")return null;const e=o.trim();let t;if(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{1,6})?Z?$/i.test(e)||/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d{1,6})?[+-]\d{2}:\d{2}$/.test(e))t=new Date(e);else if(/^\d{4}-\d{2}-\d{2} \d{2}:\d{2}:\d{2}$/.test(e)){const s=e.replace(" ","T")+Ve;t=new Date(s)}else t=new Date(e);return isNaN(t.getTime())?null:t}catch(e){return console.error("Error al parsear fecha:",e),null}},Lr=o=>{try{if(!o||o.trim()==="")return"Fecha desconocida";const e=Date.now(),t=`${o}_${Math.floor(e/ie)}`,s=L[t];if(s&&s.expiry>e)return s.result;const a=$(o);if(!a)return"Fecha inv√°lida";const i=Math.floor((e-a.getTime())/1e3);if(i<0)return ce(a);let c;if(i<60)c="Ahora mismo";else if(i<3600){const u=Math.floor(i/60);c=`${u} ${u===1?"minuto":"minutos"}`}else if(i<86400){const u=Math.floor(i/3600);c=`${u} ${u===1?"hora":"horas"}`}else if(i<604800){const u=Math.floor(i/86400);c=`${u} ${u===1?"d√≠a":"d√≠as"}`}else c=ce(a);return L[t]={result:c,timestamp:e,expiry:e+ie},Object.keys(L).length>Y&&Be(),c}catch(e){return console.error("Error en formatRelativeTime:",e),"Error en fecha"}},ce=(o,e=!1)=>{try{const t=new Date,s={day:"numeric",month:"short",year:o.getFullYear()!==t.getFullYear()?"numeric":void 0,timeZone:He};return e&&(s.hour="2-digit",s.minute="2-digit",s.hour12=!1),o.toLocaleDateString("es-EC",s)}catch(t){return console.error("Error en formatAbsoluteDate:",t),o.toLocaleDateString()}},qe=o=>{const e=$(o);if(!e)return!1;const t=new Date;return e.getDate()===t.getDate()&&e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear()},Ye=o=>{const e=$(o);if(!e)return!1;const t=new Date;return t.setDate(t.getDate()-1),e.getDate()===t.getDate()&&e.getMonth()===t.getMonth()&&e.getFullYear()===t.getFullYear()},Xe={lessThanXSeconds:{one:"menos de un segundo",other:"menos de {{count}} segundos"},xSeconds:{one:"1 segundo",other:"{{count}} segundos"},halfAMinute:"medio minuto",lessThanXMinutes:{one:"menos de un minuto",other:"menos de {{count}} minutos"},xMinutes:{one:"1 minuto",other:"{{count}} minutos"},aboutXHours:{one:"alrededor de 1 hora",other:"alrededor de {{count}} horas"},xHours:{one:"1 hora",other:"{{count}} horas"},xDays:{one:"1 d√≠a",other:"{{count}} d√≠as"},aboutXWeeks:{one:"alrededor de 1 semana",other:"alrededor de {{count}} semanas"},xWeeks:{one:"1 semana",other:"{{count}} semanas"},aboutXMonths:{one:"alrededor de 1 mes",other:"alrededor de {{count}} meses"},xMonths:{one:"1 mes",other:"{{count}} meses"},aboutXYears:{one:"alrededor de 1 a√±o",other:"alrededor de {{count}} a√±os"},xYears:{one:"1 a√±o",other:"{{count}} a√±os"},overXYears:{one:"m√°s de 1 a√±o",other:"m√°s de {{count}} a√±os"},almostXYears:{one:"casi 1 a√±o",other:"casi {{count}} a√±os"}},Je=(o,e,t)=>{let s;const a=Xe[o];return typeof a=="string"?s=a:e===1?s=a.one:s=a.other.replace("{{count}}",e.toString()),t?.addSuffix?t.comparison&&t.comparison>0?"en "+s:"hace "+s:s},Ze={full:"EEEE, d 'de' MMMM 'de' y",long:"d 'de' MMMM 'de' y",medium:"d MMM y",short:"dd/MM/y"},Qe={full:"HH:mm:ss zzzz",long:"HH:mm:ss z",medium:"HH:mm:ss",short:"HH:mm"},er={full:"{{date}} 'a las' {{time}}",long:"{{date}} 'a las' {{time}}",medium:"{{date}}, {{time}}",short:"{{date}}, {{time}}"},rr={date:ee({formats:Ze,defaultWidth:"full"}),time:ee({formats:Qe,defaultWidth:"full"}),dateTime:ee({formats:er,defaultWidth:"full"})},tr={lastWeek:"'el' eeee 'pasado a la' p",yesterday:"'ayer a la' p",today:"'hoy a la' p",tomorrow:"'ma√±ana a la' p",nextWeek:"eeee 'a la' p",other:"P"},sr={lastWeek:"'el' eeee 'pasado a las' p",yesterday:"'ayer a las' p",today:"'hoy a las' p",tomorrow:"'ma√±ana a las' p",nextWeek:"eeee 'a las' p",other:"P"},or=(o,e,t,s)=>e.getHours()!==1?sr[o]:tr[o],ar={narrow:["AC","DC"],abbreviated:["AC","DC"],wide:["antes de cristo","despu√©s de cristo"]},nr={narrow:["1","2","3","4"],abbreviated:["T1","T2","T3","T4"],wide:["1¬∫ trimestre","2¬∫ trimestre","3¬∫ trimestre","4¬∫ trimestre"]},ir={narrow:["e","f","m","a","m","j","j","a","s","o","n","d"],abbreviated:["ene","feb","mar","abr","may","jun","jul","ago","sep","oct","nov","dic"],wide:["enero","febrero","marzo","abril","mayo","junio","julio","agosto","septiembre","octubre","noviembre","diciembre"]},cr={narrow:["d","l","m","m","j","v","s"],short:["do","lu","ma","mi","ju","vi","s√°"],abbreviated:["dom","lun","mar","mi√©","jue","vie","s√°b"],wide:["domingo","lunes","martes","mi√©rcoles","jueves","viernes","s√°bado"]},lr={narrow:{am:"a",pm:"p",midnight:"mn",noon:"md",morning:"ma√±ana",afternoon:"tarde",evening:"tarde",night:"noche"},abbreviated:{am:"AM",pm:"PM",midnight:"medianoche",noon:"mediodia",morning:"ma√±ana",afternoon:"tarde",evening:"tarde",night:"noche"},wide:{am:"a.m.",pm:"p.m.",midnight:"medianoche",noon:"mediodia",morning:"ma√±ana",afternoon:"tarde",evening:"tarde",night:"noche"}},dr={narrow:{am:"a",pm:"p",midnight:"mn",noon:"md",morning:"de la ma√±ana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"},abbreviated:{am:"AM",pm:"PM",midnight:"medianoche",noon:"mediodia",morning:"de la ma√±ana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"},wide:{am:"a.m.",pm:"p.m.",midnight:"medianoche",noon:"mediodia",morning:"de la ma√±ana",afternoon:"de la tarde",evening:"de la tarde",night:"de la noche"}},ur=(o,e)=>Number(o)+"¬∫",mr={ordinalNumber:ur,era:z({values:ar,defaultWidth:"wide"}),quarter:z({values:nr,defaultWidth:"wide",argumentCallback:o=>Number(o)-1}),month:z({values:ir,defaultWidth:"wide"}),day:z({values:cr,defaultWidth:"wide"}),dayPeriod:z({values:lr,defaultWidth:"wide",formattingValues:dr,defaultFormattingWidth:"wide"})},gr=/^(\d+)(¬∫)?/i,hr=/\d+/i,fr={narrow:/^(ac|dc|a|d)/i,abbreviated:/^(a\.?\s?c\.?|a\.?\s?e\.?\s?c\.?|d\.?\s?c\.?|e\.?\s?c\.?)/i,wide:/^(antes de cristo|antes de la era com[u√∫]n|despu[e√©]s de cristo|era com[u√∫]n)/i},xr={any:[/^ac/i,/^dc/i],wide:[/^(antes de cristo|antes de la era com[u√∫]n)/i,/^(despu[e√©]s de cristo|era com[u√∫]n)/i]},pr={narrow:/^[1234]/i,abbreviated:/^T[1234]/i,wide:/^[1234](¬∫)? trimestre/i},vr={any:[/1/i,/2/i,/3/i,/4/i]},wr={narrow:/^[efmajsond]/i,abbreviated:/^(ene|feb|mar|abr|may|jun|jul|ago|sep|oct|nov|dic)/i,wide:/^(enero|febrero|marzo|abril|mayo|junio|julio|agosto|septiembre|octubre|noviembre|diciembre)/i},yr={narrow:[/^e/i,/^f/i,/^m/i,/^a/i,/^m/i,/^j/i,/^j/i,/^a/i,/^s/i,/^o/i,/^n/i,/^d/i],any:[/^en/i,/^feb/i,/^mar/i,/^abr/i,/^may/i,/^jun/i,/^jul/i,/^ago/i,/^sep/i,/^oct/i,/^nov/i,/^dic/i]},br={narrow:/^[dlmjvs]/i,short:/^(do|lu|ma|mi|ju|vi|s[√°a])/i,abbreviated:/^(dom|lun|mar|mi[√©e]|jue|vie|s[√°a]b)/i,wide:/^(domingo|lunes|martes|mi[√©e]rcoles|jueves|viernes|s[√°a]bado)/i},jr={narrow:[/^d/i,/^l/i,/^m/i,/^m/i,/^j/i,/^v/i,/^s/i],any:[/^do/i,/^lu/i,/^ma/i,/^mi/i,/^ju/i,/^vi/i,/^sa/i]},Er={narrow:/^(a|p|mn|md|(de la|a las) (ma√±ana|tarde|noche))/i,any:/^([ap]\.?\s?m\.?|medianoche|mediodia|(de la|a las) (ma√±ana|tarde|noche))/i},Nr={any:{am:/^a/i,pm:/^p/i,midnight:/^mn/i,noon:/^md/i,morning:/ma√±ana/i,afternoon:/tarde/i,evening:/tarde/i,night:/noche/i}},Sr={ordinalNumber:Re({matchPattern:gr,parsePattern:hr,valueCallback:function(o){return parseInt(o,10)}}),era:W({matchPatterns:fr,defaultMatchWidth:"wide",parsePatterns:xr,defaultParseWidth:"any"}),quarter:W({matchPatterns:pr,defaultMatchWidth:"wide",parsePatterns:vr,defaultParseWidth:"any",valueCallback:o=>o+1}),month:W({matchPatterns:wr,defaultMatchWidth:"wide",parsePatterns:yr,defaultParseWidth:"any"}),day:W({matchPatterns:br,defaultMatchWidth:"wide",parsePatterns:jr,defaultParseWidth:"any"}),dayPeriod:W({matchPatterns:Er,defaultMatchWidth:"any",parsePatterns:Nr,defaultParseWidth:"any"})},Cr={code:"es",formatDistance:Je,formatLong:rr,formatRelative:or,localize:mr,match:Sr,options:{weekStartsOn:1,firstWeekContainsDate:1}},Gr=({chats:o,selectedChatId:e,onSelectChat:t,loading:s,searchTerm:a,onSearchChange:i,statusFilter:c,onStatusFilterChange:u,unreadFilter:C,onUnreadFilterChange:h,isSeller:j=!1,showTabs:I=!0})=>{const[w,N]=l.useState("active"),v=l.useMemo(()=>{const n={active:0,closed:0,archived:0,all:o.length};return o.forEach(g=>{g.status==="active"?n.active++:g.status==="closed"?n.closed++:g.status==="archived"&&n.archived++}),n},[o]),f=[{id:"active",label:"Activos",icon:ve,count:v.active},{id:"closed",label:"Cerrados",icon:J,count:v.closed},{id:"archived",label:"Archivados",icon:me,count:v.archived}],k=o.filter(n=>w==="all"?!0:n.status===w).filter(n=>{const g=I||c==="all"||n.status===c,T=C?(n.unreadCount??0)>0:!0,R=a===""||n.product?.name&&n.product.name.toLowerCase().includes(a.toLowerCase())||(j?n.user?.name?.toLowerCase().includes(a.toLowerCase()):n.seller?.storeName?.toLowerCase().includes(a.toLowerCase()));return g&&T&&R}),d=n=>{if(!n)return"fecha desconocida";try{return Me(new Date(n),{addSuffix:!0,locale:Cr})}catch{return"fecha desconocida"}},x=n=>j?{name:n.user?.name||`Cliente #${n.userId}`,avatar:n.user?.avatar,id:n.userId,icon:r.jsx(X,{className:"h-6 w-6 text-gray-500"})}:{name:n.seller?.storeName||`Vendedor #${n.sellerId}`,avatar:n.seller?.avatar,id:n.sellerId,icon:r.jsx(te,{className:"h-6 w-6 text-gray-500"})};return r.jsxs("div",{className:"flex flex-col h-full bg-white",children:[I&&r.jsx("div",{className:"border-b border-gray-200 bg-gray-50",children:r.jsx("div",{className:"flex",children:f.map(n=>{const g=n.icon,T=w===n.id;return r.jsxs("button",{onClick:()=>N(n.id),className:`flex items-center px-4 py-3 text-sm font-medium border-b-2 transition-all duration-200 ${T?"text-primary-600 border-primary-500 bg-white":"text-gray-500 border-transparent hover:text-gray-700 hover:border-gray-300"}`,children:[r.jsx(g,{className:`h-4 w-4 mr-2 ${T?"text-primary-500":"text-gray-400"}`}),n.label,n.count>0&&r.jsx("span",{className:`ml-2 px-2 py-0.5 rounded-full text-xs font-medium ${T?"bg-primary-100 text-primary-600":"bg-gray-200 text-gray-600"}`,children:n.count})]},n.id)})})}),r.jsxs("div",{className:"p-4 bg-white border-b border-gray-100",children:[r.jsxs("div",{className:"relative mb-3",children:[r.jsx(ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 h-4 w-4 text-gray-400"}),r.jsx("input",{type:"text",placeholder:"Buscar conversaciones...",className:"w-full pl-10 pr-4 py-2.5 border border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 transition-colors",value:a,onChange:n=>i(n.target.value)})]}),r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsx("div",{className:"flex items-center space-x-3",children:!I&&r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx(we,{className:"h-4 w-4 text-gray-500"}),r.jsxs("select",{className:"border border-gray-200 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500",value:c,onChange:n=>u(n.target.value),children:[r.jsx("option",{value:"all",children:"Todos los estados"}),r.jsx("option",{value:"active",children:"Activos"}),r.jsx("option",{value:"closed",children:"Cerrados"}),r.jsx("option",{value:"archived",children:"Archivados"})]})]})}),r.jsx("div",{className:"flex items-center",children:r.jsxs("label",{className:"flex items-center cursor-pointer",children:[r.jsx("input",{type:"checkbox",className:"h-4 w-4 text-primary-600 focus:ring-primary-500 border-gray-300 rounded",checked:C,onChange:n=>h(n.target.checked)}),r.jsx("span",{className:"ml-2 text-sm text-gray-700",children:"Solo no le√≠dos"})]})})]})]}),r.jsx("div",{className:"flex-1 overflow-y-auto",children:s?r.jsx("div",{className:"flex justify-center items-center h-full",children:r.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-t-2 border-b-2 border-primary-600"})}):k.length===0?r.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-8 text-center",children:[r.jsx("div",{className:"w-16 h-16 bg-gray-100 rounded-full flex items-center justify-center mb-4",children:j?r.jsx(X,{className:"h-8 w-8 text-gray-400"}):r.jsx(te,{className:"h-8 w-8 text-gray-400"})}),r.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:"No hay conversaciones"}),r.jsx("p",{className:"text-gray-500 max-w-sm",children:a||c!=="all"||C?"No se encontraron resultados con los filtros actuales":j?"Cuando los clientes inicien conversaciones, aparecer√°n aqu√≠":"Inicia una conversaci√≥n con un vendedor desde la p√°gina de un producto"})]}):r.jsx("div",{className:"divide-y divide-gray-100",children:k.map(n=>{const g=x(n),T=n.id||0;return r.jsx("div",{className:`p-4 hover:bg-gray-50 cursor-pointer transition-all duration-200 border-l-4 group ${e===T?"bg-primary-50 border-l-primary-500 shadow-sm":"border-l-transparent hover:border-l-primary-200"}`,onClick:()=>t(n),children:r.jsxs("div",{className:"flex items-start",children:[r.jsx("div",{className:"flex-shrink-0 mr-3 relative",children:g.avatar?r.jsx("img",{src:g.avatar,alt:g.name,className:"h-12 w-12 rounded-full border-2 border-white shadow-sm group-hover:shadow-md transition-shadow",onError:R=>{const D=R.target;D.onerror=null,D.src="https://via.placeholder.com/48?text=U"}}):r.jsx("div",{className:"h-12 w-12 rounded-full bg-gradient-to-br from-gray-100 to-gray-200 flex items-center justify-center border-2 border-white shadow-sm group-hover:shadow-md transition-shadow",children:g.icon})}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsxs("div",{className:"flex justify-between items-start mb-2",children:[r.jsx("h3",{className:`text-sm font-medium truncate pr-2 transition-colors ${e===T?"text-primary-700":"text-gray-900 group-hover:text-primary-600"}`,children:g.name}),r.jsxs("div",{className:"flex items-center space-x-2 flex-shrink-0",children:[r.jsx("span",{className:"text-xs text-gray-500",children:d(n.updatedAt)}),(n.unreadCount??0)>0&&r.jsx("span",{className:"inline-flex items-center justify-center h-5 w-5 rounded-full bg-primary-600 text-white text-xs font-medium animate-pulse",children:(n.unreadCount??0)>99?"99+":n.unreadCount??0})]})]}),r.jsxs("div",{className:"flex items-center text-xs text-gray-500 mb-2",children:[r.jsx(he,{className:"h-3 w-3 mr-1 flex-shrink-0"}),r.jsx("span",{className:"truncate",children:n.product?.name||`Producto #${n.productId}`})]}),r.jsx("div",{className:"flex items-center justify-between",children:r.jsx("div",{className:"flex items-center min-w-0 flex-1",children:r.jsxs("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium mr-2 flex-shrink-0 ${n.status==="active"?"bg-green-100 text-green-800":n.status==="closed"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:[r.jsx(q,{className:"w-1.5 h-1.5 mr-1",fill:"currentColor"}),n.status==="active"?"Activo":n.status==="closed"?"Cerrado":"Archivado"]})})}),r.jsx("div",{className:"mt-1",children:r.jsx("p",{className:"text-sm text-gray-600 truncate",children:n.lastMessage?.content||"Sin mensajes"})})]})]})},`chat-${T}`)})})}),k.length>5&&r.jsx("div",{className:"p-3 border-t border-gray-100 bg-gray-50 text-center",children:r.jsxs("span",{className:"text-xs text-gray-500",children:[k.length," conversaci√≥n",k.length!==1?"es":"",I&&w!=="all"&&` ${f.find(n=>n.id===w)?.label.toLowerCase()}`]})})]})},le=o=>{const e=o?.charAt(0).toUpperCase()||"U";return`data:image/svg+xml,${encodeURIComponent(`
<svg width="24" height="24" xmlns="http://www.w3.org/2000/svg">
  <circle cx="12" cy="12" r="12" fill="#e5e7eb"/>
  <text x="12" y="16" font-family="Arial, sans-serif" font-size="10" font-weight="bold" fill="#6b7280" text-anchor="middle">
    ${e}
  </text>
</svg>
`)}`},Ir=(o,e)=>e?o.content&&o.content.includes("[ERROR]")?"error":!o.id||o.id<0?"sending":o.isRead?"read":o.createdAt?"delivered":"sent":"delivered",Ar=({status:o})=>{const e=()=>{switch(o){case"sending":return r.jsx("div",{className:"flex items-center",children:r.jsx(J,{className:"h-3 w-3 text-gray-400 animate-pulse"})});case"sent":return r.jsx("div",{className:"flex items-center",children:r.jsx(be,{className:"h-3 w-3 text-gray-400"})});case"delivered":return r.jsx("div",{className:"flex items-center",children:r.jsx(ae,{className:"h-3 w-3 text-gray-400"})});case"read":return r.jsx("div",{className:"flex items-center",children:r.jsx(ae,{className:"h-3 w-3 text-primary-500"})});case"error":return r.jsx("div",{className:"flex items-center",title:"Error al enviar mensaje",children:r.jsx(ye,{className:"h-3 w-3 text-red-500"})});default:return null}};return r.jsx("span",{className:"ml-1 flex-shrink-0",children:e()})},kr=o=>{try{const e=$(o);if(!e)return"";if(qe(o))return"Hoy";if(Ye(o))return"Ayer";{const t=new Date;return Math.floor((t.getTime()-e.getTime())/(1e3*60*60*24))<7?e.toLocaleDateString("es-EC",{weekday:"long"}):e.toLocaleDateString("es-EC",{day:"numeric",month:"long",year:e.getFullYear()!==t.getFullYear()?"numeric":void 0})}}catch(e){return console.error("Error formateando fecha separador:",e),""}},Tr=o=>{try{if(!o)return"";const e=$(o);return e?e.toLocaleTimeString("es-EC",{hour:"2-digit",minute:"2-digit",hour12:!1}):""}catch(e){return console.error("Error formateando hora:",e),""}},Rr=o=>{const e=[];return[...o].sort((s,a)=>{const i=s.createdAt&&$(s.createdAt)?.getTime()||0,c=a.createdAt&&$(a.createdAt)?.getTime()||0;return i-c}).forEach(s=>{if(!s.createdAt)return;const a=$(s.createdAt);if(!a)return;const i=a.toDateString();let c=e.find(u=>u.dateKey===i);c||(c={date:kr(s.createdAt),messages:[],dateKey:i},e.push(c)),c.messages.push(s)}),e},de=(o,e)=>{if(!e||o.senderId!==e.senderId)return!1;const t=o.createdAt?$(o.createdAt)?.getTime():0,s=e.createdAt?$(e.createdAt)?.getTime():0;return!t||!s?!1:(t-s)/(1e3*60)<5},Fr=({messages:o,loading:e,noMessagesText:t="No hay mensajes",currentUserId:s})=>{const a=l.useRef(null),i=l.useRef(null),[c,u]=l.useState(0),[C,h]=l.useState(!0),j=()=>{if(i.current){const{scrollTop:w,scrollHeight:N,clientHeight:v}=i.current,f=N-w-v<100;h(f)}};if(l.useEffect(()=>{o.length!==c&&(o.length>0&&console.log(`üì± Mostrando ${o.length} mensajes`),o.length>c&&C&&a.current&&a.current.scrollIntoView({behavior:"smooth"}),u(o.length))},[o.length,c,C]),l.useEffect(()=>{a.current&&o.length>0&&setTimeout(()=>{a.current?.scrollIntoView({behavior:"auto"})},100)},[]),e&&o.length===0)return r.jsx("div",{className:"flex justify-center items-center h-full p-8",children:r.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600"})});if(!o.length)return r.jsxs("div",{className:"flex flex-col items-center justify-center h-full text-center p-8",children:[r.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4",children:r.jsx(X,{className:"h-8 w-8 text-gray-500"})}),r.jsx("h3",{className:"text-lg font-medium text-gray-900 mb-2",children:t}),r.jsx("p",{className:"text-sm text-gray-500",children:"Env√≠a un mensaje para iniciar la conversaci√≥n"})]});const I=Rr(o);return r.jsxs("div",{className:"flex flex-col h-full bg-gray-50 relative",children:[r.jsxs("div",{className:"flex-1 overflow-y-auto px-4 py-2 space-y-1 messages-scroll smooth-scroll",style:{height:"calc(70vh - 180px)"},ref:i,onScroll:j,children:[I.map((w,N)=>r.jsxs("div",{className:"space-y-1",children:[r.jsx("div",{className:"flex justify-center my-4",children:r.jsx("div",{className:"bg-white/80 backdrop-blur-sm px-3 py-1 rounded-full shadow-sm border border-gray-200",children:r.jsx("span",{className:"text-xs text-gray-600 font-medium",children:w.date})})}),w.messages.map((v,f)=>{const S=v.isMine||s!==void 0&&v.senderId===s,k=Ir(v,!!S),d=f>0?w.messages[f-1]:null,x=f<w.messages.length-1?w.messages[f+1]:null,n=d?de(v,d):!1,g=x?de(x,v):!1,T=()=>S?n&&g?"rounded-l-2xl rounded-r-md rounded-tr-2xl":n?"rounded-l-2xl rounded-r-2xl rounded-tr-md":g?"rounded-2xl rounded-br-md":"rounded-2xl":n&&g?"rounded-r-2xl rounded-l-md rounded-tl-2xl":n?"rounded-r-2xl rounded-l-2xl rounded-tl-md":g?"rounded-2xl rounded-bl-md":"rounded-2xl";return r.jsx("div",{className:`flex ${S?"justify-end":"justify-start"} ${n?"mt-0.5":"mt-3"}`,children:r.jsxs("div",{className:`flex max-w-xs lg:max-w-md items-end ${S?"flex-row-reverse":"flex-row"}`,children:[!S&&!g&&r.jsx("div",{className:"flex-shrink-0 mr-2 mb-1",children:v.sender?.avatar?r.jsx("img",{src:v.sender.avatar,alt:v.sender?.name,className:"h-6 w-6 rounded-full",onError:R=>{const D=R.target;D.onerror=null,D.src=le(v.sender?.name)}}):r.jsx("img",{src:le(v.sender?.name),alt:v.sender?.name||"Usuario",className:"h-6 w-6 rounded-full"})}),!S&&g&&r.jsx("div",{className:"w-8 flex-shrink-0"}),r.jsxs("div",{className:`
												relative px-3 py-2 max-w-full break-words shadow-sm
												${T()}
												${S?"bg-primary-500 text-white":"bg-white text-gray-800 border border-gray-200"}
											`,children:[!S&&!n&&v.sender?.name&&r.jsx("p",{className:"text-xs font-medium text-primary-600 mb-1",children:v.sender.name}),r.jsx("p",{className:"text-sm whitespace-pre-wrap break-words leading-relaxed",children:v.content}),r.jsxs("div",{className:`
													flex items-center justify-end mt-1 space-x-1
													${S?"text-primary-100":"text-gray-500"}
												`,children:[r.jsx("span",{className:"text-xs",children:Tr(v.createdAt||"")}),S&&r.jsx(Ar,{status:k})]})]})]})},v.id||`temp-${N}-${f}`)})]},`${w.dateKey}-${N}`)),r.jsx("div",{ref:a,className:"h-1"}),e&&o.length>0&&r.jsx("div",{className:"flex justify-center py-2",children:r.jsx("div",{className:"bg-white/80 backdrop-blur-sm px-3 py-1 rounded-full shadow-sm",children:r.jsxs("div",{className:"flex items-center space-x-2",children:[r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-primary-600"}),r.jsx("span",{className:"text-xs text-gray-600",children:"Cargando mensajes..."})]})})})]}),!C&&r.jsx("div",{className:"absolute bottom-20 right-4 z-10",children:r.jsx("button",{onClick:()=>{h(!0),a.current?.scrollIntoView({behavior:"smooth"})},className:"bg-primary-500 text-white p-3 rounded-full shadow-lg hover:bg-primary-600 transition-all transform hover:scale-105 active:scale-95",title:"Ir al final",children:r.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",width:"20",height:"20",viewBox:"0 0 24 24",fill:"none",stroke:"currentColor",strokeWidth:"2",strokeLinecap:"round",strokeLinejoin:"round",children:r.jsx("path",{d:"m6 9 6 6 6-6"})})})}),r.jsx("div",{className:`scroll-indicator ${o.length>10?"visible":""}`}),o.length>10&&r.jsx("div",{className:"scroll-hint",children:"Desliza para ver m√°s mensajes"})]})},fe=({chatId:o,participantId:e,pollInterval:t=12e4,enableTypingIndicator:s=!0})=>{const{user:a}=Ke(),[i,c]=l.useState({isOnline:!1,lastSeen:null,isTyping:!1}),[u,C]=l.useState(navigator.onLine),h=l.useRef(null),j=l.useRef(null),I=l.useRef(new Date),w=l.useRef(!1);l.useEffect(()=>{const d=()=>C(!0),x=()=>C(!1);return window.addEventListener("online",d),window.addEventListener("offline",x),()=>{window.removeEventListener("online",d),window.removeEventListener("offline",x)}},[]);const N=l.useCallback(async()=>{if(!e||!u||w.current)return null;try{w.current=!0;const d=await re.get(`/users/${e}/status`);if(d?.data){const{is_online:x,last_seen:n,is_typing:g}=d.data;return{isOnline:!!x,lastSeen:n?new Date(n):null,isTyping:!!g}}}catch(d){return console.warn("Error fetching online status:",d),v()}finally{w.current=!1}return null},[e,u]),v=l.useCallback(()=>{const d=new Date,n=Math.random()>.75;let g=null;if(!n){const R=Math.floor(Math.random()*240)+5;g=new Date(d.getTime()-R*60*1e3)}const T=n&&Math.random()>.95;return{isOnline:n,lastSeen:g,isTyping:T}},[]),f=l.useCallback(async()=>{if(!e)return;const d=await N();d&&c(d)},[N,e]),S=l.useCallback(async d=>{if(!(!s||!o||!a?.id||!u))try{j.current&&clearTimeout(j.current);const n=window.location.pathname.includes("/seller/")?"/seller/chats":"/chats";d?(await re.post(`${n}/${o}/typing`,{user_id:a.id,is_typing:!0}),j.current=setTimeout(()=>{S(!1)},3e3)):await re.post(`${n}/${o}/typing`,{user_id:a.id,is_typing:!1})}catch(x){console.warn("Error sending typing indicator:",x)}},[s,o,a?.id,u]),k=l.useCallback(()=>{I.current=new Date},[]);return l.useEffect(()=>{if(!e||!u){c({isOnline:!1,lastSeen:null,isTyping:!1});return}return h.current&&(clearInterval(h.current),h.current=null),w.current||f(),document.visibilityState==="visible"&&(h.current=setInterval(()=>{document.visibilityState==="visible"&&!w.current&&f()},t)),()=>{h.current&&(clearInterval(h.current),h.current=null)}},[e,u]),l.useEffect(()=>{const d=()=>{document.visibilityState==="hidden"?h.current&&(clearInterval(h.current),h.current=null,console.log("Polling pausado - p√°gina oculta")):document.visibilityState==="visible"&&e&&u&&!h.current&&!w.current&&(console.log("Reanudando polling - p√°gina visible"),f(),h.current=setInterval(()=>{document.visibilityState==="visible"&&!w.current&&f()},t))};return document.addEventListener("visibilitychange",d),()=>{document.removeEventListener("visibilitychange",d)}},[e,u,t]),l.useEffect(()=>{if(!s)return;const d=["mousemove","keypress","click","scroll","touchstart"];return d.forEach(x=>{window.addEventListener(x,k,{passive:!0})}),()=>{d.forEach(x=>{window.removeEventListener(x,k)})}},[s,k]),l.useEffect(()=>()=>{h.current&&clearInterval(h.current),j.current&&clearTimeout(j.current)},[]),l.useEffect(()=>{if(!a?.id||!u)return;const d=()=>{navigator.sendBeacon(`https://api.comersia.app/api/users/${a.id}/activity`,JSON.stringify({last_seen:new Date().toISOString()}))},x=()=>{document.visibilityState==="hidden"&&d()};return window.addEventListener("beforeunload",d),document.addEventListener("visibilitychange",x),()=>{window.removeEventListener("beforeunload",d),document.removeEventListener("visibilitychange",x)}},[a?.id,u]),{onlineStatus:i,sendTypingIndicator:S,refreshOnlineStatus:f,isConnected:u}},Mr=o=>{const{sendTypingIndicator:e}=fe({chatId:o,enableTypingIndicator:!0}),[t,s]=l.useState(!1),a=l.useRef(null),i=l.useCallback(()=>{t||(s(!0),e(!0)),a.current&&clearTimeout(a.current),a.current=setTimeout(()=>{s(!1),e(!1)},3e3)},[t,e]),c=l.useCallback(()=>{t&&(s(!1),e(!1)),a.current&&clearTimeout(a.current)},[t,e]);return l.useEffect(()=>()=>{a.current&&clearTimeout(a.current)},[]),{isTyping:t,startTyping:i,stopTyping:c}},zr=({chat:o,isSeller:e=!1,onUpdateStatus:t,loading:s})=>{const[a,i]=l.useState(!1),[c,u]=l.useState(!1),C=l.useRef(null),h=l.useMemo(()=>e?{name:o.user?.name||`Cliente #${o.userId}`,avatar:o.user?.avatar,id:o.userId,icon:r.jsx(X,{className:"h-6 w-6 text-gray-500"}),route:`/admin/users/${o.userId}`}:{name:o.seller?.storeName||`Vendedor #${o.sellerId}`,avatar:o.seller?.avatar,id:o.sellerId,icon:r.jsx(te,{className:"h-6 w-6 text-gray-500"}),route:`/sellers/${o.sellerId}`},[e,o.user,o.userId,o.seller,o.sellerId]),{onlineStatus:j}=fe({chatId:o.id,participantId:h.id,pollInterval:6e4,enableTypingIndicator:!0}),{isOnline:I,lastSeen:w,isTyping:N}=j,v=l.useMemo(()=>e?`/seller/products/edit/${o.productId}`:`/products/${o.productId}`,[e,o.productId]);l.useEffect(()=>{const d=x=>{C.current&&!C.current.contains(x.target)&&i(!1)};return document.addEventListener("mousedown",d),()=>{document.removeEventListener("mousedown",d)}},[]);const f=()=>{i(!1)},S=async d=>{if(!(s||c||!o.id)){u(!0),f();try{console.log(`Cambiando estado de chat ${o.id} a ${d}`),await t(o.id,d)||console.error(`Error al cambiar estado a ${d}`)}catch(x){console.error(`Error al actualizar estado a ${d}:`,x)}finally{u(!1)}}},k=l.useCallback(d=>{const n=Math.floor((new Date().getTime()-d.getTime())/(1e3*60));if(n<1)return"hace un momento";if(n<60)return`hace ${n} min`;if(n<1440)return`hace ${Math.floor(n/60)} h`;{const g=Math.floor(n/1440);return g===1?"ayer":g<7?`hace ${g} d√≠as`:d.toLocaleDateString("es-EC",{day:"numeric",month:"short"})}},[]);return r.jsx("div",{className:"p-4 border-b border-gray-200 bg-white shadow-sm",children:r.jsxs("div",{className:"flex items-center justify-between",children:[r.jsxs("div",{className:"flex items-center flex-1 min-w-0",children:[r.jsxs("div",{className:"flex-shrink-0 mr-3 relative",children:[h.avatar?r.jsx("img",{src:h.avatar,alt:h.name,className:"h-12 w-12 rounded-full border-2 border-white shadow-sm",onError:d=>{const x=d.target;x.onerror=null,x.src="https://via.placeholder.com/48?text=U"}}):r.jsx("div",{className:"h-12 w-12 rounded-full bg-gray-200 flex items-center justify-center border-2 border-white shadow-sm",children:h.icon}),r.jsx("div",{className:`absolute -bottom-1 -right-1 ${I?"connection-indicator":"connection-indicator offline"}`,children:r.jsx("div",{className:`w-4 h-4 rounded-full border-2 border-white shadow-sm flex items-center justify-center ${I?"bg-green-500":"bg-gray-400"}`,children:I?r.jsx(je,{size:8,className:"text-white"}):r.jsx(Ee,{size:8,className:"text-white"})})})]}),r.jsxs("div",{className:"flex-1 min-w-0",children:[r.jsxs("div",{className:"flex items-center space-x-2 mb-1",children:[r.jsx(H,{to:h.route,className:"text-lg font-semibold text-gray-900 hover:text-primary-600 truncate transition-colors",children:h.name}),r.jsxs("span",{className:`inline-flex items-center px-2 py-0.5 rounded-full text-xs font-medium ${o.status==="active"?"bg-green-100 text-green-800":o.status==="closed"?"bg-blue-100 text-blue-800":"bg-gray-100 text-gray-800"}`,children:[r.jsx(q,{className:"w-1.5 h-1.5 mr-1",fill:"currentColor"}),o.status==="active"?"Activo":o.status==="closed"?"Cerrado":"Archivado"]})]}),r.jsx("div",{className:"flex items-center text-sm mb-1",children:N?r.jsxs("div",{className:"flex items-center text-primary-600 font-medium",children:[r.jsxs("div",{className:"typing-indicator flex space-x-1 mr-2",children:[r.jsx("div",{className:"w-1 h-1 bg-current rounded-full"}),r.jsx("div",{className:"w-1 h-1 bg-current rounded-full"}),r.jsx("div",{className:"w-1 h-1 bg-current rounded-full"})]}),r.jsx("span",{children:"escribiendo..."})]}):r.jsx("div",{className:"flex items-center text-gray-500",children:I?r.jsxs(r.Fragment,{children:[r.jsx(q,{className:"w-2 h-2 mr-2 fill-green-500 text-green-500"}),r.jsx("span",{className:"text-green-600 font-medium",children:"En l√≠nea"})]}):r.jsxs(r.Fragment,{children:[r.jsx(q,{className:"w-2 h-2 mr-2 fill-gray-400 text-gray-400"}),r.jsx("span",{children:w?`Visto ${k(w)}`:"Desconectado"})]})})}),r.jsx("div",{className:"flex items-center text-sm text-gray-500",children:r.jsxs(H,{to:v,className:"text-primary-600 hover:text-primary-700 hover:underline flex items-center truncate",title:o.product?.name||`Producto #${o.productId}`,children:[r.jsx(he,{className:"h-3.5 w-3.5 mr-1 flex-shrink-0"}),r.jsx("span",{className:"truncate max-w-xs",children:o.product?.name||`Producto #${o.productId}`}),r.jsx(Ne,{size:14,className:"ml-1 flex-shrink-0"})]})})]})]}),r.jsxs("div",{className:"flex items-center space-x-2",children:[(s||c)&&r.jsxs("div",{className:"flex items-center text-gray-500",children:[r.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-gray-400 mr-2"}),r.jsx("span",{className:"text-sm",children:c?"Actualizando...":"Cargando..."})]}),r.jsxs("div",{className:"relative",ref:C,children:[r.jsx("button",{onClick:()=>i(!a),className:"p-2 rounded-full hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-primary-500 transition-colors",disabled:s||c,title:"M√°s opciones",children:r.jsx(Se,{className:"h-5 w-5 text-gray-600"})}),a&&r.jsxs("div",{className:"absolute right-0 z-20 mt-2 w-56 bg-white rounded-lg shadow-lg border border-gray-200 py-1",children:[r.jsx("div",{className:"px-4 py-3 border-b border-gray-100 bg-gray-50",children:r.jsxs("div",{className:"flex items-center text-xs text-gray-500 space-x-4",children:[r.jsxs("span",{children:["ID: ",o.id]}),r.jsxs("span",{children:["Creado: ",o.createdAt?new Date(o.createdAt).toLocaleDateString("es-EC"):"N/A"]})]})}),r.jsxs("div",{className:"py-1",children:[o.status==="active"&&r.jsxs("button",{onClick:()=>S("closed"),className:"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors",disabled:s||c,children:[r.jsx(J,{className:"h-4 w-4 mr-3 text-gray-500"}),"Cerrar conversaci√≥n"]}),o.status==="closed"&&r.jsxs("button",{onClick:()=>S("active"),className:"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors",disabled:s||c,children:[r.jsx(ne,{className:"h-4 w-4 mr-3 text-gray-500"}),"Reabrir conversaci√≥n"]}),o.status!=="archived"&&r.jsxs("button",{onClick:()=>S("archived"),className:"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors",disabled:s||c,children:[r.jsx(me,{className:"h-4 w-4 mr-3 text-gray-500"}),"Archivar conversaci√≥n"]}),o.status==="archived"&&r.jsxs("button",{onClick:()=>S("active"),className:"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors",disabled:s||c,children:[r.jsx(ne,{className:"h-4 w-4 mr-3 text-gray-500"}),"Desarchivar conversaci√≥n"]})]}),r.jsxs("div",{className:"border-t border-gray-100 py-1",children:[r.jsxs(H,{to:h.route,className:"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors",children:[r.jsx(Ce,{className:"h-4 w-4 mr-3 text-gray-500"}),"Ver perfil"]}),r.jsxs(H,{to:v,className:"flex items-center w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 transition-colors",children:[r.jsx(Ie,{className:"h-4 w-4 mr-3 text-gray-500"}),"Ver producto"]})]})]})]})]})]})})},se={Frecuentes:{icon:"üïí",emojis:["üòä","üòÇ","‚ù§Ô∏è","üëç","üëå","üôè","üòç","üéâ","ü§î","üò≠","üî•","üí™"]},Emociones:{icon:"üòä",emojis:["üòÄ","üòÉ","üòÑ","üòÅ","üòÜ","üòÖ","üòÇ","ü§£","üòä","üòá","üôÇ","üôÉ","üòâ","üòå","üòç","ü•∞","üòò","üòó","üòô","üòö","üòã","üòõ","üòù","üòú","ü§™","ü§®","üßê","ü§ì","üòé","ü§©","ü•≥","üòè","üòí","üòû","üòî","üòü","üòï","üôÅ","‚òπÔ∏è","üò£","üòñ","üò´","üò©","ü•∫","üò¢","üò≠","üò§","üò†","üò°","ü§¨","ü§Ø","üò≥","ü•µ","ü•∂","üò±","üò®","üò∞","üò•","üòì","ü§ó","ü§î","ü§≠","ü§´","ü§•","üò∂","üòê","üòë","üò¨","üôÑ","üòØ","üò¶","üòß","üòÆ","üò≤","ü•±","üò¥","ü§§","üò™","üòµ","ü§ê","ü•¥","ü§¢","ü§Æ","ü§ß","üò∑","ü§í","ü§ï"]},Gestos:{icon:"üëç",emojis:["üëç","üëé","üëå","ü§å","ü§è","‚úåÔ∏è","ü§û","ü§ü","ü§ò","ü§ô","üëà","üëâ","üëÜ","üñï","üëá","‚òùÔ∏è","üëè","üôå","üëê","ü§≤","ü§ù","üôè","‚úçÔ∏è","üíÖ","ü§≥","üí™","ü¶æ","ü¶ø","ü¶µ","ü¶∂","üëÇ","ü¶ª","üëÉ","üß†","ü´Ä","ü´Å","ü¶∑","ü¶¥","üëÄ","üëÅÔ∏è","üëÖ","üëÑ","üíã"]},Objetos:{icon:"‚ù§Ô∏è",emojis:["‚ù§Ô∏è","üß°","üíõ","üíö","üíô","üíú","üñ§","ü§ç","ü§é","üíî","‚ù£Ô∏è","üíï","üíû","üíì","üíó","üíñ","üíò","üíù","üíü","‚òÆÔ∏è","‚úùÔ∏è","‚ò™Ô∏è","üïâÔ∏è","‚ò∏Ô∏è","‚ú°Ô∏è","üîØ","üïé","‚òØÔ∏è","‚ò¶Ô∏è","üõê","‚õé","‚ôà","‚ôâ","‚ôä","‚ôã","‚ôå","‚ôç","‚ôé","‚ôè","‚ôê","‚ôë","‚ôí","‚ôì","üî•","üíØ","üí¢","üí¶","üí®","üéâ","üéä","üéà","üéÅ","üèÜ","ü•á","ü•à","ü•â","‚≠ê","üåü","üí´","‚ú®"]},Animales:{icon:"üê∂",emojis:["üê∂","üê±","üê≠","üêπ","üê∞","ü¶ä","üêª","üêº","üêª‚Äç‚ùÑÔ∏è","üê®","üêØ","ü¶Å","üêÆ","üê∑","üêΩ","üê∏","üêµ","üôà","üôâ","üôä","üêí","üêî","üêß","üê¶","üê§","üê£","üê•","ü¶Ü","ü¶Ö","ü¶â","ü¶á","üê∫","üêó","üê¥","ü¶Ñ","üêù","üêõ","ü¶ã","üêå","üêû","üêú","ü¶ü","ü¶ó","üï∑Ô∏è","ü¶Ç","üê¢","üêç","ü¶é","ü¶ñ","ü¶ï","üêô","ü¶ë","ü¶ê","ü¶û","ü¶Ä","üê°","üê†","üêü","üê¨","üê≥","üêã","ü¶à","üêä","üêÖ","üêÜ","ü¶ì","ü¶ç","ü¶ß","üêò","ü¶£","ü¶è","ü¶õ","üê™","üê´","ü¶í","ü¶ò","üêÉ","üêÇ","üêÑ","üêé","üêñ","üêè","üêë","ü¶ô","üêê","ü¶å","üêï","üê©","ü¶Æ","üêï‚Äçü¶∫","üêà","üêà‚Äç‚¨õ","üêì","ü¶É","ü¶ö","ü¶ú","ü¶¢","ü¶©","üïäÔ∏è","üêá","ü¶ù","ü¶®","ü¶°","ü¶¶","ü¶•","üêÅ","üêÄ","üêøÔ∏è"]},Comida:{icon:"üçï",emojis:["üçé","üçè","üçê","üçä","üçã","üçå","üçâ","üçá","üçì","ü´ê","üçà","üçí","üçë","ü•≠","üçç","ü••","ü•ù","üçÖ","üçÜ","ü•ë","ü•¶","ü•¨","ü•í","üå∂Ô∏è","ü´ë","üåΩ","ü•ï","ü´í","üßÑ","üßÖ","ü•î","üç†","ü•ê","ü•Ø","üçû","ü•ñ","ü•®","üßÄ","ü•ö","üç≥","üßà","ü•û","üßá","ü•ì","ü•©","üçó","üçñ","ü¶¥","üå≠","üçî","üçü","üçï","ü´ì","ü•™","ü•ô","üßÜ","üåÆ","üåØ","ü´î","ü•ó","ü•ò","ü´ï","ü•´","üçù","üçú","üç≤","üçõ","üç£","üç±","ü•ü","ü¶™","üç§","üçô","üçö","üçò","üç•","ü•†","ü•Æ","üç¢","üç°","üçß","üç®","üç¶","ü•ß","üßÅ","üç∞","üéÇ","üçÆ","üç≠","üç¨","üç´","üçø","üç©","üç™","üå∞","ü•ú"]},Actividades:{icon:"‚öΩ",emojis:["‚öΩ","üèÄ","üèà","‚öæ","ü•é","üéæ","üèê","üèâ","ü•è","üé±","ü™Ä","üèì","üè∏","üèë","üèí","ü•ç","üèè","ü™É","ü•Ö","‚õ≥","ü™Å","üèπ","üé£","ü§ø","ü•ä","ü•ã","üéΩ","üõπ","üõ∑","‚õ∏Ô∏è","ü•å","üéø","‚õ∑Ô∏è","üèÇ","ü™Ç","üèãÔ∏è","ü§º","ü§∏","‚õπÔ∏è","ü§∫","üèåÔ∏è","üèá","üßò","üèÑ","üèä","ü§Ω","üö£","üßó","üöµ","üö¥","üèÜ","ü•á","ü•à","ü•â","üèÖ","üéñÔ∏è","üèµÔ∏è","üéóÔ∏è","üé´","üéüÔ∏è","üé™","ü§π","üé≠","ü©∞","üé®","üé¨","üé§","üéß","üéº","üéµ","üé∂","üéπ","ü•Å","üé∑","üé∫","üé∏","ü™ï","üéª","üé≤","‚ô†Ô∏è","‚ô•Ô∏è","‚ô¶Ô∏è","‚ô£Ô∏è","‚ôüÔ∏è","üÉè","üÄÑ","üé¥","üéÆ","üïπÔ∏è","üéØ"]},Viajes:{icon:"‚úàÔ∏è",emojis:["üöó","üöï","üöô","üöå","üöé","üèéÔ∏è","üöì","üöë","üöí","üöê","üõª","üöö","üöõ","üöú","üèçÔ∏è","üõµ","üö≤","üõ¥","üõπ","üõº","üöÅ","üõ∏","‚úàÔ∏è","üõ©Ô∏è","üõ´","üõ¨","ü™Ç","‚õµ","üö§","üõ•Ô∏è","üõ≥Ô∏è","‚õ¥Ô∏è","üö¢","‚öì","‚õΩ","üöß","üö¶","üö•","üöè","üó∫Ô∏è","üé°","üé¢","üé†","‚õ≤","‚õ±Ô∏è","üèñÔ∏è","üèùÔ∏è","üèúÔ∏è","üåã","‚õ∞Ô∏è","üèîÔ∏è","üóª","üèïÔ∏è","‚õ∫","üè†","üè°","üèòÔ∏è","üèöÔ∏è","üèóÔ∏è","üè≠","üè¢","üè¨","üè£","üè§","üè•","üè¶","üè®","üè™","üè´","üè©","üíí","üèõÔ∏è","‚õ™","üïå","üõï","üïç","üïã","‚õ©Ô∏è","üõ§Ô∏è","üõ£Ô∏è","üóæ","üéë","üèûÔ∏è","üåÖ","üåÑ","üå†","üéá","üéÜ","üåá","üåÜ","üèôÔ∏è","üåÉ","üåå","üåâ","üåÅ"]}},ue=()=>{try{const o=localStorage.getItem("frequent-emojis");if(o)return JSON.parse(o).slice(0,12)}catch(o){console.error("Error loading frequent emojis:",o)}return se.Frecuentes.emojis},Pr=o=>{try{const e=localStorage.getItem("frequent-emojis");let t=e?JSON.parse(e):[];t=t.filter(s=>s!==o),t.unshift(o),t=t.slice(0,20),localStorage.setItem("frequent-emojis",JSON.stringify(t))}catch(e){console.error("Error saving emoji usage:",e)}},Wr=({onSendMessage:o,isDisabled:e=!1,disabledText:t="Esta conversaci√≥n est√° cerrada",placeholder:s="Escribe un mensaje...",isLoading:a=!1,chatId:i})=>{const[c,u]=l.useState(""),[C,h]=l.useState(null),[j,I]=l.useState(!1),[w,N]=l.useState("Frecuentes"),[v,f]=l.useState(""),[S,k]=l.useState(()=>ue()),d=l.useRef(null),x=l.useRef(null),n=l.useRef(null),g=l.useRef(!0),{startTyping:T,stopTyping:R}=Mr(i);l.useEffect(()=>()=>{g.current=!1,R()},[R]),l.useEffect(()=>{j&&k(ue())},[j]),l.useEffect(()=>{d.current&&!e&&d.current.focus()},[e]),l.useEffect(()=>{const p=E=>{x.current&&!x.current.contains(E.target)&&(I(!1),f(""))};return j&&document.addEventListener("mousedown",p),()=>{document.removeEventListener("mousedown",p)}},[j]),l.useEffect(()=>{j&&n.current&&setTimeout(()=>{n.current?.focus()},100)},[j]);const D=async p=>{if(p.preventDefault(),h(null),e||a||!c.trim()){console.log("Env√≠o bloqueado:",{isDisabled:e,isLoading:a,messageEmpty:!c.trim()});return}const E=c.trim();R(),console.log("üßπ Limpiando form antes de enviar"),u(""),d.current&&(d.current.style.height="auto");try{console.log("Enviando mensaje:",E);const P=await o(E);g.current&&(P?(console.log("‚úÖ Mensaje enviado correctamente"),d.current&&d.current.focus()):(console.error("‚ùå Error al enviar mensaje - restaurando contenido"),u(E),h("No se pudo enviar el mensaje. Int√©ntalo de nuevo.")))}catch(P){console.error("Error al enviar mensaje:",P),g.current&&(u(E),h("Error al enviar mensaje. Por favor, int√©ntalo de nuevo."))}},b=p=>{C&&h(null),(p.ctrlKey||p.metaKey)&&p.key==="Enter"&&(p.preventDefault(),D(p))},m=p=>{const E=p.target,P=E.value;E.style.height="auto";const Q=Math.min(Math.max(E.scrollHeight,40),150);E.style.height=`${Q}px`,u(P),P.trim()&&!e&&!a?P!==c&&T():P.trim()||R()},M=l.useCallback(p=>{const E=d.current;if(!E)return;const P=E.selectionStart,Q=E.selectionEnd,xe=c.slice(0,P)+p+c.slice(Q);u(xe),Pr(p),setTimeout(()=>{if(E){E.focus(),E.setSelectionRange(P+p.length,P+p.length),E.style.height="auto";const pe=Math.min(Math.max(E.scrollHeight,40),150);E.style.height=`${pe}px`}},0)},[c]),Z=l.useCallback(p=>v.trim()?p.filter(E=>E.includes(v.trim())):p,[v]),oe=l.useMemo(()=>Z(w==="Frecuentes"?S:se[w].emojis),[w,S,Z]);return e?r.jsx("div",{className:"p-4 border-t border-gray-200 bg-gray-50",children:r.jsxs("div",{className:"flex items-center justify-center space-x-2 text-gray-500",children:[r.jsx(J,{size:16}),r.jsx("p",{className:"text-sm",children:t})]})}):r.jsxs("div",{className:"p-4 border-t border-gray-200 bg-white relative",children:[C&&r.jsxs("div",{className:"mb-3 p-3 bg-red-50 border border-red-200 text-red-600 text-sm rounded-lg flex items-start space-x-2",children:[r.jsx("div",{className:"flex-shrink-0 mt-0.5",children:"‚ö†Ô∏è"}),r.jsx("div",{className:"flex-1",children:C}),r.jsx("button",{onClick:()=>h(null),className:"flex-shrink-0 text-red-400 hover:text-red-600",children:"√ó"})]}),j&&r.jsxs("div",{ref:x,className:"absolute bottom-full left-4 right-4 mb-2 bg-white border border-gray-300 rounded-xl shadow-xl z-50 overflow-hidden",style:{maxHeight:"320px"},children:[r.jsx("div",{className:"p-3 border-b border-gray-200 bg-gray-50",children:r.jsxs("div",{className:"relative",children:[r.jsx(ge,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400",size:16}),r.jsx("input",{ref:n,type:"text",placeholder:"Buscar emojis...",value:v,onChange:p=>f(p.target.value),className:"w-full pl-10 pr-4 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500"})]})}),r.jsx("div",{className:"border-b border-gray-200 bg-gray-50",children:r.jsx("div",{className:"flex overflow-x-auto scrollbar-hide",children:Object.entries(se).map(([p,E])=>r.jsx("button",{onClick:()=>{N(p),f("")},className:`flex-shrink-0 px-3 py-2 text-lg hover:bg-gray-100 transition-colors ${w===p?"bg-primary-100 border-b-2 border-primary-500":""}`,title:p,children:p==="Frecuentes"?"üïí":E.icon},p))})}),r.jsxs("div",{className:"p-2 max-h-48 overflow-y-auto emoji-scroll",children:[r.jsx("div",{className:"grid grid-cols-8 gap-1",children:oe.map((p,E)=>r.jsx("button",{onClick:()=>{M(p)},className:"p-2 text-lg hover:bg-gray-100 rounded-lg transition-colors transform hover:scale-110 active:scale-95",title:p,children:p},`${p}-${E}`))}),oe.length===0&&r.jsxs("div",{className:"text-center py-8 text-gray-500",children:[r.jsx("div",{className:"text-2xl mb-2",children:"üîç"}),r.jsx("p",{className:"text-sm",children:"No se encontraron emojis"})]})]}),r.jsx("div",{className:"p-2 border-t border-gray-200 bg-gray-50 text-center",children:r.jsx("button",{onClick:()=>I(!1),className:"text-xs text-gray-500 hover:text-gray-700",children:"Presiona ESC para cerrar"})})]}),r.jsxs("form",{onSubmit:D,className:"flex items-end space-x-3",children:[r.jsx("button",{type:"button",onClick:()=>I(!j),className:`flex-shrink-0 p-2 rounded-full transition-colors ${j?"bg-primary-100 text-primary-600":"text-gray-500 hover:text-gray-700 hover:bg-gray-100"}`,disabled:a,title:"Insertar emoji",children:r.jsx(Ae,{size:20})}),r.jsxs("div",{className:"flex-1",children:[r.jsx("textarea",{ref:d,value:c,onChange:m,onKeyDown:b,placeholder:s,className:"w-full border border-gray-300 rounded-2xl px-4 py-3 focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500 resize-none scrollbar-thin scrollbar-thumb-gray-300 scrollbar-track-transparent",rows:1,style:{minHeight:"44px",maxHeight:"150px"},disabled:a}),r.jsxs("div",{className:"flex items-center justify-between mt-1 px-1",children:[r.jsx("p",{className:"text-xs text-gray-500",children:a?"Enviando...":"Ctrl+Enter para enviar"}),c.length>0&&r.jsxs("p",{className:"text-xs text-gray-400",children:[c.length,"/2000"]})]})]}),r.jsx("button",{type:"submit",className:`flex-shrink-0 h-11 w-11 rounded-full flex items-center justify-center transition-all transform ${c.trim()&&!a?"bg-primary-600 text-white hover:bg-primary-700 hover:scale-105 active:scale-95 shadow-lg":"bg-gray-300 text-gray-600 cursor-not-allowed"}`,disabled:!c.trim()||a,title:a?"Enviando...":"Enviar mensaje",children:a?r.jsx(ke,{className:"h-5 w-5 animate-spin"}):r.jsx(Te,{size:18})})]}),j&&r.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>I(!1),onKeyDown:p=>{p.key==="Escape"&&I(!1)},tabIndex:-1})]})};export{K as A,Gr as C,G,Wr as M,zr as a,Fr as b,Lr as f,Ke as u};
//# sourceMappingURL=chat-chunk-dxmpBB-S.js.map
