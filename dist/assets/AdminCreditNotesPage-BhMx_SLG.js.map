{"version":3,"file":"AdminCreditNotesPage-BhMx_SLG.js","sources":["../../src/infrastructure/repositories/HttpCreditNoteRepository.ts","../../src/core/useCases/admin/creditNote/GetAllCreditNotesUseCase.ts","../../src/core/useCases/admin/creditNote/GetCreditNoteByIdUseCase.ts","../../src/core/useCases/admin/creditNote/RetryCreditNoteUseCase.ts","../../src/core/useCases/admin/creditNote/CheckCreditNoteStatusUseCase.ts","../../src/core/useCases/admin/creditNote/GetCreditNoteStatsUseCase.ts","../../src/core/useCases/admin/creditNote/UpdateCreditNoteUseCase.ts","../../src/core/useCases/admin/creditNote/CreateCreditNoteUseCase.ts","../../src/core/useCases/admin/creditNote/GetAuthorizedInvoicesUseCase.ts","../../src/presentation/pages/admin/AdminCreditNotesPage.tsx"],"sourcesContent":["import { ApiClient } from '../api/apiClient';\r\nimport appConfig from '../../config/appConfig';\r\nimport type { CreditNoteRepository } from '../../core/domain/repositories/CreditNoteRepository';\r\nimport type { PaginatedApiResponse } from '../../core/domain/entities/ApiResponse';\r\nimport type { CreditNoteFilters, AdminCreditNote } from '../../core/useCases/admin/creditNote/GetAllCreditNotesUseCase';\r\nimport type { CreditNoteDetail } from '../../core/useCases/admin/creditNote/GetCreditNoteByIdUseCase';\r\nimport type { RetryCreditNoteResponse } from '../../core/useCases/admin/creditNote/RetryCreditNoteUseCase';\r\nimport type { CreditNoteStatusCheck } from '../../core/useCases/admin/creditNote/CheckCreditNoteStatusUseCase';\r\nimport type { CreditNoteStats } from '../../core/useCases/admin/creditNote/GetCreditNoteStatsUseCase';\r\nimport type { UpdateCreditNoteRequest, UpdateCreditNoteResponse } from '../../core/useCases/admin/creditNote/UpdateCreditNoteUseCase';\r\nimport type { SriCreditNoteRequest, SriCreditNoteResponse } from '../../core/useCases/admin/creditNote/CreateCreditNoteUseCase';\r\n\r\n// Interfaces para facturas autorizadas (mantener UX)\r\nexport interface AuthorizedInvoice {\r\n  id: number;\r\n  invoice_number: string;\r\n  display_label: string;\r\n  customer: {\r\n    name: string;\r\n    identification: string;\r\n    identification_type: string;\r\n    email?: string;\r\n    address: string;\r\n    phone?: string;\r\n  };\r\n  amounts: {\r\n    total: number;\r\n    subtotal: number;\r\n    tax: number;\r\n  };\r\n  issue_date: string;        // ✅ Campo devuelto por backend\r\n  created_at: string;        // ✅ Campo devuelto por backend\r\n}\r\n\r\nexport interface GetAuthorizedInvoicesResponse {\r\n  success: boolean;\r\n  data: AuthorizedInvoice[];\r\n  total: number;\r\n}\r\n\r\n// Interface para detalles de factura\r\nexport interface InvoiceDetail {\r\n  product_code: string;\r\n  product_name: string;\r\n  quantity: number;\r\n  unit_price: number;\r\n  discount?: number;\r\n  codigo_iva: string;\r\n}\r\n\r\nexport class HttpCreditNoteRepository implements CreditNoteRepository {\r\n\r\n  async getAllCreditNotes(filters: CreditNoteFilters = {}): Promise<PaginatedApiResponse<AdminCreditNote>> {\r\n    try {\r\n      // Usar endpoint SRI con filtros SRI\r\n      const queryParams: Record<string, any> = {};\r\n\r\n      if (filters.page) queryParams.page = filters.page;\r\n      if (filters.limit) queryParams.limit = filters.limit;\r\n      if (filters.estado) queryParams.estado = filters.estado;\r\n      if (filters.fechaDesde) queryParams.fechaDesde = filters.fechaDesde;\r\n      if (filters.fechaHasta) queryParams.fechaHasta = filters.fechaHasta;\r\n\r\n      const response = await ApiClient.get<any>('/credit-notes', queryParams);\r\n\r\n      // Adaptar respuesta del backend a formato esperado por el frontend\r\n      const creditNotes = response?.data || [];\r\n      const pagination = response?.meta || {\r\n        page: 1,\r\n        limit: 20,\r\n        total: 0,\r\n        totalPages: 1,\r\n        hasNext: false,\r\n        hasPrev: false\r\n      };\r\n\r\n      // Usar paginación del backend directamente (ya está en formato correcto)\r\n      const meta = {\r\n        current_page: pagination.current_page || 1,\r\n        last_page: pagination.last_page || 1,\r\n        per_page: pagination.per_page || 20,\r\n        total: pagination.total || 0,\r\n        from: pagination.from || 1,\r\n        to: pagination.to || 0,\r\n      };\r\n\r\n      return {\r\n        status: 'success',\r\n        message: 'Notas de crédito obtenidas exitosamente',\r\n        data: {\r\n          data: creditNotes,\r\n          meta: meta,\r\n          links: {\r\n            first: '',\r\n            last: '',\r\n            prev: pagination.hasPrev ? '' : null,\r\n            next: pagination.hasNext ? '' : null,\r\n          }\r\n        }\r\n      };\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.getAllCreditNotes:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async getCreditNoteById(id: number): Promise<CreditNoteDetail> {\r\n    try {\r\n      // Mantener endpoint admin para detalles específicos de administración\r\n      const response = await ApiClient.get<any>(`/admin/credit-notes/${id}`);\r\n      return response.data;\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.getCreditNoteById:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async createCreditNote(creditNoteData: SriCreditNoteRequest): Promise<SriCreditNoteResponse> {\r\n    try {\r\n      // Enviar datos SRI exactos sin transformación\r\n      const response = await ApiClient.post<any>('/credit-notes', creditNoteData);\r\n      return response;\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.createCreditNote:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async validateCreditNote(creditNoteData: SriCreditNoteRequest): Promise<any> {\r\n    try {\r\n      // Validar datos sin procesarlos (endpoint SRI)\r\n      const response = await ApiClient.post<any>('/credit-notes/validate', creditNoteData);\r\n      return response;\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.validateCreditNote:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async getCreditNoteStatusByAccessKey(claveAcceso: string): Promise<any> {\r\n    try {\r\n      // Obtener estado por clave de acceso (endpoint SRI)\r\n      const response = await ApiClient.get<any>(`/credit-notes/status/${claveAcceso}`);\r\n      return response;\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.getCreditNoteStatusByAccessKey:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async retryCreditNote(creditNoteId: number): Promise<RetryCreditNoteResponse> {\r\n    try {\r\n      // Mantener endpoint admin para reintentos\r\n      const response = await ApiClient.post<any>(`/admin/credit-notes/${creditNoteId}/retry`, {});\r\n      return response.data;\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.retryCreditNote:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async checkCreditNoteStatus(creditNoteId: number): Promise<CreditNoteStatusCheck> {\r\n    try {\r\n      // Mantener endpoint admin para consulta de estado por ID\r\n      const response = await ApiClient.get<any>(`/admin/credit-notes/${creditNoteId}/check-status`);\r\n      return response.data;\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.checkCreditNoteStatus:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async getCreditNoteStats(): Promise<CreditNoteStats> {\r\n    try {\r\n      // Mantener endpoint admin para estadísticas\r\n      const response = await ApiClient.get<any>('/admin/credit-notes/stats/overview');\r\n      return response.data;\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.getCreditNoteStats:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async updateCreditNote(creditNoteId: number, updateData: UpdateCreditNoteRequest): Promise<UpdateCreditNoteResponse> {\r\n    try {\r\n      // Mantener endpoint admin para actualizaciones\r\n      const response = await ApiClient.put<any>(`/admin/credit-notes/${creditNoteId}`, updateData);\r\n      return response.data;\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.updateCreditNote:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async downloadCreditNotePdf(creditNoteId: number): Promise<Blob> {\r\n    try {\r\n      // Mantener endpoint admin para descarga de PDF\r\n      const response = await fetch(`${appConfig.api.baseUrl}/admin/credit-notes/${creditNoteId}/download-pdf`, {\r\n        method: 'GET',\r\n        headers: {\r\n          'Authorization': `Bearer ${localStorage.getItem(appConfig.storage.authTokenKey)}`,\r\n          'Accept': 'application/pdf',\r\n        },\r\n      });\r\n\r\n      if (!response.ok) {\r\n        throw new Error(`Error ${response.status}: ${response.statusText}`);\r\n      }\r\n\r\n      return await response.blob();\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.downloadCreditNotePdf:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  // Métodos restaurados para mantener la excelente UX\r\n  async getAuthorizedInvoices(search?: string, limit?: number): Promise<GetAuthorizedInvoicesResponse> {\r\n    try {\r\n      const queryParams: Record<string, any> = {};\r\n      if (search) queryParams.search = search;\r\n      if (limit) queryParams.limit = limit;\r\n\r\n      // Usar endpoint real de facturas (no admin)\r\n      const response = await ApiClient.get<any>('/invoices/authorized', queryParams);\r\n      return response;\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.getAuthorizedInvoices:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  async getInvoiceDetails(invoiceId: number): Promise<InvoiceDetail[]> {\r\n    try {\r\n      // Usar endpoint real de facturas (no admin)\r\n      const response = await ApiClient.get<any>(`/invoices/${invoiceId}/details`);\r\n      return response.data;\r\n    } catch (error) {\r\n      console.error('Error en HttpCreditNoteRepository.getInvoiceDetails:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}","import type { CreditNoteRepository } from '../../../domain/repositories/CreditNoteRepository';\r\nimport type { PaginatedResponse } from '../../../domain/entities/ApiResponse';\r\n\r\nexport interface CreditNoteFilters {\r\n  status?: string;\r\n  customer_identification?: string;\r\n  customer_name?: string;\r\n  start_date?: string;\r\n  end_date?: string;\r\n  credit_note_number?: string;\r\n  page?: number;\r\n  per_page?: number;\r\n  // Filtros adicionales SRI\r\n  limit?: number;\r\n  estado?: string;\r\n  fechaDesde?: string;\r\n  fechaHasta?: string;\r\n}\r\n\r\nexport interface AdminCreditNote {\r\n  id: number;\r\n  credit_note_number: string;\r\n  issue_date: string;\r\n  status: string;\r\n  status_label: string;\r\n  status_color: string;\r\n  customer: {\r\n    identification: string;\r\n    identification_type: string;\r\n    name: string;\r\n    email: string;\r\n    address: string;\r\n    phone: string;\r\n  };\r\n  subtotal: number;\r\n  tax_amount: number;\r\n  total_amount: number;\r\n  currency: string;\r\n  motivo: string;\r\n  documento_modificado: string;\r\n  sri_access_key?: string;\r\n  sri_authorization_number?: string;\r\n  sri_error_message?: string;\r\n  retry_count: number;\r\n  last_retry_at?: string;\r\n  invoice?: {\r\n    id: number;\r\n    invoice_number: string;\r\n    status: string;\r\n  };\r\n  order?: {\r\n    id: number;\r\n    order_number: string;\r\n    user: {\r\n      name: string;\r\n      email: string;\r\n    };\r\n  };\r\n  items_count: number;\r\n  created_at: string;\r\n}\r\n\r\nexport class GetAllCreditNotesUseCase {\r\n  constructor(private creditNoteRepository: CreditNoteRepository) {}\r\n\r\n  async execute(filters: CreditNoteFilters = {}): Promise<PaginatedResponse<AdminCreditNote>> {\r\n    try {\r\n      const response = await this.creditNoteRepository.getAllCreditNotes(filters);\r\n      return response.data;\r\n    } catch (error) {\r\n      console.error('Error en GetAllCreditNotesUseCase:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}","import type { CreditNoteRepository } from '../../../domain/repositories/CreditNoteRepository';\r\n\r\nexport interface CreditNoteDetail {\r\n  id: number;\r\n  credit_note_number: string;\r\n  issue_date: string;\r\n  status: string;\r\n  status_label: string;\r\n  status_color: string;\r\n  customer: {\r\n    identification: string;\r\n    identification_type: string;\r\n    identification_type_label: string;\r\n    name: string;\r\n    email: string;\r\n    address: string;\r\n    phone: string;\r\n  };\r\n  subtotal: number;\r\n  tax_amount: number;\r\n  total_amount: number;\r\n  currency: string;\r\n  motivo: string;\r\n  documento_modificado: {\r\n    tipo: string;\r\n    numero: string;\r\n    fecha: string;\r\n  };\r\n  sri: {\r\n    access_key?: string;\r\n    authorization_number?: string;\r\n    error_message?: string;\r\n    response?: any;\r\n  };\r\n  retry_info: {\r\n    count: number;\r\n    last_retry_at?: string;\r\n    can_retry: boolean;\r\n  };\r\n  invoice?: {\r\n    id: number;\r\n    invoice_number: string;\r\n    status: string;\r\n    issue_date: string;\r\n    total_amount: number;\r\n  };\r\n  order?: {\r\n    id: number;\r\n    order_number: string;\r\n    status: string;\r\n    payment_status: string;\r\n    payment_method: string;\r\n    user: {\r\n      id?: number;\r\n      name: string;\r\n      email: string;\r\n    };\r\n  };\r\n  items: CreditNoteItemDetail[];\r\n  created_via: string;\r\n  created_at: string;\r\n  updated_at: string;\r\n}\r\n\r\nexport interface CreditNoteItemDetail {\r\n  id: number;\r\n  product_code: string;\r\n  product_name: string;\r\n  quantity: number;\r\n  unit_price: number;\r\n  discount: number;\r\n  subtotal: number;\r\n  tax_rate: number;\r\n  tax_amount: number;\r\n  codigo_iva: string;\r\n  product?: {\r\n    id: number;\r\n    name: string;\r\n    slug: string;\r\n  };\r\n}\r\n\r\nexport class GetCreditNoteByIdUseCase {\r\n  constructor(private creditNoteRepository: CreditNoteRepository) {}\r\n\r\n  async execute(id: number): Promise<CreditNoteDetail> {\r\n    try {\r\n      return await this.creditNoteRepository.getCreditNoteById(id);\r\n    } catch (error) {\r\n      console.error('Error en GetCreditNoteByIdUseCase:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}","import type { CreditNoteRepository } from '../../../domain/repositories/CreditNoteRepository';\r\n\r\nexport interface RetryCreditNoteResponse {\r\n  success: boolean;\r\n  message: string;\r\n  data: {\r\n    credit_note_id: number;\r\n    retry_count: number;\r\n    sri_response: any;\r\n  };\r\n}\r\n\r\nexport class RetryCreditNoteUseCase {\r\n  constructor(private creditNoteRepository: CreditNoteRepository) {}\r\n\r\n  async execute(creditNoteId: number): Promise<RetryCreditNoteResponse> {\r\n    try {\r\n      return await this.creditNoteRepository.retryCreditNote(creditNoteId);\r\n    } catch (error) {\r\n      console.error('Error en RetryCreditNoteUseCase:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}","import type { CreditNoteRepository } from '../../../domain/repositories/CreditNoteRepository';\r\n\r\nexport interface CreditNoteStatusCheck {\r\n  success: boolean;\r\n  credit_note_id: number;\r\n  current_status: string;\r\n  sri_status: any;\r\n  sri_access_key: string;\r\n  sri_authorization_number?: string;\r\n  data: {\r\n    credit_note_id: number;\r\n    current_status: string;\r\n    sri_status: any;\r\n  };\r\n}\r\n\r\nexport class CheckCreditNoteStatusUseCase {\r\n  constructor(private creditNoteRepository: CreditNoteRepository) {}\r\n\r\n  async execute(creditNoteId: number): Promise<CreditNoteStatusCheck> {\r\n    try {\r\n      return await this.creditNoteRepository.checkCreditNoteStatus(creditNoteId);\r\n    } catch (error) {\r\n      console.error('Error en CheckCreditNoteStatusUseCase:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}","import type { CreditNoteRepository } from '../../../domain/repositories/CreditNoteRepository';\r\n\r\nexport interface CreditNoteStats {\r\n  sri_stats: {\r\n    total_credit_notes: number;\r\n    authorized: number;\r\n    pending: number;\r\n    failed: number;\r\n    definitively_failed: number;\r\n    draft: number;\r\n    success_rate: number;\r\n  };\r\n  additional_stats: {\r\n    failed_credit_notes: number;\r\n    pending_retries: number;\r\n    recent_credit_notes: RecentCreditNote[];\r\n  };\r\n}\r\n\r\nexport interface RecentCreditNote {\r\n  id: number;\r\n  credit_note_number: string;\r\n  customer_name: string;\r\n  total_amount: number;\r\n  status: string;\r\n  created_at: string;\r\n}\r\n\r\nexport class GetCreditNoteStatsUseCase {\r\n  constructor(private creditNoteRepository: CreditNoteRepository) {}\r\n\r\n  async execute(): Promise<CreditNoteStats> {\r\n    try {\r\n      return await this.creditNoteRepository.getCreditNoteStats();\r\n    } catch (error) {\r\n      console.error('Error en GetCreditNoteStatsUseCase:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}","import type { CreditNoteRepository } from '../../../domain/repositories/CreditNoteRepository';\r\n\r\nexport interface UpdateCreditNoteRequest {\r\n  customer_name?: string;\r\n  customer_identification?: string;\r\n  customer_email?: string;\r\n  customer_address?: string;\r\n  customer_phone?: string;\r\n  motivo?: string;\r\n}\r\n\r\nexport interface UpdateCreditNoteResponse {\r\n  success: boolean;\r\n  message: string;\r\n  data: {\r\n    credit_note_id: number;\r\n    updated_fields: string[];\r\n  };\r\n}\r\n\r\nexport class UpdateCreditNoteUseCase {\r\n  constructor(private creditNoteRepository: CreditNoteRepository) {}\r\n\r\n  async execute(creditNoteId: number, updateData: UpdateCreditNoteRequest): Promise<UpdateCreditNoteResponse> {\r\n    try {\r\n      return await this.creditNoteRepository.updateCreditNote(creditNoteId, updateData);\r\n    } catch (error) {\r\n      console.error('Error en UpdateCreditNoteUseCase:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}","import type { CreditNoteRepository } from '../../../domain/repositories/CreditNoteRepository';\r\n\r\n// Interfaces SRI exactas según documentación\r\nexport interface SriCreditNoteRequest {\r\n  secuencial: string;\r\n  fechaEmision: string;\r\n  motivo: string;\r\n  documentoModificado: {\r\n    tipo: string;\r\n    numero: string;\r\n    fechaEmision: string;\r\n  };\r\n  comprador: {\r\n    tipoIdentificacion: string;\r\n    identificacion: string;\r\n    razonSocial: string;\r\n    direccion?: string;\r\n    email?: string;\r\n    telefono?: string;\r\n  };\r\n  detalles: SriCreditNoteDetail[];\r\n  informacionAdicional?: {\r\n    [key: string]: string;\r\n  };\r\n}\r\n\r\nexport interface SriCreditNoteDetail {\r\n  codigoInterno: string;\r\n  descripcion: string;\r\n  cantidad: number;\r\n  precioUnitario: number;\r\n  descuento?: number;\r\n  codigoIva: '0' | '2' | '3' | '4' | '5' | '6' | '7';\r\n}\r\n\r\n// Respuesta SRI exacta según documentación\r\nexport interface SriCreditNoteResponse {\r\n  success: boolean;\r\n  message: string;\r\n  data: {\r\n    notaCreditoId?: number;\r\n    claveAcceso?: string;\r\n    numeroNotaCredito: string;\r\n    estado: string;\r\n    fechaEmision: string;\r\n    total: number;\r\n    motivo: string;\r\n    documentoModificado: string;\r\n    numeroAutorizacion?: string;\r\n    fechaAutorizacion?: string;\r\n    sri: {\r\n      estado: string;\r\n      respuesta: any;\r\n    };\r\n  };\r\n}\r\n\r\nexport class CreateCreditNoteUseCase {\r\n  constructor(private creditNoteRepository: CreditNoteRepository) {}\r\n\r\n  async execute(creditNoteData: SriCreditNoteRequest): Promise<SriCreditNoteResponse> {\r\n    try {\r\n      // Validar que todos los datos requeridos estén presentes\r\n      this.validateCreditNoteData(creditNoteData);\r\n\r\n      return await this.creditNoteRepository.createCreditNote(creditNoteData);\r\n    } catch (error) {\r\n      console.error('Error en CreateCreditNoteUseCase:', error);\r\n      throw error;\r\n    }\r\n  }\r\n\r\n  private validateCreditNoteData(data: SriCreditNoteRequest): void {\r\n    // Secuencial no es requerido - el backend lo genera automáticamente\r\n\r\n    if (!data.fechaEmision) {\r\n      throw new Error('Fecha de emisión es requerida');\r\n    }\r\n\r\n    if (!data.motivo || data.motivo.trim() === '') {\r\n      throw new Error('Motivo es requerido');\r\n    }\r\n\r\n    if (!data.documentoModificado?.numero || data.documentoModificado.numero.trim() === '') {\r\n      throw new Error('Número del documento modificado es requerido');\r\n    }\r\n\r\n    if (!data.comprador?.identificacion || data.comprador.identificacion.trim() === '') {\r\n      throw new Error('Identificación del comprador es requerida');\r\n    }\r\n\r\n    if (!data.detalles || data.detalles.length === 0) {\r\n      throw new Error('Al menos un detalle es requerido');\r\n    }\r\n\r\n    // Validar cada detalle\r\n    data.detalles.forEach((detalle, index) => {\r\n      if (!detalle.codigoInterno || detalle.codigoInterno.trim() === '') {\r\n        throw new Error(`Código interno es requerido en detalle ${index + 1}`);\r\n      }\r\n\r\n      if (!detalle.descripcion || detalle.descripcion.trim() === '') {\r\n        throw new Error(`Descripción es requerida en detalle ${index + 1}`);\r\n      }\r\n\r\n      if (detalle.cantidad <= 0) {\r\n        throw new Error(`Cantidad debe ser mayor a 0 en detalle ${index + 1}`);\r\n      }\r\n\r\n      if (detalle.precioUnitario <= 0) {\r\n        throw new Error(`Precio unitario debe ser mayor a 0 en detalle ${index + 1}`);\r\n      }\r\n    });\r\n  }\r\n}","import type { CreditNoteRepository } from '../../../domain/repositories/CreditNoteRepository';\r\nimport type { AuthorizedInvoice, GetAuthorizedInvoicesResponse } from '../../../../infrastructure/repositories/HttpCreditNoteRepository';\r\n\r\nexport class GetAuthorizedInvoicesUseCase {\r\n  constructor(private creditNoteRepository: CreditNoteRepository) {}\r\n\r\n  async execute(search?: string, limit: number = 50): Promise<GetAuthorizedInvoicesResponse> {\r\n    try {\r\n      // Validar parámetros\r\n      if (limit > 100) {\r\n        limit = 100; // Límite máximo para performance\r\n      }\r\n\r\n      // Llamar al repositorio\r\n      const response = await (this.creditNoteRepository as any).getAuthorizedInvoices(search, limit);\r\n\r\n      return response;\r\n    } catch (error) {\r\n      console.error('Error en GetAuthorizedInvoicesUseCase:', error);\r\n      throw error;\r\n    }\r\n  }\r\n}\r\n\r\n// Re-exportar tipos para conveniencia\r\nexport type { AuthorizedInvoice, GetAuthorizedInvoicesResponse };","import React, { useState, useEffect, useRef } from \"react\";\r\nimport Table from \"../../components/dashboard/Table\";\r\nimport {\r\n  FileText,\r\n  User,\r\n  Calendar,\r\n  CheckCircle,\r\n  XCircle,\r\n  AlertTriangle,\r\n  RefreshCw,\r\n  Filter,\r\n  Eye,\r\n  Download,\r\n  Clock,\r\n  Send,\r\n  X,\r\n  RotateCcw,\r\n  CreditCard,\r\n  Phone,\r\n  MapPin,\r\n  Edit,\r\n  Minus,\r\n  Plus,\r\n  Trash2\r\n} from \"lucide-react\";\r\nimport { Link, useLocation } from \"react-router-dom\";\r\nimport StatCardList from \"../../components/dashboard/StatCardList\";\r\nimport { HttpCreditNoteRepository } from \"../../../infrastructure/repositories/HttpCreditNoteRepository\";\r\nimport { GetAllCreditNotesUseCase, type AdminCreditNote, type CreditNoteFilters } from \"../../../core/useCases/admin/creditNote/GetAllCreditNotesUseCase\";\r\nimport { GetCreditNoteByIdUseCase, type CreditNoteDetail } from \"../../../core/useCases/admin/creditNote/GetCreditNoteByIdUseCase\";\r\nimport { RetryCreditNoteUseCase } from \"../../../core/useCases/admin/creditNote/RetryCreditNoteUseCase\";\r\nimport { CheckCreditNoteStatusUseCase } from \"../../../core/useCases/admin/creditNote/CheckCreditNoteStatusUseCase\";\r\nimport { GetCreditNoteStatsUseCase, type CreditNoteStats } from \"../../../core/useCases/admin/creditNote/GetCreditNoteStatsUseCase\";\r\nimport { UpdateCreditNoteUseCase, type UpdateCreditNoteRequest } from \"../../../core/useCases/admin/creditNote/UpdateCreditNoteUseCase\";\r\nimport { CreateCreditNoteUseCase, type SriCreditNoteRequest } from \"../../../core/useCases/admin/creditNote/CreateCreditNoteUseCase\";\r\nimport { GetAuthorizedInvoicesUseCase, type AuthorizedInvoice } from \"../../../core/useCases/admin/creditNote/GetAuthorizedInvoicesUseCase\";\r\nimport type { InvoiceDetail } from \"../../../infrastructure/repositories/HttpCreditNoteRepository\";\r\nimport { useToast } from \"../../components/UniversalToast\";\r\nimport { NotificationType } from \"../../types/NotificationTypes\";\r\n\r\n// Estados válidos de notas de crédito SRI\r\nconst validStatuses = [\r\n  'DRAFT',\r\n  'SENT_TO_SRI',\r\n  'PENDING',\r\n  'PROCESSING',\r\n  'RECEIVED',\r\n  'AUTHORIZED',\r\n  'REJECTED',\r\n  'NOT_AUTHORIZED',\r\n  'RETURNED',\r\n  'SRI_ERROR',\r\n  'FAILED',\r\n  'DEFINITIVELY_FAILED'\r\n];\r\n\r\n// Motivos de nota de crédito según SRI\r\nconst creditNoteReasons = [\r\n  { value: '01', label: 'Anulación de la operación' },\r\n  { value: '02', label: 'Anulación por error en el RUC' },\r\n  { value: '03', label: 'Corrección por error en la descripción' },\r\n  { value: '04', label: 'Descuento otorgado' },\r\n  { value: '05', label: 'Devolución de bienes' },\r\n  { value: '06', label: 'Descuento por bonificación' },\r\n  { value: '07', label: 'Descuento por avería' }\r\n];\r\n\r\nconst AdminCreditNotesPage: React.FC = () => {\r\n  // Hook para mostrar notificaciones usando el sistema correcto\r\n  const { showToast } = useToast();\r\n  const location = useLocation();\r\n\r\n  // Inicializar repositorios y use cases una sola vez\r\n  const [getAllCreditNotesUseCase] = useState(() => {\r\n    const repository = new HttpCreditNoteRepository();\r\n    return new GetAllCreditNotesUseCase(repository);\r\n  });\r\n  const [getCreditNoteByIdUseCase] = useState(() => {\r\n    const repository = new HttpCreditNoteRepository();\r\n    return new GetCreditNoteByIdUseCase(repository);\r\n  });\r\n  const [retryCreditNoteUseCase] = useState(() => {\r\n    const repository = new HttpCreditNoteRepository();\r\n    return new RetryCreditNoteUseCase(repository);\r\n  });\r\n  const [checkCreditNoteStatusUseCase] = useState(() => {\r\n    const repository = new HttpCreditNoteRepository();\r\n    return new CheckCreditNoteStatusUseCase(repository);\r\n  });\r\n  const [getCreditNoteStatsUseCase] = useState(() => {\r\n    const repository = new HttpCreditNoteRepository();\r\n    return new GetCreditNoteStatsUseCase(repository);\r\n  });\r\n  const [updateCreditNoteUseCase] = useState(() => {\r\n    const repository = new HttpCreditNoteRepository();\r\n    return new UpdateCreditNoteUseCase(repository);\r\n  });\r\n\r\n  const [createCreditNoteUseCase] = useState(() => {\r\n    const repository = new HttpCreditNoteRepository();\r\n    return new CreateCreditNoteUseCase(repository);\r\n  });\r\n\r\n  // Hook restaurado para búsqueda de facturas (UX)\r\n  const [getAuthorizedInvoicesUseCase] = useState(() => {\r\n    const repository = new HttpCreditNoteRepository();\r\n    return new GetAuthorizedInvoicesUseCase(repository);\r\n  });\r\n\r\n  // Estado de la aplicación\r\n  const [creditNotes, setCreditNotes] = useState<AdminCreditNote[]>([]);\r\n  const [stats, setStats] = useState<CreditNoteStats | null>(null);\r\n  const [loading, setLoading] = useState(true);\r\n  const [error, setError] = useState<string | null>(null);\r\n\r\n  // Filtros\r\n  const [filters, setFilters] = useState<CreditNoteFilters>({\r\n    page: 1,\r\n    per_page: 20\r\n  });\r\n\r\n  // Paginación\r\n  const [pagination, setPagination] = useState({\r\n    currentPage: 1,\r\n    totalPages: 1,\r\n    totalItems: 0,\r\n    itemsPerPage: 20,\r\n  });\r\n\r\n  // Modal de detalle\r\n  const [selectedCreditNote, setSelectedCreditNote] = useState<CreditNoteDetail | null>(null);\r\n  const [showCreditNoteModal, setShowCreditNoteModal] = useState(false);\r\n  const [showPrintOptions, setShowPrintOptions] = useState(false);\r\n\r\n  // Modal de edición\r\n  const [showEditModal, setShowEditModal] = useState(false);\r\n  const [editingCreditNote, setEditingCreditNote] = useState<AdminCreditNote | null>(null);\r\n  const [editFormData, setEditFormData] = useState<UpdateCreditNoteRequest>({});\r\n\r\n  // Modal de creación (mantener UX pero con estado híbrido)\r\n  const [showCreateModal, setShowCreateModal] = useState(false);\r\n  const [createFormData, setCreateFormData] = useState({\r\n    invoice_id: 0, // Para UX de selección de factura\r\n    motivo: 'Anulación de la operación',\r\n    detalles: [] as InvoiceDetail[]\r\n  });\r\n\r\n  // Selector de facturas autorizadas (restaurado para UX)\r\n  const [authorizedInvoices, setAuthorizedInvoices] = useState<AuthorizedInvoice[]>([]);\r\n  const [invoiceSearch, setInvoiceSearch] = useState('');\r\n  const [selectedInvoice, setSelectedInvoice] = useState<AuthorizedInvoice | null>(null);\r\n  const [showInvoiceDropdown, setShowInvoiceDropdown] = useState(false);\r\n  const [invoiceSearchLoading, setInvoiceSearchLoading] = useState(false);\r\n\r\n  // Ref para el dropdown de facturas\r\n  const dropdownRef = useRef<HTMLDivElement>(null);\r\n\r\n  // Estado de acciones\r\n  const [actionLoading, setActionLoading] = useState<{[key: number]: boolean}>({});\r\n\r\n  // Cargar datos iniciales\r\n  useEffect(() => {\r\n    fetchData();\r\n  }, [filters]);\r\n\r\n  // Verificar si se debe crear nota de crédito desde factura\r\n  useEffect(() => {\r\n    if (location.state?.createFromInvoice && location.state?.invoiceData) {\r\n      const invoiceData = location.state.invoiceData;\r\n\r\n      // Crear objeto de factura mock para el selector\r\n      const mockInvoice: AuthorizedInvoice = {\r\n        id: invoiceData.id,\r\n        invoice_number: invoiceData.invoice_number,\r\n        display_label: `${invoiceData.invoice_number} - ${invoiceData.customer?.name || 'Cliente'} ($${Number(invoiceData.total_amount || 0).toFixed(2)})`,\r\n        customer: {\r\n          name: invoiceData.customer?.name || 'Cliente Sin Nombre',\r\n          identification: invoiceData.customer?.identification || '',\r\n          identification_type: invoiceData.customer?.identification_type || '05',\r\n          email: invoiceData.customer?.email,\r\n          address: invoiceData.customer?.address || '',\r\n          phone: invoiceData.customer?.phone,\r\n        },\r\n        amounts: {\r\n          total: Number(invoiceData.total_amount || 0),\r\n          subtotal: Number(invoiceData.subtotal || 0),\r\n          tax: Number(invoiceData.tax_amount || 0),\r\n        },\r\n        issue_date: invoiceData.issue_date || new Date().toISOString().split('T')[0],\r\n        created_at: new Date().toISOString(),\r\n      };\r\n\r\n      // Pre-seleccionar la factura\r\n      setSelectedInvoice(mockInvoice);\r\n      setInvoiceSearch(mockInvoice.display_label);\r\n\r\n      setCreateFormData(prev => ({\r\n        ...prev,\r\n        invoice_id: invoiceData.id\r\n      }));\r\n      setShowCreateModal(true);\r\n\r\n      // Limpiar el state después de usarlo\r\n      window.history.replaceState({}, document.title);\r\n    }\r\n  }, [location.state]);\r\n\r\n  // Cerrar dropdown cuando se hace click fuera\r\n  useEffect(() => {\r\n    const handleClickOutside = (event: MouseEvent) => {\r\n      if (showInvoiceDropdown && dropdownRef.current && !dropdownRef.current.contains(event.target as Node)) {\r\n        setShowInvoiceDropdown(false);\r\n      }\r\n    };\r\n\r\n    document.addEventListener('mousedown', handleClickOutside);\r\n    return () => {\r\n      document.removeEventListener('mousedown', handleClickOutside);\r\n    };\r\n  }, [showInvoiceDropdown]);\r\n\r\n  const fetchData = async () => {\r\n    try {\r\n      setLoading(true);\r\n      setError(null);\r\n\r\n      const [creditNotesResponse, statsResponse] = await Promise.all([\r\n        getAllCreditNotesUseCase.execute(filters),\r\n        getCreditNoteStatsUseCase.execute()\r\n      ]);\r\n\r\n      // Asegurar que data sea siempre un array\r\n      const creditNotesData = Array.isArray(creditNotesResponse.data) ? creditNotesResponse.data : [];\r\n\r\n      setCreditNotes(creditNotesData);\r\n      setPagination({\r\n        currentPage: creditNotesResponse.meta?.current_page || 1,\r\n        totalPages: creditNotesResponse.meta?.last_page || 1,\r\n        totalItems: creditNotesResponse.meta?.total || 0,\r\n        itemsPerPage: creditNotesResponse.meta?.per_page || 20,\r\n      });\r\n\r\n      if (statsResponse) {\r\n        setStats(statsResponse);\r\n      }\r\n    } catch (error) {\r\n      console.error('Error cargando notas de crédito:', error);\r\n      setError(error instanceof Error ? error.message : 'Error al cargar los datos');\r\n      setCreditNotes([]); // Establecer array vacío en caso de error\r\n    } finally {\r\n      setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Buscar facturas autorizadas con debounce\r\n  const searchAuthorizedInvoices = async (searchTerm: string) => {\r\n    try {\r\n      setInvoiceSearchLoading(true);\r\n      const response = await getAuthorizedInvoicesUseCase.execute(searchTerm, 20);\r\n      setAuthorizedInvoices(response.data);\r\n    } catch (error) {\r\n      console.error('Error buscando facturas:', error);\r\n      setAuthorizedInvoices([]);\r\n    } finally {\r\n      setInvoiceSearchLoading(false);\r\n    }\r\n  };\r\n\r\n  // Debounce para búsqueda de facturas\r\n  const [searchTimeout, setSearchTimeout] = useState<NodeJS.Timeout | null>(null);\r\n\r\n  const handleInvoiceSearch = (value: string) => {\r\n    setInvoiceSearch(value);\r\n    setShowInvoiceDropdown(true);\r\n\r\n    // Limpiar timeout anterior\r\n    if (searchTimeout) {\r\n      clearTimeout(searchTimeout);\r\n    }\r\n\r\n    // Si el valor está vacío, limpiar resultados\r\n    if (!value.trim()) {\r\n      setAuthorizedInvoices([]);\r\n      return;\r\n    }\r\n\r\n    // Crear nuevo timeout\r\n    const newTimeout = setTimeout(() => {\r\n      searchAuthorizedInvoices(value.trim());\r\n    }, 300); // 300ms de debounce\r\n\r\n    setSearchTimeout(newTimeout);\r\n  };\r\n\r\n  // Seleccionar una factura\r\n  const selectInvoice = (invoice: AuthorizedInvoice) => {\r\n    setSelectedInvoice(invoice);\r\n    setInvoiceSearch(invoice.display_label);\r\n    setShowInvoiceDropdown(false);\r\n\r\n    // Actualizar datos del formulario\r\n    setCreateFormData(prev => ({\r\n      ...prev,\r\n      invoice_id: invoice.id\r\n    }));\r\n  };\r\n\r\n  // Limpiar selección de factura\r\n  const clearInvoiceSelection = () => {\r\n    setSelectedInvoice(null);\r\n    setInvoiceSearch('');\r\n    setAuthorizedInvoices([]);\r\n    setShowInvoiceDropdown(false);\r\n    setCreateFormData(prev => ({\r\n      ...prev,\r\n      invoice_id: 0\r\n    }));\r\n  };\r\n\r\n  // Manejar cambio de filtros\r\n  const handleFilterChange = (key: keyof CreditNoteFilters, value: any) => {\r\n    setFilters(prev => ({\r\n      ...prev,\r\n      [key]: value,\r\n      page: key === 'page' ? value : 1 // Reset página si cambia otro filtro\r\n    }));\r\n  };\r\n\r\n  // Manejar cambio de página\r\n  const handlePageChange = (page: number) => {\r\n    handleFilterChange('page', page);\r\n  };\r\n\r\n  // Abrir modal de detalle\r\n  const openCreditNoteModal = async (creditNote: AdminCreditNote) => {\r\n    try {\r\n      setShowCreditNoteModal(true);\r\n      const detail = await getCreditNoteByIdUseCase.execute(creditNote.id);\r\n      setSelectedCreditNote(detail);\r\n    } catch (error) {\r\n      console.error('Error cargando detalles:', error);\r\n      showToast(NotificationType.ERROR, 'Error al cargar los detalles de la nota de crédito');\r\n      setShowCreditNoteModal(false);\r\n    }\r\n  };\r\n\r\n  // Cerrar modal\r\n  const closeCreditNoteModal = () => {\r\n    setShowCreditNoteModal(false);\r\n    setSelectedCreditNote(null);\r\n    setShowPrintOptions(false);\r\n  };\r\n\r\n  // Reintentar nota de crédito\r\n  const retryCreditNote = async (creditNoteId: number) => {\r\n    try {\r\n      setActionLoading(prev => ({...prev, [creditNoteId]: true}));\r\n      await retryCreditNoteUseCase.execute(creditNoteId);\r\n      showToast(NotificationType.SUCCESS, 'Reintento de nota de crédito iniciado correctamente');\r\n      fetchData(); // Recargar datos\r\n    } catch (error) {\r\n      const errorMessage = (error as any)?.response?.data?.error || 'Error al reintentar la nota de crédito';\r\n      showToast(NotificationType.ERROR, errorMessage);\r\n    } finally {\r\n      setActionLoading(prev => ({...prev, [creditNoteId]: false}));\r\n    }\r\n  };\r\n\r\n  // Consultar estado en SRI\r\n  const checkSriStatus = async (creditNoteId: number) => {\r\n    try {\r\n      setActionLoading(prev => ({...prev, [creditNoteId]: true}));\r\n      const result = await checkCreditNoteStatusUseCase.execute(creditNoteId);\r\n\r\n      // Verificar si la respuesta tiene los datos requeridos\r\n      if (result && result.credit_note_id) {\r\n        const { current_status, sri_status, sri_access_key, sri_authorization_number } = result;\r\n        const statusMessage = `Consulta exitosa\\n\\n` +\r\n          `Nota de Crédito: ${creditNoteId}\\n` +\r\n          `Estado Actual: ${current_status}\\n` +\r\n          `Clave Acceso: ${sri_access_key}\\n` +\r\n          `N° Autorización: ${sri_authorization_number || 'N/A'}\\n\\n` +\r\n          `Detalles SRI:\\n${JSON.stringify(sri_status, null, 2)}`;\r\n\r\n        showToast(NotificationType.SUCCESS, statusMessage);\r\n      } else {\r\n        showToast(NotificationType.WARNING, 'Respuesta inesperada del servidor');\r\n      }\r\n    } catch (error) {\r\n      console.error('Error consultando estado:', error);\r\n      showToast(NotificationType.ERROR, error instanceof Error ? error.message : 'Error al consultar el estado');\r\n    } finally {\r\n      setActionLoading(prev => ({...prev, [creditNoteId]: false}));\r\n    }\r\n  };\r\n\r\n  // Formatear fecha\r\n  const formatDate = (dateString: string | undefined) => {\r\n    if (!dateString) return \"N/A\";\r\n    const date = new Date(dateString);\r\n    return new Intl.DateTimeFormat(\"es-ES\", {\r\n      day: \"2-digit\",\r\n      month: \"2-digit\",\r\n      year: \"numeric\",\r\n      hour: \"2-digit\",\r\n      minute: \"2-digit\",\r\n    }).format(date);\r\n  };\r\n\r\n  // Formatear moneda\r\n  const formatCurrency = (amount: number) => {\r\n    return new Intl.NumberFormat(\"es-EC\", {\r\n      style: \"currency\",\r\n      currency: \"USD\",\r\n      minimumFractionDigits: 2,\r\n    }).format(amount);\r\n  };\r\n\r\n  // Descargar nota de crédito\r\n  const downloadCreditNote = async (creditNoteId: number, format: \"pdf\" | \"xml\") => {\r\n    if (format === \"xml\") {\r\n      showToast(NotificationType.INFO, 'Funcionalidad de descarga XML en desarrollo');\r\n      if (showPrintOptions) {\r\n        setShowPrintOptions(false);\r\n      }\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setActionLoading(prev => ({...prev, [creditNoteId]: true}));\r\n\r\n      // Descargar PDF usando el repositorio\r\n      const repository = new HttpCreditNoteRepository();\r\n      const pdfBlob = await repository.downloadCreditNotePdf(creditNoteId);\r\n\r\n      // Crear URL del blob y descargar\r\n      const url = window.URL.createObjectURL(pdfBlob);\r\n      const link = document.createElement('a');\r\n      link.href = url;\r\n      link.download = `nota_credito_${creditNoteId}.pdf`;\r\n      document.body.appendChild(link);\r\n      link.click();\r\n      document.body.removeChild(link);\r\n      window.URL.revokeObjectURL(url);\r\n\r\n      showToast(NotificationType.SUCCESS, 'PDF descargado correctamente');\r\n\r\n    } catch (error) {\r\n      console.error('Error descargando PDF:', error);\r\n      showToast(NotificationType.ERROR, error instanceof Error ? error.message : 'Error al descargar el PDF');\r\n    } finally {\r\n      setActionLoading(prev => ({...prev, [creditNoteId]: false}));\r\n      if (showPrintOptions) {\r\n        setShowPrintOptions(false);\r\n      }\r\n    }\r\n  };\r\n\r\n  // Enviar por email (placeholder)\r\n  const sendCreditNoteByEmail = (_creditNoteId: number) => {\r\n    showToast(NotificationType.INFO, 'Funcionalidad de envío por email en desarrollo');\r\n    if (showPrintOptions) {\r\n      setShowPrintOptions(false);\r\n    }\r\n  };\r\n\r\n  // Abrir modal de edición\r\n  const openEditModal = (creditNote: AdminCreditNote) => {\r\n    setEditingCreditNote(creditNote);\r\n    setEditFormData({\r\n      customer_name: creditNote.customer?.name || '',\r\n      customer_identification: creditNote.customer?.identification || '',\r\n      customer_email: creditNote.customer?.email || '',\r\n      customer_address: creditNote.customer?.address || '',\r\n      customer_phone: creditNote.customer?.phone || '',\r\n    });\r\n    setShowEditModal(true);\r\n  };\r\n\r\n  // Cerrar modal de edición\r\n  const closeEditModal = () => {\r\n    setShowEditModal(false);\r\n    setEditingCreditNote(null);\r\n    setEditFormData({});\r\n  };\r\n\r\n  // Guardar cambios de edición\r\n  const saveEditChanges = async () => {\r\n    if (!editingCreditNote) return;\r\n\r\n    try {\r\n      setActionLoading(prev => ({...prev, [editingCreditNote.id]: true}));\r\n\r\n      // Filtrar solo campos que han cambiado y no están vacíos\r\n      const changedData: UpdateCreditNoteRequest = {};\r\n      if (editFormData.customer_name && editFormData.customer_name !== editingCreditNote.customer?.name) {\r\n        changedData.customer_name = editFormData.customer_name;\r\n      }\r\n      if (editFormData.customer_identification && editFormData.customer_identification !== editingCreditNote.customer?.identification) {\r\n        changedData.customer_identification = editFormData.customer_identification;\r\n      }\r\n      if (editFormData.customer_email !== editingCreditNote.customer?.email) {\r\n        changedData.customer_email = editFormData.customer_email || undefined;\r\n      }\r\n      if (editFormData.customer_address && editFormData.customer_address !== editingCreditNote.customer?.address) {\r\n        changedData.customer_address = editFormData.customer_address;\r\n      }\r\n      if (editFormData.customer_phone !== editingCreditNote.customer?.phone) {\r\n        changedData.customer_phone = editFormData.customer_phone || undefined;\r\n      }\r\n\r\n      // Solo actualizar si hay cambios\r\n      if (Object.keys(changedData).length === 0) {\r\n        showToast(NotificationType.WARNING, 'No se detectaron cambios para guardar');\r\n        return;\r\n      }\r\n\r\n      await updateCreditNoteUseCase.execute(editingCreditNote.id, changedData);\r\n\r\n      showToast(NotificationType.SUCCESS, 'Nota de crédito actualizada correctamente');\r\n      closeEditModal();\r\n      fetchData(); // Recargar datos\r\n\r\n    } catch (error) {\r\n      console.error('Error actualizando nota de crédito:', error);\r\n      showToast(NotificationType.ERROR, error instanceof Error ? error.message : 'Error al actualizar la nota de crédito');\r\n    } finally {\r\n      setActionLoading(prev => ({...prev, [editingCreditNote.id]: false}));\r\n    }\r\n  };\r\n\r\n  // Cerrar modal de creación\r\n  const closeCreateModal = () => {\r\n    setShowCreateModal(false);\r\n    setCreateFormData({\r\n      invoice_id: 0,\r\n      motivo: 'Anulación de la operación', // Descripción completa por defecto\r\n      detalles: []\r\n    });\r\n    // Limpiar selector de facturas\r\n    clearInvoiceSelection();\r\n  };\r\n\r\n  // Funciones para gestión de detalles\r\n  const addDetailItem = () => {\r\n    const newDetail = {\r\n      product_code: '',\r\n      product_name: '',\r\n      quantity: 1,\r\n      unit_price: 0,\r\n      discount: 0,\r\n      codigo_iva: '4' // IVA 15% por defecto (vigente Ecuador 2024)\r\n    };\r\n\r\n    setCreateFormData(prev => ({\r\n      ...prev,\r\n      detalles: [...prev.detalles, newDetail]\r\n    }));\r\n  };\r\n\r\n  const removeDetailItem = (index: number) => {\r\n    setCreateFormData(prev => ({\r\n      ...prev,\r\n      detalles: prev.detalles.filter((_, i) => i !== index)\r\n    }));\r\n  };\r\n\r\n  const updateDetailItem = (index: number, field: string, value: any) => {\r\n    setCreateFormData(prev => ({\r\n      ...prev,\r\n      detalles: prev.detalles.map((detail, i) =>\r\n        i === index ? { ...detail, [field]: value } : detail\r\n      )\r\n    }));\r\n  };\r\n\r\n  const calculateTotalAmount = () => {\r\n    return createFormData.detalles.reduce((total, detail) => {\r\n      const subtotal = (detail.quantity || 0) * (detail.unit_price || 0) - (detail.discount || 0);\r\n      return total + subtotal;\r\n    }, 0);\r\n  };\r\n\r\n  // Cargar detalles de la factura seleccionada\r\n  const loadInvoiceDetails = async () => {\r\n    if (!selectedInvoice) {\r\n      showToast(NotificationType.WARNING, 'Debe seleccionar una factura primero');\r\n      return;\r\n    }\r\n\r\n    try {\r\n      setActionLoading(prev => ({...prev, 1: true}));\r\n\r\n      const repository = new HttpCreditNoteRepository();\r\n      const details = await repository.getInvoiceDetails(selectedInvoice.id);\r\n\r\n      setCreateFormData(prev => ({\r\n        ...prev,\r\n        detalles: details\r\n      }));\r\n\r\n      showToast(NotificationType.SUCCESS, `Se cargaron ${details.length} detalles de la factura`);\r\n    } catch (error) {\r\n      console.error('Error cargando detalles de factura:', error);\r\n      showToast(NotificationType.ERROR, 'Error al cargar los detalles de la factura');\r\n    } finally {\r\n      setActionLoading(prev => ({...prev, 1: false}));\r\n    }\r\n  };\r\n\r\n  // Crear nota de crédito\r\n  const createCreditNote = async () => {\r\n    try {\r\n      setActionLoading(prev => ({...prev, 0: true}));\r\n\r\n      if (!createFormData.invoice_id) {\r\n        showToast(NotificationType.WARNING, 'Debe seleccionar una factura para crear la nota de crédito');\r\n        return;\r\n      }\r\n\r\n      if (!selectedInvoice) {\r\n        showToast(NotificationType.WARNING, 'Debe seleccionar una factura válida');\r\n        return;\r\n      }\r\n\r\n      if (createFormData.detalles.length === 0) {\r\n        showToast(NotificationType.WARNING, 'Debe agregar al menos un detalle a la nota de crédito');\r\n        return;\r\n      }\r\n\r\n      // Validar que todos los detalles tengan los campos requeridos\r\n      const invalidDetails = createFormData.detalles.some(detail =>\r\n        !detail.product_code?.trim() ||\r\n        !detail.product_name?.trim() ||\r\n        detail.quantity <= 0 ||\r\n        detail.unit_price <= 0\r\n      );\r\n\r\n      if (invalidDetails) {\r\n        showToast(NotificationType.WARNING, 'Todos los detalles deben tener código, nombre, cantidad y precio unitario válidos');\r\n        return;\r\n      }\r\n\r\n      // DEBUG: Verificar contenido de selectedInvoice\r\n      console.log('DEBUG selectedInvoice:', JSON.stringify(selectedInvoice, null, 2));\r\n      console.log('DEBUG createFormData:', JSON.stringify(createFormData, null, 2));\r\n\r\n      // Transformar datos BCommerce → formato SRI usando datos reales\r\n      const sriData: SriCreditNoteRequest = {\r\n        secuencial: '', // El backend generará el secuencial real\r\n        fechaEmision: new Date().toISOString().split('T')[0],\r\n        motivo: createFormData.motivo,\r\n        documentoModificado: {\r\n          tipo: '01', // Tipo factura\r\n          numero: selectedInvoice.invoice_number, // Número REAL de la factura\r\n          fechaEmision: selectedInvoice.issue_date // Fecha REAL de la factura\r\n        },\r\n        comprador: {\r\n          tipoIdentificacion: selectedInvoice.customer.identification_type,\r\n          identificacion: selectedInvoice.customer.identification,\r\n          razonSocial: selectedInvoice.customer.name,\r\n          direccion: selectedInvoice.customer.address,\r\n          email: selectedInvoice.customer.email,\r\n          telefono: selectedInvoice.customer.phone\r\n        },\r\n        detalles: createFormData.detalles.map(detalle => ({\r\n          codigoInterno: detalle.product_code,\r\n          descripcion: detalle.product_name,\r\n          cantidad: detalle.quantity,\r\n          precioUnitario: detalle.unit_price,\r\n          descuento: detalle.discount || 0,\r\n          codigoIva: detalle.codigo_iva as '0' | '2' | '3' | '4' | '5' | '6' | '7'\r\n        })),\r\n        informacionAdicional: {\r\n          MotivoDetallado: createFormData.motivo,\r\n          Observaciones: 'Nota de crédito generada desde sistema administrativo'\r\n        }\r\n      };\r\n\r\n      // DEBUG: Verificar datos SRI que se van a enviar\r\n      console.log('DEBUG sriData final:', JSON.stringify(sriData, null, 2));\r\n\r\n      // Enviar en formato SRI\r\n      await createCreditNoteUseCase.execute(sriData);\r\n\r\n      showToast(NotificationType.SUCCESS, 'Nota de crédito creada correctamente');\r\n      closeCreateModal();\r\n      fetchData(); // Recargar datos\r\n\r\n    } catch (error) {\r\n      console.error('Error creando nota de crédito:', error);\r\n      showToast(NotificationType.ERROR, error instanceof Error ? error.message : 'Error al crear la nota de crédito');\r\n    } finally {\r\n      setActionLoading(prev => ({...prev, 0: false}));\r\n    }\r\n  };\r\n\r\n  // Definir columnas de la tabla\r\n  const columns = [\r\n    {\r\n      key: \"credit_note\",\r\n      header: \"Nota de Crédito\",\r\n      sortable: true,\r\n      render: (creditNote: AdminCreditNote) => (\r\n        <div className=\"flex items-center\">\r\n          <div className=\"flex-shrink-0 h-10 w-10 bg-indigo-100 rounded-lg flex items-center justify-center\">\r\n            <Minus className=\"h-5 w-5 text-indigo-600\" />\r\n          </div>\r\n          <div className=\"ml-4\">\r\n            <div className=\"text-sm font-medium text-gray-900\">\r\n              {creditNote.credit_note_number}\r\n            </div>\r\n            <div className=\"text-xs text-gray-500\">\r\n              {formatDate(creditNote.created_at)}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ),\r\n    },\r\n    {\r\n      key: \"customer\",\r\n      header: \"Cliente\",\r\n      sortable: true,\r\n      render: (creditNote: AdminCreditNote) => (\r\n        <div className=\"flex items-center\">\r\n          <div className=\"flex-shrink-0 h-8 w-8 rounded-full bg-gray-200 flex items-center justify-center overflow-hidden\">\r\n            <User className=\"h-4 w-4 text-gray-500\" />\r\n          </div>\r\n          <div className=\"ml-3\">\r\n            <div className=\"text-sm font-medium text-gray-900\">\r\n              {creditNote.customer?.name || 'N/A'}\r\n            </div>\r\n            <div className=\"text-xs text-gray-500 flex items-center\">\r\n              <CreditCard className=\"h-3 w-3 mr-1\" />\r\n              {creditNote.customer?.identification || 'N/A'}\r\n            </div>\r\n          </div>\r\n        </div>\r\n      ),\r\n    },\r\n    {\r\n      key: \"invoice\",\r\n      header: \"Factura Original\",\r\n      sortable: true,\r\n      render: (creditNote: AdminCreditNote) => (\r\n        <div>\r\n          {creditNote.documento_modificado ? (\r\n            <span className=\"text-sm font-medium text-gray-900\">\r\n              {creditNote.documento_modificado}\r\n            </span>\r\n          ) : (\r\n            <span className=\"text-sm text-gray-500\">N/A</span>\r\n          )}\r\n          <div className=\"text-xs text-gray-500\">\r\n            {creditNote.items_count} items\r\n          </div>\r\n        </div>\r\n      ),\r\n    },\r\n    {\r\n      key: \"amount\",\r\n      header: \"Monto\",\r\n      sortable: true,\r\n      render: (creditNote: AdminCreditNote) => (\r\n        <div className=\"text-sm font-medium text-gray-900\">\r\n          {formatCurrency(creditNote.total_amount)}\r\n          <div className=\"text-xs text-gray-500\">\r\n            Subtotal: {formatCurrency(creditNote.subtotal)}\r\n          </div>\r\n          <div className=\"text-xs text-gray-500\">\r\n            IVA: {formatCurrency(creditNote.tax_amount)}\r\n          </div>\r\n        </div>\r\n      ),\r\n    },\r\n    {\r\n      key: \"status\",\r\n      header: \"Estado\",\r\n      sortable: true,\r\n      render: (creditNote: AdminCreditNote) => (\r\n        <div>\r\n          <span\r\n            className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium`}\r\n            style={{\r\n              backgroundColor: getStatusBgColor(creditNote.status_color),\r\n              color: getStatusTextColor(creditNote.status_color)\r\n            }}\r\n          >\r\n            {getStatusIcon(creditNote.status)}\r\n            {creditNote.status_label}\r\n          </span>\r\n          {creditNote.retry_count > 0 && (\r\n            <div className=\"text-xs text-orange-600 mt-1\">\r\n              Reintentos: {creditNote.retry_count}\r\n            </div>\r\n          )}\r\n        </div>\r\n      ),\r\n    },\r\n    {\r\n      key: \"actions\",\r\n      header: \"Acciones\",\r\n      render: (creditNote: AdminCreditNote) => {\r\n        const isActionLoading = actionLoading[creditNote.id];\r\n\r\n        return (\r\n          <div className=\"flex justify-end space-x-2\">\r\n            {/* Ver detalles */}\r\n            <button\r\n              onClick={() => openCreditNoteModal(creditNote)}\r\n              className=\"p-1 text-blue-600 hover:bg-blue-100 rounded-md\"\r\n              title=\"Ver detalles\"\r\n            >\r\n              <Eye size={18} />\r\n            </button>\r\n\r\n            {/* Editar (solo si no está autorizada) */}\r\n            {creditNote.status !== 'AUTHORIZED' && (\r\n              <button\r\n                onClick={() => openEditModal(creditNote)}\r\n                disabled={isActionLoading}\r\n                className=\"p-1 text-green-600 hover:bg-green-100 rounded-md disabled:opacity-50\"\r\n                title=\"Editar datos de cliente\"\r\n              >\r\n                <Edit size={18} />\r\n              </button>\r\n            )}\r\n\r\n            {/* Reintentar (solo si está fallida y puede reintentarse) */}\r\n            {creditNote.status === 'FAILED' && creditNote.retry_count < 12 && (\r\n              <button\r\n                onClick={() => retryCreditNote(creditNote.id)}\r\n                disabled={isActionLoading}\r\n                className=\"p-1 text-orange-600 hover:bg-orange-100 rounded-md disabled:opacity-50\"\r\n                title=\"Reintentar envío\"\r\n              >\r\n                {isActionLoading ? (\r\n                  <RefreshCw size={18} className=\"animate-spin\" />\r\n                ) : (\r\n                  <RotateCcw size={18} />\r\n                )}\r\n              </button>\r\n            )}\r\n\r\n            {/* Consultar estado SRI */}\r\n            {creditNote.sri_access_key && (\r\n              <button\r\n                onClick={() => checkSriStatus(creditNote.id)}\r\n                disabled={isActionLoading}\r\n                className=\"p-1 text-purple-600 hover:bg-purple-100 rounded-md disabled:opacity-50\"\r\n                title=\"Consultar estado SRI\"\r\n              >\r\n                {isActionLoading ? (\r\n                  <RefreshCw size={18} className=\"animate-spin\" />\r\n                ) : (\r\n                  <RefreshCw size={18} />\r\n                )}\r\n              </button>\r\n            )}\r\n\r\n            {/* Descargar */}\r\n            <button\r\n              onClick={() => downloadCreditNote(creditNote.id, \"pdf\")}\r\n              className=\"p-1 text-green-600 hover:bg-green-100 rounded-md\"\r\n              title=\"Descargar PDF\"\r\n            >\r\n              <Download size={18} />\r\n            </button>\r\n          </div>\r\n        );\r\n      },\r\n    },\r\n  ];\r\n\r\n  // Funciones auxiliares para colores de estado\r\n  const getStatusBgColor = (color: string) => {\r\n    const colorMap: Record<string, string> = {\r\n      'gray': '#f3f4f6',\r\n      'blue': '#dbeafe',\r\n      'yellow': '#fef3c7',\r\n      'indigo': '#e0e7ff',\r\n      'green': '#d1fae5',\r\n      'red': '#fee2e2',\r\n      'orange': '#fed7aa',\r\n    };\r\n    return colorMap[color] || colorMap['gray'];\r\n  };\r\n\r\n  const getStatusTextColor = (color: string) => {\r\n    const colorMap: Record<string, string> = {\r\n      'gray': '#374151',\r\n      'blue': '#1e40af',\r\n      'yellow': '#92400e',\r\n      'indigo': '#3730a3',\r\n      'green': '#059669',\r\n      'red': '#dc2626',\r\n      'orange': '#ea580c',\r\n    };\r\n    return colorMap[color] || colorMap['gray'];\r\n  };\r\n\r\n  const getStatusIcon = (status: string) => {\r\n    const iconMap: Record<string, React.ReactNode> = {\r\n      'DRAFT': <Clock className=\"w-3 h-3 mr-1\" />,\r\n      'SENT_TO_SRI': <Send className=\"w-3 h-3 mr-1\" />,\r\n      'PENDING': <Clock className=\"w-3 h-3 mr-1\" />,\r\n      'PROCESSING': <RefreshCw className=\"w-3 h-3 mr-1 animate-spin\" />,\r\n      'RECEIVED': <CheckCircle className=\"w-3 h-3 mr-1\" />,\r\n      'AUTHORIZED': <CheckCircle className=\"w-3 h-3 mr-1\" />,\r\n      'REJECTED': <XCircle className=\"w-3 h-3 mr-1\" />,\r\n      'NOT_AUTHORIZED': <XCircle className=\"w-3 h-3 mr-1\" />,\r\n      'RETURNED': <RotateCcw className=\"w-3 h-3 mr-1\" />,\r\n      'SRI_ERROR': <AlertTriangle className=\"w-3 h-3 mr-1\" />,\r\n      'FAILED': <XCircle className=\"w-3 h-3 mr-1\" />,\r\n      'DEFINITIVELY_FAILED': <XCircle className=\"w-3 h-3 mr-1\" />,\r\n    };\r\n    return iconMap[status] || <AlertTriangle className=\"w-3 h-3 mr-1\" />;\r\n  };\r\n\r\n  // Preparar datos de estadísticas\r\n  const statItems = stats ? [\r\n    {\r\n      title: \"Total\",\r\n      value: stats.sri_stats.total_credit_notes,\r\n      description: \"Notas de Crédito\",\r\n      icon: Minus,\r\n      bgColor: \"bg-indigo-50/20\",\r\n      textColor: \"text-indigo-800\",\r\n      valueColor: \"text-indigo-900\",\r\n      descriptionColor: \"text-indigo-700\",\r\n      iconColor: \"text-indigo-600\",\r\n    },\r\n    {\r\n      title: \"Autorizadas\",\r\n      value: stats.sri_stats.authorized,\r\n      description: `${stats.sri_stats.success_rate}% éxito`,\r\n      icon: CheckCircle,\r\n      bgColor: \"bg-green-50/20\",\r\n      textColor: \"text-green-800\",\r\n      valueColor: \"text-green-900\",\r\n      descriptionColor: \"text-green-700\",\r\n      iconColor: \"text-green-600\",\r\n    },\r\n    {\r\n      title: \"Pendientes\",\r\n      value: stats.sri_stats.pending,\r\n      description: \"En proceso\",\r\n      icon: Clock,\r\n      bgColor: \"bg-yellow-50\",\r\n      textColor: \"text-yellow-800\",\r\n      valueColor: \"text-yellow-900\",\r\n      descriptionColor: \"text-yellow-700\",\r\n      iconColor: \"text-yellow-600\",\r\n    },\r\n    {\r\n      title: \"Fallidas\",\r\n      value: stats.sri_stats.failed + stats.sri_stats.definitively_failed,\r\n      description: `${stats.additional_stats.pending_retries} pueden reintentarse`,\r\n      icon: AlertTriangle,\r\n      bgColor: \"bg-red-50/20\",\r\n      textColor: \"text-red-800\",\r\n      valueColor: \"text-red-900\",\r\n      descriptionColor: \"text-red-700\",\r\n      iconColor: \"text-red-600\",\r\n    }\r\n  ] : [];\r\n\r\n  return (\r\n    <div className=\"space-y-6\">\r\n      <div className=\"flex justify-between items-center\">\r\n        <h1 className=\"text-2xl font-bold text-gray-900\">\r\n          Gestión de Notas de Crédito SRI\r\n        </h1>\r\n        <div className=\"flex space-x-2\">\r\n          <button\r\n            onClick={() => setShowCreateModal(true)}\r\n            className=\"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors\"\r\n          >\r\n            <Minus size={18} className=\"inline mr-2\" />\r\n            Nueva Nota de Crédito\r\n          </button>\r\n          <button\r\n            onClick={fetchData}\r\n            disabled={loading}\r\n            className=\"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50\"\r\n          >\r\n            <RefreshCw size={18} className={`inline mr-2 ${loading ? 'animate-spin' : ''}`} />\r\n            Actualizar\r\n          </button>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Mostrar error si existe */}\r\n      {error && (\r\n        <div className=\"bg-red-50 border border-red-200 rounded-lg p-4\">\r\n          <div className=\"flex\">\r\n            <AlertTriangle className=\"h-5 w-5 text-red-400 mr-3\" />\r\n            <p className=\"text-red-800\">{error}</p>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Panel de estadísticas */}\r\n      <StatCardList items={statItems} />\r\n\r\n      {/* Filtros */}\r\n      <div className=\"bg-white rounded-lg shadow-sm p-4\">\r\n        <div className=\"flex flex-col md:flex-row gap-4\">\r\n          {/* Filtro de Estado */}\r\n          <div className=\"flex items-center space-x-2\">\r\n            <Filter className=\"h-5 w-5 text-gray-500\" />\r\n            <select\r\n              className=\"border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n              value={filters.status || 'all'}\r\n              onChange={(e) => handleFilterChange('status', e.target.value === 'all' ? undefined : e.target.value)}\r\n            >\r\n              <option value=\"all\">Todos los Estados</option>\r\n              {validStatuses.map(status => (\r\n                <option key={status} value={status}>{status}</option>\r\n              ))}\r\n            </select>\r\n          </div>\r\n\r\n          {/* Filtro de Fecha */}\r\n          <div className=\"flex items-center space-x-2\">\r\n            <Calendar className=\"h-5 w-5 text-gray-500\" />\r\n            <input\r\n              type=\"date\"\r\n              className=\"border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n              value={filters.start_date || ''}\r\n              onChange={(e) => handleFilterChange('start_date', e.target.value || undefined)}\r\n              placeholder=\"Desde\"\r\n            />\r\n            <input\r\n              type=\"date\"\r\n              className=\"border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n              value={filters.end_date || ''}\r\n              onChange={(e) => handleFilterChange('end_date', e.target.value || undefined)}\r\n              placeholder=\"Hasta\"\r\n            />\r\n          </div>\r\n\r\n          {/* Filtro de Cliente */}\r\n          <div className=\"flex items-center space-x-2\">\r\n            <User className=\"h-5 w-5 text-gray-500\" />\r\n            <input\r\n              type=\"text\"\r\n              className=\"border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n              value={filters.customer_name || ''}\r\n              onChange={(e) => handleFilterChange('customer_name', e.target.value || undefined)}\r\n              placeholder=\"Nombre cliente\"\r\n            />\r\n          </div>\r\n\r\n          {/* Filtro de Identificación */}\r\n          <div className=\"flex items-center space-x-2\">\r\n            <CreditCard className=\"h-5 w-5 text-gray-500\" />\r\n            <input\r\n              type=\"text\"\r\n              className=\"border border-gray-300 rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n              value={filters.customer_identification || ''}\r\n              onChange={(e) => handleFilterChange('customer_identification', e.target.value || undefined)}\r\n              placeholder=\"Cédula/RUC\"\r\n            />\r\n          </div>\r\n        </div>\r\n      </div>\r\n\r\n      {/* Tabla de Notas de Crédito */}\r\n      <Table\r\n        data={creditNotes}\r\n        columns={columns}\r\n        searchFields={[\"credit_note_number\"]}\r\n        loading={loading}\r\n        emptyMessage=\"No se encontraron notas de crédito\"\r\n        pagination={{\r\n          currentPage: pagination.currentPage,\r\n          totalPages: pagination.totalPages,\r\n          totalItems: pagination.totalItems,\r\n          itemsPerPage: pagination.itemsPerPage,\r\n          onPageChange: handlePageChange,\r\n        }}\r\n      />\r\n\r\n      {/* Modal de Creación de Nota de Crédito */}\r\n      {showCreateModal && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\r\n            <div className=\"px-6 py-4 border-b border-gray-200 flex justify-between items-center\">\r\n              <h3 className=\"text-lg font-medium text-gray-900\">\r\n                Nueva Nota de Crédito\r\n              </h3>\r\n              <button\r\n                onClick={closeCreateModal}\r\n                className=\"text-gray-400 hover:text-gray-500\"\r\n                disabled={actionLoading[0]}\r\n              >\r\n                <X className=\"h-5 w-5\" />\r\n              </button>\r\n            </div>\r\n            <div className=\"p-6\">\r\n              <div className=\"space-y-4\">\r\n                {/* Selector de Factura */}\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                    Buscar Factura\r\n                  </label>\r\n                  <div className=\"relative\">\r\n                    <input\r\n                      type=\"text\"\r\n                      className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                      value={invoiceSearch}\r\n                      onChange={(e) => handleInvoiceSearch(e.target.value)}\r\n                      onFocus={() => setShowInvoiceDropdown(true)}\r\n                      placeholder=\"Buscar por número de factura, cliente o cédula...\"\r\n                    />\r\n\r\n                    {/* Botón limpiar selección */}\r\n                    {selectedInvoice && (\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={clearInvoiceSelection}\r\n                        className=\"absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600\"\r\n                      >\r\n                        <X className=\"h-4 w-4\" />\r\n                      </button>\r\n                    )}\r\n\r\n                    {/* Dropdown de resultados */}\r\n                    {showInvoiceDropdown && (\r\n                      <div ref={dropdownRef} className=\"absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-lg shadow-lg max-h-60 overflow-y-auto\">\r\n                        {invoiceSearchLoading ? (\r\n                          <div className=\"p-3 text-center text-gray-500 flex items-center justify-center\">\r\n                            <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                            Buscando facturas...\r\n                          </div>\r\n                        ) : authorizedInvoices.length > 0 ? (\r\n                          authorizedInvoices.map((invoice) => (\r\n                            <button\r\n                              key={invoice.id}\r\n                              type=\"button\"\r\n                              onClick={() => selectInvoice(invoice)}\r\n                              className=\"w-full text-left p-3 hover:bg-gray-50 border-b border-gray-100 last:border-b-0\"\r\n                            >\r\n                              <div className=\"font-medium text-gray-900\">\r\n                                {invoice.invoice_number}\r\n                              </div>\r\n                              <div className=\"text-sm text-gray-600\">\r\n                                {invoice.customer.name} - {invoice.customer.identification}\r\n                              </div>\r\n                              <div className=\"text-sm text-green-600 font-medium\">\r\n                                ${Number(invoice.amounts.total || 0).toFixed(2)}\r\n                              </div>\r\n                            </button>\r\n                          ))\r\n                        ) : invoiceSearch.length > 2 ? (\r\n                          <div className=\"p-3 text-center text-gray-500\">\r\n                            No se encontraron facturas\r\n                          </div>\r\n                        ) : (\r\n                          <div className=\"p-3 text-center text-gray-500\">\r\n                            Escribe al menos 3 caracteres para buscar\r\n                          </div>\r\n                        )}\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n\r\n                  {/* Información de la factura seleccionada */}\r\n                  {selectedInvoice && (\r\n                    <div className=\"mt-2 p-3 bg-green-50 border border-green-200 rounded-lg\">\r\n                      <div className=\"text-sm font-medium text-green-800\">\r\n                        Factura seleccionada: {selectedInvoice.invoice_number}\r\n                      </div>\r\n                      <div className=\"text-sm text-green-700\">\r\n                        Cliente: {selectedInvoice.customer.name} ({selectedInvoice.customer.identification})\r\n                      </div>\r\n                      <div className=\"text-sm text-green-700\">\r\n                        Total: ${Number(selectedInvoice.amounts.total || 0).toFixed(2)}\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n\r\n                  {/* Información cuando viene desde navegación */}\r\n                  {location.state?.invoiceData && !selectedInvoice && (\r\n                    <p className=\"text-xs text-blue-600 mt-1\">\r\n                      Factura desde navegación: {location.state.invoiceData.invoice_number}\r\n                    </p>\r\n                  )}\r\n                </div>\r\n\r\n                {/* Motivo */}\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                    Motivo\r\n                  </label>\r\n                  <select\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                    value={creditNoteReasons.find(r => r.label === createFormData.motivo)?.value || '01'}\r\n                    onChange={(e) => {\r\n                      const selectedReason = creditNoteReasons.find(r => r.value === e.target.value);\r\n                      setCreateFormData(prev => ({\r\n                        ...prev,\r\n                        motivo: selectedReason ? selectedReason.label : e.target.value\r\n                      }));\r\n                    }}\r\n                  >\r\n                    {creditNoteReasons.map(reason => (\r\n                      <option key={reason.value} value={reason.value}>\r\n                        {reason.value} - {reason.label}\r\n                      </option>\r\n                    ))}\r\n                  </select>\r\n                </div>\r\n\r\n                {/* Gestión de detalles */}\r\n                <div>\r\n                  <div className=\"flex justify-between items-center mb-3\">\r\n                    <label className=\"block text-sm font-medium text-gray-700\">\r\n                      Detalles de la Nota de Crédito\r\n                    </label>\r\n                    <div className=\"flex gap-2\">\r\n                      {selectedInvoice && (\r\n                        <button\r\n                          type=\"button\"\r\n                          onClick={loadInvoiceDetails}\r\n                          disabled={actionLoading[1]}\r\n                          className=\"px-3 py-1 bg-green-600 text-white text-sm rounded-lg hover:bg-green-700 transition-colors flex items-center disabled:opacity-50\"\r\n                        >\r\n                          {actionLoading[1] ? (\r\n                            <>\r\n                              <RefreshCw className=\"h-4 w-4 mr-1 animate-spin\" />\r\n                              Cargando...\r\n                            </>\r\n                          ) : (\r\n                            <>\r\n                              <Download className=\"h-4 w-4 mr-1\" />\r\n                              Cargar de Factura\r\n                            </>\r\n                          )}\r\n                        </button>\r\n                      )}\r\n                      <button\r\n                        type=\"button\"\r\n                        onClick={addDetailItem}\r\n                        className=\"px-3 py-1 bg-indigo-600 text-white text-sm rounded-lg hover:bg-indigo-700 transition-colors flex items-center\"\r\n                      >\r\n                        <Plus className=\"h-4 w-4 mr-1\" />\r\n                        Agregar Item\r\n                      </button>\r\n                    </div>\r\n                  </div>\r\n\r\n                  {createFormData.detalles.length === 0 ? (\r\n                    <div className=\"border border-gray-300 rounded-lg p-4 text-center text-gray-500\">\r\n                      No hay detalles agregados. Haga clic en \"Agregar Item\" para comenzar.\r\n                    </div>\r\n                  ) : (\r\n                    <div className=\"space-y-4\">\r\n                      {createFormData.detalles.map((detalle, index) => (\r\n                        <div key={index} className=\"border border-gray-200 rounded-lg p-4 bg-gray-50\">\r\n                          <div className=\"flex justify-between items-start mb-3\">\r\n                            <h4 className=\"text-sm font-medium text-gray-700\">Item {index + 1}</h4>\r\n                            <button\r\n                              type=\"button\"\r\n                              onClick={() => removeDetailItem(index)}\r\n                              className=\"p-1 text-red-600 hover:text-red-800 transition-colors\"\r\n                            >\r\n                              <Trash2 className=\"h-4 w-4\" />\r\n                            </button>\r\n                          </div>\r\n\r\n                          <div className=\"grid grid-cols-1 md:grid-cols-2 gap-3\">\r\n                            {/* Código del producto */}\r\n                            <div>\r\n                              <label className=\"block text-xs font-medium text-gray-600 mb-1\">\r\n                                Código del Producto *\r\n                              </label>\r\n                              <input\r\n                                type=\"text\"\r\n                                className=\"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                                value={detalle.product_code || ''}\r\n                                onChange={(e) => updateDetailItem(index, 'product_code', e.target.value)}\r\n                                placeholder=\"Ej: PROD001\"\r\n                              />\r\n                            </div>\r\n\r\n                            {/* Nombre del producto */}\r\n                            <div>\r\n                              <label className=\"block text-xs font-medium text-gray-600 mb-1\">\r\n                                Nombre del Producto *\r\n                              </label>\r\n                              <input\r\n                                type=\"text\"\r\n                                className=\"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                                value={detalle.product_name || ''}\r\n                                onChange={(e) => updateDetailItem(index, 'product_name', e.target.value)}\r\n                                placeholder=\"Ej: Producto de ejemplo\"\r\n                              />\r\n                            </div>\r\n\r\n                            {/* Cantidad */}\r\n                            <div>\r\n                              <label className=\"block text-xs font-medium text-gray-600 mb-1\">\r\n                                Cantidad *\r\n                              </label>\r\n                              <input\r\n                                type=\"number\"\r\n                                step=\"0.01\"\r\n                                min=\"0.01\"\r\n                                className=\"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                                value={detalle.quantity || 0}\r\n                                onChange={(e) => updateDetailItem(index, 'quantity', parseFloat(e.target.value) || 0)}\r\n                              />\r\n                            </div>\r\n\r\n                            {/* Precio unitario */}\r\n                            <div>\r\n                              <label className=\"block text-xs font-medium text-gray-600 mb-1\">\r\n                                Precio Unitario *\r\n                              </label>\r\n                              <input\r\n                                type=\"number\"\r\n                                step=\"0.01\"\r\n                                min=\"0.01\"\r\n                                className=\"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                                value={detalle.unit_price || 0}\r\n                                onChange={(e) => updateDetailItem(index, 'unit_price', parseFloat(e.target.value) || 0)}\r\n                              />\r\n                            </div>\r\n\r\n                            {/* Descuento */}\r\n                            <div>\r\n                              <label className=\"block text-xs font-medium text-gray-600 mb-1\">\r\n                                Descuento\r\n                              </label>\r\n                              <input\r\n                                type=\"number\"\r\n                                step=\"0.01\"\r\n                                min=\"0\"\r\n                                className=\"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                                value={detalle.discount || 0}\r\n                                onChange={(e) => updateDetailItem(index, 'discount', parseFloat(e.target.value) || 0)}\r\n                              />\r\n                            </div>\r\n\r\n                            {/* Código IVA */}\r\n                            <div>\r\n                              <label className=\"block text-xs font-medium text-gray-600 mb-1\">\r\n                                Código IVA *\r\n                              </label>\r\n                              <select\r\n                                className=\"w-full px-3 py-2 text-sm border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                                value={detalle.codigo_iva || '4'}\r\n                                onChange={(e) => updateDetailItem(index, 'codigo_iva', e.target.value)}\r\n                              >\r\n                                <option value=\"4\">4 - IVA 15% (Actual)</option>\r\n                                <option value=\"0\">0 - IVA 0%</option>\r\n                                <option value=\"5\">5 - IVA 5% (materiales construcción)</option>\r\n                                <option value=\"2\">2 - IVA 12% (obsoleto)</option>\r\n                                <option value=\"3\">3 - IVA 14%</option>\r\n                                <option value=\"6\">6 - No objeto de impuesto</option>\r\n                                <option value=\"7\">7 - Exento de IVA</option>\r\n                              </select>\r\n                            </div>\r\n                          </div>\r\n\r\n                          {/* Subtotal del item */}\r\n                          <div className=\"mt-3 pt-3 border-t border-gray-200\">\r\n                            <div className=\"text-right\">\r\n                              <span className=\"text-sm text-gray-600\">Subtotal: </span>\r\n                              <span className=\"text-sm font-medium text-gray-900\">\r\n                                ${((detalle.quantity || 0) * (detalle.unit_price || 0) - (detalle.discount || 0)).toFixed(2)}\r\n                              </span>\r\n                            </div>\r\n                          </div>\r\n                        </div>\r\n                      ))}\r\n\r\n                      {/* Total general */}\r\n                      <div className=\"border-t border-gray-300 pt-3\">\r\n                        <div className=\"text-right\">\r\n                          <span className=\"text-lg font-medium text-gray-900\">\r\n                            Total: ${calculateTotalAmount().toFixed(2)}\r\n                          </span>\r\n                        </div>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n              </div>\r\n\r\n              {/* Acciones */}\r\n              <div className=\"flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200\">\r\n                <button\r\n                  onClick={closeCreateModal}\r\n                  disabled={actionLoading[0]}\r\n                  className=\"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50\"\r\n                >\r\n                  Cancelar\r\n                </button>\r\n                <button\r\n                  onClick={createCreditNote}\r\n                  disabled={actionLoading[0]}\r\n                  className=\"px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors disabled:opacity-50 flex items-center\"\r\n                >\r\n                  {actionLoading[0] ? (\r\n                    <>\r\n                      <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                      Creando...\r\n                    </>\r\n                  ) : (\r\n                    'Crear Nota de Crédito'\r\n                  )}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Modal de Edición de Nota de Crédito - Similar al de facturas */}\r\n      {showEditModal && editingCreditNote && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-white rounded-lg shadow-xl max-w-2xl w-full max-h-[90vh] overflow-y-auto\">\r\n            <div className=\"px-6 py-4 border-b border-gray-200 flex justify-between items-center\">\r\n              <h3 className=\"text-lg font-medium text-gray-900\">\r\n                Editar Nota de Crédito {editingCreditNote.credit_note_number}\r\n              </h3>\r\n              <button\r\n                onClick={closeEditModal}\r\n                className=\"text-gray-400 hover:text-gray-500\"\r\n                disabled={actionLoading[editingCreditNote.id]}\r\n              >\r\n                <X className=\"h-5 w-5\" />\r\n              </button>\r\n            </div>\r\n            <div className=\"p-6\">\r\n              <div className=\"space-y-4\">\r\n                {/* Formulario similar al de facturas */}\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                    Nombre del cliente\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                    value={editFormData.customer_name || ''}\r\n                    onChange={(e) => setEditFormData(prev => ({...prev, customer_name: e.target.value}))}\r\n                    placeholder=\"Nombre completo del cliente\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                    Cédula/RUC\r\n                  </label>\r\n                  <input\r\n                    type=\"text\"\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                    value={editFormData.customer_identification || ''}\r\n                    onChange={(e) => setEditFormData(prev => ({...prev, customer_identification: e.target.value}))}\r\n                    placeholder=\"Cédula (10 dígitos) o RUC (13 dígitos)\"\r\n                    maxLength={13}\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                    Email (opcional)\r\n                  </label>\r\n                  <input\r\n                    type=\"email\"\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                    value={editFormData.customer_email || ''}\r\n                    onChange={(e) => setEditFormData(prev => ({...prev, customer_email: e.target.value}))}\r\n                    placeholder=\"email@ejemplo.com\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                    Dirección\r\n                  </label>\r\n                  <textarea\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                    rows={3}\r\n                    value={editFormData.customer_address || ''}\r\n                    onChange={(e) => setEditFormData(prev => ({...prev, customer_address: e.target.value}))}\r\n                    placeholder=\"Dirección completa del cliente\"\r\n                  />\r\n                </div>\r\n\r\n                <div>\r\n                  <label className=\"block text-sm font-medium text-gray-700 mb-1\">\r\n                    Teléfono (opcional)\r\n                  </label>\r\n                  <input\r\n                    type=\"tel\"\r\n                    className=\"w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500\"\r\n                    value={editFormData.customer_phone || ''}\r\n                    onChange={(e) => setEditFormData(prev => ({...prev, customer_phone: e.target.value}))}\r\n                    placeholder=\"0999999999\"\r\n                  />\r\n                </div>\r\n              </div>\r\n\r\n              {/* Acciones */}\r\n              <div className=\"flex justify-end gap-3 mt-6 pt-4 border-t border-gray-200\">\r\n                <button\r\n                  onClick={closeEditModal}\r\n                  disabled={actionLoading[editingCreditNote.id]}\r\n                  className=\"px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors disabled:opacity-50\"\r\n                >\r\n                  Cancelar\r\n                </button>\r\n                <button\r\n                  onClick={saveEditChanges}\r\n                  disabled={actionLoading[editingCreditNote.id]}\r\n                  className=\"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors disabled:opacity-50 flex items-center\"\r\n                >\r\n                  {actionLoading[editingCreditNote.id] ? (\r\n                    <>\r\n                      <RefreshCw className=\"h-4 w-4 mr-2 animate-spin\" />\r\n                      Guardando...\r\n                    </>\r\n                  ) : (\r\n                    'Guardar Cambios'\r\n                  )}\r\n                </button>\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n\r\n      {/* Modal de Detalle de Nota de Crédito - Similar al de facturas */}\r\n      {showCreditNoteModal && selectedCreditNote && (\r\n        <div className=\"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4\">\r\n          <div className=\"bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto\">\r\n            <div className=\"px-6 py-4 border-b border-gray-200 flex justify-between items-center\">\r\n              <h3 className=\"text-lg font-medium text-gray-900\">\r\n                Detalle de Nota de Crédito {selectedCreditNote.credit_note_number}\r\n              </h3>\r\n              <button\r\n                onClick={closeCreditNoteModal}\r\n                className=\"text-gray-400 hover:text-gray-500\"\r\n              >\r\n                <X className=\"h-5 w-5\" />\r\n              </button>\r\n            </div>\r\n            <div className=\"p-6\">\r\n              {/* Información de cabecera */}\r\n              <div className=\"grid grid-cols-1 md:grid-cols-3 gap-6 mb-6\">\r\n                {/* Información general */}\r\n                <div>\r\n                  <h4 className=\"text-sm font-medium text-gray-500 mb-2\">\r\n                    Información General\r\n                  </h4>\r\n                  <div className=\"space-y-1 text-sm\">\r\n                    <div className=\"flex justify-between\">\r\n                      <span className=\"text-gray-600\">Número:</span>\r\n                      <span className=\"font-medium text-gray-900\">\r\n                        {selectedCreditNote.credit_note_number}\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"flex justify-between\">\r\n                      <span className=\"text-gray-600\">Fecha emisión:</span>\r\n                      <span className=\"font-medium text-gray-900\">\r\n                        {formatDate(selectedCreditNote.issue_date)}\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"flex justify-between\">\r\n                      <span className=\"text-gray-600\">Estado:</span>\r\n                      <span\r\n                        className={`inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium`}\r\n                        style={{\r\n                          backgroundColor: getStatusBgColor(selectedCreditNote.status_color),\r\n                          color: getStatusTextColor(selectedCreditNote.status_color)\r\n                        }}\r\n                      >\r\n                        {getStatusIcon(selectedCreditNote.status)}\r\n                        {selectedCreditNote.status_label}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Información del cliente */}\r\n                <div>\r\n                  <h4 className=\"text-sm font-medium text-gray-500 mb-2\">\r\n                    Cliente\r\n                  </h4>\r\n                  <div className=\"space-y-1 text-sm\">\r\n                    <div className=\"flex items-center\">\r\n                      <User className=\"h-4 w-4 text-gray-400 mr-2\" />\r\n                      <span className=\"font-medium text-gray-900\">\r\n                        {selectedCreditNote.customer.name}\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"flex items-center\">\r\n                      <CreditCard className=\"h-4 w-4 text-gray-400 mr-2\" />\r\n                      <span className=\"text-gray-700\">\r\n                        {selectedCreditNote.customer.identification}\r\n                        <span className=\"text-xs text-gray-500 ml-1\">\r\n                          ({selectedCreditNote.customer.identification_type_label})\r\n                        </span>\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"flex items-center\">\r\n                      <Phone className=\"h-4 w-4 text-gray-400 mr-2\" />\r\n                      <span className=\"text-gray-700\">\r\n                        {selectedCreditNote.customer.phone || 'N/A'}\r\n                      </span>\r\n                    </div>\r\n                    <div className=\"flex items-start\">\r\n                      <MapPin className=\"h-4 w-4 text-gray-400 mr-2 mt-0.5\" />\r\n                      <span className=\"text-gray-700 text-xs\">\r\n                        {selectedCreditNote.customer.address}\r\n                      </span>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n\r\n                {/* Información SRI */}\r\n                <div>\r\n                  <h4 className=\"text-sm font-medium text-gray-500 mb-2\">\r\n                    SRI\r\n                  </h4>\r\n                  <div className=\"space-y-1 text-sm\">\r\n                    {selectedCreditNote.sri.access_key && (\r\n                      <div>\r\n                        <span className=\"text-gray-600\">Clave de acceso:</span>\r\n                        <p className=\"text-xs text-gray-900 font-mono break-all mt-1\">\r\n                          {selectedCreditNote.sri.access_key}\r\n                        </p>\r\n                      </div>\r\n                    )}\r\n                    {selectedCreditNote.sri.authorization_number && (\r\n                      <div>\r\n                        <span className=\"text-gray-600\">N° autorización:</span>\r\n                        <p className=\"text-xs text-gray-900 font-mono break-all mt-1\">\r\n                          {selectedCreditNote.sri.authorization_number}\r\n                        </p>\r\n                      </div>\r\n                    )}\r\n                    {selectedCreditNote.retry_info.count > 0 && (\r\n                      <div className=\"text-orange-600\">\r\n                        <span className=\"text-xs\">\r\n                          Reintentos: {selectedCreditNote.retry_info.count}\r\n                        </span>\r\n                      </div>\r\n                    )}\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Información de error SRI (si existe) */}\r\n              {selectedCreditNote.sri.error_message && (\r\n                <div className=\"bg-red-50 p-4 rounded-lg mb-6\">\r\n                  <h4 className=\"text-sm font-medium text-red-800 mb-2 flex items-center\">\r\n                    <AlertTriangle className=\"h-4 w-4 mr-1\" />\r\n                    Error del SRI\r\n                  </h4>\r\n                  <p className=\"text-sm text-red-700\">\r\n                    {selectedCreditNote.sri.error_message}\r\n                  </p>\r\n                </div>\r\n              )}\r\n\r\n              {/* Totales */}\r\n              <div className=\"mb-6\">\r\n                <h4 className=\"text-sm font-medium text-gray-500 mb-2\">\r\n                  Totales\r\n                </h4>\r\n                <div className=\"bg-gray-50 p-4 rounded-lg\">\r\n                  <div className=\"grid grid-cols-3 gap-4 text-sm\">\r\n                    <div>\r\n                      <span className=\"text-gray-600\">Subtotal:</span>\r\n                      <p className=\"font-medium text-gray-900\">\r\n                        {formatCurrency(selectedCreditNote.subtotal)}\r\n                      </p>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"text-gray-600\">IVA (15%):</span>\r\n                      <p className=\"font-medium text-gray-900\">\r\n                        {formatCurrency(selectedCreditNote.tax_amount)}\r\n                      </p>\r\n                    </div>\r\n                    <div>\r\n                      <span className=\"text-gray-600\">Total:</span>\r\n                      <p className=\"font-bold text-gray-900 text-lg\">\r\n                        {formatCurrency(selectedCreditNote.total_amount)}\r\n                      </p>\r\n                    </div>\r\n                  </div>\r\n                </div>\r\n              </div>\r\n\r\n              {/* Acciones */}\r\n              <div className=\"flex flex-wrap justify-end gap-2 mt-6\">\r\n                {/* Opción para descargar */}\r\n                <div className=\"relative\">\r\n                  <button\r\n                    onClick={() => setShowPrintOptions(!showPrintOptions)}\r\n                    className=\"px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors flex items-center\"\r\n                  >\r\n                    <Download className=\"h-4 w-4 mr-2\" />\r\n                    Descargar\r\n                  </button>\r\n\r\n                  {showPrintOptions && (\r\n                    <div className=\"absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 z-10\">\r\n                      <div className=\"py-1\">\r\n                        <button\r\n                          onClick={() => downloadCreditNote(selectedCreditNote.id, \"pdf\")}\r\n                          className=\"flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left\"\r\n                        >\r\n                          <FileText className=\"h-4 w-4 mr-2 text-gray-500\" />\r\n                          Descargar PDF\r\n                        </button>\r\n                        <button\r\n                          onClick={() => downloadCreditNote(selectedCreditNote.id, \"xml\")}\r\n                          className=\"flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left\"\r\n                        >\r\n                          <FileText className=\"h-4 w-4 mr-2 text-gray-500\" />\r\n                          Descargar XML\r\n                        </button>\r\n                        <button\r\n                          onClick={() => sendCreditNoteByEmail(selectedCreditNote.id)}\r\n                          className=\"flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 w-full text-left\"\r\n                        >\r\n                          <Send className=\"h-4 w-4 mr-2 text-gray-500\" />\r\n                          Enviar por email\r\n                        </button>\r\n                      </div>\r\n                    </div>\r\n                  )}\r\n                </div>\r\n\r\n                {/* Ver factura relacionada */}\r\n                {selectedCreditNote.invoice && (\r\n                  <Link\r\n                    to={`/admin/invoices/${selectedCreditNote.invoice.id}`}\r\n                    className=\"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center\"\r\n                  >\r\n                    <FileText className=\"h-4 w-4 mr-2\" />\r\n                    Ver Factura Original\r\n                  </Link>\r\n                )}\r\n              </div>\r\n            </div>\r\n          </div>\r\n        </div>\r\n      )}\r\n    </div>\r\n  );\r\n};\r\n\r\nexport default AdminCreditNotesPage;"],"names":["HttpCreditNoteRepository","filters","queryParams","response","ApiClient","creditNotes","pagination","meta","error","id","creditNoteData","claveAcceso","creditNoteId","updateData","appConfig","search","limit","invoiceId","GetAllCreditNotesUseCase","creditNoteRepository","GetCreditNoteByIdUseCase","RetryCreditNoteUseCase","CheckCreditNoteStatusUseCase","GetCreditNoteStatsUseCase","UpdateCreditNoteUseCase","CreateCreditNoteUseCase","data","detalle","index","GetAuthorizedInvoicesUseCase","validStatuses","creditNoteReasons","AdminCreditNotesPage","showToast","useToast","location","useLocation","getAllCreditNotesUseCase","useState","repository","getCreditNoteByIdUseCase","retryCreditNoteUseCase","checkCreditNoteStatusUseCase","getCreditNoteStatsUseCase","updateCreditNoteUseCase","createCreditNoteUseCase","getAuthorizedInvoicesUseCase","setCreditNotes","stats","setStats","loading","setLoading","setError","setFilters","setPagination","selectedCreditNote","setSelectedCreditNote","showCreditNoteModal","setShowCreditNoteModal","showPrintOptions","setShowPrintOptions","showEditModal","setShowEditModal","editingCreditNote","setEditingCreditNote","editFormData","setEditFormData","showCreateModal","setShowCreateModal","createFormData","setCreateFormData","authorizedInvoices","setAuthorizedInvoices","invoiceSearch","setInvoiceSearch","selectedInvoice","setSelectedInvoice","showInvoiceDropdown","setShowInvoiceDropdown","invoiceSearchLoading","setInvoiceSearchLoading","dropdownRef","useRef","actionLoading","setActionLoading","useEffect","fetchData","invoiceData","mockInvoice","prev","handleClickOutside","event","creditNotesResponse","statsResponse","creditNotesData","searchAuthorizedInvoices","searchTerm","searchTimeout","setSearchTimeout","handleInvoiceSearch","value","newTimeout","selectInvoice","invoice","clearInvoiceSelection","handleFilterChange","key","handlePageChange","page","openCreditNoteModal","creditNote","detail","NotificationType","closeCreditNoteModal","retryCreditNote","errorMessage","checkSriStatus","result","current_status","sri_status","sri_access_key","sri_authorization_number","statusMessage","formatDate","dateString","date","formatCurrency","amount","downloadCreditNote","format","pdfBlob","url","link","sendCreditNoteByEmail","_creditNoteId","openEditModal","closeEditModal","saveEditChanges","changedData","closeCreateModal","addDetailItem","newDetail","removeDetailItem","_","i","updateDetailItem","field","calculateTotalAmount","total","subtotal","loadInvoiceDetails","details","createCreditNote","sriData","columns","jsxs","jsx","Minus","User","CreditCard","getStatusBgColor","getStatusTextColor","getStatusIcon","isActionLoading","Eye","Edit","RefreshCw","RotateCcw","Download","color","colorMap","status","Clock","Send","CheckCircle","XCircle","AlertTriangle","statItems","StatCardList","Filter","e","Calendar","Table","X","r","selectedReason","reason","Fragment","Plus","Trash2","Phone","MapPin","FileText","Link"],"mappings":"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"}