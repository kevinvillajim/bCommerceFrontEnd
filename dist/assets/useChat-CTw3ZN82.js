import{t as p,l as w,r as d,u as Q}from"./index-DmNDOrWy.js";import{e as R}from"./errorHandler-ugMJT1nb.js";class W{isSeller;serviceId;constructor(a=!1){this.isSeller=a,this.serviceId=`chat-service-${Date.now()}-${Math.round(Math.random()*1e3)}`,console.log(`ChatService inicializado como ${a?"vendedor":"usuario"} (ID: ${this.serviceId})`)}getEndpoint(a,...r){if(this.isSeller)switch(a){case"LIST":return p.CHAT.SELLER.LIST;case"DETAILS":return p.CHAT.SELLER.DETAILS(r[0]);case"SEND_MESSAGE":return p.CHAT.SELLER.SEND_MESSAGE(r[0]);case"UPDATE_STATUS":return p.CHAT.SELLER.UPDATE_STATUS(r[0]);case"GET_MESSAGES":return p.CHAT.SELLER.GET_MESSAGES(r[0]);case"MARK_ALL_READ":return p.CHAT.SELLER.MARK_ALL_READ(r[0]);case"MARK_MESSAGE_READ":return p.CHAT.MARK_MESSAGE_READ(r[0],r[1]);case"DELETE":return p.CHAT.DELETE(r[0]);case"CREATE":return p.CHAT.CREATE;default:return""}else switch(a){case"LIST":return p.CHAT.LIST;case"DETAILS":return p.CHAT.DETAILS(r[0]);case"CREATE":return p.CHAT.CREATE;case"SEND_MESSAGE":return p.CHAT.SEND_MESSAGE(r[0]);case"UPDATE_STATUS":return p.CHAT.UPDATE_STATUS(r[0]);case"DELETE":return p.CHAT.DELETE(r[0]);case"GET_MESSAGES":return p.CHAT.GET_MESSAGES(r[0]);case"MARK_ALL_READ":return p.CHAT.MARK_ALL_READ(r[0]);case"MARK_MESSAGE_READ":return p.CHAT.MARK_MESSAGE_READ(r[0],r[1]);default:return""}}validateApiResponse(a,r=[]){if(!a||typeof a!="object")return console.warn("Respuesta invÃ¡lida del API:",a),null;for(const s of r)if(!(s in a))return console.warn(`Campo requerido '${s}' no encontrado en respuesta:`,a),null;return a}async getChats(){try{console.log(`ChatService (${this.serviceId}): Obteniendo lista de chats ${this.isSeller?"como vendedor":"como usuario"}`);const a=this.getEndpoint("LIST"),r=await w.get(a),s=this.validateApiResponse(r);if(!s)return{status:"error",data:[]};if(s.status==="success"){const o=Array.isArray(s.data)?s.data:s.data?.data||[];return console.log(`ChatService (${this.serviceId}): Se encontraron ${o.length} chats`),{status:"success",data:o,meta:s.data?.meta||s.meta}}else if(Array.isArray(s))return console.log(`ChatService (${this.serviceId}): Array directo con ${s.length} chats`),{status:"success",data:s};return console.log(`ChatService (${this.serviceId}): No se encontraron chats`),{status:"success",data:[]}}catch(a){return console.error(`ChatService (${this.serviceId}): Error al obtener chats:`,a),{status:"error",data:[]}}}async getChatDetails(a,r=1,s=50){try{console.log(`ChatService (${this.serviceId}): Obteniendo detalles del chat ${a}`);const o=this.getEndpoint("DETAILS",a),i=await w.get(`${o}?page=${r}&limit=${s}`),S=this.validateApiResponse(i,["status"]);if(!S)throw new Error(`No se pudo obtener informaciÃ³n del chat ${a}`);if(S.status==="success"){const T=S.data||{},E=T.chat||{id:a,userId:0,sellerId:0,productId:0,status:"active",messages:[]},b=T.messages||[],u=T.pagination||{currentPage:r,limit:s,total:b.length};return E.id||(E.id=a),{status:"success",data:{chat:E,messages:b,pagination:u}}}throw new Error(`Error en respuesta del servidor: ${S.status}`)}catch(o){throw console.error(`ChatService (${this.serviceId}): Error al obtener detalles del chat ${a}:`,o),o}}async getMessages(a,r=1,s=20){try{const o=this.getEndpoint("GET_MESSAGES",a),i=await w.get(`${o}?page=${r}&limit=${s}`),S=this.validateApiResponse(i);if(!S)throw new Error(`No se pudieron obtener los mensajes del chat ${a}`);const T=S.data?.messages||[],E=S.data?.pagination||{currentPage:r,limit:s,total:0};return{status:"success",data:{messages:T,pagination:E}}}catch(o){throw console.error(`ChatService (${this.serviceId}): Error al obtener mensajes del chat ${a}:`,o),o}}async sendMessage(a,r){try{if(console.log(`ChatService (${this.serviceId}): Enviando mensaje al chat ${a}`),!a||!r.content.trim())throw new Error("ID de chat o contenido del mensaje invÃ¡lidos");const s=this.getEndpoint("SEND_MESSAGE",a),o=await w.post(s,r),i=this.validateApiResponse(o);if(!i)throw new Error("No se recibiÃ³ respuesta al enviar mensaje");if(i.status==="error"){const S=new Error(i.message);throw S.response={data:i},S}if(i.status==="success")return{status:i.status,message:i.message||"Mensaje enviado",data:{message:i.data?.message||{id:Date.now(),chatId:a,senderId:0,content:r.content,isRead:!1,createdAt:new Date().toISOString()}}};throw new Error("Formato de respuesta inesperado")}catch(s){throw console.error(`ChatService (${this.serviceId}): Error al enviar mensaje:`,s),s}}async createChat(a){try{if(console.log(`ChatService (${this.serviceId}): Creando chat`),!a.seller_id||!a.product_id)throw new Error("ID de vendedor o producto invÃ¡lidos");const r=this.getEndpoint("CREATE"),s=await w.post(r,a),o=this.validateApiResponse(s);if(!o)throw new Error("Formato de respuesta inesperado al crear chat");if(o.status==="success"){const i=o.data?.chat_id||o.data?.id||o.id;if(i)return{status:"success",message:o.message||"Chat creado correctamente",data:{chat_id:i}}}throw new Error("No se pudo obtener el ID del chat creado")}catch(r){throw console.error(`ChatService (${this.serviceId}): Error al crear chat:`,r),r}}async updateChatStatus(a,r){try{if(!a||!r.status)throw new Error("ID de chat o estado invÃ¡lidos");const s=this.getEndpoint("UPDATE_STATUS",a),o=await w.put(s,r),i=this.validateApiResponse(o);if(!i)throw new Error("No se recibiÃ³ respuesta al actualizar estado");return{status:i.status||"success",message:i.message||`Chat ${r.status} correctamente`,data:{chat_id:i.data?.chat_id||a,status:i.data?.status||r.status}}}catch(s){throw console.error(`ChatService (${this.serviceId}): Error al actualizar estado del chat ${a}:`,s),s}}async markAllMessagesAsRead(a){try{const r=this.getEndpoint("MARK_ALL_READ",a),s=await w.post(r,{}),o=this.validateApiResponse(s);if(!o)throw new Error("No se recibiÃ³ respuesta al marcar mensajes como leÃ­dos");return{status:o.status||"success",message:o.message||"Mensajes marcados como leÃ­dos"}}catch(r){throw console.error(`ChatService (${this.serviceId}): Error al marcar mensajes como leÃ­dos:`,r),r}}async markMessageAsRead(a,r){try{const s=this.getEndpoint("MARK_MESSAGE_READ",a,r),o=await w.patch(s,{}),i=this.validateApiResponse(o);if(!i)throw new Error("No se recibiÃ³ respuesta al marcar mensaje como leÃ­do");return{status:i.status||"success",message:i.message||"Mensaje marcado como leÃ­do"}}catch(s){throw console.error(`ChatService (${this.serviceId}): Error al marcar mensaje como leÃ­do:`,s),s}}async deleteChat(a){try{const r=this.getEndpoint("DELETE",a),s=await w.delete(r),o=this.validateApiResponse(s);if(!o)throw new Error("No se recibiÃ³ respuesta al eliminar chat");return{status:o.status||"success",message:o.message||"Chat eliminado correctamente"}}catch(r){throw console.error(`ChatService (${this.serviceId}): Error al eliminar chat:`,r),r}}async getChatsBySellerIdExplicit(a){try{console.log(`ChatService (${this.serviceId}): Obteniendo chats para vendedor ID ${a}`);const r=p.CHAT.SELLER.LIST_BY_SELLER(a),s=await w.get(r),o=this.validateApiResponse(s);return o?o.status==="success"?{status:"success",data:Array.isArray(o.data)?o.data:o.data?.data||[],meta:o.data?.meta}:Array.isArray(o)?{status:"success",data:o}:{status:"success",data:[]}:{status:"error",data:[]}}catch(r){throw console.error(`ChatService (${this.serviceId}): Error al obtener chats para vendedor ID ${a}:`,r),r}}}const ee=(H=!1)=>{const[a,r]=d.useState([]),[s,o]=d.useState(null),[i,S]=d.useState([]),[T,E]=d.useState(!1),[b,u]=d.useState(null),h=d.useRef(!1),j=d.useRef({}),v=d.useRef(null),L=d.useRef([]),M=d.useRef(H),N=d.useRef(null),{user:A}=Q(),f=d.useCallback(()=>(N.current||(console.log(`Creando instancia Ãºnica de ChatService (isSeller=${M.current})`),N.current=new W(M.current)),N.current),[]),I=async e=>{try{const t=await w.get(p.SELLERS.BY_USER_ID(e));return t?.data?.id?t.data.id:t?.data?.seller_id?t.data.seller_id:null}catch(t){return console.error(`Error al obtener informaciÃ³n del vendedor para usuario ${e}:`,t),null}},y=d.useCallback(async()=>{if(h.current)return[];try{console.log(`ðŸ”„ Obteniendo lista de chats ${M.current?"como vendedor":"como usuario"}...`),h.current=!0,E(!0),u(null);const e=f();let t;if(M.current&&A?.id){const c=await I(A.id);if(c)try{t=await e.getChatsBySellerIdExplicit(c)}catch(n){console.warn("Error en bÃºsqueda explÃ­cita por ID de vendedor:",n);try{t=await e.getChatsBySellerIdExplicit(A.id)}catch(g){console.warn("Error en bÃºsqueda explÃ­cita por ID de usuario:",g),t=await e.getChats()}}else try{t=await e.getChatsBySellerIdExplicit(A.id)}catch(n){console.warn("Error en bÃºsqueda explÃ­cita por ID de usuario:",n),t=await e.getChats()}}else t=await e.getChats();if(!t||t.status!=="success")throw new Error("No se pudo obtener la lista de chats");const l=t.data||[];return r(l),L.current=l,console.log(`âœ… Cargados ${l.length} chats ${M.current?"como vendedor":"como usuario"}`),l}catch(e){return console.error("Error al obtener chats:",e),u(R(e,"Error al cargar los chats")),[]}finally{E(!1),h.current=!1}},[f,A?.id]),C=d.useCallback(async e=>{const t=j.current[e]||0;if(t>2)return console.warn(`Demasiados intentos para cargar el chat ${e}`),u("No se pudo cargar el chat. Intente mÃ¡s tarde."),v.current&&(clearInterval(v.current),v.current=null),null;try{if(h.current)return console.log(`PeticiÃ³n bloqueada para chat ${e}`),null;console.log(`Cargando mensajes para chat ${e}...`),h.current=!0,E(!0),u(null),j.current[e]=t+1;const c=await f().getChatDetails(e);if(c&&c.status==="success"&&c.data?.chat){const n=c.data.chat,g=c.data.messages||[];if(n.id)return console.log(`Chat ${e} cargado con ${g.length} mensajes`),j.current[e]=0,o(n),S(g),r($=>{if(!$.some(m=>m.id===n.id)){const m=[...$,n];return L.current=m,m}const G=$.map(m=>m.id===n.id?{...m,...n}:m);return L.current=G,G}),n}return console.error(`Error en respuesta para chat ${e}`),u("Error al cargar los mensajes"),null}catch(l){return console.error(`Error al obtener mensajes del chat ${e}:`,l),u(R(l,"Error al cargar los mensajes")),null}finally{h.current=!1,E(!1)}},[f]),P=d.useCallback(async(e,t)=>{if(h.current)return console.log("CreaciÃ³n bloqueada, hay una operaciÃ³n en curso"),null;try{console.log(`Creando chat con vendedor ${e} para producto ${t}...`),h.current=!0,E(!0),u(null);const c=await f().createChat({seller_id:e,product_id:t});if(c.status==="success"&&c.data?.chat_id){console.log("Chat creado correctamente:",c.data);const n=c.data.chat_id;return await C(n),n}else return console.error("Error en respuesta al crear chat:",c),u(c.message||"Error al crear el chat"),null}catch(l){return console.error("Error al crear chat:",l),u(R(l,"Error al crear el chat")),null}finally{h.current=!1,E(!1)}},[C,f]),x=d.useCallback(async(e,t)=>{if(!e||!t.trim())return console.error("No se puede enviar mensaje: Chat ID o contenido vacÃ­o"),!1;if(h.current)return console.log("EnvÃ­o bloqueado, hay una operaciÃ³n en curso"),!1;try{console.log(`Enviando mensaje al nuevo chat ${e}...`),h.current=!0,E(!0),u(null);const c=await f().sendMessage(e,{content:t.trim()});return c.status==="success"?(console.log("Mensaje para nuevo chat enviado correctamente"),await C(e),!0):(console.error("Error en respuesta al enviar mensaje:",c),u(c.message||"Error al enviar el mensaje"),!1)}catch(l){if(console.error("Error al enviar mensaje a nuevo chat:",l),l?.response?.data?.status==="error")throw l;return u(R(l,"Error al enviar el mensaje")),!1}finally{h.current=!1,E(!1)}},[C,f]),U=d.useCallback(async e=>{if(!s||!s.id||!e.trim())return console.error("No se puede enviar mensaje: Chat no seleccionado o contenido vacÃ­o"),!1;if(h.current)return console.log("EnvÃ­o bloqueado, hay una operaciÃ³n en curso"),!1;try{console.log(`Enviando mensaje a chat ${s.id} ${M.current?"como vendedor":"como usuario"}...`),h.current=!0,E(!0),u(null);const l=await f().sendMessage(s.id,{content:e.trim()});return l.status==="success"?(console.log("Mensaje enviado correctamente"),await C(s.id),!0):(console.error("Error en respuesta al enviar mensaje:",l),u(l.message||"Error al enviar el mensaje"),!1)}catch(t){if(console.error("Error al enviar mensaje:",t),t?.response?.data?.status==="error")throw t;return u(R(t,"Error al enviar el mensaje")),!1}finally{h.current=!1,E(!1)}},[s,C,f]),K=d.useCallback(async(e,t)=>{if(h.current)return console.log("ActualizaciÃ³n bloqueada, hay una operaciÃ³n en curso"),!1;try{console.log(`Actualizando estado de chat ${e} a ${t}...`),h.current=!0,E(!0),u(null),r(n=>n.map(g=>g.id===e?{...g,status:t}:g)),s&&s.id===e&&o(n=>n?{...n,status:t}:null);const c=await f().updateChatStatus(e,{status:t});return c.status==="success"?(console.log("Estado actualizado correctamente"),!0):(console.error("Error en respuesta al actualizar estado:",c),await y(),u(c.message||`Error al ${t} el chat`),!1)}catch(l){return console.error(`Error al actualizar estado del chat ${e}:`,l),await y(),u(R(l,`Error al ${t} el chat`)),!1}finally{h.current=!1,E(!1)}},[s,y,f]),k=d.useCallback((e,t=15e3)=>(v.current&&(clearInterval(v.current),v.current=null),j.current[e]=0,console.log(`Iniciando polling para chat ${e}...`),v.current=setInterval(()=>{!h.current&&e&&(console.log(`Actualizando mensajes del chat ${e} (polling)...`),C(e))},t),()=>{v.current&&(clearInterval(v.current),v.current=null)}),[C]),D=d.useCallback(()=>{v.current&&(clearInterval(v.current),v.current=null,console.log("Polling de mensajes detenido"))},[]);d.useEffect(()=>{const e=new AbortController;return A?.id&&(console.log(`Valor de isSellerRef.current fijado en: ${M.current}`),f(),y()),()=>{e.abort(),h.current=!1,D(),r([]),o(null),S([])}},[A?.id,y,D,f]);const q=d.useCallback(e=>{if(!e){s!==null&&(console.log("Seleccionando chat: null"),o(null),S([]),D());return}if(s&&s.id===e.id){console.log(`Chat ${e.id} ya estÃ¡ seleccionado`);return}console.log("Seleccionando chat:",e),o(e),e&&e.id&&(C(e.id),k(e.id))},[C,k,D,s]),z=d.useCallback(async e=>{if(!e)return console.error("No se puede marcar mensajes como leÃ­dos: ID de chat no vÃ¡lido"),!1;try{return console.log(`Marcando todos los mensajes del chat ${e} como leÃ­dos...`),u(null),S(c=>c.map(n=>({...n,isRead:n.senderId!==A?.id?!0:n.isRead}))),r(c=>c.map(n=>n.id===e?{...n,unreadCount:0}:n)),(await f().markAllMessagesAsRead(e)).status==="success"}catch(t){return console.error(`Error al marcar mensajes como leÃ­dos en chat ${e}:`,t),u(R(t,"Error al marcar mensajes como leÃ­dos")),!1}},[A?.id,f]),B=d.useCallback(async(e,t)=>{if(!e||!t)return console.error("No se puede marcar mensaje como leÃ­do: IDs no vÃ¡lidos"),!1;try{console.log(`Marcando mensaje ${t} del chat ${e} como leÃ­do...`),u(null),S(n=>n.map(g=>g.id===t?{...g,isRead:!0}:g));const c=await f().markMessageAsRead(e,t);if(c.status==="success"){const n=i.filter(g=>!g.isRead&&g.senderId!==A?.id).length;r(g=>g.map($=>$.id===e?{...$,unreadCount:n}:$))}return c.status==="success"}catch(l){return console.error(`Error al marcar mensaje ${t} como leÃ­do:`,l),u(R(l,"Error al marcar mensaje como leÃ­do")),!1}},[A?.id,i,f]),O=d.useCallback(async(e,t,l=20)=>{if(!e||h.current)return!1;try{console.log(`Cargando mÃ¡s mensajes para el chat ${e} (pÃ¡gina ${t})...`),h.current=!0,E(!0),u(null);const n=await f().getMessages(e,t,l);if(n.status==="success"&&n.data.messages){const g=n.data.messages;return S($=>{const _=new Map;return $.forEach(m=>_.set(m.id,m)),g.forEach(m=>{_.has(m.id)||_.set(m.id,m)}),Array.from(_.values()).sort((m,Y)=>{const V=new Date(m.createdAt||0),J=new Date(Y.createdAt||0);return V.getTime()-J.getTime()})}),!0}return!1}catch(c){return console.error(`Error al cargar mÃ¡s mensajes para el chat ${e}:`,c),u(R(c,"Error al cargar mÃ¡s mensajes")),!1}finally{h.current=!1,E(!1)}},[f]),F=d.useCallback(async e=>{if(!e)return console.error("No se puede eliminar chat: ID no vÃ¡lido"),!1;try{return console.log(`Eliminando chat ${e}...`),E(!0),u(null),r(c=>c.filter(n=>n.id!==e)),s&&s.id===e&&(o(null),S([]),D()),(await f().deleteChat(e)).status==="success"}catch(t){return console.error(`Error al eliminar chat ${e}:`,t),u(R(t,"Error al eliminar chat")),await y(),!1}finally{E(!1)}},[s,o,D,y,f]);return{chats:a,selectedChat:s,messages:i,loading:T,error:b,fetchChats:y,fetchChatMessages:C,sendMessage:U,sendMessageForNewChat:x,createChat:P,updateChatStatus:K,setSelectedChat:q,startMessagesPolling:k,stopMessagesPolling:D,markAllAsRead:z,markMessageAsRead:B,loadMoreMessages:O,deleteChat:F}};export{ee as u};
//# sourceMappingURL=useChat-CTw3ZN82.js.map
