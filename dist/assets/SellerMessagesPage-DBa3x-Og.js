import{j as s,M as U,a0 as re,R as te}from"./ui-vendor-BUNMIuFe.js";import{u as ae,d as ne,r as a,R as oe}from"./react-vendor-Cy458wKG.js";import{u as le}from"./useChat-CLovqvUZ.js";import{u as ie,C as ce,a as de,b as ue,M as me}from"./chat-chunk-BRsdDZXf.js";import{u as fe}from"./ChatFilterToast-DUfxz0BJ.js";import"./admin-chunk-BNcFjXlJ.js";import"./utils-vendor-DeGC_a19.js";import"./seller-chunk-6swISJwY.js";const be=()=>{const c=ae(),{chatId:l}=ne(),{user:u}=ie(),[g,V]=a.useState(""),[j,B]=a.useState("all"),[R,q]=a.useState(!1),[w,_]=a.useState(window.innerWidth<768),[M,m]=a.useState(!l),[b,p]=a.useState(!1),[D,H]=a.useState("Cargando conversaciones..."),N=a.useRef(!1),y=a.useRef(l),$=a.useRef(0),z=a.useRef(!0),i=a.useRef({}),t=a.useRef(null),{showSellerStrike:W,showSellerBlocked:G,NotificationComponent:J}=fe(),{chats:C,selectedChat:o,messages:K,loading:f,error:F,fetchChats:v,fetchChatMessages:k,sendMessage:O,updateChatStatus:Q,setSelectedChat:d,startMessagesPolling:E,stopMessagesPolling:S,markAllAsRead:h}=le(!0);a.useEffect(()=>{const e=()=>{_(window.innerWidth<768)};return window.addEventListener("resize",e),()=>window.removeEventListener("resize",e)},[]),a.useEffect(()=>{!N.current&&u?.id&&(console.log("Cargando lista inicial de chats para vendedor..."),p(!0),v().then(e=>{if(N.current=!0,p(!1),console.log(`Lista inicial de ${e.length} chats cargada`),l&&e.length>0){const r=parseInt(l,10),n=e.find(x=>x.id===r);n?(console.log(`Chat ${r} encontrado en carga inicial, seleccionando...`),d(n),m(!1),t.current=r,n.unreadCount&&n.unreadCount>0&&!i.current[r]&&(i.current[r]=!0,setTimeout(()=>{h(r).catch(console.error)},1e3))):(console.log(`Chat ${r} no encontrado en lista inicial, intentando carga directa...`),A(r))}}).catch(e=>{console.error("Error al cargar chats iniciales:",e),p(!1),N.current=!0}))},[v,l,d,u?.id,h]);const A=a.useCallback(async e=>{if(t.current===e){console.log(`Chat ${e} ya está seleccionado, omitiendo carga.`);return}if(u?.id){console.log(`Intentando cargar chat específico ${e}...`),p(!0),H(`Cargando conversación #${e}...`),$.current+=1;try{const r=C.find(n=>n.id===e);if(r)console.log(`Chat ${e} encontrado en la lista, seleccionando...`),d(r),m(!1),t.current=e,E(e),r.unreadCount&&r.unreadCount>0&&!i.current[e]&&(i.current[e]=!0,setTimeout(()=>{h(e).catch(console.error)},1e3));else{console.log(`Chat ${e} no encontrado en la lista, cargando desde API...`);try{if(await k(e))console.log(`Chat ${e} cargado correctamente desde API`),m(!1),t.current=e,E(e),i.current[e]||(i.current[e]=!0,setTimeout(()=>{h(e).catch(console.error)},1e3));else if(console.warn(`Chat ${e} no encontrado en API`),$.current>=3)c("/seller/messages",{replace:!0}),t.current=null;else{const L=(await v()).find(T=>T.id===e);L?(d(L),m(!1),t.current=e):(c("/seller/messages",{replace:!0}),t.current=null)}}catch(n){console.error(`Error al cargar chat ${e} desde API:`,n),c("/seller/messages",{replace:!0}),t.current=null}}}catch(r){console.error(`Error al cargar chat ${e}:`,r),c("/seller/messages",{replace:!0}),t.current=null}finally{p(!1)}}},[C,k,c,d,v,E,h,u?.id]);a.useEffect(()=>{if(!(!N.current||!u?.id)){if(z.current){z.current=!1;return}if(!(l===y.current&&t.current!==null))if(S(),y.current=l,$.current=0,l){const e=parseInt(l,10);if(isNaN(e)){c("/seller/messages",{replace:!0}),t.current=null;return}t.current!==e&&(i.current[e]=!1,A(e))}else t.current!==null&&(d(null),t.current=null,m(!0))}},[l,A,c,d,S,u?.id]);const X=oe.useMemo(()=>C.filter(e=>{const r=j==="all"||e.status===j,n=R?(e.unreadCount??0)>0:!0,x=g===""||e.product?.name&&e.product.name.toLowerCase().includes(g.toLowerCase())||e.user?.name&&e.user.name.toLowerCase().includes(g.toLowerCase());return r&&n&&x}),[C,j,R,g]),Y=e=>{if(e&&e.id){if(t.current===e.id){console.log(`Chat ${e.id} ya está seleccionado, omitiendo selección.`);return}console.log(`Vendedor seleccionó chat ${e.id}`),S(),c(`/seller/messages/${e.id}`,{replace:!0}),y.current=String(e.id),t.current=e.id,d(e),w&&m(!1),e.unreadCount&&e.unreadCount>0&&!i.current[e.id]&&(i.current[e.id]=!0,setTimeout(()=>{e.id!==void 0&&h(e.id).catch(console.error)},1e3))}},Z=async e=>{console.log("Enviando mensaje como vendedor...");try{const r=await O(e);return r&&o?.id&&await k(o.id),r}catch(r){if(console.error("Error al enviar mensaje:",r),r?.response?.data?.status==="error"){const n=r.response.data,x=n.data?.strike_count||0,L=n.data?.is_blocked||!1,T=n.data?.censored_content;L?G("Tu cuenta ha sido bloqueada por acumular múltiples strikes. Contacta al soporte."):W(n.message,x,T)}return!1}},I=async(e,r)=>(console.log(`Actualizando estado de chat ${e} a ${r}...`),await Q(e,r)),ee=()=>{console.log("Volviendo a lista de chats"),S(),m(!0),c("/seller/messages",{replace:!0}),y.current=void 0,t.current=null},P=()=>{console.log("Refrescando lista de chats"),o&&o.id&&(i.current[o.id]=!1),v().then(()=>{console.log("Lista de chats refrescada")})},se=()=>(f||b)&&!o?s.jsxs("div",{className:"flex flex-col justify-center items-center h-full",children:[s.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600 mb-4"}),s.jsx("p",{className:"text-gray-600",children:D})]}):o?s.jsxs(s.Fragment,{children:[s.jsx(de,{chat:o,isSeller:!0,onUpdateStatus:I,loading:f}),s.jsx("div",{className:"flex-1 overflow-y-auto",children:s.jsx(ue,{messages:K,loading:f,noMessagesText:"No hay mensajes todavía",currentUserId:u?.id??void 0})}),s.jsx(me,{onSendMessage:Z,isDisabled:o.status!=="active",disabledText:o.status==="closed"?"Esta conversación está cerrada":"Esta conversación está archivada",isLoading:f,chatId:o.id})]}):s.jsxs("div",{className:"flex flex-col items-center justify-center h-full p-4 text-center",children:[s.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center mb-4",children:s.jsx(U,{className:"h-8 w-8 text-gray-500"})}),s.jsx("h3",{className:"text-lg font-medium text-gray-900",children:"Selecciona una conversación"}),s.jsx("p",{className:"text-gray-500 mt-2 max-w-md",children:C.length>0?"Elige una conversación de la lista para ver los mensajes y responder a tus clientes":"No tienes conversaciones activas. Cuando los clientes inicien conversaciones sobre tus productos, aparecerán aquí."})]});return s.jsxs("div",{className:"container mx-auto p-6 max-w-7xl",children:[s.jsxs("div",{className:"mb-6 flex justify-between items-center",children:[s.jsxs("div",{className:"flex items-center space-x-3",children:[s.jsx("div",{className:"h-10 w-10 bg-primary-100 rounded-lg flex items-center justify-center",children:s.jsx(U,{className:"w-5 h-5 text-primary-600"})}),s.jsxs("div",{children:[s.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Conversaciones con Clientes"}),s.jsx("p",{className:"text-sm text-gray-500",children:"Gestiona tus chats con compradores"})]})]}),s.jsxs("div",{className:"flex items-center space-x-3",children:[w&&o&&!M&&s.jsxs("button",{onClick:ee,className:"inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors",children:[s.jsx(re,{size:16,className:"mr-2"}),"Volver"]}),s.jsxs("button",{onClick:P,className:"inline-flex items-center px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors shadow-sm",disabled:f||b,children:[s.jsx(te,{size:16,className:`mr-2 ${f||b?"animate-spin":""}`}),"Actualizar"]})]})]}),F&&s.jsxs("div",{className:"bg-red-50 border border-red-200 text-red-700 px-4 py-3 rounded-lg relative mb-6 flex items-start space-x-3",children:[s.jsx("div",{className:"flex-shrink-0",children:s.jsx("svg",{className:"h-5 w-5 text-red-500",viewBox:"0 0 20 20",fill:"currentColor",children:s.jsx("path",{fillRule:"evenodd",d:"M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L8.586 10l-1.293 1.293a1 1 0 101.414 1.414L10 11.414l1.293 1.293a1 1 0 001.414-1.414L11.414 10l1.293-1.293a1 1 0 00-1.414-1.414L10 8.586 8.707 7.293z",clipRule:"evenodd"})})}),s.jsxs("div",{className:"flex-1",children:[s.jsx("h3",{className:"text-sm font-medium text-red-800",children:"Error al cargar conversaciones"}),s.jsx("p",{className:"text-sm text-red-700 mt-1",children:F}),s.jsx("button",{onClick:P,className:"text-sm text-red-700 hover:text-red-900 underline mt-2 inline-block",children:"Reintentar"})]})]}),s.jsxs("div",{className:"bg-white rounded-xl shadow-sm border border-gray-200 flex flex-col md:flex-row overflow-hidden",style:{minHeight:"75vh"},children:[(!w||M)&&s.jsx("div",{className:"w-full md:w-1/3 border-r border-gray-200 flex flex-col bg-white",children:s.jsx(ce,{chats:X,selectedChatId:o?.id,onSelectChat:Y,loading:f||b,searchTerm:g,onSearchChange:V,statusFilter:j,onStatusFilterChange:B,unreadFilter:R,onUnreadFilterChange:q,isSeller:!0,showTabs:!0})}),(!w||!M)&&s.jsx("div",{className:"w-full md:w-2/3 flex flex-col",children:se()})]}),s.jsx(J,{})]})};export{be as default};
//# sourceMappingURL=SellerMessagesPage-DBa3x-Og.js.map
