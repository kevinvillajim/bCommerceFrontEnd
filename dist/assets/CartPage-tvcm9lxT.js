import{j as e,T as Y,am as ee,Z as q,k as se,at as he,aJ as fe,p as ve,au as be,a0 as ye,q as je}from"./ui-vendor-BUNMIuFe.js";import{r,u as Ne,R as Ce,L as A}from"./react-vendor-Cy458wKG.js";import{u as we,a as Se,N as C,c as ke,b as De,E as Ee}from"./checkout-chunk-C5n3Mg9L.js";import{u as Ae}from"./useFavorites-Djw2mJtN.js";import{b as Ie}from"./index-BStY3ojk.js";import{C as I,f as c}from"./admin-chunk-BNcFjXlJ.js";import{u as Re}from"./useImageCache-BZuULX8l.js";import{u as Te}from"./useAutoPrefetch-DYmcqHFG.js";import"./seller-chunk-6swISJwY.js";import"./utils-vendor-DeGC_a19.js";import"./chat-chunk-BRsdDZXf.js";const $e=()=>{const[te,_]=r.useState(!0),[w,ae]=r.useState(!1),[S,R]=r.useState(""),[h,f]=r.useState(null),[F,O]=r.useState(!1),V=Ne(),{getOptimizedImageUrl:L}=Re(),{prefetchCartPageData:re}=Te({enabled:!0,delay:500,onPrefetchComplete:()=>console.log("✅ Cart page prefetch completed")}),{cart:o,loading:y,error:U,fetchCart:b,itemCount:W,removeFromCart:D,updateCartItem:E,clearCart:Q,showNotification:m,appliedDiscount:j,applyDiscountCode:$,removeDiscountCode:G}=we(),{toggleFavorite:J}=Ae(),{handleError:i,handleSuccess:u,handleStockError:T}=Se({showNotification:m,context:"CartPage"}),{optimisticCartAdd:M,optimisticCartRemove:v,optimisticFavoriteAdd:H}=Ie(),N=r.useCallback(s=>typeof s.stockAvailable=="number"?s.stockAvailable:typeof s.stock=="number"?s.stock:0,[]),Z=r.useCallback((s,t)=>N(s)>=t&&s.is_in_stock!==!1,[N]),x=r.useCallback(()=>{I.removeItem("cart_user_data"),I.removeItem("cart_guest_data"),I.removeItem("header_counters");for(let s=1;s<=10;s++)I.removeItem(`user_favorites_${s}_10`);console.log("🔄 Cache invalidado desde CartPage")},[]),P=r.useCallback(s=>L(s,"medium"),[L]),[oe,z]=r.useState([]),[le,B]=r.useState(!1);r.useEffect(()=>{(async()=>{if(!o?.items){z([]);return}B(!0),console.log("🔄 CartPage: Calculando descuentos con configuración dinámica");try{const t=await Promise.all(o.items.map(async a=>{const n=await ke(a);return{...a,discount:n,imageUrl:P(a.product)}}));console.log("✅ CartPage: Descuentos calculados para",t.length,"items"),z(t)}catch(t){console.error("❌ Error calculando descuentos:",t);const a=o.items.map(n=>{const p=De(n);return{...n,discount:p,imageUrl:P(n.product)}});z(a)}finally{B(!1)}})()},[o?.items,P]);const[l,K]=r.useState({subtotal:0,tax:0,couponAmount:0,total:0,totalVolumeSavings:0,totalSellerSavings:0,totalSavings:0,volumeDiscountsApplied:!1,shipping:0});r.useEffect(()=>{(async()=>{if(!o?.items?.length){K({subtotal:0,tax:0,couponAmount:0,total:0,totalVolumeSavings:0,totalSellerSavings:0,totalSavings:0,volumeDiscountsApplied:!1,shipping:0});return}console.log("🔍 JORDAN CART - Usando calculadora migrada con configuración unificada");const t=await Ee.calculateTotals(o.items,j,!0);console.log("🔍 FLUJO CART - Totales finales calculados:"),console.log("   💰 Subtotal después de cupón:",t.subtotalAfterCoupon),console.log("   💰 + Envío:",t.shipping,"=",t.subtotalWithShipping),console.log("   💰 + IVA 15%:",t.tax),console.log("   🎯 TOTAL CART:",t.total),console.log("   📊 Descuentos: seller=",t.sellerDiscounts,"volume=",t.volumeDiscounts,"cupón=",t.couponDiscount),K({subtotal:t.step3_afterVolumeDiscount,tax:t.tax,couponAmount:t.couponDiscount,total:t.total,totalVolumeSavings:t.volumeDiscounts,totalSellerSavings:t.sellerDiscounts,totalSavings:t.totalDiscounts,volumeDiscountsApplied:t.volumeDiscountsApplied,shipping:t.shipping})})()},[o?.items,j]),r.useEffect(()=>{(async()=>{_(!0);try{await b(),re()}catch(t){console.error("Error al cargar el carrito:",t),i(t,"No se pudo cargar el carrito. Inténtalo de nuevo.")}finally{_(!1)}})()},[]),r.useEffect(()=>{!y&&o&&ae(o.items.length===0)},[o,y]);const ne=r.useCallback(async s=>{if(h)return;f(s);const t=o?.items.find(a=>a.id===s);if(t)try{const a=N(t.product),n=t.quantity+1;if(!Z(t.product,n)){T(a,n),f(null);return}if(M(),!await E({itemId:s,quantity:n}))throw new Error("No se pudo actualizar la cantidad");x()}catch(a){if(console.error("Error al aumentar cantidad:",a),a?.response?.data?.message?.includes("stock")||a?.message?.includes("stock")||a?.response?.data?.message?.includes("insuficiente")){const n=N(t.product);T(n,t.quantity+1)}else i(a,"No se pudo actualizar la cantidad")}finally{f(null)}},[o?.items,h,E,M,x,b,N,Z,T,i]),ce=r.useCallback(async s=>{if(h)return;f(s);const t=o?.items.find(a=>a.id===s);if(t&&t.quantity>1)try{if(v(),!await E({itemId:s,quantity:t.quantity-1}))throw new Error("No se pudo actualizar la cantidad");x()}catch(a){console.error("Error al disminuir cantidad:",a),i(a,"No se pudo actualizar la cantidad")}finally{f(null)}},[o?.items,h,E,v,x,b,i]),ie=r.useCallback(async s=>{if(!h){f(s);try{const a=o?.items.find(p=>p.id===s)?.quantity||1;for(let p=0;p<a;p++)v();if(await D(s))x(),u("Producto eliminado del carrito");else throw new Error("No se pudo eliminar el producto")}catch(t){console.error("Error al eliminar del carrito:",t),i(t,"No se pudo eliminar el producto")}finally{f(null)}}},[h,D,x,v,o?.items,b,u,i]),de=r.useCallback(async(s,t)=>{if(!h){f(s);try{H();const n=o?.items.find(g=>g.id===s)?.quantity||1;for(let g=0;g<n;g++)v();if(await J(t),await D(s))x(),u("Producto movido a favoritos");else throw new Error("No se pudo mover el producto a favoritos")}catch(a){console.error("Error al mover a favoritos:",a),i(a,"No se pudo mover el producto a favoritos")}finally{f(null)}}},[h,J,D,H,v,x,o?.items,b,u,i]),me=r.useCallback(async()=>{if(!S.trim()){m(C.ERROR,"Por favor ingresa un código de cupón");return}O(!0);try{const s=await $(S);s.success?(u(s.message),R("")):m(C.ERROR,s.message)}catch(s){console.error("Error applying coupon:",s),m(C.ERROR,"Error inesperado al aplicar el cupón")}finally{O(!1)}},[S,$,u,m]),ue=r.useCallback(async()=>{try{const s=await G();s.success?(u(s.message),R("")):m(C.ERROR,s.message)}catch(s){console.error("Error removing coupon:",s),m(C.ERROR,"Error inesperado al remover el cupón")}},[G,u,m]),xe=r.useCallback(async()=>{if(!y)try{const s=o?.items.reduce((a,n)=>a+n.quantity,0)||0;for(let a=0;a<s;a++)v();if(await Q())x(),u("Carrito vaciado exitosamente");else throw new Error("No se pudo vaciar el carrito")}catch(s){console.error("Error al vaciar el carrito:",s),i(s,"No se pudo vaciar el carrito")}},[y,Q,x,v,o?.items,b,u,i]),pe=r.useCallback(()=>{if(w){m(C.ERROR,"No hay productos en el carrito");return}V("/checkout")},[w,V,m]),ge=Ce.memo(({item:s,onIncrease:t,onDecrease:a,onRemove:n,onMoveToWishlist:p,isLoading:g})=>{const d=s.discount,k=N(s.product),X=s.quantity>=k;return e.jsx("div",{className:"border-b border-gray-200 last:border-b-0",children:e.jsxs("div",{className:"grid sm:grid-cols-12 gap-4 p-5",children:[e.jsxs("div",{className:"sm:col-span-6 flex",children:[e.jsx(A,{to:`/products/${s.productId}`,className:"w-24 h-24 flex-shrink-0",children:e.jsx("img",{src:s.imageUrl,alt:s.product?.name||`Producto ${s.productId}`,className:"w-full h-full object-cover rounded"})}),e.jsxs("div",{className:"ml-4 flex flex-col",children:[e.jsx(A,{to:`/products/${s.productId}`,className:"font-medium text-lg mb-2 text-gray-800 hover:text-primary-600",children:s.product?.name||`Producto ${s.productId}`}),e.jsx("div",{className:"flex items-center space-x-2 mb-2",children:k>0?e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx("div",{className:"w-2 h-2 bg-green-500 rounded-full mr-1"}),e.jsxs("span",{className:"text-green-600",children:[k," en stock"]})]}):e.jsxs("div",{className:"flex items-center text-sm",children:[e.jsx(Y,{size:12,className:"text-red-500 mr-1"}),e.jsx("span",{className:"text-red-600",children:"Agotado"})]})}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-2",children:[d.sellerDiscountAmount>0&&e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded flex items-center",children:[e.jsx(ee,{size:12,className:"mr-1"}),"Seller: ",s.product?.discount_percentage||0,"% OFF"]}),d.volumeDiscountAmount>0&&e.jsxs("span",{className:"text-xs bg-green-100 text-green-600 px-2 py-1 rounded flex items-center",children:[e.jsx(q,{size:12,className:"mr-1"}),"Volumen: ",d.discountPercentage,"% OFF adicional"]})]}),d.hasDiscount&&e.jsxs("div",{className:"text-xs text-green-600 mb-2",children:["Ahorras: ",c(d.savingsTotal)]}),e.jsxs("div",{className:"mt-auto flex space-x-3 text-sm pt-3",children:[e.jsxs("button",{onClick:n,disabled:g,className:"text-gray-500 hover:text-red-500 flex items-center disabled:opacity-50",children:[e.jsx(se,{size:14,className:"mr-1"}),"Eliminar"]}),e.jsxs("button",{onClick:p,disabled:g,className:"text-gray-500 hover:text-primary-600 flex items-center disabled:opacity-50",children:[e.jsx(he,{size:14,className:"mr-1"}),"Guardar"]})]})]})]}),e.jsxs("div",{className:"sm:col-span-2 flex items-center justify-center sm:justify-center",children:[e.jsx("div",{className:"sm:hidden mr-2 font-medium text-gray-800",children:"Precio:"}),e.jsxs("div",{className:"font-medium flex flex-col items-center",children:[e.jsx("span",{className:"text-gray-800",children:c(d.finalPricePerUnit)}),d.hasDiscount&&e.jsx("span",{className:"text-xs text-gray-500 line-through",children:c(d.originalPrice)})]})]}),e.jsxs("div",{className:"sm:col-span-2 flex items-center justify-center",children:[e.jsx("div",{className:"sm:hidden mr-2 font-medium text-gray-800",children:"Cantidad:"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsxs("div",{className:"flex items-center border border-gray-300 rounded-md",children:[e.jsx("button",{onClick:a,disabled:s.quantity<=1||g,className:"px-2 py-1 text-gray-600 hover:text-gray-800 disabled:opacity-50",children:e.jsx(fe,{size:14})}),e.jsx("span",{className:"px-3 py-1 text-gray-800 text-center w-10",children:g?e.jsx("span",{className:"inline-block h-4 w-4 border-2 border-t-primary-600 border-r-primary-600 border-b-primary-200 border-l-primary-200 rounded-full animate-spin"}):s.quantity}),e.jsx("button",{onClick:t,disabled:g||X||k===0,className:"px-2 py-1 text-gray-600 hover:text-gray-800 disabled:opacity-50",children:e.jsx(ve,{size:14})})]}),X&&k>0&&e.jsxs("div",{className:"text-xs text-amber-600 mt-1 flex items-center",children:[e.jsx(Y,{size:10,className:"mr-1"}),"Límite de stock"]})]})]}),e.jsxs("div",{className:"sm:col-span-2 flex items-center justify-center sm:justify-center",children:[e.jsx("div",{className:"sm:hidden mr-2 font-medium text-gray-800",children:"Total:"}),e.jsxs("div",{className:"flex flex-col items-center",children:[e.jsx("span",{className:"font-bold text-gray-800",children:c(d.finalPricePerUnit*s.quantity)}),d.hasDiscount&&e.jsxs("span",{className:"text-xs text-green-600",children:["(-",c(d.savingsTotal),")"]})]})]})]})})});return e.jsxs("div",{className:"container mx-auto px-4 lg:px-8 py-10",children:[e.jsx("h1",{className:"text-3xl font-bold mb-8",children:"Mi Carrito"}),te||le?e.jsx("div",{className:"flex justify-center items-center h-64",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600"})}):w?e.jsxs("div",{className:"text-center py-20 bg-gray-50 rounded-lg",children:[e.jsx(be,{className:"mx-auto h-16 w-16 text-gray-300 mb-6"}),e.jsx("h2",{className:"text-2xl font-semibold text-gray-700 mb-3",children:"Tu carrito está vacío"}),e.jsx("p",{className:"text-gray-500 mb-8 max-w-md mx-auto",children:"Añade productos a tu carrito para continuar comprando."}),e.jsx(A,{to:"/products",className:"inline-flex items-center justify-center px-6 py-3 border border-transparent text-base font-medium rounded-md text-white bg-primary-600 hover:bg-primary-700",children:"Explorar productos"})]}):e.jsxs("div",{className:"flex flex-col lg:flex-row gap-8",children:[e.jsxs("div",{className:"lg:w-2/3",children:[l.totalSavings>0&&e.jsx("div",{className:"bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(q,{size:20,className:"text-green-600 mr-3"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-medium text-green-800",children:"¡Descuentos Aplicados!"}),e.jsxs("div",{className:"text-sm text-green-600 mt-1 space-y-1",children:[l.totalSellerSavings>0&&e.jsxs("p",{children:["Descuentos del vendedor: ",c(l.totalSellerSavings)]}),l.totalVolumeSavings>0&&e.jsxs("p",{children:["Descuentos por volumen: ",c(l.totalVolumeSavings)]})]})]}),e.jsx("div",{className:"text-2xl font-bold text-green-600",children:c(l.totalSavings)})]})}),e.jsxs("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden mb-6",children:[e.jsxs("div",{className:"hidden sm:grid sm:grid-cols-12 gap-4 p-5 bg-gray-50 border-b",children:[e.jsx("div",{className:"sm:col-span-6",children:e.jsx("span",{className:"font-medium text-gray-800",children:"Producto"})}),e.jsx("div",{className:"sm:col-span-2 text-center",children:e.jsx("span",{className:"font-medium text-gray-800",children:"Precio"})}),e.jsx("div",{className:"sm:col-span-2 text-center",children:e.jsx("span",{className:"font-medium text-gray-800",children:"Cantidad"})}),e.jsx("div",{className:"sm:col-span-2 text-center",children:e.jsx("span",{className:"font-medium text-gray-800",children:"Total"})})]}),oe.map(s=>e.jsx(ge,{item:s,onIncrease:()=>ne(s.id),onDecrease:()=>ce(s.id),onRemove:()=>ie(s.id),onMoveToWishlist:()=>de(s.id,s.productId),isLoading:h===s.id},s.id)),e.jsxs("div",{className:"flex justify-between items-center p-5 bg-gray-50",children:[e.jsx("button",{onClick:xe,disabled:w||y,className:"px-4 py-2 text-red-600 border border-red-200 rounded-lg hover:bg-red-50 transition-colors disabled:opacity-50",children:"Vaciar carrito"}),e.jsxs("div",{className:"text-sm text-gray-600",children:[W," ",W===1?"producto":"productos"," en el carrito"]})]})]}),e.jsx("div",{children:e.jsxs(A,{to:"/products",className:"inline-flex items-center text-primary-600 hover:text-primary-700",children:[e.jsx(ye,{size:18,className:"mr-2"}),"Continuar comprando"]})})]}),e.jsx("div",{className:"lg:w-1/3",children:e.jsx("div",{className:"bg-white rounded-lg shadow-lg overflow-hidden",children:e.jsxs("div",{className:"p-6",children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"Resumen del pedido"}),e.jsxs("div",{className:"mb-4 pb-4 border-b border-gray-200",children:[e.jsxs("label",{htmlFor:"coupon",className:"flex items-center text-sm font-medium text-gray-700 mb-2",children:[e.jsx(je,{size:16,className:"mr-2"})," ¿Tienes un cupón?"]}),e.jsxs("div",{className:"flex",children:[e.jsx("input",{type:"text",id:"coupon",value:S,onChange:s=>R(s.target.value),placeholder:"Código de cupón",disabled:!!j,className:"flex-grow p-2 border border-gray-300 rounded-l-md focus:ring-primary-500 focus:border-primary-500 disabled:bg-gray-100"}),e.jsx("button",{onClick:me,disabled:!S||!!j||F,className:"px-4 py-2 bg-gray-800 text-white font-semibold rounded-r-md hover:bg-gray-900 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2",children:F?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"w-4 h-4 border-2 border-white border-t-transparent rounded-full animate-spin"}),"Aplicando..."]}):"Aplicar"})]})]}),e.jsxs("div",{className:"space-y-4 pt-4",children:[e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal (con descuentos)"}),e.jsx("span",{className:"font-medium",children:c(l.subtotal)})]}),l.totalSellerSavings>0&&e.jsxs("div",{className:"flex justify-between text-blue-600",children:[e.jsxs("span",{className:"flex items-center text-sm",children:[e.jsx(ee,{size:16,className:"mr-1"}),"Descuentos del vendedor"]}),e.jsxs("span",{className:"font-medium",children:["-",c(l.totalSellerSavings)]})]}),l.totalVolumeSavings>0&&e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsxs("span",{className:"flex items-center text-sm",children:[e.jsx(q,{size:16,className:"mr-1"}),"Descuentos por volumen"]}),e.jsxs("span",{className:"font-medium",children:["-",c(l.totalVolumeSavings)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"Envío:"}),e.jsx("span",{className:"font-medium",children:l.shipping===0?"Gratis":c(l.shipping)})]}),j&&e.jsxs("div",{className:"flex justify-between text-green-600",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("span",{children:["Descuento de cupón (",j.discountCode.discount_percentage,"%)"]}),e.jsx("button",{onClick:ue,className:"text-gray-400 hover:text-red-500 transition-colors text-sm",title:"Remover cupón",children:e.jsx(se,{className:"w-4 h-4"})})]}),e.jsxs("span",{children:["-",c(l.couponAmount)]})]}),e.jsxs("div",{className:"flex justify-between",children:[e.jsx("span",{className:"text-gray-600",children:"IVA (15%)"}),e.jsx("span",{className:"font-medium",children:c(l.tax)})]}),e.jsxs("div",{className:"flex justify-between border-t border-gray-200 pt-4",children:[e.jsx("span",{className:"text-xl font-bold",children:"Total"}),e.jsx("span",{className:"text-xl font-bold",children:c(l.total)})]}),l.totalSavings>0&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Total ahorrado:"}),e.jsx("span",{className:"text-lg font-bold text-green-600",children:c(l.totalSavings)})]})})]}),e.jsx("button",{onClick:pe,disabled:w||y,className:"mt-8 w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-4 rounded-md transition-colors disabled:opacity-50",children:"Proceder al pago"}),e.jsxs("div",{className:"mt-4 text-xs text-gray-500",children:[e.jsx("p",{children:"Los impuestos y gastos de envío se calculan durante el proceso de pago."}),e.jsx("p",{className:"mt-1",children:"Aceptamos diversas formas de pago, incluyendo tarjetas de crédito, transferencias bancarias y pago contra entrega."}),l.totalSavings>0&&e.jsx("p",{className:"mt-2 text-green-600 font-medium",children:"¡Tienes descuentos aplicados en tu carrito!"})]})]})})})]}),U&&e.jsxs("div",{className:"mt-4 p-4 bg-red-50 text-red-700 rounded-lg",children:[e.jsxs("p",{className:"font-medium",children:["Error: ",U]}),e.jsx("button",{onClick:()=>b(),className:"underline text-sm mt-1",children:"Reintentar cargar el carrito"})]})]})};export{$e as default};
//# sourceMappingURL=CartPage-tvcm9lxT.js.map
