import{j as e,X as A,T,P as E,i as S,e as B,f as V,S as O,g as U}from"./ui-vendor-DEBjJ4HS.js";import{r as n,L as F}from"./react-vendor-Cy458wKG.js";import{S as H}from"./StarRating-wHilpPP8.js";import{u as Q}from"./useRatings-DjQ76P-h.js";import{f as X}from"./seller-chunk-B6Pjm2KH.js";import{i as z}from"./admin-chunk-bhOJ3jtA.js";import"./RatingService-_ICai5Hc.js";import"./utils-vendor-DeGC_a19.js";class G{static adaptPendingRatings(x){if(!x||!x.data)return[];const{products:b,sellers:u}=x.data,o=new Map;return(b||[]).forEach(r=>{const a=r.order_id;o.has(a)||o.set(a,{orderId:a,orderNumber:r.order_number,orderDate:r.order_date,products:[],sellers:[]});const p={...r,productId:r.id,seller_id:r.seller_id||r.sellerId};o.get(a)?.products.push(p)}),console.log("🔍 DEBUG: Sellers raw data:",u),(u||[]).forEach((r,a)=>{console.log(`🔍 DEBUG: Seller ${a}:`,r);const p=r.order_id;o.has(p)||o.set(p,{orderId:p,orderNumber:r.order_number,orderDate:r.date,products:[],sellers:[]});const l={id:r.id||r.seller_id,name:r.name||`Vendedor #${r.seller_id}`,order_id:r.order_id,order_number:r.order_number,order_date:r.date,image:r.image,seller_id:r.seller_id,productId:r.product_id||r.productId||r.pivot?.product_id};console.log("🔍 DEBUG: Adapted seller:",l),o.get(p)?.sellers.push(l)}),Array.from(o.values()).sort((r,a)=>new Date(a.orderDate).getTime()-new Date(r.orderDate).getTime())}}const J=({type:d,entityId:x,entityName:b,entityImage:u,orderId:o,isOpen:r,onClose:a,onSubmit:p,onReport:l})=>{const[m,_]=n.useState(0),[j,I]=n.useState(""),[C,$]=n.useState(""),[g,v]=n.useState(!1),[c,P]=n.useState(!1),[N,k]=n.useState(""),[f,D]=n.useState(""),[y,w]=n.useState(!1);if(!r)return null;const R=()=>{_(0),I(""),$(""),P(!1),k(""),D(""),w(!1)},s=()=>{R(),a()},t=async()=>{if(m===0){alert("Por favor selecciona una calificación de 1 a 5 estrellas");return}if(m<=2&&!y){w(!0);return}try{v(!0),await p({rating:m,title:j.trim()||void 0,comment:C.trim()||void 0,entityId:x,orderId:o}),R(),a()}catch(i){console.error("Error al enviar valoración:",i)}finally{v(!1)}},h=async()=>{if(l){if(!N){alert("Por favor selecciona el tipo de problema");return}if(!f.trim()){alert("Por favor describe el problema");return}try{v(!0),await l({type:d,entityId:x,orderId:o,problemType:N,description:f}),R(),a()}catch(i){console.error("Error al enviar reporte:",i)}finally{v(!1)}}},q=()=>{P(!c),w(!1)};return console.log("Estado actual de rating:",m),e.jsxs("div",{className:"fixed inset-0 z-50 overflow-y-auto",children:[e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 transition-opacity",onClick:s}),e.jsx("div",{className:"flex min-h-screen items-center justify-center p-4",children:e.jsxs("div",{className:"relative bg-white rounded-lg shadow-xl w-full max-w-md mx-auto",children:[e.jsx("button",{onClick:s,className:"absolute top-3 right-3 text-gray-400 hover:text-gray-500",disabled:g,children:e.jsx(A,{size:24})}),e.jsx("div",{className:"px-6 py-4 border-b border-gray-200",children:e.jsx("h3",{className:"text-lg font-medium text-gray-900 flex items-center",children:c?e.jsxs(e.Fragment,{children:[e.jsx(T,{className:"mr-2 text-orange-500",size:20}),"Reportar problema"]}):e.jsxs(e.Fragment,{children:[d==="product"?e.jsx(E,{className:"mr-2 text-blue-500",size:20}):e.jsx(S,{className:"mr-2 text-green-500",size:20}),"Valorar ",d==="product"?"producto":"vendedor"]})})}),e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("div",{className:"flex items-center mb-4",children:[e.jsx("div",{className:"w-16 h-16 bg-gray-200 rounded-md flex items-center justify-center mr-4 relative",children:u?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:u,alt:b,className:"w-16 h-16 object-cover rounded-md",onError:i=>{const M=i.target;M.style.display="none";const L=M.parentElement;L&&L.querySelector(".fallback-icon")?.classList.remove("hidden")}}),d==="product"?e.jsx(E,{size:24,className:"text-gray-400 fallback-icon hidden absolute"}):e.jsx(S,{size:24,className:"text-gray-400 fallback-icon hidden absolute"})]}):e.jsx(e.Fragment,{children:d==="product"?e.jsx(E,{size:24,className:"text-gray-400"}):e.jsx(S,{size:24,className:"text-gray-400"})})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-gray-900",children:b}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Pedido: #",o]})]})]}),!c&&!y&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Tu valoración"}),e.jsx(H,{value:m,onChange:i=>{console.log("Valor de StarRating seleccionado:",i),_(i)},size:"large",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"rating-title",className:"block text-sm font-medium text-gray-700 mb-1",children:"Título (opcional)"}),e.jsx("input",{id:"rating-title",type:"text",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500",placeholder:"Resume tu experiencia",value:j,onChange:i=>I(i.target.value),maxLength:100})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"rating-comment",className:"block text-sm font-medium text-gray-700 mb-1",children:"Comentario (opcional)"}),e.jsx("textarea",{id:"rating-comment",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500",placeholder:"Comparte tu experiencia con este producto",value:C,onChange:i=>$(i.target.value),maxLength:500,rows:4})]})]}),c&&!y&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{htmlFor:"problem-type",className:"block text-sm font-medium text-gray-700 mb-1",children:"Tipo de problema"}),e.jsxs("select",{id:"problem-type",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500 bg-white",value:N,onChange:i=>k(i.target.value),required:!0,children:[e.jsx("option",{value:"",children:"Selecciona el tipo de problema"}),d==="product"?e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"not_received",children:"Producto no recibido"}),e.jsx("option",{value:"damaged",children:"Producto dañado/defectuoso"}),e.jsx("option",{value:"different",children:"Producto diferente al descrito"}),e.jsx("option",{value:"incomplete",children:"Producto incompleto"})]}):e.jsxs(e.Fragment,{children:[e.jsx("option",{value:"communication",children:"Problemas de comunicación"}),e.jsx("option",{value:"shipping",children:"Problemas de envío"}),e.jsx("option",{value:"customer_service",children:"Mala atención al cliente"})]}),e.jsx("option",{value:"other",children:"Otro problema"})]})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:"problem-description",className:"block text-sm font-medium text-gray-700 mb-1",children:"Descripción del problema"}),e.jsx("textarea",{id:"problem-description",className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-primary-500 focus:border-primary-500",placeholder:"Describe el problema en detalle",value:f,onChange:i=>D(i.target.value),rows:4,required:!0})]})]}),y&&e.jsx("div",{className:"bg-yellow-50 p-4 rounded-md",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(T,{className:"text-yellow-600 mt-0.5 mr-3",size:20}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-yellow-800",children:"¿Estás seguro de enviar una valoración baja?"}),e.jsxs("p",{className:"text-sm text-yellow-700 mt-1",children:["Has calificado este"," ",d==="product"?"producto":"vendedor"," con"," ",m," ",m===1?"estrella":"estrellas",". ¿Quieres continuar o prefieres reportar un problema específico?"]})]})]})})]}),e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200 flex justify-between",children:[e.jsx("div",{children:!y&&e.jsx("button",{type:"button",onClick:q,className:"text-sm text-gray-600 hover:text-gray-800 flex items-center",disabled:g,children:c?e.jsx(e.Fragment,{children:"Volver a valoración"}):e.jsxs(e.Fragment,{children:[e.jsx(T,{size:14,className:"mr-1"}),"Reportar problema"]})})}),e.jsxs("div",{className:"space-x-3",children:[e.jsx("button",{type:"button",onClick:s,className:"px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300",disabled:g,children:"Cancelar"}),y?e.jsxs(e.Fragment,{children:[e.jsx("button",{type:"button",onClick:()=>w(!1),className:"px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600 focus:outline-none focus:ring-2 focus:ring-yellow-500",disabled:g,children:"Modificar valoración"}),e.jsx("button",{type:"button",onClick:t,className:"px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500",disabled:g,children:g?"Enviando...":"Enviar valoración"})]}):e.jsx("button",{type:"button",onClick:c?h:t,className:`px-4 py-2 text-white rounded-lg focus:outline-none focus:ring-2 ${c?"bg-orange-600 hover:bg-orange-700 focus:ring-orange-500":"bg-blue-600 hover:bg-blue-700 focus:ring-blue-500"}`,disabled:g||c&&(!N||!f.trim())||!c&&m===0,children:g?"Enviando...":c?"Enviar reporte":"Enviar valoración"})]})]})]})})]})},K=({orderGroups:d,onRateProduct:x,onRateSeller:b})=>{const u=o=>{const r=o.currentTarget;r.style.display="none";const a=r.parentElement;a&&a.querySelector(".fallback-icon")?.classList.remove("hidden")};return e.jsx("div",{className:"space-y-6",children:d.map(o=>e.jsxs("div",{className:"bg-white rounded-lg shadow-sm overflow-hidden",children:[e.jsx("div",{className:"bg-gray-50 px-6 py-4 border-b border-gray-200",children:e.jsxs("div",{className:"flex flex-col md:flex-row md:justify-between md:items-center",children:[e.jsxs("div",{children:[e.jsxs("h3",{className:"text-lg font-medium text-gray-900",children:["Pedido #",o.orderNumber]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["Fecha: ",X(o.orderDate)]})]}),e.jsxs(F,{to:`/orders/${o.orderId}`,className:"text-primary-600 hover:text-primary-800 flex items-center mt-2 md:mt-0",children:[e.jsx(B,{className:"w-4 h-4 mr-1"}),"Ver detalles del pedido"]})]})}),o.products.length>0&&e.jsxs("div",{className:"px-6 py-4",children:[e.jsxs("h4",{className:"text-md font-medium text-gray-900 mb-3 flex items-center",children:[e.jsx(E,{className:"w-5 h-5 mr-2 text-primary-600"}),"Productos"]}),e.jsx("div",{className:"space-y-4",children:o.products.map((r,a)=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center p-3 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center flex-grow mb-3 sm:mb-0",children:[e.jsx("div",{className:"w-16 h-16 rounded-md mr-4 relative bg-gray-100 flex items-center justify-center",children:r.image?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:r.image,alt:r.name||"Producto",className:"w-16 h-16 object-cover rounded-md",onError:u}),e.jsx(E,{className:"h-8 w-8 text-gray-400 fallback-icon hidden absolute"})]}):e.jsx(E,{className:"h-8 w-8 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium text-gray-900",children:r.name||`Producto #${r.id||r.productId}`}),e.jsx(F,{to:`/products/${r.id||r.productId}`,className:"text-sm text-primary-600 hover:text-primary-800",children:"Ver producto"})]})]}),e.jsx("div",{children:e.jsxs("button",{onClick:()=>x(r),className:"w-full sm:w-auto px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 flex items-center justify-center transition-colors",children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Valorar producto"]})})]},`product-${r.id||r.productId}-order-${o.orderId}-${a}-${r.order_id||""}`))})]}),o.sellers.length>0&&e.jsxs("div",{className:"px-6 py-4 border-t border-gray-200",children:[e.jsxs("h4",{className:"text-md font-medium text-gray-900 mb-3 flex items-center",children:[e.jsx(S,{className:"w-5 h-5 mr-2 text-green-600"}),"Vendedores"]}),e.jsx("div",{className:"space-y-4",children:o.sellers.map((r,a)=>e.jsxs("div",{className:"flex flex-col sm:flex-row sm:items-center p-3 border border-gray-200 rounded-lg",children:[e.jsxs("div",{className:"flex items-center flex-grow mb-3 sm:mb-0",children:[e.jsx("div",{className:"w-16 h-16 rounded-md mr-4 relative bg-gray-100 flex items-center justify-center",children:r.image?e.jsxs(e.Fragment,{children:[e.jsx("img",{src:r.image,alt:r.name||"Tienda",className:"w-16 h-16 object-cover rounded-md",onError:u}),e.jsx(S,{className:"h-8 w-8 text-gray-400 fallback-icon hidden absolute"})]}):e.jsx(S,{className:"h-8 w-8 text-gray-400"})}),e.jsxs("div",{children:[e.jsx("h5",{className:"font-medium text-gray-900",children:r.name||`Vendedor #${r.seller_id||r.id}`}),e.jsxs("span",{className:"text-sm text-gray-500",children:["Tienda",r.productId&&e.jsxs("span",{className:"ml-2 text-xs bg-gray-100 px-2 py-1 rounded",children:["Producto #",r.productId]})]})]})]}),e.jsx("div",{children:e.jsxs("button",{onClick:()=>b(r),className:"w-full sm:w-auto px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 flex items-center justify-center transition-colors",children:[e.jsx(V,{className:"h-4 w-4 mr-2"}),"Valorar vendedor"]})})]},`seller-${r.id||r.seller_id}-order-${o.orderId}-${a}-${r.productId||""}`))})]})]},`order-${o.orderId}`))})},oe=()=>{const[d,x]=n.useState(""),[b,u]=n.useState(!1),[o,r]=n.useState(!1),[a,p]=n.useState("product"),[l,m]=n.useState(null),{loading:_,error:j,getPendingRatings:I,rateProduct:C,rateSeller:$,reportProblem:g}=Q(),[v,c]=n.useState([]),P=n.useRef(!1);n.useEffect(()=>{P.current||(P.current=!0,(async()=>{try{const t=await I();if(t.status!=="success")throw new Error("Error al obtener las valoraciones pendientes");const h=G.adaptPendingRatings(t);c(h)}catch(t){console.error("Error al cargar valoraciones pendientes:",t)}})())},[]);const N=n.useCallback(async()=>{try{const s=await I();if(s.status!=="success")throw new Error("Error al obtener las valoraciones pendientes");const t=G.adaptPendingRatings(s);c(t)}catch(s){console.error("Error al cargar valoraciones pendientes:",s)}},[I]),k=(s,t)=>{console.log(`💱 Abriendo modal de ${s}:`,{id:t.id,productId:t.productId,seller_id:t.seller_id,name:t.name,order_id:t.order_id}),p(s),m(t),r(!0)},f=()=>{r(!1),m(null)},D=async s=>{console.log(`📨 Enviando valoración de ${a}:`,{modalType:a,entityId:s.entityId,orderId:s.orderId,rating:s.rating,title:s.title,comment:s.comment});try{if(a==="product")console.log(`📦 Llamando rateProduct con product_id: ${s.entityId}`),await C({product_id:s.entityId,order_id:s.orderId,rating:s.rating,title:s.title,comment:s.comment});else{const t=l?.productId;if(!t)throw new Error("No se puede calificar al vendedor: falta el ID del producto asociado");console.log(`🏦 Llamando rateSeller con seller_id: ${s.entityId}, product_id: ${t}`);const h={seller_id:s.entityId,order_id:s.orderId,rating:s.rating,title:s.title,comment:s.comment,product_id:t};console.log("📨 Datos finales para rateSeller:",h),await $(h)}await N(),alert("Valoración enviada con éxito"),f()}catch(t){console.error("Error al enviar valoración:",t),alert(z(t,"Error al enviar la valoración"))}},y=async s=>{try{await g({type:s.type,entity_id:s.entityId,order_id:s.orderId,problem_type:s.problemType,description:s.description}),await N(),alert("Problema reportado con éxito"),f()}catch(t){console.error("Error al reportar problema:",t),alert(z(t,"Error al reportar el problema"))}},w=v.filter(s=>{if(d==="")return!0;const t=d.toLowerCase();return!!(s.orderNumber.toLowerCase().includes(t)||s.products.some(h=>h.name.toLowerCase().includes(t))||s.sellers.some(h=>(h.name||"").toLowerCase().includes(t)))}),R=v.some(s=>s.products.length>0||s.sellers.length>0);return e.jsxs("div",{className:"container mx-auto p-4 px-10",children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Valoraciones pendientes"}),e.jsxs("div",{className:"flex flex-col md:flex-row gap-4 mb-6",children:[e.jsxs("div",{className:"relative flex-grow",children:[e.jsx("input",{type:"text",placeholder:"Buscar por pedido o producto...",className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-primary-500 focus:border-primary-500",value:d,onChange:s=>x(s.target.value)}),e.jsx(O,{className:"absolute left-3 top-2.5 h-5 w-5 text-gray-400"})]}),e.jsx("div",{className:"flex items-center",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 text-primary-600",checked:b,onChange:s=>u(s.target.checked)}),e.jsx("span",{className:"ml-2 text-gray-700",children:"Mostrar también valorados"})]})})]}),_&&e.jsx("div",{className:"flex justify-center my-12",children:e.jsx("div",{className:"animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-600"})}),j&&e.jsxs("div",{className:"bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative mb-6",children:[e.jsx("strong",{className:"font-bold",children:"Error: "}),e.jsx("span",{className:"block sm:inline",children:j})]}),!_&&!j&&!R&&e.jsxs("div",{className:"bg-white rounded-lg shadow-sm p-8 text-center",children:[e.jsx(U,{className:"mx-auto h-12 w-12 text-gray-400 mb-4"}),e.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-2",children:"No tienes valoraciones pendientes"}),e.jsx("p",{className:"text-gray-600 max-w-md mx-auto",children:"Todas tus compras recientes han sido valoradas. ¡Gracias por compartir tu opinión!"}),e.jsx(F,{to:"/orders",className:"mt-4 inline-block px-4 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700",children:"Ver mis pedidos"})]}),!_&&!j&&w.length>0&&e.jsx(K,{orderGroups:w,onRateProduct:s=>k("product",s),onRateSeller:s=>k("seller",s)}),l&&e.jsx(J,{type:a,entityId:(()=>{const s=a==="product"?l.productId||l.id||0:l.seller_id||l.id||0;return console.log(`🎭 Modal recibirá entityId para ${a}:`,{calculatedId:s,selectedEntity_id:l.id,selectedEntity_productId:l.productId,selectedEntity_seller_id:l.seller_id}),s})(),entityName:l.name||`${a==="product"?"Producto":"Vendedor"} #${a==="product"?l.productId||l.id:l.seller_id||l.id}`,entityImage:l.image,orderId:l.order_id,isOpen:o,onClose:f,onSubmit:D,onReport:y})]})};export{oe as default};
//# sourceMappingURL=PendingRatingsPage-DcL0RX9_.js.map
