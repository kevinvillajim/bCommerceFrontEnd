import{c as B,A as X,g as Ue,C as ae,b as ue,N as k,h as je,i as de,f as q}from"./admin-chunk-bhOJ3jtA.js";import{j as e,D as Le,ah as Fe,H as he,a as De,e as Ie,N as Ve,ai as Me,aj as qe,ak as Be,al as Ge,R as me,am as He,an as ge,T as We,a3 as Ee}from"./ui-vendor-DEBjJ4HS.js";import{r as m,R as te,u as Ae}from"./react-vendor-Cy458wKG.js";import{A as ze,L as Je}from"./seller-chunk-B6Pjm2KH.js";import{u as ye}from"./chat-chunk-C3LrqA3R.js";class Qe{async getCart(){try{console.log("CartService: Obteniendo carrito del usuario");const t=await B.get(X.CART.GET);return console.log("CartService: Respuesta del carrito:",t),t}catch(t){return console.error("CartService: Error al obtener carrito:",t),{status:"error",message:t instanceof Error?t.message:"Error al obtener carrito",data:{id:0,total:0,items:[],item_count:0}}}}async addToCart(t){try{console.log("CartService: AÃ±adiendo producto al carrito:",t);const o={product_id:t.productId,quantity:t.quantity,attributes:t.attributes},a=await B.post(X.CART.ADD_ITEM,o);return console.log("CartService: Producto aÃ±adido al carrito:",a),a}catch(o){throw console.error("CartService: Error al aÃ±adir al carrito:",o),o}}async removeFromCart(t){try{console.log(`CartService: Eliminando producto ${t} del carrito`);const o=await B.delete(X.CART.REMOVE_ITEM(t));return console.log(`CartService: Producto ${t} eliminado del carrito:`,o),o}catch(o){throw console.error(`CartService: Error al eliminar producto ${t} del carrito:`,o),o}}async updateCartItem(t,o){try{console.log(`CartService: Actualizando cantidad de producto ${t} a ${o}`);const a=await B.put(X.CART.UPDATE_ITEM(t),{quantity:o});return console.log(`CartService: Cantidad actualizada para producto ${t}:`,a),a}catch(a){throw console.error(`CartService: Error al actualizar cantidad de producto ${t}:`,a),a}}async clearCart(){try{console.log("CartService: Vaciando carrito");const t=await B.post(X.CART.EMPTY);return console.log("CartService: Carrito vaciado:",t),t}catch(t){throw console.error("CartService: Error al vaciar carrito:",t),t}}async validateDiscountCode(t){try{console.log("CartService: Validando cÃ³digo de descuento:",t);const o=await B.post(X.CART.DISCOUNT.VALIDATE,{code:t});return console.log("CartService: CÃ³digo de descuento validado:",o),o}catch(o){throw console.error("CartService: Error al validar cÃ³digo de descuento:",o),o}}async applyDiscountCode(t){try{console.log("CartService: Aplicando cÃ³digo de descuento:",t);const o=await B.post(X.CART.DISCOUNT.APPLY,{code:t});return console.log("CartService: CÃ³digo de descuento aplicado:",o),o}catch(o){throw console.error("CartService: Error al aplicar cÃ³digo de descuento:",o),o}}async removeDiscountCode(){try{console.log("CartService: Removiendo cÃ³digo de descuento");const t=await B.post(X.CART.DISCOUNT.REMOVE);return console.log("CartService: CÃ³digo de descuento removido:",t),t}catch(t){throw console.error("CartService: Error al remover cÃ³digo de descuento:",t),t}}}const Re=m.createContext({cart:null,loading:!1,error:null,addToCart:async()=>!1,removeFromCart:async()=>!1,updateCartItem:async()=>!1,clearCart:async()=>!1,fetchCart:async()=>{},itemCount:0,totalAmount:0,showNotification:()=>{},cartItemCount:0,appliedDiscount:null,validateDiscountCode:async()=>({success:!1,message:"Not implemented"}),applyDiscountCode:async()=>({success:!1,message:"Not implemented"}),removeDiscountCode:async()=>({success:!1,message:"Not implemented"})}),pe=new Je,ce=new Qe,fe={CART_USER:"cart_user_data",CART_GUEST:"cart_guest_data"},Ke={CART:3*60*1e3},ft=({children:g})=>{const[t,o]=m.useState(null),[a,s]=m.useState(!1),[r,c]=m.useState(null),[f,d]=m.useState(0),[C,j]=m.useState(0),[S,E]=m.useState(null),{isAuthenticated:R}=m.useContext(ze),{showToast:v}=Ue(),L=m.useRef(!1),I=m.useRef(""),U=m.useRef(R),T=m.useRef(null),z=m.useRef(!1),J=m.useRef(null);m.useEffect(()=>{U.current=R},[R]);const oe=m.useCallback((l,n)=>{v(l,n,{duration:3e3})},[v]);m.useEffect(()=>()=>{T.current&&clearTimeout(T.current),J.current&&clearTimeout(J.current)},[]);const y=m.useCallback(()=>{ae.removeItem(fe.CART_USER),ae.removeItem(fe.CART_GUEST),ae.removeItem("header_counters"),console.log("ðŸ—‘ï¸ Cart cache invalidated")},[]),H=m.useCallback(l=>!l||l.length===0?0:l.reduce((n,b)=>n+b.quantity,0),[]),Y=m.useCallback(async()=>{if(z.current)return null;z.current=!0;try{s(!0),c(null);const l=U.current?fe.CART_USER:fe.CART_GUEST,n=ae.getItem(l);if(n)return console.log("ðŸ“¦ Using cached cart data"),o(n),d(n.items?n.items.length:0),j(n.total||0),I.current=JSON.stringify(n),s(!1),z.current=!1,n;console.log("ðŸŒ Fetching cart from API...");const b=await ce.getCart();if(b&&b.status==="success"&&b.data){const w={id:b.data.id,total:b.data.total,items:b.data.items.map(V=>{if(!V.product)throw console.error("Item sin producto asociado:",V),new Error("Error en carrito: item sin producto vÃ¡lido");const h=V.product;if(!h.id||h.id<=0)throw console.error("Producto sin ID vÃ¡lido:",h),new Error("Error en carrito: producto sin ID vÃ¡lido");if(!h.name||h.name.trim()==="")throw console.error("Producto sin nombre:",h),new Error("Error en carrito: producto sin nombre");if(typeof h.price!="number"||h.price<=0)throw console.error("Producto sin precio vÃ¡lido:",h),new Error("Error en carrito: producto sin precio vÃ¡lido");const le=h.sellerId||h.seller_id||(h.seller?h.seller.id:void 0)||h.user_id;if(!le||le<=0)throw console.error("Producto sin seller vÃ¡lido:",h),new Error("Error en carrito: producto sin vendedor vÃ¡lido");return{id:V.id,productId:h.id,quantity:V.quantity,price:V.price,subtotal:V.subtotal,attributes:V.attributes,final_price:V.final_price||V.price,original_price:V.original_price||V.price,volume_discount_percentage:V.volume_discount_percentage||0,volume_savings:V.volume_savings||0,discount_label:V.discount_label||void 0,product:{id:h.id,name:h.name,slug:h.slug,price:h.price,final_price:h.final_price??h.price??0,discount_percentage:h.discount_percentage??0,rating:h.rating??0,rating_count:h.rating_count??0,image:h.main_image||h.image||(h.images&&h.images.length>0?typeof h.images[0]=="string"?h.images[0]:h.images[0].original||h.images[0].medium||h.images[0].thumbnail:void 0),main_image:h.main_image||h.image||(h.images&&h.images.length>0?typeof h.images[0]=="string"?h.images[0]:h.images[0].original||h.images[0].medium||h.images[0].thumbnail:void 0),stockAvailable:h.stock||0,sellerId:h.sellerId||h.seller_id||(h.seller?h.seller.id:void 0)||h.user_id,seller_id:h.seller_id||h.sellerId||(h.seller?h.seller.id:void 0)||h.user_id,seller:h.seller,user_id:h.user_id,stock:h.stock||0,is_in_stock:h.is_in_stock??!0}}}),item_count:b.data.item_count||0,subtotal:b.data.subtotal||b.data.total,total_volume_savings:b.data.total_volume_savings||0,volume_discounts_applied:b.data.volume_discounts_applied||!1};ae.setItem(l,w,Ke.CART);const M=H(w.items),W=b.data.item_count||M;return o(w),d(W),j(w.total),I.current=JSON.stringify(w),console.log("âœ… Cart loaded successfully:",{itemCount:W,total:w.total,items:w.items.length,volume_discounts_applied:w.volume_discounts_applied}),w}throw new Error("Formato de respuesta de carrito invÃ¡lido")}catch(l){console.error("Error al obtener carrito desde la API:",l),c(l instanceof Error?l.message:"Error al obtener carrito");const n=pe.getItem(ue.storage.cartKey);if(n)try{const b=typeof n=="string"?JSON.parse(n):n;o(b),I.current=JSON.stringify(b);const w=H(b.items||[]);d(w),j(b.total||0)}catch(b){console.error("Error al usar cachÃ© local del carrito:",b)}return null}finally{s(!1),z.current=!1}},[H]),F=m.useCallback(async()=>{T.current&&clearTimeout(T.current),T.current=setTimeout(async()=>{if(U.current)await Y();else{const l=pe.getItem(ue.storage.cartKey);if(l)try{const n=typeof l=="string"?JSON.parse(l):l;o(n),I.current=JSON.stringify(n);const b=H(n.items||[]);d(b),j(n.total||0)}catch(n){console.error("Error al parsear carrito del localStorage:",n)}else o({id:0,items:[],total:0}),d(0),j(0)}T.current=null},100)},[Y,H]);m.useEffect(()=>{L.current=!0},[R]),m.useEffect(()=>{if(!t){d(0),j(0);return}J.current&&clearTimeout(J.current),J.current=setTimeout(()=>{const l=t.items?t.items.length:0;f!==l&&d(l),C!==t.total&&j(t.total);const n=JSON.stringify(t);!U.current&&n!==I.current&&(pe.setItem(ue.storage.cartKey,n),I.current=n),J.current=null},100)},[t,H,f,C]);const K=m.useCallback(async l=>{try{if(!t)return!1;const n=t.items.findIndex(w=>w.productId===l.productId);let b;if(n>=0){const w=[...t.items];w[n].quantity+=l.quantity,w[n].subtotal=w[n].price*w[n].quantity;const M=w.reduce((W,V)=>W+V.subtotal,0);b={...t,items:w,total:M}}else{const M={id:Date.now(),productId:l.productId,quantity:l.quantity,price:0,subtotal:0*l.quantity},W=[...t.items,M],V=W.reduce((h,le)=>h+le.subtotal,0);b={...t,items:W,total:V}}return o(b),I.current=JSON.stringify(b),!0}catch(n){return console.error("Error al aÃ±adir producto al carrito:",n),!1}},[t]),re=m.useCallback(async l=>{if(!U.current){const n=await K(l);return await F(),n}try{s(!0);const n=await ce.addToCart(l);if(n&&n.status==="success")return y(),await F(),!0;throw new Error(n?.message||"No se pudo agregar al carrito")}catch(n){return console.error("Error al agregar producto al carrito:",n),c(n instanceof Error?n.message:"Error al agregar producto al carrito"),!1}finally{s(!1)}},[K,F,y]),ne=m.useCallback(async l=>{try{if(!t)return!1;const n=t.items.filter(M=>M.id!==l),b=n.reduce((M,W)=>M+W.subtotal,0),w={...t,items:n,total:b};return o(w),I.current=JSON.stringify(w),!0}catch(n){return console.error("Error al eliminar producto del carrito:",n),!1}},[t]),se=m.useCallback(async l=>{if(!U.current){const n=await ne(l);return await F(),n}try{s(!0);const n=await ce.removeFromCart(l);if(n&&n.status==="success")return y(),await F(),!0;throw new Error(n?.message||"No se pudo eliminar del carrito")}catch(n){return console.error("Error al eliminar producto del carrito:",n),c(n instanceof Error?n.message:"Error al eliminar producto del carrito"),!1}finally{s(!1)}},[ne,F,y]),x=m.useCallback(async l=>{try{if(!t)return!1;const n=t.items.map(M=>M.id===l.itemId?{...M,quantity:l.quantity,subtotal:M.price*l.quantity}:M),b=n.reduce((M,W)=>M+W.subtotal,0),w={...t,items:n,total:b};return o(w),I.current=JSON.stringify(w),!0}catch(n){return console.error("Error al actualizar producto del carrito:",n),!1}},[t]),N=m.useCallback(async l=>{if(!U.current){const n=await x(l);return await F(),n}try{s(!0);const n=await ce.updateCartItem(l.itemId,l.quantity);if(n&&n.status==="success")return y(),await F(),!0;throw new Error(n?.message||"No se pudo actualizar el carrito")}catch(n){return console.error("Error al actualizar producto del carrito:",n),c(n instanceof Error?n.message:"Error al actualizar producto del carrito"),!1}finally{s(!1)}},[x,F,y]),O=m.useCallback(async()=>{try{if(!t)return!1;const l={id:t.id,items:[],total:0};return o(l),I.current=JSON.stringify(l),pe.setItem(ue.storage.cartKey,JSON.stringify(l)),!0}catch(l){return console.error("Error al vaciar carrito:",l),!1}},[t]),G=m.useCallback(async()=>{if(!U.current){const l=await O();return await F(),l}try{s(!0);const l=await ce.clearCart();if(l&&l.status==="success")return y(),await F(),!0;throw new Error(l?.message||"No se pudo vaciar el carrito")}catch(l){return console.error("Error al vaciar carrito:",l),c(l instanceof Error?l.message:"Error al vaciar carrito"),!1}finally{s(!1)}},[O,F,y]),p=m.useCallback(async l=>{try{s(!0);const n=await ce.validateDiscountCode(l);return n&&n.status==="success"?{success:!0,message:n.message||"CÃ³digo vÃ¡lido",data:n.data}:{success:!1,message:n?.message||"CÃ³digo de descuento invÃ¡lido"}}catch(n){return console.error("Error validating discount code:",n),{success:!1,message:n.response?.data?.message||n.message||"Error al validar cÃ³digo de descuento"}}finally{s(!1)}},[]),i=m.useCallback(async l=>{try{s(!0);const n=await ce.applyDiscountCode(l);return n&&n.status==="success"?(n.data?.cart&&(o(n.data.cart),I.current=JSON.stringify(n.data.cart)),n.data?.discount_code&&E({discountCode:n.data.discount_code,appliedAt:new Date}),y(),{success:!0,message:n.message||"Descuento aplicado exitosamente",cart:n.data?.cart}):{success:!1,message:n?.message||"No se pudo aplicar el cÃ³digo de descuento"}}catch(n){return console.error("Error applying discount code:",n),{success:!1,message:n.response?.data?.message||n.message||"Error al aplicar cÃ³digo de descuento"}}finally{s(!1)}},[y]),A=m.useCallback(async()=>{try{s(!0);const l=await ce.removeDiscountCode();return l&&l.status==="success"?(l.data?.cart&&(o(l.data.cart),I.current=JSON.stringify(l.data.cart)),E(null),y(),{success:!0,message:l.message||"Descuento removido exitosamente",cart:l.data?.cart}):{success:!1,message:l?.message||"No se pudo remover el cÃ³digo de descuento"}}catch(l){return console.error("Error removing discount code:",l),{success:!1,message:l.response?.data?.message||l.message||"Error al remover cÃ³digo de descuento"}}finally{s(!1)}},[y]);return e.jsx(Re.Provider,{value:{cart:t,loading:a,error:r,addToCart:re,removeFromCart:se,updateCartItem:N,clearCart:G,fetchCart:F,itemCount:f,totalAmount:C,showNotification:oe,cartItemCount:f,appliedDiscount:S,validateDiscountCode:p,applyDiscountCode:i,removeDiscountCode:A},children:g})};class ie{static instance;subscribers=new Set;currentCounters={cartItemCount:0,favoriteCount:0,notificationCount:0};isLoading=!1;error=null;lastFetch=0;CACHE_KEY="header_counters";CACHE_TIME=2*60*1e3;MIN_FETCH_INTERVAL=30*1e3;static getInstance(){return ie.instance||(ie.instance=new ie),ie.instance}subscribe(t){return this.subscribers.add(t),t(this.currentCounters),()=>this.subscribers.delete(t)}notify(){this.subscribers.forEach(t=>t(this.currentCounters))}async fetchCounters(t=!1){const o=Date.now();if(!(!t&&o-this.lastFetch<this.MIN_FETCH_INTERVAL)){if(!t){const a=ae.getItem(this.CACHE_KEY);if(a){this.currentCounters=a,this.notify();return}}if(!this.isLoading){this.isLoading=!0,this.error=null,this.notify();try{const a=await B.get(X.HEADER_COUNTERS);let s=0,r=0,c=0;a?.data&&(s=a.data.cart_count||0,r=a.data.favorites_count||0,c=a.data.notifications_count||0),this.currentCounters={cartItemCount:s,favoriteCount:r,notificationCount:c},this.lastFetch=o,ae.setItem(this.CACHE_KEY,this.currentCounters,this.CACHE_TIME)}catch(a){this.error=a instanceof Error?a.message:"Error al cargar contadores",this.currentCounters={cartItemCount:0,favoriteCount:0,notificationCount:0}}finally{this.isLoading=!1,this.notify()}}}}invalidateCache(){ae.removeItem(this.CACHE_KEY),this.lastFetch=0}getState(){return{counters:this.currentCounters,loading:this.isLoading,error:this.error}}updateCounter(t,o){this.currentCounters={...this.currentCounters,[t]:Math.max(0,o)},ae.setItem(this.CACHE_KEY,this.currentCounters,this.CACHE_TIME),this.notify()}incrementCart(){this.updateCounter("cartItemCount",this.currentCounters.cartItemCount+1)}decrementCart(){this.updateCounter("cartItemCount",this.currentCounters.cartItemCount-1)}incrementFavorites(){this.updateCounter("favoriteCount",this.currentCounters.favoriteCount+1)}decrementFavorites(){this.updateCounter("favoriteCount",this.currentCounters.favoriteCount-1)}markNotificationAsRead(){this.updateCounter("notificationCount",this.currentCounters.notificationCount-1)}}const ht=()=>{const[g,t]=m.useState(()=>ie.getInstance().getState()),{isAuthenticated:o}=ye(),a=m.useRef(ie.getInstance());m.useEffect(()=>{if(!o){t({counters:{cartItemCount:0,favoriteCount:0,notificationCount:0},loading:!1,error:null});return}const r=a.current,c=r.subscribe(f=>{t({counters:f,loading:r.getState().loading,error:r.getState().error})});return r.fetchCounters(),c},[o]);const s=m.useCallback(async()=>{o&&await a.current.fetchCounters(!0)},[o]);return{counters:g.counters,loading:g.loading,error:g.error,refetch:s}},Ye=()=>{const g=m.useRef(ie.getInstance());return{invalidateCounters:()=>g.current.invalidateCache(),optimisticCartAdd:()=>g.current.incrementCart(),optimisticCartRemove:()=>g.current.decrementCart(),optimisticFavoriteAdd:()=>g.current.incrementFavorites(),optimisticFavoriteRemove:()=>g.current.decrementFavorites(),optimisticNotificationRead:()=>g.current.markNotificationAsRead(),forceRefresh:()=>g.current.fetchCounters(!0)}},Ce=()=>{const g=m.useContext(Re);if(!g)throw new Error("useCart debe usarse dentro de un CartProvider");return g};class Xe{static extractUserMessage(t){if(t?.response?.data){const o=t.response.data;if(o.message)return this.translateErrorMessage(o.message);if(o.errors&&Array.isArray(o.errors))return o.errors.map(a=>a.message||a).join(", ");if(o.error)return this.translateErrorMessage(o.error)}return t?.message?this.translateErrorMessage(t.message):typeof t=="string"?this.translateErrorMessage(t):t?.code==="NETWORK_ERROR"||t?.message?.includes("Network Error")?"Error de conexiÃ³n. Verifica tu conexiÃ³n a internet.":t?.code==="ECONNABORTED"||t?.message?.includes("timeout")?"La solicitud tardÃ³ demasiado. IntÃ©ntalo de nuevo.":"Ha ocurrido un error inesperado. IntÃ©ntalo de nuevo."}static translateErrorMessage(t){const o={"Stock insuficiente":"No hay suficiente stock disponible. Reduce la cantidad.","Insufficient stock":"No hay suficiente stock disponible. Reduce la cantidad.","Out of stock":"Producto agotado. No hay unidades disponibles.","No hay suficiente stock":"No hay suficiente stock disponible. Reduce la cantidad.","Producto agotado":"Producto agotado. No hay unidades disponibles.",Unauthorized:"Debes iniciar sesiÃ³n para realizar esta acciÃ³n.","Token expired":"Tu sesiÃ³n ha expirado. Inicia sesiÃ³n nuevamente.","Invalid credentials":"Credenciales incorrectas. Verifica tu email y contraseÃ±a.","Validation failed":"Los datos ingresados no son vÃ¡lidos.","Required field missing":"Faltan campos obligatorios.","Invalid email format":"El formato del email no es vÃ¡lido.","Password too weak":"La contraseÃ±a debe ser mÃ¡s segura.","Product not found":"El producto no fue encontrado.","Product unavailable":"El producto no estÃ¡ disponible temporalmente.","Price changed":"El precio del producto ha cambiado. Actualiza la pÃ¡gina.","Cart empty":"Tu carrito estÃ¡ vacÃ­o.","Cart item not found":"El producto no se encuentra en tu carrito.","Cannot update cart":"No se pudo actualizar el carrito. IntÃ©ntalo de nuevo.","Payment failed":"El pago no pudo ser procesado. Verifica tus datos.","Invalid payment method":"MÃ©todo de pago no vÃ¡lido.","Insufficient funds":"Fondos insuficientes en tu cuenta.","Invalid shipping address":"La direcciÃ³n de envÃ­o no es vÃ¡lida.","Shipping not available":"EnvÃ­o no disponible para tu ubicaciÃ³n.","Server error":"Error del servidor. IntÃ©ntalo mÃ¡s tarde.","Service unavailable":"Servicio temporalmente no disponible.","Rate limit exceeded":"Has realizado demasiadas solicitudes. Espera un momento."};if(o[t])return o[t];const a=t.toLowerCase();return a.includes("stock")||a.includes("existencia")?"Problema con el stock del producto. Verifica la disponibilidad.":a.includes("payment")||a.includes("pago")?"Error en el procesamiento del pago. Verifica tus datos.":a.includes("network")||a.includes("connection")||a.includes("conexiÃ³n")?"Error de conexiÃ³n. Verifica tu conexiÃ³n a internet.":a.includes("timeout")||a.includes("tiempo")?"La operaciÃ³n tardÃ³ demasiado. IntÃ©ntalo de nuevo.":a.includes("cantidad")||a.includes("disponible")?"Cantidad solicitada no disponible. Verifica el stock.":t}static getNotificationType(t){const a=(t?.response?.data?.message||t?.message||"").toLowerCase();return a.includes("stock")||a.includes("existencia")||a.includes("cantidad")||a.includes("validation")||a.includes("required")?k.WARNING:a.includes("unauthorized")||a.includes("token")||a.includes("login")||a.includes("sesiÃ³n")?k.INFO:k.ERROR}static handleApiError(t,o){const a=this.extractUserMessage(t),s=this.getNotificationType(t),r=this.shouldRetry(t);return console.error(`Error${o?` in ${o}`:""}:`,{originalError:t,userMessage:a,type:s,shouldRetry:r}),{message:a,type:s,shouldRetry:r}}static shouldRetry(t){if(t?.code==="NETWORK_ERROR"||t?.code==="ECONNABORTED"||t?.message?.includes("timeout")||t?.message?.includes("Network Error")||t?.response?.status>=500)return!0;if(t?.response?.status>=400&&t?.response?.status<500)return[408,429].includes(t.response.status);const o=t?.response?.data?.message||t?.message||"";return o.toLowerCase().includes("stock")||o.toLowerCase().includes("existencia")||o.toLowerCase().includes("cantidad"),!1}static handleStockError(t,o){return{message:`Solo hay ${t} unidad${t!==1?"es":""} disponible${t!==1?"s":""} en stock. Solicitaste ${o}.`,type:k.WARNING,shouldRetry:!1}}static handleValidationError(t){const o=Object.values(t).flat();return{message:o.length>0?o.join(". "):"Error de validaciÃ³n",type:k.WARNING,shouldRetry:!1}}}const Ze=({showNotification:g,context:t})=>{const o=m.useCallback((r,c)=>{const f=Xe.handleApiError(r,t),d=c||f.message;return g(f.type,d),f.shouldRetry},[g,t]),a=m.useCallback(r=>{g(k.SUCCESS,r)},[g]),s=m.useCallback((r,c)=>{const f=`Solo hay ${r} unidad${r!==1?"es":""} disponible${r!==1?"s":""} en stock. Solicitaste ${c}.`;g(k.WARNING,f)},[g]);return{handleError:o,handleSuccess:a,handleStockError:s}},et=je.getInstance(),ve=[{quantity:3,discount:5,label:"3+"},{quantity:6,discount:10,label:"6+"},{quantity:12,discount:15,label:"12+"}];function tt(g,t,o){const a=ve;let s=null;for(const d of a)if(t>=d.quantity)s=d;else break;if(!s)return{originalPrice:g,discountedPrice:g,discountPercentage:0,savings:0,savingsTotal:0,hasDiscount:!1,tierLabel:null};const r=g*(1-s.discount/100),c=g-r,f=c*t;return{originalPrice:g,discountedPrice:r,discountPercentage:s.discount,savings:c,savingsTotal:f,hasDiscount:!0,tierLabel:s.label}}async function ot(g,t,o){let a=o;if(!a)try{const C=await et.getUnifiedConfig();C.config.volume_discounts&&Array.isArray(C.config.volume_discounts)&&C.config.volume_discounts.length>0&&(a=C.config.volume_discounts)}catch(C){console.warn("Error obteniendo configuraciÃ³n de descuentos, usando defaults:",C),a=ve}(!a||a.length===0)&&(a=ve);let s=null;const r=[...a].sort((C,j)=>C.quantity-j.quantity);for(const C of r)if(t>=C.quantity)s=C;else break;if(!s)return{originalPrice:g,discountedPrice:g,discountPercentage:0,savings:0,savingsTotal:0,hasDiscount:!1,tierLabel:null};const c=g*(1-s.discount/100),f=g-c,d=f*t;return{originalPrice:g,discountedPrice:c,discountPercentage:s.discount,savings:f,savingsTotal:d,hasDiscount:!0,tierLabel:s.label}}function yt(g){const t=g.product?.price||g.price||0,o=g.product?.discount_percentage||0,a=g.quantity||1,s=t*(o/100),r=t-s,c=tt(r,a),f=c.discountedPrice,d=s*a,C=c.savingsTotal,j=d+C,S=c.hasDiscount,E=S?c.discountPercentage:o;return{originalPrice:t,discountedPrice:f,discountPercentage:E,savings:t-f,savingsTotal:j,hasDiscount:o>0||S,sellerDiscountAmount:s,volumeDiscountAmount:c.savings,finalPricePerUnit:f}}async function st(g,t){const o=g.product?.price||g.price||0,a=g.product?.discount_percentage||0,s=g.quantity||1,r=o*(a/100),c=o-r,f=await ot(c,s,t),d=f.discountedPrice,C=r*s,j=f.savingsTotal,S=C+j,E=f.hasDiscount,R=E?f.discountPercentage:a;return{originalPrice:o,discountedPrice:d,discountPercentage:R,savings:o-d,savingsTotal:S,hasDiscount:a>0||E,sellerDiscountAmount:r,volumeDiscountAmount:f.savings,finalPricePerUnit:d}}class be{static configManager=je.getInstance();static async calculateTotals(t,o,a=!1){console.log("ðŸ§® JORDAN CALCULADORA - INICIANDO CON CONFIGURACIÃ“N UNIFICADA",{forceRefresh:a,itemsCount:t.length});const s=await this.configManager.getUnifiedConfig(a),r=s.config;console.log("âœ… JORDAN - ConfiguraciÃ³n obtenida:",{source:s.source,isStale:s.is_stale,taxRate:r.tax_rate,commissionRate:r.platform_commission_rate,shippingCost:r.shipping.default_cost,volumeTiers:r.volume_discounts.length});const c=this.calculateOriginalSubtotal(t);console.log(`1ï¸âƒ£ Subtotal original: $${c.toFixed(2)}`);const{subtotal:f,totalDiscount:d}=this.calculateSellerDiscounts(t,c);console.log(`2ï¸âƒ£ DespuÃ©s descuento vendedor: $${f.toFixed(2)}`);const{subtotal:C,totalDiscount:j}=this.calculateVolumeDiscounts(t,f,r.volume_discounts);console.log(`3ï¸âƒ£ DespuÃ©s descuento volumen: $${C.toFixed(2)}`);const{subtotal:S,discount:E}=this.calculateCouponDiscount(C,o);console.log(`4ï¸âƒ£ DespuÃ©s cupÃ³n: $${S.toFixed(2)}`);const R=this.calculateShipping(S,r.shipping),v=S+R;console.log(`5ï¸âƒ£ Con envÃ­o: $${v.toFixed(2)} (envÃ­o: $${R.toFixed(2)})`);const L=v*r.tax_rate;console.log(`6ï¸âƒ£ IVA calculado: $${L.toFixed(2)} (${(r.tax_rate*100).toFixed(1)}%)`);const I=v+L;console.log(`7ï¸âƒ£ TOTAL FINAL: $${I.toFixed(2)}`);const U=d+j+E,T=j>0,z=R===0;return console.log("ðŸ“Š JORDAN - RESUMEN CON CONFIGURACIÃ“N UNIFICADA:"),console.log(`   ðŸ’° ConfiguraciÃ³n: ${s.source} (${r.version})`),console.log(`   ðŸ’° Tax rate: ${(r.tax_rate*100).toFixed(1)}% (dinÃ¡mico)`),console.log(`   ðŸ’° Volume tiers: ${r.volume_discounts.length} configurados`),console.log(`   ðŸ’° Shipping: $${r.shipping.default_cost} (umbral: $${r.shipping.free_threshold})`),{step1_originalSubtotal:c,step2_afterSellerDiscount:f,step3_afterVolumeDiscount:C,step4_afterCoupon:S,step5_withShipping:v,step6_tax:L,step7_finalTotal:I,sellerDiscounts:d,volumeDiscounts:j,couponDiscount:E,totalDiscounts:U,shipping:R,freeShipping:z,volumeDiscountsApplied:T,configMetadata:{source:s.source,version:r.version,isStale:s.is_stale,warnings:s.warnings},originalSubtotal:c,subtotalAfterSellerDiscount:f,subtotalAfterVolumeDiscount:C,subtotalAfterCoupon:S,subtotalWithShipping:v,tax:L,total:I}}static calculateOriginalSubtotal(t){let o=0;return t.forEach(a=>{const s=this.getBasePrice(a),r=a.quantity||0,c=s*r;console.log(`ðŸ“¦ Item: precio base $${s} Ã— ${r} = $${c}`),o+=c}),o}static calculateSellerDiscounts(t,o){let a=0,s=0;return t.forEach(r=>{const c=this.getBasePrice(r),f=r.quantity||0,d=this.getSellerDiscountPercentage(r),C=c*(d/100),j=c-C,S=C*f,E=j*f;a+=S,s+=E,console.log(`ðŸª Seller discount: ${d}% sobre $${c} = descuento $${C}/unidad`)}),{subtotal:s,totalDiscount:a}}static calculateVolumeDiscounts(t,o,a){let s=0,r=0;return t.forEach(c=>{const f=c.quantity||0,d=this.getVolumeDiscountPercentage(f,a);if(d>0){const C=this.getPriceAfterSellerDiscount(c),j=C*d,S=C-j,E=j*f,R=S*f;s+=E,r+=R,console.log(`ðŸ“¦ Volume discount: ${(d*100).toFixed(1)}% sobre $${C} = descuento $${j}/unidad`)}else{const C=this.getPriceAfterSellerDiscount(c);r+=C*f}}),{subtotal:r,totalDiscount:s}}static calculateCouponDiscount(t,o){if(!o?.discountCode)return{subtotal:t,discount:0};let a=0;const s=o.discountCode;if(s.discount_percentage){const r=parseFloat(s.discount_percentage);a=t*(r/100)}else s.percentage?a=t*(s.percentage/100):s.value&&(a=Math.min(s.value,t));return console.log(`ðŸŽ« CupÃ³n ${s.code}: ${s.discount_percentage||s.percentage||s.value}% = descuento $${a.toFixed(2)}`),{subtotal:t-a,discount:a}}static calculateShipping(t,o){return o.enabled?t>=o.free_threshold?0:o.default_cost:0}static getBasePrice(t){return t.base_price!==void 0?t.base_price:t.product?.price!==void 0?t.product.price:t.price!==void 0&&t.final_price===void 0?t.price:2}static getSellerDiscountPercentage(t){return t.product?.discount_percentage!==void 0?t.product.discount_percentage:50}static getPriceAfterSellerDiscount(t){const o=this.getBasePrice(t),a=this.getSellerDiscountPercentage(t);return o*(1-a/100)}static getVolumeDiscountPercentage(t,o){const a=[...o].sort((s,r)=>r.quantity-s.quantity);for(const s of a)if(t>=s.quantity)return s.discount/100;return 0}static roundForDisplay(t){return parseFloat(t.toFixed(2))}static async prepareCheckoutData(t,o,a=!1){const s=await this.calculateTotals(t,o,a),c=(await this.configManager.getUnifiedConfig(a)).config;return{items:t.map(d=>{const C=this.getBasePrice(d),j=this.getSellerDiscountPercentage(d),S=this.getVolumeDiscountPercentage(d.quantity||0,c.volume_discounts),E=C*(1-j/100),R=S>0?E*(1-S):E;return{product_id:d.product_id||d.product?.id||d.productId,quantity:d.quantity,price:R,base_price:C,original_price:C,final_price:R,volume_discount_percentage:S*100,volume_savings:(E-R)*(d.quantity||0),seller_discount_amount:(C-E)*(d.quantity||0)}}),totals:s}}}class Ne{static async prepareItemsForCheckout(t,o=null,a=!1){console.log("ðŸ›’ JORDAN CheckoutItemsService - Preparando items con configuraciÃ³n unificada",{forceRefresh:a}),console.log("ðŸŽ« CupÃ³n para items:",o?.discountCode?.code||"NINGUNO");const{items:s}=await be.prepareCheckoutData(t,o,a);return s.map((c,f)=>(console.log(`âœ… Item ${f+1} preparado para checkout:`,{product_id:c.product_id,quantity:c.quantity,price:c.price,base_price:c.base_price,final_price:c.final_price}),c))}static async calculateCheckoutTotals(t,o=null,a=!1){console.log("ðŸ” JORDAN - FLUJO CHECKOUT MIGRADO CON CONFIGURACIÃ“N UNIFICADA:",{forceRefresh:a});const s=await be.calculateTotals(t,o,a);return console.log("ðŸ“Š PASO A PASO:"),console.log(`   1ï¸âƒ£ Subtotal original (sin descuentos): ${s.step1_originalSubtotal}`),console.log(`   2ï¸âƒ£ DespuÃ©s de seller + volume: ${s.step3_afterVolumeDiscount} âœ… DEBE SER $2.85`),console.log(`   3ï¸âƒ£ - CupÃ³n 5% sobre subtotal: ${s.couponDiscount} -> Subtotal: ${s.step4_afterCoupon}`),console.log(`   4ï¸âƒ£ + EnvÃ­o: ${s.step5_withShipping}`),console.log(`   5ï¸âƒ£ + IVA 15% sobre ${s.step5_withShipping} : ${s.step6_tax}`),console.log(`   6ï¸âƒ£ TOTAL FINAL: ${s.step7_finalTotal} âœ… DEBE SER $8.87`),console.log("ðŸ’° DESGLOSE COMPLETO:"),console.log(`   - Descuentos seller: ${s.sellerDiscounts}`),console.log(`   - Descuentos volume: ${s.volumeDiscounts}`),console.log(`   - Descuento cupÃ³n: ${s.couponDiscount}`),console.log(`   - Total descuentos: ${s.totalDiscounts}`),console.log(`   - EnvÃ­o: ${s.shipping}`),console.log(`   - IVA (15%): ${s.tax}`),console.log(`ðŸŽ¯ VALOR CORRECTO PARA BACKEND: ${s.total}`),{subtotal:s.step3_afterVolumeDiscount,originalSubtotal:s.originalSubtotal,sellerDiscounts:s.sellerDiscounts,volumeDiscounts:s.volumeDiscounts,totalDiscounts:s.totalDiscounts,couponDiscount:s.couponDiscount,tax:s.tax,shipping:s.shipping,total:s.total,freeShipping:s.freeShipping}}static validateItemsForCheckout(t){const o=[];console.log(`ðŸ” Validando ${t.length} items para checkout:`),t.forEach((s,r)=>{if(console.log(`ðŸ“‹ Validando Item ${r+1}:`,{product_id:s.product_id,product_id_type:typeof s.product_id,quantity:s.quantity,quantity_type:typeof s.quantity,price:s.price,price_type:typeof s.price}),!s.product_id||typeof s.product_id!="number"||isNaN(s.product_id)||s.product_id<=0){const c=`Item ${r+1}: product_id invÃ¡lido (${s.product_id}, tipo: ${typeof s.product_id})`;console.error("âŒ",c),o.push(c)}if(!s.quantity||typeof s.quantity!="number"||isNaN(s.quantity)||s.quantity<=0){const c=`Item ${r+1}: quantity invÃ¡lida (${s.quantity}, tipo: ${typeof s.quantity})`;console.error("âŒ",c),o.push(c)}if(typeof s.price!="number"||isNaN(s.price)||s.price<=0){const c=`Item ${r+1}: price invÃ¡lido (${s.price}, tipo: ${typeof s.price})`;console.error("âŒ",c),o.push(c)}});const a={valid:o.length===0,errors:o};return console.log("ðŸ“Š ValidaciÃ³n resultado:",a),a}static async debugItemPricing(t,o){console.log("ðŸ” DEBUG: ComparaciÃ³n usando calculadora centralizada");const s=(await be.prepareCheckoutData(t)).items;t.forEach((r,c)=>{const f=o[c],d=s[c];console.log(`ðŸ“¦ Item ${c+1}:`,{product_id:r.productId||r.product?.id,quantity:r.quantity,calculated_final_price:d?.price,checkout_price:f?.price,prices_match:Math.abs((f?.price||0)-(d?.price||0))<.01,"âœ…":"USANDO CALCULADORA CENTRALIZADA"})})}}class Pe{async storeCheckoutData(t){try{console.log("DatafastService: Almacenando CheckoutData temporal",t);const o=await B.post(X.DATAFAST.STORE_CHECKOUT_DATA,t);return console.log("DatafastService: CheckoutData almacenado exitosamente",o),o}catch(o){console.error("DatafastService: Error al almacenar CheckoutData:",o);const a=de(o,"Error al almacenar datos de checkout");throw new Error(a)}}async createCheckout(t){try{console.log("DatafastService: Creando checkout",t);const o=await B.post(X.DATAFAST.CREATE_CHECKOUT,t);return console.log("DatafastService: Respuesta de checkout",o),o}catch(o){console.error("DatafastService: Error al crear checkout:",o);const a=de(o,"Error al crear el checkout de Datafast");throw new Error(a)}}async verifyPayment(t){try{console.log("DatafastService: Verificando pago",t);const o=await B.post(X.DATAFAST.VERIFY_PAYMENT,t);return console.log("DatafastService: Respuesta de verificaciÃ³n",o),o}catch(o){console.error("DatafastService: Error al verificar pago:",o);const a=de(o,"Error al verificar el pago de Datafast");throw new Error(a)}}async simulateSuccessfulPayment(t,o,a){if(!t)throw new Error("checkout_id es requerido para simular el pago");if(!o)throw new Error("transaction_id es requerido para simular el pago");const s=`/v1/checkouts/${t}/payment`;console.log("DatafastService: Simulando pago exitoso",{checkoutId:t,transactionId:o,mockResourcePath:s});try{const r={resource_path:s,transaction_id:o,calculated_total:a,simulate_success:!0};console.log("ðŸ”„ Enviando datos de simulaciÃ³n:",r);const c=await B.post(X.DATAFAST.VERIFY_PAYMENT,r);return console.log("DatafastService: Respuesta de simulaciÃ³n:",c),c}catch(r){console.error("DatafastService: Error en simulaciÃ³n:",r);const c=de(r,"Error al simular el pago de Datafast");throw new Error(c)}}async handleDatafastResult(t,o,a){try{console.log("DatafastService: Manejando resultado real de Datafast",{resourcePath:t,transactionId:o,calculatedTotal:a});const s=await this.verifyPayment({resource_path:t,transaction_id:o,calculated_total:a});return s.status!=="success"&&s.result_code==="800.900.300"?{success:!1,status:"error",message:'No se completÃ³ un pago real. Este es el comportamiento esperado en Fase 1 de pruebas. Use "Simular Pago Exitoso" para probar el flujo completo.',result_code:s.result_code,is_phase_1_error:!0}:s}catch(s){console.error("DatafastService: Error al manejar resultado:",s);const r=de(s,"Error al procesar el resultado de Datafast");throw new Error(r)}}async simulateCompleteWidgetFlow(t,o,a,s){try{console.log("ðŸŽ¯ DatafastService: Simulando flujo COMPLETO del widget (orden + factura + SRI)"),console.log("ðŸ“Š ParÃ¡metros:",{checkoutId:t,transactionId:o,calculatedTotal:a});const r=`/v1/checkouts/${t}/payment`;console.log("ðŸ”— ResourcePath simulado:",r),console.log("ðŸ’¾ Guardando datos en localStorage (idÃ©ntico a widget real)..."),localStorage.setItem("datafast_resource_path",r),localStorage.setItem("datafast_form_data",JSON.stringify(s)),localStorage.setItem("datafast_calculated_total",a.toString()),localStorage.setItem("datafast_transaction_id",o),localStorage.setItem("datafast_checkout_id",t),console.log("âœ… Datos guardados en localStorage:"),console.log("   - datafast_resource_path:",r),console.log("   - datafast_form_data:","guardado"),console.log("   - datafast_calculated_total:",a),console.log("   - datafast_transaction_id:",o),console.log("   - datafast_checkout_id:",t),console.log("ðŸ“‹ ConfiguraciÃ³n lista - DatafastResultPage procesarÃ¡ el pago"),console.log("âš ï¸ NO hacer request aquÃ­ para evitar doble procesamiento"),console.log("â³ Simulando delay de procesamiento del widget..."),await new Promise(f=>setTimeout(f,1e3));const c=`/datafast-result?resourcePath=${encodeURIComponent(r)}&status=pending&transactionId=${o}&simulate=true`;return console.log("ðŸš€ URL de redirecciÃ³n generada (flujo completo):",c),console.log("ðŸ“‹ DatafastResultPage ejecutarÃ¡:"),console.log("   1. verifyPayment() - verificaciÃ³n (simulada como exitosa)"),console.log("   2. processCheckout() - crear orden + factura + enviar SRI"),console.log("   3. clearCart() - limpiar carrito"),console.log("   4. navigate('/orders') - redirigir a Ã³rdenes"),c}catch(r){throw console.error("âŒ Error en simulaciÃ³n de widget flow:",r),new Error("Error al simular el flujo del widget")}}extractResourcePath(t){try{const a=new URLSearchParams(t.split("?")[1]).get("resourcePath");return console.log("DatafastService: ResourcePath extraÃ­do:",a),a}catch(o){return console.error("DatafastService: Error al extraer resourcePath:",o),null}}}const at=({content:g})=>e.jsx("div",{className:"space-y-4",children:e.jsxs("div",{className:"text-center",children:[e.jsx("p",{className:"mb-4 text-gray-600",children:"Paga con Datafast!, ingresa los datos personales para pagar de forma rÃ¡pida y segura."}),e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"bg-[linear-gradient(to_right,_rgba(0,184,110,1)_0%,_rgba(0,77,112,1)_46%,_rgba(0,77,112,1)_100%)] border-purple-200 rounded-lg p-6",children:e.jsx("div",{className:"flex items-center justify-center mb-4 h-50",children:e.jsx("img",{src:"https://www.datafast.com.ec/images/logo.png",alt:"Datafast Logo",className:"h-20"})})}),g]}),e.jsxs("div",{className:"mt-4 text-sm text-gray-500",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"1."}),' Haz clic en "Pagar con Datafast!"']}),e.jsxs("p",{children:[e.jsx("strong",{children:"2."})," Completa los datos de tu tarjeta de crÃ©dito o dÃ©bito."]}),e.jsxs("p",{children:[e.jsx("strong",{children:"3."})," Confirma tu compra al finalizar."]})]})]})});class ee{static BASE_PATH="/deuna";static async createPayment(t){try{console.log("DeunaService: Creating payment",t),console.log("ðŸ” DEUNA SERVICE - EXACT PAYLOAD TO SEND:",{path:`${this.BASE_PATH}/payments`,payload:t,payload_json:JSON.stringify(t),items_in_payload:t.items,items_count:t.items?.length||0,first_item_keys:t.items&&t.items.length>0?Object.keys(t.items[0]):"no_items"});const o=await B.post(`${this.BASE_PATH}/payments`,t);return console.log("DeunaService: Payment created successfully",o),o}catch(o){throw console.error("DeunaService: Error creating payment",o),new Error(o.response?.data?.message||o.message||"Error creating payment")}}static async generateQR(t){try{console.log("DeunaService: Generating QR code",t);const o=await B.post(`${this.BASE_PATH}/payments/qr`,t);return console.log("DeunaService: QR code generated successfully",o),o}catch(o){throw console.error("DeunaService: Error generating QR code",o),new Error(o.response?.data?.message||o.message||"Error generating QR code")}}static async getPaymentStatus(t){try{console.log("DeunaService: Getting payment status",{paymentId:t});const o=await B.get(`${this.BASE_PATH}/payments/${t}/status`);return console.log("DeunaService: Payment status retrieved",o),o}catch(o){throw console.error("DeunaService: Error getting payment status",o),new Error(o.response?.data?.message||o.message||"Error getting payment status")}}static async getPaymentByOrderId(t){try{console.log("DeunaService: Getting payment by order ID",{orderId:t});const o=await B.get(`${this.BASE_PATH}/orders/${t}/payment`);return console.log("DeunaService: Payment retrieved by order ID",o),o}catch(o){throw console.error("DeunaService: Error getting payment by order ID",o),new Error(o.response?.data?.message||o.message||"Error getting payment")}}static async cancelPayment(t,o){try{console.log("DeunaService: Cancelling payment",{paymentId:t,reason:o});const a=await B.post(`${this.BASE_PATH}/payments/${t}/cancel`,{reason:o||"Cancelled by user"});return console.log("DeunaService: Payment cancelled successfully",a),a}catch(a){throw console.error("DeunaService: Error cancelling payment",a),new Error(a.response?.data?.message||a.message||"Error cancelling payment")}}static async voidPayment(t,o,a){try{console.log("DeunaService: Processing void/refund",{paymentId:t,amount:o,reason:a});const s=await B.post(`${this.BASE_PATH}/payments/${t}/void`,{amount:o,reason:a||"Void/refund requested by user"});return console.log("DeunaService: Payment void/refund processed successfully",s),s}catch(s){throw console.error("DeunaService: Error processing void/refund",s),new Error(s.response?.data?.message||s.message||"Error processing void/refund")}}static async listPayments(t){try{console.log("DeunaService: Listing payments",t);const o=new URLSearchParams;t&&Object.entries(t).forEach(([s,r])=>{r!=null&&r!==""&&o.append(s,String(r))});const a=await B.get(`${this.BASE_PATH}/payments?${o.toString()}`);return console.log("DeunaService: Payments listed successfully",a),a}catch(o){throw console.error("DeunaService: Error listing payments",o),new Error(o.response?.data?.message||o.message||"Error listing payments")}}static pollPaymentStatus(t,o){const a=o?.maxAttempts||60,s=o?.interval||5e3,r=o?.onStatusChange,c=new AbortController;return{promise:new Promise(async(d,C)=>{let j=0,S="",E=null;const R=()=>{E&&(clearTimeout(E),E=null)},v=()=>{R(),C(new Error("Payment polling was cancelled"))};c.signal.addEventListener("abort",v);try{for(;j<a&&!c.signal.aborted;)try{const L=await this.getPaymentStatus(t),I=L.data.status;if(c.signal.aborted){R();return}if(I!==S&&r&&(r(I),S=I),["completed","failed","cancelled","refunded"].includes(I)){console.log(`DeunaService: Payment reached final status: ${I}`),R(),c.signal.removeEventListener("abort",v),d(L);return}j++,j<a&&!c.signal.aborted&&await new Promise((U,T)=>{E=setTimeout(()=>{E=null,c.signal.aborted?T(new Error("Cancelled")):U()},s);const z=()=>{E&&(clearTimeout(E),E=null),T(new Error("Cancelled"))};c.signal.addEventListener("abort",z,{once:!0})})}catch(L){if(c.signal.aborted){R();return}console.warn(`DeunaService: Error polling payment status (attempt ${j+1})`,L),j++,j<a&&await new Promise((I,U)=>{E=setTimeout(()=>{E=null,c.signal.aborted?U(new Error("Cancelled")):I()},s);const T=()=>{E&&(clearTimeout(E),E=null),U(new Error("Cancelled"))};c.signal.addEventListener("abort",T,{once:!0})})}R(),c.signal.removeEventListener("abort",v),c.signal.aborted?C(new Error("Payment polling was cancelled")):C(new Error(`Payment status polling timed out after ${a} attempts`))}catch(L){R(),c.signal.removeEventListener("abort",v),L.message==="Cancelled"?C(new Error("Payment polling was cancelled")):C(L)}}),cancel:()=>{console.log("DeunaService: Cancelling payment polling"),c.abort()}}}static isValidQRCode(t){if(!t||t.trim()==="")return!1;if(t.startsWith("data:image/"))return!0;try{return new URL(t),!0}catch{return!1}}static formatCurrency(t,o="USD"){return new Intl.NumberFormat("es-EC",{style:"currency",currency:o,minimumFractionDigits:2,maximumFractionDigits:2}).format(t)}static getPaymentMethodDisplayName(t){return{qr_code:"CÃ³digo QR",payment_link:"Enlace de Pago",numeric_code:"CÃ³digo NumÃ©rico",deuna:"DeUna"}[t]||t}static getStatusDisplay(t){return{created:{label:"Creado",color:"blue",icon:te.createElement(Ve,{className:"w-4 h-4"})},pending:{label:"Pendiente",color:"yellow",icon:te.createElement(Ie,{className:"w-4 h-4"})},completed:{label:"Completado",color:"green",icon:te.createElement(De,{className:"w-4 h-4"})},failed:{label:"Fallido",color:"red",icon:te.createElement(he,{className:"w-4 h-4"})},cancelled:{label:"Cancelado",color:"gray",icon:te.createElement(Fe,{className:"w-4 h-4"})},refunded:{label:"Reembolsado",color:"purple",icon:te.createElement(Le,{className:"w-4 h-4"})}}[t]||{label:t,color:"gray",icon:te.createElement(Me,{className:"w-4 h-4"})}}static async simulatePaymentSuccess(t,o,a,s,r){if(!t||t.trim()==="")throw new Error("payment_id es obligatorio para la simulaciÃ³n");if(!o||o<=0)throw new Error("amount vÃ¡lido es obligatorio para la simulaciÃ³n");if(!a||a.trim()==="")throw new Error("customer_email es obligatorio para la simulaciÃ³n");try{console.log("ðŸ§ª Simulating payment success for testing",{paymentId:t,amount:o,customerEmail:a});const c={payment_id:t,transaction_id:t,simulate_deuna:!0,amount:o,currency:"USD",customer_email:a,customer_name:s||"Test User",calculated_total:o,session_id:r},f=await B.post("/webhooks/deuna/simulate-payment-success",c);return console.log("ðŸŽ‰ Payment simulation response:",f),f}catch(c){throw console.error("âŒ Error simulating payment:",c),new Error(c.response?.data?.message||c.message||"Error simulando el pago")}}static async processRealPaymentCompletion(t,o,a){try{console.log("âœ… Processing REAL payment completion (not simulation)",{paymentId:t,amount:o,customerEmail:a}),console.log("ðŸ“‹ Real payment flow: webhook processing â†’ order creation â†’ invoice â†’ SRI");const s=await this.getPaymentStatus(t);if(s.success&&s.data?.status==="completed"){console.log("âœ… Payment confirmed as completed, processing real webhook flow");const r={event:"payment.completed",payment_id:t,status:"completed",amount:o||s.data.amount,currency:"USD",customer_email:a||"default@deuna.com",completed_at:new Date().toISOString(),source:"real_payment_completion"};console.log("ðŸ”„ Processing real payment through webhook handler");const c=await B.post("/webhooks/deuna",r);return console.log("ðŸŽ‰ Real payment processed successfully:",c),console.log("ðŸ“Š This payment went through: HandleDeunaWebhookUseCase â†’ createOrderFromPayment() â†’ order + invoice + SRI"),c}else throw console.warn("âš ï¸ Payment status is not completed, cannot process real completion"),new Error("Payment is not in completed status")}catch(s){throw console.error("âŒ Error processing real payment completion:",s),console.error("ðŸ”„ Real payment processing failed, this should be investigated"),console.error("ðŸ’¡ Consider checking: payment status, webhook endpoint, HandleDeunaWebhookUseCase"),new Error(s.response?.data?.message||s.message||"Error procesando el pago completado real")}}static isDevelopmentMode(){return window.location.hostname==="localhost"||window.location.hostname==="127.0.0.1"}}const rt=({total:g,checkoutData:t,onPaymentSuccess:o,onPaymentError:a})=>{const{cart:s}=Ce(),{user:r}=ye(),[c,f]=m.useState(!1),[d,C]=m.useState(null),[j,S]=m.useState(""),[E,R]=m.useState(!1),[v,L]=m.useState(""),[I,U]=m.useState(600),[T,z]=m.useState(!1),[J,oe]=m.useState(!1),y=te.useRef(null),H=te.useRef(null),Y=te.useRef([]);if(!t||!t.totals)throw new Error("QRPaymentForm requiere CheckoutData vÃ¡lido con totales");if(!g||g<=0)throw new Error("QRPaymentForm requiere total vÃ¡lido mayor a $0");const F=m.useCallback(()=>`ORDER-${Date.now()}-${Math.random().toString(36).substr(2,9).toUpperCase()}`,[]),K=async i=>{try{await navigator.clipboard.writeText(i),z(!0),setTimeout(()=>z(!1),2e3)}catch(A){console.error("Failed to copy to clipboard:",A)}};m.useEffect(()=>{if(d&&E&&I>0){const i=setInterval(()=>{U(A=>A<=1?(R(!1),S("El tiempo de pago ha expirado. El pago ha sido cancelado automÃ¡ticamente."),d?.payment_id&&(console.log("â° Timer expired - automatically cancelling payment:",d.payment_id),ee.cancelPayment(d.payment_id,"Timer expired - automatic cancellation").then(()=>{console.log("âœ… Payment automatically cancelled due to timer expiration"),L("cancelled"),y.current?.cancel&&(y.current.cancel(),y.current=null)}).catch(l=>{console.error("âŒ Error automatically cancelling expired payment:",l),L("cancelled")})),0):A-1)},1e3);H.current=i,Y.current.push(()=>{i&&clearInterval(i)})}return()=>{H.current&&(clearInterval(H.current),H.current=null)}},[d,E,I]),m.useEffect(()=>()=>{console.log("ðŸš¨ QRPaymentForm: Component unmounting, executing critical cleanup"),x()},[]);const re=i=>{const A=Math.floor(i/60),l=i%60;return`${A.toString().padStart(2,"0")}:${l.toString().padStart(2,"0")}`},ne=m.useCallback(i=>{console.log("Payment status changed:",i),L(i);const A=ee.getStatusDisplay(i);switch(i){case"completed":R(!1),console.log("âœ… Payment completed successfully, processing REAL payment completion"),(async()=>{try{if(d){console.log("ðŸŽ¯ Processing REAL QR payment completion through actual webhook flow"),console.log("ðŸ“‹ This will trigger: webhook â†’ HandleDeunaWebhookUseCase â†’ createOrderFromPayment() â†’ order + invoice + SRI");const b=await ee.processRealPaymentCompletion(d.payment_id,d.amount,r?.email);b.success&&(console.log("âœ… Order created successfully from REAL QR payment:",b),console.log("ðŸ† Real payment processed with complete flow: order + invoice + SRI generation"))}o&&o({...d,status:"completed",completed_at:new Date().toISOString()})}catch(b){console.error("Error processing completed payment:",b),o&&o({...d,status:"completed",completed_at:new Date().toISOString()})}})();break;case"failed":case"cancelled":R(!1);const n=`Pago ${A.label.toLowerCase()}`;S(n),a&&a(n);break}},[d,o,a]),se=async()=>{if(!t){S("No se puede generar QR sin datos de checkout validados");return}if(!r){S("InformaciÃ³n de usuario no disponible");return}f(!0),S("");try{const i=F();console.log("ðŸŽ¯ USANDO CHECKOUTDATA PARA QR DEUNA:",{sessionId:t.sessionId,userId:t.userId,total:t.totals.final_total,itemsCount:t.items.length,validatedAt:t.validatedAt});const A={order_id:i,amount:t.totals.final_total,currency:"USD",customer:{name:t.shippingData.name,email:t.shippingData.email,phone:t.shippingData.phone},items:t.items.map((n,b)=>{const w={name:n.name,quantity:n.quantity,price:n.price,description:n.name,product_id:n.product_id};return console.log(`âœ… ITEM ${b} FROM CHECKOUTDATA:`,{product_id:w.product_id,name:w.name,quantity:w.quantity,price:w.price}),w}),qr_type:"dynamic",format:"2",metadata:{source:"bcommerce_checkout_validated",user_id:r.id,session_id:t.sessionId,validated_at:t.validatedAt,checkout_timestamp:new Date().toISOString()},session_id:t.sessionId,validated_at:t.validatedAt,checkout_data:t};console.log("ðŸš€ FINAL PAYMENT REQUEST TO SEND:",{order_id:A.order_id,amount:A.amount,items_count:A.items?.length||0,items:A.items,first_item_keys:A.items&&A.items.length>0?Object.keys(A.items[0]):"no_items"}),console.log("Creating DeUna payment:",A);const l=await ee.createPayment(A);if(console.log("DeUna API Response:",l),console.log("Response structure:",Object.keys(l)),l.success){console.log("Payment data from response:",l.data),console.log("QR code in response:",l.data?.qr_code_base64),C(l.data),L(l.data.status),U(600),R(!0);const n=ee.pollPaymentStatus(l.data.payment_id,{maxAttempts:40,interval:15e3,onStatusChange:ne});y.current=n,n.promise.catch(b=>{b.message==="Payment polling was cancelled"?console.log("DeunaService: Polling cancelled successfully"):(console.error("Polling error:",b),E&&S("Error monitoreando el estado del pago"))})}else throw new Error(l.message||"Error creating payment")}catch(i){console.error("Error generating QR payment:",i),S(i.message||"Error al generar el cÃ³digo QR"),a&&a(i.message)}finally{f(!1)}},x=()=>{y.current?.cancel&&(y.current.cancel(),y.current=null),H.current&&(clearInterval(H.current),H.current=null),Y.current.forEach(i=>{try{i()}catch(A){console.error("Error during cleanup:",A)}}),Y.current=[],C(null),S(""),L(""),R(!1),U(600),z(!1),console.log("ðŸ§¹ QRPaymentForm: Complete cleanup executed")},N=async()=>{if(!d?.payment_id||v==="completed"){x();return}if(!E){x();return}try{console.log("Cancelling payment:",d.payment_id),y.current?.cancel&&(y.current.cancel(),y.current=null),R(!1),await ee.cancelPayment(d.payment_id,"Cancelled by user"),L("cancelled"),S("Pago cancelado por el usuario"),console.log("Payment successfully cancelled by user")}catch(i){console.error("Error cancelling payment:",i),S("Error al cancelar el pago: "+i.message),R(!1)}},O=async()=>{try{if(f(!0),S(""),d?.payment_id&&E&&!["completed","cancelled","failed"].includes(v))try{console.log("Cancelling current payment before generating new QR:",d.payment_id),y.current?.cancel&&(y.current.cancel(),y.current=null),R(!1),await ee.cancelPayment(d.payment_id,"Cancelled to generate new QR"),console.log("Current payment cancelled successfully")}catch(i){console.error("Error cancelling current payment:",i)}await se()}catch(i){console.error("Error generating new QR:",i),S("Error al generar nuevo cÃ³digo QR: "+i.message)}finally{f(!1)}},G=async()=>{if(!d?.payment_id){S("No hay un pago activo para simular");return}if(!d?.amount||d.amount<=0){S("Monto del pago invÃ¡lido o faltante");return}if(!r?.email){S("Email del usuario requerido para la simulaciÃ³n");return}oe(!0),S("");try{console.log("ðŸ§ª SIMULATING payment success for testing purposes"),console.log("ðŸ“‹ This will trigger: simulation webhook â†’ HandleDeunaWebhookUseCase â†’ createOrderFromPayment() â†’ order + invoice + SRI");const i=await ee.simulatePaymentSuccess(d.payment_id,d.amount,r.email,r.name||void 0,t?.sessionId);if(i.success)console.log("âœ… Payment simulation successful:",i),L("completed"),R(!1),y.current?.cancel&&(y.current.cancel(),y.current=null),o&&o({...d,status:"completed",completed_at:new Date().toISOString(),simulated:!0});else throw new Error(i.message||"Simulation failed")}catch(i){console.error("âŒ Error simulating payment:",i),S("Error simulando el pago: "+i.message)}finally{oe(!1)}},p=()=>{if(!v)return null;const i=ee.getStatusDisplay(v);return e.jsxs("div",{className:`flex items-center justify-center p-3 rounded-lg mb-4 ${i.color==="green"?"bg-green-50 text-green-700":i.color==="red"?"bg-red-50 text-red-700":i.color==="yellow"?"bg-yellow-50 text-yellow-700":"bg-blue-50 text-blue-700"}`,children:[e.jsx("span",{className:"mr-2",children:i.icon}),e.jsx("span",{className:"font-medium",children:i.label}),E&&i.color==="yellow"&&e.jsx(me,{className:"w-4 h-4 ml-2 animate-spin"})]})};return d?e.jsxs("div",{className:"space-y-6",children:[e.jsx(p,{}),E&&e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"inline-flex items-center bg-blue-50 text-blue-700 px-4 py-2 rounded-lg",children:[e.jsx(Ie,{className:"w-4 h-4 mr-2"}),e.jsx("span",{className:"font-mono text-lg",children:re(I)})]}),e.jsx("p",{className:"text-sm text-gray-500 mt-2",children:"Tiempo restante para completar el pago"})]}),d.qr_code_base64&&!["cancelled","failed"].includes(v)?e.jsx("div",{className:"mb-4 mx-auto",children:e.jsxs("div",{className:"bg-[#2fd8a8] p-6 rounded-lg text-white",children:[e.jsx("div",{className:"w-24 h-24 mx-auto mb-4 bg-white rounded-full flex items-center justify-center",children:e.jsx("img",{src:"https://deuna.app/assets/img/brand/logo-deuna.svg",alt:"DeUna Logo",className:"w-20 h-20"})}),e.jsx("h3",{className:"text-xl font-bold mb-2",children:"Pago con Deuna"}),e.jsxs("p",{className:"text-purple-100 mb-4",children:["Monto a pagar: ",q(g)]}),e.jsx("div",{className:"bg-white rounded-lg p-4 mb-4",children:e.jsx("img",{src:d.qr_code_base64,alt:"CÃ³digo QR para pago",className:"w-full h-auto max-w-64 mx-auto"})}),e.jsxs("p",{className:"text-purple-100 text-sm mb-4 flex items-center justify-center",children:[e.jsx(qe,{className:"w-4 h-4 mr-2"}),"Escanea con tu app Deuna"]}),e.jsx("button",{onClick:N,className:"bg-white/20 hover:bg-white/30 text-white font-medium py-2 px-4 rounded-md transition-colors",disabled:!E||v==="completed",children:E?"Cancelar Pago":"Cerrar"})]})}):["cancelled","failed"].includes(v)&&e.jsx("div",{className:"mb-4 mx-auto",children:e.jsxs("div",{className:"bg-gray-100 border-2 border-gray-300 p-6 rounded-lg text-center",children:[e.jsx("div",{className:"w-24 h-24 mx-auto mb-4 bg-gray-300 rounded-full flex items-center justify-center",children:e.jsx(he,{className:"w-12 h-12 text-gray-500"})}),e.jsx("h3",{className:"text-xl font-bold text-gray-700 mb-2",children:v==="cancelled"?"Pago Cancelado":"Pago Fallido"}),e.jsx("p",{className:"text-gray-600 mb-4",children:v==="cancelled"?"El pago fue cancelado. Puedes generar un nuevo cÃ³digo QR.":"El pago fallÃ³. Puedes intentar generar un nuevo cÃ³digo QR."})]})}),d.payment_url&&!["cancelled","failed"].includes(v)&&e.jsxs("div",{className:"space-y-3",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row gap-2",children:[e.jsx("input",{type:"text",value:d.payment_url,readOnly:!0,className:"flex-1 px-3 py-2 border border-gray-300 rounded-lg bg-gray-50 text-sm"}),e.jsxs("button",{onClick:()=>K(d.payment_url),className:"px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx(Be,{className:"w-4 h-4 mr-1"}),T?"Copiado!":"Copiar"]})]}),e.jsxs("a",{href:d.payment_url,target:"_blank",rel:"noopener noreferrer",className:"w-full bg-[#3f2b57] hover:bg-[#3f2b45] text-white font-medium py-3 px-4 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx(Ge,{className:"w-4 h-4 mr-2"}),"Abrir enlace de pago"]})]}),d.numeric_code&&!["cancelled","failed"].includes(v)&&e.jsxs("div",{className:"bg-gray-50 p-4 rounded-lg text-center",children:[e.jsx("p",{className:"text-sm text-gray-600 mb-2",children:"CÃ³digo numÃ©rico:"}),e.jsx("p",{className:"text-2xl font-mono font-bold text-gray-900 tracking-wider",children:d.numeric_code})]}),e.jsxs("div",{className:"text-center",children:[e.jsxs("p",{className:"text-lg font-semibold text-gray-900",children:["Monto a pagar: ",q(g)]}),e.jsxs("p",{className:"text-sm text-gray-500",children:["ID de Pago: ",d.payment_id]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("button",{onClick:O,disabled:c,className:"flex-1 bg-gray-100 hover:bg-gray-200 disabled:opacity-50 disabled:cursor-not-allowed text-gray-700 font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:c?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-4 h-4 mr-2 animate-spin"}),"Generando..."]}):"Generar Nuevo QR"}),ee.isDevelopmentMode()&&E&&!["completed","cancelled","failed"].includes(v)&&e.jsx("button",{onClick:G,disabled:J,className:"flex-1 bg-orange-500 hover:bg-orange-600 disabled:opacity-50 disabled:cursor-not-allowed text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:J?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-4 h-4 mr-2 animate-spin"}),"Simulando..."]}):e.jsxs(e.Fragment,{children:[e.jsx(He,{className:"w-4 h-4 mr-2"}),"ðŸ§ª Simular Pago"]})}),v==="completed"&&e.jsxs("button",{onClick:()=>o&&o(d),className:"flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition-colors flex items-center justify-center",children:[e.jsx(De,{className:"w-4 h-4 mr-2"}),"Continuar"]})]}),j&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(he,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("p",{className:"text-red-700",children:j})]})}),e.jsxs("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:[e.jsx("h4",{className:"font-medium text-blue-900 mb-2",children:"Instrucciones:"}),e.jsxs("ol",{className:"text-sm text-blue-800 space-y-1",children:[e.jsxs("li",{children:[e.jsx("strong",{children:"1."})," Escanea el cÃ³digo QR con tu app de pagos"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"2."})," O usa el enlace de pago en tu dispositivo mÃ³vil"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"3."})," Completa el pago en la aplicaciÃ³n"]}),e.jsxs("li",{children:[e.jsx("strong",{children:"4."})," Espera la confirmaciÃ³n automÃ¡tica"]})]}),ee.isDevelopmentMode()&&E&&e.jsx("div",{className:"mt-3 pt-3 border-t border-blue-300",children:e.jsxs("p",{className:"text-xs text-orange-700 bg-orange-50 p-2 rounded",children:["ðŸ§ª ",e.jsx("strong",{children:"Modo de desarrollo:"}),' Puedes usar el botÃ³n "Simular Pago" para testear el flujo completo sin necesidad de realizar un pago real.']})})]})]}):e.jsxs("div",{className:"space-y-6",children:[e.jsx("p",{className:"mb-4 text-center text-gray-600",children:"Paga con DeUna!, Genera el cÃ³digo qr y escanealo desde tu app para pagar de forma rÃ¡pida y segura."}),e.jsx("div",{className:"bg-[#2fd8a8] border-purple-200 rounded-lg p-6",children:e.jsx("div",{className:"flex items-center justify-center mb-4",children:e.jsx("img",{src:"https://deuna.app/assets/img/brand/logo-deuna.svg",alt:"DeUna Logo",className:"w-50 h-50"})})}),e.jsx("button",{type:"button",onClick:se,disabled:c||!r||!s?.items?.length,className:"w-full bg-[#3f2b57] hover:bg-[#342843] disabled:opacity-50 disabled:cursor-not-allowed text-white font-bold py-3 px-6 rounded-lg transition-all duration-200 transform hover:scale-101 disabled:transform-none flex items-center justify-center",children:c?e.jsxs(e.Fragment,{children:[e.jsx(me,{className:"w-5 h-5 mr-2 animate-spin"}),"Generando cÃ³digo QR..."]}):`Pagar con DeUna! - ${q(g)}`}),j&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsx(he,{className:"w-5 h-5 text-red-600 mr-2"}),e.jsx("p",{className:"text-red-700",children:j})]})}),e.jsxs("div",{className:"mt-4 text-sm text-center text-gray-500",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"1."}),' Haz clic en "Pagar con DeUna!"']}),e.jsxs("p",{children:[e.jsx("strong",{children:"2."})," Completa el pago con el QR"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"3."})," Confirma tu compra al finalizar."]})]})]})},Se=({title:g,address:t,onAddressChange:o,errors:a})=>{const s=g.replace(/\s+/g,"-").toLowerCase();return e.jsxs("div",{className:"space-y-4",children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-800",children:g}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`name-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre Completo *"}),e.jsx("input",{type:"text",id:`name-${s}`,value:t.name||"",onChange:r=>o("name",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.name?"border-red-500":"border-gray-300"}`,placeholder:"Nombre y Apellido"}),a.name&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.name})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`identification-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"CÃ©dula/RUC *"}),e.jsx("input",{type:"text",id:`identification-${s}`,value:t.identification||"",onChange:r=>o("identification",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.identification?"border-red-500":"border-gray-300"}`,placeholder:"1234567890 (cÃ©dula) o 1234567890001 (RUC)",maxLength:13}),a.identification&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.identification})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`street-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"DirecciÃ³n / Calle Principal *"}),e.jsx("input",{type:"text",id:`street-${s}`,value:t.street||"",onChange:r=>o("street",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.street?"border-red-500":"border-gray-300"}`,placeholder:"Calle, nÃºmero, piso, etc."}),a.street&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.street})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`city-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Ciudad *"}),e.jsx("input",{type:"text",id:`city-${s}`,value:t.city||"",onChange:r=>o("city",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.city?"border-red-500":"border-gray-300"}`,placeholder:"Ciudad"}),a.city&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.city})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`state-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"Provincia/Estado *"}),e.jsx("input",{type:"text",id:`state-${s}`,value:t.state||"",onChange:r=>o("state",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.state?"border-red-500":"border-gray-300"}`,placeholder:"Provincia o Estado"}),a.state&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.state})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`postalCode-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"CÃ³digo Postal"}),e.jsx("input",{type:"text",id:`postalCode-${s}`,value:t.postalCode||"",onChange:r=>o("postalCode",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.postalCode?"border-red-500":"border-gray-300"}`,placeholder:"CÃ³digo Postal"}),a.postalCode&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.postalCode})]}),e.jsxs("div",{children:[e.jsx("label",{htmlFor:`country-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"PaÃ­s *"}),e.jsx("input",{type:"text",id:`country-${s}`,value:t.country||"",onChange:r=>o("country",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.country?"border-red-500":"border-gray-300"}`,placeholder:"PaÃ­s"}),a.country&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.country})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{htmlFor:`phone-${s}`,className:"block text-sm font-medium text-gray-700 mb-1",children:"TelÃ©fono *"}),e.jsx("input",{type:"tel",id:`phone-${s}`,value:t.phone||"",onChange:r=>o("phone",r.target.value),className:`w-full px-4 py-2 border rounded-md focus:ring-primary-500 focus:border-primary-500 ${a.phone?"border-red-500":"border-gray-300"}`,placeholder:"NÃºmero de telÃ©fono"}),a.phone&&e.jsx("p",{className:"mt-1 text-sm text-red-500",children:a.phone})]})]})]})},_e={BASE_URL:"/",DEV:!1,MODE:"production",PROD:!0,SSR:!1,VITE_ANALYTICS_ENABLED:"true",VITE_API_BASE_URL:"https://api.comersia.app/api",VITE_APP_DESCRIPTION:"Plataforma de e-commerce ecuatoriana",VITE_APP_ENV:"production",VITE_APP_NAME:"Comersia",VITE_AUTO_REFRESH_ENABLED:"true",VITE_BACKEND_URL:"https://api.comersia.app",VITE_BUNDLE_ANALYZER:"false",VITE_CACHE_DURATION:"3600000",VITE_CACHE_ENABLED:"true",VITE_CSP_ENABLED:"true",VITE_DATAFAST_LOGO_URL:"https://www.datafast.com.ec/images/logo.png",VITE_DATAFAST_MODE:"production",VITE_DATAFAST_WIDGET_URL:"https://eu-test.oppwa.com/v1/paymentWidgets.js",VITE_DEBUG_MODE:"false",VITE_DEUNA_MODE:"production",VITE_ENABLE_DEVTOOLS:"false",VITE_ERROR_REPORTING:"true",VITE_EXPIRES_IN_SECONDS:"900",VITE_FRONTEND_URL:"https://comersia.app",VITE_GOOGLE_CLIENT_ID:"581090375629-kds9jjgs2pk60iqe05fmjhpf6pps2nsv.apps.googleusercontent.com",VITE_HOT_RELOAD:"false",VITE_HTTPS_ONLY:"true",VITE_IMAGE_BASE_URL:"https://api.comersia.app/storage/",VITE_LOG_LEVEL:"error",VITE_MINIFY:"true",VITE_NODE_ENV:"production",VITE_PAYPAL_MODE:"live",VITE_PERFORMANCE_MONITORING:"true",VITE_PORT:"3000",VITE_SENTRY_ENABLED:"true",VITE_SESSION_TIMEOUT_MINUTES:"15",VITE_SITE_URL:"https://comersia.app",VITE_SOURCE_MAPS:"false",VITE_SRI_API_URL:"http://localhost:3100",VITE_SRI_EMAIL:"businessconnect@businessconnect.com.ec",VITE_SRI_PASSWORD:"dalcroze77aA@",VITE_STORAGE_PREFIX:"comersia_",VITE_TRACKING_ENABLED:"true",VITE_TREE_SHAKING:"true",VITE_URL_BASE:"http://localhost:8000"},nt=(g,t)=>{const o=_e?.[g];return o&&!isNaN(Number(o))?Number(o):t},we={PRECISION:{PRICE_COMPARISON_TOLERANCE:nt("VITE_PRICE_TOLERANCE",.001)},DEBUG:{SHOW_PRECISION_WARNINGS:_e?.VITE_DEBUG_PRECISION==="true"||_e?.NODE_ENV==="development"}},xt=(g,t,o=we.PRECISION.PRICE_COMPARISON_TOLERANCE)=>{const a=Math.abs(g-t),s=a<=o;return we.DEBUG.SHOW_PRECISION_WARNINGS&&a>0&&a<=o&&console.warn(`âš ï¸ Diferencia de precisiÃ³n detectada: ${g} vs ${t} (diff: ${a.toFixed(6)}, tolerance: ${o})`),s},ct=()=>{m.useEffect(()=>{console.log("ðŸ”“ Hook useDatafastCSP activado - Desactivando CSP para Datafast");const g=()=>{const s=document.querySelectorAll('meta[http-equiv="Content-Security-Policy"]');s.length>0&&(s.forEach(c=>c.remove()),console.log(`ðŸ—‘ï¸ Removidos ${s.length} meta tags de CSP`)),document.querySelectorAll("meta").forEach(c=>{const f=c.getAttribute("http-equiv")?.toLowerCase();f&&f.includes("content-security")&&(c.remove(),console.log("ðŸ—‘ï¸ Removido meta tag con CSP alternativo"))})};g();const t=new MutationObserver(s=>{s.forEach(r=>{r.type==="childList"&&r.addedNodes.forEach(c=>{if(c.nodeType===1){const f=c;if(f.tagName==="META"){const d=f.getAttribute("http-equiv")?.toLowerCase();d&&d.includes("content-security")&&(console.log("ðŸš¨ CSP detectado por MutationObserver - removiendo inmediatamente"),f.remove())}}})})});t.observe(document.head,{childList:!0,subtree:!0});const o=setInterval(()=>{g()},100),a=setInterval(()=>{document.querySelector('meta[http-equiv="Content-Security-Policy"]')&&(console.log("âš ï¸ CSP detectado en verificaciÃ³n regular - removiendo"),g())},1e3);return()=>{console.log("ðŸ”„ Limpiando hook useDatafastCSP"),t.disconnect(),clearInterval(o),clearInterval(a)}},[])},it=({onSuccess:g,onError:t,checkoutData:o})=>{ct();const a={Ecuador:"EC",Colombia:"CO",PerÃº:"PE",Peru:"PE","Estados Unidos":"US","United States":"US",USA:"US",EC:"EC",CO:"CO",PE:"PE",US:"US"};Ae();const{cart:s,clearCart:r,showNotification:c,appliedDiscount:f}=Ce();ye();const[d,C]=m.useState(!1),j=x=>a[x]||x.substring(0,2).toUpperCase(),S=x=>{const N=x.replace(/\D/g,"");if(N.length===10)return/^\d{10}$/.test(N)?{cedula:N,wasRuc:!1}:{cedula:N,wasRuc:!1,message:"CÃ©dula debe tener 10 dÃ­gitos numÃ©ricos"};if(N.length===13){const O=N.substring(0,10);return{cedula:O,wasRuc:!0,message:`Se extrajo automÃ¡ticamente la cÃ©dula ${O} del RUC ${N}`}}else return{cedula:N,wasRuc:!1,message:"IdentificaciÃ³n invÃ¡lida: debe tener 10 dÃ­gitos (cÃ©dula) o 13 dÃ­gitos (RUC)"}},[E,R]=m.useState(!1),[v,L]=m.useState(null),[I,U]=m.useState(!1),[T,z]=m.useState(!1),[J,oe]=m.useState(null),[y,H]=m.useState(()=>{if(!o?.shippingData)throw new Error("DatafastPaymentButton requiere CheckoutData vÃ¡lido");const x=o.shippingData,N=x.name.split(" "),O=N[0],G=N.slice(1).join(" ");if(!x.identification)throw console.error("âŒ DatafastPaymentButton: IdentificaciÃ³n requerida para Datafast"),c(k.ERROR,"La cÃ©dula/RUC es obligatoria para procesar el pago con Datafast"),new Error("IdentificaciÃ³n requerida para Datafast");const p=S(x.identification);return console.log("ðŸ” DatafastPaymentButton: Procesando identificaciÃ³n:",{original:x.identification,extracted:p.cedula,wasRuc:p.wasRuc,message:p.message}),{address:x.street,city:x.city,country:j(x.country),given_name:O,middle_name:"",surname:G,phone:x.phone,doc_id:p.cedula}}),Y=new Pe;m.useEffect(()=>()=>{const x=document.getElementById("datafast-widget-script");x&&x.remove()},[]),m.useEffect(()=>{o?(console.log("âœ… DatafastPaymentButton: Usando CheckoutData validado:",{sessionId:o.sessionId,userId:o.userId,total:o.totals.final_total,itemsCount:o.items.length,validatedAt:o.validatedAt}),o.shippingData.identification&&S(o.shippingData.identification)):console.error("âŒ DatafastPaymentButton: No se recibiÃ³ CheckoutData vÃ¡lido")},[o,c]);const F=(x,N)=>{if(x==="doc_id"){const O=S(N);O.message&&!O.wasRuc&&O.cedula.length!==10&&c(k.WARNING,O.message),H(G=>({...G,[x]:O.cedula}))}else H(O=>({...O,[x]:N}))},K=()=>{const x=["address","city","country","given_name","surname","phone","doc_id"];for(const N of x)if(!y[N]||y[N].trim()==="")return c(k.ERROR,`El campo ${N.replace("_"," ")} es obligatorio`),!1;return y.doc_id.length!==10||!/^\d+$/.test(y.doc_id)?(c(k.ERROR,"La cÃ©dula debe tener exactamente 10 dÃ­gitos"),!1):!0},re=async()=>{if(!s||s.items.length===0){c(k.ERROR,"El carrito estÃ¡ vacÃ­o");return}if(K()){C(!0);try{if(!o)throw new Error("No se puede proceder sin CheckoutData validado");console.log("ðŸ’° Usando totales pre-calculados de CheckoutData:",o.totals),console.log("ðŸ›’ Usando items pre-preparados de CheckoutData:",o.items),oe(o.totals);const x={given_name:y.given_name,surname:y.surname,phone:y.phone,doc_id:y.doc_id};y.middle_name&&y.middle_name.trim()!==""&&(x.middle_name=y.middle_name.trim());const N={shippingAddress:{street:y.address,city:y.city,country:j(y.country)},customer:x,items:o.items,total:o.totals.final_total,subtotal:o.totals.subtotal_with_discounts,shipping_cost:o.totals.shipping_cost,tax:o.totals.iva_amount,discount_code:o.discountCode||null,discount_info:o.discountInfo||null,session_id:o.sessionId,validated_at:o.validatedAt};console.log("Iniciando checkout con Datafast usando CheckoutData...",N),console.log("ðŸ’° Total enviado a Datafast: $",o.totals.final_total),console.log("ðŸ” DEBUG - Datos de CheckoutData enviados:"),console.log("   - sessionId:",o.sessionId),console.log("   - customer.middle_name:",N.customer?.middle_name!==void 0?`"${N.customer.middle_name}" (tipo: ${typeof N.customer.middle_name})`:"OMITIDO - campo no enviado"),console.log("   - shippingAddress.country:",`"${N.shippingAddress.country}" (tipo: ${typeof N.shippingAddress.country})`),console.log("ðŸ” DEBUG - Customer completo:",JSON.stringify(N.customer,null,2));const O=await Y.createCheckout(N);if(console.log("Respuesta del checkout:",O),O.status==="success"&&O.data)L(O.data),U(!1),R(!0),localStorage.setItem("datafast_transaction_id",O.data.transaction_id),localStorage.setItem("datafast_checkout_id",O.data.checkout_id),localStorage.setItem("datafast_calculated_total",o.totals.final_total.toString()),localStorage.setItem("datafast_form_data",JSON.stringify(y)),console.log("ðŸ’¾ GUARDANDO CHECKOUTDATA VALIDADO EN LOCALSTORAGE"),console.log("   - Items en CheckoutData:",o.items.length),console.log("   - SessionId:",o.sessionId),localStorage.setItem("datafast_checkout_data",JSON.stringify(o)),console.log("   âœ… CheckoutData guardado en 'datafast_checkout_data'"),localStorage.setItem("datafast_session_id",o.sessionId),console.log("   âœ… SessionId guardado para backend:",o.sessionId),c(k.SUCCESS,"Checkout creado. Preparando formulario de pago..."),setTimeout(()=>{O.data?ne(O.data.checkout_id):c(k.ERROR,"Datos de checkout no disponibles")},100);else throw new Error(O.message||"Error al crear checkout")}catch(x){console.error("Error al iniciar pago con Datafast:",x);const N=x instanceof Error?x.message:"Error desconocido";c(k.ERROR,N),t?.(N)}finally{C(!1)}}},ne=x=>{try{console.log("Cargando widget de Datafast...",x);const N=document.getElementById("datafast-widget-script");N&&N.remove(),window.wpwlOptions={onReady:function(){console.log("âœ… Widget de Datafast listo!"),z(!0),c(k.SUCCESS,"Formulario de pago cargado correctamente."),setTimeout(()=>{const p=document.querySelector("form.paymentWidgets");p&&(console.log("ðŸ“ Agregando listener adicional al formulario"),p.addEventListener("submit",function(l){console.log("ðŸš€ FORMULARIO ENVIADO - Evento capturado!"),console.log("   - Action actual:",p.getAttribute("action")),console.log("   - Method:",p.getAttribute("method")),console.log("   - Target:",p.getAttribute("target"))}),new MutationObserver(l=>{l.forEach(n=>{n.type==="attributes"&&n.attributeName==="action"&&console.log("ðŸ”„ Action del formulario cambiÃ³ a:",p.getAttribute("action"))})}).observe(p,{attributes:!0,attributeFilter:["action","method"]}),new MutationObserver(l=>{l.forEach(n=>{n.addedNodes.forEach(b=>{b.tagName==="IFRAME"&&(console.log("ðŸ–¼ï¸ Nuevo iframe detectado:",{name:b.name,src:b.src,id:b.id}),b.addEventListener("load",()=>{console.log("âœ… Iframe cargado:",b.name);try{(b.contentDocument||b.contentWindow?.document)&&console.log("ðŸ“„ Contenido del iframe accesible")}catch{console.log("ðŸ”’ Iframe cross-origin, no se puede acceder al contenido")}}))})})}).observe(document.body,{childList:!0,subtree:!0}))},500)},onBeforeSubmitCard:function(p){console.log("ðŸ”„ Widget Datafast: Usuario hizo clic en Pagar, procesando..."),console.log("ðŸ” Datos de la tarjeta que se estÃ¡n enviando:",p);const i=document.querySelector("form.paymentWidgets");if(i){console.log("ðŸ“ Estado del formulario al hacer submit:"),console.log("   - Action:",i.action),console.log("   - Method:",i.method),console.log("   - Target:",i.target);const A=i.querySelector('input[name="checkoutId"]');A&&console.log("   - CheckoutId field:",A.getAttribute("value"));const l=document.querySelector(`iframe[name="${i.target}"]`);l?console.log("   - Target iframe encontrado:",l):console.log("   - âš ï¸ No se encontrÃ³ iframe target")}return c(k.INFO,"Procesando pago con Datafast..."),!0},onAfterSubmitCard:async function(p){if(console.log("â³ Widget Datafast: Datos enviados, esperando respuesta..."),console.log("ðŸ“¤ Respuesta completa despuÃ©s del envÃ­o:",p),console.log("ðŸ” DEBUG: Analizando estructura de la respuesta:"),console.log("   - Tipo de data:",typeof p),console.log("   - Es un array?:",Array.isArray(p)),console.log("   - Keys del objeto:",p?Object.keys(p):"data es null/undefined"),p&&p.originalEvent&&console.log("ðŸ“‹ Evento original detectado:",p.originalEvent),p&&p.target){console.log("ðŸŽ¯ Target del evento:",p.target);const n=p.target;n&&n.tagName==="FORM"&&(console.log("ðŸ“ Formulario encontrado en evento:"),console.log("   - Action:",n.action),console.log("   - Method:",n.method))}try{console.log("   - JSON stringified:",JSON.stringify(p,null,2))}catch{console.log("   - No se puede convertir a JSON (referencia circular)")}p&&p.redirect&&console.log("ðŸ”— InformaciÃ³n de redirect encontrada:",p.redirect),p&&p.resourcePath&&(console.log("ðŸ“ ResourcePath encontrado:",p.resourcePath),console.log("ðŸ”„ Intentando redirecciÃ³n manual a:",`/datafast-result?resourcePath=${encodeURIComponent(p.resourcePath)}`),setTimeout(()=>{console.log("â° Esperando 3 segundos para ver si hay redirecciÃ³n automÃ¡tica...")},3e3));let i=0;const A=10,l=setInterval(async()=>{i++,console.log(`ðŸ”„ VerificaciÃ³n ${i}/${A} del estado del pago...`);const n=document.querySelector('iframe[name*="oppwa"], iframe[src*="oppwa"], iframe[src*="datafast"]');n&&console.log("ðŸ–¼ï¸ iFrame de pago detectado:",{name:n.getAttribute("name"),src:n.getAttribute("src"),visible:n.style.display!=="none"});const b=document.querySelector("form.paymentWidgets");if(b){const w=b.getAttribute("action");if(w&&w.includes("resourcePath")){console.log("ðŸ“ Formulario actualizado con resourcePath:",w),clearInterval(l);const W=new URLSearchParams(w.split("?")[1]).get("resourcePath");W&&(console.log("ðŸŽ¯ ResourcePath extraÃ­do:",W),localStorage.setItem("datafast_resource_path",W),setTimeout(()=>{console.log("ðŸš€ Redirigiendo manualmente al resultado..."),window.location.href=w},2e3))}}if(i>=3){const w=localStorage.getItem("datafast_checkout_id"),M=localStorage.getItem("datafast_transaction_id");if(w&&M)try{const V=await(await fetch(`/api/datafast/verify-payment/${M}`,{method:"GET",headers:{"Content-Type":"application/json",Authorization:`Bearer ${localStorage.getItem("authToken")}`}})).json();console.log(`ðŸ“Š Estado del pago (intento ${i}):`,V.data?.payment_status),V.status===k.SUCCESS&&V.data?.payment_status==="completed"&&(console.log("ðŸŽ‰ Pago completado exitosamente!"),clearInterval(l),window.location.href=`/datafast-result?status=success&transactionId=${M}`)}catch(W){console.error(`âŒ Error verificando estado (intento ${i}):`,W)}}i>=A&&(console.log("â° Se alcanzÃ³ el lÃ­mite de verificaciones"),clearInterval(l))},3e3)},onLoadThreeDSecure:function(){console.log("ðŸ” Widget Datafast: Cargando 3D Secure...")},onBeforeRedirectToResult:function(p){return console.log("ðŸ”„ Widget Datafast: Redirigiendo a pÃ¡gina de resultado..."),console.log("ðŸ”— Datos completos de redirecciÃ³n:",p),console.log("ðŸ” DEBUG Redirect - Keys:",p?Object.keys(p):"null"),console.log("ðŸ” DEBUG Redirect - JSON:",JSON.stringify(p,null,2)),p&&p.resourcePath&&(localStorage.setItem("datafast_resource_path",p.resourcePath),console.log("ðŸ’¾ ResourcePath guardado en localStorage:",p.resourcePath)),!0},onChangeBrand:function(p){console.log("ðŸ’³ Widget Datafast: Marca de tarjeta detectada:",p.brand),console.log("ðŸ’³ Datos completos del evento:",p)},onError:function(p){console.error("âŒ Widget Datafast: Error en el pago",p),console.error("âŒ Detalles completos del error:",{message:p.message,code:p.code,name:p.name,full:p}),c(k.ERROR,"Error al procesar el pago: "+(p.message||p.code||"Error desconocido"))},onSubmit:function(p){console.log("ðŸ“‹ Widget Datafast: Formulario enviado"),console.log("ðŸ“‹ Datos completos del formulario:",p),console.log("ðŸ“‹ DEBUG Submit - Keys:",p?Object.keys(p):"null"),console.log("ðŸ“‹ DEBUG Submit - JSON:",JSON.stringify(p,null,2));const i=document.querySelector("form.paymentWidgets");if(i){console.log("ðŸ“ Formulario encontrado:"),console.log("   - Action:",i.getAttribute("action")),console.log("   - Method:",i.getAttribute("method")),console.log("   - Target:",i.getAttribute("target"));const A=document.querySelector('iframe[name*="oppwa"]');A&&console.log("ðŸ–¼ï¸ iFrame de pago encontrado:",A)}return!0},style:"card",locale:"es",labels:{cvv:"CVV",cardHolder:"Nombre (igual que en la tarjeta)"}};const O=void 0,G=document.createElement("script");if(G.id="datafast-widget-script",v?.widget_url)G.src=v.widget_url,console.log("ðŸ“Œ Usando widget_url del backend:",v.widget_url);else{const p="https://eu-test.oppwa.com/v1/paymentWidgets.js";G.src=`${p}?checkoutId=${x}`,console.log("âš ï¸ Usando fallback URL con checkoutId:",G.src)}G.async=!0,G.onload=()=>{console.log("âœ… Script de widget Datafast cargado exitosamente"),setTimeout(()=>{const p=document.querySelectorAll("form.paymentWidgets");console.log("ðŸ“ Formularios de pago encontrados:",p.length),p.length===0?console.warn("âš ï¸ No se encontraron formularios con clase 'paymentWidgets'"):p.forEach((A,l)=>{console.log(`ðŸ“‹ Formulario ${l+1}:`,{action:A.getAttribute("action"),method:A.getAttribute("method"),"data-brands":A.getAttribute("data-brands")})});const i=document.querySelectorAll('script[src*="techlab-cdn"], script[src*="oppwa"]');console.log("ðŸ“œ Scripts de Datafast cargados:",i.length),i.forEach(A=>{console.log("  - ",A.src)})},1e3)},G.onerror=p=>{console.error("âŒ Error al cargar script del widget:",p),c(k.ERROR,"Error al cargar el formulario de pago. Por favor, recargue la pÃ¡gina.")},document.head.appendChild(G),console.log("ðŸ“Œ Script del widget aÃ±adido al DOM:",G.src)}catch(N){console.error("Error al configurar widget:",N),c(k.ERROR,"Error al configurar el formulario de pago")}},se=!1;return E?e.jsx("div",{className:"datafast-payment-widget",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"Pagar con Datafast"}),e.jsxs("div",{className:"mb-4 p-4 bg-blue-50 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-blue-800",children:"InformaciÃ³n del pedido:"}),e.jsxs("p",{className:"text-blue-700",children:["Monto: $",J?.total?.toFixed(2)||v?.amount||s?.total]}),e.jsxs("p",{className:"text-blue-700",children:["ID: ",v?.transaction_id]})]}),e.jsx("div",{className:"min-h-[400px] border border-gray-200 rounded-lg p-4",children:e.jsx("form",{className:"paymentWidgets","data-brands":"VISA MASTER AMEX DINERS DISCOVER",children:!T&&e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-primary-600 mx-auto mb-2"}),e.jsx("p",{className:"text-gray-600",children:"Cargando formulario de pago..."})]})})})}),e.jsxs("div",{className:"mt-4 p-4 bg-yellow-50 border border-yellow-200 rounded-lg",children:[e.jsx("h4",{className:"font-semibold text-yellow-800 mb-2",children:"Datos de prueba para usar:"}),e.jsxs("div",{className:"text-sm text-yellow-700 space-y-1",children:[e.jsxs("p",{children:[e.jsx("strong",{children:"Tarjeta VISA:"})," 4200 0000 0000 0000"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Fecha:"})," 07/26"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"CVV:"})," 246"]}),e.jsxs("p",{children:[e.jsx("strong",{children:"Titular:"})," ",y.given_name," ",y.surname]}),e.jsxs("p",{className:"text-xs mt-2 text-blue-600",children:[e.jsx("strong",{children:"Fase 2:"})," Credenciales de testing avanzado con transacciones reales limitadas"]})]})]}),se,e.jsx("div",{className:"flex justify-center",children:e.jsx("button",{onClick:()=>{R(!1),U(!0),z(!1);const x=document.getElementById("datafast-widget-script");x&&x.remove()},disabled:d,className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors",children:"Volver"})})]})}):I?e.jsx("div",{className:"datafast-form",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6",children:[e.jsx("h3",{className:"text-xl font-bold mb-4",children:"InformaciÃ³n para Datafast"}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Nombre *"}),e.jsx("input",{type:"text",value:y.given_name,onChange:x=>F("given_name",x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Segundo Nombre"}),e.jsx("input",{type:"text",value:y.middle_name,onChange:x=>F("middle_name",x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Apellido *"}),e.jsx("input",{type:"text",value:y.surname,onChange:x=>F("surname",x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"TelÃ©fono *"}),e.jsx("input",{type:"text",value:y.phone,onChange:x=>F("phone",x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",placeholder:"0999999999"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"CÃ©dula * (10 dÃ­gitos)"}),e.jsx("input",{type:"text",value:y.doc_id,onChange:x=>{const N=x.target.value.replace(/\D/g,"").slice(0,13);F("doc_id",N)},className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",placeholder:"1234567890 (si ingresa RUC se extraerÃ¡ automÃ¡ticamente la cÃ©dula)",maxLength:13})]}),e.jsxs("div",{className:"md:col-span-2",children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"DirecciÃ³n *"}),e.jsx("input",{type:"text",value:y.address,onChange:x=>F("address",x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"Ciudad *"}),e.jsx("input",{type:"text",value:y.city,onChange:x=>F("city",x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-1",children:"PaÃ­s *"}),e.jsxs("select",{value:y.country,onChange:x=>F("country",x.target.value),className:"w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-primary-500 focus:border-primary-500",children:[e.jsx("option",{value:"EC",children:"Ecuador"}),e.jsx("option",{value:"CO",children:"Colombia"}),e.jsx("option",{value:"PE",children:"PerÃº"}),e.jsx("option",{value:"US",children:"Estados Unidos"})]})]})]}),e.jsxs("div",{className:"mt-6 flex gap-4",children:[e.jsx("button",{onClick:re,disabled:d,className:"flex-1 bg-primary-600 hover:bg-primary-700 text-white font-medium py-2 px-4 rounded-md transition-colors disabled:opacity-50 flex items-center justify-center",children:d?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"}),"Creando checkout..."]}):"Continuar con Datafast"}),e.jsx("button",{onClick:()=>U(!1),disabled:d,className:"px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50 transition-colors",children:"Cancelar"})]})]})}):e.jsxs("div",{className:"datafast-payment-button",children:[e.jsxs("button",{onClick:()=>U(!0),disabled:d||!s||s.items.length===0,className:"w-full transition-all duration-200 transform hover:scale-101 bg-[#003c58] border-1 hover:bg-[#00B86E] text-white font-medium py-3 px-4 rounded-md disabled:opacity-50 flex items-center justify-center",children:[e.jsx("svg",{className:"w-5 h-5 mr-2",fill:"none",stroke:"currentColor",viewBox:"0 0 24 24",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"})}),"Pagar con Datafast"]}),(!s||s.items.length===0)&&e.jsx("p",{className:"mt-2 text-sm text-gray-500 text-center",children:"Agrega productos al carrito para continuar"})]})},lt=()=>{const g=Ae(),{cart:t,clearCart:o,showNotification:a,appliedDiscount:s}=Ce(),{user:r}=ye(),[c,f]=m.useState(!1),d=new Pe,C={name:"",identification:"",street:"",city:"",state:"",postalCode:"",country:"Ecuador",phone:""},{handleError:j}=Ze({showNotification:a,context:"CheckoutPage"}),{optimisticCartRemove:S}=Ye(),[E,R]=m.useState("credit_card"),[v,L]=m.useState(C),[I,U]=m.useState(C),[T,z]=m.useState(!0),[J,oe]=m.useState({method:"credit_card",card_number:"",card_expiry:"",card_cvc:""}),[y,H]=m.useState({}),[Y,F]=m.useState(!1),[K,re]=m.useState(null),[ne,se]=m.useState(8),[,x]=m.useState("forms_filling"),[N,O]=m.useState(null),[G,p]=m.useState(!1),[i,A]=m.useState({items:[],totals:{subtotal:0,originalSubtotal:0,sellerDiscounts:0,volumeDiscounts:0,totalDiscounts:0,couponDiscount:0,tax:0,shipping:0,total:0,freeShipping:!1},stockIssues:[],checkoutItems:[]});m.useEffect(()=>{(async()=>{if(!t?.items?.length){A({items:[],totals:{subtotal:0,originalSubtotal:0,sellerDiscounts:0,volumeDiscounts:0,totalDiscounts:0,couponDiscount:0,tax:0,shipping:0,total:0,freeShipping:!1},stockIssues:[],checkoutItems:[]});return}console.log("ðŸ”„ CheckoutPage: Calculando descuentos con configuraciÃ³n dinÃ¡mica");const _=await Promise.all(t.items.map(async P=>{const Z=await st(P),xe=P.product?.stockAvailable||P.product?.stock||0,$e=P.quantity>xe||!P.product?.is_in_stock;return{...P,discount:Z,itemTotal:Z.finalPricePerUnit*P.quantity,availableStock:xe,hasStockIssue:$e}}));console.log("âœ… CheckoutPage: Descuentos calculados para",_.length,"items");const $=_.filter(P=>P.hasStockIssue).map(P=>({productName:P.product?.name||"Producto",requested:P.quantity,available:P.availableStock,isOutOfStock:!P.product?.is_in_stock}));console.log("ðŸ” FLUJO CHECKOUT - Calculando totales"),console.log("ðŸ“Š Items en checkout:",t.items.length),console.log("ðŸ“Š CupÃ³n en checkout:",s?.discountCode?.code||"NINGUNO");const D=await Ne.calculateCheckoutTotals(t.items,s,!0);console.log("ðŸŽ¯ TOTAL CHECKOUT:",D.total);const Q=await Ne.prepareItemsForCheckout(t.items,s,!0);A({items:_,totals:D,stockIssues:$,checkoutItems:Q})})()},[t?.items,t?.total,t?.subtotal,s]);const l=u=>typeof u.stockAvailable=="number"?u.stockAvailable:typeof u.stock=="number"?u.stock:0,n=()=>{if(!t?.items)return{valid:!0,errors:[]};const u=[];return t.items.forEach(_=>{const $=l(_.product);_.product?.is_in_stock?_.quantity>$&&u.push(`${_.product?.name||"Producto"}: solo hay ${$} unidades disponibles (solicitaste ${_.quantity})`):u.push(`${_.product?.name||"Producto"} estÃ¡ agotado`)}),{valid:u.length===0,errors:u}};m.useEffect(()=>{if(r){const u={name:`${r.name}`,street:r.address||"",city:r.city||"",state:r.state||r.province||"",postalCode:r.postal_code||r.zip_code||"",country:r.country||"Ecuador",phone:r.phone||""};L(u),U(u)}},[r]);const b=u=>{console.log("Pago exitoso:",u)},w=u=>{console.error("Error:",u)};m.useEffect(()=>{if(Y&&K){console.log("âœ… Order complete - skipping cart validation to show receipt");return}if(!t||t.items.length===0){a(k.ERROR,"El carrito estÃ¡ vacÃ­o"),g("/cart");return}const u=n();u.valid||(console.warn("âš ï¸ Problemas de stock detectados:",u.errors),u.errors.length>0&&a(k.WARNING,`Problema de stock: ${u.errors[0]}`))},[t,g,a,Y,K]),m.useEffect(()=>{if(Y){se(8);const u=setInterval(()=>{se(_=>_<=1?(clearInterval(u),setTimeout(()=>{console.log("ðŸ”„ Auto-redirecting to orders page after 8 seconds"),g("/orders")},0),0):_-1)},1e3);return()=>clearInterval(u)}},[Y,g]);const M=u=>{R(u),oe({...J,method:u==="deuna"?"transfer":"credit_card"})},W=(u,_)=>{const $={...v,[u]:_};L($),T&&U($)},V=(u,_)=>{U({...I,[u]:_})},h=(u,_)=>{if(oe({...J,[u]:_}),_.trim()&&y[u]){const $={...y};delete $[u],H($)}},le=()=>{const u={},_=(D,Q)=>{["name","identification","street","city","state","country","phone"].forEach(Z=>{D[Z]||(u[`${Q}${Z}`]=`El campo ${Z.replace("_"," ")} es obligatorio`),Z==="name"&&D[Z]&&D[Z].trim().split(/\s+/).length<2&&(u[`${Q}${Z}`]="Debe ingresar al menos un nombre y un apellido separados por espacio")})};_(v,"shipping"),T||_(I,"billing"),H(u);const $=Object.keys(u).length===0;return $?console.log("âœ… VALIDACIÃ“N DE DIRECCIONES EXITOSA"):(console.log("âŒ VALIDACIÃ“N FALLÃ“ - Errores encontrados:",u),console.log("ðŸ“Š Estado actual de direcciones:"),console.log("   - useSameAddress:",T),console.log("   - shippingAddress:",v),T||console.log("   - billingAddress:",I)),$},Te=(u,_)=>(console.log("ðŸ”„ Combinando datos del cart con cÃ¡lculos validados (estrategia hÃ­brida)"),u.map(($,D)=>{const Q=_[D],P={product_id:$.productId||$.product_id,name:$.product?.name||`Product ${$.productId||$.product_id}`,subtotal:Q.price*Q.quantity,quantity:Q.quantity,price:Q.price,original_price:Q.original_price||Q.base_price,discount_percentage:Q.volume_discount_percentage||0};return console.log(`   Item ${D+1}: ${P.name} - $${P.price} x ${P.quantity}`),P})),Oe=async()=>{console.log("ðŸ” VALIDACIÃ“N DE CHECKOUT: Iniciando validaciÃ³n centralizada");const u=n();if(!u.valid)return console.log("âŒ ValidaciÃ³n de stock fallÃ³:",u.errors),u.errors.forEach(_=>{a(k.ERROR,_)}),a(k.WARNING,"Por favor, ajusta las cantidades en tu carrito antes de continuar"),!1;if(!le())return console.log("âŒ ValidaciÃ³n de direcciones fallÃ³"),a(k.ERROR,"Por favor, completa todos los campos de direcciÃ³n obligatorios"),!1;if(!r?.id)return a(k.ERROR,"Debes iniciar sesiÃ³n para completar la compra"),!1;console.log("âœ… VALIDACIÃ“N EXITOSA: Creando objeto temporal de checkout");try{f(!0);const _=new Date,$=`checkout_${r.id}_${_.getTime()}`,D={userId:r.id,shippingData:{name:v.name||"",email:r.email||"",phone:v.phone||"",street:v.street||"",city:v.city||"",state:v.state||"",country:v.country||"",postal_code:v.postalCode||"",identification:v.identification||""},billingData:{name:(T?v:I).name||"",email:r.email||"",phone:(T?v:I).phone||"",street:(T?v:I).street||"",city:(T?v:I).city||"",state:(T?v:I).state||"",country:(T?v:I).country||"",postal_code:(T?v:I).postalCode||"",identification:(T?v:I).identification||"",same_as_shipping:T},items:t?Te(t.items,i.checkoutItems):[],totals:{subtotal_original:i.totals.originalSubtotal,subtotal_with_discounts:i.totals.subtotal,seller_discounts:i.totals.sellerDiscounts,volume_discounts:i.totals.volumeDiscounts,coupon_discount:i.totals.couponDiscount,total_discounts:i.totals.totalDiscounts,iva_amount:i.totals.tax,shipping_cost:i.totals.shipping,free_shipping:i.totals.freeShipping,free_shipping_threshold:50,final_total:i.totals.total},discountCode:s?.discountCode?.code,discountInfo:s?{code:s.discountCode.code,discount_percentage:s.discountCode.discount_percentage,discount_amount:i.totals.couponDiscount}:void 0,timestamp:_.toISOString(),sessionId:$,validatedAt:_.toISOString(),expiresAt:new Date(_.getTime()+30*60*1e3).toISOString()};console.log("ðŸ’¾ Almacenando CheckoutData en backend (arquitectura centralizada)...");const Q={shippingData:D.shippingData,billingData:D.billingData,items:D.items,totals:{subtotal_original:D.totals.subtotal_original,subtotal_with_discounts:D.totals.subtotal_with_discounts,seller_discounts:D.totals.seller_discounts,volume_discounts:D.totals.volume_discounts,coupon_discount:D.totals.coupon_discount,total_discounts:D.totals.total_discounts,iva_amount:D.totals.iva_amount,shipping_cost:D.totals.shipping_cost,free_shipping:D.totals.free_shipping,free_shipping_threshold:D.totals.free_shipping_threshold,final_total:D.totals.final_total,subtotal:D.totals.subtotal_with_discounts,tax:D.totals.iva_amount,discount:D.totals.total_discounts},sessionId:D.sessionId,discountCode:D.discountCode,discountInfo:D.discountInfo?[{type:"coupon",amount:D.discountInfo.discount_amount,percentage:D.discountInfo.discount_percentage,code:D.discountInfo.code,description:`Descuento de cupÃ³n: ${D.discountInfo.code}`}]:void 0},P=await d.storeCheckoutData(Q);if(!P.success)throw new Error(P.message||"Error al almacenar datos de checkout");return console.log("âœ… CheckoutData almacenado en backend:",{sessionId:P.data.session_id,expiresAt:P.data.expires_at,finalTotal:P.data.final_total}),O(D),x("forms_validated"),p(!0),console.log("âœ… OBJETO TEMPORAL CREADO Y ALMACENADO:",{sessionId:D.sessionId,userId:D.userId,total:D.totals.final_total,itemsCount:D.items.length,expiresAt:D.expiresAt,backendSessionId:P.data.session_id}),a(k.SUCCESS,"Formularios validados y datos seguros almacenados. Selecciona tu mÃ©todo de pago preferido."),!0}catch(_){return console.error("âŒ Error creando objeto temporal:",_),j(_,"Error validando los datos. Por favor, intenta de nuevo."),!1}finally{f(!1)}},ke=()=>e.jsxs("div",{children:[e.jsx("h2",{className:"text-xl font-bold text-gray-800 mb-4",children:"Resumen del pedido"}),i.stockIssues.length>0&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-start",children:[e.jsx(We,{size:18,className:"text-red-600 mr-2 mt-0.5"}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-red-800 text-sm mb-2",children:"Problemas de stock detectados"}),e.jsx("div",{className:"space-y-1",children:i.stockIssues.map((u,_)=>e.jsxs("div",{className:"text-xs text-red-700",children:[e.jsxs("strong",{children:[u.productName,":"]})," ",u.isOutOfStock?"Producto agotado":`Solo ${u.available} disponibles (solicitaste ${u.requested})`]},_))}),e.jsx("div",{className:"mt-2",children:e.jsx("button",{onClick:()=>g("/cart"),className:"text-xs text-red-600 underline hover:no-underline",children:"Ir al carrito para ajustar cantidades"})})]})]})}),i.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-gradient-to-r from-green-50 to-blue-50 border border-green-200 rounded-lg p-4 mb-4",children:e.jsxs("div",{className:"flex items-center",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-green-800 text-sm",children:"Â¡Descuentos Aplicados!"}),e.jsxs("div",{className:"text-xs text-green-600 mt-1 space-y-1",children:[i.totals.sellerDiscounts>0&&e.jsxs("p",{children:["Descuentos del vendedor: ",q(i.totals.sellerDiscounts)]}),i.totals.volumeDiscounts>0&&e.jsxs("p",{children:["Descuentos por volumen: ",q(i.totals.volumeDiscounts)]})]})]}),e.jsx("div",{className:"text-lg font-bold text-green-600",children:q(i.totals.totalDiscounts)})]})}),e.jsx("div",{className:"space-y-3 mb-6",children:i.items.map((u,_)=>e.jsxs("div",{className:`flex items-center justify-between py-2 border-b border-gray-100 ${u.hasStockIssue?"bg-red-50 px-2 rounded":""}`,children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("h4",{className:`text-sm font-medium ${u.hasStockIssue?"text-red-900":"text-gray-900"}`,children:[u.product?.name||`Producto ${u.productId}`,u.hasStockIssue&&e.jsx("span",{className:"ml-2 text-xs text-red-600",children:"âš ï¸"})]}),e.jsxs("div",{className:"flex items-center space-x-2 mt-1",children:[e.jsxs("span",{className:"text-xs text-gray-500",children:["Cantidad: ",u.quantity]}),u.discount.sellerDiscountAmount>0&&e.jsxs("span",{className:"text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded flex items-center",children:[e.jsx(ge,{size:10,className:"mr-1"}),"Seller: ",u.product?.discount_percentage||0,"% OFF"]}),u.discount.volumeDiscountAmount>0&&e.jsxs("span",{className:"text-xs bg-green-100 text-green-600 px-2 py-0.5 rounded flex items-center",children:[e.jsx(Ee,{size:10,className:"mr-1"}),"Volumen: ",u.discount.discountPercentage,"% OFF"]})]}),u.discount.hasDiscount&&e.jsxs("div",{className:"text-xs text-gray-600 mt-1",children:["Precio unitario: ",q(u.discount.finalPricePerUnit),e.jsx("span",{className:"line-through text-gray-400 ml-1",children:q(u.discount.originalPrice)}),u.discount.savingsTotal>0&&e.jsxs("span",{className:"text-green-600 ml-1",children:["(Ahorras: ",q(u.discount.savingsTotal),")"]})]})]}),e.jsx("div",{className:"text-right",children:e.jsx("span",{className:`text-sm font-medium ${u.hasStockIssue?"text-red-900":"text-gray-900"}`,children:q(u.itemTotal)})})]},_))}),e.jsxs("div",{className:"space-y-3 border-t border-gray-200 pt-4",children:[e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"Subtotal (con descuentos):"}),e.jsx("span",{className:"font-medium",children:q(i.totals.subtotal)})]}),i.totals.sellerDiscounts>0&&e.jsxs("div",{className:"flex justify-between text-sm text-blue-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(ge,{size:14,className:"mr-1"}),"Descuentos del vendedor:"]}),e.jsxs("span",{className:"font-medium",children:["-",q(i.totals.sellerDiscounts)]})]}),i.totals.volumeDiscounts>0&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(Ee,{size:14,className:"mr-1"}),"Descuentos por volumen:"]}),e.jsxs("span",{className:"font-medium",children:["-",q(i.totals.volumeDiscounts)]})]}),s&&e.jsxs("div",{className:"flex justify-between text-sm text-green-600",children:[e.jsxs("span",{className:"flex items-center",children:[e.jsx(ge,{size:14,className:"mr-1"}),"CÃ³digo de descuento (",s.discountCode.code,"):"]}),e.jsxs("span",{className:"font-medium",children:["-",q(i.totals.couponDiscount||0)]})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"IVA (15%):"}),e.jsx("span",{className:"font-medium",children:q(i.totals.tax)})]}),e.jsxs("div",{className:"flex justify-between text-sm",children:[e.jsx("span",{className:"text-gray-600",children:"EnvÃ­o:"}),e.jsx("span",{className:"font-medium",children:i.totals.freeShipping?"Gratis":q(i.totals.shipping)})]}),e.jsxs("div",{className:"flex justify-between text-lg font-bold border-t border-gray-200 pt-3",children:[e.jsx("span",{children:"Total:"}),e.jsx("span",{children:q(i.totals.total)})]}),i.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3 mt-3",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-green-800",children:"Total ahorrado:"}),e.jsx("span",{className:"text-lg font-bold text-green-600",children:q(i.totals.totalDiscounts)})]})})]})]});return Y&&K?e.jsx("div",{className:"container mx-auto px-4 py-10",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-8 max-w-3xl mx-auto",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4",children:e.jsx("svg",{xmlns:"http://www.w3.org/2000/svg",className:"h-10 w-10 text-green-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor",children:e.jsx("path",{strokeLinecap:"round",strokeLinejoin:"round",strokeWidth:2,d:"M5 13l4 4L19 7"})})}),e.jsx("h2",{className:"text-3xl font-bold text-gray-800 mb-4",children:"Â¡Pago con DeUna completado!"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"Tu pago se procesÃ³ correctamente y tu pedido estÃ¡ siendo preparado. RecibirÃ¡s un correo electrÃ³nico con los detalles."}),i.totals.totalDiscounts>0&&e.jsx("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 mb-6",children:e.jsxs("div",{className:"flex items-center justify-center",children:[e.jsx(ge,{className:"h-5 w-5 text-green-600 mr-2"}),e.jsxs("span",{className:"text-green-800 font-medium",children:["Â¡Has ahorrado ",q(i.totals.totalDiscounts),"!"]})]})})]}),e.jsxs("div",{className:"border-t border-gray-200 pt-4 pb-2 mb-4",children:[e.jsx("h3",{className:"text-lg font-semibold mb-2",children:"Detalles del pedido:"}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"NÃºmero de orden:"}),e.jsx("span",{className:"font-medium",children:K.order_number})]}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Total:"}),e.jsx("span",{className:"font-medium",children:q(K.total||i.totals.total)})]}),i.totals.totalDiscounts>0&&e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Total ahorrado:"}),e.jsx("span",{className:"font-medium text-green-600",children:q(i.totals.totalDiscounts)})]}),e.jsxs("div",{className:"flex justify-between py-2",children:[e.jsx("span",{className:"text-gray-600",children:"Estado del pago:"}),e.jsx("span",{className:`font-medium ${K.payment_status==="paid"?"text-green-600":"text-yellow-600"}`,children:K.payment_status==="paid"?"Pagado":K.payment_status})]})]}),e.jsx("div",{className:"text-center mb-6",children:e.jsxs("p",{className:"text-sm text-gray-500",children:["SerÃ¡s redirigido a tus pedidos en"," ",e.jsx("span",{className:"font-medium text-primary-600",children:ne})," ","segundos..."]})}),e.jsxs("div",{className:"flex justify-center space-x-4 mt-6",children:[e.jsx("button",{onClick:()=>g("/"),className:"px-6 py-2 bg-primary-600 text-white rounded-lg hover:bg-primary-700 transition-colors",children:"Volver a la tienda"}),e.jsx("button",{onClick:()=>g("/orders"),className:"px-6 py-2 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 transition-colors",children:"Ver mis pedidos"})]})]})}):e.jsxs("div",{className:"container mx-auto px-4 py-10",children:[e.jsx("div",{className:"flex justify-between items-center mb-8",children:e.jsx("h1",{className:"text-3xl font-bold",children:"Finalizar compra"})}),e.jsxs("div",{className:"flex flex-col lg:flex-row gap-8",children:[e.jsxs("div",{className:"lg:w-2/3",children:[e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"InformaciÃ³n de envÃ­o y facturaciÃ³n"}),e.jsx("div",{className:"mb-4",children:e.jsxs("label",{className:"inline-flex items-center",children:[e.jsx("input",{type:"checkbox",className:"form-checkbox h-5 w-5 text-primary-600",checked:T,onChange:u=>{const _=u.target.checked;z(_),_||U({...v})}}),e.jsx("span",{className:"ml-2 text-gray-700",children:"Usar la misma direcciÃ³n para facturaciÃ³n"})]})}),e.jsx(Se,{title:T?"DirecciÃ³n de EnvÃ­o y FacturaciÃ³n":"DirecciÃ³n de EnvÃ­o",address:v,onAddressChange:W,errors:y}),!T&&e.jsx("div",{className:"mt-8 pt-8 border-t border-gray-200",children:e.jsx(Se,{title:"DirecciÃ³n de FacturaciÃ³n",address:I,onAddressChange:V,errors:y})})]}),G&&N&&e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"MÃ©todo de pago"}),e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-3 mb-4",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx("div",{className:"w-4 h-4 bg-green-500 rounded-full mr-2"}),e.jsx("span",{className:"text-sm text-green-800 font-medium",children:"Datos validados correctamente"})]}),e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["Total a pagar: ",q(N.totals.final_total)]})]}),e.jsxs("div",{className:"flex flex-wrap gap-4 mb-6",children:[e.jsx("button",{type:"button",onClick:()=>M("credit_card"),className:`flex items-center border rounded-lg px-4 py-3 ${E==="credit_card"?"border-primary-600 bg-primary-50 text-primary-600":"border-gray-300 hover:bg-gray-50"}`,children:e.jsx("span",{children:"Tarjeta de crÃ©dito"})}),e.jsx("button",{type:"button",onClick:()=>M("deuna"),className:`flex items-center border rounded-lg px-4 py-3 ${E==="deuna"?"border-primary-600 bg-primary-50 text-primary-600":"border-gray-300 hover:bg-gray-50"}`,children:e.jsx("span",{children:"Pago con Deuna!"})})]}),E==="credit_card"&&e.jsx(at,{paymentInfo:J,errors:y,onChange:h,content:e.jsx(it,{onSuccess:b,onError:w,checkoutData:N})}),E==="deuna"&&e.jsx(rt,{total:N?.totals?.final_total,checkoutData:N,onPaymentSuccess:async u=>{console.log("âœ… DeUna payment successful, processing completion:",u);try{if(!u||!u.payment_id)throw new Error("Datos de pago de DeUna incompletos");let _=null,$=0;const D=3;for(;!_&&$<D;){$++,console.log(`ðŸ”„ Intento ${$}/${D} - Verificando orden creada por webhook...`);try{await new Promise(P=>setTimeout(P,1e3*$)),_={order_id:u.order_id||`DEUNA-${Date.now()}`,order_number:u.payment_id,total:N.totals.final_total,payment_status:"paid",payment_method:"deuna",payment_id:u.payment_id,created_via:"deuna_webhook",completed_at:u.completed_at||new Date().toISOString()};break}catch(P){console.warn(`âš ï¸ Intento ${$} fallÃ³:`,P),$>=D&&(_={order_id:u.payment_id||`DEUNA-${Date.now()}`,order_number:u.payment_id||`DEUNA-${Date.now()}`,total:N.totals.final_total,payment_status:"processing",payment_method:"deuna",payment_id:u.payment_id,created_via:"deuna_frontend_fallback",completed_at:new Date().toISOString()},console.log("ðŸ†˜ Usando datos de fallback para mostrar recibo"))}}console.log("ðŸŽ¯ Setting orderComplete to true and orderDetails"),re(_),F(!0);const Q=t?.items.reduce((P,Z)=>P+Z.quantity,0)||0;for(let P=0;P<Q;P++)S();o(),_&&_.created_via==="deuna_frontend_fallback"?a(k.WARNING,"Pago completado. Si no aparece en tus Ã³rdenes inmediatamente, revisa en unos minutos."):a(k.SUCCESS,"Â¡Pago completado exitosamente con DeUna!"),console.log("âœ… DeUna payment completion processed successfully - should show receipt now"),console.log("ðŸ“Š Order details set:",{order_id:_?.order_id,total:_?.total,created_via:_?.created_via})}catch(_){console.error("âŒ Error processing DeUna payment completion:",_);const $={order_id:u?.payment_id||`DEUNA-ERROR-${Date.now()}`,order_number:u?.payment_id||`ERROR-${Date.now()}`,total:N.totals.final_total,payment_status:"unknown",payment_method:"deuna",payment_id:u?.payment_id||"unknown",created_via:"deuna_error_fallback",completed_at:new Date().toISOString(),error_message:"Error procesando la confirmaciÃ³n. Verifica tus Ã³rdenes."};re($),F(!0),a(k.ERROR,"Error procesando la confirmaciÃ³n del pago. Si el pago fue exitoso, aparecerÃ¡ en tus Ã³rdenes."),j(_,"Error procesando la confirmaciÃ³n del pago. Por favor, verifica tus Ã³rdenes.")}},onPaymentError:u=>{console.error("âŒ DeUna payment error:",u),j(new Error(u),"Error en el pago con DeUna. Por favor, intenta de nuevo.")}})]}),!G&&e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 mb-6",children:[e.jsx("h2",{className:"text-xl font-bold mb-4",children:"MÃ©todo de pago"}),e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsx("p",{className:"text-blue-800 text-sm",children:"Los mÃ©todos de pago se mostrarÃ¡n despuÃ©s de validar tu informaciÃ³n de envÃ­o y facturaciÃ³n."})})]})]}),e.jsx("div",{className:"lg:w-1/3",children:e.jsxs("div",{className:"bg-white rounded-lg shadow-lg p-6 sticky top-24",children:[e.jsx(ke,{}),G?e.jsx("div",{className:"mt-6 bg-green-50 border border-green-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"text-sm font-medium text-green-800",children:"âœ… Datos validados"}),e.jsx("p",{className:"text-xs text-green-600 mt-1",children:"Selecciona tu mÃ©todo de pago para continuar"})]}),e.jsx("button",{onClick:()=>{p(!1),O(null),x("forms_filling")},className:"text-xs text-green-600 underline hover:no-underline",children:"Editar datos"})]})}):e.jsx("button",{onClick:Oe,disabled:c||i.stockIssues.length>0,className:"mt-6 w-full bg-primary-600 hover:bg-primary-700 text-white font-medium py-3 px-4 rounded-md transition-colors disabled:opacity-50 flex items-center justify-center",children:c?e.jsxs(e.Fragment,{children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-3 h-5 w-5 text-white",xmlns:"http://www.w3.org/2000/svg",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Validando datos..."]}):i.stockIssues.length>0?"Resuelve problemas de stock":`Validar datos y continuar - ${q(i.totals.total)}`}),i.stockIssues.length>0&&e.jsx("div",{className:"mt-3 text-xs text-center text-red-600",children:"âš ï¸ Ajusta las cantidades en tu carrito antes de continuar"}),e.jsxs("p",{className:"mt-4 text-xs text-gray-500 text-center",children:['Al hacer clic en "Finalizar compra", aceptas nuestros'," ",e.jsx("a",{href:"/terms",className:"text-primary-600 hover:underline",children:"TÃ©rminos y condiciones"})," ","y"," ",e.jsx("a",{href:"/privacy",className:"text-primary-600 hover:underline",children:"PolÃ­tica de privacidad"}),"."]})]})})]})]})},bt=Object.freeze(Object.defineProperty({__proto__:null,default:lt},Symbol.toStringTag,{value:"Module"}));export{ft as C,be as E,ht as a,Ce as b,Ze as c,st as d,yt as e,bt as f,xt as i,Ye as u};
//# sourceMappingURL=checkout-chunk-D9tWfuim.js.map
